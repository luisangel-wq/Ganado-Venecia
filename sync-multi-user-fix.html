<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîÑ Sincronizaci√≥n Multi-Usuario - Diagn√≥stico y Soluci√≥n</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 24px;
        }
        
        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }
        
        .section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .section h2 {
            color: #444;
            margin-bottom: 15px;
            font-size: 18px;
        }
        
        .info-box {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
        }
        
        .info-box label {
            display: block;
            font-weight: 600;
            color: #555;
            margin-bottom: 5px;
            font-size: 12px;
            text-transform: uppercase;
        }
        
        .info-box .value {
            font-family: 'Courier New', monospace;
            color: #333;
            font-size: 14px;
            word-break: break-all;
        }
        
        .status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .status.success {
            background: #d4edda;
            color: #155724;
        }
        
        .status.error {
            background: #f8d7da;
            color: #721c24;
        }
        
        .status.warning {
            background: #fff3cd;
            color: #856404;
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            margin-top: 10px;
            transition: transform 0.2s;
        }
        
        .btn:hover {
            transform: translateY(-2px);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn.secondary {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        
        .btn.success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        }
        
        input[type="text"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            font-family: 'Courier New', monospace;
            margin-top: 10px;
        }
        
        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
            line-height: 1.6;
        }
        
        .alert.warning {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            color: #856404;
        }
        
        .alert.error {
            background: #f8d7da;
            border-left: 4px solid #dc3545;
            color: #721c24;
        }
        
        .alert.success {
            background: #d4edda;
            border-left: 4px solid #28a745;
            color: #155724;
        }
        
        .animal-count {
            font-size: 32px;
            font-weight: bold;
            color: #667eea;
            text-align: center;
            margin: 10px 0;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîÑ Sincronizaci√≥n Multi-Usuario</h1>
        <p class="subtitle">Diagn√≥stico y Soluci√≥n para Compartir Datos entre Hermanos</p>
        
        <div id="loading" class="loading">
            <div class="spinner"></div>
            <p>Cargando informaci√≥n...</p>
        </div>
        
        <div id="content" style="display: none;">
            <!-- Current Status -->
            <div class="section">
                <h2>üìä Tu Configuraci√≥n Actual</h2>
                <div class="info-box">
                    <label>Tu User ID</label>
                    <div class="value" id="currentUserId">-</div>
                </div>
                <div class="info-box">
                    <label>Animales en tu dispositivo</label>
                    <div class="animal-count" id="localAnimalCount">0</div>
                </div>
                <div class="info-box">
                    <label>Estado de Sincronizaci√≥n</label>
                    <div id="syncStatus">-</div>
                </div>
            </div>
            
            <!-- Problem Explanation -->
            <div id="problemSection" class="section" style="display: none;">
                <h2>‚ö†Ô∏è Problema Detectado</h2>
                <div class="alert warning">
                    <strong>üîç Problema:</strong> T√∫ y tu hermano tienen User IDs diferentes.<br><br>
                    <strong>¬øQu√© significa?</strong> Cada uno est√° guardando datos en lugares separados en Firebase. 
                    Por eso no puedes ver los animales que √©l agreg√≥.<br><br>
                    <strong>‚úÖ Soluci√≥n:</strong> Ambos deben usar el mismo User ID para compartir datos.
                </div>
            </div>
            
            <!-- Solution Options -->
            <div class="section">
                <h2>üîß Soluci√≥n: Compartir User ID</h2>
                
                <div class="alert warning">
                    <strong>IMPORTANTE:</strong> Para que t√∫ y tu hermano vean los mismos datos, 
                    deben acordar un User ID compartido y ambos configurarlo.
                </div>
                
                <div class="info-box">
                    <label>Opci√≥n 1: Usar TU User ID (Recomendado si ya tienes datos)</label>
                    <div class="value" id="yourUserIdCopy">-</div>
                    <button class="btn" onclick="copyYourUserId()">üìã Copiar mi User ID para Enviar</button>
                    <p style="margin-top: 10px; font-size: 13px; color: #666;">
                        Copia este ID y env√≠aselo a tu hermano por WhatsApp. √âl debe pegarlo en "Opci√≥n 2" abajo.
                    </p>
                </div>
                
                <div class="info-box" style="margin-top: 20px;">
                    <label>Opci√≥n 2: Usar el User ID de tu Hermano</label>
                    <input type="text" id="brotherUserId" placeholder="Pega aqu√≠ el User ID que te envi√≥ tu hermano">
                    <button class="btn secondary" onclick="useBrotherUserId()">üîÑ Cambiar a este User ID</button>
                    <p style="margin-top: 10px; font-size: 13px; color: #666;">
                        ‚ö†Ô∏è Esto reemplazar√° tu User ID actual. Aseg√∫rate de haber sincronizado tus datos primero.
                    </p>
                </div>
                
                <div class="info-box" style="margin-top: 20px;">
                    <label>Opci√≥n 3: Crear User ID Compartido Nuevo</label>
                    <button class="btn success" onclick="createSharedUserId()">‚ú® Crear User ID Compartido</button>
                    <p style="margin-top: 10px; font-size: 13px; color: #666;">
                        Crea un nuevo User ID y comp√°rtelo con tu hermano. Ideal si ambos tienen datos importantes.
                    </p>
                </div>
            </div>
            
            <!-- Instructions -->
            <div class="section">
                <h2>üì± Instrucciones Completas</h2>
                <div class="alert success">
                    <strong>Paso a Paso:</strong><br><br>
                    <strong>1Ô∏è‚É£ Decide qui√©n tiene los datos m√°s completos</strong><br>
                    - Si T√ö tienes m√°s datos ‚Üí Usa Opci√≥n 1 (compartir tu User ID)<br>
                    - Si tu HERMANO tiene m√°s datos ‚Üí Usa Opci√≥n 2 (usar su User ID)<br>
                    - Si ambos tienen datos importantes ‚Üí Usa Opci√≥n 3 (crear uno nuevo)<br><br>
                    
                    <strong>2Ô∏è‚É£ El que tenga M√ÅS datos debe:</strong><br>
                    - Ir a Config ‚Üí Cloud Sync<br>
                    - Click en "Sincronizar Ahora"<br>
                    - Seleccionar "Subir a la nube"<br>
                    - Esperar confirmaci√≥n<br><br>
                    
                    <strong>3Ô∏è‚É£ El otro debe:</strong><br>
                    - Cambiar su User ID (usando esta p√°gina)<br>
                    - Ir a Config ‚Üí Cloud Sync<br>
                    - Click en "Sincronizar Ahora"<br>
                    - Seleccionar "Descargar desde la nube"<br>
                    - ¬°Listo! Ver√° todos los datos<br><br>
                    
                    <strong>4Ô∏è‚É£ De ahora en adelante:</strong><br>
                    - Ambos ver√°n los mismos datos<br>
                    - Los cambios se sincronizan autom√°ticamente<br>
                    - ¬°Trabajan juntos en tiempo real! üéâ
                </div>
            </div>
            
            <!-- Manual Sync -->
            <div class="section">
                <h2>üîÑ Sincronizaci√≥n Manual</h2>
                <button class="btn" onclick="forceUpload()">‚¨ÜÔ∏è Subir MIS datos a la nube</button>
                <button class="btn secondary" onclick="forceDownload()">‚¨áÔ∏è Descargar datos de la nube</button>
                <p style="margin-top: 10px; font-size: 13px; color: #666; text-align: center;">
                    Usa estos botones despu√©s de cambiar el User ID
                </p>
            </div>
        </div>
    </div>
    
    <script src="firebase-config.js"></script>
    <script src="cloud-sync.js"></script>
    <script>
        let currentUserId = null;
        
        // Load Firebase
        async function initializePage() {
            try {
                // Get current user ID
                currentUserId = localStorage.getItem('cloudSync_userId');
                
                if (currentUserId) {
                    document.getElementById('currentUserId').textContent = currentUserId;
                    document.getElementById('yourUserIdCopy').textContent = currentUserId;
                } else {
                    document.getElementById('currentUserId').textContent = '‚ùå No configurado';
                }
                
                // Count local animals
                const animalCount = countLocalAnimals();
                document.getElementById('localAnimalCount').textContent = animalCount;
                
                // Check sync status
                if (typeof cloudSync !== 'undefined' && cloudSync.enabled) {
                    document.getElementById('syncStatus').innerHTML = '<span class="status success">‚óè Sincronizaci√≥n activa</span>';
                } else {
                    document.getElementById('syncStatus').innerHTML = '<span class="status error">‚ö´ Sincronizaci√≥n desactivada</span>';
                }
                
                // Show content
                document.getElementById('loading').style.display = 'none';
                document.getElementById('content').style.display = 'block';
                
            } catch (error) {
                console.error('Error initializing:', error);
                document.getElementById('loading').innerHTML = '<div class="alert error">Error al cargar: ' + error.message + '</div>';
            }
        }
        
        function countLocalAnimals() {
            const ranches = {
                la_coruna: 'ganadoFinca_LaCoruna',
                santa_catalina: 'ganadoFinca_SantaCatalina',
                la_vega: 'ganadoFinca_LaVega'
            };
            
            let total = 0;
            Object.values(ranches).forEach(key => {
                try {
                    const data = localStorage.getItem(key);
                    if (data) {
                        const parsed = JSON.parse(data);
                        if (parsed.cattle && Array.isArray(parsed.cattle)) {
                            total += parsed.cattle.length;
                        }
                    }
                } catch (e) {
                    console.error('Error counting animals:', e);
                }
            });
            
            return total;
        }
        
        function copyYourUserId() {
            const userId = document.getElementById('currentUserId').textContent;
            
            // Create message for WhatsApp
            const message = `üêÑ Ganado Venecia - User ID Compartido\n\n` +
                `Para que veas los mismos datos que yo:\n\n` +
                `1. Abre este link en tu tel√©fono:\n` +
                `https://luisangel-wq.github.io/Ganado-Venecia/sync-multi-user-fix.html\n\n` +
                `2. En "Opci√≥n 2", pega este User ID:\n` +
                `${userId}\n\n` +
                `3. Click en "Cambiar a este User ID"\n\n` +
                `4. Ve a Config ‚Üí Cloud Sync ‚Üí Sincronizar Ahora\n\n` +
                `5. Selecciona "Descargar desde la nube"\n\n` +
                `¬°Listo! Ver√°s todos los animales üéâ`;
            
            // Copy to clipboard
            if (navigator.clipboard) {
                navigator.clipboard.writeText(message).then(() => {
                    alert('‚úÖ Mensaje copiado!\n\nAhora p√©galo en WhatsApp y env√≠aselo a tu hermano.');
                }).catch(() => {
                    // Fallback
                    prompt('Copia este mensaje y env√≠aselo por WhatsApp:', message);
                });
            } else {
                prompt('Copia este mensaje y env√≠aselo por WhatsApp:', message);
            }
        }
        
        function useBrotherUserId() {
            const brotherUserId = document.getElementById('brotherUserId').value.trim();
            
            if (!brotherUserId) {
                alert('‚ùå Por favor pega el User ID de tu hermano');
                return;
            }
            
            if (!brotherUserId.startsWith('user_')) {
                alert('‚ùå El User ID no parece v√°lido. Debe empezar con "user_"');
                return;
            }
            
            if (!confirm(
                '‚ö†Ô∏è ADVERTENCIA\n\n' +
                'Esto cambiar√° tu User ID a:\n' +
                brotherUserId + '\n\n' +
                '¬øEst√°s seguro?\n\n' +
                'Despu√©s de cambiar, haz click en "Descargar datos de la nube" abajo.'
            )) {
                return;
            }
            
            // Save old user ID for backup
            const oldUserId = currentUserId;
            localStorage.setItem('cloudSync_userId_backup', oldUserId);
            
            // Set new user ID
            localStorage.setItem('cloudSync_userId', brotherUserId);
            currentUserId = brotherUserId;
            
            alert('‚úÖ User ID cambiado exitosamente!\n\n' +
                'Ahora haz click en "Descargar datos de la nube" abajo para obtener los datos de tu hermano.');
            
            // Reload page to show new ID
            window.location.reload();
        }
        
        function createSharedUserId() {
            const newUserId = 'user_shared_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            
            const message = `üêÑ User ID Compartido Creado\n\n` +
                `${newUserId}\n\n` +
                `Env√≠a este User ID a tu hermano y ambos √∫senlo.\n\n` +
                `Instrucciones:\n` +
                `1. El que tenga M√ÅS datos: primero SUBE a la nube\n` +
                `2. Luego ambos cambian al nuevo User ID\n` +
                `3. El que ten√≠a menos datos: DESCARGA desde la nube\n` +
                `4. ¬°Listo! Ambos sincronizados üéâ`;
            
            if (confirm('Se crear√° un nuevo User ID compartido.\n\n¬øContinuar?')) {
                if (navigator.clipboard) {
                    navigator.clipboard.writeText(message).then(() => {
                        alert('‚úÖ User ID compartido creado y copiado!\n\nP√©galo en WhatsApp y env√≠aselo a tu hermano.');
                        // Set as current
                        localStorage.setItem('cloudSync_userId_backup', currentUserId);
                        localStorage.setItem('cloudSync_userId', newUserId);
                        window.location.reload();
                    });
                } else {
                    prompt('Copia este User ID y comp√°rtelo:', message);
                }
            }
        }
        
        async function forceUpload() {
            if (!confirm('¬øSubir TUS datos actuales a la nube?\n\n‚ö†Ô∏è Esto sobrescribir√° lo que est√© en la nube para este User ID.')) {
                return;
            }
            
            try {
                // Initialize cloud sync if not already
                if (!cloudSync.enabled) {
                    await cloudSync.initialize(getFirebaseConfig());
                }
                
                await cloudSync.syncToCloud();
                alert('‚úÖ Datos subidos exitosamente a la nube!\n\nAhora tu hermano puede descargarlos.');
            } catch (error) {
                alert('‚ùå Error al subir datos:\n' + error.message);
            }
        }
        
        async function forceDownload() {
            if (!confirm('¬øDescargar datos de la nube?\n\n‚ö†Ô∏è Esto reemplazar√° tus datos locales con los datos de la nube.')) {
                return;
            }
            
            try {
                // Initialize cloud sync if not already
                if (!cloudSync.enabled) {
                    await cloudSync.initialize(getFirebaseConfig());
                }
                
                await cloudSync.syncFromCloud();
                alert('‚úÖ Datos descargados exitosamente!\n\nRecarga la p√°gina para ver los cambios.');
                setTimeout(() => window.location.reload(), 1500);
            } catch (error) {
                alert('‚ùå Error al descargar datos:\n' + error.message);
            }
        }
        
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', initializePage);
    </script>
</body>
</html>
