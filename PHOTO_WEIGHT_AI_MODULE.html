<!-- ============================================
     üì∑ AI-ASSISTED PHOTO WEIGHT ESTIMATION
     Ganado Finca - Gemini Vision Integration
     
     Uses Google Gemini API to automatically
     analyze photos and extract measurements
     using the calibrated manga as reference.
     ============================================ -->

<!-- ==================== 
     COMPLETE TAB CONTENT WITH AI
     ==================== -->
<div id="tab-peso-foto" class="tab-content">
    
    <!-- Header with AI Badge -->
    <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1.5rem; flex-wrap: wrap;">
        <h2 style="margin: 0; color: #374151; font-weight: 800; display: flex; align-items: center; gap: 0.5rem;">
            <span style="font-size: 2rem;">üì∑</span>
            Peso por Fotograf√≠a
        </h2>
        <span style="background: linear-gradient(135deg, #8b5cf6, #6d28d9); color: white; padding: 0.35rem 0.75rem; border-radius: 20px; font-size: 0.75rem; font-weight: 700;">
            ü§ñ AI POWERED
        </span>
    </div>

    <!-- Manga Calibration Info Card -->
    <div class="card" style="border: 2px solid #8b5cf6; margin-bottom: 1.5rem;">
        <div class="card-header" style="background: linear-gradient(135deg, #8b5cf6, #6d28d9);">
            <span style="font-size: 1.5rem;">üìê</span>
            <span>Sistema de Medici√≥n con IA</span>
        </div>
        <div class="card-body">
            <!-- AI Info Banner -->
            <div style="background: linear-gradient(135deg, #eff6ff, #dbeafe); border: 2px solid #3b82f6; border-radius: 16px; padding: 1rem; margin-bottom: 1.5rem;">
                <div style="display: flex; align-items: flex-start; gap: 1rem;">
                    <div style="font-size: 2.5rem;">ü§ñ</div>
                    <div>
                        <h4 style="margin: 0 0 0.5rem 0; color: #1d4ed8;">Google Gemini Vision</h4>
                        <p style="margin: 0; font-size: 0.85rem; color: #4b5563;">
                            La IA analiza las fotos y detecta autom√°ticamente las medidas del animal usando la manga calibrada como referencia. 
                            <strong>Solo toma las fotos y la IA hace el resto.</strong>
                        </p>
                    </div>
                </div>
            </div>

            <!-- Calibration Reference Display -->
            <div style="background: linear-gradient(135deg, #faf5ff, #ede9fe); padding: 1.25rem; border-radius: 16px; margin-bottom: 1.5rem;">
                <h4 style="margin: 0 0 1rem 0; color: #6d28d9; font-size: 0.9rem;">
                    üîß Referencias de la Manga (conocidas por la IA)
                </h4>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(80px, 1fr)); gap: 0.5rem;">
                    <div style="text-align: center; padding: 0.5rem; background: white; border-radius: 10px;">
                        <div style="font-size: 1.25rem;">üìè</div>
                        <div style="font-weight: 800; font-size: 1rem; color: #6d28d9;">144.5</div>
                        <div style="font-size: 0.6rem; color: #666;">Altura cm</div>
                    </div>
                    <div style="text-align: center; padding: 0.5rem; background: white; border-radius: 10px;">
                        <div style="font-size: 1.25rem;">‚ÜîÔ∏è</div>
                        <div style="font-weight: 800; font-size: 1rem; color: #6d28d9;">60.5</div>
                        <div style="font-size: 0.6rem; color: #666;">Ancho cm</div>
                    </div>
                    <div style="text-align: center; padding: 0.5rem; background: white; border-radius: 10px;">
                        <div style="font-size: 1.25rem;">üìä</div>
                        <div style="font-weight: 800; font-size: 1rem; color: #6d28d9;">23</div>
                        <div style="font-size: 0.6rem; color: #666;">Entre Barras</div>
                    </div>
                    <div style="text-align: center; padding: 0.5rem; background: white; border-radius: 10px;">
                        <div style="font-size: 1.25rem;">‚≠ï</div>
                        <div style="font-weight: 800; font-size: 1rem; color: #6d28d9;">5</div>
                        <div style="font-size: 0.6rem; color: #666;">Tubo cm</div>
                    </div>
                    <div style="text-align: center; padding: 0.5rem; background: white; border-radius: 10px;">
                        <div style="font-size: 1.25rem;">üìê</div>
                        <div style="font-weight: 800; font-size: 1rem; color: #6d28d9;">170</div>
                        <div style="font-size: 0.6rem; color: #666;">Secci√≥n 1</div>
                    </div>
                    <div style="text-align: center; padding: 0.5rem; background: white; border-radius: 10px;">
                        <div style="font-size: 1.25rem;">üìê</div>
                        <div style="font-weight: 800; font-size: 1rem; color: #6d28d9;">152</div>
                        <div style="font-size: 0.6rem; color: #666;">Secci√≥n 2</div>
                    </div>
                </div>
            </div>

            <!-- Animal Selection -->
            <div class="form-group">
                <label class="form-label" style="font-size: 1rem;">
                    üêÇ Seleccionar Animal
                </label>
                <select class="form-select" id="pesoFotoAnimal" onchange="loadAnimalForPhotoWeight()">
                    <option value="">-- Seleccionar chapeta --</option>
                </select>
            </div>

            <!-- Selected Animal Info -->
            <div id="selectedAnimalInfo" style="display: none; background: #f0fdf4; border: 2px solid #10b981; border-radius: 12px; padding: 1rem; margin-top: 1rem;">
                <div style="display: flex; align-items: center; gap: 1rem; flex-wrap: wrap;">
                    <div style="font-size: 2.5rem;">üêÇ</div>
                    <div>
                        <div style="font-weight: 800; font-size: 1.25rem; color: #059669;" id="selectedAnimalChapeta">--</div>
                        <div style="font-size: 0.85rem; color: #666;" id="selectedAnimalDetails">--</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Photo Capture Section -->
    <div class="card" style="margin-bottom: 1.5rem;">
        <div class="card-header" style="background: linear-gradient(135deg, #3b82f6, #1d4ed8);">
            <span style="font-size: 1.5rem;">üì∑</span>
            <span>Capturar Fotograf√≠as</span>
        </div>
        <div class="card-body">
            <!-- Photo Instructions -->
            <div style="background: #fef3c7; border: 2px solid #f59e0b; border-radius: 12px; padding: 1rem; margin-bottom: 1.5rem;">
                <h4 style="margin: 0 0 0.5rem 0; color: #d97706; font-size: 0.9rem;">üì∏ Instrucciones</h4>
                <ul style="margin: 0; padding-left: 1.25rem; font-size: 0.85rem; color: #92400e;">
                    <li><strong>Lateral:</strong> A 2 metros, captura todo el cuerpo del animal</li>
                    <li><strong>Trasera:</strong> A 1.5-2 metros, centrado en el animal</li>
                    <li><strong>Superior:</strong> A 1 metro desde arriba (opcional pero mejora precisi√≥n)</li>
                </ul>
            </div>

            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 1rem;">
                
                <!-- Side Photo -->
                <div class="photo-capture-card" id="sidePhotoCard" onclick="document.getElementById('sidePhotoInput').click()">
                    <input type="file" accept="image/*" capture="environment" id="sidePhotoInput" onchange="handlePhotoCapture('side', this)" style="display: none;">
                    <div class="photo-capture-icon" id="sidePhotoIcon">üì∑</div>
                    <div class="photo-capture-title">Vista Lateral</div>
                    <div class="photo-capture-distance">üìç 2 metros</div>
                    <div class="photo-capture-status" id="sidePhotoStatus">Toca para capturar</div>
                    <div class="photo-preview-container" id="sidePhotoPreview"></div>
                </div>

                <!-- Back Photo -->
                <div class="photo-capture-card" id="backPhotoCard" onclick="document.getElementById('backPhotoInput').click()">
                    <input type="file" accept="image/*" capture="environment" id="backPhotoInput" onchange="handlePhotoCapture('back', this)" style="display: none;">
                    <div class="photo-capture-icon" id="backPhotoIcon">üì∑</div>
                    <div class="photo-capture-title">Vista Trasera</div>
                    <div class="photo-capture-distance">üìç 1.5-2 metros</div>
                    <div class="photo-capture-status" id="backPhotoStatus">Toca para capturar</div>
                    <div class="photo-preview-container" id="backPhotoPreview"></div>
                </div>

                <!-- Top Photo -->
                <div class="photo-capture-card" id="topPhotoCard" onclick="document.getElementById('topPhotoInput').click()">
                    <input type="file" accept="image/*" capture="environment" id="topPhotoInput" onchange="handlePhotoCapture('top', this)" style="display: none;">
                    <div class="photo-capture-icon" id="topPhotoIcon">üì∑</div>
                    <div class="photo-capture-title">Vista Superior</div>
                    <div class="photo-capture-distance">üìç 1 metro</div>
                    <div class="photo-capture-status" id="topPhotoStatus">Toca para capturar</div>
                    <div class="photo-preview-container" id="topPhotoPreview"></div>
                </div>
            </div>

            <!-- AI Analysis Button -->
            <div style="margin-top: 1.5rem;">
                <button class="btn btn-primary" id="btnAnalyzeAI" onclick="analyzeWithGemini()" style="width: 100%; padding: 1.25rem; font-size: 1.1rem;" disabled>
                    <span style="font-size: 1.5rem;">ü§ñ</span>
                    <span>Analizar con IA</span>
                </button>
                <p style="text-align: center; font-size: 0.8rem; color: #6b7280; margin-top: 0.5rem;">
                    Captura al menos la foto lateral para activar el an√°lisis
                </p>
            </div>
        </div>
    </div>

    <!-- AI Analysis Loading -->
    <div id="aiAnalysisLoading" class="card" style="display: none; margin-bottom: 1.5rem;">
        <div class="card-body" style="text-align: center; padding: 3rem;">
            <div style="font-size: 4rem; animation: pulse 1.5s infinite;">ü§ñ</div>
            <h3 style="margin: 1rem 0 0.5rem 0; color: #374151;">Analizando im√°genes...</h3>
            <p style="color: #6b7280; margin: 0;">La IA est√° midiendo el animal usando la manga como referencia</p>
            <div style="margin-top: 1.5rem;">
                <div class="ai-progress-bar">
                    <div class="ai-progress-fill"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- AI Results Section -->
    <div id="aiMeasurementResults" class="card" style="display: none; border: 3px solid #8b5cf6; margin-bottom: 1.5rem;">
        <div class="card-header" style="background: linear-gradient(135deg, #8b5cf6, #6d28d9);">
            <span style="font-size: 1.5rem;">ü§ñ</span>
            <span>Mediciones Detectadas por IA</span>
        </div>
        <div class="card-body">
            <!-- AI Detected Measurements -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
                <div class="ai-measurement-box">
                    <div class="ai-measurement-icon">üìè</div>
                    <div class="ai-measurement-value" id="aiLargo">-- cm</div>
                    <div class="ai-measurement-label">Largo del Cuerpo</div>
                    <input type="number" class="form-input ai-measurement-edit" id="inputLargoCuerpo" placeholder="Ajustar" oninput="calcularPesoFoto()">
                </div>
                <div class="ai-measurement-box">
                    <div class="ai-measurement-icon">üìê</div>
                    <div class="ai-measurement-value" id="aiAltura">-- cm</div>
                    <div class="ai-measurement-label">Altura a la Cruz</div>
                    <input type="number" class="form-input ai-measurement-edit" id="inputAlturaCruz" placeholder="Ajustar" oninput="calcularPesoFoto()">
                </div>
                <div class="ai-measurement-box">
                    <div class="ai-measurement-icon">‚ÜîÔ∏è</div>
                    <div class="ai-measurement-value" id="aiAncho">-- cm</div>
                    <div class="ai-measurement-label">Ancho del Cuerpo</div>
                    <input type="number" class="form-input ai-measurement-edit" id="inputAnchoCuerpo" placeholder="Ajustar" oninput="calcularPesoFoto()">
                </div>
                <div class="ai-measurement-box">
                    <div class="ai-measurement-icon">‚≠ï</div>
                    <div class="ai-measurement-value" id="aiPerimetro">-- cm</div>
                    <div class="ai-measurement-label">Per√≠metro Estimado</div>
                    <input type="number" class="form-input ai-measurement-edit" id="inputPerimetroToracico" placeholder="Ajustar" oninput="calcularPesoFoto()">
                </div>
            </div>

            <!-- AI Confidence -->
            <div style="background: #f3f4f6; border-radius: 12px; padding: 1rem; margin-bottom: 1rem;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                    <span style="font-weight: 600; color: #374151;">Confianza del An√°lisis</span>
                    <span style="font-weight: 800; color: #8b5cf6;" id="aiConfidenceValue">--%</span>
                </div>
                <div style="background: #e5e7eb; border-radius: 10px; height: 10px; overflow: hidden;">
                    <div id="aiConfidenceBar" style="background: linear-gradient(90deg, #8b5cf6, #6d28d9); height: 100%; width: 0%; transition: width 0.5s ease;"></div>
                </div>
            </div>

            <!-- AI Notes -->
            <div id="aiNotes" style="background: #fffbeb; border: 1px solid #fcd34d; border-radius: 12px; padding: 1rem; font-size: 0.85rem; color: #92400e; display: none;">
                <strong>üí° Notas de la IA:</strong>
                <p id="aiNotesText" style="margin: 0.5rem 0 0 0;"></p>
            </div>
        </div>
    </div>

    <!-- Manual Input Section (Alternative) -->
    <div class="card" style="margin-bottom: 1.5rem;">
        <div class="card-header" style="background: linear-gradient(135deg, #f59e0b, #d97706);">
            <span style="font-size: 1.5rem;">‚úèÔ∏è</span>
            <span>Entrada Manual (Opcional)</span>
        </div>
        <div class="card-body">
            <p style="font-size: 0.85rem; color: #666; margin-bottom: 1rem;">
                Si prefieres, puedes ingresar las medidas manualmente o ajustar las detectadas por la IA.
            </p>
            
            <button class="btn btn-secondary" onclick="toggleManualInput()" style="width: 100%;">
                <span>üìù</span> Mostrar/Ocultar Entrada Manual
            </button>
            
            <div id="manualInputSection" style="display: none; margin-top: 1rem;">
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">üìè Largo (cm)</label>
                        <input type="number" class="form-input" id="manualLargo" placeholder="Ej: 145" oninput="syncManualToAI('largo')">
                    </div>
                    <div class="form-group">
                        <label class="form-label">üìê Altura (cm)</label>
                        <input type="number" class="form-input" id="manualAltura" placeholder="Ej: 125" oninput="syncManualToAI('altura')">
                    </div>
                    <div class="form-group">
                        <label class="form-label">‚ÜîÔ∏è Ancho (cm)</label>
                        <input type="number" class="form-input" id="manualAncho" placeholder="Ej: 52" oninput="syncManualToAI('ancho')">
                    </div>
                    <div class="form-group">
                        <label class="form-label">‚≠ï Per√≠metro (cm)</label>
                        <input type="number" class="form-input" id="manualPerimetro" placeholder="Opcional" oninput="syncManualToAI('perimetro')">
                    </div>
                </div>
                
                <!-- Measurement Guide Button -->
                <button class="btn btn-outline" onclick="mostrarGuiaMedicion()" style="margin-top: 1rem; width: 100%;">
                    <span>üìñ</span> Ver Gu√≠a de Medici√≥n con Barras
                </button>
            </div>
        </div>
    </div>

    <!-- Weight Results Section -->
    <div class="card" id="resultadosPesoFoto" style="display: none; border: 3px solid #10b981;">
        <div class="card-header" style="background: linear-gradient(135deg, #10b981, #059669);">
            <span style="font-size: 1.5rem;">‚öñÔ∏è</span>
            <span>Peso Estimado</span>
        </div>
        <div class="card-body">
            <!-- Main Result -->
            <div style="text-align: center; padding: 2rem; background: linear-gradient(135deg, #f0fdf4, #dcfce7); border-radius: 20px; margin-bottom: 1.5rem;">
                <div style="font-size: 4rem; margin-bottom: 0.5rem;">‚öñÔ∏è</div>
                <div style="font-size: 3.5rem; font-weight: 900; color: #059669; line-height: 1;" id="resultadoPesoKg">-- kg</div>
                <div style="font-size: 1rem; color: #666; margin-top: 0.5rem;">Peso Estimado</div>
                <div style="font-size: 1.25rem; color: #374151; margin-top: 0.5rem; font-weight: 600;" id="resultadoRango">Rango: -- a -- kg</div>
            </div>

            <!-- Stats Grid -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
                <div style="text-align: center; padding: 1rem; background: white; border-radius: 12px; border: 1px solid #e5e7eb;">
                    <div style="font-size: 1.75rem;">‚≠ï</div>
                    <div style="font-weight: 800; font-size: 1.1rem; color: #374151;" id="resultadoPerimetro">-- cm</div>
                    <div style="font-size: 0.65rem; color: #666; text-transform: uppercase;">Per√≠metro</div>
                </div>
                <div style="text-align: center; padding: 1rem; background: white; border-radius: 12px; border: 1px solid #e5e7eb;">
                    <div style="font-size: 1.75rem;">üìä</div>
                    <div style="font-weight: 800; font-size: 1.1rem; color: #374151;" id="resultadoConfianza">--%</div>
                    <div style="font-size: 0.65rem; color: #666; text-transform: uppercase;">Confianza</div>
                </div>
                <div style="text-align: center; padding: 1rem; background: white; border-radius: 12px; border: 1px solid #e5e7eb;">
                    <div style="font-size: 1.75rem;">üìà</div>
                    <div style="font-weight: 800; font-size: 1.1rem; color: #374151;" id="resultadoGDP">-- g/d√≠a</div>
                    <div style="font-size: 0.65rem; color: #666; text-transform: uppercase;">GDP Est.</div>
                </div>
                <div style="text-align: center; padding: 1rem; background: white; border-radius: 12px; border: 1px solid #e5e7eb;">
                    <div style="font-size: 1.75rem;">ü§ñ</div>
                    <div style="font-weight: 800; font-size: 1.1rem; color: #8b5cf6;" id="resultadoMetodo">IA</div>
                    <div style="font-size: 0.65rem; color: #666; text-transform: uppercase;">M√©todo</div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="btn-group" style="justify-content: center;">
                <button class="btn btn-success" onclick="guardarPesoFoto()">
                    <span style="font-size: 1.25rem;">üíæ</span> Guardar
                </button>
                <button class="btn btn-primary" onclick="verHistorialPesos()">
                    <span style="font-size: 1.25rem;">üìä</span> Historial
                </button>
                <button class="btn btn-secondary" onclick="nuevaEstimacion()">
                    <span style="font-size: 1.25rem;">üîÑ</span> Nueva
                </button>
            </div>
        </div>
    </div>

    <!-- Weight History -->
    <div class="card">
        <div class="card-header">
            <span style="font-size: 1.25rem;">üìà</span>
            <span>Historial de Estimaciones</span>
        </div>
        <div class="card-body">
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Fecha</th>
                            <th>Chapeta</th>
                            <th>Peso</th>
                            <th>M√©todo</th>
                            <th>Conf.</th>
                        </tr>
                    </thead>
                    <tbody id="historialPesosTable">
                        <tr><td colspan="5" class="text-center" style="color: #9ca3af;">No hay estimaciones guardadas</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- ==================== 
     MEASUREMENT GUIDE MODAL 
     ==================== -->
<div id="guiaMedicionModal" class="modal">
    <div class="modal-content" style="max-width: 700px;">
        <div class="modal-header">
            <h3 class="modal-title">
                <span style="font-size: 1.5rem;">üìñ</span>
                Gu√≠a de Medici√≥n Manual
            </h3>
            <button class="modal-close" onclick="cerrarGuiaMedicion()">‚úï</button>
        </div>
        <div class="modal-body">
            <!-- Visual Diagram -->
            <div style="background: #f3f4f6; border-radius: 16px; padding: 1.5rem; margin-bottom: 1.5rem; text-align: center;">
                <svg viewBox="0 0 400 280" style="max-width: 100%; height: auto;">
                    <!-- Manga Structure -->
                    <rect x="50" y="20" width="10" height="240" fill="#6b7280" rx="2"/>
                    <rect x="340" y="20" width="10" height="240" fill="#6b7280" rx="2"/>
                    
                    <!-- Horizontal Bars with labels -->
                    <rect x="50" y="30" width="300" height="6" fill="#9ca3af" rx="3"/>
                    <rect x="50" y="75" width="300" height="6" fill="#9ca3af" rx="3"/>
                    <rect x="50" y="120" width="300" height="6" fill="#9ca3af" rx="3"/>
                    <rect x="50" y="165" width="300" height="6" fill="#9ca3af" rx="3"/>
                    <rect x="50" y="210" width="300" height="6" fill="#9ca3af" rx="3"/>
                    
                    <!-- Cow Silhouette -->
                    <ellipse cx="200" cy="140" rx="90" ry="50" fill="#2d6a4f" opacity="0.85"/>
                    <ellipse cx="300" cy="120" rx="28" ry="32" fill="#2d6a4f" opacity="0.85"/>
                    <rect x="130" y="175" width="12" height="45" fill="#2d6a4f" rx="4"/>
                    <rect x="165" y="180" width="12" height="40" fill="#2d6a4f" rx="4"/>
                    <rect x="220" y="180" width="12" height="40" fill="#2d6a4f" rx="4"/>
                    <rect x="255" y="175" width="12" height="45" fill="#2d6a4f" rx="4"/>
                    
                    <!-- Measurement Arrows -->
                    <!-- Length -->
                    <line x1="110" y1="245" x2="290" y2="245" stroke="#ef4444" stroke-width="3"/>
                    <polygon points="110,245 118,240 118,250" fill="#ef4444"/>
                    <polygon points="290,245 282,240 282,250" fill="#ef4444"/>
                    <text x="200" y="262" text-anchor="middle" fill="#ef4444" font-weight="bold" font-size="11">LARGO</text>
                    
                    <!-- Height -->
                    <line x1="32" y1="90" x2="32" y2="220" stroke="#3b82f6" stroke-width="3"/>
                    <polygon points="32,90 27,98 37,98" fill="#3b82f6"/>
                    <polygon points="32,220 27,212 37,212" fill="#3b82f6"/>
                    <text x="18" y="158" fill="#3b82f6" font-weight="bold" font-size="10" transform="rotate(-90, 18, 158)">ALTURA</text>
                    
                    <!-- Bar spacing indicator -->
                    <line x1="365" y1="36" x2="365" y2="75" stroke="#8b5cf6" stroke-width="2"/>
                    <text x="372" y="58" fill="#8b5cf6" font-size="9" font-weight="bold">23cm</text>
                </svg>
            </div>

            <!-- Quick Reference -->
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; margin-bottom: 1.5rem;">
                <div style="background: #fee2e2; padding: 1rem; border-radius: 12px; border-left: 4px solid #ef4444;">
                    <strong style="color: #dc2626;">üìè Largo</strong>
                    <p style="margin: 0.25rem 0 0 0; font-size: 0.8rem; color: #666;">
                        Hombro ‚Üí Base de cola
                    </p>
                </div>
                <div style="background: #dbeafe; padding: 1rem; border-radius: 12px; border-left: 4px solid #3b82f6;">
                    <strong style="color: #2563eb;">üìê Altura</strong>
                    <p style="margin: 0.25rem 0 0 0; font-size: 0.8rem; color: #666;">
                        Suelo ‚Üí Cruz (lomo)
                    </p>
                </div>
            </div>

            <!-- Bar Calculator -->
            <div style="background: #f0fdf4; padding: 1rem; border-radius: 12px; border: 2px solid #10b981;">
                <strong style="color: #059669;">üßÆ Calculadora de Barras</strong>
                <div style="display: flex; gap: 0.75rem; align-items: center; margin-top: 0.75rem; flex-wrap: wrap;">
                    <div>
                        <label style="font-size: 0.75rem; color: #666;">Espacios:</label>
                        <input type="number" id="calcBarras" class="form-input" style="width: 70px; padding: 0.4rem;" placeholder="0" oninput="calcularPorBarras()">
                    </div>
                    <div>
                        <label style="font-size: 0.75rem; color: #666;">Tubos:</label>
                        <input type="number" id="calcTubos" class="form-input" style="width: 70px; padding: 0.4rem;" placeholder="0" oninput="calcularPorBarras()">
                    </div>
                    <div style="font-size: 1.5rem; font-weight: 800; color: #059669;" id="calcResultado">= 0 cm</div>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-primary" onclick="cerrarGuiaMedicion()">Entendido</button>
        </div>
    </div>
</div>


<!-- ==================== 
     CSS STYLES 
     ==================== -->
<style>
/* Photo Capture Cards */
.photo-capture-card {
    background: white;
    border: 3px dashed #d1d5db;
    border-radius: 20px;
    padding: 1.5rem 1rem;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.photo-capture-card:hover {
    border-color: #8b5cf6;
    background: #faf5ff;
    transform: translateY(-4px);
    box-shadow: 0 10px 25px rgba(139, 92, 246, 0.2);
}

.photo-capture-card:active {
    transform: scale(0.98);
}

.photo-capture-card.has-photo {
    border-style: solid;
    border-color: #10b981;
    background: linear-gradient(135deg, #f0fdf4, #dcfce7);
}

.photo-capture-icon {
    font-size: 3.5rem;
    margin-bottom: 0.5rem;
    transition: transform 0.3s ease;
}

.photo-capture-card:hover .photo-capture-icon {
    transform: scale(1.1);
}

.photo-capture-card.has-photo .photo-capture-icon {
    font-size: 2rem;
}

.photo-capture-title {
    font-size: 1rem;
    font-weight: 700;
    color: #374151;
    margin-bottom: 0.25rem;
}

.photo-capture-distance {
    font-size: 0.8rem;
    color: #6b7280;
    margin-bottom: 0.5rem;
}

.photo-capture-status {
    font-size: 0.75rem;
    color: #9ca3af;
    font-weight: 500;
}

.photo-capture-card.has-photo .photo-capture-status {
    color: #059669;
    font-weight: 700;
}

.photo-preview-container {
    margin-top: 0.75rem;
}

.photo-preview-container img {
    max-width: 100%;
    max-height: 120px;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

/* AI Measurement Boxes */
.ai-measurement-box {
    background: linear-gradient(135deg, #faf5ff, #ede9fe);
    border: 2px solid #c4b5fd;
    border-radius: 16px;
    padding: 1rem;
    text-align: center;
    transition: all 0.3s ease;
}

.ai-measurement-box:hover {
    border-color: #8b5cf6;
    box-shadow: 0 4px 15px rgba(139, 92, 246, 0.2);
}

.ai-measurement-icon {
    font-size: 2rem;
    margin-bottom: 0.25rem;
}

.ai-measurement-value {
    font-size: 1.5rem;
    font-weight: 800;
    color: #6d28d9;
    margin-bottom: 0.25rem;
}

.ai-measurement-label {
    font-size: 0.7rem;
    color: #6b7280;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 0.5rem;
}

.ai-measurement-edit {
    padding: 0.4rem !important;
    font-size: 0.85rem !important;
    text-align: center;
    border-color: #c4b5fd !important;
}

.ai-measurement-edit:focus {
    border-color: #8b5cf6 !important;
}

/* AI Progress Bar */
.ai-progress-bar {
    background: #e5e7eb;
    border-radius: 10px;
    height: 8px;
    overflow: hidden;
}

.ai-progress-fill {
    background: linear-gradient(90deg, #8b5cf6, #6d28d9, #8b5cf6);
    background-size: 200% 100%;
    height: 100%;
    width: 100%;
    animation: progressMove 1.5s linear infinite;
}

@keyframes progressMove {
    0% { background-position: 0% 0%; }
    100% { background-position: 200% 0%; }
}

@keyframes pulse {
    0%, 100% { transform: scale(1); opacity: 1; }
    50% { transform: scale(1.1); opacity: 0.8; }
}

/* Result Animation */
@keyframes resultPop {
    0% { transform: scale(0.8); opacity: 0; }
    50% { transform: scale(1.05); }
    100% { transform: scale(1); opacity: 1; }
}

#resultadosPesoFoto.show,
#aiMeasurementResults.show {
    animation: resultPop 0.4s ease-out;
}

/* Mobile Optimizations */
@media (max-width: 480px) {
    .photo-capture-card {
        padding: 1rem 0.75rem;
    }
    
    .photo-capture-icon {
        font-size: 2.5rem;
    }
    
    .photo-capture-title {
        font-size: 0.9rem;
    }
    
    .ai-measurement-box {
        padding: 0.75rem;
    }
    
    .ai-measurement-value {
        font-size: 1.25rem;
    }
    
    #resultadoPesoKg {
        font-size: 2.5rem !important;
    }
}
</style>


<!-- ==================== 
     JAVASCRIPT WITH GEMINI AI
     ==================== -->
<script>
// ============================================
// üì∑ AI-ASSISTED PHOTO WEIGHT ESTIMATION
// Google Gemini Vision Integration
// ============================================

// Manga Calibration Constants
const MANGA = {
    altura: 144.5,           // Height: top of first bar to bottom of last bar (cm)
    anchoInterno: 60.5,      // Internal width between columns (cm)
    espacioBarras: 23,       // Space between bars (cm)
    diametroTubo: 5,         // Tube diameter (cm)
    anchoColumna: 7,         // Column width (cm)
    seccion1: 170,           // Section 1 length (cm)
    seccion2: 152,           // Section 2 length (cm)
    largoTotal: 330.5        // Total length (cm)
};

// Storage for current estimation
let estimacionActual = {
    animalId: null,
    fotos: { lateral: null, trasera: null, superior: null },
    medidas: { largo: null, altura: null, ancho: null, perimetro: null },
    resultado: null,
    metodo: 'manual'
};

// Initialize when DOM loads
document.addEventListener('DOMContentLoaded', function() {
    if (document.getElementById('pesoFotoAnimal')) {
        cargarAnimalesParaFoto();
        cargarHistorialPesos();
    }
});

// Populate animal dropdown
function cargarAnimalesParaFoto() {
    const select = document.getElementById('pesoFotoAnimal');
    if (!select) return;
    
    const inventario = typeof getInventario === 'function' ? getInventario() : [];
    select.innerHTML = '<option value="">-- Seleccionar chapeta --</option>';
    
    inventario.forEach(animal => {
        const option = document.createElement('option');
        option.value = animal.numero || animal.chapeta;
        option.textContent = `${animal.numero || animal.chapeta} - ${animal.sexo || 'N/A'} - ${animal.peso || 0} kg`;
        select.appendChild(option);
    });
}

// Load selected animal info
function loadAnimalForPhotoWeight() {
    const animalId = document.getElementById('pesoFotoAnimal').value;
    const infoDiv = document.getElementById('selectedAnimalInfo');
    
    if (!animalId) {
        infoDiv.style.display = 'none';
        estimacionActual.animalId = null;
        return;
    }
    
    estimacionActual.animalId = animalId;
    
    const inventario = typeof getInventario === 'function' ? getInventario() : [];
    const animal = inventario.find(a => (a.numero || a.chapeta) === animalId);
    
    if (animal) {
        document.getElementById('selectedAnimalChapeta').textContent = `Chapeta: ${animalId}`;
        document.getElementById('selectedAnimalDetails').textContent = 
            `${animal.sexo || 'N/A'} | Peso entrada: ${animal.peso || 0} kg | ${animal.lote || 'Sin lote'}`;
        infoDiv.style.display = 'block';
    }
    
    // Clear previous results
    document.getElementById('aiMeasurementResults').style.display = 'none';
    document.getElementById('resultadosPesoFoto').style.display = 'none';
}

// Handle photo capture
function handlePhotoCapture(type, input) {
    const file = input.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = function(e) {
        const photoData = e.target.result;
        
        // Store photo
        const typeMap = { side: 'lateral', back: 'trasera', top: 'superior' };
        estimacionActual.fotos[typeMap[type] || type] = photoData;
        
        // Update UI
        const card = document.getElementById(type + 'PhotoCard');
        const icon = document.getElementById(type + 'PhotoIcon');
        const status = document.getElementById(type + 'PhotoStatus');
        const preview = document.getElementById(type + 'PhotoPreview');
        
        card.classList.add('has-photo');
        icon.textContent = '‚úÖ';
        status.textContent = '¬°Capturada!';
        preview.innerHTML = `<img src="${photoData}" alt="Vista ${type}">`;
        
        // Enable AI button if at least side photo is available
        updateAIButtonState();
        
        if (typeof showToast === 'function') {
            showToast(`üì∑ Foto ${type === 'side' ? 'lateral' : type === 'back' ? 'trasera' : 'superior'} capturada`, 'success');
        }
    };
    reader.readAsDataURL(file);
}

// Update AI button state
function updateAIButtonState() {
    const btn = document.getElementById('btnAnalyzeAI');
    const hasPhotos = estimacionActual.fotos.lateral || estimacionActual.fotos.trasera;
    btn.disabled = !hasPhotos;
    
    if (hasPhotos) {
        btn.style.opacity = '1';
        btn.style.cursor = 'pointer';
    }
}

// ============================================
// ü§ñ GEMINI AI ANALYSIS
// ============================================

async function analyzeWithGemini() {
    // Check for API key
    const apiKey = localStorage.getItem('geminiApiKey');
    if (!apiKey) {
        if (typeof showToast === 'function') {
            showToast('‚ùå Configura tu API Key de Gemini en la pesta√±a Config', 'error');
        }
        // Try to switch to config tab
        if (typeof switchTab === 'function') {
            switchTab('config');
        }
        return;
    }
    
    // Check for photos
    if (!estimacionActual.fotos.lateral && !estimacionActual.fotos.trasera) {
        if (typeof showToast === 'function') {
            showToast('üì∑ Captura al menos una foto (lateral o trasera)', 'warning');
        }
        return;
    }
    
    // Show loading
    document.getElementById('aiAnalysisLoading').style.display = 'block';
    document.getElementById('aiMeasurementResults').style.display = 'none';
    document.getElementById('resultadosPesoFoto').style.display = 'none';
    
    try {
        // Build the prompt
        const prompt = buildMeasurementPrompt();
        
        // Prepare images for API
        const imageParts = [];
        
        if (estimacionActual.fotos.lateral) {
            imageParts.push({
                inlineData: {
                    mimeType: 'image/jpeg',
                    data: estimacionActual.fotos.lateral.split(',')[1]
                }
            });
        }
        
        if (estimacionActual.fotos.trasera) {
            imageParts.push({
                inlineData: {
                    mimeType: 'image/jpeg',
                    data: estimacionActual.fotos.trasera.split(',')[1]
                }
            });
        }
        
        if (estimacionActual.fotos.superior) {
            imageParts.push({
                inlineData: {
                    mimeType: 'image/jpeg',
                    data: estimacionActual.fotos.superior.split(',')[1]
                }
            });
        }
        
        // Call Gemini API
        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=${apiKey}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                contents: [{
                    parts: [
                        { text: prompt },
                        ...imageParts
                    ]
                }],
                generationConfig: {
                    temperature: 0.2,
                    maxOutputTokens: 1024
                }
            })
        });
        
        if (!response.ok) {
            throw new Error(`API Error: ${response.status}`);
        }
        
        const data = await response.json();
        
        // Parse the response
        const aiText = data.candidates?.[0]?.content?.parts?.[0]?.text || '';
        const measurements = parseAIMeasurements(aiText);
        
        // Update UI with AI results
        displayAIResults(measurements);
        
        // Auto-calculate weight
        calcularPesoFoto();
        
        estimacionActual.metodo = 'IA Gemini';
        
        if (typeof showToast === 'function') {
            showToast('ü§ñ An√°lisis completado', 'success');
        }
        
    } catch (error) {
        console.error('Gemini API Error:', error);
        if (typeof showToast === 'function') {
            showToast('‚ùå Error en an√°lisis: ' + error.message, 'error');
        }
    } finally {
        document.getElementById('aiAnalysisLoading').style.display = 'none';
    }
}

// Build measurement prompt for Gemini
function buildMeasurementPrompt() {
    return `Eres un experto en medici√≥n de ganado bovino. Analiza las im√°genes de un animal dentro de una manga ganadera (cattle chute) y estima sus medidas corporales.

## REFERENCIAS DE LA MANGA (CALIBRACI√ìN):
- Altura total de barras: ${MANGA.altura} cm
- Espacio entre barras horizontales: ${MANGA.espacioBarras} cm
- Di√°metro de cada tubo/barra: ${MANGA.diametroTubo} cm
- Ancho interno (entre columnas): ${MANGA.anchoInterno} cm
- Ancho de columnas cuadradas: ${MANGA.anchoColumna} cm
- Largo secci√≥n 1: ${MANGA.seccion1} cm
- Largo secci√≥n 2: ${MANGA.seccion2} cm

## INSTRUCCIONES:
1. Identifica las barras horizontales de la manga en la imagen
2. Usa las barras como escala de referencia (cada espacio = 23cm, cada tubo = 5cm)
3. Estima las siguientes medidas del animal:
   - LARGO: Distancia desde el hombro hasta la base de la cola
   - ALTURA: Desde el suelo hasta la cruz (punto m√°s alto del lomo)
   - ANCHO: Parte m√°s ancha del cuerpo (vista trasera)
   - PERIMETRO_TORACICO: Circunferencia del t√≥rax detr√°s de las patas delanteras (si es posible estimar)

## FORMATO DE RESPUESTA (JSON):
{
  "largo_cm": <n√∫mero>,
  "altura_cm": <n√∫mero>,
  "ancho_cm": <n√∫mero>,
  "perimetro_cm": <n√∫mero o null si no se puede estimar>,
  "confianza": <n√∫mero 0-100>,
  "notas": "<observaciones sobre la calidad de la imagen o dificultades>"
}

Solo responde con el JSON, sin texto adicional.`;
}

// Parse AI response
function parseAIMeasurements(aiText) {
    try {
        // Try to extract JSON from the response
        let jsonStr = aiText;
        
        // Check if response contains markdown code block
        const jsonMatch = aiText.match(/```(?:json)?\s*([\s\S]*?)\s*```/);
        if (jsonMatch) {
            jsonStr = jsonMatch[1];
        }
        
        // Try to find JSON object in the text
        const objectMatch = jsonStr.match(/\{[\s\S]*\}/);
        if (objectMatch) {
            jsonStr = objectMatch[0];
        }
        
        const parsed = JSON.parse(jsonStr);
        
        return {
            largo: parsed.largo_cm || null,
            altura: parsed.altura_cm || null,
            ancho: parsed.ancho_cm || null,
            perimetro: parsed.perimetro_cm || null,
            confianza: parsed.confianza || 70,
            notas: parsed.notas || null
        };
    } catch (e) {
        console.error('Error parsing AI response:', e, aiText);
        
        // Try to extract numbers from text as fallback
        const largoMatch = aiText.match(/largo[:\s]+(\d+(?:\.\d+)?)/i);
        const alturaMatch = aiText.match(/altura[:\s]+(\d+(?:\.\d+)?)/i);
        const anchoMatch = aiText.match(/ancho[:\s]+(\d+(?:\.\d+)?)/i);
        
        return {
            largo: largoMatch ? parseFloat(largoMatch[1]) : null,
            altura: alturaMatch ? parseFloat(alturaMatch[1]) : null,
            ancho: anchoMatch ? parseFloat(anchoMatch[1]) : null,
            perimetro: null,
            confianza: 50,
            notas: 'An√°lisis parcial - algunos valores pueden requerir ajuste manual'
        };
    }
}

// Display AI results
function displayAIResults(measurements) {
    const resultsDiv = document.getElementById('aiMeasurementResults');
    
    // Update measurement displays
    if (measurements.largo) {
        document.getElementById('aiLargo').textContent = `${measurements.largo} cm`;
        document.getElementById('inputLargoCuerpo').value = measurements.largo;
    }
    
    if (measurements.altura) {
        document.getElementById('aiAltura').textContent = `${measurements.altura} cm`;
        document.getElementById('inputAlturaCruz').value = measurements.altura;
    }
    
    if (measurements.ancho) {
        document.getElementById('aiAncho').textContent = `${measurements.ancho} cm`;
        document.getElementById('inputAnchoCuerpo').value = measurements.ancho;
    }
    
    if (measurements.perimetro) {
        document.getElementById('aiPerimetro').textContent = `${measurements.perimetro} cm`;
        document.getElementById('inputPerimetroToracico').value = measurements.perimetro;
    } else {
        document.getElementById('aiPerimetro').textContent = 'Calculado';
    }
    
    // Update confidence
    document.getElementById('aiConfidenceValue').textContent = `${measurements.confianza}%`;
    document.getElementById('aiConfidenceBar').style.width = `${measurements.confianza}%`;
    
    // Show notes if any
    if (measurements.notas) {
        document.getElementById('aiNotes').style.display = 'block';
        document.getElementById('aiNotesText').textContent = measurements.notas;
    } else {
        document.getElementById('aiNotes').style.display = 'none';
    }
    
    // Show results section
    resultsDiv.style.display = 'block';
    resultsDiv.classList.add('show');
    
    // Store in estimation data
    estimacionActual.medidas = {
        largo: measurements.largo,
        altura: measurements.altura,
        ancho: measurements.ancho,
        perimetro: measurements.perimetro
    };
}

// ============================================
// WEIGHT CALCULATION
// ============================================

function calcularPesoFoto() {
    const largo = parseFloat(document.getElementById('inputLargoCuerpo').value) || 0;
    const altura = parseFloat(document.getElementById('inputAlturaCruz').value) || 0;
    const ancho = parseFloat(document.getElementById('inputAnchoCuerpo').value) || 0;
    let perimetro = parseFloat(document.getElementById('inputPerimetroToracico').value) || 0;
    
    // Need at least length, height, and width
    if (largo < 50 || altura < 60 || ancho < 20) {
        document.getElementById('resultadosPesoFoto').style.display = 'none';
        return;
    }
    
    // Calculate perimeter if not provided
    if (!perimetro || perimetro < 80) {
        const a = ancho / 2;
        const b = (altura * 0.65) / 2;
        perimetro = Math.PI * Math.sqrt(2 * (a * a + b * b)) * 2 * 1.05;
        perimetro = Math.round(perimetro * 10) / 10;
        
        // Update AI perimeter display if it wasn't set
        if (!document.getElementById('inputPerimetroToracico').value) {
            document.getElementById('aiPerimetro').textContent = `${perimetro} cm`;
        }
    }
    
    // Store measurements
    estimacionActual.medidas = { largo, altura, ancho, perimetro };
    
    // Calculate weight using multiple formulas
    const P = perimetro;
    const L = largo;
    
    const pesoSchaeffer = (P * P * L) / 10840;
    const pesoCrevat = (P * P * L) / 11880;
    const pesoQuetelet = (P * P * L) / 10000;
    
    const pesoPromedio = (pesoSchaeffer + pesoCrevat + pesoQuetelet) / 3;
    
    const pesoMin = Math.round(pesoPromedio * 0.9);
    const pesoMax = Math.round(pesoPromedio * 1.1);
    const pesoFinal = Math.round(pesoPromedio);
    
    // Calculate confidence
    let confianza = 70;
    if (estimacionActual.fotos.lateral) confianza += 10;
    if (estimacionActual.fotos.trasera) confianza += 10;
    if (estimacionActual.fotos.superior) confianza += 5;
    if (estimacionActual.metodo === 'IA Gemini') confianza += 5;
    confianza = Math.min(confianza, 95);
    
    // Store result
    estimacionActual.resultado = {
        peso: pesoFinal,
        rango: { min: pesoMin, max: pesoMax },
        perimetroCalculado: perimetro,
        confianza: confianza,
        fecha: new Date().toISOString(),
        metodo: estimacionActual.metodo
    };
    
    // Update UI
    document.getElementById('resultadoPesoKg').textContent = `${pesoFinal} kg`;
    document.getElementById('resultadoRango').textContent = `Rango: ${pesoMin} - ${pesoMax} kg`;
    document.getElementById('resultadoPerimetro').textContent = `${perimetro} cm`;
    document.getElementById('resultadoConfianza').textContent = `${confianza}%`;
    document.getElementById('resultadoMetodo').textContent = estimacionActual.metodo === 'IA Gemini' ? 'ü§ñ IA' : '‚úèÔ∏è Manual';
    
    // Calculate GDP if we have entry weight
    if (estimacionActual.animalId) {
        const inventario = typeof getInventario === 'function' ? getInventario() : [];
        const animal = inventario.find(a => (a.numero || a.chapeta) === estimacionActual.animalId);
        if (animal && animal.peso && animal.fecha) {
            const diasEnFinca = Math.floor((new Date() - new Date(animal.fecha)) / (1000 * 60 * 60 * 24));
            if (diasEnFinca > 0) {
                const ganancia = pesoFinal - animal.peso;
                const gdp = Math.round((ganancia / diasEnFinca) * 1000);
                document.getElementById('resultadoGDP').textContent = `${gdp} g/d√≠a`;
            }
        }
    }
    
    // Show results
    document.getElementById('resultadosPesoFoto').style.display = 'block';
    document.getElementById('resultadosPesoFoto').classList.add('show');
}

// ============================================
// UTILITY FUNCTIONS
// ============================================

function toggleManualInput() {
    const section = document.getElementById('manualInputSection');
    section.style.display = section.style.display === 'none' ? 'block' : 'none';
}

function syncManualToAI(field) {
    const value = document.getElementById('manual' + field.charAt(0).toUpperCase() + field.slice(1)).value;
    const targetId = field === 'largo' ? 'inputLargoCuerpo' : 
                     field === 'altura' ? 'inputAlturaCruz' :
                     field === 'ancho' ? 'inputAnchoCuerpo' : 'inputPerimetroToracico';
    document.getElementById(targetId).value = value;
    calcularPesoFoto();
}

function guardarPesoFoto() {
    if (!estimacionActual.resultado || !estimacionActual.animalId) {
        if (typeof showToast === 'function') {
            showToast('Selecciona un animal y completa las mediciones', 'warning');
        }
        return;
    }
    
    const historialKey = 'pesoFotoHistorial_' + (typeof currentRanch !== 'undefined' ? currentRanch : 'default');
    let historial = JSON.parse(localStorage.getItem(historialKey) || '[]');
    
    historial.unshift({
        id: Date.now(),
        animalId: estimacionActual.animalId,
        fecha: new Date().toISOString(),
        medidas: { ...estimacionActual.medidas },
        resultado: { ...estimacionActual.resultado },
        metodo: estimacionActual.metodo,
        fotos: {
            lateral: !!estimacionActual.fotos.lateral,
            trasera: !!estimacionActual.fotos.trasera,
            superior: !!estimacionActual.fotos.superior
        }
    });
    
    historial = historial.slice(0, 100);
    localStorage.setItem(historialKey, JSON.stringify(historial));
    
    cargarHistorialPesos();
    
    if (typeof showToast === 'function') {
        showToast(`‚úÖ Peso ${estimacionActual.resultado.peso} kg guardado (${estimacionActual.metodo})`, 'success');
    }
}

function cargarHistorialPesos() {
    const historialKey = 'pesoFotoHistorial_' + (typeof currentRanch !== 'undefined' ? currentRanch : 'default');
    const historial = JSON.parse(localStorage.getItem(historialKey) || '[]');
    const tbody = document.getElementById('historialPesosTable');
    
    if (!tbody) return;
    
    if (historial.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="text-center" style="color: #9ca3af;">No hay estimaciones guardadas</td></tr>';
        return;
    }
    
    tbody.innerHTML = historial.slice(0, 20).map(est => `
        <tr>
            <td>${new Date(est.fecha).toLocaleDateString('es-CO')}</td>
            <td><strong>${est.animalId}</strong></td>
            <td style="font-weight: 700; color: #059669;">${est.resultado.peso} kg</td>
            <td style="font-size: 0.75rem;">${est.metodo === 'IA Gemini' ? 'ü§ñ' : '‚úèÔ∏è'} ${est.metodo || 'Manual'}</td>
            <td>${est.resultado.confianza}%</td>
        </tr>
    `).join('');
}

function nuevaEstimacion() {
    ['side', 'back', 'top'].forEach(type => {
        const card = document.getElementById(type + 'PhotoCard');
        const icon = document.getElementById(type + 'PhotoIcon');
        const status = document.getElementById(type + 'PhotoStatus');
        const preview = document.getElementById(type + 'PhotoPreview');
        const input = document.getElementById(type + 'PhotoInput');
        
        if (card) card.classList.remove('has-photo');
        if (icon) icon.textContent = 'üì∑';
        if (status) status.textContent = 'Toca para capturar';
        if (preview) preview.innerHTML = '';
        if (input) input.value = '';
    });
    
    document.getElementById('inputLargoCuerpo').value = '';
    document.getElementById('inputAlturaCruz').value = '';
    document.getElementById('inputAnchoCuerpo').value = '';
    document.getElementById('inputPerimetroToracico').value = '';
    
    document.getElementById('aiMeasurementResults').style.display = 'none';
    document.getElementById('resultadosPesoFoto').style.display = 'none';
    
    document.getElementById('btnAnalyzeAI').disabled = true;
    
    estimacionActual.fotos = { lateral: null, trasera: null, superior: null };
    estimacionActual.medidas = { largo: null, altura: null, ancho: null, perimetro: null };
    estimacionActual.resultado = null;
    estimacionActual.metodo = 'manual';
    
    if (typeof showToast === 'function') {
        showToast('üîÑ Listo para nueva estimaci√≥n', 'info');
    }
}

function mostrarGuiaMedicion() {
    document.getElementById('guiaMedicionModal').classList.add('active');
}

function cerrarGuiaMedicion() {
    document.getElementById('guiaMedicionModal').classList.remove('active');
}

function calcularPorBarras() {
    const espacios = parseFloat(document.getElementById('calcBarras').value) || 0;
    const tubos = parseFloat(document.getElementById('calcTubos').value) || 0;
    const totalCm = (espacios * MANGA.espacioBarras) + (tubos * MANGA.diametroTubo);
    document.getElementById('calcResultado').textContent = `= ${totalCm} cm`;
}

function verHistorialPesos() {
    document.querySelector('#historialPesosTable').closest('.card').scrollIntoView({ behavior: 'smooth' });
}

document.addEventListener('click', function(e) {
    if (e.target.classList.contains('modal') && e.target.classList.contains('active')) {
        e.target.classList.remove('active');
    }
});
</script>
