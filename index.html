<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Ganado Finca">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#2e7d32">
    <meta name="description" content="Sistema de Gesti√≥n Ganadera para Fincas">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%232e7d32' width='100' height='100' rx='20'/><text x='50' y='65' font-size='50' text-anchor='middle' fill='white'>üêÇ</text></svg>">
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="icon" type="image/png" href="data:image/svg+xml,<svg xmlns=%27http://www.w3.org/2000/svg%27 viewBox=%270 0 100 100%27><rect fill=%27%232e7d32%27 width=%27100%27 height=%27100%27 rx=%2720%27/><text x=%2750%27 y=%2770%27 font-size=%2760%27 text-anchor=%27middle%27 fill=%27white%27>üêÇ</text></svg>">
    <title>Ganado Finca - Sistema de Gesti√≥n</title>
    <!-- v2.2 - Embedded default API key for all family devices -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    
    <!-- Firebase Configuration -->
    <script src="firebase-config.js"></script>
    
    <!-- Cloud Sync Module (v7 = force download on button click) -->
    <script src="cloud-sync.js?v=9"></script>
    
    <!-- Google Fonts - Professional Typography -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    
    <style>
        :root {
            /* Primary Colors - Rich Forest Green */
            --primary: #1a472a;
            --primary-light: #2d6a4f;
            --primary-dark: #0d2818;
            --primary-gradient: linear-gradient(135deg, #1a472a 0%, #2d6a4f 50%, #40916c 100%);
            --primary-glow: 0 4px 20px rgba(26, 71, 42, 0.4);
            
            /* Accent Colors */
            --accent: #d4a373;
            --accent-gold: #e9c46a;
            
            /* Status Colors - Vibrant */
            --success: #10b981;
            --success-light: #d1fae5;
            --warning: #f59e0b;
            --warning-light: #fef3c7;
            --danger: #ef4444;
            --danger-light: #fee2e2;
            --info: #3b82f6;
            --info-light: #dbeafe;
            
            /* Neutrals */
            --white: #ffffff;
            --light: #f8faf9;
            --gray: #6b7280;
            --dark: #1f2937;
            --border: #e5e7eb;
            
            /* Shadows */
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.1), 0 1px 2px rgba(0,0,0,0.06);
            --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
            --shadow-xl: 0 20px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04);
            
            /* Border Radius */
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-xl: 24px;
            --radius-full: 9999px;
            
            /* Safe Areas & Nav */
            --safe-top: env(safe-area-inset-top);
            --safe-bottom: env(safe-area-inset-bottom);
            --bottom-nav-height: 80px;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(180deg, #f3f4f6 0%, #e5e7eb 100%);
            background-attachment: fixed;
            min-height: 100vh;
            min-height: -webkit-fill-available;
            color: var(--dark);
            line-height: 1.6;
            padding-bottom: calc(var(--bottom-nav-height) + var(--safe-bottom) + 20px);
            -webkit-font-smoothing: antialiased;
            transition: background 0.5s ease;
        }
        
        @media (min-width: 1024px) {
            body {
                padding-bottom: 2rem;
            }
        }
        
        /* Ranch-specific body backgrounds */
        body.theme-coruna-bg {
            background: linear-gradient(135deg, #fffde7 0%, #fff9c4 100%) !important;
        }

        body.theme-catalina-bg {
            background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%) !important;
        }
        
        body.theme-vega-bg {
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%) !important;
        }

        body.theme-fernando-bg {
            background: linear-gradient(135deg, #e0f2fe 0%, #bae6fd 100%) !important;
        }

        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 1rem 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 1.5rem;
            font-weight: bold;
        }
        
        .logo-icon {
            font-size: 2rem;
        }
        
        .header-stats {
            display: flex;
            gap: 2rem;
            font-size: 0.9rem;
        }
        
        .header-stat {
            text-align: center;
        }
        
        .header-stat-value {
            font-size: 1.25rem;
            font-weight: bold;
        }

        .app-version-badge {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.35);
            padding: 0.35rem 0.6rem;
            border-radius: 999px;
            font-size: 0.8rem;
            font-weight: 600;
            letter-spacing: 0.02em;
            white-space: nowrap;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 1.5rem;
        }
        
        /* Navigation Tabs */
        .nav-tabs {
            display: flex;
            gap: 0.5rem;
            background: var(--white);
            padding: 0.5rem;
            border-radius: 12px;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            flex-wrap: wrap;
        }
        
        .nav-tab {
            padding: 0.75rem 1.25rem;
            border: none;
            background: transparent;
            cursor: pointer;
            border-radius: 8px;
            font-size: 0.95rem;
            font-weight: 500;
            color: var(--gray);
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .nav-tab:hover {
            background: var(--light);
            color: var(--primary);
        }
        
        .nav-tab.active {
            background: var(--primary);
            color: white;
        }
        
        .nav-tab-icon {
            font-size: 1.1rem;
        }
        
        /* Tab Content */
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Cards */
        .card {
            background: var(--white);
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 1.5rem;
            overflow: hidden;
        }
        
        .card-header {
            background: linear-gradient(135deg, var(--primary-light) 0%, var(--primary) 100%);
            color: white;
            padding: 1rem 1.5rem;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .card-header.compras { background: linear-gradient(135deg, #4CAF50, #2E7D32); }
        .card-header.nacimientos { background: linear-gradient(135deg, #2196F3, #1565C0); }
        .card-header.ventas { background: linear-gradient(135deg, #FF9800, #E65100); }
        .card-header.muertes { background: linear-gradient(135deg, #607D8B, #37474F); }
        
        .card-body {
            padding: 1.5rem;
        }
        
        /* Event Type Cards */
        .event-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .event-card {
            background: var(--white);
            border-radius: 12px;
            padding: 1.5rem;
            cursor: pointer;
            transition: all 0.3s;
            border: 3px solid transparent;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .event-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        }
        
        .event-card.compras { border-color: #4CAF50; }
        .event-card.compras:hover { background: #E8F5E9; }
        .event-card.nacimientos { border-color: #2196F3; }
        .event-card.nacimientos:hover { background: #E3F2FD; }
        .event-card.ventas { border-color: #FF9800; }
        .event-card.ventas:hover { background: #FFF3E0; }
        .event-card.muertes { border-color: #607D8B; }
        .event-card.muertes:hover { background: #ECEFF1; }
        
        .event-card-icon {
            font-size: 2.5rem;
            margin-bottom: 0.75rem;
        }
        
        .event-card-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 0.5rem;
        }
        
        .event-card-desc {
            color: var(--gray);
            font-size: 0.9rem;
        }
        
        /* Forms */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }
        
        .form-group {
            margin-bottom: 1rem;
        }
        
        .form-group.full-width {
            grid-column: 1 / -1;
        }
        
        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--dark);
        }
        
        .form-label .required {
            color: var(--danger);
        }
        
        .form-input, .form-select {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.2s;
        }
        
        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: var(--primary);
        }
        
        .form-hint {
            font-size: 0.8rem;
            color: var(--gray);
            margin-top: 0.25rem;
        }
        
        .form-calculated {
            background: #f0f7f0;
            font-weight: 600;
            color: var(--primary);
        }
        
        /* Buttons */
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .btn-primary {
            background: var(--primary);
            color: white;
        }
        
        .btn-primary:hover {
            background: var(--primary-dark);
        }
        
        .btn-success {
            background: var(--success);
            color: white;
        }
        
        .btn-success:hover {
            background: #218838;
        }
        
        .btn-warning {
            background: var(--warning);
            color: var(--dark);
        }
        
        .btn-danger {
            background: var(--danger);
            color: white;
        }
        
        .btn-danger:hover {
            background: #c82333;
        }
        
        .btn-secondary {
            background: var(--gray);
            color: white;
        }
        
        .btn-outline {
            background: transparent;
            border: 2px solid var(--primary);
            color: var(--primary);
        }
        
        .btn-outline:hover {
            background: var(--primary);
            color: white;
        }
        
        .btn-group {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
            margin-top: 1rem;
        }
        
        /* Tables */
        .table-container {
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        .sticky-col {
            position: sticky;
            left: 0;
            z-index: 2;
            background: var(--white);
        }

        thead .sticky-col {
            z-index: 4;
            background: var(--light);
        }

        tfoot .sticky-col {
            z-index: 3;
        }
        
        th {
            background: var(--light);
            font-weight: 600;
            color: var(--dark);
            white-space: nowrap;
        }
        
        th.sortable {
            cursor: pointer;
            user-select: none;
            position: relative;
            padding-right: 1.5rem;
        }
        
        th.sortable:hover {
            background: #e9ecef;
        }
        
        th.sortable::after {
            content: '‚áÖ';
            position: absolute;
            right: 0.5rem;
            opacity: 0.3;
            font-size: 0.8rem;
        }
        
        th.sortable.asc::after {
            content: '‚Üë';
            opacity: 1;
            color: var(--primary);
        }
        
        th.sortable.desc::after {
            content: '‚Üì';
            opacity: 1;
            color: var(--primary);
        }
        
        tr:hover {
            background: #f8fff8;
        }

        tfoot .summary-row td {
            background: #f3f7f2;
            font-weight: 600;
            border-top: 2px solid var(--border);
        }

        tfoot .summary-row.summary-average td {
            background: #f8faf8;
            font-weight: 500;
        }

        .summary-label {
            color: var(--primary-dark);
            white-space: nowrap;
        }
        
        .text-right {
            text-align: right;
        }
        
        .text-center {
            text-align: center;
        }
        
        /* Status badges */
        .badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        .badge-success { background: #d4edda; color: #155724; }
        .badge-warning { background: #fff3cd; color: #856404; }
        .badge-danger { background: #f8d7da; color: #721c24; }
        .badge-info { background: #d1ecf1; color: #0c5460; }
        .badge-secondary { background: #e2e3e5; color: #383d41; }
        
        /* Summary boxes */
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .summary-box {
            background: var(--white);
            border-radius: var(--radius-xl);
            padding: 1.5rem 1rem;
            text-align: center;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            cursor: pointer;
        }
        
        .summary-box::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--primary-gradient);
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }
        
        .summary-box:hover::before {
            transform: scaleX(1);
        }
        
        .summary-box:hover {
            transform: translateY(-6px);
            box-shadow: var(--shadow-xl);
        }
        
        .summary-box:active {
            transform: scale(0.98);
        }
        
        .summary-box-icon {
            font-size: 3.5rem;
            margin-bottom: 0.5rem;
            display: block;
            filter: drop-shadow(0 4px 6px rgba(0,0,0,0.1));
            transition: transform 0.3s ease;
        }
        
        .summary-box:hover .summary-box-icon {
            transform: scale(1.1) rotate(-5deg);
        }
        
        .summary-box-value {
            font-size: 1.75rem;
            font-weight: 900;
            color: #111827;
            margin-bottom: 0.125rem;
            letter-spacing: -1px;
        }
        
        .summary-box-label {
            font-size: 0.7rem;
            color: var(--gray);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 700;
        }
        
        /* Mobile: 2 columns */
        @media (max-width: 480px) {
            .summary-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 0.75rem;
            }
            .summary-box {
                padding: 1rem 0.75rem;
            }
            .summary-box-icon {
                font-size: 2.75rem;
            }
            .summary-box-value {
                font-size: 1.35rem;
            }
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: var(--white);
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--gray);
        }
        
        .modal-body {
            padding: 1.5rem;
        }
        
        .modal-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
        }
        
        /* Toast notifications */
        .toast-container {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 2000;
        }
        
        .toast {
            background: var(--dark);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            margin-bottom: 0.5rem;
            animation: slideIn 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .toast.success { background: var(--success); }
        .toast.error { background: var(--danger); }
        .toast.warning { background: var(--warning); color: var(--dark); }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        /* Animal selector */
        .animal-selector {
            max-height: 300px;
            overflow-y: auto;
            border: 2px solid var(--border);
            border-radius: 8px;
            margin-bottom: 1rem;
        }
        
        .animal-option {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .animal-option:hover {
            background: var(--light);
        }
        
        .animal-option.selected {
            background: #e8f5e9;
            border-left: 4px solid var(--primary);
        }
        
        .animal-option:last-child {
            border-bottom: none;
        }
        
        /* Filters */
        .filters {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .filters .form-input,
        .filters .form-select {
            width: auto;
            min-width: 150px;
        }
        
        /* Responsive - Tablet */
        @media (max-width: 768px) {
            .header-stats {
                display: none;
            }

            .nav-tabs {
                justify-content: center;
            }

            .nav-tab {
                padding: 0.5rem 0.75rem;
                font-size: 0.85rem;
            }

            .nav-tab span:not(.nav-tab-icon) {
                display: none;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }
        }

        /* ========== MOBILE OPTIMIZATIONS ========== */
        @media (max-width: 480px) {
            /* Safe area for notched phones */
            body {
                padding-bottom: env(safe-area-inset-bottom, 0);
            }

            /* Container padding */
            .container {
                padding: 0.75rem;
                padding-bottom: 5.5rem; /* Space for bottom nav */
            }

            /* Header - More compact */
            .header {
                padding: 0.75rem 1rem;
            }

            .header h1 {
                font-size: 1.1rem;
            }

            .ranch-selector {
                gap: 0.25rem;
            }

            .ranch-btn {
                padding: 0.4rem 0.6rem;
                font-size: 0.75rem;
            }

            .ranch-icon {
                font-size: 1rem;
            }

            .ranch-name {
                display: none;
            }

            /* Bottom Navigation for Mobile */
            .nav-tabs {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                margin: 0;
                border-radius: 0;
                padding: 0.5rem;
                padding-bottom: calc(0.5rem + env(safe-area-inset-bottom, 0));
                background: var(--white);
                box-shadow: 0 -2px 10px rgba(0,0,0,0.15);
                z-index: 100;
                justify-content: space-around;
                flex-wrap: nowrap;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                gap: 0.25rem;
            }

            .nav-tab {
                flex-direction: column;
                padding: 0.5rem 0.4rem;
                font-size: 0.65rem;
                min-width: 52px;
                flex-shrink: 0;
                gap: 0.2rem;
                border-radius: 8px;
            }

            .nav-tab-icon {
                font-size: 1.3rem;
            }

            .nav-tab span:not(.nav-tab-icon) {
                display: block;
                font-size: 0.6rem;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                max-width: 50px;
            }

            /* Larger touch targets for buttons */
            .btn {
                min-height: 44px;
                padding: 0.75rem 1rem;
                font-size: 0.95rem;
            }

            .btn-group {
                flex-direction: column;
                gap: 0.5rem;
            }

            .btn-group .btn {
                width: 100%;
            }

            /* Form inputs - Larger for touch */
            .form-input, .form-select, select, input[type="text"], input[type="number"], input[type="date"], textarea {
                min-height: 48px;
                font-size: 16px !important; /* Prevents iOS zoom */
                padding: 0.75rem;
                border-radius: 10px;
            }

            .form-label {
                font-size: 0.9rem;
                margin-bottom: 0.5rem;
            }

            .form-group {
                margin-bottom: 1rem;
            }

            /* Cards - Full width */
            .card {
                border-radius: 12px;
                margin-bottom: 1rem;
            }

            .card-header {
                padding: 0.75rem 1rem;
                font-size: 0.95rem;
            }

            .card-body {
                padding: 1rem;
            }

            /* Summary boxes - Better mobile layout */
            .summary-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 0.5rem;
            }

            .summary-box {
                padding: 0.75rem;
                border-radius: 12px;
            }

            .summary-box-icon {
                font-size: 2rem;
            }

            .summary-box-value {
                font-size: 1.25rem;
            }

            .summary-box-label {
                font-size: 0.7rem;
            }

            /* Tables - Horizontal scroll */
            .table-container {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                margin: 0 -1rem;
                padding: 0 1rem;
            }

            table {
                font-size: 0.85rem;
            }

            th, td {
                padding: 0.5rem 0.4rem;
                white-space: nowrap;
            }

            /* Clickable rows - Larger touch area */
            .clickable-row {
                min-height: 48px;
            }

            /* Modal - Full screen on mobile */
            .modal-content {
                width: 100%;
                max-width: 100%;
                height: 100%;
                max-height: 100%;
                border-radius: 0;
                margin: 0;
            }

            .modal-header {
                padding: 1rem;
                position: sticky;
                top: 0;
                background: white;
                z-index: 10;
            }

            .modal-body {
                padding: 1rem;
                padding-bottom: 2rem;
            }

            .modal-close {
                font-size: 2rem;
                min-width: 44px;
                min-height: 44px;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            /* Toast - Full width on mobile */
            .toast-container {
                left: 0.5rem;
                right: 0.5rem;
                top: auto;
                bottom: 5rem;
            }

            .toast {
                width: 100%;
            }

            /* Filters - Stack on mobile */
            .filters {
                flex-direction: column;
                align-items: stretch;
                gap: 0.5rem;
            }

            .filters .form-input,
            .filters .form-select,
            .filters select {
                width: 100%;
                min-width: auto;
            }

            /* Cr√≠a tab sub-navigation */
            .cria-tabs, [style*="display: flex"][style*="gap: 0.5rem"] {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                padding-bottom: 0.5rem;
                flex-wrap: nowrap !important;
            }

            /* Animal profile modal */
            .profile-section {
                margin-bottom: 1rem;
                padding: 0.75rem;
            }

            .profile-grid {
                grid-template-columns: 1fr 1fr;
                gap: 0.5rem;
            }

            .profile-item {
                padding: 0.5rem;
            }

            .profile-item-value.large {
                font-size: 1.1rem;
            }

            /* Quick action buttons */
            [style*="display: flex"][style*="gap: 0.5rem"] button,
            [style*="display: flex"][style*="gap: 1rem"] button {
                flex: 1;
                min-height: 44px;
            }

            /* Better spacing for inline elements */
            .badge {
                padding: 0.35rem 0.6rem;
                font-size: 0.75rem;
            }

            /* Photo grid */
            .photo-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 0.5rem;
            }

            /* Hide scrollbars but allow scroll */
            .nav-tabs::-webkit-scrollbar,
            .table-container::-webkit-scrollbar {
                display: none;
            }

            .nav-tabs, .table-container {
                -ms-overflow-style: none;
                scrollbar-width: none;
            }
        }

        /* Extra small phones */
        @media (max-width: 360px) {
            .nav-tab {
                min-width: 45px;
                padding: 0.4rem 0.3rem;
            }

            .nav-tab-icon {
                font-size: 1.2rem;
            }

            .nav-tab span:not(.nav-tab-icon) {
                font-size: 0.55rem;
                max-width: 40px;
            }

            .summary-box-icon {
                font-size: 1.75rem;
            }

            .summary-box-value {
                font-size: 1.1rem;
            }
        }

        /* Landscape mode on phones */
        @media (max-width: 812px) and (orientation: landscape) {
            .nav-tabs {
                padding: 0.25rem 0.5rem;
            }

            .nav-tab {
                flex-direction: row;
                padding: 0.4rem 0.6rem;
            }

            .nav-tab span:not(.nav-tab-icon) {
                display: block;
                font-size: 0.7rem;
            }

            .container {
                padding-bottom: 4rem;
            }
        }

        /* Photos tab mobile fixes */
        @media (max-width: 500px) {
            /* Photo options grid: 2 columns on mobile */
            #tab-fotos .card-body > div:first-child {
                grid-template-columns: repeat(2, 1fr) !important;
                gap: 0.5rem !important;
            }

            /* Make photo option boxes more compact */
            #tab-fotos .card-body > div:first-child > div {
                padding: 0.6rem !important;
            }

            #tab-fotos .card-body > div:first-child > div h4 {
                font-size: 0.75rem !important;
            }

            #tab-fotos .card-body > div:first-child > div p {
                font-size: 0.6rem !important;
            }

            #tab-fotos .card-body > div:first-child > div span:first-child {
                font-size: 1rem !important;
            }

            #tab-fotos .card-body > div:first-child > div button {
                padding: 0.4rem !important;
                font-size: 0.7rem !important;
            }

            /* Animal photos grid: single column on very small screens */
            #animalPhotosGrid {
                grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)) !important;
            }
        }

        /* Extra small phones */
        @media (max-width: 380px) {
            #tab-fotos .card-body > div:first-child {
                grid-template-columns: 1fr 1fr !important;
            }

            #tab-fotos .card-body > div:first-child > div {
                padding: 0.5rem !important;
            }

            #tab-fotos .card-body > div:first-child > div h4 {
                font-size: 0.65rem !important;
            }

            #tab-fotos .card-body > div:first-child > div button {
                padding: 0.3rem !important;
                font-size: 0.65rem !important;
            }
        }

        /* Progreso tab mobile fixes */
        @media (max-width: 600px) {
            /* Performance tiers: 1 column on mobile */
            #performanceTiers {
                grid-template-columns: 1fr !important;
                gap: 0.75rem !important;
            }

            #performanceTiers > div {
                padding: 1rem !important;
            }

            #performanceTiers h3 {
                font-size: 1rem !important;
            }

            #performanceTiers > div > div > div:first-child {
                font-size: 2rem !important;
            }

            /* Action lists: 1 column on mobile */
            #tab-progreso .card-body > div[style*="grid-template-columns: repeat(3"] {
                grid-template-columns: 1fr !important;
                gap: 0.75rem !important;
            }

            /* Herd summary: 2x2 grid on mobile */
            #herdSummary {
                grid-template-columns: repeat(2, 1fr) !important;
                gap: 0.5rem !important;
                padding: 0.75rem !important;
            }

            #herdSummary > div > div:first-child {
                font-size: 0.7rem !important;
            }

            #herdSummary > div > div:last-child {
                font-size: 1.2rem !important;
            }

            /* Quick actions row in progreso */
            #tab-progreso .card-body > div:first-child {
                flex-direction: column !important;
            }

            #tab-progreso .card-body > div:first-child > div {
                min-width: 100% !important;
            }
        }

        @media (max-width: 400px) {
            #performanceTiers > div {
                padding: 0.75rem !important;
            }

            #performanceTiers h3 {
                font-size: 0.9rem !important;
            }

            #performanceTiers p {
                font-size: 0.7rem !important;
            }
        }

        /* PWA Standalone mode tweaks */
        @media (display-mode: standalone) {
            .header {
                padding-top: calc(0.75rem + env(safe-area-inset-top, 0));
            }
        }
        
        /* Print styles */
        @media print {
            .header, .nav-tabs, .btn, .filters {
                display: none !important;
            }
            
            .card {
                box-shadow: none;
                border: 1px solid #ddd;
            }
        }
        
        /* Camera styles */
        .camera-container {
            background: #000;
            border-radius: 12px;
            overflow: hidden;
            position: relative;
            margin-bottom: 1rem;
        }
        
        .camera-preview {
            width: 100%;
            max-height: 400px;
            object-fit: contain;
            display: block;
        }
        
        .camera-controls {
            display: flex;
            justify-content: center;
            gap: 1rem;
            padding: 1rem;
            background: rgba(0,0,0,0.8);
        }
        
        .camera-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: 3px solid white;
            background: transparent;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
            transition: all 0.2s;
        }
        
        .camera-btn:hover {
            background: rgba(255,255,255,0.2);
        }
        
        .camera-btn.capture {
            background: #f44336;
            border-color: #f44336;
        }
        
        .camera-btn.capture:hover {
            background: #d32f2f;
        }
        
        /* Fix for label buttons acting as actual buttons */
        label.btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        
        .photo-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 0.5rem;
            margin-top: 1rem;
        }
        
        .photo-thumbnail {
            position: relative;
            aspect-ratio: 1;
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
            border: 2px solid var(--border);
        }
        
        .photo-thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .photo-thumbnail .delete-photo {
            position: absolute;
            top: 4px;
            right: 4px;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: rgba(244, 67, 54, 0.9);
            color: white;
            border: none;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .photo-thumbnail .photo-label {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0,0,0,0.7);
            color: white;
            font-size: 0.7rem;
            padding: 2px 4px;
            text-align: center;
        }
        
        .photo-type-selector {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
            flex-wrap: wrap;
        }
        
        .photo-type-btn {
            padding: 0.5rem 1rem;
            border: 2px solid var(--border);
            border-radius: 20px;
            background: white;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s;
        }
        
        .photo-type-btn:hover {
            border-color: var(--primary);
        }
        
        .photo-type-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        .photo-type-btn.has-photo {
            background: #e8f5e9;
            border-color: var(--success);
        }
        
        /* Fullscreen photo viewer */
        .photo-viewer {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.95);
            z-index: 3000;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }
        
        .photo-viewer.active {
            display: flex;
        }
        
        .photo-viewer img {
            max-width: 95%;
            max-height: 85%;
            object-fit: contain;
        }
        
        .photo-viewer-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            color: white;
            font-size: 2rem;
            cursor: pointer;
        }
        
        .photo-viewer-info {
            color: white;
            margin-top: 1rem;
            text-align: center;
        }
        
        .photo-viewer-nav {
            display: flex;
            gap: 2rem;
            margin-top: 1rem;
        }
        
        .photo-viewer-nav button {
            background: rgba(255,255,255,0.2);
            border: 2px solid white;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
        }
        
        .photo-viewer-nav button:hover {
            background: rgba(255,255,255,0.3);
        }
        
        /* Mobile camera input styling */
        .camera-input-wrapper {
            position: relative;
            display: inline-block;
        }
        
        .camera-input-wrapper input[type="file"] {
            position: absolute;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }
        
        
        /* AI Analytics Styles */
        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.7; }
        }

        /* Voice Dictation Styles */
        @keyframes pulseMic {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.3); }
        }

        .pulse-mic {
            display: inline-block;
            animation: pulseMic 0.8s ease-in-out infinite;
        }

        .btn-voice {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(139, 92, 246, 0.3);
        }

        .btn-voice:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(139, 92, 246, 0.4);
        }

        .btn-voice.recording {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.4);
            animation: pulseMic 1s ease-in-out infinite;
        }

        .voice-status-panel {
            background: linear-gradient(135deg, #fef3c7, #fde68a);
            border: 2px solid #f59e0b;
            border-radius: 12px;
            padding: 1rem;
            margin: 1rem 0;
        }

        .pending-dictation-card {
            transition: all 0.3s ease;
        }

        .pending-dictation-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        #aiResponseContent {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        #aiResponseContent h3 {
            color: #9c27b0;
            margin-top: 1rem;
            margin-bottom: 0.5rem;
        }
        
        #aiResponseContent ul {
            margin: 0.5rem 0;
            padding-left: 1.5rem;
        }
        
        #aiResponseContent li {
            margin: 0.3rem 0;
        }
        
        #aiResponseContent strong {
            color: #2e7d32;
        }
        
        #aiResponseContent code {
            background: #f5f5f5;
            padding: 0.2rem 0.4rem;
            border-radius: 4px;
            font-size: 0.9em;
        }
        
        /* AI Provider Button Styles */
        .ai-provider-btn {
            padding: 0.75rem 1rem;
            border: 2px solid #ddd;
            background: #f5f5f5;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
        }
        
        .ai-provider-btn:hover {
            border-color: #999;
        }
        
        .ai-provider-btn.active {
            border-color: #4285f4;
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
            color: #1565c0;
        }
        
        #btnProviderAnthropic.active {
            border-color: #9c27b0;
            background: linear-gradient(135deg, #f3e5f5, #e1bee7);
            color: #7b1fa2;
        }
        
        /* Ranch Selector Styles */
        .ranch-selector-bar {
            background: linear-gradient(135deg, #37474f, #263238);
            padding: 0.5rem 1rem;
            position: sticky;
            top: 0;
            z-index: 1001;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        
        .ranch-selector-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            flex-wrap: wrap;
        }
        
        .ranch-label {
            color: white;
            font-weight: 500;
            font-size: 0.9rem;
        }
        
        .ranch-buttons {
            display: flex;
            gap: 0.5rem;
        }
        
        .ranch-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border: 2px solid transparent;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.3s ease;
            opacity: 0.7;
        }
        
        .ranch-btn:hover {
            opacity: 1;
            transform: translateY(-2px);
        }
        
        .ranch-btn.active {
            opacity: 1;
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        
        .ranch-icon {
            font-size: 1.2rem;
        }
        
        /* La Coru√±a - Pure Yellow Theme */
        .ranch-coruna {
            background: linear-gradient(135deg, #FFEB3B, #FDD835);
            color: #000;
            border-color: #FFEB3B;
        }

        .ranch-coruna.active {
            border-color: #fff;
            box-shadow: 0 4px 12px rgba(255, 235, 59, 0.5);
        }

        /* Santa Catalina - Orange Theme */
        .ranch-catalina {
            background: linear-gradient(135deg, #ff9800, #f57c00);
            color: #000;
            border-color: #ff9800;
        }

        .ranch-catalina.active {
            border-color: #fff;
            box-shadow: 0 4px 12px rgba(255, 152, 0, 0.5);
        }
        
        /* La Vega - Green Theme */
        .ranch-vega {
            background: linear-gradient(135deg, #4caf50, #2e7d32);
            color: white;
            border-color: #4caf50;
        }
        
        .ranch-vega.active {
            border-color: #fff;
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.5);
        }

        /* San Fernando - Sky Blue Theme (Breeding Ranch) */
        .ranch-fernando {
            background: linear-gradient(135deg, #0ea5e9, #0284c7);
            color: white;
            border-color: #0ea5e9;
        }

        .ranch-fernando.active {
            border-color: #fff;
            box-shadow: 0 4px 12px rgba(14, 165, 233, 0.5);
        }

        /* Dynamic header themes */
        .header.theme-coruna {
            background: linear-gradient(135deg, #FFEB3B, #FDD835) !important;
            color: #000 !important;
        }

        .header.theme-coruna * {
            color: #000 !important;
        }

        .header.theme-catalina {
            background: linear-gradient(135deg, #ff9800, #e65100) !important;
            color: #000 !important;
        }

        .header.theme-catalina * {
            color: #000 !important;
        }
        
        .header.theme-vega {
            background: linear-gradient(135deg, #4caf50, #1b5e20) !important;
        }

        .header.theme-fernando {
            background: linear-gradient(135deg, #0ea5e9, #0284c7) !important;
        }

        /* Active tab indicator color change */
        .theme-coruna-active .nav-tab.active {
            border-bottom-color: #FDD835 !important;
            color: #FDD835 !important;
        }

        .theme-catalina-active .nav-tab.active {
            border-bottom-color: #e65100 !important;
            color: #e65100 !important;
        }

        .theme-fernando-active .nav-tab.active {
            border-bottom-color: #0ea5e9 !important;
            color: #0ea5e9 !important;
        }

        /* Animal Selector Styles */
        .animal-selector {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 0.5rem;
            max-height: 200px;
            overflow-y: auto;
            padding: 0.75rem;
            background: #f5f5f5;
            border-radius: 8px;
            border: 1px solid #ddd;
        }
        
        .animal-chip {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0.4rem 0.6rem;
            background: white;
            border: 2px solid #ddd;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        .animal-chip:hover {
            border-color: var(--primary);
            background: #e8f5e9;
        }
        
        .animal-chip.selected {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        .animal-chip.in-retiro {
            background: #ffebee;
            border-color: #e57373;
        }
        
        .animal-chip.in-retiro.selected {
            background: #e57373;
        }
        
        /* Modal Styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            padding: 1rem;
        }
        
        .modal-content {
            background: white;
            border-radius: 12px;
            width: 100%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.25rem;
            background: var(--primary);
            color: white;
            border-radius: 12px 12px 0 0;
            font-weight: 600;
        }
        
        .modal-close {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            line-height: 1;
        }
        
        .modal-body {
            padding: 1.25rem;
        }
        
        /* Potrero Card Styles */
        .potrero-card {
            background: white;
            border-radius: 12px;
            padding: 1rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-left: 5px solid #4caf50;
            transition: all 0.3s;
        }
        
        .potrero-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
        }
        
        .potrero-card.ocupado {
            border-left-color: #ff9800;
        }
        
        .potrero-card.descanso {
            border-left-color: #2196f3;
        }
        
        .potrero-card.mantenimiento {
            border-left-color: #9e9e9e;
        }
        
        .potrero-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.75rem;
        }
        
        .potrero-card-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #333;
        }
        
        .potrero-card-status {
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .potrero-card-status.disponible {
            background: #e8f5e9;
            color: #2e7d32;
        }
        
        .potrero-card-status.ocupado {
            background: #fff3e0;
            color: #e65100;
        }
        
        .potrero-card-status.descanso {
            background: #e3f2fd;
            color: #1565c0;
        }
        
        .potrero-card-status.mantenimiento {
            background: #f5f5f5;
            color: #616161;
        }
        
        .potrero-card-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
            font-size: 0.85rem;
            margin-bottom: 0.75rem;
        }
        
        .potrero-stat {
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }
        
        .potrero-card-footer {
            display: flex;
            gap: 0.5rem;
            padding-top: 0.75rem;
            border-top: 1px solid #eee;
        }
        
        .potrero-card-footer button {
            flex: 1;
            padding: 0.4rem;
            font-size: 0.8rem;
        }
        
        /* Alert Styles */
        .alert-item {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            padding: 0.75rem;
            background: #fff;
            border-radius: 8px;
            margin-bottom: 0.5rem;
            border-left: 4px solid #ff9800;
        }
        
        .alert-item.critical {
            border-left-color: #f44336;
            background: #ffebee;
        }
        
        .alert-item.warning {
            border-left-color: #ff9800;
            background: #fff3e0;
        }
        
        .alert-item.info {
            border-left-color: #2196f3;
            background: #e3f2fd;
        }
        
        .alert-icon {
            font-size: 1.3rem;
        }
        
        .alert-content {
            flex: 1;
        }
        
        .alert-title {
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        .alert-desc {
            font-size: 0.8rem;
            color: #666;
        }
        
        /* Animal Profile Styles */
        .profile-section {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        
        .profile-section-title {
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .profile-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.5rem;
        }
        
        .profile-item {
            display: flex;
            flex-direction: column;
        }
        
        .profile-item-label {
            font-size: 0.75rem;
            color: #666;
            text-transform: uppercase;
        }
        
        .profile-item-value {
            font-size: 1rem;
            font-weight: 500;
            color: #333;
        }
        
        .profile-item-value.large {
            font-size: 1.5rem;
            color: var(--primary);
        }
        
        /* Health Type Badge */
        .health-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.2rem 0.5rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        
        .health-badge.vacuna {
            background: #e8f5e9;
            color: #2e7d32;
        }
        
        .health-badge.desparasitacion {
            background: #fff3e0;
            color: #e65100;
        }
        
        .health-badge.tratamiento {
            background: #fce4ec;
            color: #c2185b;
        }
        
        .health-badge.revision {
            background: #f3e5f5;
            color: #7b1fa2;
        }
        
        /* Clickable row */
        .clickable-row {
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .clickable-row:hover {
            background: #e8f5e9 !important;
        }
    </style>
</head>
<body>
    <!-- Ranch Selector Bar -->
    <div class="ranch-selector-bar">
        <div class="ranch-selector-content">
            <span class="ranch-label">üè† Seleccionar Finca:</span>
            <div class="ranch-buttons">
                <button class="ranch-btn ranch-coruna" onclick="switchRanch('la_coruna')" id="btnRanchCoruna">
                    <span class="ranch-icon">üèîÔ∏è</span>
                    <span class="ranch-name">La Coru√±a</span>
                </button>
                <button class="ranch-btn ranch-catalina" onclick="switchRanch('santa_catalina')" id="btnRanchCatalina">
                    <span class="ranch-icon">‚õ™</span>
                    <span class="ranch-name">Santa Catalina</span>
                </button>
                <button class="ranch-btn ranch-vega" onclick="switchRanch('la_vega')" id="btnRanchVega">
                    <span class="ranch-icon">üåæ</span>
                    <span class="ranch-name">La Vega</span>
                </button>
                <button class="ranch-btn ranch-fernando" onclick="switchRanch('san_fernando')" id="btnRanchFernando">
                    <span class="ranch-icon">üêÑ</span>
                    <span class="ranch-name">San Fernando</span>
                </button>
            </div>
            <!-- Cloud Sync Status Indicator -->
            <div id="cloudSyncIndicator" style="display: flex; align-items: center; gap: 6px; background: rgba(255,255,255,0.15); padding: 4px 10px; border-radius: 12px; font-size: 0.75rem; cursor: pointer;" onclick="showTab('config')" title="Estado de sincronizaci√≥n">
                <span id="syncIndicatorIcon" style="font-size: 1rem;">‚òÅÔ∏è</span>
                <span id="syncIndicatorText" style="color: white;">Conectando...</span>
            </div>
        </div>
    </div>

    <header class="header" id="mainHeader">
        <div class="header-content">
            <div class="logo">
                <span class="logo-icon">üêÇ</span>
                <span id="headerRanchName">Ganado Finca</span>
            </div>
            <div class="header-stats">
                <div class="header-stat">
                    <div class="header-stat-value" id="headerTotalAnimals">0</div>
                    <div>Animales</div>
                </div>
                <div class="header-stat">
                    <div class="header-stat-value" id="headerTotalKg">0</div>
                    <div>Kg Totales</div>
                </div>
                <div class="header-stat">
                    <div class="header-stat-value" id="headerTotalValue">$0</div>
                    <div>Valor Inventario</div>
                </div>
            </div>
            <div class="app-version-badge" id="appVersionHeader">v2 ¬∑ 2026-01-10</div>
        </div>
    </header>
    
    <div class="container">
        <!-- Navigation -->
        <nav class="nav-tabs">
            <button class="nav-tab active" data-tab="inicio">
                <span class="nav-tab-icon">üè†</span>
                <span>Inicio</span>
            </button>
            <button class="nav-tab" data-tab="eventos">
                <span class="nav-tab-icon">üìù</span>
                <span>Eventos</span>
            </button>
            <button class="nav-tab" data-tab="inventario">
                <span class="nav-tab-icon">üìä</span>
                <span>Inventario</span>
            </button>
            <button class="nav-tab" data-tab="fotos">
                <span class="nav-tab-icon">üì∏</span>
                <span>Fotos</span>
            </button>
            <button class="nav-tab" data-tab="progreso">
                <span class="nav-tab-icon">‚öñÔ∏è</span>
                <span>Progreso</span>
            </button>
            <button class="nav-tab" data-tab="salud">
                <span class="nav-tab-icon">üíâ</span>
                <span>Salud</span>
            </button>
            <button class="nav-tab" data-tab="cria" id="tabCria" style="display: none;">
                <span class="nav-tab-icon">üêÑ</span>
                <span>Cr√≠a</span>
            </button>
            <button class="nav-tab" data-tab="potreros">
                <span class="nav-tab-icon">üåø</span>
                <span>Potreros</span>
            </button>
            <button class="nav-tab" data-tab="entradas">
                <span class="nav-tab-icon">üì•</span>
                <span>Entradas</span>
            </button>
            <button class="nav-tab" data-tab="salidas">
                <span class="nav-tab-icon">üì§</span>
                <span>Salidas</span>
            </button>
            <button class="nav-tab" data-tab="analytics">
                <span class="nav-tab-icon">ü§ñ</span>
                <span>Reportes & IA</span>
            </button>
            <button class="nav-tab" data-tab="config">
                <span class="nav-tab-icon">‚öôÔ∏è</span>
                <span>Config</span>
            </button>
        </nav>
        
        <!-- Tab: Inicio -->
        <div id="tab-inicio" class="tab-content active">
            <div class="summary-grid">
                <div class="summary-box">
                    <div class="summary-box-icon">üêÇ</div>
                    <div class="summary-box-value" id="summaryTotal">0</div>
                    <div class="summary-box-label">Total Animales</div>
                </div>
                <div class="summary-box">
                    <div class="summary-box-icon">‚ôÇÔ∏è</div>
                    <div class="summary-box-value" id="summaryMachos">0</div>
                    <div class="summary-box-label">Machos</div>
                </div>
                <div class="summary-box">
                    <div class="summary-box-icon">‚ôÄÔ∏è</div>
                    <div class="summary-box-value" id="summaryHembras">0</div>
                    <div class="summary-box-label">Hembras</div>
                </div>
                <div class="summary-box">
                    <div class="summary-box-icon">üí∞</div>
                    <div class="summary-box-value" id="summaryInversion">$0</div>
                    <div class="summary-box-label">Total Inventario</div>
                </div>
                <div class="summary-box">
                    <div class="summary-box-icon">‚öñÔ∏è</div>
                    <div class="summary-box-value" id="summaryKgTotal">0</div>
                    <div class="summary-box-label">Kg Totales</div>
                </div>
                <div class="summary-box">
                    <div class="summary-box-icon">üìä</div>
                    <div class="summary-box-value" id="summaryPrecioKg">$0</div>
                    <div class="summary-box-label">$/Kg</div>
                </div>
                <div class="summary-box">
                    <div class="summary-box-icon">üìè</div>
                    <div class="summary-box-value" id="summaryKgPromedio">0</div>
                    <div class="summary-box-label">Kg Promedio</div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <span>üìÖ Actividad Reciente</span>
                </div>
                <div class="card-body">
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Fecha</th>
                                    <th>Tipo</th>
                                    <th>Chapeta</th>
                                    <th>Detalle</th>
                                </tr>
                            </thead>
                            <tbody id="recentActivity">
                                <tr><td colspan="4" class="text-center">No hay actividad reciente</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Tab: Eventos -->
        <div id="tab-eventos" class="tab-content">
            <h2 style="margin-bottom: 1.5rem; color: var(--dark);">Registrar Nuevo Evento</h2>
            
            <div class="event-cards">
                <div class="event-card compras" onclick="showEventForm('compra')">
                    <div class="event-card-icon">üõí</div>
                    <div class="event-card-title">COMPRA</div>
                    <div class="event-card-desc">Registrar compra de ganado nuevo</div>
                </div>
                
                <div class="event-card nacimientos" onclick="showEventForm('nacimiento')">
                    <div class="event-card-icon">üê£</div>
                    <div class="event-card-title">NACIMIENTO</div>
                    <div class="event-card-desc">Registrar nacimiento de ternero</div>
                </div>
                
                <div class="event-card ventas" onclick="showEventForm('venta')">
                    <div class="event-card-icon">üíµ</div>
                    <div class="event-card-title">VENTA</div>
                    <div class="event-card-desc">Registrar venta de ganado</div>
                </div>
                
                <div class="event-card muertes" onclick="showEventForm('muerte')">
                    <div class="event-card-icon">‚úùÔ∏è</div>
                    <div class="event-card-title">MUERTE</div>
                    <div class="event-card-desc">Registrar muerte/p√©rdida de animal</div>
                </div>
            </div>
            
            <!-- Form: Compra -->
            <div id="form-compra" class="card" style="display:none;">
                <div class="card-header compras">
                    <span>üõí Registrar Compra - Lote</span>
                    <button class="modal-close" onclick="hideEventForm('compra')" style="color:white;">√ó</button>
                </div>
                <div class="card-body">
                    <!-- Step 1: Lote Information (set once) -->
                    <div id="compraLoteInfo">
                        <h3 style="margin-bottom: 1rem; color: var(--primary);">üì¶ Paso 1: Informaci√≥n del Lote</h3>
                        <div class="form-hint" style="margin-bottom: 1rem;">Esta informaci√≥n aplica a todos los animales del lote</div>
                        
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">N√∫mero de Lote</label>
                                <input type="text" class="form-input" id="compraLote" readonly style="background: #e8f5e9; font-weight: bold;">
                                <div class="form-hint">Consecutivo autom√°tico</div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Cantidad de Animales <span class="required">*</span></label>
                                <input type="number" class="form-input" id="compraCantidadAnimales" required min="1" max="100" placeholder="ej: 6" style="font-size: 1.2rem; font-weight: bold;">
                                <div class="form-hint">¬øCu√°ntos animales en este lote?</div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Vendedor <span class="required">*</span></label>
                                <input type="text" class="form-input" id="compraVendedor" required list="vendedoresList" placeholder="ej: Alveiro Pineda">
                                <datalist id="vendedoresList"></datalist>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Precio/Kg del Lote <span class="required">*</span></label>
                                <input type="number" class="form-input" id="compraPrecioKilo" required min="1" step="1" placeholder="ej: 8500">
                                <div class="form-hint">Mismo precio para todos los animales</div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Fecha de Entrada <span class="required">*</span></label>
                                <input type="date" class="form-input" id="compraFecha" required>
                            </div>
                        </div>
                        
                        <button type="button" class="btn btn-primary" onclick="startLoteEntry()" style="width: 100%;">
                            ‚úÖ Confirmar Lote y Agregar Animales ‚Üí
                        </button>
                    </div>
                    
                    <!-- Step 2: Add Animals to Lote -->
                    <div id="compraAnimalesSection" style="display: none;">
                        <!-- Lote Summary Header -->
                        <div style="background: linear-gradient(135deg, #e8f5e9, #c8e6c9); padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">
                            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 0.5rem;">
                                <div>
                                    <strong style="font-size: 1.1rem;">üì¶ Lote <span id="loteNumeroDisplay">---</span></strong>
                                    <span style="margin-left: 1rem;" id="loteVendedorDisplay">---</span>
                                </div>
                                <div>
                                    <span id="lotePrecioDisplay">$---/kg</span> | 
                                    <span id="loteFechaDisplay">---</span>
                                </div>
                            </div>
                            <!-- Progress indicator -->
                            <div style="margin-top: 0.75rem; padding: 0.5rem; background: white; border-radius: 6px;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <span><strong id="loteProgressText">0 de 0</strong> animales agregados</span>
                                    <span id="loteProgressStatus" class="badge badge-warning">En progreso</span>
                                </div>
                                <div style="margin-top: 0.5rem; height: 8px; background: #e0e0e0; border-radius: 4px; overflow: hidden;">
                                    <div id="loteProgressBar" style="height: 100%; background: var(--primary); width: 0%; transition: width 0.3s;"></div>
                                </div>
                            </div>
                        </div>
                        
                        <h3 style="margin-bottom: 1rem; color: var(--primary);">üêÑ Paso 2: Agregar Animales (Todos a la vez)</h3>
                        
                        <div class="form-hint" style="margin-bottom: 0.75rem;">
                            Llena la tabla completa y luego confirma para guardar todos los animales.
                        </div>
                        
                        <div class="table-container" style="max-height: 320px; overflow-y: auto; margin-bottom: 1rem;">
                            <table>
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>Chapeta *</th>
                                        <th>Raza *</th>
                                        <th>Sexo *</th>
                                        <th class="text-right">Peso (kg) *</th>
                                    </tr>
                                </thead>
                                <tbody id="compraAnimalesBulkTable">
                                    <tr><td colspan="5" class="text-center" style="color: var(--gray);">Completa el paso 1 para crear la tabla</td></tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <div style="display: flex; gap: 0.75rem; flex-wrap: wrap;">
                            <button type="button" class="btn btn-success" onclick="confirmBulkCompraAnimales()" style="flex: 2;">
                                ‚úÖ Confirmar Animales y Guardar
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="resetBulkCompraTable()">
                                üîÑ Limpiar Tabla
                            </button>
                        </div>
                        
                        <!-- Animals in current lote -->
                        <div style="margin-top: 1.5rem;">
                            <h4 style="margin-bottom: 0.5rem;">
                                Animales en este Lote: <span id="loteAnimalCount">0</span>
                                <span style="font-weight: normal; color: var(--gray); margin-left: 1rem;">
                                    Total: <span id="loteTotalKg">0</span> kg | <span id="loteTotalCosto">$0</span>
                                </span>
                            </h4>
                            <div class="table-container" style="max-height: 250px; overflow-y: auto;">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>#</th>
                                            <th>Chapeta</th>
                                            <th>Raza</th>
                                            <th>Sexo</th>
                                            <th class="text-right">Peso</th>
                                            <th class="text-right">Costo</th>
                                            <th></th>
                                        </tr>
                                    </thead>
                                    <tbody id="loteAnimalesTable">
                                        <tr><td colspan="7" class="text-center" style="color: var(--gray);">A√∫n no hay animales en este lote</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <!-- Action buttons -->
                        <div style="margin-top: 1.5rem; padding-top: 1rem; border-top: 2px solid var(--border);">
                            <div style="display: flex; gap: 0.75rem; flex-wrap: wrap;">
                                <button type="button" class="btn btn-primary" id="btnFinalizarLote" onclick="finalizarLote()" style="flex: 2;" disabled>
                                    ‚úÖ Finalizar Lote y Guardar
                                </button>
                                <button type="button" class="btn btn-secondary" onclick="cancelarLote()">
                                    ‚ùå Cancelar Lote
                                </button>
                            </div>
                            <div id="finalizarLoteWarning" style="margin-top: 0.5rem; padding: 0.5rem; background: #fff3e0; border-radius: 6px; font-size: 0.9rem; display: none;">
                                ‚ö†Ô∏è <span id="finalizarWarningText">Debe agregar todos los animales antes de finalizar</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Form: Nacimiento -->
            <div id="form-nacimiento" class="card" style="display:none;">
                <div class="card-header nacimientos">
                    <span>üê£ Registrar Nacimiento</span>
                    <button class="modal-close" onclick="hideEventForm('nacimiento')" style="color:white;">√ó</button>
                </div>
                <div class="card-body">
                    <form id="nacimientoForm" onsubmit="saveNacimiento(event)">
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">N√∫mero (Chapeta) del Ternero <span class="required">*</span></label>
                                <input type="text" class="form-input" id="nacimientoNumero" required placeholder="ej: 300">
                                <div class="form-hint" id="nacimientoChapetaHint">Siguiente sugerido: ---</div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">N√∫mero Vaca (Madre) <span class="required">*</span></label>
                                <input type="text" class="form-input" id="nacimientoMadre" required list="vacasList" placeholder="ej: 150" oninput="autoFillMotherRaza()">
                                <datalist id="vacasList"></datalist>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Raza <span class="required">*</span></label>
                                <select class="form-select" id="nacimientoRaza" required>
                                    <option value="Ceb√∫">Ceb√∫</option>
                                    <option value="Razuno">Razuno</option>
                                    <option value="Brangus">Brangus</option>
                                    <option value="Ceb√∫/Europeo">Ceb√∫/Europeo</option>
                                    <option value="Simbra">Simbra</option>
                                    <option value="Brahman">Brahman</option>
                                    <option value="Angus">Angus</option>
                                    <option value="Cruce">Cruce</option>
                                    <option value="Otra">Otra</option>
                                </select>
                                <div class="form-hint" id="razaMotherHint"></div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Sexo <span class="required">*</span></label>
                                <select class="form-select" id="nacimientoSexo" required>
                                    <option value="MACHO">MACHO</option>
                                    <option value="HEMBRA">HEMBRA</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Peso al Nacer (kg)</label>
                                <input type="number" class="form-input" id="nacimientoPeso" min="1" step="0.1" placeholder="ej: 35">
                                <div class="form-hint">Peso t√≠pico: 25-40 kg</div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Fecha de Nacimiento <span class="required">*</span></label>
                                <input type="date" class="form-input" id="nacimientoFecha" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Lote</label>
                                <input type="text" class="form-input" id="nacimientoLote" placeholder="ej: NAC-01">
                            </div>
                        </div>
                        <div class="btn-group">
                            <button type="submit" class="btn btn-success">üíæ Guardar Nacimiento</button>
                            <button type="button" class="btn btn-primary" onclick="saveNacimientoAndContinue()">üíæ Guardar y Agregar Otro ‚Üí</button>
                            <button type="button" class="btn btn-secondary" onclick="hideEventForm('nacimiento')">Cancelar</button>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- Form: Venta -->
            <div id="form-venta" class="card" style="display:none;">
                <div class="card-header ventas">
                    <span>üíµ Registrar Venta</span>
                    <button class="modal-close" onclick="hideEventForm('venta')" style="color:white;">√ó</button>
                </div>
                <div class="card-body">
                    <!-- Step 1: Sale Information (set once) -->
                    <div id="ventaLoteInfo">
                        <h3 style="margin-bottom: 1rem; color: var(--warning);">üíµ Paso 1: Informaci√≥n de la Venta</h3>
                        <div class="form-hint" style="margin-bottom: 1rem;">Esta informaci√≥n aplica a todos los animales de esta venta</div>
                        
                        <!-- Transfer option -->
                        <div class="form-group full-width" style="margin-bottom: 1.5rem; padding: 1rem; background: #e3f2fd; border-radius: 8px; border-left: 4px solid #2196f3;">
                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; font-weight: 600;">
                                <input type="checkbox" id="ventaEsTransferencia" onchange="toggleTransferMode()" style="width: 20px; height: 20px;">
                                <span>üîÑ Transferencia entre fincas</span>
                            </label>
                            <div class="form-hint" style="margin-top: 0.5rem;">
                                Marque esta opci√≥n si est√° transfiriendo animales a otra finca propia
                            </div>
                        </div>
                        
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">Cantidad de Animales <span class="required">*</span></label>
                                <input type="number" class="form-input" id="ventaCantidadAnimales" required min="1" max="100" placeholder="ej: 6" style="font-size: 1.2rem; font-weight: bold;">
                                <div class="form-hint">¬øCu√°ntos animales vas a vender?</div>
                            </div>
                            
                            <!-- Normal sale fields -->
                            <div id="ventaNormalFields">
                                <div class="form-group">
                                    <label class="form-label">Comprador <span class="required">*</span></label>
                                    <input type="text" class="form-input" id="ventaComprador" list="compradoresList" placeholder="ej: Camilo Correa">
                                    <datalist id="compradoresList"></datalist>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Precio/Kg de Venta <span class="required">*</span></label>
                                    <input type="number" class="form-input" id="ventaPrecioKilo" min="1" step="1" placeholder="ej: 9500">
                                    <div class="form-hint">Mismo precio para todos los animales</div>
                                </div>
                            </div>
                            
                            <!-- Transfer fields -->
                            <div id="ventaTransferFields" style="display: none;">
                                <div class="form-group">
                                    <label class="form-label">Finca Destino <span class="required">*</span></label>
                                    <select class="form-select" id="ventaFincaDestino">
                                        <option value="">-- Seleccionar finca --</option>
                                    </select>
                                    <div class="form-hint">Finca que recibir√° los animales</div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Precio/Kg de Transferencia</label>
                                    <input type="number" class="form-input" id="ventaPrecioTransfer" min="0" step="1" placeholder="0" value="0">
                                    <div class="form-hint">Dejar en 0 para transferir al costo original</div>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Fecha de Venta/Transferencia <span class="required">*</span></label>
                                <input type="date" class="form-input" id="ventaFecha" required>
                            </div>
                        </div>
                        
                        <button type="button" class="btn btn-warning" onclick="startVentaEntry()" style="width: 100%; color: #333;">
                            ‚úÖ Confirmar y Seleccionar Animales ‚Üí
                        </button>
                    </div>
                    
                    <!-- Step 2: Select Animals for Sale -->
                    <div id="ventaAnimalesSection" style="display: none;">
                        <!-- Sale Summary Header -->
                        <div style="background: linear-gradient(135deg, #fff3e0, #ffe0b2); padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">
                            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 0.5rem;">
                                <div>
                                    <strong style="font-size: 1.1rem;">üíµ Venta a:</strong>
                                    <span style="margin-left: 0.5rem;" id="ventaCompradorDisplay">---</span>
                                </div>
                                <div>
                                    <span id="ventaPrecioDisplay">$---/kg</span> | 
                                    <span id="ventaFechaDisplay">---</span>
                                </div>
                            </div>
                            <!-- Progress indicator -->
                            <div style="margin-top: 0.75rem; padding: 0.5rem; background: white; border-radius: 6px;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <span><strong id="ventaProgressText">0 de 0</strong> animales seleccionados</span>
                                    <span id="ventaProgressStatus" class="badge badge-warning">En progreso</span>
                                </div>
                                <div style="margin-top: 0.5rem; height: 8px; background: #e0e0e0; border-radius: 4px; overflow: hidden;">
                                    <div id="ventaProgressBar" style="height: 100%; background: var(--warning); width: 0%; transition: width 0.3s;"></div>
                                </div>
                            </div>
                        </div>
                        
                        <h3 style="margin-bottom: 1rem; color: var(--warning);">üêÑ Paso 2: Seleccionar Animales</h3>
                        
                        <!-- Animal selector -->
                        <div class="form-group" id="ventaAnimalSelectorContainer">
                            <label class="form-label">Buscar Animal en Inventario</label>
                            <input type="text" class="form-input" id="ventaSearchLote" placeholder="Buscar por chapeta, lote, vendedor..." oninput="filterAnimalsForSaleLote()">
                        </div>
                        
                        <!-- Available animals grid -->
                        <div id="ventaAnimalSelectorLote" class="animal-selector" style="max-height: 200px; margin-bottom: 1rem;"></div>
                        
                        <!-- Add selected animal form -->
                        <div id="ventaAddAnimalForm" style="display: none; padding: 1rem; background: #f5f5f5; border-radius: 8px; margin-bottom: 1rem;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                                <strong>Animal seleccionado: <span id="ventaSelectedAnimalInfo">---</span></strong>
                                <button type="button" class="btn btn-secondary" style="padding: 0.25rem 0.5rem;" onclick="clearVentaSelection()">‚úï</button>
                            </div>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="form-label">Peso de Venta (kg) <span class="required">*</span></label>
                                    <input type="number" class="form-input" id="ventaPesoAnimal" required min="1" step="0.1" placeholder="Peso actual" style="font-size: 1.1rem;">
                                    <div class="form-hint" id="ventaPesoEstimadoHint">Peso estimado: --- kg</div>
                                </div>
                                <div class="form-group" style="display: flex; align-items: flex-end;">
                                    <button type="button" class="btn btn-success" id="btnAddAnimalVenta" onclick="addAnimalToVenta()">
                                        ‚ûï Agregar (<span id="ventaAnimalCountRemaining">0</span> restantes)
                                    </button>
                                </div>
                            </div>
                            <input type="hidden" id="ventaSelectedNumero">
                        </div>
                        
                        <!-- Animals in current sale -->
                        <div style="margin-top: 1rem;">
                            <h4 style="margin-bottom: 0.5rem;">
                                Animales en esta Venta: <span id="ventaAnimalCount">0</span>
                                <span style="font-weight: normal; color: var(--gray); margin-left: 1rem;">
                                    Total: <span id="ventaTotalKg">0</span> kg | <span id="ventaTotalVenta">$0</span>
                                </span>
                            </h4>
                            <div class="table-container" style="max-height: 250px; overflow-y: auto;">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>#</th>
                                            <th>Chapeta</th>
                                            <th>Lote Compra</th>
                                            <th>Raza</th>
                                            <th class="text-right">Peso Entrada</th>
                                            <th class="text-right">Peso Venta</th>
                                            <th class="text-right">Ganancia kg</th>
                                            <th class="text-right">Valor Venta</th>
                                            <th></th>
                                        </tr>
                                    </thead>
                                    <tbody id="ventaAnimalesTable">
                                        <tr><td colspan="9" class="text-center" style="color: var(--gray);">Selecciona animales del inventario</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <!-- Action buttons -->
                        <div style="margin-top: 1.5rem; padding-top: 1rem; border-top: 2px solid var(--border);">
                            <div style="display: flex; gap: 0.75rem; flex-wrap: wrap;">
                                <button type="button" class="btn btn-warning" id="btnFinalizarVenta" onclick="finalizarVenta()" style="flex: 2; color: #333;" disabled>
                                    ‚úÖ Finalizar Venta y Guardar
                                </button>
                                <button type="button" class="btn btn-secondary" onclick="cancelarVenta()">
                                    ‚ùå Cancelar
                                </button>
                            </div>
                            <div id="finalizarVentaWarning" style="margin-top: 0.5rem; padding: 0.5rem; background: #fff3e0; border-radius: 6px; font-size: 0.9rem; display: none;">
                                ‚ö†Ô∏è <span id="finalizarVentaWarningText">Debe seleccionar todos los animales antes de finalizar</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Form: Muerte -->
            <div id="form-muerte" class="card" style="display:none;">
                <div class="card-header muertes">
                    <span>‚úùÔ∏è Registrar Muerte</span>
                    <button class="modal-close" onclick="hideEventForm('muerte')" style="color:white;">√ó</button>
                </div>
                <div class="card-body">
                    <form id="muerteForm" onsubmit="saveMuerte(event)">
                        <div class="form-group">
                            <label class="form-label">Seleccionar Animal <span class="required">*</span></label>
                            <input type="text" class="form-input" id="muerteSearch" placeholder="Buscar por chapeta..." oninput="filterAnimalsForDeath()">
                            <div class="animal-selector" id="muerteAnimalSelector"></div>
                            <input type="hidden" id="muerteNumero" required>
                        </div>
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">Peso al Momento (kg)</label>
                                <input type="number" class="form-input" id="muertePeso" min="1" step="0.1" placeholder="Peso estimado">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Fecha de Muerte <span class="required">*</span></label>
                                <input type="date" class="form-input" id="muerteFecha" required>
                            </div>
                            <div class="form-group full-width">
                                <label class="form-label">Causa / Observaciones</label>
                                <input type="text" class="form-input" id="muerteCausa" placeholder="ej: Enfermedad, accidente, etc.">
                            </div>
                        </div>
                        <div class="btn-group">
                            <button type="submit" class="btn btn-danger">üíæ Registrar Muerte</button>
                            <button type="button" class="btn btn-secondary" onclick="hideEventForm('muerte')">Cancelar</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- Tab: Inventario -->
        <div id="tab-inventario" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <span>üìä Inventario Actual</span>
                    <button class="btn btn-outline" onclick="exportInventario()" style="padding: 0.5rem 1rem; font-size: 0.85rem;">
                        üì§ Exportar
                    </button>
                </div>
                <div class="card-body">
                    <div class="filters">
                        <input type="text" class="form-input" id="inventarioSearch" placeholder="Buscar chapeta..." oninput="filterInventario()">
                        <select class="form-select" id="inventarioSexoFilter" onchange="filterInventario()">
                            <option value="">Todos los sexos</option>
                            <option value="MACHO">Machos</option>
                            <option value="HEMBRA">Hembras</option>
                        </select>
                        <select class="form-select" id="inventarioVendedorFilter" onchange="filterInventario()">
                            <option value="">Todos los vendedores</option>
                        </select>
                    </div>
                    <div class="table-container">
                        <table id="inventarioTableContainer">
                            <thead>
                                <tr>
                                    <th class="sortable" data-sort="numero" data-type="number">Chapeta</th>
                                    <th class="sortable" data-sort="lote" data-type="text">Lote</th>
                                    <th class="sortable" data-sort="vendedor" data-type="text">Vendedor</th>
                                    <th class="sortable" data-sort="raza" data-type="text">Raza</th>
                                    <th class="sortable" data-sort="sexo" data-type="text">Sexo</th>
                                    <th class="sortable text-right" data-sort="peso" data-type="number">Peso Inicial</th>
                                    <th class="sortable text-right" data-sort="precioKilo" data-type="number">$/Kg</th>
                                    <th class="sortable" data-sort="fechaEntrada" data-type="date">Fecha</th>
                                    <th class="sortable text-right" data-sort="diasEnFinca" data-type="number">D√≠as</th>
                                    <th class="sortable text-right" data-sort="pesoEstimado" data-type="number">Peso Est.</th>
                                    <th class="text-center">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="inventarioTable">
                                <tr><td colspan="11" class="text-center">No hay datos</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Tab: Fotos -->
        <div id="tab-fotos" class="tab-content">
            <div class="card">
                <div class="card-header" style="background: linear-gradient(135deg, #9c27b0, #7b1fa2);">
                    <span>üì∏ Gesti√≥n de Fotos del Ganado</span>
                </div>
                <div class="card-body">
                    <!-- Photo Options Grid - 2 rows of beautiful boxes -->
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.75rem; margin-bottom: 1rem;">
                        <!-- Row 1: AI Voice, Foto Individual, Captura R√°pida -->

                        <!-- AI Photo Voice -->
                        <div style="background: linear-gradient(135deg, #ede9fe, #ddd6fe); border-radius: 10px; padding: 1rem; border: 2px solid #8b5cf6;">
                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                <span style="font-size: 1.3rem;">üé§</span>
                                <div>
                                    <h4 style="margin: 0; font-size: 0.9rem; color: #6d28d9;">AI Photo Voice</h4>
                                    <p style="margin: 0; font-size: 0.7rem; color: #7c3aed;">Dicte + foto</p>
                                </div>
                            </div>
                            <button id="voiceDictationBtn" onclick="startVoiceDictation('photos')" style="width: 100%; background: linear-gradient(135deg, #8b5cf6, #7c3aed); color: white; border: none; border-radius: 6px; padding: 0.5rem; font-size: 0.8rem; cursor: pointer;">
                                üé§ Dictar
                            </button>
                            <div id="voiceStatus" style="display: none; margin-top: 0.4rem;">
                                <div style="background: white; border-radius: 4px; padding: 0.3rem; border: 1px solid #f59e0b; font-size: 0.7rem;">
                                    <div id="voiceTranscriptPreview" style="color: #92400e;">Escuchando...</div>
                                </div>
                            </div>
                        </div>

                        <!-- Foto Individual -->
                        <div style="background: linear-gradient(135deg, #e0f2fe, #bae6fd); border-radius: 10px; padding: 1rem; border: 2px solid #0ea5e9;">
                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                <span style="font-size: 1.3rem;">üì∏</span>
                                <div>
                                    <h4 style="margin: 0; font-size: 0.9rem; color: #0369a1;">Foto Individual</h4>
                                    <p style="margin: 0; font-size: 0.7rem; color: #0c4a6e;">Una foto + #</p>
                                </div>
                            </div>
                            <button onclick="showAddAnimalPhoto()" style="width: 100%; background: linear-gradient(135deg, #0ea5e9, #0284c7); color: white; border: none; border-radius: 6px; padding: 0.5rem; font-size: 0.8rem; cursor: pointer;">
                                üì∏ Tomar
                            </button>
                        </div>

                        <!-- Captura R√°pida -->
                        <div style="background: linear-gradient(135deg, #fef3c7, #fde68a); border-radius: 10px; padding: 1rem; border: 2px solid #f59e0b;">
                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                <span style="font-size: 1.3rem;">‚ö°</span>
                                <div>
                                    <h4 style="margin: 0; font-size: 0.9rem; color: #92400e;">Captura R√°pida</h4>
                                    <p style="margin: 0; font-size: 0.7rem; color: #78350f;">Muchas fotos</p>
                                </div>
                            </div>
                            <button onclick="startQuickCaptureMode()" style="width: 100%; background: linear-gradient(135deg, #f59e0b, #d97706); color: white; border: none; border-radius: 6px; padding: 0.5rem; font-size: 0.8rem; cursor: pointer;">
                                ‚ö° R√°pido
                            </button>
                        </div>

                        <!-- Row 2: Subir Archivos, Nota de Voz -->

                        <!-- Subir Archivos -->
                        <div style="background: linear-gradient(135deg, #d1fae5, #a7f3d0); border-radius: 10px; padding: 1rem; border: 2px solid #10b981;">
                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                <span style="font-size: 1.3rem;">üìÅ</span>
                                <div>
                                    <h4 style="margin: 0; font-size: 0.9rem; color: #065f46;">Subir Archivos</h4>
                                    <p style="margin: 0; font-size: 0.7rem; color: #064e3b;">Desde galer√≠a</p>
                                </div>
                            </div>
                            <button onclick="openMultiplePhotosPicker()" style="width: 100%; background: linear-gradient(135deg, #10b981, #059669); color: white; border: none; border-radius: 6px; padding: 0.5rem; font-size: 0.8rem; cursor: pointer;">
                                üìÅ Subir
                            </button>
                        </div>

                        <!-- Nota de Voz + Foto -->
                        <div style="background: linear-gradient(135deg, #fce7f3, #fbcfe8); border-radius: 10px; padding: 1rem; border: 2px solid #ec4899;">
                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                <span style="font-size: 1.3rem;">üéôÔ∏è</span>
                                <div>
                                    <h4 style="margin: 0; font-size: 0.9rem; color: #9d174d;">Nota de Voz</h4>
                                    <p style="margin: 0; font-size: 0.7rem; color: #831843;">Audio + foto</p>
                                </div>
                            </div>
                            <button onclick="startVoiceNoteMode()" style="width: 100%; background: linear-gradient(135deg, #ec4899, #db2777); color: white; border: none; border-radius: 6px; padding: 0.5rem; font-size: 0.8rem; cursor: pointer;">
                                üéôÔ∏è Grabar
                            </button>
                        </div>
                    </div>

                    <!-- Pending Dictations Panel -->
                    <div id="pendingDictationsSection" style="margin-bottom: 1rem;">
                        <div id="pendingDictationsContainer" style="background: #f9fafb; border-radius: 8px; padding: 0.75rem; min-height: auto;">
                            <div style="text-align: center; color: #999; padding: 0.5rem; font-size: 0.85rem;">
                                üé§ Use AI Voice para dictar informaci√≥n del animal
                            </div>
                        </div>
                        <div id="dictationActions" style="display: none; margin-top: 0.5rem; display: flex; gap: 0.5rem; justify-content: flex-end;">
                            <button onclick="clearAllPendingDictations()" class="btn btn-secondary" style="font-size: 0.8rem; padding: 0.4rem 0.75rem;">
                                üóëÔ∏è Limpiar
                            </button>
                            <button id="saveAllDictationsBtn" onclick="saveAllPendingDictations()" class="btn btn-success" style="font-size: 0.8rem; padding: 0.4rem 0.75rem; background: #10b981;">
                                üíæ Guardar
                            </button>
                        </div>
                    </div>

                    <div style="margin-top: 2rem;">
                        <h3 style="margin-bottom: 1rem;">Animales con Fotos</h3>
                        <div id="animalPhotosGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1rem;">
                            <div style="grid-column: 1/-1; text-align: center; color: var(--gray); padding: 2rem;">
                                No hay fotos registradas a√∫n
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Tab: Entradas -->
        <div id="tab-entradas" class="tab-content">
            <div class="card">
                <div class="card-header compras">
                    <span>üì• Historial de Entradas (Compras + Nacimientos)</span>
                </div>
                <div class="card-body">
            <div class="filters" style="flex-wrap: wrap;">
                <div style="flex: 1; min-width: 300px;">
                    <input type="text" class="form-input" id="entradasSearch" placeholder="üîç Buscar por chapeta, lote, vendedor, raza..." oninput="filterEntradas()" style="width: 100%;">
                    <div class="form-hint" style="margin-top: 0.25rem;">üí° Escribe para filtrar autom√°ticamente - sin necesidad de hacer clic</div>
                </div>
                        <select class="form-select" id="entradasTipoFilter" onchange="filterEntradas()">
                            <option value="">Todos los tipos</option>
                            <option value="compra">Compras</option>
                            <option value="nacimiento">Nacimientos</option>
                        </select>
                        <select class="form-select" id="entradasPeriodoFilter" onchange="handleEntradasPeriodoChange()" style="min-width: 150px;">
                            <option value="">Todos los registros</option>
                            <option value="ano_actual">üìÖ A√±o en curso</option>
                            <option value="ultimo_mes">üìÜ √öltimo mes</option>
                            <option value="ultimo_lote">üì¶ √öltimo lote</option>
                            <option value="ano_especifico">üóìÔ∏è A√±o espec√≠fico</option>
                            <option value="rango_fechas">üìä Rango de fechas</option>
                        </select>
                        <select class="form-select" id="entradasYearSelect" style="display:none; min-width: 100px;" onchange="filterEntradas()">
                            <option value="">Seleccionar a√±o</option>
                        </select>
                        <div id="entradasDateRange" style="display:none; display: flex; gap: 0.5rem; align-items: center;">
                            <input type="date" class="form-input" id="entradasDateFrom" onchange="filterEntradas()" style="width: auto;">
                            <span>a</span>
                            <input type="date" class="form-input" id="entradasDateTo" onchange="filterEntradas()" style="width: auto;">
                        </div>
                    </div>
                    <div class="table-container">
                        <table id="entradasTableContainer">
                            <thead>
                                <tr>
                                    <th class="text-center sticky-col">#</th>
                                    <th class="sortable" data-sort="numero" data-type="number">Chapeta</th>
                                    <th class="sortable" data-sort="tipo" data-type="text">Tipo</th>
                                    <th class="sortable" data-sort="lote" data-type="text">Lote</th>
                                    <th class="sortable" data-sort="vendedor" data-type="text">Vendedor/Madre</th>
                                    <th class="sortable" data-sort="raza" data-type="text">Raza</th>
                                    <th class="sortable" data-sort="sexo" data-type="text">Sexo</th>
                                    <th class="sortable text-right" data-sort="peso" data-type="number">Peso</th>
                                    <th class="sortable text-right" data-sort="precioKilo" data-type="number">$/Kg</th>
                                    <th class="sortable" data-sort="fechaEntrada" data-type="date">Fecha</th>
                                    <th class="sortable text-right" data-sort="costoTotal" data-type="number">Costo</th>
                                    <th class="sortable" data-sort="estado" data-type="text">Estado</th>
                                </tr>
                            </thead>
                            <tbody id="entradasTable">
                                <tr><td colspan="12" class="text-center">No hay datos</td></tr>
                            </tbody>
                            <tfoot id="entradasSummary">
                                <tr class="summary-row summary-total">
                                    <td class="summary-label sticky-col" data-summary="label">Totales (0)</td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td class="text-right" data-summary="peso">-</td>
                                    <td class="text-right" data-summary="precio">-</td>
                                    <td></td>
                                    <td class="text-right" data-summary="costo">-</td>
                                    <td></td>
                                </tr>
                                <tr class="summary-row summary-average">
                                    <td class="summary-label sticky-col">Promedios</td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td class="text-right" data-summary="peso-avg">-</td>
                                    <td class="text-right" data-summary="precio-avg">-</td>
                                    <td></td>
                                    <td class="text-right" data-summary="costo-avg">-</td>
                                    <td></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Tab: Salidas -->
        <div id="tab-salidas" class="tab-content">
            <div class="card">
                <div class="card-header ventas">
                    <span>üì§ Historial de Salidas (Ventas + Muertes)</span>
                </div>
                <div class="card-body">
                    <div class="filters" style="flex-wrap: wrap;">
                        <input type="text" class="form-input" id="salidasSearch" placeholder="Buscar..." oninput="filterSalidas()">
                        <select class="form-select" id="salidasTipoFilter" onchange="filterSalidas()">
                            <option value="">Todos los tipos</option>
                            <option value="venta">Ventas</option>
                            <option value="muerte">Muertes</option>
                        </select>
                        <select class="form-select" id="salidasPeriodoFilter" onchange="handleSalidasPeriodoChange()" style="min-width: 150px;">
                            <option value="">Todos los registros</option>
                            <option value="ano_actual">üìÖ A√±o en curso</option>
                            <option value="ultimo_mes">üìÜ √öltimo mes</option>
                            <option value="ultima_venta">üíµ √öltimas ventas</option>
                            <option value="ano_especifico">üóìÔ∏è A√±o espec√≠fico</option>
                            <option value="rango_fechas">üìä Rango de fechas</option>
                        </select>
                        <select class="form-select" id="salidasYearSelect" style="display:none; min-width: 100px;" onchange="filterSalidas()">
                            <option value="">Seleccionar a√±o</option>
                        </select>
                        <div id="salidasDateRange" style="display:none; display: flex; gap: 0.5rem; align-items: center;">
                            <input type="date" class="form-input" id="salidasDateFrom" onchange="filterSalidas()" style="width: auto;">
                            <span>a</span>
                            <input type="date" class="form-input" id="salidasDateTo" onchange="filterSalidas()" style="width: auto;">
                        </div>
                    </div>
                    <div class="table-container">
                        <table id="salidasTableContainer">
                            <thead>
                                <tr>
                                    <th class="text-center sticky-col">#</th>
                                    <th class="sortable" data-sort="numero" data-type="number">Chapeta</th>
                                    <th class="sortable" data-sort="tipo" data-type="text">Tipo</th>
                                    <th class="sortable text-right" data-sort="peso" data-type="number">Peso</th>
                                    <th class="sortable" data-sort="fechaSalida" data-type="date">Fecha</th>
                                    <th class="sortable text-right" data-sort="precioKiloVenta" data-type="number">$/Kg</th>
                                    <th class="sortable" data-sort="comprador" data-type="text">Comprador</th>
                                    <th class="sortable text-right" data-sort="costoVenta" data-type="number">Valor</th>
                                    <th class="text-right">Costo compra</th>
                                    <th class="sortable text-right" data-sort="gananciaDay" data-type="number">GDP</th>
                                </tr>
                            </thead>
                            <tbody id="salidasTable">
                                <tr><td colspan="10" class="text-center">No hay datos</td></tr>
                            </tbody>
                            <tfoot id="salidasSummary">
                                <tr class="summary-row summary-total">
                                    <td class="summary-label sticky-col" data-summary="label">Totales (0)</td>
                                    <td></td>
                                    <td></td>
                                    <td class="text-right" data-summary="peso">-</td>
                                    <td></td>
                                    <td class="text-right" data-summary="precio">-</td>
                                    <td></td>
                                    <td class="text-right" data-summary="valor">-</td>
                                    <td class="text-right" data-summary="costo-compra">-</td>
                                    <td class="text-right" data-summary="gdp">-</td>
                                </tr>
                                <tr class="summary-row summary-average">
                                    <td class="summary-label sticky-col">Promedios</td>
                                    <td></td>
                                    <td></td>
                                    <td class="text-right" data-summary="peso-avg">-</td>
                                    <td></td>
                                    <td class="text-right" data-summary="precio-avg">-</td>
                                    <td></td>
                                    <td class="text-right" data-summary="valor-avg">-</td>
                                    <td class="text-right" data-summary="costo-compra-avg">-</td>
                                    <td class="text-right" data-summary="gdp-avg">-</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Tab: Salud (Health & Treatments) -->
        <div id="tab-salud" class="tab-content">
            <div class="card">
                <div class="card-header" style="background: linear-gradient(135deg, #e91e63, #c2185b);">
                    <span>üíâ Gesti√≥n de Salud</span>
                </div>
                <div class="card-body">
                    <!-- Quick Stats -->
                    <div class="summary-grid" style="margin-bottom: 1.5rem;">
                        <div class="summary-box" style="background: linear-gradient(135deg, #e8f5e9, #c8e6c9);">
                            <div class="summary-box-icon">‚úÖ</div>
                            <div class="summary-box-value" id="saludVacunasAlDia">0</div>
                            <div class="summary-box-label">Vacunas al d√≠a</div>
                        </div>
                        <div class="summary-box" style="background: linear-gradient(135deg, #fff3e0, #ffe0b2);">
                            <div class="summary-box-icon">‚ö†Ô∏è</div>
                            <div class="summary-box-value" id="saludVacunasPendientes">0</div>
                            <div class="summary-box-label">Vacunas pendientes</div>
                        </div>
                        <div class="summary-box" style="background: linear-gradient(135deg, #fce4ec, #f8bbd9);">
                            <div class="summary-box-icon">üíä</div>
                            <div class="summary-box-value" id="saludEnTratamiento">0</div>
                            <div class="summary-box-label">En tratamiento</div>
                        </div>
                        <div class="summary-box" style="background: linear-gradient(135deg, #ffebee, #ffcdd2);">
                            <div class="summary-box-icon">üö´</div>
                            <div class="summary-box-value" id="saludEnRetiro">0</div>
                            <div class="summary-box-label">En periodo retiro</div>
                        </div>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div class="action-grid" style="margin-bottom: 1.5rem;">
                        <button class="action-btn" style="background: linear-gradient(135deg, #4caf50, #388e3c);" onclick="showSaludForm('vacuna')">
                            <span class="action-btn-icon">üíâ</span>
                            <span class="action-btn-label">Registrar Vacuna</span>
                        </button>
                        <button class="action-btn" style="background: linear-gradient(135deg, #ff9800, #f57c00);" onclick="showSaludForm('desparasitacion')">
                            <span class="action-btn-icon">üêõ</span>
                            <span class="action-btn-label">Desparasitaci√≥n</span>
                        </button>
                        <button class="action-btn" style="background: linear-gradient(135deg, #e91e63, #c2185b);" onclick="showSaludForm('tratamiento')">
                            <span class="action-btn-icon">üíä</span>
                            <span class="action-btn-label">Tratamiento</span>
                        </button>
                        <button class="action-btn" style="background: linear-gradient(135deg, #9c27b0, #7b1fa2);" onclick="showSaludForm('revision')">
                            <span class="action-btn-icon">ü©∫</span>
                            <span class="action-btn-label">Revisi√≥n Veterinaria</span>
                        </button>
                    </div>
                    
                    <!-- Health Registration Form (hidden by default) -->
                    <div id="saludFormContainer" style="display: none;">
                        <div class="card" style="border: 2px solid #e91e63; margin-bottom: 1.5rem;">
                            <div class="card-header" style="background: linear-gradient(135deg, #e91e63, #c2185b);">
                                <span id="saludFormTitle">üíâ Registrar Evento de Salud</span>
                                <button class="modal-close" onclick="hideSaludForm()" style="color:white;">√ó</button>
                            </div>
                            <div class="card-body">
                                <form id="saludForm" onsubmit="saveSaludEvento(event)">
                                    <input type="hidden" id="saludTipo" value="vacuna">
                                    
                                    <div class="form-group">
                                        <label class="form-label">Seleccionar Animales <span class="required">*</span></label>
                                        <div style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
                                            <button type="button" class="btn btn-secondary" onclick="selectAllAnimalsForSalud()">Seleccionar todos</button>
                                            <button type="button" class="btn btn-secondary" onclick="clearSaludSelection()">Limpiar selecci√≥n</button>
                                            <input type="text" class="form-input" id="saludSearchAnimal" placeholder="Buscar por chapeta..." oninput="filterAnimalsForSalud()" style="flex: 1;">
                                        </div>
                                        <div class="animal-selector" id="saludAnimalSelector" style="max-height: 150px;"></div>
                                        <div class="form-hint">Animales seleccionados: <strong id="saludSelectedCount">0</strong></div>
                                    </div>
                                    
                                    <div class="form-grid">
                                        <div class="form-group">
                                            <label class="form-label">Fecha <span class="required">*</span></label>
                                            <input type="date" class="form-input" id="saludFecha" required>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label" id="saludProductoLabel">Vacuna/Medicamento <span class="required">*</span></label>
                                            <input type="text" class="form-input" id="saludProducto" required list="productosSaludList" placeholder="ej: Aftosa, Carb√≥n, Ivermectina">
                                            <datalist id="productosSaludList">
                                                <option value="Fiebre Aftosa">
                                                <option value="Carb√≥n Sintom√°tico">
                                                <option value="Brucelosis">
                                                <option value="Rabia">
                                                <option value="Triple (Carb√≥n+Edema+Septicemia)">
                                                <option value="Ivermectina">
                                                <option value="Albendazol">
                                                <option value="Levamisol">
                                                <option value="Oxitetraciclina">
                                                <option value="Penicilina">
                                                <option value="Vitaminas ADE">
                                            </datalist>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Dosis</label>
                                            <input type="text" class="form-input" id="saludDosis" placeholder="ej: 5ml, 2 tabletas">
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Lote del Producto</label>
                                            <input type="text" class="form-input" id="saludLoteProducto" placeholder="Lote del fabricante">
                                        </div>
                                        <div class="form-group" id="saludRetiroGroup">
                                            <label class="form-label">D√≠as de Retiro</label>
                                            <input type="number" class="form-input" id="saludDiasRetiro" min="0" value="0" placeholder="0">
                                            <div class="form-hint">D√≠as antes de poder vender el animal</div>
                                        </div>
                                        <div class="form-group" id="saludProximaGroup">
                                            <label class="form-label">Pr√≥xima Aplicaci√≥n</label>
                                            <input type="date" class="form-input" id="saludProximaFecha">
                                            <div class="form-hint">Para vacunas con refuerzo</div>
                                        </div>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label class="form-label">Veterinario / Aplicador</label>
                                        <input type="text" class="form-input" id="saludVeterinario" placeholder="Nombre del veterinario o responsable">
                                    </div>
                                    
                                    <div class="form-group">
                                        <label class="form-label">Observaciones</label>
                                        <textarea class="form-input" id="saludObservaciones" rows="2" placeholder="Notas adicionales..."></textarea>
                                    </div>
                                    
                                    <button type="submit" class="btn btn-primary" style="width: 100%;">
                                        üíæ Guardar Registro de Salud
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Alerts Section -->
                    <div id="saludAlertas" class="card" style="margin-bottom: 1.5rem; display: none;">
                        <div class="card-header" style="background: linear-gradient(135deg, #ff9800, #f57c00);">
                            <span>‚ö†Ô∏è Alertas de Salud</span>
                        </div>
                        <div class="card-body" id="saludAlertasContent">
                        </div>
                    </div>
                    
                    <!-- Health History -->
                    <div class="card">
                        <div class="card-header">
                            <span>üìã Historial de Salud</span>
                        </div>
                        <div class="card-body">
                            <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem; flex-wrap: wrap;">
                                <input type="text" class="form-input" id="saludHistorialSearch" placeholder="Buscar..." oninput="filterSaludHistorial()" style="flex: 1; min-width: 150px;">
                                <select class="form-select" id="saludHistorialTipo" onchange="filterSaludHistorial()" style="width: auto;">
                                    <option value="">Todos los tipos</option>
                                    <option value="vacuna">üíâ Vacunas</option>
                                    <option value="desparasitacion">üêõ Desparasitaciones</option>
                                    <option value="tratamiento">üíä Tratamientos</option>
                                    <option value="revision">ü©∫ Revisiones</option>
                                </select>
                            </div>
                            <div class="table-container">
                                <table id="saludHistorialTable">
                                    <thead>
                                        <tr>
                                            <th>Fecha</th>
                                            <th>Tipo</th>
                                            <th>Producto</th>
                                            <th>Animales</th>
                                            <th>Retiro</th>
                                            <th>Pr√≥xima</th>
                                        </tr>
                                    </thead>
                                    <tbody id="saludHistorialBody">
                                        <tr><td colspan="6" class="text-center">No hay registros de salud</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab: Cr√≠a (Breeding Management - San Fernando Only) -->
        <div id="tab-cria" class="tab-content">
            <div class="card" style="border: 2px solid #0ea5e9;">
                <div class="card-header" style="background: linear-gradient(135deg, #0ea5e9, #0284c7);">
                    <span>üêÑ Gesti√≥n de Cr√≠a - San Fernando</span>
                </div>
                <div class="card-body">
                    <!-- Breeding Sub-Navigation -->
                    <div style="display: flex; gap: 0.5rem; margin-bottom: 1.5rem; flex-wrap: wrap; border-bottom: 2px solid #e5e7eb; padding-bottom: 0.75rem;">
                        <button id="criaBtnVacas" onclick="showCriaSection('vacas')" class="btn" style="background: #0ea5e9; color: white;">
                            üêÑ Vacas
                        </button>
                        <button id="criaBtnCrias" onclick="showCriaSection('crias')" class="btn btn-secondary">
                            üë∂ Cr√≠as
                        </button>
                        <button id="criaBtnServicios" onclick="showCriaSection('servicios')" class="btn btn-secondary">
                            üíï Servicios
                        </button>
                        <button id="criaBtnDiagnosticos" onclick="showCriaSection('diagnosticos')" class="btn btn-secondary">
                            üîç Diagn√≥sticos
                        </button>
                    </div>

                    <!-- Section: Vacas (Breeding Cows) -->
                    <div id="cria-section-vacas">
                        <!-- Status Filter -->
                        <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem; flex-wrap: wrap;">
                            <label style="font-weight: bold; color: #0284c7; align-self: center;">Filtrar:</label>
                            <select id="criaVacasFilter" onchange="renderCriaVacas()" class="form-input" style="width: auto; min-width: 150px;">
                                <option value="todas">Todas las vacas</option>
                                <option value="vacia">üîµ Vac√≠as</option>
                                <option value="servida">üíï Servidas</option>
                                <option value="prenada">ü§∞ Pre√±adas</option>
                                <option value="proxima_parto">‚è∞ Pr√≥ximas a parir</option>
                                <option value="lactando">üçº Lactando</option>
                            </select>
                            <button onclick="showRegistrarServicioModal()" class="btn" style="background: #ec4899; color: white; margin-left: auto;">
                                üíï Registrar Servicio
                            </button>
                        </div>

                        <!-- Vacas Summary Cards -->
                        <div class="summary-grid" style="margin-bottom: 1rem;">
                            <div class="summary-box" style="background: linear-gradient(135deg, #dbeafe, #bfdbfe);">
                                <div class="summary-box-icon">üêÑ</div>
                                <div class="summary-box-value" id="criaTotalVacas">0</div>
                                <div class="summary-box-label">Total Vacas</div>
                            </div>
                            <div class="summary-box" style="background: linear-gradient(135deg, #fce7f3, #fbcfe8);">
                                <div class="summary-box-icon">ü§∞</div>
                                <div class="summary-box-value" id="criaTotalPrenadas">0</div>
                                <div class="summary-box-label">Pre√±adas</div>
                            </div>
                            <div class="summary-box" style="background: linear-gradient(135deg, #d1fae5, #a7f3d0);">
                                <div class="summary-box-icon">üçº</div>
                                <div class="summary-box-value" id="criaTotalLactando">0</div>
                                <div class="summary-box-label">Lactando</div>
                            </div>
                            <div class="summary-box" style="background: linear-gradient(135deg, #fef3c7, #fde68a);">
                                <div class="summary-box-icon">‚è∞</div>
                                <div class="summary-box-value" id="criaTotalProximas">0</div>
                                <div class="summary-box-label">Pr√≥x. 30 d√≠as</div>
                            </div>
                        </div>

                        <!-- Vacas List -->
                        <div id="criaVacasList" style="max-height: 500px; overflow-y: auto;">
                            <div style="text-align: center; padding: 2rem; color: #666;">
                                <div style="font-size: 3rem; margin-bottom: 0.5rem;">üêÑ</div>
                                <p>No hay vacas registradas en San Fernando</p>
                                <p style="font-size: 0.85rem;">Agregue animales hembra en la pesta√±a "Entradas"</p>
                            </div>
                        </div>
                    </div>

                    <!-- Section: Cr√≠as (Cow-Calf Pairs & Weaning) -->
                    <div id="cria-section-crias" style="display: none;">
                        <!-- Weaning Alert Banner -->
                        <div id="criaWeaningAlert" style="display: none; background: linear-gradient(135deg, #fef3c7, #fde68a); border: 2px solid #f59e0b; border-radius: 10px; padding: 1rem; margin-bottom: 1rem;">
                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                <span style="font-size: 1.5rem;">‚ö†Ô∏è</span>
                                <h4 style="margin: 0; color: #92400e;">Cr√≠as Listas para Destete</h4>
                            </div>
                            <p style="color: #78350f; margin: 0 0 0.75rem 0; font-size: 0.9rem;">
                                Las siguientes cr√≠as tienen 6-9 meses de edad y est√°n listas para ser destetadas:
                            </p>
                            <div id="criaWeaningAlertList" style="display: flex; flex-wrap: wrap; gap: 0.5rem;"></div>
                        </div>

                        <!-- Filter Controls -->
                        <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem; flex-wrap: wrap; align-items: center;">
                            <label style="font-weight: bold; color: #0284c7;">Filtrar:</label>
                            <select id="criaCriasFilter" onchange="renderCriaCrias()" class="form-input" style="width: auto; min-width: 150px;">
                                <option value="todas">Todas las cr√≠as</option>
                                <option value="con_madre">üçº Con madre (lactando)</option>
                                <option value="destete_listo">‚ö†Ô∏è Listas para destete</option>
                                <option value="destetadas">‚úÖ Destetadas</option>
                                <option value="machos">‚ôÇÔ∏è Machos</option>
                                <option value="hembras">‚ôÄÔ∏è Hembras</option>
                            </select>
                            <button onclick="showRegistrarDesteteModal()" class="btn" style="background: #f59e0b; color: white; margin-left: auto;">
                                üçº‚û°Ô∏è Registrar Destete
                            </button>
                        </div>

                        <!-- Summary Cards -->
                        <div class="summary-grid" style="margin-bottom: 1rem;">
                            <div class="summary-box" style="background: linear-gradient(135deg, #dbeafe, #bfdbfe);">
                                <div class="summary-box-icon">üêÆ</div>
                                <div class="summary-box-value" id="criaTotalCrias">0</div>
                                <div class="summary-box-label">Total Cr√≠as</div>
                            </div>
                            <div class="summary-box" style="background: linear-gradient(135deg, #d1fae5, #a7f3d0);">
                                <div class="summary-box-icon">üêÑüêÆ</div>
                                <div class="summary-box-value" id="criaCriasConMadre">0</div>
                                <div class="summary-box-label">Con Madre</div>
                            </div>
                            <div class="summary-box" style="background: linear-gradient(135deg, #fef3c7, #fde68a);">
                                <div class="summary-box-icon">‚ö†Ô∏è</div>
                                <div class="summary-box-value" id="criaCriasListasDestete">0</div>
                                <div class="summary-box-label">Listas Destete</div>
                            </div>
                            <div class="summary-box" style="background: linear-gradient(135deg, #e0e7ff, #c7d2fe);">
                                <div class="summary-box-icon">‚úÖ</div>
                                <div class="summary-box-value" id="criaCriasDestetadas">0</div>
                                <div class="summary-box-label">Destetadas</div>
                            </div>
                        </div>

                        <!-- Cow-Calf Pairs List -->
                        <h4 style="color: #0284c7; margin-bottom: 0.75rem;">üêÑüêÆ Parejas Vaca-Cr√≠a</h4>
                        <div id="criaCriasList" style="max-height: 500px; overflow-y: auto;">
                            <div style="text-align: center; padding: 2rem; color: #666;">
                                <div style="font-size: 3rem; margin-bottom: 0.5rem;">üêÆ</div>
                                <p>No hay cr√≠as registradas en San Fernando</p>
                                <p style="font-size: 0.85rem;">Registre nacimientos en la pesta√±a "Entradas" ‚Üí "Nacimiento"</p>
                            </div>
                        </div>
                    </div>

                    <!-- Section: Servicios (Breeding Events) -->
                    <div id="cria-section-servicios" style="display: none;">
                        <!-- Quick Actions -->
                        <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem; flex-wrap: wrap;">
                            <button onclick="showRegistrarServicioModal()" class="btn" style="background: #ec4899; color: white;">
                                ‚ûï Registrar Servicio
                            </button>
                            <button onclick="showRegistrarToroModal()" class="btn" style="background: #8b5cf6; color: white;">
                                üêÇ Agregar Toro
                            </button>
                        </div>

                        <!-- Services Summary -->
                        <div class="summary-grid" style="margin-bottom: 1rem;">
                            <div class="summary-box" style="background: linear-gradient(135deg, #fce7f3, #fbcfe8);">
                                <div class="summary-box-icon">üíï</div>
                                <div class="summary-box-value" id="criaTotalServicios">0</div>
                                <div class="summary-box-label">Servicios Totales</div>
                            </div>
                            <div class="summary-box" style="background: linear-gradient(135deg, #e0e7ff, #c7d2fe);">
                                <div class="summary-box-icon">üêÇ</div>
                                <div class="summary-box-value" id="criaTotalMontaNatural">0</div>
                                <div class="summary-box-label">Monta Natural</div>
                            </div>
                            <div class="summary-box" style="background: linear-gradient(135deg, #cffafe, #a5f3fc);">
                                <div class="summary-box-icon">üíâ</div>
                                <div class="summary-box-value" id="criaTotalIA">0</div>
                                <div class="summary-box-label">Inseminaci√≥n</div>
                            </div>
                            <div class="summary-box" style="background: linear-gradient(135deg, #fef3c7, #fde68a);">
                                <div class="summary-box-icon">‚è≥</div>
                                <div class="summary-box-value" id="criaPendienteDiagnostico">0</div>
                                <div class="summary-box-label">Pend. Diagn√≥stico</div>
                            </div>
                        </div>

                        <!-- Toros Section -->
                        <div class="card" style="margin-bottom: 1rem; border: 1px solid #8b5cf6;">
                            <div class="card-header" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed); padding: 0.5rem 1rem;">
                                <span>üêÇ Toros Registrados</span>
                            </div>
                            <div class="card-body" style="padding: 0.75rem;">
                                <div id="criaTorosList">
                                    <div style="text-align: center; padding: 1rem; color: #666;">
                                        <p>No hay toros registrados</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Services History -->
                        <h4 style="color: #0284c7; margin-bottom: 0.75rem;">üìã Historial de Servicios</h4>
                        <div id="criaServiciosList" style="max-height: 400px; overflow-y: auto;">
                            <div style="text-align: center; padding: 2rem; color: #666;">
                                <div style="font-size: 2rem; margin-bottom: 0.5rem;">üíï</div>
                                <p>No hay servicios registrados</p>
                            </div>
                        </div>
                    </div>

                    <!-- Section: Diagn√≥sticos (Pregnancy Checks) -->
                    <div id="cria-section-diagnosticos" style="display: none;">
                        <!-- Quick Actions -->
                        <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem; flex-wrap: wrap;">
                            <button onclick="showRegistrarDiagnosticoModal()" class="btn" style="background: #10b981; color: white;">
                                ‚ûï Registrar Diagn√≥stico
                            </button>
                        </div>

                        <!-- Pending Diagnostics Alert -->
                        <div id="criaPendingDiagnosticsAlert" style="display: none; background: #fef3c7; border: 1px solid #f59e0b; border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                            <h4 style="color: #b45309; margin: 0 0 0.5rem 0;">‚è∞ Vacas pendientes de diagn√≥stico</h4>
                            <p style="color: #92400e; margin: 0; font-size: 0.9rem;">Las siguientes vacas tienen 60-90 d√≠as desde su √∫ltimo servicio y necesitan diagn√≥stico de pre√±ez:</p>
                            <div id="criaPendingDiagnosticsList" style="margin-top: 0.75rem;"></div>
                        </div>

                        <!-- Diagnostics Summary -->
                        <div class="summary-grid" style="margin-bottom: 1rem;">
                            <div class="summary-box" style="background: linear-gradient(135deg, #d1fae5, #a7f3d0);">
                                <div class="summary-box-icon">‚úÖ</div>
                                <div class="summary-box-value" id="criaDiagPrenadas">0</div>
                                <div class="summary-box-label">Pre√±adas</div>
                            </div>
                            <div class="summary-box" style="background: linear-gradient(135deg, #fee2e2, #fecaca);">
                                <div class="summary-box-icon">‚ùå</div>
                                <div class="summary-box-value" id="criaDiagVacias">0</div>
                                <div class="summary-box-label">Vac√≠as</div>
                            </div>
                            <div class="summary-box" style="background: linear-gradient(135deg, #fef3c7, #fde68a);">
                                <div class="summary-box-icon">‚ö†Ô∏è</div>
                                <div class="summary-box-value" id="criaDiagReabsorcion">0</div>
                                <div class="summary-box-label">Reabsorci√≥n</div>
                            </div>
                        </div>

                        <!-- Diagnostics History -->
                        <h4 style="color: #0284c7; margin-bottom: 0.75rem;">üìã Historial de Diagn√≥sticos</h4>
                        <div id="criaDiagnosticosList" style="max-height: 400px; overflow-y: auto;">
                            <div style="text-align: center; padding: 2rem; color: #666;">
                                <div style="font-size: 2rem; margin-bottom: 0.5rem;">üîç</div>
                                <p>No hay diagn√≥sticos registrados</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab: Potreros (Paddock Rotation) -->
        <div id="tab-potreros" class="tab-content">
            <div class="card">
                <div class="card-header" style="background: linear-gradient(135deg, #4caf50, #2e7d32);">
                    <span>üåø Gesti√≥n de Potreros</span>
                </div>
                <div class="card-body">
                    <!-- Quick Stats -->
                    <div class="summary-grid" style="margin-bottom: 1.5rem;">
                        <div class="summary-box" style="background: linear-gradient(135deg, #e8f5e9, #c8e6c9);">
                            <div class="summary-box-icon">üåø</div>
                            <div class="summary-box-value" id="potrerosTotal">0</div>
                            <div class="summary-box-label">Potreros</div>
                        </div>
                        <div class="summary-box" style="background: linear-gradient(135deg, #fff3e0, #ffe0b2);">
                            <div class="summary-box-icon">üêÑ</div>
                            <div class="summary-box-value" id="potrerosOcupados">0</div>
                            <div class="summary-box-label">Ocupados</div>
                        </div>
                        <div class="summary-box" style="background: linear-gradient(135deg, #e3f2fd, #bbdefb);">
                            <div class="summary-box-icon">üå±</div>
                            <div class="summary-box-value" id="potrerosDescansando">0</div>
                            <div class="summary-box-label">En descanso</div>
                        </div>
                        <div class="summary-box" style="background: linear-gradient(135deg, #c8e6c9, #a5d6a7);">
                            <div class="summary-box-icon">‚úÖ</div>
                            <div class="summary-box-value" id="potrerosListos">0</div>
                            <div class="summary-box-label">Listos (30+ d√≠as)</div>
                        </div>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div style="display: flex; gap: 0.75rem; margin-bottom: 1.5rem; flex-wrap: wrap;">
                        <button class="btn btn-primary" onclick="showPotreroForm()">
                            ‚ûï Agregar Potrero
                        </button>
                        <button class="btn btn-success" onclick="showMoverAnimalesForm()">
                            üîÑ Mover Animales
                        </button>
                    </div>
                    
                    <!-- Add Potrero Form (hidden by default) -->
                    <div id="potreroFormContainer" style="display: none;">
                        <div class="card" style="border: 2px solid #4caf50; margin-bottom: 1.5rem;">
                            <div class="card-header" style="background: linear-gradient(135deg, #4caf50, #2e7d32);">
                                <span id="potreroFormTitle">‚ûï Agregar Potrero</span>
                                <button class="modal-close" onclick="hidePotreroForm()" style="color:white;">√ó</button>
                            </div>
                            <div class="card-body">
                                <form id="potreroForm" onsubmit="savePotrero(event)">
                                    <input type="hidden" id="potreroEditId" value="">
                                    <div class="form-grid">
                                        <div class="form-group">
                                            <label class="form-label">Nombre del Potrero <span class="required">*</span></label>
                                            <input type="text" class="form-input" id="potreroNombre" required placeholder="ej: Potrero Norte, Loma Alta">
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">√Årea (hect√°reas)</label>
                                            <input type="number" class="form-input" id="potreroArea" min="0" step="0.1" placeholder="ej: 5.5">
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Tipo de Pasto</label>
                                            <select class="form-select" id="potreroTipoPasto">
                                                <option value="Brachiaria">Brachiaria</option>
                                                <option value="Estrella">Estrella</option>
                                                <option value="Guinea">Guinea</option>
                                                <option value="Angleton">Angleton</option>
                                                <option value="Kikuyo">Kikuyo</option>
                                                <option value="Nativo">Nativo/Mixto</option>
                                                <option value="Otro">Otro</option>
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Capacidad (cabezas)</label>
                                            <input type="number" class="form-input" id="potreroCapacidad" min="1" placeholder="ej: 20">
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Agua Disponible</label>
                                            <select class="form-select" id="potreroAgua">
                                                <option value="quebrada">Quebrada/R√≠o</option>
                                                <option value="bebedero">Bebedero</option>
                                                <option value="jag√ºey">Jag√ºey/Estanque</option>
                                                <option value="pozo">Pozo</option>
                                                <option value="ninguna">Sin agua directa</option>
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Estado Actual</label>
                                            <select class="form-select" id="potreroEstado">
                                                <option value="disponible">üå± Disponible</option>
                                                <option value="ocupado">üêÑ Ocupado</option>
                                                <option value="descanso">üí§ En descanso</option>
                                                <option value="mantenimiento">üîß Mantenimiento</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Notas</label>
                                        <textarea class="form-input" id="potreroNotas" rows="2" placeholder="Caracter√≠sticas, mejoras necesarias, etc."></textarea>
                                    </div>
                                    <button type="submit" class="btn btn-success" style="width: 100%;">
                                        üíæ Guardar Potrero
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Move Animals Form (hidden by default) -->
                    <div id="moverAnimalesFormContainer" style="display: none;">
                        <div class="card" style="border: 2px solid #ff9800; margin-bottom: 1.5rem;">
                            <div class="card-header" style="background: linear-gradient(135deg, #ff9800, #f57c00);">
                                <span>üîÑ Mover Animales a Potrero</span>
                                <button class="modal-close" onclick="hideMoverAnimalesForm()" style="color:white;">√ó</button>
                            </div>
                            <div class="card-body">
                                <form id="moverAnimalesForm" onsubmit="moverAnimales(event)">
                                    <div class="form-grid">
                                        <div class="form-group">
                                            <label class="form-label">Desde Potrero</label>
                                            <select class="form-select" id="moverDesde" onchange="updateAnimalesEnPotrero()">
                                                <option value="">-- Sin potrero asignado --</option>
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Hacia Potrero <span class="required">*</span></label>
                                            <select class="form-select" id="moverHacia" required>
                                                <option value="">-- Seleccionar destino --</option>
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Fecha del Movimiento</label>
                                            <input type="date" class="form-input" id="moverFecha" required>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Seleccionar Animales a Mover</label>
                                        <div style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
                                            <button type="button" class="btn btn-secondary" onclick="selectAllAnimalesMover()">Todos</button>
                                            <button type="button" class="btn btn-secondary" onclick="clearMoverSelection()">Limpiar</button>
                                        </div>
                                        <div class="animal-selector" id="moverAnimalSelector" style="max-height: 200px;"></div>
                                        <div class="form-hint">Animales seleccionados: <strong id="moverSelectedCount">0</strong></div>
                                    </div>
                                    <button type="submit" class="btn btn-warning" style="width: 100%; color: #333;">
                                        üîÑ Mover Animales
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Potreros Grid -->
                    <div id="potrerosGrid" class="summary-grid" style="grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));">
                        <div class="text-center" style="grid-column: 1/-1; padding: 2rem; color: var(--gray);">
                            No hay potreros registrados. Haga clic en "Agregar Potrero" para comenzar.
                        </div>
                    </div>
                    
                    <!-- Rotation History -->
                    <div class="card" style="margin-top: 1.5rem;">
                        <div class="card-header">
                            <span>üìú Historial de Rotaci√≥n</span>
                        </div>
                        <div class="card-body">
                            <div class="table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Fecha</th>
                                            <th>Desde</th>
                                            <th>Hacia</th>
                                            <th>Animales</th>
                                            <th>D√≠as en potrero anterior</th>
                                        </tr>
                                    </thead>
                                    <tbody id="rotacionHistorialBody">
                                        <tr><td colspan="5" class="text-center">No hay movimientos registrados</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Animal Profile Modal -->
        <div id="animalProfileModal" class="modal" style="display: none;">
            <div class="modal-content" style="max-width: 700px;">
                <div class="modal-header" id="animalProfileHeader" style="background: linear-gradient(135deg, var(--primary), #1b5e20);">
                    <span id="animalProfileTitle">üêÇ Perfil del Animal</span>
                    <button class="modal-close" onclick="closeAnimalProfile()">√ó</button>
                </div>
                <div class="modal-body" id="animalProfileBody">
                    <!-- Content will be populated dynamically -->
                </div>
            </div>
        </div>
        
        
        <!-- Tab: Progreso -->
        <div id="tab-progreso" class="tab-content">
            <div class="card">
                <div class="card-header" style="background: linear-gradient(135deg, #10b981, #059669);">
                    <span>üìà Seguimiento de Peso y Progreso</span>
                </div>
                <div class="card-body">
                    <!-- ==================== ANALYTICS DASHBOARD ==================== -->

                    <!-- Quick Actions Row -->
                    <div style="display: flex; gap: 0.75rem; margin-bottom: 1.5rem; flex-wrap: wrap;">
                        <div style="flex: 1; min-width: 200px; background: linear-gradient(135deg, #ede9fe, #ddd6fe); border-radius: 10px; padding: 1rem; border: 2px solid #8b5cf6;">
                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                <span style="font-size: 1.2rem;">üé§</span>
                                <h4 style="margin: 0; font-size: 0.9rem; color: #6d28d9;">AI Dictation</h4>
                            </div>
                            <button onclick="startProgressoDictation()" class="btn-voice" style="width: 100%; padding: 0.5rem; font-size: 0.85rem;">
                                üé§ Dictar Peso
                            </button>
                            <div id="progresoVoiceStatus" style="display: none; margin-top: 0.4rem;">
                                <div style="background: white; border-radius: 4px; padding: 0.3rem; font-size: 0.75rem;">
                                    <div id="progresoVoiceTranscript" style="color: #333;">Escuchando...</div>
                                </div>
                            </div>
                        </div>
                        <div style="flex: 1; min-width: 200px; background: linear-gradient(135deg, #e8f5e9, #c8e6c9); border-radius: 10px; padding: 1rem; border: 2px solid #10b981;">
                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                <span style="font-size: 1.2rem;">‚öñÔ∏è</span>
                                <h4 style="margin: 0; font-size: 0.9rem; color: #065f46;">Registro Manual</h4>
                            </div>
                            <button class="btn btn-primary" onclick="showRegistrarPesoForm()" style="width: 100%; background: #10b981; padding: 0.5rem; font-size: 0.85rem;">
                                ‚ûï Registrar Peso
                            </button>
                        </div>
                    </div>

                    <!-- Pending Progreso Dictations -->
                    <div id="pendingProgresoDictations" style="display: none; margin-bottom: 1.5rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                            <h4 style="margin: 0;">üìù Dictaciones Pendientes</h4>
                            <div style="display: flex; gap: 0.5rem;">
                                <button onclick="clearProgresoDictations()" class="btn btn-secondary" style="font-size: 0.8rem; padding: 0.4rem 0.75rem;">üóëÔ∏è</button>
                                <button id="saveProgresoDictationsBtn" onclick="saveAllProgresoDictations()" class="btn btn-success" style="font-size: 0.8rem; padding: 0.4rem 0.75rem; background: #10b981;">üíæ Guardar</button>
                            </div>
                        </div>
                        <div id="progresoDictationsContainer" style="background: #f9fafb; border-radius: 8px; padding: 0.75rem;"></div>
                    </div>

                    <!-- ==================== PERFORMANCE TIERS ==================== -->
                    <div class="card" style="margin-bottom: 1.5rem; border: 2px solid #10b981;">
                        <div class="card-header" style="background: linear-gradient(135deg, #10b981, #059669);">
                            <span>üèÜ Clasificaci√≥n de Rendimiento (GDP)</span>
                        </div>
                        <div class="card-body">
                            <!-- Filter Controls -->
                            <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem; flex-wrap: wrap; align-items: center;">
                                <label style="font-weight: bold; color: #065f46;">Per√≠odo:</label>
                                <select id="tierPeriodSelect" onchange="refreshPerformanceAnalytics()" class="form-input" style="width: auto; min-width: 150px;">
                                    <option value="all">Todo el historial</option>
                                    <option value="24months">√öltimos 24 meses</option>
                                    <option value="12months">√öltimos 12 meses</option>
                                </select>
                            </div>

                            <!-- Data Source Tabs -->
                            <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem; border-bottom: 2px solid #e5e7eb; padding-bottom: 0.5rem;">
                                <button id="tabTierInventory" onclick="showTierTab('inventory')" class="btn" style="background: #10b981; color: white; font-size: 0.85rem;">
                                    üì¶ Inventario Actual
                                </button>
                                <button id="tabTierSold" onclick="showTierTab('sold')" class="btn btn-secondary" style="font-size: 0.85rem;">
                                    üí∞ Ganado Vendido
                                </button>
                            </div>

                            <div id="performanceTiers" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-bottom: 1.5rem;">
                                <!-- Top Performers -->
                                <div onclick="showTierAnimals('top')" style="background: linear-gradient(135deg, #d1fae5, #a7f3d0); border-radius: 12px; padding: 1.25rem; border: 3px solid #10b981; cursor: pointer; transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
                                    <div style="text-align: center;">
                                        <div style="font-size: 2.5rem; margin-bottom: 0.5rem;">üü¢</div>
                                        <h3 style="margin: 0; color: #065f46; font-size: 1.1rem;">TOP PERFORMERS</h3>
                                        <p style="margin: 0.25rem 0; font-size: 0.8rem; color: #047857;">GDP > 0.40 kg/d√≠a</p>
                                        <div id="topPerformersCount" style="font-size: 2rem; font-weight: bold; color: #059669; margin: 0.5rem 0;">0</div>
                                        <div style="font-size: 0.85rem; color: #065f46;">animales</div>
                                        <div id="topPerformersAvgGDP" style="font-size: 1.1rem; font-weight: bold; color: #047857; margin-top: 0.5rem;">GDP: -- kg/d√≠a</div>
                                    </div>
                                </div>

                                <!-- Average Performers -->
                                <div onclick="showTierAnimals('average')" style="background: linear-gradient(135deg, #fef3c7, #fde68a); border-radius: 12px; padding: 1.25rem; border: 3px solid #f59e0b; cursor: pointer; transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
                                    <div style="text-align: center;">
                                        <div style="font-size: 2.5rem; margin-bottom: 0.5rem;">üü°</div>
                                        <h3 style="margin: 0; color: #92400e; font-size: 1.1rem;">PROMEDIO</h3>
                                        <p style="margin: 0.25rem 0; font-size: 0.8rem; color: #b45309;">GDP 0.25 - 0.40 kg/d√≠a</p>
                                        <div id="avgPerformersCount" style="font-size: 2rem; font-weight: bold; color: #d97706; margin: 0.5rem 0;">0</div>
                                        <div style="font-size: 0.85rem; color: #92400e;">animales</div>
                                        <div id="avgPerformersAvgGDP" style="font-size: 1.1rem; font-weight: bold; color: #b45309; margin-top: 0.5rem;">GDP: -- kg/d√≠a</div>
                                    </div>
                                </div>

                                <!-- Below Average -->
                                <div onclick="showTierAnimals('poor')" style="background: linear-gradient(135deg, #fee2e2, #fecaca); border-radius: 12px; padding: 1.25rem; border: 3px solid #ef4444; cursor: pointer; transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
                                    <div style="text-align: center;">
                                        <div style="font-size: 2.5rem; margin-bottom: 0.5rem;">üî¥</div>
                                        <h3 style="margin: 0; color: #991b1b; font-size: 1.1rem;">BAJO RENDIMIENTO</h3>
                                        <p style="margin: 0.25rem 0; font-size: 0.8rem; color: #dc2626;">GDP < 0.25 kg/d√≠a</p>
                                        <div id="poorPerformersCount" style="font-size: 2rem; font-weight: bold; color: #ef4444; margin: 0.5rem 0;">0</div>
                                        <div style="font-size: 0.85rem; color: #991b1b;">animales</div>
                                        <div id="poorPerformersAvgGDP" style="font-size: 1.1rem; font-weight: bold; color: #dc2626; margin-top: 0.5rem;">GDP: -- kg/d√≠a</div>
                                    </div>
                                </div>
                            </div>

                            <!-- No Data Message -->
                            <div id="noPerformanceData" style="display: none; text-align: center; padding: 2rem; color: #666;">
                                <div style="font-size: 3rem; margin-bottom: 1rem;">üìä</div>
                                <p>No hay suficientes datos de peso para calcular rendimiento.</p>
                                <p style="font-size: 0.9rem; color: #999;">Registre actualizaciones de peso para ver el an√°lisis de GDP.</p>
                            </div>

                            <!-- Herd Summary -->
                            <div id="herdSummary" style="background: #f8fafc; border-radius: 8px; padding: 1rem; display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; text-align: center;">
                                <div>
                                    <div id="herdTotalLabel" style="font-size: 0.8rem; color: #666;">Total Animales</div>
                                    <div id="herdTotalAnimals" style="font-size: 1.5rem; font-weight: bold; color: #333;">0</div>
                                </div>
                                <div>
                                    <div style="font-size: 0.8rem; color: #666;">Con Datos GDP</div>
                                    <div id="herdWithGDP" style="font-size: 1.5rem; font-weight: bold; color: #0ea5e9;">0</div>
                                </div>
                                <div>
                                    <div style="font-size: 0.8rem; color: #666;">GDP Promedio</div>
                                    <div id="herdAvgGDP" style="font-size: 1.5rem; font-weight: bold; color: #10b981;">-- kg/d√≠a</div>
                                </div>
                                <div>
                                    <div style="font-size: 0.8rem; color: #666;">Mejor GDP</div>
                                    <div id="herdBestGDP" style="font-size: 1.5rem; font-weight: bold; color: #059669;">-- kg/d√≠a</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ==================== ACTIONABLE LISTS ==================== -->
                    <div class="card" style="margin-bottom: 1.5rem;">
                        <div class="card-header" style="background: linear-gradient(135deg, #ec4899, #db2777);">
                            <span>üìã Listas de Acci√≥n</span>
                        </div>
                        <div class="card-body">
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem;">
                                <!-- Ready to Sell -->
                                <div style="background: linear-gradient(135deg, #d1fae5, #a7f3d0); border-radius: 10px; padding: 1rem; border: 2px solid #10b981;">
                                    <h4 style="margin: 0 0 0.75rem 0; color: #065f46; display: flex; align-items: center; gap: 0.5rem;">
                                        <span>üí∞</span> Listos para Venta
                                    </h4>
                                    <p style="font-size: 0.8rem; color: #047857; margin: 0 0 0.75rem 0;">Buen GDP + peso objetivo alcanzado</p>
                                    <div id="readyToSellList" style="max-height: 200px; overflow-y: auto;"></div>
                                    <div id="readyToSellCount" style="text-align: center; font-weight: bold; color: #059669; margin-top: 0.5rem;">0 animales</div>
                                </div>

                                <!-- Stars - Keep -->
                                <div style="background: linear-gradient(135deg, #fef3c7, #fde68a); border-radius: 10px; padding: 1rem; border: 2px solid #f59e0b;">
                                    <h4 style="margin: 0 0 0.75rem 0; color: #92400e; display: flex; align-items: center; gap: 0.5rem;">
                                        <span>‚≠ê</span> Estrellas
                                    </h4>
                                    <p style="font-size: 0.8rem; color: #b45309; margin: 0 0 0.75rem 0;">Excelente GDP - considerar retener</p>
                                    <div id="starAnimalsList" style="max-height: 200px; overflow-y: auto;"></div>
                                    <div id="starAnimalsCount" style="text-align: center; font-weight: bold; color: #d97706; margin-top: 0.5rem;">0 animales</div>
                                </div>

                                <!-- Underperformers -->
                                <div style="background: linear-gradient(135deg, #fee2e2, #fecaca); border-radius: 10px; padding: 1rem; border: 2px solid #ef4444;">
                                    <h4 style="margin: 0 0 0.75rem 0; color: #991b1b; display: flex; align-items: center; gap: 0.5rem;">
                                        <span>‚ö†Ô∏è</span> Bajo Rendimiento
                                    </h4>
                                    <p style="font-size: 0.8rem; color: #dc2626; margin: 0 0 0.75rem 0;">Considerar venta o revisar salud</p>
                                    <div id="underperformersList" style="max-height: 200px; overflow-y: auto;"></div>
                                    <div id="underperformersCount" style="text-align: center; font-weight: bold; color: #ef4444; margin-top: 0.5rem;">0 animales</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ==================== PESO REGISTRATION FORM ==================== -->
                    <div id="pesoFormContainer" style="display: none;">
                        <div class="card" style="border: 2px solid #10b981; margin-bottom: 1.5rem;">
                            <div class="card-header" style="background: linear-gradient(135deg, #10b981, #059669);">
                                <span>‚öñÔ∏è Registrar Peso Actualizado</span>
                                <button class="modal-close" onclick="hidePesoForm()" style="color:white;">√ó</button>
                            </div>
                            <div class="card-body">
                                <form id="pesoForm" onsubmit="savePesoUpdate(event)">
                                    <div class="form-group">
                                        <label class="form-label">Seleccionar Animal <span class="required">*</span></label>
                                        <input type="text" class="form-input" id="pesoSearchAnimal" placeholder="Buscar por chapeta..." oninput="filterAnimalsForPeso()">
                                        <div class="animal-selector" id="pesoAnimalSelector" style="max-height: 200px;"></div>
                                        <input type="hidden" id="pesoAnimalNumero" required>
                                    </div>

                                    <div id="pesoAnimalInfo" style="display: none; background: #f0f7f0; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                                        <strong>Animal Seleccionado:</strong>
                                        <div id="pesoAnimalInfoContent"></div>
                                    </div>

                                    <div class="form-grid">
                                        <div class="form-group">
                                            <label class="form-label">Peso Actualizado (kg) <span class="required">*</span></label>
                                            <input type="number" class="form-input" id="pesoNuevo" required min="1" step="0.1" style="font-size: 1.2rem;">
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Fecha de Pesaje <span class="required">*</span></label>
                                            <input type="date" class="form-input" id="pesoFecha" required>
                                        </div>
                                    </div>

                                    <div class="form-group">
                                        <label class="form-label">Observaciones</label>
                                        <textarea class="form-input" id="pesoObservaciones" rows="2" placeholder="Notas sobre el estado del animal..."></textarea>
                                    </div>

                                    <button type="submit" class="btn btn-success" style="width: 100%;">
                                        üíæ Guardar Actualizaci√≥n de Peso
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>

                    <!-- ==================== CORRELATION ANALYSIS (Moved to end) ==================== -->
                    <div class="card" style="margin-bottom: 1.5rem;">
                        <div class="card-header" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed);">
                            <span>üîç Factores que Afectan el Rendimiento</span>
                        </div>
                        <div class="card-body">
                            <div id="correlationAnalysis" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
                                <!-- By Raza -->
                                <div style="background: #f8fafc; border-radius: 8px; padding: 1rem;">
                                    <h4 style="margin: 0 0 0.75rem 0; color: #6d28d9; font-size: 0.95rem;">üêÑ Por Raza</h4>
                                    <div id="correlationByRaza" style="font-size: 0.85rem;"></div>
                                </div>
                                <!-- By Condition -->
                                <div style="background: #f8fafc; border-radius: 8px; padding: 1rem;">
                                    <h4 style="margin: 0 0 0.75rem 0; color: #6d28d9; font-size: 0.95rem;">üí™ Por Condici√≥n</h4>
                                    <div id="correlationByCondition" style="font-size: 0.85rem;"></div>
                                </div>
                                <!-- By Entry Weight -->
                                <div style="background: #f8fafc; border-radius: 8px; padding: 1rem;">
                                    <h4 style="margin: 0 0 0.75rem 0; color: #6d28d9; font-size: 0.95rem;">‚öñÔ∏è Por Peso Entrada</h4>
                                    <div id="correlationByWeight" style="font-size: 0.85rem;"></div>
                                </div>
                                <!-- By Sex -->
                                <div style="background: #f8fafc; border-radius: 8px; padding: 1rem;">
                                    <h4 style="margin: 0 0 0.75rem 0; color: #6d28d9; font-size: 0.95rem;">‚ôÇÔ∏è‚ôÄÔ∏è Por Sexo</h4>
                                    <div id="correlationBySex" style="font-size: 0.85rem;"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>

        <!-- Tab: Reportes & IA -->
        <div id="tab-analytics" class="tab-content">
            <!-- API Key Configuration -->
            <div class="card" style="margin-bottom: 1.5rem;" id="apiKeySetup">
                <div class="card-header" style="background: linear-gradient(135deg, #6366f1, #4f46e5);">
                    <span>üîë Configuraci√≥n de API Key (Opcional)</span>
                </div>
                <div class="card-body">
                    <div style="background: #d4edda; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border-left: 4px solid #28a745;">
                        <strong>‚úÖ API Key configurada autom√°ticamente</strong>
                        <p style="margin: 0.5rem 0 0 0; font-size: 0.9rem;">
                            La IA ya funciona en todos los dispositivos de la familia. Solo configura una clave personalizada si lo deseas.
                        </p>
                    </div>

                    <details style="margin-bottom: 1rem;">
                        <summary style="cursor: pointer; color: #4f46e5; font-weight: 500;">üìù ¬øQuieres usar tu propia API Key? (opcional)</summary>
                        <div style="background: #eef2ff; padding: 1rem; border-radius: 8px; margin-top: 0.5rem; border-left: 4px solid #6366f1;">
                            <ol style="margin: 0.5rem 0 0 1.5rem; font-size: 0.9rem;">
                                <li>Ve a <a href="https://aistudio.google.com/apikey" target="_blank" style="color: #4f46e5;">Google AI Studio</a></li>
                                <li>Inicia sesi√≥n con tu cuenta de Google</li>
                                <li>Haz clic en "Create API Key"</li>
                                <li>Copia la clave y p√©gala aqu√≠ abajo</li>
                            </ol>
                        </div>
                    </details>

                    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                        <input type="password"
                               id="googleApiKey"
                               class="form-input"
                               placeholder="(Opcional) Pega tu API Key personalizada..."
                               style="flex: 1; min-width: 250px;">
                        <button class="btn btn-primary" onclick="saveGoogleApiKey()" style="background: linear-gradient(135deg, #6366f1, #4f46e5);">
                            üíæ Guardar
                        </button>
                        <button class="btn btn-secondary" onclick="testGoogleApiKey()">
                            üß™ Probar
                        </button>
                    </div>
                    <div id="googleApiKeyStatus" style="margin-top: 0.75rem; font-size: 0.9rem;"></div>
                </div>
            </div>

            <!-- Custom Question Chatbox -->
            <div class="card" style="margin-bottom: 1.5rem;">
                <div class="card-header" style="background: linear-gradient(135deg, #9c27b0, #7b1fa2);">
                    <span>üí¨ Preg√∫ntale a la IA sobre tu Finca</span>
                </div>
                <div class="card-body">
                    <div style="display: flex; flex-direction: column; gap: 1rem;">
                        <div style="background: #f3e5f5; padding: 1rem; border-radius: 8px; border-left: 4px solid #9c27b0;">
                            <strong>üí° Ejemplos de preguntas:</strong>
                            <ul style="margin: 0.5rem 0 0 1.5rem; font-size: 0.9rem;">
                                <li>¬øCu√°l es el mejor momento para vender mis animales?</li>
                                <li>¬øQu√© vendedor me ha dado mejor ganado?</li>
                                <li>¬øCu√°nto puedo ganar si vendo todos los animales listos?</li>
                                <li>Dame consejos para mejorar la rentabilidad</li>
                                <li>¬øC√≥mo est√° la salud de mi hato?</li>
                            </ul>
                        </div>
                        
                        <div style="display: flex; gap: 0.5rem;">
                            <textarea 
                                id="aiCustomQuestion" 
                                class="form-input" 
                                rows="3" 
                                placeholder="Escribe tu pregunta aqu√≠... Por ejemplo: '¬øQu√© animales debo vender esta semana?' o '¬øC√≥mo puedo mejorar mi GDP?'"
                                style="flex: 1; resize: vertical;"
                            ></textarea>
                        </div>
                        
                        <div style="display: flex; gap: 0.5rem; justify-content: flex-end;">
                            <button class="btn btn-secondary" onclick="document.getElementById('aiCustomQuestion').value = ''">
                                üóëÔ∏è Limpiar
                            </button>
                            <button class="btn btn-primary" onclick="askCustomQuestion()" style="background: linear-gradient(135deg, #9c27b0, #7b1fa2);">
                                ü§ñ Preguntar a la IA
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Quick Analysis Buttons -->
            <div class="card">
                <div class="card-header">
                    <span>‚ö° An√°lisis R√°pidos</span>
                </div>
                <div class="card-body">
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 0.75rem;">
                        <button class="btn btn-secondary" onclick="quickAnalysis('resumen')">
                            üìã Resumen General
                        </button>
                        <button class="btn btn-secondary" onclick="quickAnalysis('listos_venta')">
                            üíµ Animales Listos para Venta
                        </button>
                        <button class="btn btn-secondary" onclick="quickAnalysis('mejor_gdp')">
                            üèÜ Mejor Rendimiento (GDP)
                        </button>
                        <button class="btn btn-secondary" onclick="quickAnalysis('rentabilidad')">
                            üí∞ An√°lisis de Rentabilidad
                        </button>
                        <button class="btn btn-secondary" onclick="quickAnalysis('vendedores')">
                            üë• Evaluaci√≥n de Vendedores
                        </button>
                        <button class="btn btn-secondary" onclick="quickAnalysis('compradores')">
                            üõí An√°lisis de Compradores
                        </button>
                        <button class="btn btn-secondary" onclick="quickAnalysis('salud')">
                            üíâ Estado de Salud del Hato
                        </button>
                        <button class="btn btn-secondary" onclick="quickAnalysis('potreros')">
                            üåø Eficiencia de Potreros
                        </button>
                        <button class="btn btn-secondary" onclick="quickAnalysis('proyeccion')">
                            üìÖ Proyecci√≥n 30/60/90 d√≠as
                        </button>
                        <button class="btn btn-secondary" onclick="quickAnalysis('recomendaciones')">
                            üí° Recomendaciones
                        </button>
                        <button class="btn btn-secondary" onclick="quickAnalysis('peso_rentabilidad')">
                            üìä Pesos de Compra m√°s Rentables
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- AI Response Area (Hidden by default, shows when analysis is requested) -->
            <div class="card" id="aiResponseCard" style="display: none; margin-top: 1.5rem;">
                <div class="card-header" style="background: linear-gradient(135deg, #4caf50, #388e3c);">
                    <span>üìä Resultado del An√°lisis</span>
                    <button class="btn btn-secondary" onclick="copyAnalysis()" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;">
                        üìã Copiar
                    </button>
                </div>
                <div class="card-body">
                    <div id="aiResponseContent" style="white-space: pre-wrap; line-height: 1.6;"></div>
                </div>
            </div>
            
            <!-- Loading Indicator -->
            <div id="aiLoading" style="display: none; text-align: center; padding: 2rem;">
                <div style="font-size: 3rem; animation: pulse 1s infinite;">ü§ñ</div>
                <p style="color: #666; margin-top: 1rem;" id="aiLoadingText">Analizando datos con IA...</p>
            </div>
        </div>
        
        <!-- Tab: Configuraci√≥n -->
        
        <!-- Tab: Configuraci√≥n -->
        <div id="tab-config" class="tab-content">
            <div class="card">
                <div class="card-header" style="background: linear-gradient(135deg, #0f172a, #1e293b);">
                    <span>üß≠ Versi√≥n de la App</span>
                </div>
                <div class="card-body">
                    <div style="display: flex; align-items: center; gap: 1rem; flex-wrap: wrap;">
                        <div style="font-size: 1.2rem; font-weight: 700;" id="appVersionConfig">v2</div>
                        <div style="color: #666; font-size: 0.9rem;">
                            Actualizado: <span id="appBuildDate">2026-01-10</span>
                        </div>
                    </div>
                    <div style="margin-top: 0.75rem; color: #6b7280; font-size: 0.85rem;">
                        Use este n√∫mero para confirmar que todos los dispositivos tienen la misma versi√≥n.
                    </div>
                </div>
            </div>

            <!-- Cloud Sync Section -->
            <div class="card">
                <div class="card-header" style="background: linear-gradient(135deg, #10b981, #059669);">
                    <span>‚òÅÔ∏è Sincronizaci√≥n en la Nube</span>
                </div>
                <div class="card-body">
                    <div style="background: linear-gradient(135deg, #e8f5e9, #c8e6c9); padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem; border-left: 4px solid #10b981;">
                        <h4 style="margin: 0 0 0.5rem 0; color: #2e7d32;">‚úÖ Sincronizaci√≥n Configurada</h4>
                        <p style="margin: 0; color: #555; font-size: 0.9rem;">
                            Sus datos se sincronizan autom√°ticamente con Firebase cuando hay conexi√≥n a internet.
                        </p>
                    </div>
                    
                    <!-- Firebase Configuration Section -->
                    <div class="card" style="border: 2px solid #10b981; margin-bottom: 1.5rem;">
                        <div class="card-header" style="background: linear-gradient(135deg, #10b981, #059669); cursor: pointer;" onclick="toggleFirebaseConfig()">
                            <span>üîß Configuraci√≥n de Firebase</span>
                            <span id="firebaseConfigToggle" style="float: right;">‚ñº</span>
                        </div>
                        <div class="card-body" id="firebaseConfigBody" style="display: none;">
                            <div style="background: #fff3e0; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border-left: 4px solid #ff9800;">
                                <strong>‚ö†Ô∏è IMPORTANTE:</strong>
                                <p style="margin: 0.5rem 0 0 0; font-size: 0.9rem;">
                                    Esta configuraci√≥n se guarda en firebase-config.js. No comparta esta informaci√≥n p√∫blicamente.
                                </p>
                            </div>
                            
                            <form id="firebaseConfigForm" onsubmit="saveFirebaseConfig(event)">
                                <div class="form-grid">
                                    <div class="form-group full-width">
                                        <label class="form-label">API Key <span class="required">*</span></label>
                                        <input type="text" class="form-input" id="fbApiKey" required>
                                    </div>
                                    <div class="form-group full-width">
                                        <label class="form-label">Auth Domain <span class="required">*</span></label>
                                        <input type="text" class="form-input" id="fbAuthDomain" required>
                                    </div>
                                    <div class="form-group full-width">
                                        <label class="form-label">Database URL</label>
                                        <input type="text" class="form-input" id="fbDatabaseURL">
                                    </div>
                                    <div class="form-group full-width">
                                        <label class="form-label">Project ID <span class="required">*</span></label>
                                        <input type="text" class="form-input" id="fbProjectId" required>
                                    </div>
                                    <div class="form-group full-width">
                                        <label class="form-label">Storage Bucket</label>
                                        <input type="text" class="form-input" id="fbStorageBucket">
                                    </div>
                                    <div class="form-group full-width">
                                        <label class="form-label">Messaging Sender ID</label>
                                        <input type="text" class="form-input" id="fbMessagingSenderId">
                                    </div>
                                    <div class="form-group full-width">
                                        <label class="form-label">App ID <span class="required">*</span></label>
                                        <input type="text" class="form-input" id="fbAppId" required>
                                    </div>
                                    <div class="form-group full-width">
                                        <label class="form-label">Measurement ID</label>
                                        <input type="text" class="form-input" id="fbMeasurementId">
                                    </div>
                                </div>
                                
                                <div class="btn-group" style="margin-top: 1rem;">
                                    <button type="button" class="btn btn-secondary" onclick="loadFirebaseConfig()">
                                        üîÑ Recargar Configuraci√≥n
                                    </button>
                                    <button type="submit" class="btn btn-primary">
                                        üíæ Guardar Configuraci√≥n
                                    </button>
                                    <button type="button" class="btn btn-success" onclick="testFirebaseConnection()">
                                        üß™ Probar Conexi√≥n
                                    </button>
                                </div>
                                
                                <div id="firebaseConfigStatus" style="margin-top: 1rem; padding: 1rem; border-radius: 8px; display: none;"></div>
                            </form>
                        </div>
                    </div>
                    
                    <!-- Sync Status -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
                        <div style="background: white; border: 2px solid #e5e7eb; border-radius: 8px; padding: 1rem;">
                            <div style="font-size: 0.8rem; color: #666; margin-bottom: 0.25rem;">Estado</div>
                            <div id="syncStatus" style="font-size: 1.1rem; font-weight: 600; color: #10b981;">‚óè En l√≠nea</div>
                        </div>
                        <div style="background: white; border: 2px solid #e5e7eb; border-radius: 8px; padding: 1rem;">
                            <div style="font-size: 0.8rem; color: #666; margin-bottom: 0.25rem;">√öltima Sincronizaci√≥n</div>
                            <div id="lastSyncTime" style="font-size: 1.1rem; font-weight: 600; color: #333;">Nunca</div>
                        </div>
                        <div style="background: white; border: 2px solid #e5e7eb; border-radius: 8px; padding: 1rem;">
                            <div style="font-size: 0.8rem; color: #666; margin-bottom: 0.25rem;">Datos Pendientes</div>
                            <div id="pendingChanges" style="font-size: 1.1rem; font-weight: 600; color: #333;">0</div>
                        </div>
                    </div>

                    <!-- Debug Info Panel -->
                    <div style="background: #1e293b; border-radius: 8px; padding: 1rem; margin-bottom: 1.5rem; color: #94a3b8; font-family: monospace; font-size: 0.85rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                            <span style="color: #10b981; font-weight: 600;">üìä Diagn√≥stico de Sincronizaci√≥n</span>
                            <button onclick="refreshSyncDebugInfo()" style="background: #334155; border: none; color: #94a3b8; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 0.75rem;">üîÑ Actualizar</button>
                        </div>
                        <div id="syncDebugInfo" style="line-height: 1.6;">
                            <div>Cargando...</div>
                        </div>
                    </div>
                    
                    <!-- ========== CLOUD BACKUP ========== -->
                    <div style="padding: 1.25rem; background: linear-gradient(135deg, #dcfce7, #bbf7d0); border-radius: 12px; border: 2px solid #22c55e; margin-bottom: 1.5rem;">
                        <h4 style="margin: 0 0 0.75rem 0; color: #166534; display: flex; align-items: center; gap: 0.5rem;">
                            <span style="font-size: 1.3rem;">‚òÅÔ∏è</span> Backup en la Nube (Firebase)
                        </h4>
                        <p style="margin: 0 0 1rem 0; color: #166534; font-size: 0.85rem;">
                            Sincroniza autom√°ticamente entre todos los dispositivos de la familia.
                        </p>

                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.75rem; background: white; border-radius: 8px; margin-bottom: 1rem;">
                            <input type="checkbox" id="autoSyncEnabled" checked onchange="toggleAutoSync()" style="width: 18px; height: 18px;">
                            <span style="font-size: 0.9rem;">Sincronizaci√≥n Autom√°tica</span>
                        </label>

                        <div class="btn-group" style="flex-wrap: wrap; gap: 0.5rem;">
                            <button class="btn" onclick="forceUploadToCloud()" id="forceUploadBtn" style="background: #16a34a; color: white;">
                                üì§ Subir a Nube
                            </button>
                            <button class="btn" onclick="forceDownloadFromCloud()" id="forceDownloadBtn" style="background: #0891b2; color: white;">
                                üì• Descargar de Nube
                            </button>
                        </div>

                        <div id="syncStatusPanel" style="margin-top: 1rem; padding: 0.75rem; background: rgba(255,255,255,0.7); border-radius: 8px; font-size: 0.8rem;">
                            <div id="syncStatusText" style="color: #166534;">Verificando...</div>
                        </div>
                    </div>

                    <!-- ========== LOCAL BACKUP ========== -->
                    <div style="padding: 1.25rem; background: linear-gradient(135deg, #dbeafe, #bfdbfe); border-radius: 12px; border: 2px solid #3b82f6; margin-bottom: 1.5rem;">
                        <h4 style="margin: 0 0 0.75rem 0; color: #1e40af; display: flex; align-items: center; gap: 0.5rem;">
                            <span style="font-size: 1.3rem;">üíæ</span> Backup Local (Archivo)
                        </h4>
                        <p style="margin: 0 0 1rem 0; color: #1e3a8a; font-size: 0.85rem;">
                            Guarde una copia en su computadora o restaure desde un archivo.
                        </p>

                        <div class="btn-group" style="flex-wrap: wrap; gap: 0.5rem;">
                            <button class="btn" onclick="downloadBackupFromApp()" style="background: #2563eb; color: white;">
                                üì• Descargar a Computadora
                            </button>
                            <button class="btn" onclick="document.getElementById('restoreFileInput').click()" style="background: #7c3aed; color: white;">
                                üì§ Restaurar desde Archivo
                            </button>
                            <input type="file" id="restoreFileInput" accept=".json" style="display: none;" onchange="restoreFromLocalFile(this)">
                        </div>

                        <div id="backupUploadStatus" style="margin-top: 1rem; display: none;"></div>
                    </div>

                    <!-- User ID Management Section -->
                    <div style="margin-top: 1.5rem; padding: 1.25rem; background: linear-gradient(135deg, #fef3c7, #fde68a); border-radius: 12px; border: 2px solid #f59e0b;">
                        <h4 style="margin: 0 0 1rem 0; color: #92400e; display: flex; align-items: center; gap: 0.5rem;">
                            <span style="font-size: 1.3rem;">üë•</span> Compartir con Familia
                        </h4>
                        <p style="margin: 0 0 1rem 0; color: #78350f; font-size: 0.9rem;">
                            Para sincronizar entre dispositivos de la familia, todos deben usar el <strong>mismo ID de Usuario</strong>.
                        </p>

                        <!-- Current User ID Display -->
                        <div style="background: white; border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                            <div style="font-size: 0.8rem; color: #666; margin-bottom: 0.5rem;">Tu ID de Usuario:</div>
                            <div style="display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap;">
                                <code id="currentUserIdDisplay" style="flex: 1; min-width: 200px; padding: 0.75rem; background: #f3f4f6; border-radius: 6px; font-size: 0.85rem; word-break: break-all; border: 1px solid #e5e7eb;">Cargando...</code>
                                <button class="btn btn-secondary" onclick="copyUserId()" style="white-space: nowrap;">
                                    üìã Copiar
                                </button>
                            </div>
                        </div>

                        <!-- Change User ID -->
                        <div style="background: white; border-radius: 8px; padding: 1rem;">
                            <div style="font-size: 0.8rem; color: #666; margin-bottom: 0.5rem;">Usar ID de otro familiar:</div>
                            <div style="display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap;">
                                <input type="text" id="newUserIdInput" placeholder="Pegar ID del familiar aqu√≠"
                                       style="flex: 1; min-width: 200px; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 6px; font-size: 0.9rem;">
                                <button class="btn btn-warning" onclick="changeUserId()" style="white-space: nowrap; background: #f59e0b; border-color: #f59e0b;">
                                    üîÑ Cambiar ID
                                </button>
                            </div>
                            <div style="margin-top: 0.75rem; padding: 0.75rem; background: #fef2f2; border-radius: 6px; border-left: 3px solid #ef4444; font-size: 0.8rem; color: #991b1b;">
                                <strong>‚ö†Ô∏è Importante:</strong> Al cambiar el ID, tus datos locales se reemplazar√°n con los datos de la nube del nuevo ID.
                            </div>
                        </div>
                    </div>

                    <!-- Sync Info -->
                    <div style="margin-top: 1.5rem; padding: 1rem; background: #f3f4f6; border-radius: 8px; font-size: 0.9rem;">
                        <strong>‚ÑπÔ∏è Informaci√≥n de Sincronizaci√≥n:</strong>
                        <ul style="margin: 0.5rem 0 0 1.5rem; color: #666;">
                            <li>Los datos se guardan localmente y en la nube</li>
                            <li>Funciona sin conexi√≥n - se sincroniza cuando hay internet</li>
                            <li>Todos sus dispositivos tendr√°n la misma informaci√≥n</li>
                            <li>Las fotos se comprimen antes de subir para ahorrar espacio</li>
                        </ul>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <span>‚öôÔ∏è Configuraci√≥n de la Finca</span>
                </div>
                <div class="card-body">
                    <!-- Historical GDP Info -->
                    <div style="background: linear-gradient(135deg, #e0f2fe, #bae6fd); border-radius: 10px; padding: 1rem; margin-bottom: 1.5rem; border: 2px solid #0ea5e9;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                            <h4 style="margin: 0; color: #0369a1;">üìä GDP Hist√≥rico (√öltimos 2 a√±os)</h4>
                            <button onclick="recalculateHistoricalGDP()" class="btn" style="background: #0ea5e9; color: white; font-size: 0.8rem; padding: 0.4rem 0.75rem;">
                                üîÑ Recalcular
                            </button>
                        </div>
                        <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                            <div style="flex: 1; min-width: 150px;">
                                <div style="font-size: 0.85rem; color: #0369a1;">GDP Promedio Calculado</div>
                                <div id="historicalGDPValue" style="font-size: 1.5rem; font-weight: bold; color: #0284c7;">-- kg/d√≠a</div>
                            </div>
                            <div style="flex: 1; min-width: 150px;">
                                <div style="font-size: 0.85rem; color: #0369a1;">Basado en</div>
                                <div id="historicalGDPCount" style="font-size: 1.5rem; font-weight: bold; color: #0284c7;">-- ventas</div>
                            </div>
                        </div>
                        <div style="font-size: 0.8rem; color: #0369a1; margin-top: 0.5rem;">
                            Este GDP se usa para estimar el peso actual del inventario
                        </div>
                    </div>

                    <!-- Data Management -->
                    <div style="background: #fef2f2; border-radius: 10px; padding: 1rem; margin-bottom: 1.5rem; border: 2px solid #fca5a5;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <h4 style="margin: 0; color: #991b1b;">üóëÔ∏è Limpiar Datos de Peso</h4>
                                <div style="font-size: 0.8rem; color: #991b1b; margin-top: 0.25rem;">
                                    Elimina todas las actualizaciones de peso del Progreso (usa con cuidado)
                                </div>
                            </div>
                            <button onclick="clearAllPesoUpdates()" class="btn" style="background: #dc2626; color: white; font-size: 0.85rem; padding: 0.5rem 1rem;">
                                Limpiar Todo
                            </button>
                        </div>
                    </div>

                    <!-- San Fernando Test Data (only shown for San Fernando ranch) -->
                    <div id="sanFernandoTestDataSection" style="display: none; background: linear-gradient(135deg, #e0f2fe, #bae6fd); border-radius: 10px; padding: 1rem; margin-bottom: 1.5rem; border: 2px solid #0ea5e9;">
                        <h4 style="margin: 0 0 0.75rem 0; color: #0369a1;">üß™ Datos de Prueba - San Fernando</h4>
                        <p style="font-size: 0.85rem; color: #0369a1; margin: 0 0 1rem 0;">
                            Genere datos simulados para probar el m√≥dulo de cr√≠a, o elimine todos los datos para comenzar de nuevo.
                        </p>
                        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                            <button onclick="generateSanFernandoTestData()" class="btn" style="background: #0ea5e9; color: white;">
                                üêÑ Generar Datos de Prueba
                            </button>
                            <button onclick="clearSanFernandoTestData()" class="btn" style="background: #ef4444; color: white;">
                                üóëÔ∏è Eliminar Todos los Datos
                            </button>
                        </div>
                        <div style="font-size: 0.8rem; color: #0369a1; margin-top: 0.75rem; padding: 0.5rem; background: rgba(255,255,255,0.5); border-radius: 6px;">
                            <strong>Datos generados:</strong> 120 vacas, 6 toros, 70 cr√≠as (edades variadas), servicios y diagn√≥sticos
                        </div>
                    </div>

                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">GDP Promedio (kg/d√≠a)</label>
                            <input type="number" class="form-input" id="configGDP" value="0.31" step="0.01" min="0.1" max="1" readonly style="background: #f5f5f5;">
                            <div class="form-hint">Calculado autom√°ticamente de ventas hist√≥ricas (editable si no hay datos)</div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Precio Venta Estimado ($/kg)</label>
                            <input type="number" class="form-input" id="configPrecioVenta" value="9000" step="100" min="1000">
                            <div class="form-hint">Para calcular valor del inventario</div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Peso Objetivo Venta (kg)</label>
                            <input type="number" class="form-input" id="configPesoObjetivo" value="450" step="10" min="300">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Peso M√≠nimo Venta (kg)</label>
                            <input type="number" class="form-input" id="configPesoMinimo" value="380" step="10" min="200">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Intervalo de Fotos (d√≠as)</label>
                            <input type="number" class="form-input" id="configFotoIntervalo" value="90" step="15" min="30" max="180">
                            <div class="form-hint">D√≠as recomendados entre sesiones de fotos (90 = cada 3 meses)</div>
                        </div>
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="saveConfig()">üíæ Guardar Configuraci√≥n</button>
                        <button class="btn btn-danger" onclick="clearAllData()">üóëÔ∏è Borrar Todos los Datos</button>
                    </div>
                </div>
            </div>

            <!-- Quicken Export Section -->
            <div class="card" style="margin-top: 1.5rem; border: 2px solid #7c3aed;">
                <div class="card-header" style="background: linear-gradient(135deg, #7c3aed, #5b21b6);">
                    <span>üìä Exportar a Quicken (QIF)</span>
                </div>
                <div class="card-body">
                    <p style="color: #666; margin-bottom: 1rem;">
                        Exporte transacciones de compra y venta de ganado para importar en Quicken.
                    </p>

                    <!-- Date Range Filter -->
                    <div style="display: flex; gap: 1rem; margin-bottom: 1rem; flex-wrap: wrap; align-items: center;">
                        <div class="form-group" style="margin: 0;">
                            <label class="form-label" style="margin-bottom: 0.25rem;">Desde:</label>
                            <input type="date" class="form-input" id="qifDateFrom" style="width: auto;">
                        </div>
                        <div class="form-group" style="margin: 0;">
                            <label class="form-label" style="margin-bottom: 0.25rem;">Hasta:</label>
                            <input type="date" class="form-input" id="qifDateTo" style="width: auto;">
                        </div>
                        <button onclick="loadQifTransactions()" class="btn" style="background: #7c3aed; color: white; align-self: flex-end;">
                            üîç Cargar Transacciones
                        </button>
                    </div>

                    <!-- Transaction Type Tabs -->
                    <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem; border-bottom: 2px solid #e5e7eb; padding-bottom: 0.5rem;">
                        <button id="qifTabCompras" onclick="showQifTab('compras')" class="btn" style="background: #ef4444; color: white; font-size: 0.85rem;">
                            üì• Compras (Gastos)
                        </button>
                        <button id="qifTabVentas" onclick="showQifTab('ventas')" class="btn btn-secondary" style="font-size: 0.85rem;">
                            üì§ Ventas (Ingresos)
                        </button>
                    </div>

                    <!-- Select All / None -->
                    <div style="display: flex; gap: 1rem; margin-bottom: 0.5rem;">
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="checkbox" id="qifSelectAll" onchange="toggleQifSelectAll()">
                            <span style="font-size: 0.85rem;">Seleccionar Todo</span>
                        </label>
                        <span id="qifSelectedCount" style="color: #666; font-size: 0.85rem;">0 seleccionados</span>
                    </div>

                    <!-- Transactions List -->
                    <div id="qifTransactionsList" style="max-height: 350px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 8px; padding: 0.5rem; background: #f9fafb;">
                        <div style="text-align: center; padding: 2rem; color: #666;">
                            <div style="font-size: 2rem; margin-bottom: 0.5rem;">üìã</div>
                            <p>Seleccione un rango de fechas y haga clic en "Cargar Transacciones"</p>
                        </div>
                    </div>

                    <!-- Export Button -->
                    <div style="margin-top: 1rem; display: flex; gap: 1rem; justify-content: flex-end;">
                        <button onclick="exportToQIF()" class="btn btn-primary" style="background: #7c3aed; padding: 0.75rem 1.5rem;">
                            üíæ Exportar Seleccionados a QIF
                        </button>
                    </div>

                    <!-- Instructions -->
                    <div style="margin-top: 1rem; background: #ede9fe; border-radius: 8px; padding: 1rem; font-size: 0.85rem; color: #5b21b6;">
                        <strong>Instrucciones para Quicken:</strong>
                        <ol style="margin: 0.5rem 0 0 1rem; padding: 0;">
                            <li>Exporte el archivo .qif</li>
                            <li>En Quicken: File ‚Üí Import ‚Üí QIF File</li>
                            <li>Seleccione la cuenta donde importar</li>
                            <li>Revise las transacciones importadas</li>
                        </ol>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Photo viewer modal -->
    <div class="photo-viewer" id="photoViewer" onclick="closePhotoViewer(event)">
        <button class="photo-viewer-close" onclick="closePhotoViewer()">&times;</button>
        <img id="photoViewerImg" src="" alt="Foto" onclick="event.stopPropagation()">
        <div class="photo-viewer-info" id="photoViewerInfo"></div>
        <div class="photo-viewer-nav" id="photoViewerNav" style="display: none;">
            <button onclick="event.stopPropagation(); navigatePhoto(-1)">‚Üê Anterior</button>
            <button onclick="event.stopPropagation(); navigatePhoto(1)">Siguiente ‚Üí</button>
        </div>
    </div>
    
    <!-- Toast container -->
    <div class="toast-container" id="toastContainer"></div>
    
    <script>
        // ==================== RANCH CONFIGURATION ====================
        const RANCHES = {
            la_coruna: {
                id: 'la_coruna',
                name: 'La Coru√±a',
                icon: 'üèîÔ∏è',
                theme: 'coruna',
                storageKey: 'ganadoFinca_LaCoruna'
            },
            santa_catalina: {
                id: 'santa_catalina',
                name: 'Santa Catalina',
                icon: '‚õ™',
                theme: 'catalina',
                storageKey: 'ganadoFinca_SantaCatalina'
            },
            la_vega: {
                id: 'la_vega',
                name: 'La Vega',
                icon: 'üåæ',
                theme: 'vega',
                storageKey: 'ganadoFinca_LaVega'
            },
            san_fernando: {
                id: 'san_fernando',
                name: 'San Fernando',
                icon: 'üêÑ',
                theme: 'fernando',
                storageKey: 'ganadoFinca_SanFernando'
            }
        };
        
        // Current active ranch
        let currentRanch = 'la_coruna'; // Default to La Coru√±a

        // Ranches that share potreros (cattle moves between them)
        const SHARED_POTRERO_RANCHES = ['la_coruna', 'santa_catalina'];

        // Get combined potreros for ranches that share them
        function getSharedPotreros() {
            // Only La Coru√±a and Santa Catalina share potreros
            if (!SHARED_POTRERO_RANCHES.includes(currentRanch)) {
                return data.potreros || [];
            }

            // Combine potreros from both ranches
            const combinedPotreros = [];
            const seenIds = new Set();

            SHARED_POTRERO_RANCHES.forEach(ranchId => {
                const ranch = RANCHES[ranchId];
                const ranchData = localStorage.getItem(ranch.storageKey);
                if (ranchData) {
                    try {
                        const parsed = JSON.parse(ranchData);
                        if (parsed.potreros && Array.isArray(parsed.potreros)) {
                            parsed.potreros.forEach(p => {
                                // Add ranch identifier to avoid ID conflicts
                                const uniqueId = `${ranchId}_${p.id}`;
                                if (!seenIds.has(uniqueId)) {
                                    seenIds.add(uniqueId);
                                    combinedPotreros.push({
                                        ...p,
                                        sourceRanch: ranchId,
                                        displayName: `${p.nombre} (${ranch.name})`
                                    });
                                }
                            });
                        }
                    } catch (e) {
                        console.error('Error loading potreros from', ranchId, e);
                    }
                }
            });

            return combinedPotreros;
        }

        // Check if current ranch shares potreros
        function usesSharedPotreros() {
            return SHARED_POTRERO_RANCHES.includes(currentRanch);
        }

        // App version info (update when publishing)
        const APP_VERSION = '2';
        const APP_BUILD_DATE = '2026-01-10';
        
        // ==================== DATA STORAGE ====================
        let data = {
            entradas: [],  // Compras + Nacimientos
            salidas: [],   // Ventas + Muertes
            saludEventos: [], // Health events (vaccines, treatments, etc.)
            potreros: [], // Paddocks/pastures
            rotaciones: [], // Paddock rotation history
            animalPotreros: {}, // Map of animal number -> current potrero
            weatherHistory: [], // Track weather condition changes over time
            config: {
                gdp: 0.31, // Default/average GDP
                precioVenta: 9000,
                pesoObjetivo: 450,
                pesoMinimo: 380,
                fotoIntervalo: 90, // Days between recommended photos
                currentWeather: 'lluvias', // Current weather condition
                gdpByWeather: {
                    'lluvias_fuertes': 0.22,
                    'lluvias': 0.36,
                    'veranillo': 0.42,
                    'seco': 0.30
                }
            }
        };
        
        // Sorting state for each table
        let sortState = {
            inventario: { column: null, direction: 'asc' },
            entradas: { column: null, direction: 'asc' },
            salidas: { column: null, direction: 'asc' },
            vendedores: { column: null, direction: 'asc' },
            compradores: { column: null, direction: 'asc' },
            saludHistorial: { column: null, direction: 'asc' }
        };
        
        // Selected animals for health/movement forms
        let selectedSaludAnimals = new Set();
        let selectedMoverAnimals = new Set();
        
        // ==================== INITIALIZATION ====================
        document.addEventListener('DOMContentLoaded', function() {
            // Load last selected ranch from localStorage
            const lastRanch = localStorage.getItem('ganadoFinca_lastRanch') || 'la_coruna';
            currentRanch = lastRanch;
            
            // Apply ranch theme and load data
            applyRanchTheme();
            loadData();
            loadAnimalPhotos(); // Load animal photos FIRST
            initTabs();
            initForms();
            initSortableHeaders();
            updateAllViews();
            updateAnimalPhotosGrid(); // Update photo grid after loading
            initConfigValues();
            loadApiKeys();
            updateAppVersionLabels();
            
            // Excel import listener (if element exists)
            const importExcelEl = document.getElementById('importExcel');
            if (importExcelEl) {
                importExcelEl.addEventListener('change', handleExcelImport);
            }
            
            // Set today's date as default
            const today = new Date().toISOString().split('T')[0];
            document.querySelectorAll('input[type="date"]').forEach(el => el.value = today);
            
            // Set season based on today's date for foto form
            updateSeasonFromDate();
        });

        function updateAppVersionLabels() {
            const headerEl = document.getElementById('appVersionHeader');
            const configEl = document.getElementById('appVersionConfig');
            const buildEl = document.getElementById('appBuildDate');
            const buildDate = APP_BUILD_DATE === 'auto'
                ? new Date().toISOString().split('T')[0]
                : APP_BUILD_DATE;
            
            const dateLabel = buildDate ? ` ¬∑ ${buildDate}` : '';
            if (headerEl) headerEl.textContent = `v${APP_VERSION}${dateLabel}`;
            if (configEl) configEl.textContent = `v${APP_VERSION}`;
            if (buildEl) buildEl.textContent = buildDate;
        }
        
        // ==================== RANCH SWITCHING ====================
        function switchRanch(ranchId) {
            if (ranchId === currentRanch) return;
            
            try {
                // Check for unsaved work
                const hasUnsavedWork = currentLote && currentLote.animales && currentLote.animales.length > 0 || 
                                     currentVenta && currentVenta.animales && currentVenta.animales.length > 0;
                
                // Confirm if there's unsaved work
                if (hasUnsavedWork) {
                    if (!confirm('Hay datos sin guardar. ¬øCambiar de finca de todas formas?')) {
                        return;
                    }
                }
                
                // Save current ranch data before switching
                saveData();
                
                // Reset lote/venta workflows
                currentLote = { numero: null, vendedor: null, precioKilo: null, fecha: null, cantidadEsperada: 0, animales: [] };
                currentVenta = { comprador: null, precioKilo: null, fecha: null, cantidadEsperada: 0, animales: [], esTransferencia: false, fincaDestino: null };
                
                // Switch to new ranch
                currentRanch = ranchId;
                localStorage.setItem('ganadoFinca_lastRanch', ranchId);
                
                // Apply new theme and update UI
                applyRanchTheme();
                
                // Load new ranch data
                loadData();
                loadAnimalPhotos(); // Reload photos for new ranch
                
                // Update all views
                updateAllViews();
                initConfigValues();
                
                // Reset any open forms
                document.querySelectorAll('[id^="form-"]').forEach(f => f.style.display = 'none');
                
                // Hide form containers
                const formContainers = ['saludFormContainer', 'potreroFormContainer', 'moverAnimalesFormContainer'];
                formContainers.forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.style.display = 'none';
                });
                
                // Show confirmation
                const ranch = RANCHES[ranchId];
                showToast(`${ranch.icon} Cambiado a ${ranch.name}`, 'success');
                
                console.log('Ranch switched successfully to:', ranchId);
            } catch (error) {
                console.error('Error switching ranch:', error);
                showToast('Error al cambiar de finca. Recargue la p√°gina.', 'error');
            }
        }
        
        function applyRanchTheme() {
            const ranch = RANCHES[currentRanch];
            
            // Update ranch buttons
            document.querySelectorAll('.ranch-btn').forEach(btn => btn.classList.remove('active'));
            const btnIds = {
                'la_coruna': 'btnRanchCoruna',
                'santa_catalina': 'btnRanchCatalina',
                'la_vega': 'btnRanchVega',
                'san_fernando': 'btnRanchFernando'
            };
            const activeBtn = document.getElementById(btnIds[currentRanch]);
            if (activeBtn) activeBtn.classList.add('active');
            
            // Update header
            const header = document.getElementById('mainHeader');
            if (header) {
                header.classList.remove('theme-coruna', 'theme-catalina', 'theme-vega', 'theme-fernando');
                header.classList.add('theme-' + ranch.theme);
            }
            
            // Update header title
            document.getElementById('headerRanchName').innerHTML = `${ranch.icon} ${ranch.name}`;
            
            // Update body background based on ranch
            document.body.classList.remove('theme-coruna-bg', 'theme-catalina-bg', 'theme-vega-bg', 'theme-fernando-bg', 'theme-coruna-active', 'theme-catalina-active', 'theme-vega-active', 'theme-fernando-active');
            document.body.classList.add('theme-' + ranch.theme + '-bg');
            document.body.classList.add('theme-' + ranch.theme + '-active');
        }
        
        function initConfigValues() {
            document.getElementById('configGDP').value = data.config.gdp || 0.31;
            document.getElementById('configPrecioVenta').value = data.config.precioVenta || 9000;
            document.getElementById('configPesoObjetivo').value = data.config.pesoObjetivo || 450;
            document.getElementById('configPesoMinimo').value = data.config.pesoMinimo || 380;
            document.getElementById('configFotoIntervalo').value = data.config.fotoIntervalo || 90;
            
            // Initialize weather selector
            const currentWeather = data.config.currentWeather || 'lluvias';
            const weatherRadio = document.querySelector(`input[name="currentWeather"][value="${currentWeather}"]`);
            if (weatherRadio) {
                weatherRadio.checked = true;
                updateWeatherVisuals();
            }
            
            // Show last weather change info if available (only if weather UI exists)
            if (data.weatherHistory && data.weatherHistory.length > 0) {
                const lastChange = data.weatherHistory[data.weatherHistory.length - 1];
                const weatherInfoEl = document.getElementById('weatherChangeInfo');
                const lastWeatherEl = document.getElementById('lastWeatherChange');
                if (weatherInfoEl) weatherInfoEl.style.display = 'block';
                if (lastWeatherEl) lastWeatherEl.textContent = `${getTemporadaDisplay(lastChange.to)} - ${formatDate(lastChange.fecha)}`;
            }
        }
        
        function updateWeatherCondition() {
            const selectedWeather = document.querySelector('input[name="currentWeather"]:checked')?.value;
            if (!selectedWeather) return;
            
            const oldWeather = data.config.currentWeather;
            
            // Update config
            data.config.currentWeather = selectedWeather;
            data.config.gdp = data.config.gdpByWeather[selectedWeather];
            
            // Record weather change in history
            if (!data.weatherHistory) data.weatherHistory = [];
            if (oldWeather !== selectedWeather) {
                data.weatherHistory.push({
                    fecha: new Date().toISOString().split('T')[0],
                    from: oldWeather,
                    to: selectedWeather,
                    gdp: data.config.gdp
                });
                
                // Show last change info (only if weather UI exists)
                const weatherInfoEl = document.getElementById('weatherChangeInfo');
                const lastWeatherEl = document.getElementById('lastWeatherChange');
                if (weatherInfoEl) weatherInfoEl.style.display = 'block';
                if (lastWeatherEl) lastWeatherEl.textContent = `${getTemporadaDisplay(selectedWeather)} - ${formatDate(new Date().toISOString().split('T')[0])}`;
            }
            
            // Update GDP field
            document.getElementById('configGDP').value = data.config.gdp;
            
            // Update visual selection
            updateWeatherVisuals();
            
            // Save and refresh views
            saveData();
            
            const weatherNames = {
                'lluvias_fuertes': 'Lluvias Fuertes (0.22 kg/d√≠a)',
                'lluvias': 'Lluvias (0.36 kg/d√≠a)',
                'veranillo': 'Veranillo (0.42 kg/d√≠a)',
                'seco': 'Seco (0.30 kg/d√≠a)'
            };
            
            showToast(`üå¶Ô∏è Condiciones actualizadas: ${weatherNames[selectedWeather]}`, 'success');
        }
        
        function updateWeatherVisuals() {
            // Update visual styling of weather cards
            document.querySelectorAll('.weather-option').forEach(label => {
                const radio = label.querySelector('input[type="radio"]');
                if (radio && radio.checked) {
                    label.style.background = 'linear-gradient(135deg, #e8f5e9, #c8e6c9)';
                    label.style.borderColor = 'var(--success)';
                    label.style.transform = 'scale(1.05)';
                } else {
                    label.style.background = '#fff';
                    label.style.borderColor = '#ddd';
                    label.style.transform = 'scale(1)';
                }
            });
        }

        // Calculate historical GDP from sold animals in last 2 years
        function calculateHistoricalGDP() {
            const twoYearsAgo = new Date();
            twoYearsAgo.setFullYear(twoYearsAgo.getFullYear() - 2);

            // Filter salidas from last 2 years (exclude deaths and transfers)
            const validSales = (data.salidas || []).filter(s => {
                if (!s.fechaSalida) return false;
                if (s.comprador === 'MUERTE' || s.comprador?.includes('TRANSFERENCIA')) return false;
                const fecha = new Date(s.fechaSalida);
                return fecha >= twoYearsAgo;
            });

            // Calculate GDP for each sale
            const gdpValues = [];
            validSales.forEach(s => {
                // Get original animal data
                const original = data.entradas.find(e => String(e.numero) === String(s.numero));
                if (!original || !original.fechaEntrada) return;

                const pesoEntrada = original.peso || 0;
                const pesoSalida = s.peso || 0;
                const gananciaKg = pesoSalida - pesoEntrada;

                // Calculate days in farm
                const entrada = new Date(original.fechaEntrada);
                const salida = new Date(s.fechaSalida);
                const diasEnFinca = Math.floor((salida - entrada) / (1000 * 60 * 60 * 24));

                // Use stored GDP or calculate
                let gdp = s.gananciaDay;
                if (!gdp && diasEnFinca > 0) {
                    gdp = gananciaKg / diasEnFinca;
                }

                // Only include reasonable GDP values (0.1 - 1.0 kg/day)
                if (gdp && gdp > 0.1 && gdp < 1.0) {
                    gdpValues.push(gdp);
                }
            });

            if (gdpValues.length === 0) {
                return { avgGDP: 0.31, count: 0 }; // Default if no data
            }

            const avgGDP = gdpValues.reduce((sum, g) => sum + g, 0) / gdpValues.length;
            return { avgGDP, count: gdpValues.length };
        }

        // Recalculate and update historical GDP
        function recalculateHistoricalGDP() {
            const result = calculateHistoricalGDP();

            // Update UI
            const gdpValueEl = document.getElementById('historicalGDPValue');
            const gdpCountEl = document.getElementById('historicalGDPCount');
            const configGDPEl = document.getElementById('configGDP');

            if (gdpValueEl) gdpValueEl.textContent = result.avgGDP.toFixed(2) + ' kg/d√≠a';
            if (gdpCountEl) gdpCountEl.textContent = result.count + ' ventas';

            // Update config GDP if we have sales data
            if (result.count > 0) {
                data.config.gdp = parseFloat(result.avgGDP.toFixed(2));
                data.config.historicalGDPCount = result.count;
                if (configGDPEl) configGDPEl.value = result.avgGDP.toFixed(2);
                saveData();
                showToast(`üìä GDP actualizado: ${result.avgGDP.toFixed(2)} kg/d√≠a (basado en ${result.count} ventas)`, 'success');
            } else {
                showToast('‚ö†Ô∏è No hay suficientes datos de ventas para calcular GDP hist√≥rico', 'info');
            }

            return result;
        }

        // Update historical GDP display on settings page load
        function updateHistoricalGDPDisplay() {
            const result = calculateHistoricalGDP();
            const gdpValueEl = document.getElementById('historicalGDPValue');
            const gdpCountEl = document.getElementById('historicalGDPCount');

            if (gdpValueEl) gdpValueEl.textContent = result.count > 0 ? result.avgGDP.toFixed(2) + ' kg/d√≠a' : '-- kg/d√≠a';
            if (gdpCountEl) gdpCountEl.textContent = result.count > 0 ? result.count + ' ventas' : 'Sin datos';
        }

        function loadData() {
            const ranch = RANCHES[currentRanch];
            const saved = localStorage.getItem(ranch.storageKey);
            if (saved) {
                data = JSON.parse(saved);
                // Ensure all arrays exist
                if (!data.entradas) data.entradas = [];
                if (!data.salidas) data.salidas = [];
                if (!data.saludEventos) data.saludEventos = [];
                if (!data.potreros) data.potreros = [];
                if (!data.rotaciones) data.rotaciones = [];
                if (!data.animalPotreros) data.animalPotreros = {};
                if (!data.weatherHistory) data.weatherHistory = [];
                if (!data.pesoUpdates) data.pesoUpdates = [];
                if (!data.fotoSesiones) data.fotoSesiones = [];

                // Breeding-specific arrays (for San Fernando)
                if (!data.servicios) data.servicios = [];           // Breeding events
                if (!data.diagnosticos) data.diagnosticos = [];     // Pregnancy checks
                if (!data.toros) data.toros = [];                   // Bulls registry
                if (!data.semenInventario) data.semenInventario = []; // AI semen inventory

                // Ensure config has all fields including new weather-related fields
                if (!data.config) data.config = {};
                if (!data.config.fotoIntervalo) data.config.fotoIntervalo = 90;
                if (!data.config.gdpByWeather) {
                    data.config.gdpByWeather = {
                        'lluvias_fuertes': 0.22,
                        'lluvias': 0.36,
                        'veranillo': 0.42,
                        'seco': 0.30
                    };
                }
                if (!data.config.currentWeather) data.config.currentWeather = 'lluvias';
                if (!data.config.gdp) data.config.gdp = data.config.gdpByWeather[data.config.currentWeather];
                if (!data.config.precioVenta) data.config.precioVenta = 9000;
                if (!data.config.pesoObjetivo) data.config.pesoObjetivo = 450;
                if (!data.config.pesoMinimo) data.config.pesoMinimo = 380;
            } else {
                // Initialize with empty data for this ranch
                data = {
                    entradas: [],
                    salidas: [],
                    saludEventos: [],
                    potreros: [],
                    rotaciones: [],
                    animalPotreros: {},
                    weatherHistory: [],
                    // Breeding-specific arrays (for San Fernando)
                    servicios: [],
                    diagnosticos: [],
                    toros: [],
                    semenInventario: [],
                    config: {
                        gdp: 0.31,
                        precioVenta: 9000,
                        pesoObjetivo: 450,
                        pesoMinimo: 380,
                        fotoIntervalo: 90,
                        currentWeather: 'lluvias',
                        gdpByWeather: {
                            'lluvias_fuertes': 0.22,
                            'lluvias': 0.36,
                            'veranillo': 0.42,
                            'seco': 0.30
                        }
                    }
                };
            }
        }
        
        // Generate simulated data for San Fernando testing
        function generateSanFernandoTestData() {
            if (currentRanch !== 'san_fernando') {
                showNotification('Esta funci√≥n solo est√° disponible para San Fernando', 'error');
                return;
            }

            if (!confirm('¬øGenerar datos de prueba para San Fernando?\n\nEsto crear√°:\n- 120 vacas\n- 6 toros\n- 70 cr√≠as (reci√©n nacidas a ~11 meses)\n- Servicios y diagn√≥sticos simulados\n\n¬øContinuar?')) {
                return;
            }

            const razas = ['Brahman', 'Gyr', 'Brahman x Gyr', 'Nelore', 'Guzerat'];
            const toroNombres = ['Emperador', 'Tit√°n', 'Rel√°mpago', 'Dominante', 'Campe√≥n', 'Guerrero'];
            const now = new Date();

            // Clear existing data for fresh start
            data.entradas = [];
            data.inventario = [];
            data.toros = [];
            data.servicios = [];
            data.diagnosticos = [];

            // Generate 6 bulls
            for (let i = 1; i <= 6; i++) {
                const toroNumero = `T-${String(i).padStart(2, '0')}`;
                const birthDate = new Date(now);
                birthDate.setFullYear(birthDate.getFullYear() - (3 + Math.floor(Math.random() * 3))); // 3-5 years old

                data.toros.push({
                    numero: toroNumero,
                    nombre: toroNombres[i - 1],
                    raza: razas[Math.floor(Math.random() * razas.length)],
                    fechaNacimiento: birthDate.toISOString().split('T')[0],
                    peso: 700 + Math.floor(Math.random() * 200),
                    estado: 'activo',
                    observaciones: ''
                });

                // Also add to entradas/inventario
                data.entradas.push({
                    numero: toroNumero,
                    fechaEntrada: birthDate.toISOString().split('T')[0],
                    tipoEntrada: 'compra',
                    sexo: 'MACHO',
                    raza: razas[Math.floor(Math.random() * razas.length)],
                    peso: 400,
                    precioKilo: 8000,
                    vendedor: 'Hacienda El Roble',
                    lote: 'TOROS',
                    observaciones: `Toro reproductor - ${toroNombres[i - 1]}`
                });
            }

            // Generate 120 cows
            const cowNumbers = [];
            for (let i = 1; i <= 120; i++) {
                const cowNumero = String(100 + i);
                cowNumbers.push(cowNumero);

                const entryDate = new Date(now);
                entryDate.setMonth(entryDate.getMonth() - (12 + Math.floor(Math.random() * 24))); // 1-3 years ago

                data.entradas.push({
                    numero: cowNumero,
                    fechaEntrada: entryDate.toISOString().split('T')[0],
                    tipoEntrada: 'compra',
                    sexo: 'HEMBRA',
                    raza: razas[Math.floor(Math.random() * razas.length)],
                    peso: 280 + Math.floor(Math.random() * 80),
                    precioKilo: 7500,
                    vendedor: 'Subasta Ganadera',
                    lote: `LOTE-${Math.ceil(i / 30)}`,
                    observaciones: ''
                });
            }

            // Select 70 cows to have calves (mothers)
            const mothersWithCalves = cowNumbers.slice(0, 70);
            let calfCounter = 1;

            mothersWithCalves.forEach((motherNumero, index) => {
                // Distribute calves across age groups:
                // 20 newborns (0-2 months)
                // 20 young (2-5 months)
                // 15 ready for weaning (6-8 months)
                // 15 older (9-11 months, some weaned)

                let ageInDays;
                let isWeaned = false;

                if (index < 20) {
                    // Newborns: 0-60 days
                    ageInDays = Math.floor(Math.random() * 60);
                } else if (index < 40) {
                    // Young: 60-150 days
                    ageInDays = 60 + Math.floor(Math.random() * 90);
                } else if (index < 55) {
                    // Ready for weaning: 180-240 days
                    ageInDays = 180 + Math.floor(Math.random() * 60);
                } else {
                    // Older: 270-330 days (some weaned)
                    ageInDays = 270 + Math.floor(Math.random() * 60);
                    isWeaned = Math.random() > 0.4; // 60% chance of being weaned
                }

                const birthDate = new Date(now);
                birthDate.setDate(birthDate.getDate() - ageInDays);

                const calfNumero = `C-${String(calfCounter).padStart(3, '0')}`;
                const isMale = Math.random() > 0.5;
                const birthWeight = 28 + Math.floor(Math.random() * 10);

                const calfEntry = {
                    numero: calfNumero,
                    fechaEntrada: birthDate.toISOString().split('T')[0],
                    tipoEntrada: 'nacimiento',
                    sexo: isMale ? 'MACHO' : 'HEMBRA',
                    raza: razas[Math.floor(Math.random() * razas.length)],
                    peso: birthWeight,
                    precioKilo: 0,
                    vendedor: '',
                    numeroVaca: motherNumero, // Link to mother
                    lote: 'CRIAS',
                    observaciones: `Cr√≠a de vaca #${motherNumero}`
                };

                // Add weaning data for weaned calves
                if (isWeaned) {
                    const weaningDate = new Date(birthDate);
                    weaningDate.setDate(weaningDate.getDate() + 210 + Math.floor(Math.random() * 30));
                    calfEntry.fechaDestete = weaningDate.toISOString().split('T')[0];
                    calfEntry.pesoDestete = 160 + Math.floor(Math.random() * 40);
                }

                data.entradas.push(calfEntry);

                // Create service record for the mother (9 months + calf age before birth)
                const serviceDate = new Date(birthDate);
                serviceDate.setDate(serviceDate.getDate() - 283); // Gestation period

                const toroUsed = data.toros[Math.floor(Math.random() * data.toros.length)];
                const isAI = Math.random() > 0.7; // 30% AI

                data.servicios.push({
                    id: `srv_${Date.now()}_${index}`,
                    vacaNumero: motherNumero,
                    fecha: serviceDate.toISOString().split('T')[0],
                    tipo: isAI ? 'inseminacion' : 'monta_natural',
                    toroNumero: isAI ? null : toroUsed.numero,
                    semenId: isAI ? `SEM-${Math.floor(Math.random() * 100)}` : null,
                    tecnico: isAI ? 'Dr. Rodr√≠guez' : null,
                    observaciones: '',
                    fechaEsperadaParto: birthDate.toISOString().split('T')[0]
                });

                // Create pregnancy diagnosis record
                const diagDate = new Date(serviceDate);
                diagDate.setDate(diagDate.getDate() + 60 + Math.floor(Math.random() * 30));

                data.diagnosticos.push({
                    id: `diag_${Date.now()}_${index}`,
                    vacaNumero: motherNumero,
                    fecha: diagDate.toISOString().split('T')[0],
                    resultado: 'prenada',
                    diasGestacion: 60 + Math.floor(Math.random() * 30),
                    metodo: Math.random() > 0.5 ? 'palpacion' : 'ecografia',
                    veterinario: 'Dr. Mart√≠nez',
                    observaciones: ''
                });

                calfCounter++;
            });

            // Add some services for cows without calves yet (pending pregnancy checks)
            const cowsWithoutCalves = cowNumbers.slice(70, 90);
            cowsWithoutCalves.forEach((cowNumero, index) => {
                const serviceDate = new Date(now);
                serviceDate.setDate(serviceDate.getDate() - (30 + Math.floor(Math.random() * 60)));

                const toroUsed = data.toros[Math.floor(Math.random() * data.toros.length)];

                data.servicios.push({
                    id: `srv_pending_${Date.now()}_${index}`,
                    vacaNumero: cowNumero,
                    fecha: serviceDate.toISOString().split('T')[0],
                    tipo: 'monta_natural',
                    toroNumero: toroUsed.numero,
                    semenId: null,
                    tecnico: null,
                    observaciones: 'Pendiente diagn√≥stico',
                    fechaEsperadaParto: new Date(serviceDate.getTime() + 283 * 24 * 60 * 60 * 1000).toISOString().split('T')[0]
                });
            });

            // Rebuild inventario from entradas
            data.inventario = data.entradas.filter(e => {
                const salida = data.salidas.find(s => s.numero === e.numero);
                return !salida;
            });

            saveData();
            updateAllViews();
            showNotification('‚úÖ Datos de prueba generados: 120 vacas, 6 toros, 70 cr√≠as', 'success');
        }

        // Clear San Fernando test data
        function clearSanFernandoTestData() {
            if (currentRanch !== 'san_fernando') {
                showNotification('Esta funci√≥n solo est√° disponible para San Fernando', 'error');
                return;
            }

            if (!confirm('¬øEliminar TODOS los datos de San Fernando?\n\nEsta acci√≥n no se puede deshacer.')) {
                return;
            }

            data = {
                entradas: [],
                salidas: [],
                inventario: [],
                saludEventos: [],
                potreros: [],
                rotaciones: [],
                animalPotreros: {},
                weatherHistory: [],
                servicios: [],
                diagnosticos: [],
                toros: [],
                semenInventario: [],
                config: {
                    gdp: 0.31,
                    precioVenta: 9000,
                    pesoObjetivo: 450,
                    pesoMinimo: 380,
                    fotoIntervalo: 90,
                    currentWeather: 'lluvias',
                    gdpByWeather: {
                        'lluvias_fuertes': 0.22,
                        'lluvias': 0.36,
                        'veranillo': 0.42,
                        'seco': 0.30
                    }
                }
            };

            saveData();
            updateAllViews();
            showNotification('‚úÖ Datos de San Fernando eliminados', 'success');
        }

        function saveData() {
            const ranch = RANCHES[currentRanch];
            localStorage.setItem(ranch.storageKey, JSON.stringify(data));

            // üîÑ Trigger immediate cloud sync
            if (window.cloudSync && window.cloudSync.enabled) {
                window.cloudSync.syncToCloud().catch(err => console.error('Cloud sync error:', err));
            }
            
            updateAllViews();
        }
        
        // ==================== TAB NAVIGATION ====================
        function initTabs() {
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabId = this.dataset.tab;

                    document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

                    this.classList.add('active');
                    document.getElementById('tab-' + tabId).classList.add('active');

                    // Update historical GDP display when config tab is shown
                    if (tabId === 'config') {
                        updateHistoricalGDPDisplay();
                    }
                });
            });
        }
        
        // ==================== SORTABLE TABLES ====================
        function initSortableHeaders() {
            // Inventario table
            document.querySelectorAll('#inventarioTableContainer th.sortable').forEach(th => {
                th.addEventListener('click', () => handleSort('inventario', th));
            });
            
            // Entradas table
            document.querySelectorAll('#entradasTableContainer th.sortable').forEach(th => {
                th.addEventListener('click', () => handleSort('entradas', th));
            });
            
            // Salidas table
            document.querySelectorAll('#salidasTableContainer th.sortable').forEach(th => {
                th.addEventListener('click', () => handleSort('salidas', th));
            });
            
            // Vendedores table
            document.querySelectorAll('#vendedoresTableContainer th.sortable').forEach(th => {
                th.addEventListener('click', () => handleSort('vendedores', th));
            });
            
            // Compradores table
            document.querySelectorAll('#compradoresTableContainer th.sortable').forEach(th => {
                th.addEventListener('click', () => handleSort('compradores', th));
            });
            
            // Foto historial table
        }
        
        function handleSort(tableId, th) {
            const column = th.dataset.sort;
            const type = th.dataset.type;
            const table = th.closest('table');
            
            // Toggle direction
            if (sortState[tableId].column === column) {
                sortState[tableId].direction = sortState[tableId].direction === 'asc' ? 'desc' : 'asc';
            } else {
                sortState[tableId].column = column;
                sortState[tableId].direction = 'asc';
            }
            
            // Update header classes
            table.querySelectorAll('th.sortable').forEach(header => {
                header.classList.remove('asc', 'desc');
            });
            th.classList.add(sortState[tableId].direction);
            
            // Re-render the appropriate table
            switch(tableId) {
                case 'inventario':
                    updateInventarioTable();
                    break;
                case 'entradas':
                    updateEntradasTable();
                    break;
                case 'salidas':
                    updateSalidasTable();
                    break;
                case 'vendedores':
                case 'compradores':
                    updateReports();
                    break;
                case 'fotoSesiones':
                    updateFotoHistorial();
                    break;
            }
        }
        
        function sortData(dataArray, column, direction, type, tableId) {
            return [...dataArray].sort((a, b) => {
                let valA, valB;
                
                // Handle special computed columns
                if (tableId === 'inventario') {
                    if (column === 'diasEnFinca') {
                        valA = getDiasEnFinca(a.fechaEntrada);
                        valB = getDiasEnFinca(b.fechaEntrada);
                    } else if (column === 'pesoEstimado') {
                        // Females go to bottom when sorting by estimated weight
                        valA = a.sexo === 'HEMBRA' ? -1 : a.peso + (getDiasEnFinca(a.fechaEntrada) * data.config.gdp);
                        valB = b.sexo === 'HEMBRA' ? -1 : b.peso + (getDiasEnFinca(b.fechaEntrada) * data.config.gdp);
                    } else {
                        valA = a[column];
                        valB = b[column];
                    }
                } else if (tableId === 'entradas') {
                    if (column === 'tipo') {
                        valA = a.numeroVaca ? 'nacimiento' : 'compra';
                        valB = b.numeroVaca ? 'nacimiento' : 'compra';
                    } else if (column === 'estado') {
                        valA = isAnimalSold(a.numero) ? 'vendido' : 'en finca';
                        valB = isAnimalSold(b.numero) ? 'vendido' : 'en finca';
                    } else {
                        valA = a[column];
                        valB = b[column];
                    }
                } else if (tableId === 'salidas') {
                    if (column === 'tipo') {
                        // Determine tipo from comprador field
                        valA = a.comprador === 'MUERTE' ? 'muerte' : 'venta';
                        valB = b.comprador === 'MUERTE' ? 'muerte' : 'venta';
                        // For tipo, treat as text comparison
                        type = 'text';
                    } else {
                        valA = a[column];
                        valB = b[column];
                    }
                } else {
                    valA = a[column];
                    valB = b[column];
                }
                
                // Handle null/undefined values
                if (valA == null) valA = type === 'number' ? 0 : '';
                if (valB == null) valB = type === 'number' ? 0 : '';
                
                // Compare based on type
                let comparison = 0;
                if (type === 'number') {
                    const numA = parseFloat(valA);
                    const numB = parseFloat(valB);
                    comparison = numA - numB;
                } else if (type === 'date') {
                    const dateA = new Date(valA);
                    const dateB = new Date(valB);
                    comparison = dateA - dateB;
                } else {
                    // Text comparison (case-insensitive for Spanish)
                    comparison = String(valA).toLowerCase().localeCompare(String(valB).toLowerCase(), 'es');
                }
                
                return direction === 'asc' ? comparison : -comparison;
            });
        }
        
        // ==================== EVENT FORMS ====================
        function initForms() {
            // Note: With lote-based workflows, calculations happen when adding animals
            // These listeners are kept for backward compatibility but check if elements exist
            
            const compraPrecioKilo = document.getElementById('compraPrecioKilo');
            
            if (compraPrecioKilo) compraPrecioKilo.addEventListener('input', updateLotePrecioHint);
            
            // Venta is now lote-based, no individual calculation needed
        }
        
        
        function calcVentaTotal() {
            // Not used in lote-based venta workflow
        }
        
        function showEventForm(type) {
            // Hide all forms first
            document.querySelectorAll('[id^="form-"]').forEach(f => f.style.display = 'none');
            
            // Show selected form
            document.getElementById('form-' + type).style.display = 'block';
            
            // Populate datalists
            updateDataLists();
            
            // Type-specific initialization
            if (type === 'compra') {
                initCompraForm();
            } else if (type === 'venta') {
                initVentaForm();
            } else if (type === 'muerte') {
                populateAnimalSelector('muerteAnimalSelector', 'muerteNumero');
            } else if (type === 'nacimiento') {
                // Suggest next consecutive chapeta for nacimiento
                const nextChapeta = getNextConsecutiveChapeta();
                const hintElement = document.getElementById('nacimientoChapetaHint');
                if (hintElement) {
                    hintElement.innerHTML = `Siguiente sugerido: <strong>${nextChapeta}</strong> <button type="button" class="btn" style="padding: 0.1rem 0.5rem; font-size: 0.75rem;" onclick="useNextChapeta('nacimiento', '${nextChapeta}')">Usar</button>`;
                }
            }
        }
        
        function getNextConsecutiveChapeta() {
            // Get all chapeta numbers from entradas
            const allNumeros = data.entradas.map(e => {
                const num = parseInt(e.numero);
                return isNaN(num) ? 0 : num;
            }).filter(n => n > 0);
            
            if (allNumeros.length === 0) {
                return '1';
            }
            
            // Find the maximum and return next
            const maxNumero = Math.max(...allNumeros);
            return String(maxNumero + 1);
        }
        
        function useNextChapeta(type, chapeta) {
            document.getElementById(type + 'Numero').value = chapeta;
            // Focus on next field
            if (type === 'compra') {
                document.getElementById('compraLote').focus();
            } else if (type === 'nacimiento') {
                document.getElementById('nacimientoMadre').focus();
            }
        }
        
        function autoFillMotherRaza() {
            const madreNumero = document.getElementById('nacimientoMadre').value.trim();
            const hintElement = document.getElementById('razaMotherHint');
            
            if (!madreNumero) {
                hintElement.textContent = '';
                return;
            }
            
            // Find mother in entradas
            const madre = data.entradas.find(e => e.numero == madreNumero);
            
            if (madre && madre.raza) {
                document.getElementById('nacimientoRaza').value = madre.raza;
                hintElement.innerHTML = `<span style="color: var(--success);">‚úì Heredado de madre: ${madre.raza}</span>`;
            } else if (madre) {
                hintElement.innerHTML = `<span style="color: var(--gray);">Madre encontrada (sin raza registrada)</span>`;
            } else {
                hintElement.innerHTML = `<span style="color: var(--warning);">‚ö†Ô∏è Madre no encontrada en sistema</span>`;
            }
        }
        
        function updateLotePrecioHint() {
            const lote = document.getElementById('compraLote').value.trim();
            const hintElement = document.getElementById('lotePrecioHint');
            
            if (lote) {
                hintElement.innerHTML = `Este precio aplica a todos los animales del lote <strong>${lote}</strong>`;
            } else {
                hintElement.textContent = 'Este precio aplica a todos los animales del lote';
            }
        }
        
        function hideEventForm(type) {
            const formContainer = document.getElementById('form-' + type);
            if (formContainer) {
                formContainer.style.display = 'none';
            }
            
            const form = document.getElementById(type + 'Form');
            if (form) {
                form.reset();
            }
        }
        
        function updateDataLists() {
            // Vendedores
            const vendedores = [...new Set(data.entradas.filter(e => !e.numeroVaca).map(e => e.vendedor))];
            document.getElementById('vendedoresList').innerHTML = vendedores.map(v => `<option value="${v}">`).join('');
            
            // Compradores
            const compradores = [...new Set(data.salidas.filter(s => s.comprador !== 'MUERTE').map(s => s.comprador))];
            document.getElementById('compradoresList').innerHTML = compradores.map(c => `<option value="${c}">`).join('');
            
            // Vacas (hembras en inventario)
            const vacas = getInventario().filter(a => a.sexo === 'HEMBRA').map(a => a.numero);
            document.getElementById('vacasList').innerHTML = vacas.map(v => `<option value="${v}">`).join('');
        }
        
        function populateAnimalSelector(selectorId, hiddenInputId) {
            const inventario = getInventario();
            const selector = document.getElementById(selectorId);
            
            if (inventario.length === 0) {
                selector.innerHTML = '<div style="padding: 1rem; text-align: center; color: var(--gray);">No hay animales en inventario</div>';
                return;
            }
            
            selector.innerHTML = inventario.map(animal => {
                const diasEnFinca = getDiasEnFinca(animal.fechaEntrada);
                const pesoEstimado = (animal.peso + (diasEnFinca * data.config.gdp)).toFixed(0);
                return `
                    <div class="animal-option" data-numero="${animal.numero}" onclick="selectAnimal('${animal.numero}', '${selectorId}', '${hiddenInputId}')">
                        <div>
                            <strong>#${animal.numero}</strong> - ${animal.sexo === 'MACHO' ? '‚ôÇÔ∏è' : '‚ôÄÔ∏è'} ${animal.vendedor || 'Nacimiento'}
                        </div>
                        <div style="color: var(--gray); font-size: 0.85rem;">
                            ${pesoEstimado} kg est. | ${diasEnFinca} d√≠as
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function selectAnimal(numero, selectorId, hiddenInputId) {
            // Update hidden input
            document.getElementById(hiddenInputId).value = numero;
            
            // Visual selection
            document.querySelectorAll(`#${selectorId} .animal-option`).forEach(opt => {
                opt.classList.remove('selected');
            });
            document.querySelector(`#${selectorId} .animal-option[data-numero="${numero}"]`).classList.add('selected');
            
            // If it's venta, calculate GDP
            if (selectorId === 'ventaAnimalSelector') {
                const animal = getInventario().find(a => a.numero == numero);
                if (animal) {
                    const pesoEstimado = animal.peso + (getDiasEnFinca(animal.fechaEntrada) * data.config.gdp);
                    document.getElementById('ventaPeso').value = Math.round(pesoEstimado);
                    calcVentaTotal();
                }
            } else if (selectorId === 'muerteAnimalSelector') {
                const animal = getInventario().find(a => a.numero == numero);
                if (animal) {
                    const pesoEstimado = animal.peso + (getDiasEnFinca(animal.fechaEntrada) * data.config.gdp);
                    document.getElementById('muertePeso').value = Math.round(pesoEstimado);
                }
            }
        }
        
        function filterAnimalsForSale() {
            const search = document.getElementById('ventaSearch').value.toLowerCase();
            document.querySelectorAll('#ventaAnimalSelector .animal-option').forEach(opt => {
                const numero = opt.dataset.numero.toLowerCase();
                opt.style.display = numero.includes(search) ? '' : 'none';
            });
        }
        
        function filterAnimalsForDeath() {
            const search = document.getElementById('muerteSearch').value.toLowerCase();
            document.querySelectorAll('#muerteAnimalSelector .animal-option').forEach(opt => {
                const numero = opt.dataset.numero.toLowerCase();
                opt.style.display = numero.includes(search) ? '' : 'none';
            });
        }
        
        // ==================== CALCULATIONS ====================
        // Old calc functions removed - now using lote-based workflow
        
        function getDiasEnFinca(fechaEntrada) {
            // Handle Excel serial dates and other formats
            let fechaStr;
            
            // If it's a number (Excel serial), parse it first
            if (typeof fechaEntrada === 'number') {
                fechaStr = parseExcelDate(fechaEntrada);
            } else if (fechaEntrada instanceof Date) {
                fechaStr = fechaEntrada.toISOString().split('T')[0];
            } else {
                fechaStr = fechaEntrada;
            }
            
            const entrada = new Date(fechaStr);
            
            // Validate date
            if (isNaN(entrada.getTime())) {
                console.warn('Fecha entrada inv√°lida:', fechaEntrada);
                return 0;
            }
            
            const hoy = new Date();
            const dias = Math.floor((hoy - entrada) / (1000 * 60 * 60 * 24));
            
            // Return 0 if negative (future date)
            return dias >= 0 ? dias : 0;
        }
        
        // ==================== SAVE EVENTS ====================
        // ==================== LOTE-BASED COMPRA WORKFLOW ====================
        let currentLote = {
            numero: null,
            vendedor: null,
            precioKilo: null,
            fecha: null,
            cantidadEsperada: 0,
            animales: []
        };
        
        function getNextLoteNumber() {
            // Set minimum lote number based on ranch
            const minLotePorFinca = {
                santa_catalina: 59,
                la_coruna: 173,
                la_vega: 241
            };
            
            const minLote = minLotePorFinca[currentRanch] || 1;
            
            // Get all unique lote numbers that start with "L-"
            const loteNumbers = data.entradas
                .filter(e => e.lote && e.lote.startsWith('L-'))
                .map(e => parseInt(e.lote.replace('L-', '')))
                .filter(n => !isNaN(n));

            if (loteNumbers.length === 0) {
                return `L-${minLote}`;
            }

            const maxLote = Math.max(...loteNumbers);
            // Use the higher of maxLote+1 or minLote
            const nextLote = Math.max(maxLote + 1, minLote);
            return `L-${nextLote}`;
        }
        
        function initCompraForm() {
            // Reset to step 1
            document.getElementById('compraLoteInfo').style.display = 'block';
            document.getElementById('compraAnimalesSection').style.display = 'none';
            
            // Set next lote number
            const nextLote = getNextLoteNumber();
            document.getElementById('compraLote').value = nextLote;
            
            // Clear fields
            document.getElementById('compraVendedor').value = '';
            document.getElementById('compraPrecioKilo').value = '';
            document.getElementById('compraCantidadAnimales').value = '';
            
            // Reset current lote
            currentLote = {
                numero: nextLote,
                vendedor: null,
                precioKilo: null,
                fecha: null,
                cantidadEsperada: 0,
                animales: []
            };
        }
        
        function startLoteEntry() {
            const cantidadAnimales = parseInt(document.getElementById('compraCantidadAnimales').value);
            const vendedor = document.getElementById('compraVendedor').value.trim();
            const precioKilo = parseFloat(document.getElementById('compraPrecioKilo').value);
            const fecha = document.getElementById('compraFecha').value;
            
            if (!cantidadAnimales || cantidadAnimales < 1) {
                showToast('Ingrese la cantidad de animales', 'error');
                return;
            }
            if (!vendedor) {
                showToast('Ingrese el vendedor', 'error');
                return;
            }
            if (!precioKilo || precioKilo <= 0) {
                showToast('Ingrese el precio por kilo', 'error');
                return;
            }
            if (!fecha) {
                showToast('Ingrese la fecha de entrada', 'error');
                return;
            }
            
            // Store lote info
            currentLote.cantidadEsperada = cantidadAnimales;
            currentLote.vendedor = vendedor;
            currentLote.precioKilo = precioKilo;
            currentLote.fecha = fecha;
            
            // Update display
            document.getElementById('loteNumeroDisplay').textContent = currentLote.numero;
            document.getElementById('loteVendedorDisplay').textContent = vendedor;
            document.getElementById('lotePrecioDisplay').textContent = formatCurrency(precioKilo) + '/kg';
            document.getElementById('loteFechaDisplay').textContent = formatDate(fecha);
            
            // Show animals section
            document.getElementById('compraLoteInfo').style.display = 'none';
            document.getElementById('compraAnimalesSection').style.display = 'block';

            // Build bulk entry table
            buildBulkCompraTable(cantidadAnimales);

            updateLoteTable();
            updateLoteProgress();
        }

        function getNextChapetaNumber() {
            // Find the highest numeric chapeta number from all animals (active and sold)
            let maxNumber = 0;

            if (data.entradas && data.entradas.length > 0) {
                data.entradas.forEach(animal => {
                    const num = parseInt(animal.numero);
                    if (!isNaN(num) && num > maxNumber) {
                        maxNumber = num;
                    }
                });
            }

            return maxNumber + 1;
        }

        function buildBulkCompraTable(count) {
            const tbody = document.getElementById('compraAnimalesBulkTable');
            if (!tbody) return;

            if (!count || count < 1) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center" style="color: var(--gray);">Completa el paso 1 para crear la tabla</td></tr>';
                return;
            }

            // Get the next consecutive chapeta number
            const startingNumber = getNextChapetaNumber();

            tbody.innerHTML = Array.from({ length: count }).map((_, index) => `
                <tr>
                    <td class="text-center">${index + 1}</td>
                    <td><input type="text" class="form-input" data-field="numero" value="${startingNumber + index}" placeholder="ej: 301"></td>
                    <td>
                        <select class="form-select" data-field="raza">
                            <option value="">Seleccionar</option>
                            <option value="Ceb√∫">Ceb√∫</option>
                            <option value="Razuno">Razuno</option>
                            <option value="Brangus">Brangus</option>
                            <option value="Ceb√∫/Europeo">Ceb√∫/Europeo</option>
                            <option value="Simbra">Simbra</option>
                            <option value="Brahman">Brahman</option>
                            <option value="Angus">Angus</option>
                            <option value="Otra">Otra</option>
                        </select>
                    </td>
                    <td>
                        <select class="form-select" data-field="sexo">
                            <option value="">Seleccionar</option>
                            <option value="MACHO" selected>MACHO</option>
                            <option value="HEMBRA">HEMBRA</option>
                        </select>
                    </td>
                    <td><input type="number" class="form-input text-right" data-field="peso" min="1" step="0.1" placeholder="ej: 420"></td>
                </tr>
            `).join('');
        }

        function resetBulkCompraTable() {
            const count = currentLote.cantidadEsperada || parseInt(document.getElementById('compraCantidadAnimales').value) || 0;
            buildBulkCompraTable(count);
        }

        function confirmBulkCompraAnimales() {
            const tbody = document.getElementById('compraAnimalesBulkTable');
            if (!tbody) return;

            const rows = [...tbody.querySelectorAll('tr')];
            if (!rows.length) {
                showToast('Complete el paso 1 para generar la tabla', 'warning');
                return;
            }

            const animales = [];
            const numerosSet = new Set();

            for (const row of rows) {
                const numero = row.querySelector('[data-field="numero"]')?.value.trim();
                const raza = row.querySelector('[data-field="raza"]')?.value;
                const sexo = row.querySelector('[data-field="sexo"]')?.value;
                const peso = parseFloat(row.querySelector('[data-field="peso"]')?.value);

                if (!numero || !raza || !sexo || !peso || peso <= 0) {
                    showToast('Complete todos los campos obligatorios', 'error');
                    return;
                }

                if (numerosSet.has(numero)) {
                    showToast(`Chapeta duplicada en la tabla: ${numero}`, 'error');
                    return;
                }
                numerosSet.add(numero);

                if (data.entradas.some(e => e.numero == numero && !isAnimalSold(e.numero))) {
                    showToast(`La chapeta ${numero} ya existe en inventario`, 'error');
                    return;
                }

                animales.push({ numero, raza, sexo, peso });
            }

            currentLote.animales = animales.map(animal => ({
                numero: animal.numero,
                raza: animal.raza,
                sexo: animal.sexo,
                peso: animal.peso,
                costoTotal: animal.peso * currentLote.precioKilo
            }));

            updateLoteTable();
            updateLoteProgress();
            showToast(`‚úÖ ${animales.length} animales agregados al lote`, 'success');
        }
        
        function updateLoteProgress() {
            const current = currentLote.animales.length;
            const expected = currentLote.cantidadEsperada;
            const remaining = expected - current;
            const percentage = expected > 0 ? (current / expected) * 100 : 0;
            
            // Update progress text and bar
            document.getElementById('loteProgressText').textContent = `${current} de ${expected}`;
            document.getElementById('loteProgressBar').style.width = `${Math.min(percentage, 100)}%`;
            const remainingSpan = document.getElementById('animalCountRemaining');
            if (remainingSpan) {
                remainingSpan.textContent = remaining;
            }
            
            // Update progress status badge
            const statusBadge = document.getElementById('loteProgressStatus');
            const finalizarBtn = document.getElementById('btnFinalizarLote');
            const warningDiv = document.getElementById('finalizarLoteWarning');
            const addBtn = document.getElementById('btnAddAnimal');
            
            if (current === expected) {
                // Exact count reached
                statusBadge.className = 'badge badge-success';
                statusBadge.textContent = '‚úÖ Completo';
                finalizarBtn.disabled = false;
                if (addBtn) {
                    addBtn.disabled = true;
                    addBtn.textContent = '‚úÖ Lote completo';
                }
                warningDiv.style.display = 'none';
                document.getElementById('loteProgressBar').style.background = 'var(--success)';
            } else if (current > expected) {
                // Too many (shouldn't happen)
                statusBadge.className = 'badge badge-danger';
                statusBadge.textContent = '‚ö†Ô∏è Excedido';
                finalizarBtn.disabled = true;
                warningDiv.style.display = 'block';
                document.getElementById('finalizarWarningText').textContent = `Hay ${current - expected} animal(es) de m√°s. Elimine para continuar.`;
            } else {
                // Still adding
                statusBadge.className = 'badge badge-warning';
                statusBadge.textContent = 'En progreso';
                finalizarBtn.disabled = true;
                if (addBtn) {
                    addBtn.disabled = false;
                    addBtn.innerHTML = `‚ûï Agregar Animal (<span id="animalCountRemaining">${remaining}</span> restantes)`;
                }
                if (remainingSpan) {
                    remainingSpan.textContent = remaining;
                }
                warningDiv.style.display = 'block';
                document.getElementById('finalizarWarningText').textContent = `Faltan ${remaining} animal(es) para completar el lote`;
                document.getElementById('loteProgressBar').style.background = 'var(--primary)';
            }
        }
        
        
        function updateLoteTable() {
            const tbody = document.getElementById('loteAnimalesTable');
            const count = document.getElementById('loteAnimalCount');
            const totalKg = document.getElementById('loteTotalKg');
            const totalCosto = document.getElementById('loteTotalCosto');
            
            if (currentLote.animales.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center" style="color: var(--gray);">A√∫n no hay animales en este lote</td></tr>';
                count.textContent = '0';
                totalKg.textContent = '0';
                totalCosto.textContent = '$0';
                return;
            }
            
            const sumKg = currentLote.animales.reduce((sum, a) => sum + a.peso, 0);
            const sumCosto = currentLote.animales.reduce((sum, a) => sum + a.costoTotal, 0);
            
            count.textContent = currentLote.animales.length;
            totalKg.textContent = formatNumber(sumKg);
            totalCosto.textContent = formatCurrency(sumCosto);
            
            tbody.innerHTML = currentLote.animales.map((animal, index) => `
                <tr>
                    <td>${index + 1}</td>
                    <td><strong>${animal.numero}</strong></td>
                    <td>${animal.raza}</td>
                    <td>${animal.sexo === 'MACHO' ? '‚ôÇÔ∏è' : '‚ôÄÔ∏è'}</td>
                    <td class="text-right">${animal.peso} kg</td>
                    <td class="text-right">${formatCurrency(animal.costoTotal)}</td>
                    <td class="text-center">
                        <button type="button" class="btn btn-danger" style="padding: 0.15rem 0.4rem; font-size: 0.75rem;" onclick="removeAnimalFromLote(${index})">‚úï</button>
                    </td>
                </tr>
            `).join('');
        }
        
        function removeAnimalFromLote(index) {
            const animal = currentLote.animales[index];
            currentLote.animales.splice(index, 1);
            updateLoteTable();
            updateLoteProgress();
            showToast(`Animal #${animal.numero} eliminado del lote`, 'warning');
        }
        
        function finalizarLote() {
            if (currentLote.animales.length !== currentLote.cantidadEsperada) {
                showToast(`Debe agregar exactamente ${currentLote.cantidadEsperada} animales`, 'error');
                return;
            }
            
            if (!confirm(`¬øFinalizar lote ${currentLote.numero} con ${currentLote.animales.length} animales?`)) {
                return;
            }
            
            // Save all animals to entradas
            currentLote.animales.forEach(animal => {
                const entrada = {
                    numero: animal.numero,
                    lote: currentLote.numero,
                    vendedor: currentLote.vendedor,
                    raza: animal.raza,
                    sexo: animal.sexo,
                    peso: animal.peso,
                    precioKilo: currentLote.precioKilo,
                    fechaEntrada: currentLote.fecha,
                    numeroVaca: null,
                    costoTotal: animal.costoTotal
                };
                data.entradas.push(entrada);
            });
            
            saveData();
            
            const totalKg = currentLote.animales.reduce((sum, a) => sum + a.peso, 0);
            const totalCosto = currentLote.animales.reduce((sum, a) => sum + a.costoTotal, 0);
            
            showToast(`‚úÖ Lote ${currentLote.numero} guardado: ${currentLote.animales.length} animales, ${formatNumber(totalKg)} kg, ${formatCurrency(totalCosto)}`, 'success');
            
            hideEventForm('compra');
        }
        
        function cancelarLote() {
            if (currentLote.animales.length > 0) {
                if (!confirm(`¬øCancelar lote? Se perder√°n ${currentLote.animales.length} animales sin guardar.`)) {
                    return;
                }
            }
            
            hideEventForm('compra');
        }
        
        function saveNacimiento(event) {
            event.preventDefault();
            saveNacimientoInternal(false);
        }
        
        function saveNacimientoAndContinue() {
            const form = document.getElementById('nacimientoForm');
            if (!form.reportValidity()) return;
            saveNacimientoInternal(true);
        }
        
        function saveNacimientoInternal(continueAdding) {
            const nacimiento = {
                numero: document.getElementById('nacimientoNumero').value.trim(),
                lote: document.getElementById('nacimientoLote').value.trim() || 'NAC',
                vendedor: 'Nacimiento',
                raza: document.getElementById('nacimientoRaza').value,
                sexo: document.getElementById('nacimientoSexo').value,
                peso: parseFloat(document.getElementById('nacimientoPeso').value) || 30,
                precioKilo: 0,
                fechaEntrada: document.getElementById('nacimientoFecha').value,
                numeroVaca: document.getElementById('nacimientoMadre').value.trim(),
                costoTotal: 0
            };
            
            // Check if chapeta already exists
            if (data.entradas.some(e => e.numero == nacimiento.numero && !isAnimalSold(e.numero))) {
                showToast('Ya existe un animal con ese n√∫mero de chapeta', 'error');
                return;
            }
            
            data.entradas.push(nacimiento);
            saveData();
            
            if (continueAdding) {
                // Keep lote and fecha - clear everything else
                const lote = document.getElementById('nacimientoLote').value;
                const fecha = document.getElementById('nacimientoFecha').value;
                
                document.getElementById('nacimientoForm').reset();
                
                // Restore data
                document.getElementById('nacimientoLote').value = lote;
                document.getElementById('nacimientoFecha').value = fecha;
                
                // Set next consecutive chapeta
                const nextChapeta = getNextConsecutiveChapeta();
                document.getElementById('nacimientoNumero').value = nextChapeta;
                document.getElementById('razaMotherHint').textContent = '';
                
                showToast(`‚úÖ Nacimiento #${nacimiento.numero} guardado. Siguiente: #${nextChapeta}`, 'success');
                document.getElementById('nacimientoMadre').focus();
            } else {
                showToast('Nacimiento registrado exitosamente', 'success');
                hideEventForm('nacimiento');
            }
        }
        
        // ==================== VENTA WORKFLOW (NO LOTES) ====================
        let currentVenta = {
            comprador: null,
            precioKilo: null,
            fecha: null,
            cantidadEsperada: 0,
            animales: [],
            transferenciaHacia: null // Ranch ID for inter-ranch transfers
        };
        
        function initVentaForm() {
            // Reset to step 1
            document.getElementById('ventaLoteInfo').style.display = 'block';
            document.getElementById('ventaAnimalesSection').style.display = 'none';
            
            // Clear fields
            document.getElementById('ventaComprador').value = '';
            document.getElementById('ventaPrecioKilo').value = '';
            document.getElementById('ventaCantidadAnimales').value = '';
            
            const checkboxEl = document.getElementById('ventaEsTransferencia');
            if (checkboxEl) checkboxEl.checked = false;
            
            // Populate destination ranch selector (only if element exists)
            populateDestinationRanches();
            
            // Reset transfer mode UI
            toggleTransferMode();
            
            // Reset current venta
            currentVenta = {
                comprador: null,
                precioKilo: null,
                fecha: null,
                cantidadEsperada: 0,
                animales: [],
                esTransferencia: false,
                fincaDestino: null
            };
        }
        
        function populateDestinationRanches() {
            const select = document.getElementById('ventaFincaDestino');
            if (!select) return; // Element might not exist yet
            
            // Get all ranches except current one
            select.innerHTML = '<option value="">-- Seleccionar finca --</option>' +
                Object.keys(RANCHES)
                    .filter(id => id !== currentRanch)
                    .map(id => {
                        const ranch = RANCHES[id];
                        return `<option value="${id}">${ranch.icon} ${ranch.name}</option>`;
                    })
                    .join('');
        }
        
        function toggleTransferMode() {
            const isTransfer = document.getElementById('ventaEsTransferencia').checked;
            const normalFields = document.getElementById('ventaNormalFields');
            const transferFields = document.getElementById('ventaTransferFields');
            
            if (isTransfer) {
                normalFields.style.display = 'none';
                transferFields.style.display = 'contents';
            } else {
                normalFields.style.display = 'contents';
                transferFields.style.display = 'none';
            }
        }
        
        function startVentaEntry() {
            const cantidadAnimales = parseInt(document.getElementById('ventaCantidadAnimales').value);
            const esTransferencia = document.getElementById('ventaEsTransferencia').checked;
            const fecha = document.getElementById('ventaFecha').value;
            
            if (!cantidadAnimales || cantidadAnimales < 1) {
                showToast('Ingrese la cantidad de animales a vender', 'error');
                return;
            }
            
            let comprador, precioKilo, fincaDestino;
            
            if (esTransferencia) {
                // Transfer mode validation
                fincaDestino = document.getElementById('ventaFincaDestino').value;
                precioKilo = parseFloat(document.getElementById('ventaPrecioTransfer').value) || 0;
                
                if (!fincaDestino) {
                    showToast('Seleccione la finca destino', 'error');
                    return;
                }
                
                comprador = `TRANSFERENCIA ‚Üí ${RANCHES[fincaDestino].name}`;
            } else {
                // Normal sale validation
                comprador = document.getElementById('ventaComprador').value.trim();
                precioKilo = parseFloat(document.getElementById('ventaPrecioKilo').value);
                
                if (!comprador) {
                    showToast('Ingrese el comprador', 'error');
                    return;
                }
                if (!precioKilo || precioKilo <= 0) {
                    showToast('Ingrese el precio por kilo', 'error');
                    return;
                }
            }
            
            if (!fecha) {
                showToast('Ingrese la fecha', 'error');
                return;
            }
            
            // Check if there are enough animals in inventory
            const inventarioCount = getInventario().length;
            if (cantidadAnimales > inventarioCount) {
                showToast(`Solo hay ${inventarioCount} animales en inventario`, 'error');
                return;
            }
            
            // Store venta info
            currentVenta.cantidadEsperada = cantidadAnimales;
            currentVenta.comprador = comprador;
            currentVenta.precioKilo = precioKilo;
            currentVenta.fecha = fecha;
            currentVenta.esTransferencia = esTransferencia;
            currentVenta.fincaDestino = fincaDestino || null;
            
            // Update display
            document.getElementById('ventaCompradorDisplay').textContent = comprador;
            document.getElementById('ventaPrecioDisplay').textContent = formatCurrency(precioKilo) + '/kg';
            document.getElementById('ventaFechaDisplay').textContent = formatDate(fecha);
            
            // Show animals section
            document.getElementById('ventaLoteInfo').style.display = 'none';
            document.getElementById('ventaAnimalesSection').style.display = 'block';
            
            // Populate available animals
            populateVentaAnimalSelector();
            updateVentaTable();
            updateVentaProgress();
        }
        
        function updateVentaProgress() {
            const current = currentVenta.animales.length;
            const expected = currentVenta.cantidadEsperada;
            const remaining = expected - current;
            const percentage = expected > 0 ? (current / expected) * 100 : 0;
            
            // Update progress text and bar
            document.getElementById('ventaProgressText').textContent = `${current} de ${expected}`;
            document.getElementById('ventaProgressBar').style.width = `${Math.min(percentage, 100)}%`;
            document.getElementById('ventaAnimalCountRemaining').textContent = remaining;
            
            // Update progress status badge
            const statusBadge = document.getElementById('ventaProgressStatus');
            const finalizarBtn = document.getElementById('btnFinalizarVenta');
            const addBtn = document.getElementById('btnAddAnimalVenta');
            const warningDiv = document.getElementById('finalizarVentaWarning');
            const selectorContainer = document.getElementById('ventaAnimalSelectorContainer');
            
            if (current === expected) {
                // Exact count reached
                statusBadge.className = 'badge badge-success';
                statusBadge.textContent = '‚úÖ Completo';
                finalizarBtn.disabled = false;
                if (addBtn) addBtn.disabled = true;
                warningDiv.style.display = 'none';
                selectorContainer.style.display = 'none';
                document.getElementById('ventaAnimalSelectorLote').style.display = 'none';
                document.getElementById('ventaAddAnimalForm').style.display = 'none';
                document.getElementById('ventaProgressBar').style.background = 'var(--success)';
            } else if (current > expected) {
                // Too many (shouldn't happen)
                statusBadge.className = 'badge badge-danger';
                statusBadge.textContent = '‚ö†Ô∏è Excedido';
                finalizarBtn.disabled = true;
                warningDiv.style.display = 'block';
                document.getElementById('finalizarVentaWarningText').textContent = `Hay ${current - expected} animal(es) de m√°s. Elimine para continuar.`;
            } else {
                // Still adding
                statusBadge.className = 'badge badge-warning';
                statusBadge.textContent = 'En progreso';
                finalizarBtn.disabled = true;
                if (addBtn) addBtn.disabled = false;
                selectorContainer.style.display = 'block';
                document.getElementById('ventaAnimalSelectorLote').style.display = 'block';
                warningDiv.style.display = 'block';
                document.getElementById('finalizarVentaWarningText').textContent = `Faltan ${remaining} animal(es) para completar la venta`;
                document.getElementById('ventaProgressBar').style.background = 'var(--warning)';
            }
        }
        
        function populateVentaAnimalSelector() {
            const container = document.getElementById('ventaAnimalSelectorLote');
            const searchTerm = (document.getElementById('ventaSearchLote')?.value || '').toLowerCase();
            
            // Get inventory excluding animals already in current venta
            let inventario = getInventario().filter(a => 
                !currentVenta.animales.some(v => v.numero == a.numero)
            );
            
            // Filter by search term
            if (searchTerm) {
                inventario = inventario.filter(a => 
                    String(a.numero).toLowerCase().includes(searchTerm) ||
                    (a.lote || '').toLowerCase().includes(searchTerm) ||
                    (a.vendedor || '').toLowerCase().includes(searchTerm) ||
                    (a.raza || '').toLowerCase().includes(searchTerm)
                );
            }
            
            if (inventario.length === 0) {
                container.innerHTML = '<div style="padding: 1rem; text-align: center; color: var(--gray);">No hay animales disponibles</div>';
                return;
            }
            
            container.innerHTML = inventario.map(animal => {
                const diasEnFinca = getDiasEnFinca(animal.fechaEntrada);
                const pesoEstimado = animal.peso + (diasEnFinca * data.config.gdp);
                
                return `
                    <div class="animal-option" onclick="selectAnimalForVenta('${animal.numero}')">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong>#${animal.numero}</strong>
                                <span style="color: var(--gray); margin-left: 0.5rem;">${animal.lote || ''}</span>
                                <span style="margin-left: 0.5rem;">${animal.raza || ''}</span>
                            </div>
                            <div style="text-align: right;">
                                <div>${animal.sexo === 'MACHO' ? '‚ôÇÔ∏è' : '‚ôÄÔ∏è'} ${pesoEstimado.toFixed(0)} kg est.</div>
                                <div style="font-size: 0.8rem; color: var(--gray);">${diasEnFinca} d√≠as</div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function filterAnimalsForSaleLote() {
            populateVentaAnimalSelector();
        }
        
        // Check which ranch an animal belongs to
        function getAnimalOriginRanch(numero) {
            // Check all ranches for this animal
            for (const ranchId in RANCHES) {
                const ranch = RANCHES[ranchId];
                const ranchData = localStorage.getItem(ranch.storageKey);
                if (ranchData) {
                    const parsed = JSON.parse(ranchData);
                    if (parsed.entradas && parsed.entradas.some(e => e.numero == numero && !isAnimalSoldInRanch(numero, parsed))) {
                        return ranchId;
                    }
                }
            }
            return null;
        }
        
        function isAnimalSoldInRanch(numero, ranchData) {
            return ranchData.salidas && ranchData.salidas.some(s => s.numero == numero);
        }
        
        function selectAnimalForVenta(numero) {
            // Check if venta is already complete
            if (currentVenta.animales.length >= currentVenta.cantidadEsperada) {
                showToast('La venta ya est√° completa', 'warning');
                return;
            }
            
            // Check if animal belongs to a different ranch
            const originRanch = getAnimalOriginRanch(numero);
            if (originRanch && originRanch !== currentRanch) {
                showCrossRanchSaleWarning(numero, originRanch, () => {
                    // User confirmed, proceed with sale
                    selectAnimalForVentaInternal(numero, originRanch);
                });
                return;
            }
            
            // Same ranch or not found, proceed normally
            selectAnimalForVentaInternal(numero, null);
        }
        
        function showCrossRanchSaleWarning(numero, originRanchId, onConfirm) {
            const originRanchName = RANCHES[originRanchId].name;
            const currentRanchName = RANCHES[currentRanch].name;
            
            // Create warning modal
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 500px;">
                    <div class="modal-header" style="background: linear-gradient(135deg, #ff9800, #f57c00);">
                        <span>‚ö†Ô∏è Animal de Otra Finca</span>
                        <button class="modal-close" onclick="this.closest('.modal').remove()">√ó</button>
                    </div>
                    <div class="modal-body">
                        <div style="background: #fff3e0; padding: 1.5rem; border-radius: 8px; margin-bottom: 1rem; border-left: 4px solid #ff9800;">
                            <div style="font-size: 1.1rem; font-weight: 600; margin-bottom: 0.5rem;">
                                üè† El animal #${numero} pertenece a ${RANCHES[originRanchId].icon} ${originRanchName}
                            </div>
                            <div style="font-size: 0.95rem; color: #666;">
                                Est√°s en ${RANCHES[currentRanch].icon} ${currentRanchName}, pero este animal est√° registrado en otra finca.
                            </div>
                        </div>
                        
                        <div style="background: #e3f2fd; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border-left: 4px solid #2196f3;">
                            <strong>üìã ¬øQu√© significa esto?</strong>
                            <ul style="margin: 0.5rem 0 0 1.5rem; font-size: 0.9rem;">
                                <li>El animal se vender√° desde ${currentRanchName}</li>
                                <li>Se registrar√° como salida en ${originRanchName}</li>
                                <li>Se mantendr√° el registro del origen</li>
                            </ul>
                        </div>
                        
                        <div style="background: #f5f5f5; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">
                            <strong>‚úÖ ¬øDeseas proceder con la venta?</strong>
                            <p style="margin: 0.5rem 0 0 0; font-size: 0.9rem; color: #666;">
                                Se registrar√° autom√°ticamente en ambas fincas.
                            </p>
                        </div>
                        
                        <div style="display: flex; gap: 0.75rem;">
                            <button class="btn btn-warning" onclick="confirmCrossRanchSale()" style="flex: 1; color: #333;">
                                ‚úÖ S√≠, Proceder con la Venta
                            </button>
                            <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">
                                ‚ùå Cancelar
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Store callback for confirmation
            window.tempCrossRanchCallback = onConfirm;
        }
        
        function confirmCrossRanchSale() {
            if (window.tempCrossRanchCallback) {
                window.tempCrossRanchCallback();
                delete window.tempCrossRanchCallback;
            }
            document.querySelector('.modal.active')?.remove();
        }
        
        function selectAnimalForVentaInternal(numero, originRanchId) {
            const animal = getInventario().find(a => a.numero == numero);
            if (!animal) return;
            
            const diasEnFinca = getDiasEnFinca(animal.fechaEntrada);
            const pesoEstimado = animal.peso + (diasEnFinca * data.config.gdp);
            
            // Store selected animal with origin ranch info
            document.getElementById('ventaSelectedNumero').value = numero;
            if (originRanchId) {
                document.getElementById('ventaSelectedNumero').dataset.originRanch = originRanchId;
            }
            
            // Show add animal form
            document.getElementById('ventaAddAnimalForm').style.display = 'block';
            
            // Update info display with cross-ranch indicator
            const crossRanchLabel = originRanchId && originRanchId !== currentRanch ? 
                ` <span style="color: #ff9800;">‚ö†Ô∏è (${RANCHES[originRanchId].icon} ${RANCHES[originRanchId].name})</span>` : '';
            
            document.getElementById('ventaSelectedAnimalInfo').innerHTML = 
                `<span style="font-size: 1.1rem;">#${numero}</span> | ${animal.raza || '-'} | ${animal.sexo === 'MACHO' ? '‚ôÇÔ∏è' : '‚ôÄÔ∏è'} | Lote: ${animal.lote || '-'}${crossRanchLabel}`;
            
            // Pre-fill estimated weight
            document.getElementById('ventaPesoAnimal').value = Math.round(pesoEstimado);
            document.getElementById('ventaPesoEstimadoHint').textContent = `Peso entrada: ${animal.peso} kg | Estimado: ${pesoEstimado.toFixed(0)} kg | ${diasEnFinca} d√≠as`;
            
            // Update remaining count on button
            const remaining = currentVenta.cantidadEsperada - currentVenta.animales.length;
            document.getElementById('ventaAnimalCountRemaining').textContent = remaining;
            
            // Highlight selected
            document.querySelectorAll('#ventaAnimalSelectorLote .animal-option').forEach(opt => {
                opt.classList.remove('selected');
                if (opt.querySelector('strong')?.textContent === `#${numero}`) {
                    opt.classList.add('selected');
                }
            });
            
            document.getElementById('ventaPesoAnimal').focus();
        }

        function clearVentaSelection() {
            document.getElementById('ventaSelectedNumero').value = '';
            document.getElementById('ventaAddAnimalForm').style.display = 'none';
            document.querySelectorAll('#ventaAnimalSelectorLote .animal-option').forEach(opt => {
                opt.classList.remove('selected');
            });
        }
        
        function addAnimalToVenta() {
            // Check if venta is already complete
            if (currentVenta.animales.length >= currentVenta.cantidadEsperada) {
                showToast('La venta ya est√° completa', 'warning');
                return;
            }
            
            const numero = document.getElementById('ventaSelectedNumero').value;
            const pesoVenta = parseFloat(document.getElementById('ventaPesoAnimal').value);
            
            if (!numero) {
                showToast('Seleccione un animal', 'error');
                return;
            }
            if (!pesoVenta || pesoVenta <= 0) {
                showToast('Ingrese el peso de venta', 'error');
                return;
            }
            
            const animal = getInventario().find(a => a.numero == numero);
            if (!animal) {
                showToast('Animal no encontrado', 'error');
                return;
            }
            
            const diasEnFinca = getDiasEnFinca(animal.fechaEntrada);
            const gananciaKg = pesoVenta - animal.peso;
            
            // Add to current venta
            currentVenta.animales.push({
                numero: numero,
                loteCompra: animal.lote,
                raza: animal.raza,
                sexo: animal.sexo,
                pesoEntrada: animal.peso,
                pesoVenta: pesoVenta,
                gananciaKg: gananciaKg,
                diasEnFinca: diasEnFinca,
                gdp: diasEnFinca > 0 ? gananciaKg / diasEnFinca : 0,
                costoVenta: pesoVenta * currentVenta.precioKilo
            });
            
            // Update table and progress
            updateVentaTable();
            updateVentaProgress();
            
            // Clear selection and refresh available animals
            clearVentaSelection();
            populateVentaAnimalSelector();
            
            const remaining = currentVenta.cantidadEsperada - currentVenta.animales.length;
            
            if (remaining > 0) {
                showToast(`‚úÖ Animal #${numero} agregado (${remaining} restantes)`, 'success');
            } else {
                showToast(`‚úÖ Animal #${numero} agregado. ¬°Venta completa! Puede finalizar.`, 'success');
            }
        }
        
        function updateVentaTable() {
            const tbody = document.getElementById('ventaAnimalesTable');
            const count = document.getElementById('ventaAnimalCount');
            const totalKg = document.getElementById('ventaTotalKg');
            const totalVenta = document.getElementById('ventaTotalVenta');
            
            if (currentVenta.animales.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="text-center" style="color: var(--gray);">Selecciona animales del inventario</td></tr>';
                count.textContent = '0';
                totalKg.textContent = '0';
                totalVenta.textContent = '$0';
                return;
            }
            
            const sumKg = currentVenta.animales.reduce((sum, a) => sum + a.pesoVenta, 0);
            const sumVenta = currentVenta.animales.reduce((sum, a) => sum + a.costoVenta, 0);
            
            count.textContent = currentVenta.animales.length;
            totalKg.textContent = formatNumber(sumKg);
            totalVenta.textContent = formatCurrency(sumVenta);
            
            tbody.innerHTML = currentVenta.animales.map((animal, index) => `
                <tr>
                    <td>${index + 1}</td>
                    <td><strong>${animal.numero}</strong></td>
                    <td>${animal.loteCompra || '-'}</td>
                    <td>${animal.raza || '-'}</td>
                    <td class="text-right">${animal.pesoEntrada} kg</td>
                    <td class="text-right"><strong>${animal.pesoVenta} kg</strong></td>
                    <td class="text-right" style="color: ${animal.gananciaKg >= 0 ? 'var(--success)' : 'var(--danger)'};">
                        ${animal.gananciaKg >= 0 ? '+' : ''}${animal.gananciaKg.toFixed(1)} kg
                    </td>
                    <td class="text-right">${formatCurrency(animal.costoVenta)}</td>
                    <td class="text-center">
                        <button type="button" class="btn btn-danger" style="padding: 0.15rem 0.4rem; font-size: 0.75rem;" onclick="removeAnimalFromVenta(${index})">‚úï</button>
                    </td>
                </tr>
            `).join('');
        }
        
        function removeAnimalFromVenta(index) {
            const animal = currentVenta.animales[index];
            currentVenta.animales.splice(index, 1);
            updateVentaTable();
            updateVentaProgress();
            populateVentaAnimalSelector();
            showToast(`Animal #${animal.numero} eliminado de la venta`, 'warning');
        }
        
        function finalizarVenta() {
            if (currentVenta.animales.length !== currentVenta.cantidadEsperada) {
                showToast(`Debe seleccionar exactamente ${currentVenta.cantidadEsperada} animales`, 'error');
                return;
            }
            
            const esTransferencia = currentVenta.esTransferencia || false;
            const fincaDestino = currentVenta.fincaDestino;
            
            const confirmMsg = esTransferencia 
                ? `¬øFinalizar transferencia de ${currentVenta.animales.length} animales a ${RANCHES[fincaDestino].name}?`
                : `¬øFinalizar venta de ${currentVenta.animales.length} animales a ${currentVenta.comprador}?`;
            
            if (!confirm(confirmMsg)) {
                return;
            }
            
            // Save all animals to salidas in CURRENT ranch
            currentVenta.animales.forEach(animal => {
                const venta = {
                    numero: animal.numero,
                    peso: animal.pesoVenta,
                    fechaSalida: currentVenta.fecha,
                    precioKiloVenta: currentVenta.precioKilo,
                    comprador: esTransferencia ? `TRANSFERENCIA ‚Üí ${RANCHES[fincaDestino].name}` : currentVenta.comprador,
                    costoVenta: animal.costoVenta,
                    gananciaDay: animal.gdp,
                    esTransferencia: esTransferencia,
                    fincaDestino: esTransferencia ? fincaDestino : null
                };
                data.salidas.push(venta);
            });
            
            saveData();
            
            // If it's a transfer, create purchase entries in destination ranch
            if (esTransferencia && fincaDestino) {
                const destinoRanch = RANCHES[fincaDestino];
                const destinoData = JSON.parse(localStorage.getItem(destinoRanch.storageKey) || '{"entradas":[],"salidas":[],"config":{}}');
                
                if (!destinoData.entradas) destinoData.entradas = [];
                
                const precioTransfer = currentVenta.precioKilo || 0;
                
                currentVenta.animales.forEach(animal => {
                    // Find original animal data to get complete info
                    const originalAnimal = data.entradas.find(e => e.numero === animal.numero);
                    
                    const compra = {
                        numero: animal.numero,
                        lote: `TRANSFER-${currentRanch.toUpperCase()}-${new Date().getTime()}`,
                        vendedor: `Transferencia desde ${RANCHES[currentRanch].name}`,
                        raza: originalAnimal?.raza || animal.raza || 'No especificada',
                        sexo: originalAnimal?.sexo || animal.sexo || 'MACHO',
                        peso: animal.pesoVenta,
                        precioKilo: precioTransfer,
                        fechaEntrada: currentVenta.fecha,
                        numeroVaca: null,
                        costoTotal: animal.pesoVenta * precioTransfer,
                        esTransferencia: true,
                        fincaOrigen: currentRanch
                    };
                    
                    destinoData.entradas.push(compra);
                });
                
                // Save to destination ranch
                localStorage.setItem(destinoRanch.storageKey, JSON.stringify(destinoData));
            }
            
            const totalKg = currentVenta.animales.reduce((sum, a) => sum + a.pesoVenta, 0);
            const totalVenta = currentVenta.animales.reduce((sum, a) => sum + a.costoVenta, 0);
            
            const successMsg = esTransferencia
                ? `‚úÖ Transferencia completada: ${currentVenta.animales.length} animales a ${RANCHES[fincaDestino].name}, ${formatNumber(totalKg)} kg`
                : `‚úÖ Venta guardada: ${currentVenta.animales.length} animales, ${formatNumber(totalKg)} kg, ${formatCurrency(totalVenta)}`;
            
            showToast(successMsg, 'success');
            
            hideEventForm('venta');
        }
        
        function cancelarVenta() {
            if (currentVenta.animales.length > 0) {
                if (!confirm(`¬øCancelar venta? Se perder√°n ${currentVenta.animales.length} animales seleccionados.`)) {
                    return;
                }
            }
            
            hideEventForm('venta');
        }
        
        // Keep old function for backward compatibility (quick sale from inventory)
        function saveVenta(event) {
            event.preventDefault();
            // Redirect to new workflow
            showEventForm('venta');
        }
        
        function saveMuerte(event) {
            event.preventDefault();
            
            const numero = document.getElementById('muerteNumero').value;
            if (!numero) {
                showToast('Debe seleccionar un animal', 'error');
                return;
            }
            
            const animal = getInventario().find(a => a.numero == numero);
            
            const muerte = {
                numero: numero,
                peso: parseFloat(document.getElementById('muertePeso').value) || animal.peso,
                fechaSalida: document.getElementById('muerteFecha').value,
                precioKiloVenta: 0,
                comprador: 'MUERTE',
                costoVenta: animal.costoTotal || 0,
                gananciaDay: 0,
                causa: document.getElementById('muerteCausa').value.trim()
            };
            
            data.salidas.push(muerte);
            saveData();
            
            showToast('Muerte registrada', 'success');
            hideEventForm('muerte');
        }
        
        // ==================== INVENTORY HELPERS ====================
        function isAnimalSold(numero) {
            return data.salidas.some(s => s.numero == numero);
        }
        
        function getInventario() {
            return data.entradas.filter(e => !isAnimalSold(e.numero));
        }
        
        // ==================== UPDATE VIEWS ====================
        function updateAllViews() {
            updateSummary();
            updateHeader();
            updateInventarioTable();
            updateEntradasTable();
            updateSalidasTable();
            updateReports();
            updateRecentActivity();
            updateFilters();
            updateSaludView();
            updatePotrerosView();
            updateAIStats();
            updateAnimalPhotosGrid(); // Update animal photos grid
            refreshPerformanceAnalytics(); // Update performance analytics dashboard
            updateCriaTabVisibility(); // Show/hide Cr√≠a tab based on ranch
            if (currentRanch === 'san_fernando') updateCriaViews(); // Update breeding module
        }
        
        function updateSummary() {
            const inventario = getInventario();
            const machos = inventario.filter(a => a.sexo === 'MACHO').length;
            const hembras = inventario.filter(a => a.sexo === 'HEMBRA').length;
            
            let kgTotalInicial = 0;  // Initial purchase weight (matches Excel)
            let inversionTotal = 0;
            
            inventario.forEach(a => {
                kgTotalInicial += a.peso;  // Use initial weight, not estimated
                // Calculate cost as peso √ó precioKilo if costoTotal is missing
                const costo = a.costoTotal || (a.peso * a.precioKilo) || 0;
                inversionTotal += costo;
            });
            
            const kgPromedio = inventario.length > 0 ? kgTotalInicial / inventario.length : 0;
            
            document.getElementById('summaryTotal').textContent = inventario.length;
            document.getElementById('summaryMachos').textContent = machos;
            document.getElementById('summaryHembras').textContent = hembras;
            document.getElementById('summaryKgTotal').textContent = formatNumber(Math.round(kgTotalInicial));
            document.getElementById('summaryInversion').textContent = formatCurrency(inversionTotal);
            document.getElementById('summaryPrecioKg').textContent = kgTotalInicial > 0 ? formatCurrency(inversionTotal / kgTotalInicial) : '$0';
            document.getElementById('summaryKgPromedio').textContent = kgPromedio.toFixed(2);
        }
        
        function updateHeader() {
            const inventario = getInventario();
            let kgTotalInicial = 0;
            let inversionTotal = 0;
            
            inventario.forEach(a => {
                kgTotalInicial += a.peso;  // Initial weight
                const costo = a.costoTotal || (a.peso * a.precioKilo) || 0;
                inversionTotal += costo;
            });
            
            document.getElementById('headerTotalAnimals').textContent = inventario.length;
            document.getElementById('headerTotalKg').textContent = formatNumber(Math.round(kgTotalInicial));
            document.getElementById('headerTotalValue').textContent = formatCurrency(inversionTotal);
        }
        
        function updateInventarioTable() {
            let inventario = getInventario();
            const tbody = document.getElementById('inventarioTable');

            if (inventario.length === 0) {
                tbody.innerHTML = '<tr><td colspan="11" class="text-center">No hay animales en inventario</td></tr>';
                return;
            }

            // Apply sorting if active
            if (sortState.inventario.column) {
                const th = document.querySelector(`#inventarioTableContainer th[data-sort="${sortState.inventario.column}"]`);
                const type = th ? th.dataset.type : 'text';
                inventario = sortData(inventario, sortState.inventario.column, sortState.inventario.direction, type, 'inventario');
            }

            tbody.innerHTML = inventario.map(animal => {
                const diasEnFinca = getDiasEnFinca(animal.fechaEntrada);
                const pesoEstimadoDefault = animal.peso + (diasEnFinca * data.config.gdp);
                const inRetiro = isAnimalInRetiro(animal.numero);
                // Use shared potreros for La Coru√±a and Santa Catalina
                const allPotreros = usesSharedPotreros() ? getSharedPotreros() : (data.potreros || []);
                const potrero = data.animalPotreros[animal.numero] ? allPotreros.find(p => p.id === data.animalPotreros[animal.numero]) : null;
                const hasPhoto = !!animalPhotos[animal.numero]?.photo;

                // Check for manual weight updates from Progreso
                // Sort by date descending, then by id descending (for same-day updates)
                const animalUpdates = data.pesoUpdates ? data.pesoUpdates.filter(u => String(u.numero) === String(animal.numero)).sort((a, b) => {
                    const dateCompare = new Date(b.fecha) - new Date(a.fecha);
                    if (dateCompare !== 0) return dateCompare;
                    return (b.id || 0) - (a.id || 0); // Most recent id first for same date
                }) : [];
                const lastManualUpdate = animalUpdates.length > 0 ? animalUpdates[0] : null;

                let pesoDisplay, pesoStyle;
                // Only show estimated/actual weight for MACHOS - females are not raised for weight gain
                if (animal.sexo === 'HEMBRA') {
                    pesoDisplay = `<span style="color: #9ca3af; font-style: italic;">Hembra</span>`;
                } else if (lastManualUpdate && !lastManualUpdate.isDemo) {
                    // Has REAL manual weight update (not demo data) - compare to default estimate
                    const pesoReal = lastManualUpdate.pesoNuevo;
                    if (pesoReal > pesoEstimadoDefault) {
                        // Above estimate - green and bold
                        pesoStyle = 'color: #16a34a; font-weight: bold;';
                    } else if (pesoReal < pesoEstimadoDefault) {
                        // Below estimate - red and bold
                        pesoStyle = 'color: #dc2626; font-weight: bold;';
                    } else {
                        // Equal to estimate - bold only
                        pesoStyle = 'font-weight: bold;';
                    }
                    pesoDisplay = `<span style="${pesoStyle}">${pesoReal.toFixed(0)} kg</span>`;
                } else {
                    // No manual update OR only demo data - default black (not bold, just regular)
                    pesoDisplay = `<span>${pesoEstimadoDefault.toFixed(0)} kg</span>`;
                }

                return `
                    <tr class="clickable-row" onclick="showAnimalProfile('${animal.numero}')" title="Ver perfil del animal">
                        <td><strong>${animal.numero}</strong>${inRetiro ? ' üö´' : ''}${hasPhoto ? ' üì∏' : ''}</td>
                        <td>${animal.lote || '-'}</td>
                        <td>${animal.numeroVaca ? 'Nac. (' + animal.numeroVaca + ')' : animal.vendedor}</td>
                        <td>${animal.raza || '-'}</td>
                        <td>${animal.sexo === 'MACHO' ? '‚ôÇÔ∏è' : '‚ôÄÔ∏è'}</td>
                        <td class="text-right">${animal.peso} kg</td>
                        <td class="text-right">${formatCurrency(animal.precioKilo)}</td>
                        <td>${formatDate(animal.fechaEntrada)}</td>
                        <td class="text-right">${diasEnFinca}</td>
                        <td class="text-right">${pesoDisplay}</td>
                        <td class="text-center">
                            <button class="btn btn-warning" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;" onclick="event.stopPropagation(); quickSale('${animal.numero}')">üíµ</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        function updateEntradasTable() {
            const tbody = document.getElementById('entradasTable');
            
            if (data.entradas.length === 0) {
                tbody.innerHTML = '<tr><td colspan="12" class="text-center">No hay entradas registradas</td></tr>';
                updateEntradasSummary();
                return;
            }
            
            // Default sort by date descending, or use active sort
            let sorted;
            if (sortState.entradas.column) {
                const th = document.querySelector(`#entradasTableContainer th[data-sort="${sortState.entradas.column}"]`);
                const type = th ? th.dataset.type : 'text';
                sorted = sortData(data.entradas, sortState.entradas.column, sortState.entradas.direction, type, 'entradas');
            } else {
                sorted = [...data.entradas].sort((a, b) => new Date(b.fechaEntrada) - new Date(a.fechaEntrada));
            }
            
            tbody.innerHTML = sorted.map((entrada, index) => {
                const tipo = entrada.numeroVaca ? 'nacimiento' : 'compra';
                const vendedorMadre = entrada.numeroVaca ? `Madre: ${entrada.numeroVaca}` : entrada.vendedor;
                const sold = isAnimalSold(entrada.numero);
                
                return `
                    <tr class="clickable-row" onclick="showAnimalProfile('${entrada.numero}')" title="Ver perfil del animal" style="cursor: pointer;">
                        <td class="text-center sticky-col">${index + 1}</td>
                        <td><strong>${entrada.numero}</strong></td>
                        <td><span class="badge ${tipo === 'compra' ? 'badge-success' : 'badge-info'}">${tipo === 'compra' ? 'üõí' : 'üê£'}</span></td>
                        <td>${entrada.lote || '-'}</td>
                        <td>${vendedorMadre}</td>
                        <td>${entrada.raza || '-'}</td>
                        <td>${entrada.sexo === 'MACHO' ? '‚ôÇÔ∏è' : '‚ôÄÔ∏è'}</td>
                        <td class="text-right">${entrada.peso} kg</td>
                        <td class="text-right">${formatCurrency(entrada.precioKilo)}</td>
                        <td>${formatDate(entrada.fechaEntrada)}</td>
                        <td class="text-right">${formatCurrency(entrada.costoTotal)}</td>
                        <td><span class="badge ${sold ? 'badge-secondary' : 'badge-success'}">${sold ? 'Vendido' : 'En Finca'}</span></td>
                    </tr>
                `;
            }).join('');

            // Re-apply filters after rendering (using setTimeout to ensure DOM is updated)
            setTimeout(() => filterEntradas(), 0);
        }
        
        function updateSalidasTable() {
            const tbody = document.getElementById('salidasTable');
            
            if (data.salidas.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" class="text-center">No hay salidas registradas</td></tr>';
                updateSalidasSummary();
                return;
            }
            
            // Apply sorting if active, otherwise sort by date descending
            let sorted = [...data.salidas];
            
            if (sortState.salidas.column) {
                // Find the column header to get its type
                const th = document.querySelector(`#salidasTableContainer th[data-sort="${sortState.salidas.column}"]`);
                const type = th ? th.dataset.type : 'text';
                
                // Sort the data
                sorted = sortData(sorted, sortState.salidas.column, sortState.salidas.direction, type, 'salidas');
            } else {
                // Default: sort by date descending
                sorted.sort((a, b) => new Date(b.fechaSalida) - new Date(a.fechaSalida));
            }
            
            tbody.innerHTML = sorted.map((salida, index) => {
                const tipo = salida.comprador === 'MUERTE' ? 'muerte' : 'venta';
                const entrada = data.entradas.find(e => e.numero == salida.numero);
                const costoCompra = entrada
                    ? (entrada.costoTotal || (entrada.peso * entrada.precioKilo) || 0)
                    : null;
                
                return `
                    <tr class="clickable-row" onclick="showAnimalProfile('${salida.numero}')" title="Ver perfil del animal" style="cursor: pointer;">
                        <td class="text-center sticky-col">${index + 1}</td>
                        <td><strong>${salida.numero}</strong></td>
                        <td><span class="badge ${tipo === 'venta' ? 'badge-warning' : 'badge-danger'}">${tipo === 'venta' ? 'üíµ' : '‚úùÔ∏è'}</span></td>
                        <td class="text-right">${salida.peso} kg</td>
                        <td>${formatDate(salida.fechaSalida)}</td>
                        <td class="text-right">${formatCurrency(salida.precioKiloVenta)}</td>
                        <td>${salida.comprador}${salida.causa ? ' (' + salida.causa + ')' : ''}</td>
                        <td class="text-right">${formatCurrency(salida.costoVenta)}</td>
                        <td class="text-right">${costoCompra === null ? '-' : formatCurrency(costoCompra)}</td>
                        <td class="text-right">${salida.gananciaDay ? salida.gananciaDay.toFixed(3) : '-'}</td>
                    </tr>
                `;
            }).join('');
            
            // Re-apply filters after rendering (using setTimeout to ensure DOM is updated)
            setTimeout(() => filterSalidas(), 0);
        }
        
        function updateReports() {
            // Reportes tab was removed - skip if elements don't exist
            if (!document.getElementById('reportTotalCompras')) return;

            const { entradasFiltered, salidasFiltered } = getReportesFilteredData();
            const compras = entradasFiltered.filter(e => !e.numeroVaca).length;
            const nacimientos = entradasFiltered.filter(e => e.numeroVaca).length;
            const ventas = salidasFiltered.filter(s => s.comprador !== 'MUERTE').length;
            const muertes = salidasFiltered.filter(s => s.comprador === 'MUERTE').length;

            document.getElementById('reportTotalCompras').textContent = compras;
            document.getElementById('reportTotalNacimientos').textContent = nacimientos;
            document.getElementById('reportTotalVentas').textContent = ventas;
            document.getElementById('reportTotalMuertes').textContent = muertes;
            
            // Vendedores report
            const vendedoresData = {};
            entradasFiltered.filter(e => !e.numeroVaca).forEach(e => {
                if (!vendedoresData[e.vendedor]) {
                    vendedoresData[e.vendedor] = { vendedor: e.vendedor, count: 0, kg: 0, inversion: 0 };
                }
                vendedoresData[e.vendedor].count++;
                vendedoresData[e.vendedor].kg += e.peso;
                vendedoresData[e.vendedor].inversion += e.costoTotal || 0;
            });
            
            // Add precioKg for sorting
            Object.values(vendedoresData).forEach(v => {
                v.precioKg = v.kg > 0 ? v.inversion / v.kg : 0;
            });
            
            const vendedoresTbody = document.getElementById('vendedoresReport');
            let vendedoresRows = Object.values(vendedoresData);
            
            // Apply sorting
            if (sortState.vendedores.column) {
                const th = document.querySelector(`#vendedoresTableContainer th[data-sort="${sortState.vendedores.column}"]`);
                const type = th ? th.dataset.type : 'text';
                vendedoresRows = sortData(vendedoresRows, sortState.vendedores.column, sortState.vendedores.direction, type, 'vendedores');
            } else {
                vendedoresRows.sort((a, b) => b.count - a.count);
            }
            
            if (vendedoresRows.length === 0) {
                vendedoresTbody.innerHTML = '<tr><td colspan="5" class="text-center">No hay datos</td></tr>';
            } else {
                vendedoresTbody.innerHTML = vendedoresRows.map(stats => `
                    <tr>
                        <td><strong>${stats.vendedor}</strong></td>
                        <td class="text-right">${stats.count}</td>
                        <td class="text-right">${formatNumber(stats.kg)} kg</td>
                        <td class="text-right">${formatCurrency(stats.inversion)}</td>
                        <td class="text-right">${formatCurrency(stats.precioKg)}</td>
                    </tr>
                `).join('');
            }
            
            // Compradores report
            const compradoresData = {};
            salidasFiltered.filter(s => s.comprador !== 'MUERTE').forEach(s => {
                if (!compradoresData[s.comprador]) {
                    compradoresData[s.comprador] = { comprador: s.comprador, count: 0, kg: 0, ingresos: 0, gdpSum: 0 };
                }
                compradoresData[s.comprador].count++;
                compradoresData[s.comprador].kg += s.peso;
                compradoresData[s.comprador].ingresos += s.costoVenta || 0;
                compradoresData[s.comprador].gdpSum += s.gananciaDay || 0;
            });
            
            // Add gdp for sorting
            Object.values(compradoresData).forEach(c => {
                c.gdp = c.count > 0 ? c.gdpSum / c.count : 0;
            });
            
            const compradoresTbody = document.getElementById('compradoresReport');
            let compradoresRows = Object.values(compradoresData);
            
            // Apply sorting
            if (sortState.compradores.column) {
                const th = document.querySelector(`#compradoresTableContainer th[data-sort="${sortState.compradores.column}"]`);
                const type = th ? th.dataset.type : 'text';
                compradoresRows = sortData(compradoresRows, sortState.compradores.column, sortState.compradores.direction, type, 'compradores');
            } else {
                compradoresRows.sort((a, b) => b.count - a.count);
            }
            
            if (compradoresRows.length === 0) {
                compradoresTbody.innerHTML = '<tr><td colspan="5" class="text-center">No hay datos</td></tr>';
            } else {
                compradoresTbody.innerHTML = compradoresRows.map(stats => `
                    <tr>
                        <td><strong>${stats.comprador}</strong></td>
                        <td class="text-right">${stats.count}</td>
                        <td class="text-right">${formatNumber(stats.kg)} kg</td>
                        <td class="text-right">${formatCurrency(stats.ingresos)}</td>
                        <td class="text-right">${stats.gdp.toFixed(3)} kg/d√≠a</td>
                    </tr>
                `).join('');
            }
        }
        
        function updateRecentActivity() {
            const activities = [];
            
            // Add entradas
            data.entradas.forEach(e => {
                activities.push({
                    fecha: e.fechaEntrada,
                    tipo: e.numeroVaca ? 'üê£ Nacimiento' : 'üõí Compra',
                    chapeta: e.numero,
                    detalle: e.numeroVaca ? `Madre: ${e.numeroVaca}` : `${e.vendedor} - ${e.peso} kg`
                });
            });
            
            // Add salidas
            data.salidas.forEach(s => {
                activities.push({
                    fecha: s.fechaSalida,
                    tipo: s.comprador === 'MUERTE' ? '‚úùÔ∏è Muerte' : 'üíµ Venta',
                    chapeta: s.numero,
                    detalle: s.comprador === 'MUERTE' ? (s.causa || 'Sin causa') : `${s.comprador} - ${s.peso} kg`
                });
            });
            
            // Sort by date descending and take last 10
            activities.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
            const recent = activities.slice(0, 10);
            
            const tbody = document.getElementById('recentActivity');
            if (recent.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center">No hay actividad reciente</td></tr>';
            } else {
                tbody.innerHTML = recent.map(a => `
                    <tr>
                        <td>${formatDate(a.fecha)}</td>
                        <td>${a.tipo}</td>
                        <td><strong>${a.chapeta}</strong></td>
                        <td>${a.detalle}</td>
                    </tr>
                `).join('');
            }
        }
        
        function updateFilters() {
            // Vendedor filter
            const vendedores = [...new Set(data.entradas.filter(e => !e.numeroVaca).map(e => e.vendedor))];
            const inventarioVendedorFilter = document.getElementById('inventarioVendedorFilter');
            if (inventarioVendedorFilter) {
                inventarioVendedorFilter.innerHTML = 
                    '<option value="">Todos los vendedores</option>' +
                    vendedores.map(v => `<option value="${v}">${v}</option>`).join('');
            }
            
            // Year filters
            const years = [...new Set([
                ...data.entradas.map(e => new Date(e.fechaEntrada).getFullYear()),
                ...data.salidas.map(s => new Date(s.fechaSalida).getFullYear())
            ])].sort((a, b) => b - a);
            
            const yearOptions = '<option value="">Todos los a√±os</option>' + years.map(y => `<option value="${y}">${y}</option>`).join('');
            
            const entradasYearSelect = document.getElementById('entradasYearSelect');
            if (entradasYearSelect) {
                entradasYearSelect.innerHTML = yearOptions;
            }
            
            const salidasYearSelect = document.getElementById('salidasYearSelect');
            if (salidasYearSelect) {
                salidasYearSelect.innerHTML = yearOptions;
            }

            const reportesYearSelect = document.getElementById('reportesYearSelect');
            if (reportesYearSelect) {
                reportesYearSelect.innerHTML = yearOptions;
            }
        }
        
        // ==================== FILTERS ====================
        function filterInventario() {
            const search = document.getElementById('inventarioSearch').value.toLowerCase();
            const sexo = document.getElementById('inventarioSexoFilter').value;
            const vendedor = document.getElementById('inventarioVendedorFilter').value;
            
            const rows = document.querySelectorAll('#inventarioTable tr');
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                const matchSearch = !search || text.includes(search);
                const matchSexo = !sexo || text.includes(sexo.toLowerCase());
                const matchVendedor = !vendedor || text.includes(vendedor.toLowerCase());
                
                row.style.display = matchSearch && matchSexo && matchVendedor ? '' : 'none';
            });
        }
        
        function handleEntradasPeriodoChange() {
            const periodo = document.getElementById('entradasPeriodoFilter').value;
            const yearSelect = document.getElementById('entradasYearSelect');
            const dateRange = document.getElementById('entradasDateRange');
            
            // Hide all extra controls first
            yearSelect.style.display = 'none';
            dateRange.style.display = 'none';
            
            // Show appropriate controls based on selection
            if (periodo === 'ano_especifico') {
                yearSelect.style.display = 'block';
                // Populate years if empty
                if (yearSelect.options.length <= 1) {
                    const years = [...new Set(data.entradas.map(e => new Date(e.fechaEntrada).getFullYear()))].sort((a, b) => b - a);
                    yearSelect.innerHTML = '<option value="">Seleccionar a√±o</option>' + 
                        years.map(y => `<option value="${y}">${y}</option>`).join('');
                }
            } else if (periodo === 'rango_fechas') {
                dateRange.style.display = 'flex';
            }
            
            // Apply filter
            filterEntradas();
        }
        
        function handleSalidasPeriodoChange() {
            const periodo = document.getElementById('salidasPeriodoFilter').value;
            const yearSelect = document.getElementById('salidasYearSelect');
            const dateRange = document.getElementById('salidasDateRange');
            
            // Hide all extra controls first
            yearSelect.style.display = 'none';
            dateRange.style.display = 'none';
            
            // Show appropriate controls based on selection
            if (periodo === 'ano_especifico') {
                yearSelect.style.display = 'block';
                // Populate years if empty
                if (yearSelect.options.length <= 1) {
                    const years = [...new Set(data.salidas.map(s => new Date(s.fechaSalida).getFullYear()))].sort((a, b) => b - a);
                    yearSelect.innerHTML = '<option value="">Seleccionar a√±o</option>' + 
                        years.map(y => `<option value="${y}">${y}</option>`).join('');
                }
            } else if (periodo === 'rango_fechas') {
                dateRange.style.display = 'flex';
            }
            
            // Apply filter
            filterSalidas();
        }

        function handleReportesPeriodoChange() {
            const periodo = document.getElementById('reportesPeriodoFilter').value;
            const yearSelect = document.getElementById('reportesYearSelect');
            const dateRange = document.getElementById('reportesDateRange');

            // Hide all extra controls first
            yearSelect.style.display = 'none';
            dateRange.style.display = 'none';

            // Show appropriate controls based on selection
            if (periodo === 'ano_especifico') {
                yearSelect.style.display = 'block';
            } else if (periodo === 'rango_fechas') {
                dateRange.style.display = 'flex';
            }

            filterReportes();
        }

        function getReportesFilteredData() {
            const tipo = document.getElementById('reportesTipoFilter')?.value || '';
            const periodo = document.getElementById('reportesPeriodoFilter')?.value || '';
            const yearSelect = document.getElementById('reportesYearSelect')?.value || '';
            const dateFrom = document.getElementById('reportesDateFrom')?.value || '';
            const dateTo = document.getElementById('reportesDateTo')?.value || '';
            const search = document.getElementById('reportesSearch')?.value.toLowerCase() || '';

            const today = new Date();
            const currentYear = today.getFullYear();

            const filterByPeriodo = (fechaStr) => {
                if (!periodo || !fechaStr) return true;
                const fecha = new Date(fechaStr);
                if (Number.isNaN(fecha.getTime())) return false;

                switch (periodo) {
                    case 'ano_actual':
                        return fecha.getFullYear() === currentYear;
                    case 'ultimo_mes': {
                        const lastMonth = new Date(today);
                        lastMonth.setMonth(lastMonth.getMonth() - 1);
                        return fecha >= lastMonth;
                    }
                    case 'ano_especifico':
                        return yearSelect ? fecha.getFullYear() === parseInt(yearSelect, 10) : true;
                    case 'rango_fechas': {
                        if (dateFrom && dateTo) {
                            const from = new Date(dateFrom);
                            const to = new Date(dateTo);
                            return fecha >= from && fecha <= to;
                        }
                        if (dateFrom) {
                            const from = new Date(dateFrom);
                            return fecha >= from;
                        }
                        if (dateTo) {
                            const to = new Date(dateTo);
                            return fecha <= to;
                        }
                        return true;
                    }
                    default:
                        return true;
                }
            };

            let entradasFiltered = data.entradas.filter(e => filterByPeriodo(e.fechaEntrada));
            let salidasFiltered = data.salidas.filter(s => filterByPeriodo(s.fechaSalida));

            if (search) {
                entradasFiltered = entradasFiltered.filter(e => (e.vendedor || '').toLowerCase().includes(search));
                salidasFiltered = salidasFiltered.filter(s => (s.comprador || '').toLowerCase().includes(search));
            }

            if (tipo === 'compra') {
                entradasFiltered = entradasFiltered.filter(e => !e.numeroVaca);
                salidasFiltered = [];
            } else if (tipo === 'nacimiento') {
                entradasFiltered = entradasFiltered.filter(e => e.numeroVaca);
                salidasFiltered = [];
            } else if (tipo === 'venta') {
                salidasFiltered = salidasFiltered.filter(s => s.comprador !== 'MUERTE');
                entradasFiltered = [];
            } else if (tipo === 'muerte') {
                salidasFiltered = salidasFiltered.filter(s => s.comprador === 'MUERTE');
                entradasFiltered = [];
            }

            return { entradasFiltered, salidasFiltered };
        }

        function filterReportes() {
            updateReports();
        }

        function parseIntegerFromText(text) {
            if (!text) return 0;
            const cleaned = text.replace(/[^\d-]/g, '');
            const value = parseInt(cleaned, 10);
            return Number.isNaN(value) ? 0 : value;
        }

        function parseFloatFromText(text) {
            if (!text) return 0;
            const cleaned = text.replace(/[^\d,.-]/g, '');
            if (!cleaned) return 0;
            let normalized = cleaned;
            if (normalized.includes(',') && normalized.includes('.')) {
                normalized = normalized.replace(/\./g, '').replace(',', '.');
            } else if (normalized.includes(',') && !normalized.includes('.')) {
                normalized = normalized.replace(',', '.');
            }
            const value = parseFloat(normalized);
            return Number.isNaN(value) ? 0 : value;
        }

        function getDateKey(date) {
            if (!(date instanceof Date) || Number.isNaN(date.getTime())) return null;
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function getDateKeyFromDisplay(dateText) {
            if (!dateText) return null;
            const [day, month, year] = dateText.split('/').map(Number);
            if (!day || !month || !year) return null;
            return `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        }

        function updateEntradasSummary() {
            const summary = document.getElementById('entradasSummary');
            if (!summary) return;

            const rows = document.querySelectorAll('#entradasTable tr');
            let count = 0;
            let totalPeso = 0;
            let totalPrecio = 0;
            let totalCosto = 0;

            rows.forEach(row => {
                if (row.style.display === 'none') return;
                const cells = row.querySelectorAll('td');
                if (cells.length < 12) return;

                totalPeso += parseIntegerFromText(cells[7]?.textContent || '');
                totalPrecio += parseIntegerFromText(cells[8]?.textContent || '');
                totalCosto += parseIntegerFromText(cells[10]?.textContent || '');
                count += 1;
            });

            const avgPeso = count ? totalPeso / count : 0;
            const avgPrecio = count ? totalPrecio / count : 0;
            const avgCosto = count ? totalCosto / count : 0;

            const labelCell = summary.querySelector('[data-summary="label"]');
            if (labelCell) labelCell.textContent = `Totales (${count})`;

            const pesoTotalCell = summary.querySelector('[data-summary="peso"]');
            if (pesoTotalCell) pesoTotalCell.textContent = count ? `${formatNumber(totalPeso)} kg` : '-';
            const precioTotalCell = summary.querySelector('[data-summary="precio"]');
            if (precioTotalCell) precioTotalCell.textContent = count ? formatCurrency(totalPrecio) : '-';
            const costoTotalCell = summary.querySelector('[data-summary="costo"]');
            if (costoTotalCell) costoTotalCell.textContent = count ? formatCurrency(totalCosto) : '-';

            const pesoAvgCell = summary.querySelector('[data-summary="peso-avg"]');
            if (pesoAvgCell) pesoAvgCell.textContent = count ? `${formatNumber(avgPeso)} kg` : '-';
            const precioAvgCell = summary.querySelector('[data-summary="precio-avg"]');
            if (precioAvgCell) precioAvgCell.textContent = count ? formatCurrency(avgPrecio) : '-';
            const costoAvgCell = summary.querySelector('[data-summary="costo-avg"]');
            if (costoAvgCell) costoAvgCell.textContent = count ? formatCurrency(avgCosto) : '-';
        }

        function updateSalidasSummary() {
            const summary = document.getElementById('salidasSummary');
            if (!summary) return;

            const rows = document.querySelectorAll('#salidasTable tr');
            let count = 0;
            let totalPeso = 0;
            let totalPrecio = 0;
            let totalValor = 0;
            let totalCostoCompra = 0;
            let totalGdp = 0;

            rows.forEach(row => {
                if (row.style.display === 'none') return;
                const cells = row.querySelectorAll('td');
                if (cells.length < 10) return;

                totalPeso += parseIntegerFromText(cells[3]?.textContent || '');
                totalPrecio += parseIntegerFromText(cells[5]?.textContent || '');
                totalValor += parseIntegerFromText(cells[7]?.textContent || '');
                totalCostoCompra += parseIntegerFromText(cells[8]?.textContent || '');
                totalGdp += parseFloatFromText(cells[9]?.textContent || '');
                count += 1;
            });

            const avgPeso = count ? totalPeso / count : 0;
            const avgPrecio = count ? totalPrecio / count : 0;
            const avgValor = count ? totalValor / count : 0;
            const avgCostoCompra = count ? totalCostoCompra / count : 0;
            const avgGdp = count ? totalGdp / count : 0;

            const labelCell = summary.querySelector('[data-summary="label"]');
            if (labelCell) labelCell.textContent = `Totales (${count})`;

            const pesoTotalCell = summary.querySelector('[data-summary="peso"]');
            if (pesoTotalCell) pesoTotalCell.textContent = count ? `${formatNumber(totalPeso)} kg` : '-';
            const precioTotalCell = summary.querySelector('[data-summary="precio"]');
            if (precioTotalCell) precioTotalCell.textContent = count ? formatCurrency(totalPrecio) : '-';
            const valorTotalCell = summary.querySelector('[data-summary="valor"]');
            if (valorTotalCell) valorTotalCell.textContent = count ? formatCurrency(totalValor) : '-';
            const costoCompraTotalCell = summary.querySelector('[data-summary="costo-compra"]');
            if (costoCompraTotalCell) costoCompraTotalCell.textContent = count ? formatCurrency(totalCostoCompra) : '-';
            const gdpTotalCell = summary.querySelector('[data-summary="gdp"]');
            if (gdpTotalCell) gdpTotalCell.textContent = count ? totalGdp.toFixed(3) : '-';

            const pesoAvgCell = summary.querySelector('[data-summary="peso-avg"]');
            if (pesoAvgCell) pesoAvgCell.textContent = count ? `${formatNumber(avgPeso)} kg` : '-';
            const precioAvgCell = summary.querySelector('[data-summary="precio-avg"]');
            if (precioAvgCell) precioAvgCell.textContent = count ? formatCurrency(avgPrecio) : '-';
            const valorAvgCell = summary.querySelector('[data-summary="valor-avg"]');
            if (valorAvgCell) valorAvgCell.textContent = count ? formatCurrency(avgValor) : '-';
            const costoCompraAvgCell = summary.querySelector('[data-summary="costo-compra-avg"]');
            if (costoCompraAvgCell) costoCompraAvgCell.textContent = count ? formatCurrency(avgCostoCompra) : '-';
            const gdpAvgCell = summary.querySelector('[data-summary="gdp-avg"]');
            if (gdpAvgCell) gdpAvgCell.textContent = count ? avgGdp.toFixed(3) : '-';
        }
        
        function filterEntradas() {
            const search = document.getElementById('entradasSearch').value.toLowerCase();
            const tipo = document.getElementById('entradasTipoFilter').value;
            const periodo = document.getElementById('entradasPeriodoFilter').value;
            const yearSelect = document.getElementById('entradasYearSelect').value;
            const dateFrom = document.getElementById('entradasDateFrom').value;
            const dateTo = document.getElementById('entradasDateTo').value;
            
            const rows = document.querySelectorAll('#entradasTable tr');
            const today = new Date();
            const currentYear = today.getFullYear();
            const currentMonth = today.getMonth();
            
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length === 0) return; // Skip header or empty rows
                
                const text = row.textContent.toLowerCase();
                const matchSearch = !search || text.includes(search);
                
                // Check tipo by badge class in second column (tipo column)
                let matchTipo = true; // Default to true if no filter
                if (tipo) {
                    matchTipo = false; // Start false when filtering
                    const tipoBadge = cells[2]?.querySelector('.badge');
                    if (tipoBadge) {
                        if (tipo === 'compra') {
                            matchTipo = tipoBadge.classList.contains('badge-success');
                        } else if (tipo === 'nacimiento') {
                            matchTipo = tipoBadge.classList.contains('badge-info');
                        }
                    }
                }
                
                // Get the fecha from the row (assuming it's in column 9 - Fecha)
                const fechaCell = cells[9]?.textContent.trim();
                let matchPeriodo = true;
                
                if (periodo && fechaCell) {
                    const [day, month, year] = fechaCell.split('/').map(Number);
                    if (day && month && year) {
                        // Note: month is 1-12 in display, but Date uses 0-11
                        const fechaEntrada = new Date(year, month - 1, day);
                        
                        switch(periodo) {
                            case 'ano_actual':
                                matchPeriodo = fechaEntrada.getFullYear() === currentYear;
                                break;
                            case 'ultimo_mes':
                                const lastMonth = new Date(today);
                                lastMonth.setMonth(lastMonth.getMonth() - 1);
                                matchPeriodo = fechaEntrada >= lastMonth;
                                break;
                            case 'ultimo_lote':
                                // Find the most recent lote
                                const lotes = data.entradas.map(e => ({
                                    lote: e.lote,
                                    fecha: new Date(e.fechaEntrada)
                                }));
                                if (lotes.length > 0) {
                                    lotes.sort((a, b) => b.fecha - a.fecha);
                                    const ultimoLote = lotes[0].lote;
                                    const loteCell = cells[3]?.textContent.trim();
                                    matchPeriodo = loteCell === ultimoLote;
                                }
                                break;
                            case 'ano_especifico':
                                if (yearSelect) {
                                    matchPeriodo = fechaEntrada.getFullYear() === parseInt(yearSelect);
                                }
                                break;
                            case 'rango_fechas':
                                if (dateFrom && dateTo) {
                                    const from = new Date(dateFrom);
                                    const to = new Date(dateTo);
                                    matchPeriodo = fechaEntrada >= from && fechaEntrada <= to;
                                } else if (dateFrom) {
                                    const from = new Date(dateFrom);
                                    matchPeriodo = fechaEntrada >= from;
                                } else if (dateTo) {
                                    const to = new Date(dateTo);
                                    matchPeriodo = fechaEntrada <= to;
                                }
                                break;
                        }
                    }
                }
                
                row.style.display = matchSearch && matchTipo && matchPeriodo ? '' : 'none';
            });

            updateEntradasSummary();
        }
        
        function filterSalidas() {
            const search = document.getElementById('salidasSearch').value.toLowerCase();
            const tipo = document.getElementById('salidasTipoFilter').value;
            const periodo = document.getElementById('salidasPeriodoFilter').value;
            const yearSelect = document.getElementById('salidasYearSelect').value;
            const dateFrom = document.getElementById('salidasDateFrom').value;
            const dateTo = document.getElementById('salidasDateTo').value;
            
            const rows = document.querySelectorAll('#salidasTable tr');
            const today = new Date();
            const currentYear = today.getFullYear();
            const latestSaleDate = data.salidas
                .filter(s => s.comprador !== 'MUERTE')
                .reduce((latest, salida) => {
                    const date = new Date(salida.fechaSalida);
                    if (Number.isNaN(date.getTime())) return latest;
                    return latest && latest > date ? latest : date;
                }, null);
            const latestSaleKey = latestSaleDate ? getDateKey(latestSaleDate) : null;
            
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length === 0) return; // Skip header or empty rows
                
                const text = row.textContent.toLowerCase();
                const matchSearch = !search || text.includes(search);
                
                // Check tipo by badge class (column index 2)
                let matchTipo = true; // Default to true (show all)
                let isVenta = false;
                
                if (tipo) {
                    // When filter is selected, check the badge class in the Tipo column
                    const tipoBadge = cells[2]?.querySelector('.badge');
                    if (tipoBadge) {
                        isVenta = tipoBadge.classList.contains('badge-warning');
                        const isMuerte = tipoBadge.classList.contains('badge-danger');
                        
                        // Set matchTipo based on selected filter
                        if (tipo === 'venta') {
                            matchTipo = isVenta;
                        } else if (tipo === 'muerte') {
                            matchTipo = isMuerte;
                        }
                    } else {
                        // If badge not found, don't match
                        matchTipo = false;
                    }
                } else {
                    // No filter selected - check badge for period filtering later
                    const tipoBadge = cells[2]?.querySelector('.badge');
                    if (tipoBadge) {
                        isVenta = tipoBadge.classList.contains('badge-warning');
                    }
                }
                
                // Get the fecha from the row (assuming it's in column 3 - Fecha)
                const fechaCell = cells[4]?.textContent.trim();
                let matchPeriodo = true;
                
                if (periodo && fechaCell) {
                    const [day, month, year] = fechaCell.split('/').map(Number);
                    if (day && month && year) {
                        // Note: month is 1-12 in display, but Date uses 0-11
                        const fechaSalida = new Date(year, month - 1, day);
                        
                        switch(periodo) {
                            case 'ano_actual':
                                matchPeriodo = fechaSalida.getFullYear() === currentYear;
                                break;
                            case 'ultimo_mes':
                                const lastMonth = new Date(today);
                                lastMonth.setMonth(lastMonth.getMonth() - 1);
                                matchPeriodo = fechaSalida >= lastMonth;
                                break;
                            case 'ultima_venta':
                                if (!latestSaleKey) {
                                    matchPeriodo = false;
                                } else {
                                    const rowKey = getDateKeyFromDisplay(fechaCell);
                                    matchPeriodo = isVenta && rowKey === latestSaleKey;
                                }
                                break;
                            case 'ano_especifico':
                                if (yearSelect) {
                                    matchPeriodo = fechaSalida.getFullYear() === parseInt(yearSelect);
                                }
                                break;
                            case 'rango_fechas':
                                if (dateFrom && dateTo) {
                                    const from = new Date(dateFrom);
                                    const to = new Date(dateTo);
                                    matchPeriodo = fechaSalida >= from && fechaSalida <= to;
                                } else if (dateFrom) {
                                    const from = new Date(dateFrom);
                                    matchPeriodo = fechaSalida >= from;
                                } else if (dateTo) {
                                    const to = new Date(dateTo);
                                    matchPeriodo = fechaSalida <= to;
                                }
                                break;
                        }
                    }
                }
                
                row.style.display = matchSearch && matchTipo && matchPeriodo ? '' : 'none';
            });

            updateSalidasSummary();
        }
        
        // ==================== QUICK ACTIONS ====================
        function quickSale(numero) {
            document.querySelector('.nav-tab[data-tab="eventos"]').click();
            setTimeout(() => {
                showEventForm('venta');
                // Pre-fill can be done after lote info is set
                // Store the number for later
                window.pendingQuickSaleNumber = numero;
                showToast(`Animal #${numero} listo para agregar a la venta`, 'info');
            }, 100);
        }
        
        // ==================== IMPORT/EXPORT ====================
        function handleExcelImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            showToast('üìÇ Abriendo archivo Excel...', 'info');
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    console.log('=== INICIO DE IMPORTACI√ìN ===');
                    console.log('Archivo:', file.name);
                    console.log('Tama√±o:', file.size, 'bytes');
                    
                    showToast('üìä Procesando Excel...', 'info');
                    
                    const workbook = XLSX.read(e.target.result, { type: 'array', cellDates: true });
                    
                    console.log('Hojas disponibles:', workbook.SheetNames);
                    
                    let importedCount = 0;
                    let errorCount = 0;
                    const errors = [];
                    let warnedMissingPrice = false;
                    
                    const getFirstValue = (row, keys) => {
                        for (const key of keys) {
                            const value = row[key];
                            if (value !== undefined && value !== null && value !== '') {
                                return value;
                            }
                        }
                        return undefined;
                    };
                    
                    const parseNumber = (value) => {
                        if (value === undefined || value === null || value === '') return 0;
                        if (typeof value === 'number') return value;
                        const cleaned = String(value).replace(/[^\d,.-]/g, '').trim();
                        if (!cleaned) return 0;
                        if (cleaned.includes(',') && cleaned.includes('.')) {
                            return parseFloat(cleaned.replace(/\./g, '').replace(/,/g, '.')) || 0;
                        }
                        if (cleaned.includes(',')) {
                            return parseFloat(cleaned.replace(/\./g, '').replace(/,/g, '.')) || 0;
                        }
                        return parseFloat(cleaned) || 0;
                    };
                    
                    // Try to find the data sheet
                    // Detect if this is a sales file based on filename
                    const fileName = file.name.toLowerCase();
                    const isSalesFile = fileName.includes('salida') || fileName.includes('venta');
                    
                    let sheetName = null;
                    let isSalesSheet = false;
                    
                    if (workbook.SheetNames.includes('Salidas')) {
                        sheetName = 'Salidas';
                        isSalesSheet = true;
                    } else if (workbook.SheetNames.includes('Entradas')) {
                        sheetName = 'Entradas';
                        isSalesSheet = false;
                    } else if (workbook.SheetNames.includes('Sheet1')) {
                        sheetName = 'Sheet1';
                        // If filename suggests sales, treat Sheet1 as sales
                        isSalesSheet = isSalesFile;
                    } else {
                        sheetName = workbook.SheetNames[0];
                        isSalesSheet = isSalesFile;
                    }

                    console.log('Usando hoja:', sheetName);
                    console.log('Tipo de archivo:', isSalesSheet ? 'SALIDAS (Ventas)' : 'ENTRADAS (Compras)');

                    if (sheetName) {
                        const sheet = workbook.Sheets[sheetName];
                        const rows = XLSX.utils.sheet_to_json(sheet);

                        console.log('Total de filas:', rows.length);
                        console.log('Primera fila:', rows[0]);

                        if (rows.length === 0) {
                            throw new Error('El archivo Excel est√° vac√≠o o no tiene datos v√°lidos');
                        }

                        showToast(`üìù Procesando ${rows.length} ${isSalesSheet ? 'ventas' : 'compras'}...`, 'info');

                        // Process each row
                        rows.forEach((row, index) => {
                            try {
                                // Get chapeta number
                                const numero = String(row['N√∫mero'] || row['Numero'] || '').trim();
                                if (!numero) {
                                    console.warn(`Fila ${index + 2}: Sin n√∫mero de chapeta, omitida`);
                                    return;
                                }
                                
                                // For SALES files: Process as salidas (don't check duplicates)
                                if (isSalesSheet) {
                                    // Parse precio using the new parseNumber function
                                    const precioKiloVenta = parseNumber(row['Precio/Kg'] || row['Precio/kg'] || row['Precio/Kilo Venta'] || row['Precio/Kilo'] || row['Precio/kilo'] || row['PrecioKilo'] || row['Precio Kilo'] || row['$/Kg'] || row['$ / Kg'] || row['Precio x Kg'] || row['Precio por Kilo'] || row['Precio por kilo'] || row['Precio']);
                                    
                                    // Calculate cost if not provided
                                    const peso = parseFloat(row['Peso']) || 0;
                                    let costoVenta = parseFloat(row['Costo de venta'] || row['Valor'] || row['Total'] || 0);
                                    if (costoVenta === 0 && peso > 0 && precioKiloVenta > 0) {
                                        costoVenta = peso * precioKiloVenta;
                                    }

                                    const salida = {
                                        numero: numero,
                                        peso: peso,
                                        fechaSalida: parseExcelDate(row['Fecha'] || row['Fecha Salida'] || row['Fecha de Salida']),
                                        precioKiloVenta: precioKiloVenta,
                                        comprador: row['Comprador'] || row['Tipo'] || 'No especificado',
                                        costoVenta: costoVenta,
                                        gananciaDay: parseFloat(row['Ganancia/D√≠a'] || row['GDP'] || row['Ganancia Diaria'] || 0)
                                    };

                                    data.salidas.push(salida);
                                    importedCount++;
                                    
                                    if (importedCount % 50 === 0) {
                                        console.log(`‚úÖ Importadas ${importedCount} ventas...`);
                                    }
                                    return; // Important: return here to skip purchase logic
                                }

                                // For PURCHASE files: Check if already exists
                                const exists = data.entradas.some(e => e.numero == numero && !isAnimalSold(e.numero));
                                if (exists) {
                                    console.warn(`Fila ${index + 2}: Animal ${numero} ya existe, omitido`);
                                    errorCount++;
                                    errors.push(`#${numero} ya existe`);
                                    return;
                                }
                                
                                // Get date - try different columns and handle Excel serial dates
                                let fechaEntrada;
                                const fechaRaw = row['Fecha de entrada'] || row['Fecha'] || row['fecha'];
                                if (fechaRaw) {
                                    fechaEntrada = parseExcelDate(fechaRaw);
                                } else {
                                    fechaEntrada = new Date().toISOString().split('T')[0];
                                }
                                
                                // Get other fields
                                const peso = parseNumber(row['Peso Inicial'] || row['Peso inicial'] || row['Peso'] || 0);
                                
                                // Try multiple column name variations for price/kg
                                const rowKeys = Object.keys(row);
                                let precioKiloRaw = getFirstValue(row, [
                                    'Precio/Kg',
                                    'Precio/kg',
                                    'Precio/Kilo',
                                    'Precio/kilo',
                                    'PrecioKilo',
                                    'Precio Kilo',
                                    '$/Kg',
                                    '$ / Kg',
                                    'Precio x Kg',
                                    'Precio x kg',
                                    'Precio por Kilo',
                                    'Precio por kilo'
                                ]);
                                
                                if (!precioKiloRaw) {
                                    const precioKgKey = rowKeys.find((key) => {
                                        const lower = key.toLowerCase();
                                        return lower.includes('precio') && (lower.includes('kg') || lower.includes('kilo'));
                                    });
                                    if (precioKgKey) {
                                        precioKiloRaw = row[precioKgKey];
                                    }
                                }
                                
                                // Parse precio handling Spanish number format (8.500 -> 8500)
                                let precioKilo = parseNumber(precioKiloRaw);
                                
                                if (precioKilo <= 0) {
                                    let totalRaw = getFirstValue(row, [
                                        'Precio',
                                        'Precio Total',
                                        'Precio total',
                                        'Valor',
                                        'Valor Total',
                                        'Valor total',
                                        'Costo',
                                        'Costo Total',
                                        'Costo total',
                                        'Total'
                                    ]);
                                    
                                    if (!totalRaw) {
                                        const totalKey = rowKeys.find((key) => {
                                            const lower = key.toLowerCase();
                                            const hasPrice = lower.includes('precio') || lower.includes('valor') || lower.includes('costo');
                                            const isPerKg = lower.includes('kg') || lower.includes('kilo');
                                            return hasPrice && !isPerKg;
                                        });
                                        if (totalKey) {
                                            totalRaw = row[totalKey];
                                        }
                                    }
                                    
                                    const totalPrice = parseNumber(totalRaw);
                                    if (totalPrice > 0 && peso > 0) {
                                        precioKilo = totalPrice > 20000 ? totalPrice / peso : totalPrice;
                                    }
                                }
                                
                                if (precioKilo <= 0 && !warnedMissingPrice) {
                                    console.warn('No se encontro columna de precio/kg o precio total. Revise el nombre de la columna en Excel.');
                                    warnedMissingPrice = true;
                                }
                                
                                if (peso <= 0 || precioKilo <= 0) {
                                    console.warn(`Fila ${index + 2}: Datos inv√°lidos para #${numero} (peso: ${peso}, precio: ${precioKilo})`);
                                    errorCount++;
                                    errors.push(`#${numero} con datos inv√°lidos`);
                                    return;
                                }
                                
                                const entrada = {
                                    numero: numero,
                                    lote: String(row['Lote'] || ''),
                                    vendedor: row['Vendedor'] || 'No especificado',
                                    raza: row['Raza'] || 'Ceb√∫',
                                    sexo: (row['Sexo'] || 'MACHO').toUpperCase(),
                                    peso: peso,
                                    precioKilo: Math.round(precioKilo),
                                    fechaEntrada: fechaEntrada,
                                    numeroVaca: (() => {
                                        const vacaVal = row['N√∫mero vaca'] || row['Numero vaca'];
                                        return (vacaVal && vacaVal !== 'N/A' && vacaVal !== 'NA' && vacaVal !== 'n/a') ? vacaVal : null;
                                    })(),
                                    costoTotal: Math.round(peso * precioKilo)
                                };
                                
                                data.entradas.push(entrada);
                                importedCount++;
                                
                                if (importedCount % 10 === 0) {
                                    console.log(`Importados ${importedCount} animales...`);
                                }
                            } catch (rowError) {
                                console.error(`Error en fila ${index + 2}:`, rowError);
                                errorCount++;
                                errors.push(`Fila ${index + 2}: ${rowError.message}`);
                            }
                        });
                    }
                    
                    // Process Salidas sheet if exists
                    if (workbook.SheetNames.includes('Salidas')) {
                        console.log('Procesando hoja Salidas...');
                        const sheet = workbook.Sheets['Salidas'];
                        const rows = XLSX.utils.sheet_to_json(sheet);
                        
                        rows.forEach((row, index) => {
                            try {
                                const numero = String(row['N√∫mero'] || row['Numero'] || '').trim();
                                if (!numero) return;
                                
                                // Parse precio using the new parseNumber function (handles commas/dots)
                                const precioKiloVenta = parseNumber(row['Precio/Kg'] || row['Precio/kg'] || row['Precio/Kilo Venta'] || row['Precio/Kilo'] || row['Precio/kilo'] || row['PrecioKilo'] || row['Precio Kilo'] || row['$/Kg'] || row['$ / Kg'] || row['Precio x Kg'] || row['Precio por Kilo'] || row['Precio por kilo']);
                                
                                const salida = {
                                    numero: numero,
                                    peso: parseFloat(row['Peso']) || 0,
                                    fechaSalida: parseExcelDate(row['Fecha'] || row['Fecha Salida']),
                                    precioKiloVenta: precioKiloVenta,
                                    comprador: row['Comprador'] || '',
                                    costoVenta: parseFloat(row['Costo de venta'] || row['Valor'] || 0),
                                    gananciaDay: parseFloat(row['Ganancia/D√≠a'] || row['GDP'] || 0)
                                };
                                
                                data.salidas.push(salida);
                                importedCount++;
                            } catch (rowError) {
                                console.error(`Error en salida fila ${index + 2}:`, rowError);
                            }
                        });
                    }
                    
                    console.log('=== RESUMEN DE IMPORTACI√ìN ===');
                    console.log('Importados exitosamente:', importedCount);
                    console.log('Errores/Omitidos:', errorCount);
                    console.log('Total en sistema:', data.entradas.length);
                    
                    saveData();
                    updateAllViews();
                    
                    let message = `‚úÖ Importados ${importedCount} registros a ${RANCHES[currentRanch].name}`;
                    if (errorCount > 0) {
                        message += `\n‚ö†Ô∏è ${errorCount} omitidos (duplicados o inv√°lidos)`;
                    }
                    
                    showToast(message, importedCount > 0 ? 'success' : 'warning');
                    
                    if (errors.length > 0 && errors.length <= 5) {
                        console.warn('Errores:', errors);
                    }
                    
                } catch (err) {
                    console.error('=== ERROR DE IMPORTACI√ìN ===');
                    console.error('Error completo:', err);
                    console.error('Stack:', err.stack);
                    showToast('‚ùå Error al importar: ' + err.message, 'error');
                    alert('Error al importar el archivo:\n\n' + err.message + '\n\nRevise la consola del navegador para m√°s detalles (F12).');
                }
            };
            
            reader.onerror = function(err) {
                console.error('Error al leer el archivo:', err);
                showToast('‚ùå Error al leer el archivo', 'error');
            };
            
            reader.readAsArrayBuffer(file);
            event.target.value = '';
        }
        
        function parseExcelDate(value) {
            if (!value) return new Date().toISOString().split('T')[0];
            
            // Already a Date object
            if (value instanceof Date) {
                if (isNaN(value.getTime())) {
                    console.warn('Fecha inv√°lida detectada, usando fecha actual');
                    return new Date().toISOString().split('T')[0];
                }
                return value.toISOString().split('T')[0];
            }
            
            // Excel serial date (number)
            if (typeof value === 'number') {
                // Excel dates start from 1900-01-01 (serial 1)
                // But Excel incorrectly treats 1900 as a leap year, so we adjust
                if (value < 60) {
                    // Dates before March 1, 1900
                    const date = new Date(1900, 0, value);
                    return date.toISOString().split('T')[0];
                } else {
                    // Dates after February 28, 1900 (adjust for Excel leap year bug)
                    const date = new Date((value - 25569) * 86400 * 1000);
                    if (isNaN(date.getTime())) {
                        console.warn('Fecha serial inv√°lida:', value);
                        return new Date().toISOString().split('T')[0];
                    }
                    return date.toISOString().split('T')[0];
                }
            }
            
            // String date
            const str = String(value);
            
            // Check if it's ISO format (YYYY-MM-DD)
            if (/^\d{4}-\d{2}-\d{2}/.test(str)) {
                return str.split('T')[0];
            }
            
            // Try to parse as date
            const parsed = new Date(str);
            if (!isNaN(parsed.getTime())) {
                return parsed.toISOString().split('T')[0];
            }
            
            console.warn('No se pudo parsear la fecha:', value, '- usando fecha actual');
            return new Date().toISOString().split('T')[0];
        }
        
        function exportToExcel() {
            const wb = XLSX.utils.book_new();
            
            // Entradas sheet
            const entradasData = data.entradas.map(e => ({
                'N√∫mero': e.numero,
                'Lote': e.lote,
                'Vendedor': e.vendedor,
                'Sexo': e.sexo,
                'Peso': e.peso,
                'Precio/Kilo': e.precioKilo,
                'Fecha de entrada': e.fechaEntrada,
                'N√∫mero vaca': e.numeroVaca || '',
                'Costo Total': e.costoTotal,
                'Fecha': e.fechaEntrada
            }));
            const wsEntradas = XLSX.utils.json_to_sheet(entradasData);
            XLSX.utils.book_append_sheet(wb, wsEntradas, 'Entradas');
            
            // Salidas sheet
            const salidasData = data.salidas.map(s => ({
                'N√∫mero': s.numero,
                'Peso': s.peso,
                'Fecha Salida': s.fechaSalida,
                'Precio/Kilo Venta': s.precioKiloVenta,
                'Comprador': s.comprador,
                'Fecha': s.fechaSalida,
                'Costo de venta': s.costoVenta,
                'Ganancia/D√≠a': s.gananciaDay
            }));
            const wsSalidas = XLSX.utils.json_to_sheet(salidasData);
            XLSX.utils.book_append_sheet(wb, wsSalidas, 'Salidas');
            
            // Inventario sheet
            const inventario = getInventario();
            const inventarioData = inventario.map(a => {
                const dias = getDiasEnFinca(a.fechaEntrada);
                return {
                    'N√∫mero': a.numero,
                    'Lote': a.lote,
                    'Vendedor': a.vendedor,
                    'Sexo': a.sexo,
                    'Peso Inicial': a.peso,
                    'Precio/Kilo': a.precioKilo,
                    'Fecha de entrada': a.fechaEntrada,
                    'D√≠as en finca': dias,
                    'Peso Estimado': Math.round(a.peso + (dias * data.config.gdp)),
                    'Fecha': a.fechaEntrada
                };
            });
            const wsInventario = XLSX.utils.json_to_sheet(inventarioData);
            XLSX.utils.book_append_sheet(wb, wsInventario, 'Inventario');
            
            XLSX.writeFile(wb, 'ganado_finca_export.xlsx');
            showToast('Archivo exportado exitosamente', 'success');
        }
        
        function exportToCSV() {
            const inventario = getInventario();
            const headers = ['N√∫mero', 'Lote', 'Vendedor', 'Sexo', 'Peso Inicial', 'Precio/Kilo', 'Fecha Entrada', 'D√≠as en Finca', 'Peso Estimado'];
            
            const rows = inventario.map(a => {
                const dias = getDiasEnFinca(a.fechaEntrada);
                return [
                    a.numero,
                    a.lote,
                    a.vendedor,
                    a.sexo,
                    a.peso,
                    a.precioKilo,
                    a.fechaEntrada,
                    dias,
                    Math.round(a.peso + (dias * data.config.gdp))
                ];
            });
            
            const csv = [headers, ...rows].map(row => row.join(',')).join('\n');
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'inventario_ganado.csv';
            a.click();
            
            showToast('CSV exportado exitosamente', 'success');
        }
        
        function exportInventario() {
            exportToCSV();
        }
        
        // ==================== CONFIG ====================
        function saveConfig() {
            data.config.gdp = parseFloat(document.getElementById('configGDP').value) || 0.31;
            data.config.precioVenta = parseFloat(document.getElementById('configPrecioVenta').value) || 9000;
            data.config.pesoObjetivo = parseFloat(document.getElementById('configPesoObjetivo').value) || 450;
            data.config.pesoMinimo = parseFloat(document.getElementById('configPesoMinimo').value) || 380;
            data.config.fotoIntervalo = parseInt(document.getElementById('configFotoIntervalo').value) || 90;
            
            saveData();
            showToast('Configuraci√≥n guardada', 'success');
        }

        // ==================== QIF EXPORT (QUICKEN) ====================
        let qifTransactions = { compras: [], ventas: [] };
        let qifCurrentTab = 'compras';

        function initQifDates() {
            // Set default dates: last 3 months
            const today = new Date();
            const threeMonthsAgo = new Date(today.getFullYear(), today.getMonth() - 3, 1);

            document.getElementById('qifDateTo').value = today.toISOString().split('T')[0];
            document.getElementById('qifDateFrom').value = threeMonthsAgo.toISOString().split('T')[0];
        }

        function showQifTab(tab) {
            qifCurrentTab = tab;

            const comprasBtn = document.getElementById('qifTabCompras');
            const ventasBtn = document.getElementById('qifTabVentas');

            if (tab === 'compras') {
                comprasBtn.style.background = '#ef4444';
                comprasBtn.style.color = 'white';
                comprasBtn.classList.remove('btn-secondary');
                ventasBtn.style.background = '';
                ventasBtn.style.color = '';
                ventasBtn.classList.add('btn-secondary');
            } else {
                ventasBtn.style.background = '#10b981';
                ventasBtn.style.color = 'white';
                ventasBtn.classList.remove('btn-secondary');
                comprasBtn.style.background = '';
                comprasBtn.style.color = '';
                comprasBtn.classList.add('btn-secondary');
            }

            renderQifTransactions();
        }

        function loadQifTransactions() {
            const dateFrom = document.getElementById('qifDateFrom').value;
            const dateTo = document.getElementById('qifDateTo').value;

            if (!dateFrom || !dateTo) {
                showToast('Seleccione un rango de fechas', 'warning');
                return;
            }

            const startDate = new Date(dateFrom);
            const endDate = new Date(dateTo);
            endDate.setHours(23, 59, 59);

            // Load purchases (entradas) - grouped by vendor and date
            const comprasMap = {};
            data.entradas.forEach(e => {
                if (!e.fechaEntrada) return;
                const fecha = new Date(e.fechaEntrada);
                if (fecha < startDate || fecha > endDate) return;

                // Group by vendor + date
                const vendedor = e.vendedor || 'Sin vendedor';
                const dateKey = e.fechaEntrada.split('T')[0];
                const key = `${vendedor}_${dateKey}`;

                if (!comprasMap[key]) {
                    comprasMap[key] = {
                        id: key,
                        fecha: e.fechaEntrada,
                        vendedor: vendedor,
                        animales: [],
                        total: 0,
                        selected: false
                    };
                }

                comprasMap[key].animales.push({
                    numero: e.numero,
                    peso: e.peso,
                    precioKilo: e.precioKilo,
                    costo: e.costoTotal || (e.peso * e.precioKilo) || 0,
                    raza: e.raza || 'Sin raza'
                });
                comprasMap[key].total += e.costoTotal || (e.peso * e.precioKilo) || 0;
            });

            qifTransactions.compras = Object.values(comprasMap).sort((a, b) =>
                new Date(b.fecha) - new Date(a.fecha)
            );

            // Load sales (salidas) - grouped by buyer and date
            const ventasMap = {};
            (data.salidas || []).forEach(s => {
                if (!s.fechaSalida) return;
                if (s.comprador === 'MUERTE' || s.comprador?.includes('TRANSFERENCIA')) return;

                const fecha = new Date(s.fechaSalida);
                if (fecha < startDate || fecha > endDate) return;

                const comprador = s.comprador || 'Sin comprador';
                const dateKey = s.fechaSalida.split('T')[0];
                const key = `${comprador}_${dateKey}`;

                if (!ventasMap[key]) {
                    ventasMap[key] = {
                        id: key,
                        fecha: s.fechaSalida,
                        comprador: comprador,
                        animales: [],
                        total: 0,
                        selected: false
                    };
                }

                ventasMap[key].animales.push({
                    numero: s.numero,
                    peso: s.peso,
                    precioKilo: s.precioKilo,
                    total: s.total || (s.peso * s.precioKilo) || 0
                });
                ventasMap[key].total += s.total || (s.peso * s.precioKilo) || 0;
            });

            qifTransactions.ventas = Object.values(ventasMap).sort((a, b) =>
                new Date(b.fecha) - new Date(a.fecha)
            );

            renderQifTransactions();

            const totalCount = qifTransactions.compras.length + qifTransactions.ventas.length;
            showToast(`Se cargaron ${totalCount} transacciones`, 'success');
        }

        function renderQifTransactions() {
            const container = document.getElementById('qifTransactionsList');
            const transactions = qifCurrentTab === 'compras' ? qifTransactions.compras : qifTransactions.ventas;

            if (transactions.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: #666;">
                        <div style="font-size: 2rem; margin-bottom: 0.5rem;">${qifCurrentTab === 'compras' ? 'üì•' : 'üì§'}</div>
                        <p>No hay ${qifCurrentTab === 'compras' ? 'compras' : 'ventas'} en este per√≠odo</p>
                    </div>
                `;
                updateQifSelectedCount();
                return;
            }

            let html = '';
            transactions.forEach((t, idx) => {
                const fecha = new Date(t.fecha).toLocaleDateString('es-CO');
                const persona = qifCurrentTab === 'compras' ? t.vendedor : t.comprador;
                const bgColor = t.selected ? (qifCurrentTab === 'compras' ? '#fee2e2' : '#d1fae5') : 'white';
                const borderColor = qifCurrentTab === 'compras' ? '#ef4444' : '#10b981';

                html += `
                    <div style="background: ${bgColor}; border-radius: 8px; padding: 0.75rem; margin-bottom: 0.5rem; border-left: 3px solid ${borderColor}; cursor: pointer;" onclick="toggleQifTransaction('${qifCurrentTab}', ${idx})">
                        <div style="display: flex; align-items: center; gap: 0.75rem;">
                            <input type="checkbox" ${t.selected ? 'checked' : ''} onclick="event.stopPropagation(); toggleQifTransaction('${qifCurrentTab}', ${idx})" style="width: 18px; height: 18px;">
                            <div style="flex: 1;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <strong style="color: #333;">${persona}</strong>
                                    <span style="font-weight: bold; color: ${qifCurrentTab === 'compras' ? '#dc2626' : '#059669'};">
                                        ${qifCurrentTab === 'compras' ? '-' : '+'}${formatCurrency(t.total)}
                                    </span>
                                </div>
                                <div style="font-size: 0.8rem; color: #666; margin-top: 0.25rem;">
                                    ${fecha} | ${t.animales.length} animal${t.animales.length !== 1 ? 'es' : ''}: ${t.animales.map(a => '#' + a.numero).join(', ')}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
            updateQifSelectedCount();
        }

        function toggleQifTransaction(type, idx) {
            qifTransactions[type][idx].selected = !qifTransactions[type][idx].selected;
            renderQifTransactions();
        }

        function toggleQifSelectAll() {
            const selectAll = document.getElementById('qifSelectAll').checked;
            const transactions = qifCurrentTab === 'compras' ? qifTransactions.compras : qifTransactions.ventas;

            transactions.forEach(t => t.selected = selectAll);
            renderQifTransactions();
        }

        function updateQifSelectedCount() {
            const comprasSelected = qifTransactions.compras.filter(t => t.selected).length;
            const ventasSelected = qifTransactions.ventas.filter(t => t.selected).length;
            const total = comprasSelected + ventasSelected;

            document.getElementById('qifSelectedCount').textContent = `${total} seleccionados`;

            // Update select all checkbox
            const currentTransactions = qifCurrentTab === 'compras' ? qifTransactions.compras : qifTransactions.ventas;
            const allSelected = currentTransactions.length > 0 && currentTransactions.every(t => t.selected);
            document.getElementById('qifSelectAll').checked = allSelected;
        }

        function formatQifDate(dateStr) {
            // QIF format: MM/DD/YYYY or M/D/YYYY
            const d = new Date(dateStr);
            return `${d.getMonth() + 1}/${d.getDate()}/${d.getFullYear()}`;
        }

        function exportToQIF() {
            const selectedCompras = qifTransactions.compras.filter(t => t.selected);
            const selectedVentas = qifTransactions.ventas.filter(t => t.selected);

            if (selectedCompras.length === 0 && selectedVentas.length === 0) {
                showToast('Seleccione al menos una transacci√≥n', 'warning');
                return;
            }

            // Build QIF content
            let qifContent = '';

            // Add purchases (expenses)
            if (selectedCompras.length > 0) {
                qifContent += '!Type:Cash\n';
                selectedCompras.forEach(t => {
                    const animalesList = t.animales.map(a => `#${a.numero}(${a.peso}kg)`).join(', ');
                    qifContent += `D${formatQifDate(t.fecha)}\n`;
                    qifContent += `T-${t.total.toFixed(2)}\n`;
                    qifContent += `PCompra Ganado - ${t.vendedor}\n`;
                    qifContent += `M${t.animales.length} animales: ${animalesList}\n`;
                    qifContent += `LGanado:Compras\n`;
                    qifContent += `^\n`;
                });
            }

            // Add sales (income)
            if (selectedVentas.length > 0) {
                if (selectedCompras.length > 0) {
                    qifContent += '\n';
                }
                qifContent += '!Type:Cash\n';
                selectedVentas.forEach(t => {
                    const animalesList = t.animales.map(a => `#${a.numero}(${a.peso}kg)`).join(', ');
                    qifContent += `D${formatQifDate(t.fecha)}\n`;
                    qifContent += `T${t.total.toFixed(2)}\n`;
                    qifContent += `PVenta Ganado - ${t.comprador}\n`;
                    qifContent += `M${t.animales.length} animales: ${animalesList}\n`;
                    qifContent += `LGanado:Ventas\n`;
                    qifContent += `^\n`;
                });
            }

            // Download file
            const blob = new Blob([qifContent], { type: 'application/qif' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;

            const today = new Date().toISOString().split('T')[0];
            const ranchName = RANCHES[currentRanch]?.name || 'Ganado';
            a.download = `${ranchName}_Transacciones_${today}.qif`;

            a.click();
            URL.revokeObjectURL(url);

            showToast(`Exportadas ${selectedCompras.length + selectedVentas.length} transacciones a QIF`, 'success');
        }

        // Initialize QIF dates on page load
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(initQifDates, 500);
        });

        // ==================== END QIF EXPORT ====================

        // ==================== BREEDING MODULE (CR√çA) - SAN FERNANDO ====================

        let currentCriaSection = 'vacas';
        const GESTATION_DAYS = 283; // Days for cattle gestation

        // Show/hide Cr√≠a tab based on current ranch
        function updateCriaTabVisibility() {
            const criaTab = document.getElementById('tabCria');
            if (criaTab) {
                criaTab.style.display = (currentRanch === 'san_fernando') ? 'flex' : 'none';
            }

            // Show/hide San Fernando test data section in config
            const testDataSection = document.getElementById('sanFernandoTestDataSection');
            if (testDataSection) {
                testDataSection.style.display = (currentRanch === 'san_fernando') ? 'block' : 'none';
            }
        }

        // Switch between Cr√≠a sub-sections
        function showCriaSection(section) {
            currentCriaSection = section;

            // Update buttons
            document.getElementById('criaBtnVacas').className = section === 'vacas' ? 'btn' : 'btn btn-secondary';
            document.getElementById('criaBtnVacas').style.background = section === 'vacas' ? '#0ea5e9' : '';
            document.getElementById('criaBtnVacas').style.color = section === 'vacas' ? 'white' : '';

            document.getElementById('criaBtnServicios').className = section === 'servicios' ? 'btn' : 'btn btn-secondary';
            document.getElementById('criaBtnServicios').style.background = section === 'servicios' ? '#0ea5e9' : '';
            document.getElementById('criaBtnServicios').style.color = section === 'servicios' ? 'white' : '';

            document.getElementById('criaBtnDiagnosticos').className = section === 'diagnosticos' ? 'btn' : 'btn btn-secondary';
            document.getElementById('criaBtnDiagnosticos').style.background = section === 'diagnosticos' ? '#0ea5e9' : '';
            document.getElementById('criaBtnDiagnosticos').style.color = section === 'diagnosticos' ? 'white' : '';

            document.getElementById('criaBtnCrias').className = section === 'crias' ? 'btn' : 'btn btn-secondary';
            document.getElementById('criaBtnCrias').style.background = section === 'crias' ? '#0ea5e9' : '';
            document.getElementById('criaBtnCrias').style.color = section === 'crias' ? 'white' : '';

            // Show/hide sections
            document.getElementById('cria-section-vacas').style.display = section === 'vacas' ? 'block' : 'none';
            document.getElementById('cria-section-crias').style.display = section === 'crias' ? 'block' : 'none';
            document.getElementById('cria-section-servicios').style.display = section === 'servicios' ? 'block' : 'none';
            document.getElementById('cria-section-diagnosticos').style.display = section === 'diagnosticos' ? 'block' : 'none';

            // Refresh the section data
            if (section === 'vacas') renderCriaVacas();
            else if (section === 'crias') renderCriaCrias();
            else if (section === 'servicios') renderCriaServicios();
            else if (section === 'diagnosticos') renderCriaDiagnosticos();
        }

        // Calculate reproductive status for a cow
        function getReproductiveStatus(vacaNumero) {
            const now = new Date();

            // Check if lactating (has calf under 60 days old)
            const recentCalf = data.entradas.find(e =>
                e.numeroVaca === vacaNumero &&
                e.fechaEntrada &&
                ((now - new Date(e.fechaEntrada)) / (1000 * 60 * 60 * 24)) < 60
            );
            if (recentCalf) {
                return { status: 'lactando', label: 'üçº Lactando', color: '#10b981', detail: `Cr√≠a #${recentCalf.numero}` };
            }

            // Get most recent service for this cow
            const servicios = (data.servicios || [])
                .filter(s => s.vacaNumero === vacaNumero)
                .sort((a, b) => new Date(b.fecha) - new Date(a.fecha));

            const lastServicio = servicios[0];

            if (!lastServicio) {
                return { status: 'vacia', label: 'üîµ Vac√≠a', color: '#3b82f6', detail: 'Sin servicio registrado' };
            }

            // Get most recent diagnostic for this cow (after last service)
            const diagnosticos = (data.diagnosticos || [])
                .filter(d => d.vacaNumero === vacaNumero && new Date(d.fecha) >= new Date(lastServicio.fecha))
                .sort((a, b) => new Date(b.fecha) - new Date(a.fecha));

            const lastDiagnostico = diagnosticos[0];

            if (lastDiagnostico) {
                if (lastDiagnostico.resultado === 'prenada') {
                    // Calculate expected calving date
                    const servicioDate = new Date(lastServicio.fecha);
                    const expectedCalving = new Date(servicioDate);
                    expectedCalving.setDate(expectedCalving.getDate() + GESTATION_DAYS);

                    const daysToCalving = Math.ceil((expectedCalving - now) / (1000 * 60 * 60 * 24));

                    if (daysToCalving <= 30 && daysToCalving > 0) {
                        return {
                            status: 'proxima_parto',
                            label: '‚è∞ Pr√≥xima a parir',
                            color: '#f59e0b',
                            detail: `Parto esperado: ${expectedCalving.toLocaleDateString('es-CO')} (${daysToCalving} d√≠as)`
                        };
                    }

                    const diasGestacion = Math.floor((now - servicioDate) / (1000 * 60 * 60 * 24));
                    return {
                        status: 'prenada',
                        label: 'ü§∞ Pre√±ada',
                        color: '#ec4899',
                        detail: `${diasGestacion} d√≠as de gestaci√≥n`
                    };
                } else if (lastDiagnostico.resultado === 'vacia' || lastDiagnostico.resultado === 'reabsorcion') {
                    return { status: 'vacia', label: 'üîµ Vac√≠a', color: '#3b82f6', detail: `Diagn√≥stico: ${lastDiagnostico.resultado}` };
                }
            }

            // Serviced but not yet diagnosed
            const daysSinceService = Math.floor((now - new Date(lastServicio.fecha)) / (1000 * 60 * 60 * 24));
            return {
                status: 'servida',
                label: 'üíï Servida',
                color: '#8b5cf6',
                detail: `Hace ${daysSinceService} d√≠as - Pendiente diagn√≥stico`
            };
        }

        // Get all breeding cows (HEMBRA in inventory)
        function getBreedingCows() {
            return getInventario().filter(animal => animal.sexo === 'HEMBRA');
        }

        // Render the Vacas section
        function renderCriaVacas() {
            if (currentRanch !== 'san_fernando') return;

            const vacas = getBreedingCows();
            const filter = document.getElementById('criaVacasFilter')?.value || 'todas';

            // Calculate stats
            let totalPrenadas = 0, totalLactando = 0, totalProximas = 0;

            const vacasWithStatus = vacas.map(vaca => {
                const status = getReproductiveStatus(vaca.numero);
                if (status.status === 'prenada') totalPrenadas++;
                if (status.status === 'lactando') totalLactando++;
                if (status.status === 'proxima_parto') { totalPrenadas++; totalProximas++; }
                return { ...vaca, reproStatus: status };
            });

            // Update summary cards
            document.getElementById('criaTotalVacas').textContent = vacas.length;
            document.getElementById('criaTotalPrenadas').textContent = totalPrenadas;
            document.getElementById('criaTotalLactando').textContent = totalLactando;
            document.getElementById('criaTotalProximas').textContent = totalProximas;

            // Filter vacas
            let filteredVacas = vacasWithStatus;
            if (filter !== 'todas') {
                filteredVacas = vacasWithStatus.filter(v => v.reproStatus.status === filter);
            }

            // Render list
            const container = document.getElementById('criaVacasList');
            if (filteredVacas.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: #666;">
                        <div style="font-size: 3rem; margin-bottom: 0.5rem;">üêÑ</div>
                        <p>${filter === 'todas' ? 'No hay vacas registradas en San Fernando' : 'No hay vacas con este estado'}</p>
                        <p style="font-size: 0.85rem;">Agregue animales hembra en la pesta√±a "Entradas"</p>
                    </div>
                `;
                return;
            }

            let html = '';
            filteredVacas.forEach(vaca => {
                const status = vaca.reproStatus;
                html += `
                    <div style="background: white; border-radius: 8px; padding: 0.75rem; margin-bottom: 0.5rem; border-left: 4px solid ${status.color}; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 0.5rem;">
                            <div>
                                <strong style="font-size: 1.1rem;">#${vaca.numero}</strong>
                                <span style="color: #666; margin-left: 0.5rem;">${vaca.raza || 'Sin raza'}</span>
                            </div>
                            <span style="background: ${status.color}; color: white; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.85rem;">
                                ${status.label}
                            </span>
                        </div>
                        <div style="color: #666; font-size: 0.85rem; margin-top: 0.25rem;">
                            ${status.detail}
                        </div>
                        <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem; flex-wrap: wrap;">
                            <button onclick="showRegistrarServicioModal('${vaca.numero}')" class="btn btn-secondary" style="font-size: 0.75rem; padding: 0.25rem 0.5rem;">
                                üíï Servicio
                            </button>
                            <button onclick="showRegistrarDiagnosticoModal('${vaca.numero}')" class="btn btn-secondary" style="font-size: 0.75rem; padding: 0.25rem 0.5rem;">
                                üîç Diagn√≥stico
                            </button>
                            <button onclick="showAnimalProfile('${vaca.numero}')" class="btn btn-secondary" style="font-size: 0.75rem; padding: 0.25rem 0.5rem;">
                                üìã Perfil
                            </button>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // Render the Servicios section
        function renderCriaServicios() {
            if (currentRanch !== 'san_fernando') return;

            const servicios = data.servicios || [];
            const toros = data.toros || [];

            // Update stats
            const montaNatural = servicios.filter(s => s.tipo === 'monta_natural').length;
            const inseminacion = servicios.filter(s => s.tipo === 'inseminacion').length;

            // Count pending diagnostics (services 60-90 days ago without diagnosis)
            const now = new Date();
            let pendienteDiagnostico = 0;
            servicios.forEach(s => {
                const daysSince = Math.floor((now - new Date(s.fecha)) / (1000 * 60 * 60 * 24));
                if (daysSince >= 60 && daysSince <= 120) {
                    const hasDiag = (data.diagnosticos || []).some(d =>
                        d.vacaNumero === s.vacaNumero &&
                        new Date(d.fecha) >= new Date(s.fecha)
                    );
                    if (!hasDiag) pendienteDiagnostico++;
                }
            });

            document.getElementById('criaTotalServicios').textContent = servicios.length;
            document.getElementById('criaTotalMontaNatural').textContent = montaNatural;
            document.getElementById('criaTotalIA').textContent = inseminacion;
            document.getElementById('criaPendienteDiagnostico').textContent = pendienteDiagnostico;

            // Render toros list
            const torosContainer = document.getElementById('criaTorosList');
            if (toros.length === 0) {
                torosContainer.innerHTML = '<div style="text-align: center; padding: 1rem; color: #666;"><p>No hay toros registrados</p></div>';
            } else {
                let torosHtml = '<div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">';
                toros.forEach(toro => {
                    const serviciosCount = servicios.filter(s => s.toroNumero === toro.numero).length;
                    torosHtml += `
                        <div style="background: #f3e8ff; border-radius: 8px; padding: 0.5rem 0.75rem; border: 1px solid #8b5cf6;">
                            <strong>üêÇ ${toro.numero}</strong> ${toro.nombre ? `(${toro.nombre})` : ''}
                            <span style="font-size: 0.8rem; color: #666;"> | ${toro.raza || 'N/A'} | ${serviciosCount} servicios</span>
                        </div>
                    `;
                });
                torosHtml += '</div>';
                torosContainer.innerHTML = torosHtml;
            }

            // Render servicios history
            const serviciosContainer = document.getElementById('criaServiciosList');
            if (servicios.length === 0) {
                serviciosContainer.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: #666;">
                        <div style="font-size: 2rem; margin-bottom: 0.5rem;">üíï</div>
                        <p>No hay servicios registrados</p>
                    </div>
                `;
            } else {
                const sortedServicios = [...servicios].sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
                let html = '';
                sortedServicios.forEach(s => {
                    const fecha = new Date(s.fecha).toLocaleDateString('es-CO');
                    const expectedCalving = new Date(s.fecha);
                    expectedCalving.setDate(expectedCalving.getDate() + GESTATION_DAYS);
                    const tipoLabel = s.tipo === 'monta_natural' ? 'üêÇ Monta Natural' : 'üíâ Inseminaci√≥n';
                    const toroInfo = s.tipo === 'monta_natural' ? `Toro: ${s.toroNumero}` : `Semen: ${s.semenId || 'N/A'}`;

                    html += `
                        <div style="background: white; border-radius: 8px; padding: 0.75rem; margin-bottom: 0.5rem; border-left: 4px solid #ec4899; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap;">
                                <strong>Vaca #${s.vacaNumero}</strong>
                                <span style="font-size: 0.85rem; color: #666;">${fecha}</span>
                            </div>
                            <div style="font-size: 0.85rem; color: #666; margin-top: 0.25rem;">
                                ${tipoLabel} | ${toroInfo}
                            </div>
                            <div style="font-size: 0.8rem; color: #ec4899; margin-top: 0.25rem;">
                                Parto esperado: ${expectedCalving.toLocaleDateString('es-CO')}
                            </div>
                        </div>
                    `;
                });
                serviciosContainer.innerHTML = html;
            }
        }

        // Render the Diagn√≥sticos section
        function renderCriaDiagnosticos() {
            if (currentRanch !== 'san_fernando') return;

            const diagnosticos = data.diagnosticos || [];
            const servicios = data.servicios || [];

            // Calculate stats
            const prenadas = diagnosticos.filter(d => d.resultado === 'prenada').length;
            const vacias = diagnosticos.filter(d => d.resultado === 'vacia').length;
            const reabsorcion = diagnosticos.filter(d => d.resultado === 'reabsorcion').length;

            document.getElementById('criaDiagPrenadas').textContent = prenadas;
            document.getElementById('criaDiagVacias').textContent = vacias;
            document.getElementById('criaDiagReabsorcion').textContent = reabsorcion;

            // Find pending diagnostics
            const now = new Date();
            const pendingList = [];
            servicios.forEach(s => {
                const daysSince = Math.floor((now - new Date(s.fecha)) / (1000 * 60 * 60 * 24));
                if (daysSince >= 60 && daysSince <= 120) {
                    const hasDiag = diagnosticos.some(d =>
                        d.vacaNumero === s.vacaNumero &&
                        new Date(d.fecha) >= new Date(s.fecha)
                    );
                    if (!hasDiag) {
                        pendingList.push({ vacaNumero: s.vacaNumero, daysSince, servicioFecha: s.fecha });
                    }
                }
            });

            const alertEl = document.getElementById('criaPendingDiagnosticsAlert');
            const pendingListEl = document.getElementById('criaPendingDiagnosticsList');

            if (pendingList.length > 0) {
                alertEl.style.display = 'block';
                let pendingHtml = '';
                pendingList.forEach(p => {
                    pendingHtml += `
                        <span style="display: inline-flex; align-items: center; gap: 0.25rem; background: white; padding: 0.25rem 0.5rem; border-radius: 6px; margin: 0.25rem; font-size: 0.85rem; cursor: pointer;" onclick="showRegistrarDiagnosticoModal('${p.vacaNumero}')">
                            üêÑ #${p.vacaNumero} <span style="color: #666;">(${p.daysSince} d√≠as)</span>
                        </span>
                    `;
                });
                pendingListEl.innerHTML = pendingHtml;
            } else {
                alertEl.style.display = 'none';
            }

            // Render diagnostics history
            const container = document.getElementById('criaDiagnosticosList');
            if (diagnosticos.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: #666;">
                        <div style="font-size: 2rem; margin-bottom: 0.5rem;">üîç</div>
                        <p>No hay diagn√≥sticos registrados</p>
                    </div>
                `;
            } else {
                const sortedDiag = [...diagnosticos].sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
                let html = '';
                sortedDiag.forEach(d => {
                    const fecha = new Date(d.fecha).toLocaleDateString('es-CO');
                    let resultColor = '#10b981';
                    let resultIcon = '‚úÖ';
                    if (d.resultado === 'vacia') { resultColor = '#ef4444'; resultIcon = '‚ùå'; }
                    if (d.resultado === 'reabsorcion') { resultColor = '#f59e0b'; resultIcon = '‚ö†Ô∏è'; }

                    html += `
                        <div style="background: white; border-radius: 8px; padding: 0.75rem; margin-bottom: 0.5rem; border-left: 4px solid ${resultColor}; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap;">
                                <strong>Vaca #${d.vacaNumero}</strong>
                                <span style="font-size: 0.85rem; color: #666;">${fecha}</span>
                            </div>
                            <div style="margin-top: 0.25rem;">
                                <span style="background: ${resultColor}; color: white; padding: 0.15rem 0.5rem; border-radius: 8px; font-size: 0.8rem;">
                                    ${resultIcon} ${d.resultado.charAt(0).toUpperCase() + d.resultado.slice(1)}
                                </span>
                                ${d.diasGestacion ? `<span style="font-size: 0.8rem; color: #666; margin-left: 0.5rem;">${d.diasGestacion} d√≠as gestaci√≥n</span>` : ''}
                            </div>
                            ${d.veterinario ? `<div style="font-size: 0.8rem; color: #666; margin-top: 0.25rem;">Veterinario: ${d.veterinario}</div>` : ''}
                        </div>
                    `;
                });
                container.innerHTML = html;
            }
        }

        // Render the Cr√≠as (offspring) section with cow-calf pairs
        function renderCriaCrias() {
            if (currentRanch !== 'san_fernando') return;

            // Get all calves (animals born from nacimiento with a mother)
            const calves = data.entradas.filter(e =>
                e.tipoEntrada === 'nacimiento' && e.numeroVaca
            );

            const now = new Date();

            // Calculate age and weaning status for each calf
            const calvesWithStatus = calves.map(calf => {
                const birthDate = new Date(calf.fechaEntrada);
                const ageInDays = Math.floor((now - birthDate) / (1000 * 60 * 60 * 24));
                const ageInMonths = Math.floor(ageInDays / 30);

                // Find the mother in inventory
                const mother = data.inventario.find(inv => inv.numero === calf.numeroVaca);

                // Determine weaning status
                let weaningStatus = 'con_madre'; // Default: with mother
                let weaningLabel = 'üçº Con madre';
                let weaningColor = '#10b981';

                if (calf.fechaDestete) {
                    weaningStatus = 'destetada';
                    weaningLabel = '‚úÖ Destetada';
                    weaningColor = '#6366f1';
                } else if (ageInDays >= 180 && ageInDays <= 270) {
                    weaningStatus = 'destete_listo';
                    weaningLabel = '‚ö†Ô∏è Lista para destete';
                    weaningColor = '#f59e0b';
                } else if (ageInDays > 270) {
                    weaningStatus = 'destete_listo';
                    weaningLabel = '‚ö†Ô∏è Destete urgente';
                    weaningColor = '#ef4444';
                }

                return {
                    ...calf,
                    mother,
                    ageInDays,
                    ageInMonths,
                    weaningStatus,
                    weaningLabel,
                    weaningColor,
                    birthDate
                };
            });

            // Calculate stats
            const totalCrias = calvesWithStatus.length;
            const conMadre = calvesWithStatus.filter(c => c.weaningStatus === 'con_madre').length;
            const listasDestete = calvesWithStatus.filter(c => c.weaningStatus === 'destete_listo').length;
            const destetadas = calvesWithStatus.filter(c => c.weaningStatus === 'destetada').length;

            // Update summary cards
            document.getElementById('criaTotalCrias').textContent = totalCrias;
            document.getElementById('criaCriasConMadre').textContent = conMadre;
            document.getElementById('criaCriasListasDestete').textContent = listasDestete;
            document.getElementById('criaCriasDestetadas').textContent = destetadas;

            // Show weaning alert if there are calves ready
            const weaningAlert = document.getElementById('criaWeaningAlert');
            const weaningAlertList = document.getElementById('criaWeaningAlertList');
            const weaningReady = calvesWithStatus.filter(c => c.weaningStatus === 'destete_listo');

            if (weaningReady.length > 0) {
                weaningAlert.style.display = 'block';
                let alertHtml = '';
                weaningReady.forEach(c => {
                    const urgentStyle = c.ageInDays > 270 ? 'background: #fef2f2; border: 1px solid #ef4444;' : 'background: white;';
                    alertHtml += `
                        <span style="display: inline-flex; align-items: center; gap: 0.25rem; ${urgentStyle} padding: 0.25rem 0.5rem; border-radius: 6px; font-size: 0.85rem; cursor: pointer;" onclick="showRegistrarDesteteModal('${c.numero}')">
                            üêÆ #${c.numero} <span style="color: #666;">(${c.ageInMonths} meses)</span>
                        </span>
                    `;
                });
                weaningAlertList.innerHTML = alertHtml;
            } else {
                weaningAlert.style.display = 'none';
            }

            // Apply filter
            const filter = document.getElementById('criaCriasFilter').value;
            let filteredCalves = calvesWithStatus;

            if (filter === 'con_madre') {
                filteredCalves = calvesWithStatus.filter(c => c.weaningStatus === 'con_madre');
            } else if (filter === 'destete_listo') {
                filteredCalves = calvesWithStatus.filter(c => c.weaningStatus === 'destete_listo');
            } else if (filter === 'destetadas') {
                filteredCalves = calvesWithStatus.filter(c => c.weaningStatus === 'destetada');
            } else if (filter === 'machos') {
                filteredCalves = calvesWithStatus.filter(c => c.sexo === 'MACHO');
            } else if (filter === 'hembras') {
                filteredCalves = calvesWithStatus.filter(c => c.sexo === 'HEMBRA');
            }

            // Sort by age (youngest first)
            filteredCalves.sort((a, b) => b.birthDate - a.birthDate);

            // Render cow-calf pairs
            const container = document.getElementById('criaCriasList');

            if (filteredCalves.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: #666;">
                        <div style="font-size: 3rem; margin-bottom: 0.5rem;">üêÆ</div>
                        <p>No hay cr√≠as ${filter !== 'todas' ? 'con este filtro' : 'registradas en San Fernando'}</p>
                        <p style="font-size: 0.85rem;">Registre nacimientos en la pesta√±a "Entradas" ‚Üí "Nacimiento"</p>
                    </div>
                `;
                return;
            }

            let html = '';
            filteredCalves.forEach(calf => {
                const birthDateStr = calf.birthDate.toLocaleDateString('es-CO');
                const sexIcon = calf.sexo === 'MACHO' ? '‚ôÇÔ∏è' : '‚ôÄÔ∏è';
                const sexColor = calf.sexo === 'MACHO' ? '#3b82f6' : '#ec4899';

                // Mother info
                const motherInfo = calf.mother
                    ? `üêÑ Madre: #${calf.mother.numero} ${calf.mother.raza ? `(${calf.mother.raza})` : ''}`
                    : `üêÑ Madre: #${calf.numeroVaca} (no encontrada en inventario)`;

                // Weaning info
                let weaningInfo = '';
                if (calf.fechaDestete) {
                    const desteteDate = new Date(calf.fechaDestete).toLocaleDateString('es-CO');
                    weaningInfo = `<div style="font-size: 0.8rem; color: #666; margin-top: 0.25rem;">Destetada: ${desteteDate} ${calf.pesoDestete ? `| Peso: ${calf.pesoDestete} kg` : ''}</div>`;
                }

                html += `
                    <div style="background: white; border-radius: 10px; padding: 1rem; margin-bottom: 0.75rem; border-left: 4px solid ${calf.weaningColor}; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 0.5rem;">
                            <div>
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <span style="font-size: 1.2rem;">üêÆ</span>
                                    <strong style="font-size: 1.1rem;">Cr√≠a #${calf.numero}</strong>
                                    <span style="color: ${sexColor}; font-size: 1.1rem;">${sexIcon}</span>
                                    <span style="background: ${calf.weaningColor}; color: white; padding: 0.15rem 0.5rem; border-radius: 8px; font-size: 0.75rem;">
                                        ${calf.weaningLabel}
                                    </span>
                                </div>
                                <div style="font-size: 0.85rem; color: #666; margin-top: 0.25rem;">
                                    ${motherInfo}
                                </div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-weight: bold; color: #0284c7;">${calf.ageInMonths} meses</div>
                                <div style="font-size: 0.8rem; color: #666;">${calf.ageInDays} d√≠as</div>
                            </div>
                        </div>
                        <div style="margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px solid #e5e7eb;">
                            <div style="display: flex; flex-wrap: wrap; gap: 1rem; font-size: 0.85rem; color: #666;">
                                <span>üìÖ Nacimiento: ${birthDateStr}</span>
                                ${calf.raza ? `<span>üè∑Ô∏è Raza: ${calf.raza}</span>` : ''}
                                ${calf.peso ? `<span>‚öñÔ∏è Peso nac.: ${calf.peso} kg</span>` : ''}
                            </div>
                            ${weaningInfo}
                        </div>
                        ${calf.weaningStatus === 'destete_listo' ? `
                            <div style="margin-top: 0.75rem;">
                                <button onclick="showRegistrarDesteteModal('${calf.numero}')" class="btn" style="background: #f59e0b; color: white; padding: 0.4rem 0.75rem; font-size: 0.85rem;">
                                    üçº‚û°Ô∏è Registrar Destete
                                </button>
                            </div>
                        ` : ''}
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // Show modal to register weaning
        function showRegistrarDesteteModal(calfNumero = '') {
            // Get calves that can be weaned (not yet weaned)
            const calves = data.entradas.filter(e =>
                e.tipoEntrada === 'nacimiento' &&
                e.numeroVaca &&
                !e.fechaDestete
            );

            const now = new Date();
            const calvesWithAge = calves.map(c => {
                const birthDate = new Date(c.fechaEntrada);
                const ageInDays = Math.floor((now - birthDate) / (1000 * 60 * 60 * 24));
                return { ...c, ageInDays };
            }).sort((a, b) => b.ageInDays - a.ageInDays); // Oldest first

            let calvesOptions = '<option value="">-- Seleccionar Cr√≠a --</option>';
            calvesWithAge.forEach(c => {
                const selected = c.numero === calfNumero ? 'selected' : '';
                const ageMonths = Math.floor(c.ageInDays / 30);
                const urgentBadge = c.ageInDays >= 180 ? ' ‚ö†Ô∏è' : '';
                calvesOptions += `<option value="${c.numero}" ${selected}>#${c.numero} - ${ageMonths} meses (madre: #${c.numeroVaca})${urgentBadge}</option>`;
            });

            const today = new Date().toISOString().split('T')[0];

            showModal(`
                <h3 style="margin-top: 0; color: #f59e0b;">üçº‚û°Ô∏è Registrar Destete</h3>
                <form id="desteteForm" onsubmit="guardarDestete(event)">
                    <div class="form-group">
                        <label>Cr√≠a a destetar *</label>
                        <select id="desteteCalfNumero" required class="form-input">
                            ${calvesOptions}
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Fecha de destete *</label>
                        <input type="date" id="desteteFecha" required class="form-input" value="${today}">
                    </div>
                    <div class="form-group">
                        <label>Peso al destete (kg)</label>
                        <input type="number" id="destetePeso" class="form-input" placeholder="ej: 180" step="0.1" min="50" max="400">
                    </div>
                    <div class="form-group">
                        <label>Observaciones</label>
                        <textarea id="desteteObservaciones" class="form-input" rows="2" placeholder="ej: Buen estado, destete gradual..."></textarea>
                    </div>
                    <div style="display: flex; gap: 0.5rem; justify-content: flex-end; margin-top: 1rem;">
                        <button type="button" onclick="closeModal()" class="btn btn-secondary">Cancelar</button>
                        <button type="submit" class="btn" style="background: #f59e0b; color: white;">üíæ Guardar Destete</button>
                    </div>
                </form>
            `);
        }

        // Save weaning record
        function guardarDestete(event) {
            event.preventDefault();

            const calfNumero = document.getElementById('desteteCalfNumero').value;
            const fecha = document.getElementById('desteteFecha').value;
            const peso = document.getElementById('destetePeso').value;
            const observaciones = document.getElementById('desteteObservaciones').value;

            if (!calfNumero || !fecha) {
                showNotification('Por favor seleccione la cr√≠a y fecha', 'error');
                return;
            }

            // Find the calf entry and update it
            const calfIndex = data.entradas.findIndex(e => e.numero === calfNumero);
            if (calfIndex === -1) {
                showNotification('Cr√≠a no encontrada', 'error');
                return;
            }

            // Update the entry with weaning data
            data.entradas[calfIndex].fechaDestete = fecha;
            if (peso) data.entradas[calfIndex].pesoDestete = parseFloat(peso);
            if (observaciones) data.entradas[calfIndex].observacionesDestete = observaciones;

            saveData();
            closeModal();
            renderCriaCrias();
            showNotification(`‚úÖ Destete registrado para cr√≠a #${calfNumero}`, 'success');
        }

        // Show modal to register a new servicio (breeding event)
        function showRegistrarServicioModal(vacaNumero = '') {
            const vacas = getBreedingCows();
            const toros = data.toros || [];

            let vacasOptions = '<option value="">-- Seleccionar Vaca --</option>';
            vacas.forEach(v => {
                const selected = v.numero === vacaNumero ? 'selected' : '';
                vacasOptions += `<option value="${v.numero}" ${selected}>#${v.numero} - ${v.raza || 'Sin raza'}</option>`;
            });

            let torosOptions = '<option value="">-- Seleccionar Toro --</option>';
            toros.forEach(t => {
                torosOptions += `<option value="${t.numero}">${t.numero} - ${t.nombre || t.raza || 'N/A'}</option>`;
            });

            const today = new Date().toISOString().split('T')[0];

            const modalHtml = `
                <div id="servicioModal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000; padding: 1rem;">
                    <div style="background: white; border-radius: 12px; max-width: 500px; width: 100%; max-height: 90vh; overflow-y: auto;">
                        <div style="background: linear-gradient(135deg, #ec4899, #be185d); color: white; padding: 1rem; border-radius: 12px 12px 0 0;">
                            <h3 style="margin: 0;">üíï Registrar Servicio</h3>
                        </div>
                        <div style="padding: 1rem;">
                            <div class="form-group">
                                <label class="form-label">Vaca *</label>
                                <select id="servicioVaca" class="form-input" required>${vacasOptions}</select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Fecha del Servicio *</label>
                                <input type="date" id="servicioFecha" class="form-input" value="${today}" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Tipo de Servicio *</label>
                                <select id="servicioTipo" class="form-input" onchange="toggleServicioFields()" required>
                                    <option value="monta_natural">üêÇ Monta Natural</option>
                                    <option value="inseminacion">üíâ Inseminaci√≥n Artificial</option>
                                </select>
                            </div>
                            <div id="servicioToroField" class="form-group">
                                <label class="form-label">Toro *</label>
                                <select id="servicioToro" class="form-input">${torosOptions}</select>
                                <small style="color: #666;">¬øNo est√° el toro? <a href="#" onclick="closeServicioModal(); showRegistrarToroModal(); return false;">Agregar nuevo toro</a></small>
                            </div>
                            <div id="servicioIAFields" style="display: none;">
                                <div class="form-group">
                                    <label class="form-label">ID del Semen</label>
                                    <input type="text" id="servicioSemenId" class="form-input" placeholder="Ej: BRAHMAN-001">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">T√©cnico</label>
                                    <input type="text" id="servicioTecnico" class="form-input" placeholder="Nombre del t√©cnico">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Observaciones</label>
                                <textarea id="servicioObservaciones" class="form-input" rows="2" placeholder="Observaciones adicionales..."></textarea>
                            </div>
                            <div style="display: flex; gap: 0.5rem; justify-content: flex-end; margin-top: 1rem;">
                                <button onclick="closeServicioModal()" class="btn btn-secondary">Cancelar</button>
                                <button onclick="saveServicio()" class="btn" style="background: #ec4899; color: white;">üíï Guardar Servicio</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        function toggleServicioFields() {
            const tipo = document.getElementById('servicioTipo').value;
            document.getElementById('servicioToroField').style.display = tipo === 'monta_natural' ? 'block' : 'none';
            document.getElementById('servicioIAFields').style.display = tipo === 'inseminacion' ? 'block' : 'none';
        }

        function closeServicioModal() {
            const modal = document.getElementById('servicioModal');
            if (modal) modal.remove();
        }

        function saveServicio() {
            const vacaNumero = document.getElementById('servicioVaca').value;
            const fecha = document.getElementById('servicioFecha').value;
            const tipo = document.getElementById('servicioTipo').value;

            if (!vacaNumero || !fecha) {
                showToast('Complete los campos obligatorios', 'warning');
                return;
            }

            if (tipo === 'monta_natural' && !document.getElementById('servicioToro').value) {
                showToast('Seleccione un toro para monta natural', 'warning');
                return;
            }

            const servicio = {
                id: 'srv_' + Date.now(),
                vacaNumero,
                fecha,
                tipo,
                toroNumero: tipo === 'monta_natural' ? document.getElementById('servicioToro').value : null,
                semenId: tipo === 'inseminacion' ? document.getElementById('servicioSemenId').value : null,
                tecnico: tipo === 'inseminacion' ? document.getElementById('servicioTecnico').value : null,
                observaciones: document.getElementById('servicioObservaciones').value,
                fechaEsperadaParto: (() => {
                    const d = new Date(fecha);
                    d.setDate(d.getDate() + GESTATION_DAYS);
                    return d.toISOString().split('T')[0];
                })()
            };

            if (!data.servicios) data.servicios = [];
            data.servicios.push(servicio);
            saveData();

            closeServicioModal();
            showToast('üíï Servicio registrado exitosamente', 'success');

            // Refresh views
            if (currentCriaSection === 'vacas') renderCriaVacas();
            else if (currentCriaSection === 'servicios') renderCriaServicios();
        }

        // Show modal to register a new toro
        function showRegistrarToroModal() {
            const modalHtml = `
                <div id="toroModal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000; padding: 1rem;">
                    <div style="background: white; border-radius: 12px; max-width: 400px; width: 100%;">
                        <div style="background: linear-gradient(135deg, #8b5cf6, #7c3aed); color: white; padding: 1rem; border-radius: 12px 12px 0 0;">
                            <h3 style="margin: 0;">üêÇ Agregar Toro</h3>
                        </div>
                        <div style="padding: 1rem;">
                            <div class="form-group">
                                <label class="form-label">N√∫mero/ID del Toro *</label>
                                <input type="text" id="toroNumero" class="form-input" placeholder="Ej: T-01" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Nombre (opcional)</label>
                                <input type="text" id="toroNombre" class="form-input" placeholder="Ej: Emperador">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Raza</label>
                                <select id="toroRaza" class="form-input">
                                    <option value="">-- Seleccionar --</option>
                                    <option value="Brahman">Brahman</option>
                                    <option value="Ceb√∫">Ceb√∫</option>
                                    <option value="Angus">Angus</option>
                                    <option value="Simmental">Simmental</option>
                                    <option value="Gyr">Gyr</option>
                                    <option value="Criollo">Criollo</option>
                                    <option value="Mestizo">Mestizo</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Peso (kg)</label>
                                <input type="number" id="toroPeso" class="form-input" placeholder="Ej: 800">
                            </div>
                            <div style="display: flex; gap: 0.5rem; justify-content: flex-end; margin-top: 1rem;">
                                <button onclick="closeToroModal()" class="btn btn-secondary">Cancelar</button>
                                <button onclick="saveToro()" class="btn" style="background: #8b5cf6; color: white;">üêÇ Guardar Toro</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        function closeToroModal() {
            const modal = document.getElementById('toroModal');
            if (modal) modal.remove();
        }

        function saveToro() {
            const numero = document.getElementById('toroNumero').value.trim();

            if (!numero) {
                showToast('Ingrese el n√∫mero del toro', 'warning');
                return;
            }

            // Check if toro already exists
            if ((data.toros || []).some(t => t.numero === numero)) {
                showToast('Ya existe un toro con ese n√∫mero', 'error');
                return;
            }

            const toro = {
                numero,
                nombre: document.getElementById('toroNombre').value.trim(),
                raza: document.getElementById('toroRaza').value,
                peso: parseFloat(document.getElementById('toroPeso').value) || null,
                estado: 'activo',
                fechaRegistro: new Date().toISOString()
            };

            if (!data.toros) data.toros = [];
            data.toros.push(toro);
            saveData();

            closeToroModal();
            showToast('üêÇ Toro registrado exitosamente', 'success');
            renderCriaServicios();
        }

        // Show modal to register pregnancy diagnosis
        function showRegistrarDiagnosticoModal(vacaNumero = '') {
            const vacas = getBreedingCows();

            let vacasOptions = '<option value="">-- Seleccionar Vaca --</option>';
            vacas.forEach(v => {
                const selected = v.numero === vacaNumero ? 'selected' : '';
                vacasOptions += `<option value="${v.numero}" ${selected}>#${v.numero} - ${v.raza || 'Sin raza'}</option>`;
            });

            const today = new Date().toISOString().split('T')[0];

            const modalHtml = `
                <div id="diagnosticoModal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000; padding: 1rem;">
                    <div style="background: white; border-radius: 12px; max-width: 450px; width: 100%;">
                        <div style="background: linear-gradient(135deg, #10b981, #059669); color: white; padding: 1rem; border-radius: 12px 12px 0 0;">
                            <h3 style="margin: 0;">üîç Registrar Diagn√≥stico de Pre√±ez</h3>
                        </div>
                        <div style="padding: 1rem;">
                            <div class="form-group">
                                <label class="form-label">Vaca *</label>
                                <select id="diagnosticoVaca" class="form-input" required>${vacasOptions}</select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Fecha del Diagn√≥stico *</label>
                                <input type="date" id="diagnosticoFecha" class="form-input" value="${today}" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Resultado *</label>
                                <select id="diagnosticoResultado" class="form-input" required>
                                    <option value="">-- Seleccionar --</option>
                                    <option value="prenada">‚úÖ Pre√±ada</option>
                                    <option value="vacia">‚ùå Vac√≠a</option>
                                    <option value="reabsorcion">‚ö†Ô∏è Reabsorci√≥n</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">D√≠as de Gestaci√≥n (si pre√±ada)</label>
                                <input type="number" id="diagnosticoDias" class="form-input" placeholder="Ej: 60">
                            </div>
                            <div class="form-group">
                                <label class="form-label">M√©todo</label>
                                <select id="diagnosticoMetodo" class="form-input">
                                    <option value="palpacion">Palpaci√≥n rectal</option>
                                    <option value="ecografia">Ecograf√≠a</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Veterinario</label>
                                <input type="text" id="diagnosticoVeterinario" class="form-input" placeholder="Nombre del veterinario">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Observaciones</label>
                                <textarea id="diagnosticoObservaciones" class="form-input" rows="2" placeholder="Observaciones..."></textarea>
                            </div>
                            <div style="display: flex; gap: 0.5rem; justify-content: flex-end; margin-top: 1rem;">
                                <button onclick="closeDiagnosticoModal()" class="btn btn-secondary">Cancelar</button>
                                <button onclick="saveDiagnostico()" class="btn" style="background: #10b981; color: white;">üîç Guardar Diagn√≥stico</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        function closeDiagnosticoModal() {
            const modal = document.getElementById('diagnosticoModal');
            if (modal) modal.remove();
        }

        function saveDiagnostico() {
            const vacaNumero = document.getElementById('diagnosticoVaca').value;
            const fecha = document.getElementById('diagnosticoFecha').value;
            const resultado = document.getElementById('diagnosticoResultado').value;

            if (!vacaNumero || !fecha || !resultado) {
                showToast('Complete los campos obligatorios', 'warning');
                return;
            }

            const diagnostico = {
                id: 'diag_' + Date.now(),
                vacaNumero,
                fecha,
                resultado,
                diasGestacion: parseInt(document.getElementById('diagnosticoDias').value) || null,
                metodo: document.getElementById('diagnosticoMetodo').value,
                veterinario: document.getElementById('diagnosticoVeterinario').value.trim(),
                observaciones: document.getElementById('diagnosticoObservaciones').value.trim()
            };

            if (!data.diagnosticos) data.diagnosticos = [];
            data.diagnosticos.push(diagnostico);
            saveData();

            closeDiagnosticoModal();

            const resultText = resultado === 'prenada' ? '‚úÖ Pre√±ada' : resultado === 'vacia' ? '‚ùå Vac√≠a' : '‚ö†Ô∏è Reabsorci√≥n';
            showToast(`Diagn√≥stico registrado: ${resultText}`, 'success');

            // Refresh views
            renderCriaVacas();
            renderCriaDiagnosticos();
        }

        // Update Cr√≠a views when needed
        function updateCriaViews() {
            if (currentRanch === 'san_fernando') {
                updateCriaTabVisibility();
                if (currentCriaSection === 'vacas') renderCriaVacas();
                else if (currentCriaSection === 'servicios') renderCriaServicios();
                else if (currentCriaSection === 'diagnosticos') renderCriaDiagnosticos();
            }
        }

        // ==================== END BREEDING MODULE ====================

        // ==================== CLOUD SYNC UI FUNCTIONS ====================
        async function manualSync() {
            if (typeof cloudSync === 'undefined') {
                showToast('‚ö†Ô∏è Cloud sync no est√° disponible', 'error');
                return;
            }
            
            const btn = document.getElementById('manualSyncBtn');
            const originalText = btn.innerHTML;
            
            try {
                btn.disabled = true;
                btn.innerHTML = 'üîÑ Sincronizando...';
                
                // Initialize if not already done
                if (!cloudSync.enabled) {
                    if (typeof firebaseConfig === 'undefined') {
                        showToast('‚ö†Ô∏è Configuraci√≥n de Firebase no encontrada', 'error');
                        return;
                    }
                    
                    showToast('üì° Iniciando conexi√≥n...', 'info');
                    const initialized = await cloudSync.initialize(firebaseConfig);
                    
                    if (!initialized) {
                        showToast('‚ùå Error al inicializar sincronizaci√≥n', 'error');
                        return;
                    }
                }
                
                // Now sync
                await cloudSync.syncToCloud();
                await cloudSync.syncFromCloud();
                
                showToast('‚úÖ Sincronizaci√≥n completada', 'success');
                updateSyncStatus();
            } catch (error) {
                console.error('Manual sync error:', error);
                showToast('‚ùå Error al sincronizar: ' + error.message, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        // Upload backup file directly to cloud
        async function uploadBackupToCloud() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';

            input.onchange = async function(e) {
                const file = e.target.files[0];
                if (!file) return;

                const statusDiv = document.getElementById('backupUploadStatus');
                statusDiv.style.display = 'block';
                statusDiv.innerHTML = '<div style="padding: 1rem; background: #fef3c7; border-radius: 8px; color: #92400e;">üìñ Leyendo archivo...</div>';

                const reader = new FileReader();
                reader.onload = async function(event) {
                    try {
                        const backup = JSON.parse(event.target.result);

                        // Validate backup structure
                        if (!backup.version || !backup.ranches) {
                            throw new Error('Archivo de backup inv√°lido - debe tener version y ranches');
                        }

                        // Count animals in backup
                        let totalAnimals = 0;
                        let ranchNames = [];
                        const backupKeyMapping = {
                            'la_coruna': 'la_coruna', 'LaCoruna': 'la_coruna', 'La Coru√±a': 'la_coruna',
                            'La_Coruna': 'la_coruna', 'laCoruna': 'la_coruna', 'coruna': 'la_coruna',
                            'catalina': 'santa_catalina', 'santa_catalina': 'santa_catalina',
                            'Catalina': 'santa_catalina', 'SantaCatalina': 'santa_catalina',
                            'Santa Catalina': 'santa_catalina', 'Santa_Catalina': 'santa_catalina',
                            'la_vega': 'la_vega', 'LaVega': 'la_vega', 'La Vega': 'la_vega', 'La_Vega': 'la_vega'
                        };

                        console.log('üìã Backup ranch keys found:', Object.keys(backup.ranches));
                        Object.keys(backup.ranches).forEach(key => {
                            const ranchData = backup.ranches[key];
                            const mappedKey = backupKeyMapping[key] || key;
                            const animalCount = ranchData.data?.entradas?.length || 0;
                            console.log(`  - "${key}" ‚Üí "${mappedKey}": ${animalCount} animals`);
                            if (ranchData.data && ranchData.data.entradas) {
                                totalAnimals += ranchData.data.entradas.length;
                            }
                            ranchNames.push(ranchData.name || key);
                        });

                        statusDiv.innerHTML = `<div style="padding: 1rem; background: #dbeafe; border-radius: 8px; color: #1e40af;">
                            üìä Backup encontrado:<br>
                            <strong>${totalAnimals} animales</strong> en ${ranchNames.length} finca(s): ${ranchNames.join(', ')}
                        </div>`;

                        if (!confirm(`üì§ SUBIR BACKUP A LA NUBE\n\nEste backup contiene:\n- ${totalAnimals} animales\n- Fincas: ${ranchNames.join(', ')}\n\nEsto REEMPLAZAR√Å todos los datos en la nube y en este dispositivo.\n\n¬øContinuar?`)) {
                            statusDiv.innerHTML = '<div style="padding: 1rem; background: #fee2e2; border-radius: 8px; color: #991b1b;">‚ùå Operaci√≥n cancelada</div>';
                            return;
                        }

                        statusDiv.innerHTML = '<div style="padding: 1rem; background: #fef3c7; border-radius: 8px; color: #92400e;">üíæ Guardando datos localmente...</div>';

                        // First restore to localStorage
                        Object.keys(backup.ranches).forEach(backupRanchId => {
                            const appRanchId = backupKeyMapping[backupRanchId] || backupRanchId;
                            const ranch = RANCHES[appRanchId];
                            if (ranch) {
                                const ranchBackup = backup.ranches[backupRanchId];
                                localStorage.setItem(ranch.storageKey, JSON.stringify(ranchBackup.data));
                                console.log(`‚úÖ Restored ${backupRanchId} -> ${ranch.storageKey}`);

                                if (ranchBackup.animalPhotos) {
                                    localStorage.setItem('animalPhotos_' + appRanchId, JSON.stringify(ranchBackup.animalPhotos));
                                }
                            }
                        });

                        statusDiv.innerHTML = '<div style="padding: 1rem; background: #dbeafe; border-radius: 8px; color: #1e40af;">‚òÅÔ∏è Subiendo a Firebase...</div>';

                        // Initialize cloud sync if needed
                        if (typeof cloudSync !== 'undefined') {
                            if (!cloudSync.enabled && typeof firebaseConfig !== 'undefined') {
                                await cloudSync.initialize(firebaseConfig);
                            }

                            if (cloudSync.enabled) {
                                await cloudSync.syncToCloud();
                                statusDiv.innerHTML = `<div style="padding: 1rem; background: #d1fae5; border-radius: 8px; color: #065f46;">
                                    ‚úÖ ¬°√âxito! ${totalAnimals} animales subidos a la nube.<br>
                                    <small>La p√°gina se recargar√° en 3 segundos...</small>
                                </div>`;
                                showToast(`‚úÖ ${totalAnimals} animales subidos a la nube`, 'success');
                                setTimeout(() => location.reload(), 3000);
                            } else {
                                throw new Error('No se pudo conectar a Firebase');
                            }
                        } else {
                            throw new Error('Cloud sync no disponible');
                        }

                    } catch (error) {
                        console.error('Error uploading backup:', error);
                        statusDiv.innerHTML = `<div style="padding: 1rem; background: #fee2e2; border-radius: 8px; color: #991b1b;">‚ùå Error: ${error.message}</div>`;
                        showToast('‚ùå Error: ' + error.message, 'error');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        // Download backup from current app data
        function downloadBackupFromApp() {
            const backup = {
                version: '3.0',
                backupDate: new Date().toISOString(),
                ranches: {},
                lastRanch: localStorage.getItem('ganadoFinca_lastRanch')
            };

            Object.keys(RANCHES).forEach(ranchId => {
                const ranch = RANCHES[ranchId];
                const ranchData = localStorage.getItem(ranch.storageKey);
                const photosData = localStorage.getItem('animalPhotos_' + ranchId);

                if (ranchData) {
                    backup.ranches[ranchId] = {
                        name: ranch.name,
                        data: JSON.parse(ranchData),
                        animalPhotos: photosData ? JSON.parse(photosData) : {}
                    };
                }
            });

            const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `backup_ganado_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            showToast('üíæ Backup descargado', 'success');
        }

        // Restore from local file
        async function restoreFromLocalFile(input) {
            const file = input.files[0];
            if (!file) return;

            const statusDiv = document.getElementById('backupUploadStatus');
            statusDiv.style.display = 'block';
            statusDiv.innerHTML = '<div style="padding: 1rem; background: #fef3c7; border-radius: 8px; color: #92400e;">üìñ Leyendo archivo...</div>';

            const reader = new FileReader();
            reader.onload = async function(event) {
                try {
                    const backup = JSON.parse(event.target.result);

                    // Validate backup structure
                    if (!backup.version || !backup.ranches) {
                        throw new Error('Archivo de backup inv√°lido - debe tener version y ranches');
                    }

                    // Count animals and photos in backup
                    let totalAnimals = 0;
                    let totalPhotos = 0;
                    let ranchNames = [];

                    const backupKeyMapping = {
                        'la_coruna': 'la_coruna', 'LaCoruna': 'la_coruna', 'La Coru√±a': 'la_coruna',
                        'La_Coruna': 'la_coruna', 'laCoruna': 'la_coruna', 'coruna': 'la_coruna',
                        'catalina': 'santa_catalina', 'santa_catalina': 'santa_catalina',
                        'Catalina': 'santa_catalina', 'SantaCatalina': 'santa_catalina',
                        'Santa_Catalina': 'santa_catalina', 'santaCatalina': 'santa_catalina',
                        'la_vega': 'la_vega', 'LaVega': 'la_vega', 'La Vega': 'la_vega',
                        'La_Vega': 'la_vega', 'laVega': 'la_vega', 'vega': 'la_vega'
                    };

                    Object.entries(backup.ranches).forEach(([key, ranchData]) => {
                        const normalizedKey = backupKeyMapping[key] || key;
                        if (RANCHES[normalizedKey]) {
                            const animals = ranchData.data?.entradas?.length || 0;
                            const photos = ranchData.animalPhotos ? Object.keys(ranchData.animalPhotos).filter(k => ranchData.animalPhotos[k]?.photo).length : 0;
                            totalAnimals += animals;
                            totalPhotos += photos;
                            ranchNames.push(`${RANCHES[normalizedKey].name}: ${animals} animales, ${photos} fotos`);
                        }
                    });

                    // Confirm restore
                    const confirmMsg = `üìÇ RESTAURAR DESDE ARCHIVO\n\n` +
                        `Archivo: ${file.name}\n` +
                        `Fecha: ${backup.backupDate ? new Date(backup.backupDate).toLocaleString() : 'Desconocida'}\n\n` +
                        `Contenido:\n${ranchNames.join('\n')}\n\n` +
                        `Total: ${totalAnimals} animales, ${totalPhotos} fotos\n\n` +
                        `‚ö†Ô∏è Esto REEMPLAZAR√Å todos los datos locales actuales.\n¬øContinuar?`;

                    if (!confirm(confirmMsg)) {
                        statusDiv.innerHTML = '<div style="padding: 1rem; background: #fee2e2; border-radius: 8px; color: #991b1b;">‚ùå Restauraci√≥n cancelada</div>';
                        input.value = '';
                        return;
                    }

                    statusDiv.innerHTML = '<div style="padding: 1rem; background: #dbeafe; border-radius: 8px; color: #1e40af;">üîÑ Restaurando datos...</div>';

                    // Restore each ranch
                    Object.entries(backup.ranches).forEach(([key, ranchData]) => {
                        const normalizedKey = backupKeyMapping[key] || key;
                        if (RANCHES[normalizedKey]) {
                            const ranch = RANCHES[normalizedKey];

                            // Restore ranch data
                            if (ranchData.data) {
                                localStorage.setItem(ranch.storageKey, JSON.stringify(ranchData.data));
                            }

                            // Restore photos
                            if (ranchData.animalPhotos && Object.keys(ranchData.animalPhotos).length > 0) {
                                localStorage.setItem('animalPhotos_' + normalizedKey, JSON.stringify(ranchData.animalPhotos));
                            }
                        }
                    });

                    // Restore last ranch selection
                    if (backup.lastRanch) {
                        localStorage.setItem('ganadoFinca_lastRanch', backup.lastRanch);
                    }

                    statusDiv.innerHTML = `<div style="padding: 1rem; background: #dcfce7; border-radius: 8px; color: #166534;">
                        ‚úÖ Restauraci√≥n completada<br>
                        <strong>${totalAnimals} animales</strong> y <strong>${totalPhotos} fotos</strong> restaurados<br>
                        <small>Recargando p√°gina...</small>
                    </div>`;

                    // Sync to cloud after restore
                    if (typeof cloudSync !== 'undefined' && cloudSync.isInitialized) {
                        try {
                            await cloudSync.syncToCloud();
                            console.log('‚úÖ Restored data synced to cloud');
                        } catch (e) {
                            console.error('Error syncing restored data:', e);
                        }
                    }

                    // Reload page after 1.5 seconds
                    setTimeout(() => {
                        location.reload();
                    }, 1500);

                } catch (error) {
                    console.error('Error restoring backup:', error);
                    statusDiv.innerHTML = `<div style="padding: 1rem; background: #fee2e2; border-radius: 8px; color: #991b1b;">
                        ‚ùå Error: ${error.message}
                    </div>`;
                }
            };

            reader.onerror = function() {
                statusDiv.innerHTML = '<div style="padding: 1rem; background: #fee2e2; border-radius: 8px; color: #991b1b;">‚ùå Error leyendo archivo</div>';
            };

            reader.readAsText(file);
            input.value = ''; // Reset input
        }

        // Force upload ALL local data to cloud (overwrites cloud)
        async function forceUploadToCloud() {
            if (typeof cloudSync === 'undefined') {
                showToast('‚ö†Ô∏è Cloud sync no disponible', 'error');
                return;
            }

            const localCount = cloudSync.countLocalAnimals();
            if (localCount === 0) {
                showToast('‚ö†Ô∏è No hay datos locales para subir', 'warning');
                return;
            }

            if (!confirm(`üì§ SUBIR DATOS A LA NUBE\n\nEsto subir√° ${localCount} animales a Firebase.\nLos datos en la nube ser√°n reemplazados.\n\n¬øContinuar?`)) {
                return;
            }

            const btn = document.getElementById('forceUploadBtn');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = 'üì§ Subiendo...';

            try {
                // Initialize if needed
                if (!cloudSync.enabled && typeof firebaseConfig !== 'undefined') {
                    await cloudSync.initialize(firebaseConfig);
                }

                if (!cloudSync.enabled) {
                    throw new Error('No se pudo inicializar Firebase');
                }

                await cloudSync.syncToCloud();
                showToast(`‚úÖ ${localCount} animales subidos a la nube exitosamente`, 'success');
                updateSyncStatus();
            } catch (error) {
                console.error('Force upload error:', error);
                showToast('‚ùå Error al subir: ' + error.message, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        // Force download ALL data from cloud (overwrites local)
        async function forceDownloadFromCloud() {
            if (typeof cloudSync === 'undefined') {
                showToast('‚ö†Ô∏è Cloud sync no disponible', 'error');
                return;
            }

            if (!confirm('üì• DESCARGAR DATOS DE LA NUBE\n\nEsto descargar√° los datos de Firebase y reemplazar√° los datos locales.\n\n¬øContinuar?')) {
                return;
            }

            const btn = document.getElementById('forceDownloadBtn');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = 'üì• Descargando...';

            try {
                // Initialize if needed
                if (!cloudSync.enabled && typeof firebaseConfig !== 'undefined') {
                    await cloudSync.initialize(firebaseConfig);
                }

                if (!cloudSync.enabled) {
                    throw new Error('No se pudo inicializar Firebase');
                }

                // Force download
                const snapshot = await cloudSync.db.ref(`users/${cloudSync.userId}`).once('value');
                const cloudData = snapshot.val();

                if (!cloudData || !cloudData.ranches) {
                    showToast('‚ö†Ô∏è No hay datos en la nube', 'warning');
                    return;
                }

                const cloudCount = cloudSync.countAnimalsInData(cloudData);

                // Apply data
                Object.keys(cloudData.ranches).forEach(ranchId => {
                    const ranch = RANCHES[ranchId];
                    if (ranch) {
                        localStorage.setItem(ranch.storageKey, JSON.stringify(cloudData.ranches[ranchId]));
                    }
                });

                if (cloudData.photos) {
                    Object.keys(cloudData.photos).forEach(ranchId => {
                        localStorage.setItem('animalPhotos_' + ranchId, JSON.stringify(cloudData.photos[ranchId]));
                    });
                }

                showToast(`‚úÖ ${cloudCount} animales descargados. Recargando...`, 'success');
                setTimeout(() => location.reload(), 1500);
            } catch (error) {
                console.error('Force download error:', error);
                showToast('‚ùå Error al descargar: ' + error.message, 'error');
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        function viewSyncHistory() {
            if (typeof cloudSync === 'undefined' || !cloudSync.isInitialized) {
                showToast('‚ö†Ô∏è Cloud sync no est√° inicializado', 'error');
                return;
            }

            const history = cloudSync.getSyncHistory ? cloudSync.getSyncHistory() : [];
            
            if (history.length === 0) {
                alert('üìú HISTORIAL DE SINCRONIZACI√ìN\n\nNo hay registros de sincronizaci√≥n a√∫n.');
                return;
            }
            
            let message = 'üìú HISTORIAL DE SINCRONIZACI√ìN\n\n';
            message += '√öltimas 10 sincronizaciones:\n\n';
            
            history.slice(-10).reverse().forEach((entry, index) => {
                const date = new Date(entry.timestamp);
                const timeStr = date.toLocaleString('es-CO');
                const status = entry.success ? '‚úÖ' : '‚ùå';
                message += `${index + 1}. ${status} ${timeStr}\n`;
                if (entry.error) {
                    message += `   Error: ${entry.error}\n`;
                }
            });
            
            alert(message);
        }
        
        function toggleAutoSync() {
            if (typeof cloudSync === 'undefined') {
                showToast('‚ö†Ô∏è Cloud sync no disponible', 'error');
                return;
            }
            
            const checkbox = document.getElementById('autoSyncEnabled');
            const enabled = checkbox.checked;
            
            if (cloudSync.setAutoSync) {
                cloudSync.setAutoSync(enabled);
            }
            
            localStorage.setItem('cloudSync_autoSync', enabled ? 'true' : 'false');
            showToast(enabled ? '‚úÖ Sincronizaci√≥n autom√°tica activada' : '‚è∏Ô∏è Sincronizaci√≥n autom√°tica desactivada', 'info');
        }
        
        function updateSyncStatus() {
            // Update header indicator
            const indicatorIcon = document.getElementById('syncIndicatorIcon');
            const indicatorText = document.getElementById('syncIndicatorText');

            if (typeof cloudSync === 'undefined') {
                if (indicatorIcon) indicatorIcon.textContent = '‚ö´';
                if (indicatorText) indicatorText.textContent = 'Sin sync';
                return;
            }

            const statusEl = document.getElementById('syncStatus');
            const lastSyncEl = document.getElementById('lastSyncTime');
            const pendingEl = document.getElementById('pendingChanges');

            // Check connection status
            const isConnected = cloudSync && cloudSync.enabled && cloudSync.isInitialized;

            if (statusEl) {
                if (isConnected) {
                    statusEl.innerHTML = 'üü¢ Conectado';
                    statusEl.style.color = '#10b981';
                } else {
                    statusEl.innerHTML = '‚ö´ Desconectado';
                    statusEl.style.color = '#ef4444';
                }
            }

            // Update header indicator
            if (indicatorIcon && indicatorText) {
                if (isConnected) {
                    indicatorIcon.textContent = '‚òÅÔ∏è';
                    indicatorText.textContent = 'Sincronizado';
                    indicatorText.style.color = '#a7f3d0';
                } else {
                    indicatorIcon.textContent = '‚ö´';
                    indicatorText.textContent = 'Sin conexi√≥n';
                    indicatorText.style.color = '#fca5a5';
                }
            }

            if (lastSyncEl) {
                const lastSync = cloudSync.lastSync || localStorage.getItem('cloudSync_lastSync');
                if (lastSync) {
                    const date = new Date(lastSync);
                    const now = new Date();
                    const diff = Math.floor((now - date) / 1000);

                    let timeStr;
                    if (diff < 60) timeStr = 'hace unos segundos';
                    else if (diff < 3600) timeStr = `hace ${Math.floor(diff / 60)} minutos`;
                    else if (diff < 86400) timeStr = `hace ${Math.floor(diff / 3600)} horas`;
                    else timeStr = `hace ${Math.floor(diff / 86400)} d√≠as`;

                    lastSyncEl.textContent = timeStr;
                } else {
                    lastSyncEl.textContent = 'Nunca';
                }
            }

            if (pendingEl) {
                pendingEl.textContent = '0'; // Cloud sync handles this automatically
            }

            // Update the new sync status panel
            const syncStatusText = document.getElementById('syncStatusText');
            if (syncStatusText) {
                const lastSync = cloudSync ? (cloudSync.lastSync || localStorage.getItem('cloudSync_lastSync')) : null;
                const localCount = typeof cloudSync !== 'undefined' ? cloudSync.countLocalAnimals() : 0;
                const deviceId = localStorage.getItem('cloudSync_deviceId') || 'no generado';

                let statusHtml = '';
                if (isConnected) {
                    statusHtml += `<div style="color: #059669; font-weight: 600;">üü¢ Conectado a Firebase</div>`;
                } else {
                    statusHtml += `<div style="color: #dc2626; font-weight: 600;">‚ö´ No conectado</div>`;
                }

                statusHtml += `<div style="margin-top: 0.5rem;">üìä Animales locales: <b>${localCount}</b></div>`;

                if (lastSync) {
                    const date = new Date(lastSync);
                    const now = new Date();
                    const diff = Math.floor((now - date) / 1000);
                    let timeStr;
                    if (diff < 60) timeStr = 'hace unos segundos';
                    else if (diff < 3600) timeStr = `hace ${Math.floor(diff / 60)} min`;
                    else if (diff < 86400) timeStr = `hace ${Math.floor(diff / 3600)} horas`;
                    else timeStr = `hace ${Math.floor(diff / 86400)} d√≠as`;
                    statusHtml += `<div>üïê √öltima sync: <b>${timeStr}</b></div>`;
                } else {
                    statusHtml += `<div>üïê √öltima sync: <b>Nunca</b></div>`;
                }

                statusHtml += `<div style="font-size: 0.75rem; color: #64748b; margin-top: 0.25rem;">ID: ${deviceId.substring(0, 15)}...</div>`;
                syncStatusText.innerHTML = statusHtml;
            }
        }
        
        // Update sync status every 30 seconds
        setInterval(updateSyncStatus, 30000);

        // Update status on page load and when cloud sync is ready
        document.addEventListener('DOMContentLoaded', function() {
            // Wait a bit for cloud-sync.js to initialize
            setTimeout(updateSyncStatus, 1000);
            setTimeout(updateSyncStatus, 3000);
            setTimeout(refreshSyncDebugInfo, 2000);
        });

        async function refreshSyncDebugInfo() {
            const debugEl = document.getElementById('syncDebugInfo');
            if (!debugEl) return;

            let html = '';

            // Local data info
            const localCount = typeof cloudSync !== 'undefined' ? cloudSync.countLocalAnimals() : 0;
            const localSyncTime = localStorage.getItem('cloudSync_lastSync') || 'nunca';
            const deviceId = localStorage.getItem('cloudSync_deviceId') || 'no generado';
            const userId = localStorage.getItem('cloudSync_userId') || 'no configurado';

            html += `<div style="color: #60a5fa;">üì± <b>Este Dispositivo:</b></div>`;
            html += `<div style="margin-left: 1rem;">ID: ${deviceId.substring(0, 12)}...</div>`;
            html += `<div style="margin-left: 1rem;">Animales locales: <span style="color: #fbbf24;">${localCount}</span></div>`;
            html += `<div style="margin-left: 1rem;">√öltima sync local: ${localSyncTime === 'nunca' ? 'nunca' : new Date(localSyncTime).toLocaleString()}</div>`;
            html += `<div style="margin-left: 1rem;">User ID: ${userId}</div>`;

            // Cloud data info
            if (typeof cloudSync !== 'undefined' && cloudSync.enabled && cloudSync.db) {
                try {
                    html += `<div style="color: #60a5fa; margin-top: 0.75rem;">‚òÅÔ∏è <b>Nube (Firebase):</b></div>`;

                    const snapshot = await cloudSync.db.ref(`users/${cloudSync.userId}`).once('value');
                    const cloudData = snapshot.val();

                    if (cloudData) {
                        const cloudCount = cloudSync.countAnimalsInData(cloudData);
                        const cloudTime = cloudData.lastModified || 'desconocido';
                        const cloudDevice = cloudData.deviceId || 'desconocido';

                        html += `<div style="margin-left: 1rem;">Animales en nube: <span style="color: #fbbf24;">${cloudCount}</span></div>`;
                        html += `<div style="margin-left: 1rem;">√öltima modificaci√≥n: ${new Date(cloudTime).toLocaleString()}</div>`;
                        html += `<div style="margin-left: 1rem;">√öltimo dispositivo: ${cloudDevice.substring(0, 12)}...</div>`;

                        // Comparison
                        const localTimeMs = localSyncTime !== 'nunca' ? new Date(localSyncTime).getTime() : 0;
                        const cloudTimeMs = new Date(cloudTime).getTime();

                        html += `<div style="color: #60a5fa; margin-top: 0.75rem;">üìä <b>Comparaci√≥n:</b></div>`;
                        if (cloudTimeMs > localTimeMs) {
                            html += `<div style="margin-left: 1rem; color: #f87171;">‚ö†Ô∏è La nube tiene datos m√°s recientes</div>`;
                        } else if (cloudTimeMs < localTimeMs) {
                            html += `<div style="margin-left: 1rem; color: #fbbf24;">üì§ Tus datos locales son m√°s recientes</div>`;
                        } else {
                            html += `<div style="margin-left: 1rem; color: #4ade80;">‚úÖ Datos sincronizados</div>`;
                        }

                        if (cloudDevice === deviceId) {
                            html += `<div style="margin-left: 1rem; color: #4ade80;">‚úì √öltima actualizaci√≥n fue de este dispositivo</div>`;
                        } else {
                            html += `<div style="margin-left: 1rem; color: #fbbf24;">‚Üí √öltima actualizaci√≥n fue de otro dispositivo</div>`;
                        }
                    } else {
                        html += `<div style="margin-left: 1rem; color: #f87171;">No hay datos en la nube</div>`;
                    }
                } catch (error) {
                    html += `<div style="margin-left: 1rem; color: #f87171;">Error: ${error.message}</div>`;
                }
            } else {
                html += `<div style="color: #f87171; margin-top: 0.75rem;">‚òÅÔ∏è Cloud sync no est√° inicializado</div>`;
            }

            debugEl.innerHTML = html;
        }
        
        function clearAllData() {
            if (confirm('¬øEst√° seguro de borrar TODOS los datos? Esta acci√≥n no se puede deshacer.')) {
                if (confirm('¬øREALMENTE est√° seguro? Se perder√°n todas las entradas, salidas e inventario.')) {
                    data.entradas = [];
                    data.salidas = [];
                    saveData();
                    showToast('Todos los datos han sido borrados', 'warning');
                }
            }
        }

        // ==================== USER ID MANAGEMENT FUNCTIONS ====================

        function displayCurrentUserId() {
            const userIdDisplay = document.getElementById('currentUserIdDisplay');
            if (userIdDisplay) {
                const userId = localStorage.getItem('cloudSync_userId') || 'No configurado';
                userIdDisplay.textContent = userId;
            }
        }

        function copyUserId() {
            const userId = localStorage.getItem('cloudSync_userId');
            if (!userId) {
                showToast('‚ö†Ô∏è No hay ID de usuario configurado', 'warning');
                return;
            }

            // Try to use the Clipboard API
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(userId)
                    .then(() => {
                        showToast('‚úÖ ID copiado al portapapeles', 'success');
                    })
                    .catch(err => {
                        // Fallback for older browsers
                        fallbackCopyUserId(userId);
                    });
            } else {
                // Fallback for older browsers
                fallbackCopyUserId(userId);
            }
        }

        function fallbackCopyUserId(userId) {
            const textArea = document.createElement('textarea');
            textArea.value = userId;
            textArea.style.position = 'fixed';
            textArea.style.left = '-9999px';
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();

            try {
                document.execCommand('copy');
                showToast('‚úÖ ID copiado al portapapeles', 'success');
            } catch (err) {
                showToast('‚ùå No se pudo copiar. ID: ' + userId, 'error');
            }

            document.body.removeChild(textArea);
        }

        async function changeUserId() {
            const newUserIdInput = document.getElementById('newUserIdInput');
            const newUserId = newUserIdInput.value.trim();

            if (!newUserId) {
                showToast('‚ö†Ô∏è Por favor ingrese un ID de usuario', 'warning');
                return;
            }

            // Validate format (should start with user_)
            if (!newUserId.startsWith('user_')) {
                showToast('‚ö†Ô∏è ID inv√°lido. Debe empezar con "user_"', 'error');
                return;
            }

            const currentUserId = localStorage.getItem('cloudSync_userId');
            if (newUserId === currentUserId) {
                showToast('‚ÑπÔ∏è Ya est√°s usando ese ID', 'info');
                return;
            }

            // Confirm the change
            const confirmed = confirm(
                '‚ö†Ô∏è ADVERTENCIA\n\n' +
                'Al cambiar el ID de usuario:\n\n' +
                '1. Tus datos locales se sincronizar√°n con la nube del nuevo ID\n' +
                '2. Si el nuevo ID tiene datos, reemplazar√°n los tuyos locales\n\n' +
                '¬øDesea continuar?'
            );

            if (!confirmed) return;

            try {
                // Stop current sync if running
                if (typeof cloudSync !== 'undefined' && cloudSync.enabled) {
                    cloudSync.disable();
                }

                // Update the user ID
                localStorage.setItem('cloudSync_userId', newUserId);

                // Reinitialize cloud sync with new user ID
                if (typeof cloudSync !== 'undefined' && typeof firebaseConfig !== 'undefined') {
                    cloudSync.userId = newUserId;
                    cloudSync.enabled = false;

                    showToast('üîÑ Conectando con nuevo ID...', 'info');

                    const initialized = await cloudSync.initialize(firebaseConfig);

                    if (initialized) {
                        showToast('‚úÖ Conectado con nuevo ID. Sincronizando...', 'success');
                        await cloudSync.syncFromCloud();

                        // Offer to reload page
                        setTimeout(() => {
                            if (confirm('¬øRecargar la p√°gina para ver los datos sincronizados?')) {
                                window.location.reload();
                            }
                        }, 1000);
                    } else {
                        showToast('‚ö†Ô∏è ID cambiado pero error al conectar. Recargue la p√°gina.', 'warning');
                    }
                } else {
                    showToast('‚úÖ ID cambiado. Recargue la p√°gina para sincronizar.', 'success');
                }

                // Update display
                displayCurrentUserId();
                newUserIdInput.value = '';

            } catch (error) {
                console.error('Error changing user ID:', error);
                showToast('‚ùå Error al cambiar ID: ' + error.message, 'error');
            }
        }

        // Initialize User ID display when page loads
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(displayCurrentUserId, 500);
        });

        // ==================== PHOTO SESSION FUNCTIONS ====================
        
        // Current session photos (temporary storage before save)
        let currentSessionPhotos = [];
        let currentPhotoType = 'lateral';
        let currentChapetaPhoto = null;
        
        function updateFotosView() {
            updateFotosPendientes();
            updateFotoHistorial();
            updateFotoSummary();
            updateBCSChartSelector();
        }
        
        // ==================== CHAPETA IDENTIFICATION ====================
        
        function handleChapetaCapture(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            compressImage(file, (compressedDataUrl) => {
                currentChapetaPhoto = compressedDataUrl;
                
                // Show chapeta preview
                document.getElementById('chapetaPreview').style.display = 'block';
                document.getElementById('chapetaPhotoImg').src = compressedDataUrl;
                document.getElementById('fotoNumeroFromPhoto').value = '';
                document.getElementById('fotoNumeroFromPhoto').focus();
                
                showToast('Foto de chapeta capturada. Ingresa el n√∫mero visible.', 'info');
            });
            
            event.target.value = '';
        }
        
        function handleManualChapeta(event) {
            const input = event.target;
            const numero = input.value.trim();
            
            if (numero.length > 0) {
                validateAndShowAnimalInfo(numero);
            } else {
                hideAnimalPhotosStep();
            }
        }
        
        function validateAndShowAnimalInfo(numero) {
            const inventario = getInventario();
            const animal = inventario.find(a => String(a.numero) === String(numero));
            
            document.getElementById('fotoNumero').value = numero;
            
            const infoDisplay = document.getElementById('animalInfoDisplay');
            const numeroDisplay = document.getElementById('animalInfoNumero');
            const detailsDisplay = document.getElementById('animalInfoDetails');
            const statusDisplay = document.getElementById('animalInfoStatus');
            
            if (animal) {
                // Animal found in inventory
                const diasEnFinca = getDiasEnFinca(animal.fechaEntrada);
                const pesoEstimado = animal.peso + (diasEnFinca * data.config.gdp);
                const ultimaFoto = getUltimaFoto(numero);
                const diasSinFoto = ultimaFoto ? getDiasDesde(ultimaFoto.fecha) : null;
                
                numeroDisplay.textContent = `#${numero}`;
                detailsDisplay.innerHTML = `
                    ${animal.sexo === 'MACHO' ? '‚ôÇÔ∏è' : '‚ôÄÔ∏è'} ${animal.vendedor || 'Nacimiento'} | 
                    Peso inicial: ${animal.peso} kg | 
                    Estimado: <strong>${pesoEstimado.toFixed(0)} kg</strong> | 
                    ${diasEnFinca} d√≠as en finca
                `;
                
                if (diasSinFoto === null) {
                    statusDisplay.innerHTML = '<span class="badge badge-warning">üÜï Sin fotos previas</span>';
                } else if (diasSinFoto > 90) {
                    statusDisplay.innerHTML = `<span class="badge badge-danger">üî¥ ${diasSinFoto} d√≠as sin foto</span>`;
                } else if (diasSinFoto > 60) {
                    statusDisplay.innerHTML = `<span class="badge badge-warning">üü° ${diasSinFoto} d√≠as sin foto</span>`;
                } else {
                    statusDisplay.innerHTML = `<span class="badge badge-success">üü¢ ${diasSinFoto} d√≠as sin foto</span>`;
                }
                
                infoDisplay.style.display = 'block';
                infoDisplay.style.background = '#e8f5e9';
                
                // Pre-fill BCS if there's a previous session
                if (ultimaFoto) {
                    document.getElementById('fotoBCS').value = ultimaFoto.bcs;
                    document.getElementById('fotoPasto').value = ultimaFoto.pasto || 'bueno';
                }
                
                showAnimalPhotosStep();
            } else {
                // Animal not found - might be new or typo
                numeroDisplay.textContent = `#${numero}`;
                detailsDisplay.textContent = '‚ö†Ô∏è Animal no encontrado en inventario actual';
                statusDisplay.innerHTML = '<span class="badge badge-secondary">Verificar n√∫mero</span>';
                
                infoDisplay.style.display = 'block';
                infoDisplay.style.background = '#fff3e0';
                
                // Still allow photos (might be newly purchased)
                showAnimalPhotosStep();
            }
        }
        
        function showAnimalPhotosStep() {
            document.getElementById('animalPhotosStep').style.display = 'block';
            updatePhotosProgressIndicator();
        }
        
        function hideAnimalPhotosStep() {
            document.getElementById('animalPhotosStep').style.display = 'none';
            document.getElementById('animalInfoDisplay').style.display = 'none';
            document.getElementById('fotoNumero').value = '';
        }
        
        function clearChapetaPhoto() {
            currentChapetaPhoto = null;
            document.getElementById('chapetaPreview').style.display = 'none';
            document.getElementById('chapetaPhotoImg').src = '';
            document.getElementById('fotoNumeroFromPhoto').value = '';
            hideAnimalPhotosStep();
        }
        
        function updatePhotosProgressIndicator() {
            const indicator = document.getElementById('photosProgressIndicator');
            const text = document.getElementById('photosProgressText');
            
            const hasLateral = currentSessionPhotos.some(p => p.type === 'lateral');
            const hasTrasera = currentSessionPhotos.some(p => p.type === 'trasera');
            const hasSuperior = currentSessionPhotos.some(p => p.type === 'superior');
            const count = currentSessionPhotos.length;
            
            if (hasLateral && hasTrasera) {
                indicator.style.background = '#e8f5e9';
                text.innerHTML = `‚úÖ ${count} foto(s) - M√≠nimo alcanzado ${hasSuperior ? '(+Superior)' : ''}`;
            } else {
                indicator.style.background = '#fff3e0';
                const missing = [];
                if (!hasLateral) missing.push('Lateral');
                if (!hasTrasera) missing.push('Trasera');
                text.innerHTML = `‚ö†Ô∏è ${count} foto(s) - Falta: ${missing.join(', ')}`;
            }
        }
        
        // ==================== CAMERA FUNCTIONS ====================
        
        function setPhotoType(type) {
            currentPhotoType = type;
            document.querySelectorAll('.photo-type-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.type === type) {
                    btn.classList.add('active');
                }
            });
        }
        
        function updateReferenciaHint() {
            const tipoRef = document.querySelector('input[name="tipoReferencia"]:checked')?.value || 'ninguna';
            const hintEl = document.getElementById('referenciaHint');
            const mangaSelector = document.getElementById('mangaPositionSelector');
            const refCheckboxes = document.getElementById('referenceCheckboxes');
            const distanciaSelector = document.getElementById('distanciaSelector');
            
            // Update hint text
            const hints = {
                'manga_calibrada': '‚úÖ Barras de la manga con marcas de altura para calibraci√≥n IA',
                'vara_1m': '‚úÖ La vara de 1m permite calibraci√≥n precisa para IA',
                'chapeta_only': '‚ö†Ô∏è Solo chapeta como referencia (precisi√≥n limitada)',
                'ninguna': '‚ùå Sin referencia - estimaci√≥n de peso menos precisa'
            };
            hintEl.textContent = hints[tipoRef] || '';
            
            // Update visual styling of radio buttons
            document.querySelectorAll('input[name="tipoReferencia"]').forEach(radio => {
                const label = radio.closest('label');
                if (radio.checked) {
                    label.style.background = '#e8f5e9';
                    label.style.borderColor = 'var(--success)';
                } else {
                    label.style.background = '#f5f5f5';
                    label.style.borderColor = 'transparent';
                }
            });
            
            // Show/hide manga position selector
            if (tipoRef === 'manga_calibrada') {
                mangaSelector.style.display = 'flex';
                refCheckboxes.style.display = 'none';
                distanciaSelector.style.display = 'none';
            } else if (tipoRef === 'vara_1m') {
                mangaSelector.style.display = 'none';
                refCheckboxes.style.display = 'flex';
                distanciaSelector.style.display = 'block';
            } else {
                mangaSelector.style.display = 'none';
                refCheckboxes.style.display = 'none';
                distanciaSelector.style.display = 'none';
            }
        }
        
        function handlePhotoCapture(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Check if animal is identified
            const numero = document.getElementById('fotoNumero').value;
            if (!numero) {
                showToast('Primero identifica el animal con la chapeta', 'error');
                event.target.value = '';
                return;
            }
            
            // Compress and store the image
            compressImage(file, (compressedDataUrl) => {
                const photo = {
                    id: Date.now(),
                    type: currentPhotoType,
                    dataUrl: compressedDataUrl,
                    timestamp: new Date().toISOString()
                };
                
                currentSessionPhotos.push(photo);
                updatePhotoPreviewGrid();
                updatePhotoTypeButtons();
                updatePhotosProgressIndicator();
                
                // Update photo count
                document.getElementById('fotoNumFotos').value = currentSessionPhotos.length;
                
                showToast(`Foto ${getPhotoTypeLabel(currentPhotoType)} capturada`, 'success');
                
                // Auto-advance to next photo type
                autoAdvancePhotoType();
            });
            
            // Reset the input
            event.target.value = '';
        }
        
        function compressImage(file, callback) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    // Calculate new dimensions (max 800px on longest side)
                    const maxSize = 800;
                    let width = img.width;
                    let height = img.height;
                    
                    if (width > height) {
                        if (width > maxSize) {
                            height *= maxSize / width;
                            width = maxSize;
                        }
                    } else {
                        if (height > maxSize) {
                            width *= maxSize / height;
                            height = maxSize;
                        }
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    
                    // Draw and compress
                    ctx.drawImage(img, 0, 0, width, height);
                    const compressedDataUrl = canvas.toDataURL('image/jpeg', 0.7);
                    
                    callback(compressedDataUrl);
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }
        
        function updatePhotoPreviewGrid() {
            const grid = document.getElementById('photoPreviewGrid');
            
            if (currentSessionPhotos.length === 0) {
                grid.innerHTML = '';
                return;
            }
            
            grid.innerHTML = currentSessionPhotos.map((photo, index) => `
                <div class="photo-thumbnail" onclick="viewPhoto('${photo.dataUrl}', '${getPhotoTypeLabel(photo.type)}')">
                    <img src="${photo.dataUrl}" alt="${photo.type}">
                    <button type="button" class="delete-photo" onclick="event.stopPropagation(); deleteSessionPhoto(${index})">√ó</button>
                    <div class="photo-label">${getPhotoTypeLabel(photo.type)}</div>
                </div>
            `).join('');
        }
        
        function updatePhotoTypeButtons() {
            const types = ['lateral', 'trasera', 'superior'];
            types.forEach(type => {
                const btn = document.querySelector(`.photo-type-btn[data-type="${type}"]`);
                if (btn) {
                    const hasPhoto = currentSessionPhotos.some(p => p.type === type);
                    btn.classList.toggle('has-photo', hasPhoto);
                }
            });
        }
        
        function autoAdvancePhotoType() {
            const typeOrder = ['lateral', 'trasera', 'superior'];
            const currentIndex = typeOrder.indexOf(currentPhotoType);
            
            if (currentIndex >= 0 && currentIndex < typeOrder.length - 1) {
                const nextType = typeOrder[currentIndex + 1];
                const hasNextPhoto = currentSessionPhotos.some(p => p.type === nextType);
                
                if (!hasNextPhoto) {
                    setPhotoType(nextType);
                }
            }
        }
        
        function getPhotoTypeLabel(type) {
            const labels = {
                'lateral': 'üìê Lateral',
                'trasera': 'üîô Trasera',
                'superior': '‚¨ÜÔ∏è Superior',
                'chapeta': 'üè∑Ô∏è Chapeta',
                'otra': 'üì∑ Otra'
            };
            return labels[type] || type;
        }

        function getSessionPhotoDataUrl(foto, sesion) {
            if (foto && foto.dataUrl) return foto.dataUrl;
            if (foto && foto.fromAnimalPhotos && foto.chapeta) {
                return animalPhotos[foto.chapeta]?.photo || null;
            }
            if (sesion && sesion.photoRef && sesion.photoRef.chapeta) {
                return animalPhotos[sesion.photoRef.chapeta]?.photo || null;
            }
            return null;
        }
        
        function deleteSessionPhoto(index) {
            currentSessionPhotos.splice(index, 1);
            updatePhotoPreviewGrid();
            updatePhotoTypeButtons();
            updatePhotosProgressIndicator();
            document.getElementById('fotoNumFotos').value = currentSessionPhotos.length;
        }
        
        function clearPhotoSession() {
            if ((currentSessionPhotos.length > 0 || currentChapetaPhoto) && 
                !confirm('¬øLimpiar toda la sesi√≥n actual?')) return;
            
            // Clear all
            currentSessionPhotos = [];
            currentChapetaPhoto = null;
            currentPhotoType = 'lateral';
            
            // Reset form
            document.getElementById('fotoForm').reset();
            document.getElementById('fotoNumero').value = '';
            document.getElementById('fotoNumeroManual').value = '';
            document.getElementById('chapetaPreview').style.display = 'none';
            document.getElementById('chapetaPhotoImg').src = '';
            
            // Hide steps
            hideAnimalPhotosStep();
            
            // Reset photo UI
            updatePhotoPreviewGrid();
            updatePhotoTypeButtons();
            setPhotoType('lateral');
            
            // Reset date
            document.getElementById('fotoFecha').value = new Date().toISOString().split('T')[0];
            updateSeasonFromDate();
            
            showToast('Sesi√≥n limpiada', 'info');
        }
        
        function saveAndNextAnimal() {
            // First save current session
            const form = document.getElementById('fotoForm');
            if (!form.reportValidity()) return;
            
            // Trigger save
            saveFotoSesionInternal(true);
        }
        
        function populateFotoAnimalSelector() {
            const inventario = getInventario();
            const selector = document.getElementById('fotoAnimalSelector');
            
            if (!selector) return;
            
            if (inventario.length === 0) {
                selector.innerHTML = '<div style="padding: 1rem; text-align: center; color: var(--gray);">No hay animales en inventario</div>';
                return;
            }
            
            selector.innerHTML = inventario.map(animal => {
                const ultimaFoto = getUltimaFoto(animal.numero);
                const diasSinFoto = ultimaFoto ? getDiasDesde(ultimaFoto.fecha) : 999;
                const statusColor = diasSinFoto > 90 ? '#f44336' : diasSinFoto > 60 ? '#ff9800' : '#4caf50';
                
                return `
                    <div class="animal-option" data-numero="${animal.numero}" onclick="selectAnimalForFoto('${animal.numero}')">
                        <div>
                            <strong>#${animal.numero}</strong> - ${animal.sexo === 'MACHO' ? '‚ôÇÔ∏è' : '‚ôÄÔ∏è'} ${animal.vendedor || 'Nacimiento'}
                        </div>
                        <div style="color: ${statusColor}; font-size: 0.85rem;">
                            ${ultimaFoto ? diasSinFoto + ' d√≠as sin foto' : 'Sin fotos'}
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function selectAnimalForFoto(numero) {
            document.getElementById('fotoNumero').value = numero;
            
            document.querySelectorAll('#fotoAnimalSelector .animal-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            document.querySelector(`#fotoAnimalSelector .animal-option[data-numero="${numero}"]`).classList.add('selected');
            
            // Pre-fill with last known data
            const ultimaFoto = getUltimaFoto(numero);
            if (ultimaFoto) {
                document.getElementById('fotoBCS').value = ultimaFoto.bcs;
                document.getElementById('fotoPasto').value = ultimaFoto.pasto || 'bueno';
            }
        }
        
        function filterAnimalsForFoto() {
            const search = document.getElementById('fotoSearch').value.toLowerCase();
            document.querySelectorAll('#fotoAnimalSelector .animal-option').forEach(opt => {
                const numero = opt.dataset.numero.toLowerCase();
                opt.style.display = numero.includes(search) ? '' : 'none';
            });
        }
        
        function getTemporadaFromDateValue(fecha) {
            const month = new Date(fecha).getMonth() + 1; // 1-12
            if (month >= 4 && month <= 5) return 'lluvias_fuertes';
            if (month >= 6 && month <= 8) return 'veranillo';
            if (month >= 9 && month <= 11) return 'lluvias';
            return 'seco';
        }
        
        function updateSeasonFromDate() {
            const fotoFechaEl = document.getElementById('fotoFecha');
            if (!fotoFechaEl) return; // Element doesn't exist yet
            
            const fecha = fotoFechaEl.value;
            if (!fecha) return;
            
            document.getElementById('fotoTemporada').value = getTemporadaFromDateValue(fecha);
        }
        
        function getUltimaFoto(numero) {
            if (!data.fotoSesiones) return null;
            const sesiones = data.fotoSesiones.filter(s => s.numero == numero);
            if (sesiones.length === 0) return null;
            return sesiones.sort((a, b) => new Date(b.fecha) - new Date(a.fecha))[0];
        }
        
        function getDiasDesde(fecha) {
            return Math.floor((new Date() - new Date(fecha)) / (1000 * 60 * 60 * 24));
        }
        
        function saveFotoSesion(event) {
            event.preventDefault();
            saveFotoSesionInternal(false);
        }
        
        function saveFotoSesionInternal(continueToNext) {
            const numero = document.getElementById('fotoNumero').value;
            if (!numero) {
                showToast('Debe identificar un animal primero', 'error');
                return;
            }
            
            if (currentSessionPhotos.length === 0) {
                showToast('Debe tomar al menos una foto del animal', 'error');
                return;
            }
            
            // Check minimum photos
            const hasLateral = currentSessionPhotos.some(p => p.type === 'lateral');
            const hasTrasera = currentSessionPhotos.some(p => p.type === 'trasera');
            
            if (!hasLateral || !hasTrasera) {
                if (!confirm('‚ö†Ô∏è Faltan fotos recomendadas (Lateral y Trasera). ¬øGuardar de todas formas?')) {
                    return;
                }
            }
            
            // Get reference data
            const tipoReferencia = document.querySelector('input[name="tipoReferencia"]:checked')?.value || 'ninguna';
            const distancia = document.querySelector('input[name="distanciaFoto"]:checked')?.value || '3m';
            const refVisibility = {
                lateral: document.getElementById('refVisibleLateral')?.checked || false,
                trasera: document.getElementById('refVisibleTrasera')?.checked || false,
                superior: document.getElementById('refVisibleSuperior')?.checked || false
            };
            
            // Get manga-specific data if using manga calibrada
            const posicionManga = document.querySelector('input[name="posicionManga"]:checked')?.value || 'centro';
            const marcasVisibles = document.getElementById('marcasVisibles')?.checked || false;
            
            // Build all photos array (chapeta first, then body photos)
            const allPhotos = [];
            
            // Add chapeta photo if captured
            if (currentChapetaPhoto) {
                allPhotos.push({
                    type: 'chapeta',
                    dataUrl: currentChapetaPhoto,
                    timestamp: new Date().toISOString(),
                    hasReference: false
                });
            }
            
            // Add body photos with reference visibility
            currentSessionPhotos.forEach(p => {
                allPhotos.push({
                    type: p.type,
                    dataUrl: p.dataUrl,
                    timestamp: p.timestamp,
                    hasReference: tipoReferencia === 'manga_calibrada' ? marcasVisibles : (refVisibility[p.type] || false)
                });
            });
            
            const sesion = {
                id: Date.now(),
                numero: numero,
                fecha: document.getElementById('fotoFecha').value,
                temporada: document.getElementById('fotoTemporada').value,
                bcs: parseInt(document.getElementById('fotoBCS').value),
                pasto: document.getElementById('fotoPasto').value,
                pesoVisual: parseFloat(document.getElementById('fotoPesoVisual').value) || null,
                pesoBascula: parseFloat(document.getElementById('fotoPesoBascula').value) || null,
                numFotos: allPhotos.length,
                fotos: allPhotos,
                // Reference calibration data
                calibracion: {
                    tipoReferencia: tipoReferencia,
                    distancia: tipoReferencia === 'manga_calibrada' ? 'manga' : distancia,
                    refVisibility: refVisibility,
                    // Manga-specific data
                    posicionManga: tipoReferencia === 'manga_calibrada' ? posicionManga : null,
                    marcasVisibles: tipoReferencia === 'manga_calibrada' ? marcasVisibles : null
                },
                salud: document.getElementById('fotoSalud').value,
                observaciones: document.getElementById('fotoObservaciones').value.trim()
            };
            
            if (!data.fotoSesiones) data.fotoSesiones = [];
            data.fotoSesiones.push(sesion);
            
            // Try to save
            try {
                saveData();
                const refInfo = tipoReferencia !== 'ninguna' ? ` (Ref: ${tipoReferencia})` : '';
                showToast(`‚úÖ Sesi√≥n guardada: #${numero} (${allPhotos.length} fotos)${refInfo}`, 'success');
            } catch (e) {
                if (e.name === 'QuotaExceededError') {
                    showToast('‚ö†Ô∏è Almacenamiento lleno. Exporta y borra sesiones antiguas.', 'error');
                    data.fotoSesiones.pop();
                    return;
                }
                throw e;
            }
            
            // Clear current session
            currentSessionPhotos = [];
            currentChapetaPhoto = null;
            
            if (continueToNext) {
                // Prepare for next animal
                document.getElementById('fotoNumeroManual').value = '';
                document.getElementById('chapetaPreview').style.display = 'none';
                hideAnimalPhotosStep();
                updatePhotoPreviewGrid();
                updatePhotoTypeButtons();
                setPhotoType('lateral');
                
                // Keep same date, season, and reference settings
                showToast('üì∑ Listo para el siguiente animal', 'info');
                
                // Scroll to top
                window.scrollTo({ top: 0, behavior: 'smooth' });
            } else {
                // Full reset
                clearPhotoSession();
            }
        }
        
        function addQuickPhotoSession(chapetaNum, timestamp) {
            const fecha = new Date(timestamp).toISOString().split('T')[0];
            const temporada = getTemporadaFromDateValue(fecha);
            const ultimaFoto = getUltimaFoto(chapetaNum);
            const bcs = ultimaFoto?.bcs || 3;
            const pasto = ultimaFoto?.pasto || 'bueno';
            
            const sesion = {
                id: Date.now(),
                numero: chapetaNum,
                fecha: fecha,
                temporada: temporada,
                bcs: bcs,
                pasto: pasto,
                pesoVisual: null,
                pesoBascula: null,
                numFotos: 1,
                fotos: [{
                    type: 'otra',
                    dataUrl: null,
                    timestamp: timestamp,
                    hasReference: false,
                    fromAnimalPhotos: true,
                    chapeta: chapetaNum
                }],
                photoRef: {
                    chapeta: chapetaNum
                },
                calibracion: {
                    tipoReferencia: 'ninguna',
                    distancia: null,
                    refVisibility: { lateral: false, trasera: false, superior: false },
                    posicionManga: null,
                    marcasVisibles: null
                },
                salud: 'bueno',
                observaciones: 'Captura r√°pida'
            };
            
            if (!data.fotoSesiones) data.fotoSesiones = [];
            data.fotoSesiones.push(sesion);
            try {
                saveData();
            } catch (error) {
                data.fotoSesiones.pop();
                throw error;
            }
        }
        
        function viewPhoto(dataUrl, label) {
            // Clear any existing session navigation
            window.currentViewingSession = null;
            window.currentPhotoIndex = 0;
            
            const viewer = document.getElementById('photoViewer');
            const img = document.getElementById('photoViewerImg');
            const info = document.getElementById('photoViewerInfo');
            const nav = document.getElementById('photoViewerNav');
            
            img.src = dataUrl;
            info.textContent = label;
            nav.style.display = 'none';
            viewer.classList.add('active');
            
            document.addEventListener('keydown', function escHandler(e) {
                if (e.key === 'Escape') {
                    closePhotoViewer();
                    document.removeEventListener('keydown', escHandler);
                }
            });
        }
        
        function updateFotoSummary() {
            const inventario = getInventario();
            let vencidas = 0, prontas = 0, alDia = 0;
            
            inventario.forEach(animal => {
                const ultimaFoto = getUltimaFoto(animal.numero);
                const diasSinFoto = ultimaFoto ? getDiasDesde(ultimaFoto.fecha) : 999;
                
                if (diasSinFoto > 90) vencidas++;
                else if (diasSinFoto > 60) prontas++;
                else alDia++;
            });
            
            document.getElementById('fotosVencidas').textContent = vencidas;
            document.getElementById('fotosProntas').textContent = prontas;
            document.getElementById('fotosAlDia').textContent = alDia;
            document.getElementById('totalSesiones').textContent = data.fotoSesiones ? data.fotoSesiones.length : 0;
        }
        
        function updateFotosPendientes() {
            const inventario = getInventario();
            const tbody = document.getElementById('fotosPendientesTable');
            
            // Create list with photo status
            const animalesConStatus = inventario.map(animal => {
                const ultimaFoto = getUltimaFoto(animal.numero);
                const diasSinFoto = ultimaFoto ? getDiasDesde(ultimaFoto.fecha) : 999;
                const diasEnFinca = getDiasEnFinca(animal.fechaEntrada);
                const pesoEstimado = animal.peso + (diasEnFinca * data.config.gdp);
                
                return {
                    ...animal,
                    ultimaFoto,
                    diasSinFoto,
                    pesoEstimado
                };
            });
            
            // Filter to only show animals needing photos (>60 days)
            const pendientes = animalesConStatus.filter(a => a.diasSinFoto > 60)
                .sort((a, b) => b.diasSinFoto - a.diasSinFoto);
            
            if (pendientes.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center" style="color: var(--success);">‚úÖ Todos los animales tienen fotos al d√≠a</td></tr>';
                return;
            }
            
            tbody.innerHTML = pendientes.map(animal => {
                const statusClass = animal.diasSinFoto > 90 ? 'badge-danger' : 'badge-warning';
                const statusText = animal.diasSinFoto > 90 ? 'üî¥ Vencida' : 'üü° Pr√≥xima';
                
                return `
                    <tr>
                        <td><strong>${animal.numero}</strong></td>
                        <td>${animal.vendedor || 'Nacimiento'}</td>
                        <td class="text-right"><strong>${animal.diasSinFoto === 999 ? 'Nunca' : animal.diasSinFoto + ' d√≠as'}</strong></td>
                        <td>${animal.ultimaFoto ? formatDate(animal.ultimaFoto.fecha) : 'Nunca'}</td>
                        <td>${animal.ultimaFoto ? getBCSDisplay(animal.ultimaFoto.bcs) : '-'}</td>
                        <td class="text-right">${animal.pesoEstimado.toFixed(0)} kg</td>
                        <td><span class="badge ${statusClass}">${statusText}</span></td>
                        <td class="text-center">
                            <button class="btn btn-primary" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;" onclick="quickFoto('${animal.numero}')">üì∑ Foto</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        function updateFotoHistorial() {
            const tbody = document.getElementById('fotoHistorialTable');
            
            if (!data.fotoSesiones || data.fotoSesiones.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" class="text-center">No hay sesiones registradas</td></tr>';
                return;
            }
            
            let sesiones = [...data.fotoSesiones];
            
            // Apply sorting if active
            if (sortState.fotoSesiones && sortState.fotoSesiones.column) {
                const th = document.querySelector(`#fotoHistorialTableContainer th[data-sort="${sortState.fotoSesiones.column}"]`);
                const type = th ? th.dataset.type : 'text';
                sesiones = sortData(sesiones, sortState.fotoSesiones.column, sortState.fotoSesiones.direction, type, 'fotoSesiones');
            } else {
                sesiones.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
            }
            
            tbody.innerHTML = sesiones.map(sesion => {
                // Generate photo thumbnails
                let fotosHtml = '-';
                if (sesion.fotos && sesion.fotos.length > 0) {
                    const previewFotos = sesion.fotos
                        .map(foto => ({
                            ...foto,
                            dataUrl: getSessionPhotoDataUrl(foto, sesion)
                        }))
                        .filter(foto => foto.dataUrl);
                    
                    if (previewFotos.length === 0) {
                        fotosHtml = `<span class="badge badge-warning">Sin foto</span>`;
                    } else {
                    fotosHtml = `
                        <div style="display: flex; gap: 4px;">
                            ${previewFotos.slice(0, 3).map(foto => `
                                <img src="${foto.dataUrl}"
                                     style="width: 40px; height: 40px; object-fit: cover; border-radius: 4px; cursor: pointer;"
                                     onclick="viewPhoto('${foto.dataUrl}', '${getPhotoTypeLabel(foto.type)} - #${sesion.numero}')"
                                     title="${getPhotoTypeLabel(foto.type)}">
                            `).join('')}
                            ${previewFotos.length > 3 ? `<span style="font-size: 0.8rem; color: var(--gray);">+${previewFotos.length - 3}</span>` : ''}
                        </div>
                    `;
                    }
                } else if (sesion.numFotos) {
                    fotosHtml = `<span class="badge badge-secondary">${sesion.numFotos} fotos</span>`;
                }
                
                return `
                    <tr>
                        <td><strong>${sesion.numero}</strong></td>
                        <td>${formatDate(sesion.fecha)}</td>
                        <td>${getTemporadaDisplay(sesion.temporada)}</td>
                        <td class="text-center">${getBCSDisplay(sesion.bcs)}</td>
                        <td>${getPastoDisplay(sesion.pasto)}</td>
                        <td class="text-right">${sesion.pesoVisual ? sesion.pesoVisual + ' kg' : '-'}</td>
                        <td class="text-right">${sesion.pesoBascula ? sesion.pesoBascula + ' kg' : '-'}</td>
                        <td>${fotosHtml}</td>
                        <td>${getSaludDisplay(sesion.salud)}</td>
                        <td class="text-center">
                            <button class="btn btn-primary" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;" onclick="viewSessionPhotos(${sesion.id})" ${!sesion.fotos || sesion.fotos.length === 0 ? 'disabled' : ''}>üëÅÔ∏è</button>
                            <button class="btn btn-danger" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;" onclick="deleteFotoSesion(${sesion.id})">üóëÔ∏è</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        function viewSessionPhotos(sessionId) {
            const sesion = data.fotoSesiones.find(s => s.id === sessionId);
            if (!sesion || !sesion.fotos || sesion.fotos.length === 0) {
                showToast('No hay fotos en esta sesi√≥n', 'info');
                return;
            }
            
            const fotos = sesion.fotos
                .map(foto => ({
                    ...foto,
                    dataUrl: getSessionPhotoDataUrl(foto, sesion)
                }))
                .filter(foto => foto.dataUrl);
            
            if (fotos.length === 0) {
                showToast('No hay fotos disponibles para mostrar', 'info');
                return;
            }
            
            // Store session for navigation
            window.currentViewingSession = { ...sesion, fotos };
            window.currentPhotoIndex = 0;
            
            // Show first photo
            updatePhotoViewerDisplay();
            document.getElementById('photoViewer').classList.add('active');
            
            // Show navigation buttons if multiple photos
            const navButtons = document.getElementById('photoViewerNav');
            navButtons.style.display = fotos.length > 1 ? 'flex' : 'none';
            
            // Add keyboard navigation
            document.addEventListener('keydown', handlePhotoNavigation);
            
            // Add touch/swipe support
            addSwipeSupport();
        }
        
        function navigatePhoto(direction) {
            if (!window.currentViewingSession) return;
            
            const fotos = window.currentViewingSession.fotos;
            window.currentPhotoIndex = (window.currentPhotoIndex + direction + fotos.length) % fotos.length;
            updatePhotoViewerDisplay();
        }
        
        function updatePhotoViewerDisplay() {
            const sesion = window.currentViewingSession;
            const fotos = sesion.fotos;
            const foto = fotos[window.currentPhotoIndex];
            
            document.getElementById('photoViewerImg').src = foto.dataUrl;
            document.getElementById('photoViewerInfo').textContent = 
                `#${sesion.numero} - ${getPhotoTypeLabel(foto.type)} (${window.currentPhotoIndex + 1}/${fotos.length})`;
        }
        
        function addSwipeSupport() {
            const viewer = document.getElementById('photoViewer');
            let touchStartX = 0;
            let touchEndX = 0;
            
            viewer.ontouchstart = (e) => {
                touchStartX = e.changedTouches[0].screenX;
            };
            
            viewer.ontouchend = (e) => {
                touchEndX = e.changedTouches[0].screenX;
                handleSwipe();
            };
            
            function handleSwipe() {
                const swipeThreshold = 50;
                const diff = touchStartX - touchEndX;
                
                if (Math.abs(diff) > swipeThreshold) {
                    if (diff > 0) {
                        // Swipe left - next photo
                        navigatePhoto(1);
                    } else {
                        // Swipe right - previous photo
                        navigatePhoto(-1);
                    }
                }
            }
        }
        
        function handlePhotoNavigation(e) {
            if (!window.currentViewingSession) return;
            
            const viewer = document.getElementById('photoViewer');
            if (!viewer.classList.contains('active')) {
                document.removeEventListener('keydown', handlePhotoNavigation);
                return;
            }
            
            if (e.key === 'ArrowRight' || e.key === ' ') {
                e.preventDefault();
                navigatePhoto(1);
            } else if (e.key === 'ArrowLeft') {
                e.preventDefault();
                navigatePhoto(-1);
            } else if (e.key === 'Escape') {
                closePhotoViewer();
            }
        }
        
        function closePhotoViewer(event) {
            if (event && event.target !== document.getElementById('photoViewer') && 
                event.target !== document.querySelector('.photo-viewer-close')) return;
            
            document.getElementById('photoViewer').classList.remove('active');
            document.removeEventListener('keydown', handlePhotoNavigation);
            window.currentViewingSession = null;
            window.currentPhotoIndex = 0;
        }
        
        function getBCSDisplay(bcs) {
            const colors = { 1: '#f44336', 2: '#ff9800', 3: '#4caf50', 4: '#2196f3', 5: '#9c27b0' };
            const labels = { 1: 'Muy Flaco', 2: 'Flaco', 3: 'Normal', 4: 'Gordo', 5: 'Obeso' };
            return `<span class="badge" style="background: ${colors[bcs]}; color: white;">${bcs} - ${labels[bcs]}</span>`;
        }
        
        function getTemporadaDisplay(temporada) {
            const map = {
                'lluvias_fuertes': 'üåßÔ∏è Lluvias Fuertes',
                'veranillo': 'üå§Ô∏è Veranillo',
                'lluvias': 'üåßÔ∏è Lluvias',
                'seco': '‚òÄÔ∏è Seco'
            };
            return map[temporada] || temporada;
        }
        
        function getPastoDisplay(pasto) {
            const map = {
                'excelente': 'üåø Excelente',
                'bueno': 'üå± Bueno',
                'regular': 'üåæ Regular',
                'malo': 'ü•Ä Malo'
            };
            return map[pasto] || pasto;
        }
        
        function getSaludDisplay(salud) {
            const map = {
                'excelente': 'üíö',
                'bueno': 'üíô',
                'regular': 'üíõ',
                'enfermo': '‚ù§Ô∏è'
            };
            return map[salud] || salud;
        }
        
        function quickFoto(numero) {
            // Clear any existing session
            currentSessionPhotos = [];
            updatePhotoPreviewGrid();
            updatePhotoTypeButtons();
            setPhotoType('lateral');
            
            // Navigate to photos tab and select animal
            document.querySelector('.nav-tab[data-tab="fotos"]').click();
            setTimeout(() => {
                selectAnimalForFoto(numero);
                document.getElementById('fotoFecha').value = new Date().toISOString().split('T')[0];
                updateSeasonFromDate();
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }, 100);
        }
        
        function deleteFotoSesion(id) {
            if (!confirm('¬øEliminar esta sesi√≥n de fotos?')) return;
            
            data.fotoSesiones = data.fotoSesiones.filter(s => s.id !== id);
            saveData();
            showToast('Sesi√≥n eliminada', 'warning');
        }
        
        function updateBCSChartSelector() {
            const select = document.getElementById('bcsChartAnimal');
            if (!select) return;
            
            const inventario = getInventario();
            const animalesConFotos = inventario.filter(a => {
                return data.fotoSesiones && data.fotoSesiones.some(s => s.numero == a.numero);
            });
            
            select.innerHTML = '<option value="">-- Seleccionar Animal --</option>' +
                animalesConFotos.map(a => `<option value="${a.numero}">#${a.numero} - ${a.vendedor || 'Nacimiento'}</option>`).join('');
        }
        
        function updateBCSChart() {
            const numero = document.getElementById('bcsChartAnimal').value;
            const container = document.getElementById('bcsChartContainer');
            
            if (!numero) {
                container.innerHTML = '<div style="text-align: center; color: var(--gray); padding: 2rem;">Selecciona un animal para ver su historial de condici√≥n corporal</div>';
                return;
            }
            
            const sesiones = data.fotoSesiones.filter(s => s.numero == numero)
                .sort((a, b) => new Date(a.fecha) - new Date(b.fecha));
            
            if (sesiones.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: var(--gray); padding: 2rem;">No hay sesiones para este animal</div>';
                return;
            }
            
            // Create simple text-based chart
            const maxBCS = 5;
            const chartHeight = 150;
            
            let html = `
                <div style="display: flex; align-items: flex-end; gap: 1rem; height: ${chartHeight}px; padding: 1rem; background: #f5f5f5; border-radius: 8px; overflow-x: auto;">
            `;
            
            sesiones.forEach((sesion, i) => {
                const height = (sesion.bcs / maxBCS) * (chartHeight - 40);
                const colors = { 1: '#f44336', 2: '#ff9800', 3: '#4caf50', 4: '#2196f3', 5: '#9c27b0' };
                
                html += `
                    <div style="display: flex; flex-direction: column; align-items: center; min-width: 60px;">
                        <div style="font-weight: bold; margin-bottom: 4px;">BCS ${sesion.bcs}</div>
                        <div style="width: 40px; height: ${height}px; background: ${colors[sesion.bcs]}; border-radius: 4px 4px 0 0;"></div>
                        <div style="font-size: 0.7rem; margin-top: 4px; text-align: center;">${formatDate(sesion.fecha)}</div>
                    </div>
                `;
            });
            
            html += '</div>';
            
            // Add peso tracking if available
            const pesosBascula = sesiones.filter(s => s.pesoBascula);
            if (pesosBascula.length > 0) {
                html += `
                    <div style="margin-top: 1rem;">
                        <strong>Pesos Registrados (B√°scula):</strong>
                        <div style="display: flex; gap: 1rem; flex-wrap: wrap; margin-top: 0.5rem;">
                            ${pesosBascula.map(s => `
                                <div style="background: #e3f2fd; padding: 0.5rem 1rem; border-radius: 8px;">
                                    <div style="font-weight: bold;">${s.pesoBascula} kg</div>
                                    <div style="font-size: 0.8rem; color: var(--gray);">${formatDate(s.fecha)}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            container.innerHTML = html;
        }
        
        function filterFotoHistorial() {
            const search = document.getElementById('fotoHistorialSearch').value.toLowerCase();
            const temporada = document.getElementById('fotoTemporadaFilter').value;
            const bcs = document.getElementById('fotoBCSFilter').value;
            
            const rows = document.querySelectorAll('#fotoHistorialTable tr');
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                const matchSearch = !search || text.includes(search);
                const matchTemporada = !temporada || text.includes(getTemporadaDisplay(temporada).toLowerCase());
                const matchBCS = !bcs || row.querySelector('td:nth-child(4)')?.textContent.includes(bcs);
                
                row.style.display = matchSearch && matchTemporada && matchBCS ? '' : 'none';
            });
        }
        
        function startBulkFotoSession() {
            showToast('Funci√≥n de sesi√≥n masiva pr√≥ximamente. Por ahora, registra cada animal individualmente.', 'info');
        }
        
        function exportFotosPendientes() {
            const inventario = getInventario();
            const pendientes = inventario.map(animal => {
                const ultimaFoto = getUltimaFoto(animal.numero);
                const diasSinFoto = ultimaFoto ? getDiasDesde(ultimaFoto.fecha) : 999;
                return { ...animal, diasSinFoto, ultimaFoto };
            }).filter(a => a.diasSinFoto > 60).sort((a, b) => b.diasSinFoto - a.diasSinFoto);
            
            const headers = ['Chapeta', 'Vendedor', 'D√≠as Sin Foto', '√öltima Foto', '√öltimo BCS'];
            const rows = pendientes.map(a => [
                a.numero,
                a.vendedor || 'Nacimiento',
                a.diasSinFoto === 999 ? 'Nunca' : a.diasSinFoto,
                a.ultimaFoto ? a.ultimaFoto.fecha : 'Nunca',
                a.ultimaFoto ? a.ultimaFoto.bcs : '-'
            ]);
            
            const csv = [headers, ...rows].map(row => row.join(',')).join('\n');
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'animales_pendientes_fotos.csv';
            a.click();
            
            showToast('Lista exportada', 'success');
        }
        
        // ==================== SALUD (HEALTH) MODULE ====================
        function showSaludForm(tipo) {
            document.getElementById('saludFormContainer').style.display = 'block';
            document.getElementById('saludTipo').value = tipo;
            document.getElementById('saludFecha').value = new Date().toISOString().split('T')[0];
            
            const titles = {
                'vacuna': 'üíâ Registrar Vacunaci√≥n',
                'desparasitacion': 'üêõ Registrar Desparasitaci√≥n',
                'tratamiento': 'üíä Registrar Tratamiento',
                'revision': 'ü©∫ Registrar Revisi√≥n Veterinaria'
            };
            document.getElementById('saludFormTitle').textContent = titles[tipo] || 'üíâ Registrar Evento de Salud';
            
            // Show/hide relevant fields
            document.getElementById('saludRetiroGroup').style.display = (tipo === 'tratamiento') ? 'block' : 'none';
            document.getElementById('saludProximaGroup').style.display = (tipo === 'vacuna' || tipo === 'desparasitacion') ? 'block' : 'none';
            
            // Update product label
            const labels = {
                'vacuna': 'Tipo de Vacuna',
                'desparasitacion': 'Desparasitante',
                'tratamiento': 'Medicamento',
                'revision': 'Tipo de Revisi√≥n'
            };
            document.getElementById('saludProductoLabel').textContent = labels[tipo] || 'Producto';
            
            // Populate animal selector
            populateSaludAnimalSelector();
            selectedSaludAnimals.clear();
            updateSaludSelectedCount();
        }
        
        function hideSaludForm() {
            document.getElementById('saludFormContainer').style.display = 'none';
            document.getElementById('saludForm').reset();
            selectedSaludAnimals.clear();
        }
        
        function populateSaludAnimalSelector() {
            const container = document.getElementById('saludAnimalSelector');
            const inventario = getInventario();
            
            if (inventario.length === 0) {
                container.innerHTML = '<div style="grid-column: 1/-1; text-align: center; color: var(--gray);">No hay animales en inventario</div>';
                return;
            }
            
            container.innerHTML = inventario.map(a => {
                const inRetiro = isAnimalInRetiro(a.numero);
                return `<div class="animal-chip ${inRetiro ? 'in-retiro' : ''}" data-numero="${a.numero}" onclick="toggleSaludAnimal('${a.numero}')">${a.numero}${inRetiro ? ' üö´' : ''}</div>`;
            }).join('');
        }
        
        function toggleSaludAnimal(numero) {
            if (selectedSaludAnimals.has(numero)) {
                selectedSaludAnimals.delete(numero);
            } else {
                selectedSaludAnimals.add(numero);
            }
            
            document.querySelectorAll('#saludAnimalSelector .animal-chip').forEach(chip => {
                if (chip.dataset.numero === numero) {
                    chip.classList.toggle('selected');
                }
            });
            
            updateSaludSelectedCount();
        }
        
        function selectAllAnimalsForSalud() {
            const inventario = getInventario();
            inventario.forEach(a => selectedSaludAnimals.add(a.numero));
            document.querySelectorAll('#saludAnimalSelector .animal-chip').forEach(chip => {
                chip.classList.add('selected');
            });
            updateSaludSelectedCount();
        }
        
        function clearSaludSelection() {
            selectedSaludAnimals.clear();
            document.querySelectorAll('#saludAnimalSelector .animal-chip').forEach(chip => {
                chip.classList.remove('selected');
            });
            updateSaludSelectedCount();
        }
        
        function filterAnimalsForSalud() {
            const search = document.getElementById('saludSearchAnimal').value.toLowerCase();
            document.querySelectorAll('#saludAnimalSelector .animal-chip').forEach(chip => {
                const numero = chip.dataset.numero.toLowerCase();
                chip.style.display = numero.includes(search) ? '' : 'none';
            });
        }
        
        function updateSaludSelectedCount() {
            document.getElementById('saludSelectedCount').textContent = selectedSaludAnimals.size;
        }
        
        function isAnimalInRetiro(numero) {
            const today = new Date();
            return data.saludEventos.some(e => {
                if (!e.diasRetiro || e.diasRetiro <= 0) return false;
                if (!e.animales.includes(numero)) return false;
                const eventDate = new Date(e.fecha);
                const retiroEnd = new Date(eventDate);
                retiroEnd.setDate(retiroEnd.getDate() + e.diasRetiro);
                return today < retiroEnd;
            });
        }
        
        function getRetiroEndDate(numero) {
            const today = new Date();
            let latestRetiro = null;
            
            data.saludEventos.forEach(e => {
                if (!e.diasRetiro || e.diasRetiro <= 0) return;
                if (!e.animales.includes(numero)) return;
                const eventDate = new Date(e.fecha);
                const retiroEnd = new Date(eventDate);
                retiroEnd.setDate(retiroEnd.getDate() + e.diasRetiro);
                if (retiroEnd > today && (!latestRetiro || retiroEnd > latestRetiro)) {
                    latestRetiro = retiroEnd;
                }
            });
            
            return latestRetiro;
        }
        
        function saveSaludEvento(event) {
            event.preventDefault();
            
            if (selectedSaludAnimals.size === 0) {
                showToast('Debe seleccionar al menos un animal', 'error');
                return;
            }
            
            const evento = {
                id: Date.now(),
                tipo: document.getElementById('saludTipo').value,
                fecha: document.getElementById('saludFecha').value,
                producto: document.getElementById('saludProducto').value.trim(),
                dosis: document.getElementById('saludDosis').value.trim(),
                loteProducto: document.getElementById('saludLoteProducto').value.trim(),
                diasRetiro: parseInt(document.getElementById('saludDiasRetiro').value) || 0,
                proximaFecha: document.getElementById('saludProximaFecha').value || null,
                veterinario: document.getElementById('saludVeterinario').value.trim(),
                observaciones: document.getElementById('saludObservaciones').value.trim(),
                animales: Array.from(selectedSaludAnimals)
            };
            
            data.saludEventos.push(evento);
            saveData();
            
            const tipoNames = { 'vacuna': 'Vacunaci√≥n', 'desparasitacion': 'Desparasitaci√≥n', 'tratamiento': 'Tratamiento', 'revision': 'Revisi√≥n' };
            showToast(`${tipoNames[evento.tipo]} registrada para ${evento.animales.length} animales`, 'success');
            
            hideSaludForm();
        }
        
        function updateSaludView() {
            updateSaludStats();
            updateSaludAlertas();
            updateSaludHistorial();
        }
        
        function updateSaludStats() {
            const inventario = getInventario();
            const today = new Date();
            
            let vacunasAlDia = 0;
            let vacunasPendientes = 0;
            let enTratamiento = 0;
            let enRetiro = 0;
            
            inventario.forEach(a => {
                // Check retiro status
                if (isAnimalInRetiro(a.numero)) enRetiro++;
                
                // Check if has recent vaccination (within 6 months)
                const lastVacuna = data.saludEventos
                    .filter(e => e.tipo === 'vacuna' && e.animales.includes(a.numero))
                    .sort((a, b) => new Date(b.fecha) - new Date(a.fecha))[0];
                
                if (lastVacuna) {
                    const vacunaDate = new Date(lastVacuna.fecha);
                    const daysSince = Math.floor((today - vacunaDate) / (1000 * 60 * 60 * 24));
                    if (daysSince <= 180) {
                        vacunasAlDia++;
                    } else {
                        vacunasPendientes++;
                    }
                } else {
                    vacunasPendientes++;
                }
                
                // Check active treatments
                const activeTreatments = data.saludEventos.filter(e => {
                    if (e.tipo !== 'tratamiento') return false;
                    if (!e.animales.includes(a.numero)) return false;
                    if (!e.diasRetiro) return false;
                    const eventDate = new Date(e.fecha);
                    const endDate = new Date(eventDate);
                    endDate.setDate(endDate.getDate() + e.diasRetiro);
                    return today < endDate;
                });
                if (activeTreatments.length > 0) enTratamiento++;
            });
            
            document.getElementById('saludVacunasAlDia').textContent = vacunasAlDia;
            document.getElementById('saludVacunasPendientes').textContent = vacunasPendientes;
            document.getElementById('saludEnTratamiento').textContent = enTratamiento;
            document.getElementById('saludEnRetiro').textContent = enRetiro;
        }
        
        function updateSaludAlertas() {
            const alertas = [];
            const today = new Date();
            
            // Check for upcoming vaccinations
            data.saludEventos.forEach(e => {
                if (e.proximaFecha) {
                    const proxima = new Date(e.proximaFecha);
                    const daysUntil = Math.floor((proxima - today) / (1000 * 60 * 60 * 24));
                    
                    if (daysUntil <= 7 && daysUntil >= 0) {
                        alertas.push({
                            type: 'warning',
                            icon: '‚è∞',
                            title: `${e.producto} - Refuerzo pr√≥ximo`,
                            desc: `${e.animales.length} animales - ${daysUntil === 0 ? 'Hoy' : `en ${daysUntil} d√≠as`} (${formatDate(e.proximaFecha)})`
                        });
                    } else if (daysUntil < 0) {
                        alertas.push({
                            type: 'critical',
                            icon: 'üö®',
                            title: `${e.producto} - Refuerzo VENCIDO`,
                            desc: `${e.animales.length} animales - hace ${Math.abs(daysUntil)} d√≠as`
                        });
                    }
                }
            });
            
            // Check for animals in retiro about to end
            const inventario = getInventario();
            inventario.forEach(a => {
                const retiroEnd = getRetiroEndDate(a.numero);
                if (retiroEnd) {
                    const daysUntil = Math.floor((retiroEnd - today) / (1000 * 60 * 60 * 24));
                    if (daysUntil <= 3 && daysUntil >= 0) {
                        alertas.push({
                            type: 'info',
                            icon: '‚úÖ',
                            title: `Animal ${a.numero} - Retiro termina pronto`,
                            desc: `${daysUntil === 0 ? 'Hoy' : `en ${daysUntil} d√≠as`} (${formatDate(retiroEnd.toISOString())})`
                        });
                    }
                }
            });
            
            const container = document.getElementById('saludAlertas');
            const content = document.getElementById('saludAlertasContent');
            
            if (alertas.length === 0) {
                container.style.display = 'none';
                return;
            }
            
            container.style.display = 'block';
            content.innerHTML = alertas.map(a => `
                <div class="alert-item ${a.type}">
                    <span class="alert-icon">${a.icon}</span>
                    <div class="alert-content">
                        <div class="alert-title">${a.title}</div>
                        <div class="alert-desc">${a.desc}</div>
                    </div>
                </div>
            `).join('');
        }
        
        function updateSaludHistorial() {
            const tbody = document.getElementById('saludHistorialBody');
            
            if (data.saludEventos.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center">No hay registros de salud</td></tr>';
                return;
            }
            
            const sorted = [...data.saludEventos].sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
            
            tbody.innerHTML = sorted.map(e => {
                const tipoIcons = { 'vacuna': 'üíâ', 'desparasitacion': 'üêõ', 'tratamiento': 'üíä', 'revision': 'ü©∫' };
                const tipoNames = { 'vacuna': 'Vacuna', 'desparasitacion': 'Desparasitaci√≥n', 'tratamiento': 'Tratamiento', 'revision': 'Revisi√≥n' };
                
                return `<tr>
                    <td>${formatDate(e.fecha)}</td>
                    <td><span class="health-badge ${e.tipo}">${tipoIcons[e.tipo]} ${tipoNames[e.tipo]}</span></td>
                    <td>${e.producto}</td>
                    <td>${e.animales.length} animal${e.animales.length > 1 ? 'es' : ''}</td>
                    <td>${e.diasRetiro ? `${e.diasRetiro} d√≠as` : '-'}</td>
                    <td>${e.proximaFecha ? formatDate(e.proximaFecha) : '-'}</td>
                </tr>`;
            }).join('');
        }
        
        function filterSaludHistorial() {
            const search = document.getElementById('saludHistorialSearch').value.toLowerCase();
            const tipo = document.getElementById('saludHistorialTipo').value;
            
            document.querySelectorAll('#saludHistorialBody tr').forEach(row => {
                const text = row.textContent.toLowerCase();
                const rowTipo = row.querySelector('.health-badge')?.classList.contains(tipo) || !tipo;
                const matchSearch = text.includes(search);
                row.style.display = (matchSearch && rowTipo) ? '' : 'none';
            });
        }
        
        // ==================== POTREROS (PADDOCK) MODULE ====================
        function showPotreroForm(editId = null) {
            document.getElementById('potreroFormContainer').style.display = 'block';
            document.getElementById('potreroEditId').value = editId || '';
            
            if (editId) {
                const potrero = data.potreros.find(p => p.id === editId);
                if (potrero) {
                    document.getElementById('potreroFormTitle').textContent = '‚úèÔ∏è Editar Potrero';
                    document.getElementById('potreroNombre').value = potrero.nombre;
                    document.getElementById('potreroArea').value = potrero.area || '';
                    document.getElementById('potreroTipoPasto').value = potrero.tipoPasto || 'Brachiaria';
                    document.getElementById('potreroCapacidad').value = potrero.capacidad || '';
                    document.getElementById('potreroAgua').value = potrero.agua || 'bebedero';
                    document.getElementById('potreroEstado').value = potrero.estado || 'disponible';
                    document.getElementById('potreroNotas').value = potrero.notas || '';
                }
            } else {
                document.getElementById('potreroFormTitle').textContent = '‚ûï Agregar Potrero';
                document.getElementById('potreroForm').reset();
            }
        }
        
        function hidePotreroForm() {
            document.getElementById('potreroFormContainer').style.display = 'none';
            document.getElementById('potreroForm').reset();
        }
        
        function savePotrero(event) {
            event.preventDefault();
            
            const editId = document.getElementById('potreroEditId').value;
            const potreroData = {
                id: editId ? parseInt(editId) : Date.now(),
                nombre: document.getElementById('potreroNombre').value.trim(),
                area: parseFloat(document.getElementById('potreroArea').value) || null,
                tipoPasto: document.getElementById('potreroTipoPasto').value,
                capacidad: parseInt(document.getElementById('potreroCapacidad').value) || null,
                agua: document.getElementById('potreroAgua').value,
                estado: document.getElementById('potreroEstado').value,
                notas: document.getElementById('potreroNotas').value.trim(),
                ultimaEntrada: editId ? (data.potreros.find(p => p.id === parseInt(editId))?.ultimaEntrada || null) : null,
                ultimaSalida: editId ? (data.potreros.find(p => p.id === parseInt(editId))?.ultimaSalida || null) : null
            };
            
            if (editId) {
                const idx = data.potreros.findIndex(p => p.id === parseInt(editId));
                if (idx >= 0) data.potreros[idx] = potreroData;
            } else {
                data.potreros.push(potreroData);
            }
            
            saveData();
            showToast(`Potrero ${editId ? 'actualizado' : 'agregado'}: ${potreroData.nombre}`, 'success');
            hidePotreroForm();
        }
        
        function deletePotrero(id) {
            const potrero = data.potreros.find(p => p.id === id);
            if (!potrero) return;
            
            // Check if animals are assigned
            const animalesEnPotrero = Object.entries(data.animalPotreros).filter(([num, pId]) => pId === id);
            if (animalesEnPotrero.length > 0) {
                showToast(`No se puede eliminar: hay ${animalesEnPotrero.length} animales en este potrero`, 'error');
                return;
            }
            
            if (!confirm(`¬øEliminar el potrero "${potrero.nombre}"?`)) return;
            
            data.potreros = data.potreros.filter(p => p.id !== id);
            saveData();
            showToast('Potrero eliminado', 'success');
        }
        
        function showMoverAnimalesForm() {
            document.getElementById('moverAnimalesFormContainer').style.display = 'block';
            document.getElementById('moverFecha').value = new Date().toISOString().split('T')[0];

            // Get ALL potreros from ALL shared ranches (always combine La Coru√±a + Santa Catalina)
            const allPotreros = getAllSharedPotreros();

            // Populate potrero selectors with ALL potreros from shared ranches
            const desdeSelect = document.getElementById('moverDesde');
            const haciaSelect = document.getElementById('moverHacia');

            desdeSelect.innerHTML = '<option value="">-- Sin potrero asignado --</option>' +
                allPotreros.map(p => `<option value="${p.sourceRanch}_${p.id}">${p.displayName}</option>`).join('');

            haciaSelect.innerHTML = '<option value="">-- Seleccionar destino --</option>' +
                allPotreros.filter(p => p.estado !== 'mantenimiento')
                    .map(p => `<option value="${p.sourceRanch}_${p.id}">${p.displayName} (${p.estado})</option>`).join('');

            selectedMoverAnimals.clear();
            updateAnimalesEnPotrero();
        }

        // Get ALL potreros from all shared ranches (always includes ranch name in display)
        function getAllSharedPotreros() {
            const combinedPotreros = [];
            const seenIds = new Set();

            // Always combine from La Coru√±a and Santa Catalina
            SHARED_POTRERO_RANCHES.forEach(ranchId => {
                const ranch = RANCHES[ranchId];
                const ranchData = localStorage.getItem(ranch.storageKey);
                if (ranchData) {
                    try {
                        const parsed = JSON.parse(ranchData);
                        if (parsed.potreros && Array.isArray(parsed.potreros)) {
                            parsed.potreros.forEach(p => {
                                const uniqueId = `${ranchId}_${p.id}`;
                                if (!seenIds.has(uniqueId)) {
                                    seenIds.add(uniqueId);
                                    combinedPotreros.push({
                                        ...p,
                                        sourceRanch: ranchId,
                                        displayName: `${p.nombre} (${ranch.name})`
                                    });
                                }
                            });
                        }
                    } catch (e) {
                        console.error('Error loading potreros from', ranchId, e);
                    }
                }
            });

            console.log('All shared potreros:', combinedPotreros.length, combinedPotreros.map(p => p.displayName));
            return combinedPotreros;
        }
        
        function hideMoverAnimalesForm() {
            document.getElementById('moverAnimalesFormContainer').style.display = 'none';
            selectedMoverAnimals.clear();
        }
        
        function updateAnimalesEnPotrero() {
            const desdeValue = document.getElementById('moverDesde').value;
            const container = document.getElementById('moverAnimalSelector');
            const inventario = getInventario();

            let animalesFiltrados;
            if (desdeValue === '') {
                // Animals without assigned potrero
                animalesFiltrados = inventario.filter(a => !data.animalPotreros[a.numero]);
            } else {
                // Parse the combined ID (format: "ranchId_potreroId")
                const parts = desdeValue.split('_');
                const sourceRanch = parts[0];
                const potreroId = parseInt(parts.slice(1).join('_')); // Handle IDs that might have underscores

                // Animals in selected potrero (check both old format and new format)
                animalesFiltrados = inventario.filter(a => {
                    const assignedPotrero = data.animalPotreros[a.numero];
                    // Support both old format (just ID) and new format (ranch_id)
                    return assignedPotrero === potreroId ||
                           assignedPotrero === desdeValue ||
                           assignedPotrero === `${sourceRanch}_${potreroId}`;
                });
            }

            if (animalesFiltrados.length === 0) {
                container.innerHTML = '<div style="grid-column: 1/-1; text-align: center; color: var(--gray);">No hay animales en esta ubicaci√≥n</div>';
                return;
            }

            container.innerHTML = animalesFiltrados.map(a =>
                `<div class="animal-chip" data-numero="${a.numero}" onclick="toggleMoverAnimal('${a.numero}')">${a.numero}</div>`
            ).join('');

            selectedMoverAnimals.clear();
            updateMoverSelectedCount();
        }
        
        function toggleMoverAnimal(numero) {
            if (selectedMoverAnimals.has(numero)) {
                selectedMoverAnimals.delete(numero);
            } else {
                selectedMoverAnimals.add(numero);
            }
            
            document.querySelectorAll('#moverAnimalSelector .animal-chip').forEach(chip => {
                if (chip.dataset.numero === numero) {
                    chip.classList.toggle('selected');
                }
            });
            
            updateMoverSelectedCount();
        }
        
        function selectAllAnimalesMover() {
            document.querySelectorAll('#moverAnimalSelector .animal-chip').forEach(chip => {
                selectedMoverAnimals.add(chip.dataset.numero);
                chip.classList.add('selected');
            });
            updateMoverSelectedCount();
        }
        
        function clearMoverSelection() {
            selectedMoverAnimals.clear();
            document.querySelectorAll('#moverAnimalSelector .animal-chip').forEach(chip => {
                chip.classList.remove('selected');
            });
            updateMoverSelectedCount();
        }
        
        function updateMoverSelectedCount() {
            document.getElementById('moverSelectedCount').textContent = selectedMoverAnimals.size;
        }
        
        function moverAnimales(event) {
            event.preventDefault();

            if (selectedMoverAnimals.size === 0) {
                showToast('Debe seleccionar al menos un animal', 'error');
                return;
            }

            const haciaValue = document.getElementById('moverHacia').value;
            if (!haciaValue) {
                showToast('Debe seleccionar potrero destino', 'error');
                return;
            }

            const desdeValue = document.getElementById('moverDesde').value || null;
            const fecha = document.getElementById('moverFecha').value;

            // Parse the combined IDs (format: "ranchId_potreroId")
            const allPotreros = getAllSharedPotreros();

            // Find destination potrero info
            let haciaRanch, haciaPotreroId, haciaPotreroInfo;
            if (haciaValue.includes('_')) {
                const parts = haciaValue.split('_');
                haciaRanch = parts[0];
                haciaPotreroId = parseInt(parts.slice(1).join('_'));
                haciaPotreroInfo = allPotreros.find(p => p.sourceRanch === haciaRanch && p.id === haciaPotreroId);
            }

            // Find source potrero info
            let desdeRanch, desdePotreroId, desdePotreroInfo;
            if (desdeValue && desdeValue.includes('_')) {
                const parts = desdeValue.split('_');
                desdeRanch = parts[0];
                desdePotreroId = parseInt(parts.slice(1).join('_'));
                desdePotreroInfo = allPotreros.find(p => p.sourceRanch === desdeRanch && p.id === desdePotreroId);
            }

            // Calculate days in previous potrero
            let diasEnAnterior = null;
            if (desdePotreroInfo && desdePotreroInfo.ultimaEntrada) {
                const entrada = new Date(desdePotreroInfo.ultimaEntrada);
                const hoy = new Date(fecha);
                diasEnAnterior = Math.floor((hoy - entrada) / (1000 * 60 * 60 * 24));
            }

            // Record rotation with full info
            const rotacion = {
                id: Date.now(),
                fecha: fecha,
                desdeId: desdeValue,
                desdeNombre: desdePotreroInfo?.displayName || desdePotreroInfo?.nombre || 'Sin asignar',
                haciaId: haciaValue,
                haciaNombre: haciaPotreroInfo?.displayName || haciaPotreroInfo?.nombre || 'Desconocido',
                animales: Array.from(selectedMoverAnimals),
                diasEnAnterior: diasEnAnterior
            };
            data.rotaciones.push(rotacion);

            // Update animal assignments with the full ID (for cross-ranch tracking)
            selectedMoverAnimals.forEach(numero => {
                data.animalPotreros[numero] = haciaValue;
            });

            // Update potrero states in source ranch data
            if (desdePotreroInfo && desdeRanch) {
                const sourceRanchData = getRanchData(desdeRanch);
                if (sourceRanchData) {
                    const potreroDesde = sourceRanchData.potreros?.find(p => p.id === desdePotreroId);
                    if (potreroDesde) {
                        potreroDesde.ultimaSalida = fecha;
                        // Check if potrero is now empty
                        const remaining = Object.values(data.animalPotreros).filter(pId =>
                            pId === desdeValue || pId === desdePotreroId
                        ).length;
                        if (remaining === 0) {
                            potreroDesde.estado = 'descanso';
                        }
                        saveRanchData(desdeRanch, sourceRanchData);
                    }
                }
            }

            // Update destination potrero state
            if (haciaPotreroInfo && haciaRanch) {
                const destRanchData = getRanchData(haciaRanch);
                if (destRanchData) {
                    const potreroHacia = destRanchData.potreros?.find(p => p.id === haciaPotreroId);
                    if (potreroHacia) {
                        potreroHacia.ultimaEntrada = fecha;
                        potreroHacia.estado = 'ocupado';
                        saveRanchData(haciaRanch, destRanchData);
                    }
                }
            }

            saveData();

            const destino = haciaPotreroInfo?.displayName || haciaPotreroInfo?.nombre || 'destino';
            showToast(`${selectedMoverAnimals.size} animales movidos a ${destino}`, 'success');

            hideMoverAnimalesForm();
        }

        // Helper function to get ranch data
        function getRanchData(ranchId) {
            const ranch = RANCHES[ranchId];
            if (!ranch) return null;
            const dataStr = localStorage.getItem(ranch.storageKey);
            if (!dataStr) return null;
            try {
                return JSON.parse(dataStr);
            } catch (e) {
                return null;
            }
        }

        // Helper function to save ranch data
        function saveRanchData(ranchId, ranchData) {
            const ranch = RANCHES[ranchId];
            if (!ranch) return;
            localStorage.setItem(ranch.storageKey, JSON.stringify(ranchData));
        }
        
        function updatePotrerosView() {
            updatePotrerosStats();
            updatePotrerosGrid();
            updateRotacionHistorial();
        }
        
        function updatePotrerosStats() {
            // Use shared potreros for La Coru√±a and Santa Catalina
            const potreros = usesSharedPotreros() ? getSharedPotreros() : (data.potreros || []);
            const total = potreros.length;
            const ocupados = potreros.filter(p => p.estado === 'ocupado').length;
            const descansando = potreros.filter(p => p.estado === 'descanso').length;

            // Count potreros that have been resting for 30+ days
            const today = new Date();
            const listos = potreros.filter(p => {
                if (p.estado !== 'descanso') return false;
                if (!p.ultimaSalida) return true; // Never used = ready
                const salida = new Date(p.ultimaSalida);
                const dias = Math.floor((today - salida) / (1000 * 60 * 60 * 24));
                return dias >= 30;
            }).length;

            document.getElementById('potrerosTotal').textContent = total;
            document.getElementById('potrerosOcupados').textContent = ocupados;
            document.getElementById('potrerosDescansando').textContent = descansando;
            document.getElementById('potrerosListos').textContent = listos;
        }

        function updatePotrerosGrid() {
            const container = document.getElementById('potrerosGrid');
            // Use shared potreros for La Coru√±a and Santa Catalina
            const potreros = usesSharedPotreros() ? getSharedPotreros() : (data.potreros || []);

            if (potreros.length === 0) {
                container.innerHTML = '<div class="text-center" style="grid-column: 1/-1; padding: 2rem; color: var(--gray);">No hay potreros registrados. Haga clic en "Agregar Potrero" para comenzar.</div>';
                return;
            }

            // Show info banner if using shared potreros
            let html = '';
            if (usesSharedPotreros()) {
                html += '<div style="grid-column: 1/-1; background: #dbeafe; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; color: #1e40af; display: flex; align-items: center; gap: 0.5rem;"><span style="font-size: 1.2rem;">üîÑ</span> <span>Potreros compartidos entre <strong>La Coru√±a</strong> y <strong>Santa Catalina</strong> - El ganado se mueve entre ambas fincas</span></div>';
            }

            const today = new Date();

            html += potreros.map(p => {
                // Count ALL animals in this potrero from ALL shared ranches
                const animalesInfo = countAnimalesInPotreroAllRanches(p);
                const animalesCount = animalesInfo.total;

                // Build breakdown text for tooltip/display
                let breakdownText = '';
                Object.entries(animalesInfo.byRanch).forEach(([ranchId, info]) => {
                    if (breakdownText) breakdownText += ' + ';
                    breakdownText += `${info.count} ${info.ranchName}`;
                });

                // Calculate days resting or occupied
                let diasEstado = null;
                if (p.estado === 'descanso' && p.ultimaSalida) {
                    diasEstado = Math.floor((today - new Date(p.ultimaSalida)) / (1000 * 60 * 60 * 24));
                } else if (p.estado === 'ocupado' && p.ultimaEntrada) {
                    diasEstado = Math.floor((today - new Date(p.ultimaEntrada)) / (1000 * 60 * 60 * 24));
                }

                const statusLabels = {
                    'disponible': 'üå± Disponible',
                    'ocupado': 'üêÑ Ocupado',
                    'descanso': 'üí§ Descanso',
                    'mantenimiento': 'üîß Mantenimiento'
                };

                const waterLabels = {
                    'quebrada': 'üåä Quebrada',
                    'bebedero': 'üö∞ Bebedero',
                    'jag√ºey': 'üíß Jag√ºey',
                    'pozo': 'üï≥Ô∏è Pozo',
                    'ninguna': '‚ùå Sin agua'
                };

                // Show which ranch this potrero belongs to (for shared potreros)
                const ranchLabel = p.sourceRanch ? RANCHES[p.sourceRanch]?.name : null;
                const potreroKey = `${p.sourceRanch}_${p.id}`;

                return `
                    <div class="potrero-card ${p.estado}" onclick="showPotreroAnimales('${potreroKey}')" style="cursor: pointer;">
                        <div class="potrero-card-header">
                            <div class="potrero-card-title">üåø ${p.nombre}</div>
                            <span class="potrero-card-status ${p.estado}">${statusLabels[p.estado]}</span>
                        </div>
                        ${ranchLabel ? `<div style="font-size: 0.75rem; color: #6b7280; margin-bottom: 0.5rem;">üìç ${ranchLabel}</div>` : ''}
                        <div class="potrero-card-stats">
                            <div class="potrero-stat">üìè ${p.area ? p.area + ' ha' : 'Sin √°rea'}</div>
                            <div class="potrero-stat">üåæ ${p.tipoPasto}</div>
                            <div class="potrero-stat" style="cursor: pointer;" title="${breakdownText || 'Sin animales'}">
                                üêÑ <strong>${animalesCount}</strong>${p.capacidad ? '/' + p.capacidad : ''} cabezas
                                ${breakdownText ? `<br><small style="color: #6b7280; font-size: 0.7rem;">${breakdownText}</small>` : ''}
                            </div>
                            <div class="potrero-stat">${waterLabels[p.agua] || '‚ùì'}</div>
                            ${diasEstado !== null ? `<div class="potrero-stat" style="grid-column: 1/-1;">‚è±Ô∏è ${diasEstado} d√≠as ${p.estado === 'descanso' ? 'descansando' : 'ocupado'}</div>` : ''}
                        </div>
                        ${p.notas ? `<div style="font-size: 0.8rem; color: #666; margin-bottom: 0.5rem;">üìù ${p.notas}</div>` : ''}
                        <div class="potrero-card-footer" onclick="event.stopPropagation();">
                            <button class="btn btn-secondary" onclick="showPotreroForm(${p.id}${p.sourceRanch ? ", '" + p.sourceRanch + "'" : ''})">‚úèÔ∏è Editar</button>
                            <button class="btn btn-danger" onclick="deletePotrero(${p.id}${p.sourceRanch ? ", '" + p.sourceRanch + "'" : ''})">üóëÔ∏è</button>
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = html;
        }

        // Show modal with animals in potrero, grouped by ranch
        function showPotreroAnimales(potreroKey) {
            // Parse potrero key (format: "ranchId_potreroId")
            const parts = potreroKey.split('_');
            const sourceRanch = parts[0];
            const potreroId = parseInt(parts.slice(1).join('_'));

            // Find potrero info
            const allPotreros = getAllSharedPotreros();
            const potrero = allPotreros.find(p => p.sourceRanch === sourceRanch && p.id === potreroId);

            if (!potrero) {
                showToast('Potrero no encontrado', 'error');
                return;
            }

            // Get animal counts from all ranches
            const animalesInfo = countAnimalesInPotreroAllRanches(potrero);

            // Build modal content
            let animalesHtml = '';

            if (animalesInfo.total === 0) {
                animalesHtml = '<div style="text-align: center; padding: 2rem; color: #6b7280;">No hay animales en este potrero</div>';
            } else {
                // Group by ranch
                Object.entries(animalesInfo.byRanch).forEach(([ranchId, info]) => {
                    const ranch = RANCHES[ranchId];
                    const ranchColor = ranchId === 'la_coruna' ? '#FFEB3B' : '#ff9800'; // Pure Yellow for Coru√±a, Orange for Catalina

                    animalesHtml += `
                        <div style="margin-bottom: 1.5rem;">
                            <div style="display: flex; align-items: center; gap: 0.5rem; padding: 0.75rem; background: ${ranchColor}25; border-left: 4px solid ${ranchColor}; border-radius: 0 8px 8px 0; margin-bottom: 0.75rem;">
                                <span style="font-size: 1.2rem;">${ranch.icon}</span>
                                <span style="font-weight: 600; color: ${ranchId === 'la_coruna' ? '#9a7b00' : '#c45000'};">${info.ranchName}</span>
                                <span style="background: ${ranchColor}; color: #000; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.85rem; margin-left: auto;">
                                    ${info.count} animal${info.count > 1 ? 'es' : ''}
                                </span>
                            </div>
                            <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; padding-left: 1rem;">
                                ${info.animales.map(a => `
                                    <div style="background: white; border: 1px solid #e5e7eb; padding: 0.5rem 0.75rem; border-radius: 6px; font-size: 0.9rem; display: flex; align-items: center; gap: 0.5rem;">
                                        <strong>#${a.numero}</strong>
                                        <span style="color: #6b7280; font-size: 0.8rem;">${a.peso || '?'}kg</span>
                                        <span style="font-size: 0.8rem;">${a.sexo === 'macho' ? '‚ôÇÔ∏è' : '‚ôÄÔ∏è'}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                });
            }

            // Create and show modal
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.id = 'potreroAnimalesModal';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 600px;">
                    <div class="modal-header" style="background: linear-gradient(135deg, #059669, #10b981);">
                        <span>üåø ${potrero.nombre} - Animales</span>
                        <button class="modal-close" onclick="document.getElementById('potreroAnimalesModal').remove()">√ó</button>
                    </div>
                    <div class="modal-body" style="padding: 1.5rem; max-height: 70vh; overflow-y: auto;">
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; background: #f0fdf4; border-radius: 8px; margin-bottom: 1.5rem;">
                            <div>
                                <div style="font-size: 0.85rem; color: #6b7280;">Total de animales</div>
                                <div style="font-size: 2rem; font-weight: 700; color: #059669;">${animalesInfo.total}</div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 0.85rem; color: #6b7280;">Capacidad</div>
                                <div style="font-size: 1.5rem; font-weight: 600; color: #6b7280;">${potrero.capacidad || '‚àû'}</div>
                            </div>
                        </div>

                        ${animalesHtml}
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function updateRotacionHistorial() {
            const tbody = document.getElementById('rotacionHistorialBody');

            if (data.rotaciones.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center">No hay movimientos registrados</td></tr>';
                return;
            }

            // Use shared potreros for name lookup
            const allPotreros = getAllSharedPotreros();

            const sorted = [...data.rotaciones].sort((a, b) => new Date(b.fecha) - new Date(a.fecha)).slice(0, 20);

            tbody.innerHTML = sorted.map(r => {
                // Use stored names if available (new format), otherwise look up
                let desde = 'Sin asignar';
                let hacia = 'Desconocido';

                if (r.desdeNombre) {
                    desde = r.desdeNombre;
                } else if (r.desdeId) {
                    // Try to find potrero (support both old and new ID formats)
                    const desdePotrero = findPotreroById(allPotreros, r.desdeId);
                    desde = desdePotrero ? (desdePotrero.displayName || desdePotrero.nombre) : 'Desconocido';
                }

                if (r.haciaNombre) {
                    hacia = r.haciaNombre;
                } else if (r.haciaId) {
                    const haciaPotrero = findPotreroById(allPotreros, r.haciaId);
                    hacia = haciaPotrero ? (haciaPotrero.displayName || haciaPotrero.nombre) : 'Desconocido';
                }

                return `<tr>
                    <td>${formatDate(r.fecha)}</td>
                    <td>${desde}</td>
                    <td>${hacia}</td>
                    <td>${r.animales.length} animal${r.animales.length > 1 ? 'es' : ''}</td>
                    <td>${r.diasEnAnterior !== null ? r.diasEnAnterior + ' d√≠as' : '-'}</td>
                </tr>`;
            }).join('');
        }

        // Helper to find potrero by ID (supports both old numeric ID and new "ranch_id" format)
        function findPotreroById(potreros, id) {
            if (!id) return null;

            // Try direct match first (for new format "ranch_id")
            let potrero = potreros.find(p => `${p.sourceRanch}_${p.id}` === id);
            if (potrero) return potrero;

            // Try numeric match (for old format)
            const numericId = typeof id === 'number' ? id : parseInt(id);
            if (!isNaN(numericId)) {
                potrero = potreros.find(p => p.id === numericId);
            }

            return potrero;
        }

        // Find potrero by the ID stored in animalPotreros (handles both formats)
        function findPotreroByAssignedId(potreros, assignedId) {
            if (!assignedId) return null;

            // Check if it's the new format "ranchId_potreroId"
            if (typeof assignedId === 'string' && assignedId.includes('_')) {
                const parts = assignedId.split('_');
                const ranchId = parts[0];
                const potreroId = parseInt(parts.slice(1).join('_'));
                return potreros.find(p => p.sourceRanch === ranchId && p.id === potreroId);
            }

            // Old format - just numeric ID
            const numericId = typeof assignedId === 'number' ? assignedId : parseInt(assignedId);
            if (!isNaN(numericId)) {
                return potreros.find(p => p.id === numericId);
            }

            return null;
        }

        // Check if an assigned potrero ID matches a potrero (handles both formats)
        function potreroIdMatches(assignedId, potrero) {
            if (!assignedId || !potrero) return false;

            // New format: "ranchId_potreroId"
            if (typeof assignedId === 'string' && assignedId.includes('_')) {
                return assignedId === `${potrero.sourceRanch}_${potrero.id}`;
            }

            // Old format: just numeric ID
            const numericId = typeof assignedId === 'number' ? assignedId : parseInt(assignedId);
            return !isNaN(numericId) && numericId === potrero.id;
        }

        // Count ALL animals in a potrero from ALL shared ranches
        function countAnimalesInPotreroAllRanches(potrero) {
            const result = {
                total: 0,
                byRanch: {}  // { ranchId: { count: X, animales: [...] } }
            };

            // Get all shared ranches
            SHARED_POTRERO_RANCHES.forEach(ranchId => {
                const ranch = RANCHES[ranchId];
                const ranchDataStr = localStorage.getItem(ranch.storageKey);
                if (!ranchDataStr) return;

                try {
                    const ranchData = JSON.parse(ranchDataStr);
                    const animalPotreros = ranchData.animalPotreros || {};
                    const entradas = ranchData.entradas || [];

                    // Find animals from this ranch in this potrero
                    const animalesEnPotrero = [];
                    Object.entries(animalPotreros).forEach(([numero, assignedId]) => {
                        if (potreroIdMatches(assignedId, potrero)) {
                            // Find animal info
                            const animal = entradas.find(a => a.numero === numero);
                            if (animal) {
                                animalesEnPotrero.push({
                                    numero: animal.numero,
                                    peso: animal.pesoActual || animal.peso,
                                    sexo: animal.sexo
                                });
                            }
                        }
                    });

                    if (animalesEnPotrero.length > 0) {
                        result.byRanch[ranchId] = {
                            count: animalesEnPotrero.length,
                            animales: animalesEnPotrero,
                            ranchName: ranch.name
                        };
                        result.total += animalesEnPotrero.length;
                    }
                } catch (e) {
                    console.error(`Error counting animals for ${ranchId}:`, e);
                }
            });

            return result;
        }
        
        // ==================== ANIMAL PROFILE MODULE ====================

        // Generate weight history table for animal profile
        function generateWeightHistoryTable(animal, weightUpdates, gdp) {
            // Sort updates by date ascending (oldest first) for chronological display
            const sortedUpdates = [...weightUpdates].sort((a, b) => {
                const dateCompare = new Date(a.fecha) - new Date(b.fecha);
                if (dateCompare !== 0) return dateCompare;
                return (a.id || 0) - (b.id || 0);
            });

            if (sortedUpdates.length === 0) {
                return `<div style="margin-top: 1rem; padding: 0.75rem; background: #f9fafb; border-radius: 8px; text-align: center; color: #6b7280; font-size: 0.85rem;">
                    üìä Sin historial de pesajes registrados
                </div>`;
            }

            // Build table with entry weight + all updates
            let tableHtml = `
                <div style="margin-top: 1rem; overflow-x: auto;">
                    <div style="font-size: 0.8rem; color: #374151; margin-bottom: 0.5rem; font-weight: 600;">üìä Historial de Pesajes</div>
                    <table style="width: 100%; border-collapse: collapse; font-size: 0.8rem; background: white; border-radius: 8px; overflow: hidden;">
                        <thead>
                            <tr style="background: #f3f4f6;">
                                <th style="padding: 0.5rem; text-align: left; border-bottom: 2px solid #e5e7eb;">Fecha</th>
                                <th style="padding: 0.5rem; text-align: right; border-bottom: 2px solid #e5e7eb;">Peso</th>
                                <th style="padding: 0.5rem; text-align: right; border-bottom: 2px solid #e5e7eb;">GDP Per√≠odo</th>
                                <th style="padding: 0.5rem; text-align: right; border-bottom: 2px solid #e5e7eb;">GDP Total</th>
                            </tr>
                        </thead>
                        <tbody>`;

            // Entry row
            const entryDate = new Date(animal.fechaEntrada);
            tableHtml += `
                <tr style="background: #f0fdf4;">
                    <td style="padding: 0.4rem 0.5rem; border-bottom: 1px solid #e5e7eb;">
                        <strong>Entrada</strong><br>
                        <span style="font-size: 0.7rem; color: #6b7280;">${entryDate.toLocaleDateString('es-CO')}</span>
                    </td>
                    <td style="padding: 0.4rem 0.5rem; text-align: right; border-bottom: 1px solid #e5e7eb; font-weight: bold;">
                        ${animal.peso} kg
                    </td>
                    <td style="padding: 0.4rem 0.5rem; text-align: right; border-bottom: 1px solid #e5e7eb; color: #6b7280;">
                        -
                    </td>
                    <td style="padding: 0.4rem 0.5rem; text-align: right; border-bottom: 1px solid #e5e7eb; color: #6b7280;">
                        -
                    </td>
                </tr>`;

            // Weight update rows
            let previousWeight = animal.peso;
            let previousDate = entryDate;

            sortedUpdates.forEach((update, index) => {
                const updateDate = new Date(update.fecha);
                const daysSincePrevious = Math.max(1, Math.floor((updateDate - previousDate) / (1000 * 60 * 60 * 24)));
                const daysSinceEntry = Math.max(1, Math.floor((updateDate - entryDate) / (1000 * 60 * 60 * 24)));

                const periodGain = update.pesoNuevo - previousWeight;
                const totalGain = update.pesoNuevo - animal.peso;

                const periodGDP = periodGain / daysSincePrevious;
                const totalGDP = totalGain / daysSinceEntry;

                // Calculate expected weight at this date
                const expectedWeight = animal.peso + (daysSinceEntry * gdp);

                // Color based on comparison to expected
                let weightColor = '';
                if (update.pesoNuevo > expectedWeight) {
                    weightColor = 'color: #16a34a; font-weight: bold;'; // Green - above estimate
                } else if (update.pesoNuevo < expectedWeight) {
                    weightColor = 'color: #dc2626; font-weight: bold;'; // Red - below estimate
                }

                // GDP color based on comparison to expected GDP
                let periodGDPColor = periodGDP >= gdp ? 'color: #16a34a;' : 'color: #dc2626;';
                let totalGDPColor = totalGDP >= gdp ? 'color: #16a34a;' : 'color: #dc2626;';

                tableHtml += `
                    <tr>
                        <td style="padding: 0.4rem 0.5rem; border-bottom: 1px solid #e5e7eb;">
                            ${updateDate.toLocaleDateString('es-CO')}<br>
                            <span style="font-size: 0.7rem; color: #6b7280;">${daysSincePrevious}d desde anterior</span>
                        </td>
                        <td style="padding: 0.4rem 0.5rem; text-align: right; border-bottom: 1px solid #e5e7eb; ${weightColor}">
                            ${update.pesoNuevo} kg
                            <span style="font-size: 0.7rem; display: block; ${periodGain >= 0 ? 'color: #16a34a;' : 'color: #dc2626;'}">${periodGain >= 0 ? '+' : ''}${periodGain.toFixed(0)} kg</span>
                        </td>
                        <td style="padding: 0.4rem 0.5rem; text-align: right; border-bottom: 1px solid #e5e7eb; ${periodGDPColor}">
                            ${periodGDP.toFixed(2)}
                        </td>
                        <td style="padding: 0.4rem 0.5rem; text-align: right; border-bottom: 1px solid #e5e7eb; ${totalGDPColor}">
                            ${totalGDP.toFixed(2)}
                        </td>
                    </tr>`;

                previousWeight = update.pesoNuevo;
                previousDate = updateDate;
            });

            tableHtml += `
                        </tbody>
                    </table>
                    <div style="font-size: 0.7rem; color: #6b7280; margin-top: 0.5rem; text-align: right;">
                        GDP esperado: ${gdp.toFixed(2)} kg/d√≠a | <span style="color: #16a34a;">Verde = sobre estimado</span> | <span style="color: #dc2626;">Rojo = bajo estimado</span>
                    </div>
                </div>`;

            return tableHtml;
        }

        function showAnimalProfile(numero) {
            const animal = getInventario().find(a => a.numero === numero);
            if (!animal) {
                showToast('Animal no encontrado', 'error');
                return;
            }

            const modal = document.getElementById('animalProfileModal');
            const body = document.getElementById('animalProfileBody');
            const title = document.getElementById('animalProfileTitle');

            title.textContent = `üêÇ Animal #${numero}`;

            // Calculate current estimated weight
            const today = new Date();
            const entryDate = new Date(animal.fechaEntrada);
            const days = Math.floor((today - entryDate) / (1000 * 60 * 60 * 24));
            const gdp = data.config.gdp || 0.31;
            const pesoEstimadoDefault = animal.peso + (days * gdp);

            // Check for manual weight updates from Progreso
            // Sort by date descending, then by id descending (for same-day updates)
            const animalUpdates = data.pesoUpdates ? data.pesoUpdates.filter(u => String(u.numero) === String(numero)).sort((a, b) => {
                const dateCompare = new Date(b.fecha) - new Date(a.fecha);
                if (dateCompare !== 0) return dateCompare;
                return (b.id || 0) - (a.id || 0); // Most recent id first for same date
            }) : [];
            const lastManualUpdate = animalUpdates.length > 0 ? animalUpdates[0] : null;

            // Use manual weight if available, otherwise use estimate
            let pesoActual, pesoStyle, hasManualWeight;
            if (lastManualUpdate) {
                pesoActual = lastManualUpdate.pesoNuevo;
                hasManualWeight = true;
                if (pesoActual > pesoEstimadoDefault) {
                    pesoStyle = 'color: #16a34a;'; // Green - above estimate
                } else if (pesoActual < pesoEstimadoDefault) {
                    pesoStyle = 'color: #dc2626;'; // Red - below estimate
                } else {
                    pesoStyle = '';
                }
            } else {
                pesoActual = pesoEstimadoDefault;
                hasManualWeight = false;
                pesoStyle = '';
            }

            const gananciaTotal = pesoActual - animal.peso;
            
            // Get potrero (supports both old numeric ID and new "ranch_id" format)
            const potreroId = data.animalPotreros[numero];
            const allPotreros = getAllSharedPotreros();
            const potrero = potreroId ? findPotreroByAssignedId(allPotreros, potreroId) : null;
            
            // Get health history
            const saludHistorial = data.saludEventos
                .filter(e => e.animales.includes(numero))
                .sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
            
            // Get photo sessions
            const fotoSesiones = (data.fotoSesiones || [])
                .filter(f => f.numero === numero)
                .sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
            const mainPhoto = animalPhotos[numero]?.photo || null;
            const mainPhotoDate = animalPhotos[numero]?.dateAdded || null;
            
            // Check retiro status
            const inRetiro = isAnimalInRetiro(numero);
            const retiroEnd = getRetiroEndDate(numero);
            
            // Calculate value
            const valorActual = pesoActual * (data.config.precioVenta || 9000);
            
            // Get GDP from photos if available
            const calculatedGDP = animal.gananciaDay || gdp;
            
            body.innerHTML = `
                <!-- Basic Info Section -->
                <div class="profile-section">
                    <div class="profile-section-title">üìã Informaci√≥n B√°sica</div>
                    <div class="profile-grid">
                        <div class="profile-item">
                            <span class="profile-item-label">Chapeta</span>
                            <span class="profile-item-value large">#${numero}</span>
                        </div>
                        <div class="profile-item">
                            <span class="profile-item-label">Lote</span>
                            <span class="profile-item-value">${animal.lote || '-'}</span>
                        </div>
                        <div class="profile-item">
                            <span class="profile-item-label">Sexo</span>
                            <span class="profile-item-value">${animal.sexo === 'MACHO' ? '‚ôÇÔ∏è Macho' : '‚ôÄÔ∏è Hembra'}</span>
                        </div>
                        <div class="profile-item">
                            <span class="profile-item-label">Raza</span>
                            <span class="profile-item-value">${animal.raza || 'No especificada'}</span>
                        </div>
                        <div class="profile-item">
                            <span class="profile-item-label">Tipo Entrada</span>
                            <span class="profile-item-value">${animal.tipo === 'nacimiento' ? 'üê£ Nacimiento' : 'üõí Compra'}</span>
                        </div>
                        <div class="profile-item">
                            <span class="profile-item-label">Fecha Entrada</span>
                            <span class="profile-item-value">${formatDate(animal.fechaEntrada)}</span>
                        </div>
                        <div class="profile-item">
                            <span class="profile-item-label">Vendedor</span>
                            <span class="profile-item-value">${animal.vendedor || '-'}</span>
                        </div>
                        <div class="profile-item">
                            <span class="profile-item-label">D√≠as en Finca</span>
                            <span class="profile-item-value">${days} d√≠as</span>
                        </div>
                    </div>
                </div>
                
                <!-- Weight Section -->
                <div class="profile-section" style="background: linear-gradient(135deg, #e8f5e9, #c8e6c9);">
                    <div class="profile-section-title" style="display: flex; justify-content: space-between; align-items: center;">
                        <span>‚öñÔ∏è Peso y Crecimiento</span>
                        <button onclick="closeAnimalProfile(); showQuickWeightUpdate('${numero}')" style="background: #16a34a; color: white; border: none; padding: 0.4rem 0.8rem; border-radius: 6px; font-size: 0.85rem; cursor: pointer;">
                            ‚öñÔ∏è Actualizar Peso
                        </button>
                    </div>
                    <div class="profile-grid">
                        <div class="profile-item">
                            <span class="profile-item-label">Peso Entrada</span>
                            <span class="profile-item-value">${animal.peso} kg</span>
                        </div>
                        <div class="profile-item">
                            <span class="profile-item-label">${hasManualWeight ? 'Peso Actual (Registrado)' : 'Peso Actual (Est.)'}</span>
                            <span class="profile-item-value large" style="${pesoStyle}">${Math.round(pesoActual)} kg</span>
                            ${hasManualWeight ? `<div style="font-size: 0.75rem; color: #666; margin-top: 0.25rem;">Est. por defecto: ${Math.round(pesoEstimadoDefault)} kg</div>` : ''}
                        </div>
                        <div class="profile-item">
                            <span class="profile-item-label">Ganancia Total</span>
                            <span class="profile-item-value" style="color: var(--success);">+${Math.round(gananciaTotal)} kg</span>
                        </div>
                        <div class="profile-item">
                            <span class="profile-item-label">GDP (Ganancia/d√≠a)</span>
                            <span class="profile-item-value">${calculatedGDP.toFixed(2)} kg/d√≠a</span>
                        </div>
                    </div>

                    <!-- Weight History Table -->
                    ${generateWeightHistoryTable(animal, animalUpdates, gdp)}
                </div>

                <!-- Financial Section -->
                <div class="profile-section" style="background: linear-gradient(135deg, #fff3e0, #ffe0b2);">
                    <div class="profile-section-title" style="display: flex; justify-content: space-between; align-items: center;">
                        <span>üí∞ Informaci√≥n Financiera</span>
                        <button onclick="showEditFinancialModal('${numero}')" style="background: #f59e0b; color: white; border: none; padding: 0.4rem 0.8rem; border-radius: 6px; font-size: 0.85rem; cursor: pointer;">
                            ‚úèÔ∏è Editar
                        </button>
                    </div>
                    <div class="profile-grid">
                        <div class="profile-item">
                            <span class="profile-item-label">Costo Compra</span>
                            <span class="profile-item-value">${formatCurrency(animal.costoTotal || (animal.peso * animal.precioKilo) || 0)}</span>
                        </div>
                        <div class="profile-item">
                            <span class="profile-item-label">Precio/Kg Compra</span>
                            <span class="profile-item-value">${formatCurrency(animal.precioKilo || 0)}/kg</span>
                        </div>
                        <div class="profile-item">
                            <span class="profile-item-label">Valor Actual (Est.)</span>
                            <span class="profile-item-value large">${formatCurrency(valorActual)}</span>
                        </div>
                        <div class="profile-item">
                            <span class="profile-item-label">Precio Venta/Kg</span>
                            <span class="profile-item-value">${formatCurrency(data.config.precioVenta)}/kg</span>
                        </div>
                    </div>
                </div>
                
                <!-- Location Section -->
                <div class="profile-section">
                    <div class="profile-section-title" style="display: flex; justify-content: space-between; align-items: center;">
                        <span>üìç Ubicaci√≥n</span>
                        <button onclick="showChangePotreroModal('${numero}')" style="background: #8b5cf6; color: white; border: none; padding: 0.4rem 0.8rem; border-radius: 6px; font-size: 0.85rem; cursor: pointer;">
                            üåø Cambiar Potrero
                        </button>
                    </div>
                    <div class="profile-grid">
                        <div class="profile-item" style="grid-column: 1/-1;">
                            <span class="profile-item-label">Potrero Actual</span>
                            <span class="profile-item-value">${potrero ? `üåø ${potrero.nombre}` : '‚ùì Sin asignar'}</span>
                        </div>
                    </div>
                </div>

                <!-- Condicion General Section -->
                <div class="profile-section" style="background: linear-gradient(135deg, #ede9fe, #ddd6fe);">
                    <div class="profile-section-title" style="display: flex; justify-content: space-between; align-items: center;">
                        <span>üìä Condici√≥n General</span>
                        <button onclick="startVoiceDictationForAnimal('${numero}')" style="background: #7c3aed; color: white; border: none; padding: 0.4rem 0.8rem; border-radius: 6px; font-size: 0.85rem; cursor: pointer;">
                            üé§ Dictar Observaci√≥n
                        </button>
                    </div>
                    <div class="profile-grid">
                        <div class="profile-item" style="grid-column: 1/-1;">
                            <span class="profile-item-label">Estado/Condici√≥n</span>
                            <span class="profile-item-value" id="animalCondicion_${numero}">${animal.condicionGeneral || 'Sin observaciones'}</span>
                        </div>
                    </div>
                    <div style="margin-top: 0.75rem;">
                        <select id="condicionSelect_${numero}" onchange="updateAnimalCondicion('${numero}', this.value)" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 6px;">
                            <option value="">Seleccionar condici√≥n...</option>
                            <option value="Excelente" ${animal.condicionGeneral === 'Excelente' ? 'selected' : ''}>Excelente</option>
                            <option value="Muy bien" ${animal.condicionGeneral === 'Muy bien' ? 'selected' : ''}>Muy bien</option>
                            <option value="Buenas condiciones" ${animal.condicionGeneral === 'Buenas condiciones' ? 'selected' : ''}>Buenas condiciones</option>
                            <option value="Regular" ${animal.condicionGeneral === 'Regular' ? 'selected' : ''}>Regular</option>
                            <option value="Flaco" ${animal.condicionGeneral === 'Flaco' ? 'selected' : ''}>Flaco</option>
                            <option value="Enfermo" ${animal.condicionGeneral === 'Enfermo' ? 'selected' : ''}>Enfermo</option>
                            <option value="Recuper√°ndose" ${animal.condicionGeneral === 'Recuper√°ndose' ? 'selected' : ''}>Recuper√°ndose</option>
                        </select>
                    </div>
                </div>

                <!-- Health Status -->
                <div class="profile-section" style="background: ${inRetiro ? 'linear-gradient(135deg, #ffebee, #ffcdd2)' : 'linear-gradient(135deg, #e3f2fd, #bbdefb)'};">
                    <div class="profile-section-title">üíâ Estado de Salud</div>
                    ${inRetiro ? `
                        <div class="alert-item critical" style="margin-bottom: 1rem;">
                            <span class="alert-icon">üö´</span>
                            <div class="alert-content">
                                <div class="alert-title">EN PERIODO DE RETIRO</div>
                                <div class="alert-desc">No disponible para venta hasta ${formatDate(retiroEnd.toISOString())}</div>
                            </div>
                        </div>
                    ` : ''}
                    ${saludHistorial.length > 0 ? `
                        <div style="font-size: 0.9rem;">
                            <strong>√öltimos eventos:</strong>
                            <ul style="margin: 0.5rem 0; padding-left: 1.5rem;">
                                ${saludHistorial.slice(0, 5).map(e => {
                                    const icons = { 'vacuna': 'üíâ', 'desparasitacion': 'üêõ', 'tratamiento': 'üíä', 'revision': 'ü©∫' };
                                    return `<li>${icons[e.tipo]} ${e.producto} - ${formatDate(e.fecha)}</li>`;
                                }).join('')}
                            </ul>
                        </div>
                    ` : '<div style="color: var(--gray);">Sin registros de salud</div>'}
                </div>

                ${generateOffspringSection(numero, animal)}

                <!-- Photo History -->
                <div class="profile-section">
                    <div class="profile-section-title" style="display: flex; justify-content: space-between; align-items: center;">
                        <span>üì∏ Historial Fotogr√°fico</span>
                        <button onclick="closeAnimalProfile(); showPhotoSourceSelection('${numero}', ${JSON.stringify(animal).replace(/"/g, '&quot;')})" style="background: #3b82f6; color: white; border: none; padding: 0.4rem 0.8rem; border-radius: 6px; font-size: 0.85rem; cursor: pointer;">
                            üì∑ ${mainPhoto ? 'Cambiar' : 'Agregar'} Foto
                        </button>
                    </div>
                    ${mainPhoto ? `
                        <div style="display: flex; gap: 1rem; align-items: center; margin-bottom: 1rem;">
                            <img src="${mainPhoto}" alt="Foto animal ${numero}" style="width: 120px; height: 120px; object-fit: cover; border-radius: 10px; border: 2px solid #e5e7eb; cursor: pointer;" onclick="viewAnimalPhotoLarge('${numero}')">
                            <div style="font-size: 0.9rem; color: #666;">
                                <div style="font-weight: 700; color: #111;">Foto principal</div>
                                <div>${mainPhotoDate ? formatDate(mainPhotoDate) : ''}</div>
                            </div>
                        </div>
                    ` : ''}
                    ${fotoSesiones.length > 0 ? `
                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 0.5rem;">
                            ${fotoSesiones.slice(0, 6).map(f => `
                                <div style="text-align: center; padding: 0.5rem; background: #f5f5f5; border-radius: 8px;">
                                    <div style="font-size: 1.5rem;">üì∑</div>
                                    <div style="font-size: 0.8rem;">${formatDate(f.fecha)}</div>
                                    <div style="font-size: 0.75rem; color: var(--gray);">BCS: ${f.bcs}</div>
                                    ${f.pesoBascula ? `<div style="font-size: 0.75rem; color: var(--success);">${f.pesoBascula} kg</div>` : ''}
                                </div>
                            `).join('')}
                        </div>
                        ${fotoSesiones.length > 6 ? `<div style="text-align: center; margin-top: 0.5rem; color: var(--gray);">+${fotoSesiones.length - 6} m√°s sesiones</div>` : ''}
                    ` : '<div style="color: var(--gray);">Sin sesiones fotogr√°ficas</div>'}
                </div>
                
                <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
                    <button class="btn btn-secondary" onclick="closeAnimalProfile()" style="flex: 1;">Cerrar</button>
                </div>
            `;
            
            modal.style.display = 'flex';
        }
        
        function closeAnimalProfile() {
            document.getElementById('animalProfileModal').style.display = 'none';
        }

        // Generate offspring/reproductive history section for animal profile
        function generateOffspringSection(numero, animal) {
            // Only show for San Fernando ranch and females
            if (currentRanch !== 'san_fernando') return '';

            const isFemale = animal.sexo === 'HEMBRA';
            const now = new Date();

            // Check if this animal is a calf (has a mother)
            const isCalfEntry = data.entradas.find(e => e.numero === numero && e.numeroVaca);

            let html = '';

            // For female cows - show their offspring
            if (isFemale) {
                // Get this cow's offspring
                const offspring = data.entradas.filter(e =>
                    e.tipoEntrada === 'nacimiento' && e.numeroVaca === numero
                ).sort((a, b) => new Date(b.fechaEntrada) - new Date(a.fechaEntrada));

                // Get reproductive status
                const reproStatus = getReproductiveStatus(numero);

                html += `
                    <div class="profile-section" style="background: linear-gradient(135deg, #fce7f3, #fbcfe8);">
                        <div class="profile-section-title">üêÑ Historial Reproductivo</div>
                        <div class="profile-grid">
                            <div class="profile-item">
                                <span class="profile-item-label">Estado Reproductivo</span>
                                <span class="profile-item-value" style="display: flex; align-items: center; gap: 0.5rem;">
                                    <span style="background: ${reproStatus.color}; color: white; padding: 0.25rem 0.5rem; border-radius: 6px; font-size: 0.85rem;">${reproStatus.label}</span>
                                </span>
                            </div>
                            <div class="profile-item">
                                <span class="profile-item-label">Total Cr√≠as</span>
                                <span class="profile-item-value large">${offspring.length}</span>
                            </div>
                        </div>
                        ${reproStatus.detail ? `<div style="font-size: 0.85rem; color: #666; margin-top: 0.5rem;">${reproStatus.detail}</div>` : ''}

                        ${offspring.length > 0 ? `
                            <div style="margin-top: 1rem;">
                                <strong style="font-size: 0.9rem; color: #9d174d;">Historial de Cr√≠as:</strong>
                                <div style="max-height: 200px; overflow-y: auto; margin-top: 0.5rem;">
                                    ${offspring.map(calf => {
                                        const birthDate = new Date(calf.fechaEntrada);
                                        const ageInDays = Math.floor((now - birthDate) / (1000 * 60 * 60 * 24));
                                        const ageInMonths = Math.floor(ageInDays / 30);
                                        const sexIcon = calf.sexo === 'MACHO' ? '‚ôÇÔ∏è' : '‚ôÄÔ∏è';
                                        const weanedBadge = calf.fechaDestete ? '<span style="background: #6366f1; color: white; padding: 0.1rem 0.3rem; border-radius: 4px; font-size: 0.7rem; margin-left: 0.5rem;">Destetada</span>' : '';

                                        return `
                                            <div style="background: white; padding: 0.5rem; border-radius: 6px; margin-bottom: 0.25rem; display: flex; justify-content: space-between; align-items: center;">
                                                <div>
                                                    <span style="font-weight: bold;">#${calf.numero}</span> ${sexIcon}
                                                    ${weanedBadge}
                                                </div>
                                                <div style="font-size: 0.8rem; color: #666;">
                                                    ${formatDate(calf.fechaEntrada)} (${ageInMonths}m)
                                                </div>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            </div>
                        ` : '<div style="margin-top: 0.75rem; color: #9d174d; font-style: italic;">Sin cr√≠as registradas</div>'}
                    </div>
                `;
            }

            // For calves - show their mother
            if (isCalfEntry) {
                const mother = data.inventario.find(inv => inv.numero === isCalfEntry.numeroVaca);
                const birthDate = new Date(isCalfEntry.fechaEntrada);
                const ageInDays = Math.floor((now - birthDate) / (1000 * 60 * 60 * 24));
                const ageInMonths = Math.floor(ageInDays / 30);

                // Weaning status
                let weaningStatus = 'Con madre';
                let weaningColor = '#10b981';
                if (isCalfEntry.fechaDestete) {
                    weaningStatus = 'Destetada';
                    weaningColor = '#6366f1';
                } else if (ageInDays >= 180 && ageInDays <= 270) {
                    weaningStatus = 'Lista para destete';
                    weaningColor = '#f59e0b';
                } else if (ageInDays > 270) {
                    weaningStatus = 'Destete urgente';
                    weaningColor = '#ef4444';
                }

                html += `
                    <div class="profile-section" style="background: linear-gradient(135deg, #dbeafe, #bfdbfe);">
                        <div class="profile-section-title">üë∂ Informaci√≥n de Cr√≠a</div>
                        <div class="profile-grid">
                            <div class="profile-item">
                                <span class="profile-item-label">Madre</span>
                                <span class="profile-item-value" style="cursor: pointer; color: #0284c7;" onclick="closeAnimalProfile(); setTimeout(() => showAnimalProfile('${isCalfEntry.numeroVaca}'), 300);">
                                    #${isCalfEntry.numeroVaca} ${mother ? `(${mother.raza || 'Sin raza'})` : ''}
                                </span>
                            </div>
                            <div class="profile-item">
                                <span class="profile-item-label">Edad</span>
                                <span class="profile-item-value">${ageInMonths} meses (${ageInDays} d√≠as)</span>
                            </div>
                            <div class="profile-item">
                                <span class="profile-item-label">Estado</span>
                                <span class="profile-item-value">
                                    <span style="background: ${weaningColor}; color: white; padding: 0.25rem 0.5rem; border-radius: 6px; font-size: 0.85rem;">${weaningStatus}</span>
                                </span>
                            </div>
                            ${isCalfEntry.fechaDestete ? `
                                <div class="profile-item">
                                    <span class="profile-item-label">Fecha Destete</span>
                                    <span class="profile-item-value">${formatDate(isCalfEntry.fechaDestete)}</span>
                                </div>
                                ${isCalfEntry.pesoDestete ? `
                                    <div class="profile-item">
                                        <span class="profile-item-label">Peso al Destete</span>
                                        <span class="profile-item-value">${isCalfEntry.pesoDestete} kg</span>
                                    </div>
                                ` : ''}
                            ` : ''}
                        </div>
                        ${!isCalfEntry.fechaDestete && ageInDays >= 180 ? `
                            <div style="margin-top: 0.75rem;">
                                <button onclick="closeAnimalProfile(); showRegistrarDesteteModal('${numero}')" class="btn" style="background: #f59e0b; color: white; padding: 0.4rem 0.75rem; font-size: 0.85rem;">
                                    üçº‚û°Ô∏è Registrar Destete
                                </button>
                            </div>
                        ` : ''}
                    </div>
                `;
            }

            return html;
        }

        // Quick weight update from animal profile
        function showQuickWeightUpdate(numero) {
            const animal = data.entradas.find(a => String(a.numero) === String(numero));
            if (!animal) {
                showToast('Animal no encontrado', 'error');
                return;
            }

            const diasEnFinca = getDiasEnFinca(animal.fechaEntrada);
            const pesoEstimado = animal.peso + (diasEnFinca * (data.config.gdp || 0.31));

            // Check for last manual update - sort by date then by id for same-day updates
            const animalUpdates = data.pesoUpdates ? data.pesoUpdates.filter(u => String(u.numero) === String(numero)).sort((a, b) => {
                const dateCompare = new Date(b.fecha) - new Date(a.fecha);
                if (dateCompare !== 0) return dateCompare;
                return (b.id || 0) - (a.id || 0);
            }) : [];
            const lastUpdate = animalUpdates.length > 0 ? animalUpdates[0] : null;
            const pesoAnterior = lastUpdate ? lastUpdate.pesoNuevo : animal.peso;

            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.id = 'quickWeightModal';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 450px;">
                    <div class="modal-header" style="background: linear-gradient(135deg, #16a34a, #15803d);">
                        <span>‚öñÔ∏è Actualizar Peso - #${numero}</span>
                        <button class="modal-close" onclick="document.getElementById('quickWeightModal').remove()">√ó</button>
                    </div>
                    <div class="modal-body" style="padding: 1.5rem;">
                        <div style="background: #f0fdf4; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                <span>Peso entrada:</span>
                                <strong>${animal.peso} kg</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                <span>Peso anterior:</span>
                                <strong>${pesoAnterior} kg</strong>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span>Peso estimado:</span>
                                <strong>${Math.round(pesoEstimado)} kg</strong>
                            </div>
                        </div>

                        <!-- Voice Input Button -->
                        <div style="text-align: center; margin-bottom: 1rem;">
                            <button onclick="startVoiceForWeightUpdate('${numero}')" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed); color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; font-size: 1rem; cursor: pointer;">
                                üé§ Dictar Peso y Observaciones
                            </button>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Nuevo Peso (kg)</label>
                            <input type="number" class="form-input" id="quickPesoNuevo" value="${Math.round(pesoEstimado)}" min="1" step="1" style="font-size: 1.2rem; text-align: center;">
                        </div>

                        <div class="form-group">
                            <label class="form-label">Fecha</label>
                            <input type="date" class="form-input" id="quickPesoFecha" value="${new Date().toISOString().split('T')[0]}">
                        </div>

                        <div class="form-group">
                            <label class="form-label">Observaciones (opcional)</label>
                            <textarea class="form-input" id="quickPesoObs" placeholder="Notas sobre el animal..." rows="2" style="resize: vertical;"></textarea>
                        </div>

                        <button onclick="saveQuickWeightUpdate('${numero}')" class="btn btn-primary" style="width: 100%; padding: 1rem; font-size: 1.1rem;">
                            üíæ Guardar Peso
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            document.getElementById('quickPesoNuevo').focus();
            document.getElementById('quickPesoNuevo').select();
        }

        function saveQuickWeightUpdate(numero) {
            const pesoNuevo = parseFloat(document.getElementById('quickPesoNuevo').value);
            const fecha = document.getElementById('quickPesoFecha').value;
            const observaciones = document.getElementById('quickPesoObs').value.trim();

            if (!pesoNuevo || pesoNuevo <= 0) {
                showToast('Ingrese un peso v√°lido', 'error');
                return;
            }

            const animal = data.entradas.find(a => String(a.numero) === String(numero));
            if (!animal) {
                showToast('Animal no encontrado', 'error');
                return;
            }

            // Get previous weight
            const animalUpdates = data.pesoUpdates ? data.pesoUpdates.filter(u => String(u.numero) === String(numero)).sort((a, b) => new Date(a.fecha) - new Date(b.fecha)) : [];
            const lastUpdate = animalUpdates[animalUpdates.length - 1];
            const pesoAnterior = lastUpdate ? lastUpdate.pesoNuevo : animal.peso;
            const fechaAnterior = lastUpdate ? lastUpdate.fecha : animal.fechaEntrada;

            const diasTranscurridos = Math.floor((new Date(fecha) - new Date(fechaAnterior)) / (1000 * 60 * 60 * 24));
            const ganancia = pesoNuevo - pesoAnterior;
            const gdpReal = diasTranscurridos > 0 ? ganancia / diasTranscurridos : 0;

            const update = {
                id: Date.now(),
                numero: String(animal.numero), // Ensure consistent format with animal data
                fecha: fecha,
                pesoAnterior: pesoAnterior,
                pesoNuevo: pesoNuevo,
                ganancia: ganancia,
                dias: diasTranscurridos,
                gdpReal: gdpReal,
                observaciones: observaciones
            };

            if (!data.pesoUpdates) data.pesoUpdates = [];
            data.pesoUpdates.push(update);

            // Close modal first
            const modal = document.getElementById('quickWeightModal');
            if (modal) modal.remove();

            // Save data and update views
            saveData();

            console.log('Weight update saved:', update);
            console.log('All peso updates:', data.pesoUpdates);

            showToast(`‚úÖ Peso actualizado: #${animal.numero} - ${pesoNuevo} kg`, 'success');
        }

        // Change potrero from animal profile
        function showChangePotreroModal(numero) {
            const currentPotreroId = data.animalPotreros[numero];
            // Use ALL shared potreros from La Coru√±a and Santa Catalina
            const potreros = getAllSharedPotreros();

            if (potreros.length === 0) {
                showToast('No hay potreros definidos. Cr√©elos en la pesta√±a Potreros.', 'warning');
                return;
            }

            // Find current potrero for display
            const currentPotrero = currentPotreroId ? findPotreroByAssignedId(potreros, currentPotreroId) : null;

            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.id = 'changePotreroModal';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 400px;">
                    <div class="modal-header" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed);">
                        <span>üåø Cambiar Potrero - #${numero}</span>
                        <button class="modal-close" onclick="document.getElementById('changePotreroModal').remove()">√ó</button>
                    </div>
                    <div class="modal-body" style="padding: 1.5rem;">
                        <div style="background: #dbeafe; padding: 0.75rem; border-radius: 6px; margin-bottom: 1rem; font-size: 0.85rem; color: #1e40af;">
                            ‚ÑπÔ∏è Potreros de La Coru√±a y Santa Catalina<br>
                            <small>El animal permanece en su finca original</small>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Seleccionar Potrero</label>
                            <select class="form-select" id="newPotreroSelect" style="font-size: 1.1rem;">
                                <option value="">‚ùì Sin asignar</option>
                                ${potreros.map(p => {
                                    const valueId = `${p.sourceRanch}_${p.id}`;
                                    const isCurrentPotrero = currentPotrero && p.sourceRanch === currentPotrero.sourceRanch && p.id === currentPotrero.id;
                                    return `
                                        <option value="${valueId}" ${isCurrentPotrero ? 'selected' : ''}>
                                            üåø ${p.displayName} ${isCurrentPotrero ? '(actual)' : ''}
                                        </option>
                                    `;
                                }).join('')}
                            </select>
                        </div>

                        <button onclick="savePotreroChange('${numero}')" class="btn btn-primary" style="width: 100%; padding: 1rem; font-size: 1.1rem; background: #8b5cf6;">
                            üíæ Guardar Ubicaci√≥n
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function savePotreroChange(numero) {
            const newPotreroId = document.getElementById('newPotreroSelect').value;

            if (newPotreroId) {
                data.animalPotreros[numero] = newPotreroId;
            } else {
                delete data.animalPotreros[numero];
            }

            saveData();
            document.getElementById('changePotreroModal').remove();

            // Refresh the animal profile if it's open
            const profileModal = document.getElementById('animalProfileModal');
            if (profileModal && profileModal.style.display !== 'none') {
                showAnimalProfile(numero);
            }

            updateAllViews();

            const potrero = data.potreros.find(p => p.id === newPotreroId);
            showToast(`‚úÖ Animal #${numero} ${potrero ? 'movido a ' + potrero.nombre : 'sin potrero asignado'}`, 'success');
        }

        // Edit financial information modal
        function showEditFinancialModal(numero) {
            const animal = data.entradas.find(e => String(e.numero) === String(numero));
            if (!animal) {
                showToast('Animal no encontrado', 'error');
                return;
            }

            // Check if animal is sold
            const salida = data.salidas ? data.salidas.find(s => String(s.numero) === String(numero)) : null;
            const isSold = !!salida;

            const costoTotal = animal.costoTotal || (animal.peso * animal.precioKilo) || 0;
            const precioKilo = animal.precioKilo || 0;
            const pesoEntrada = animal.peso || 0;

            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.id = 'editFinancialModal';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 450px;">
                    <div class="modal-header" style="background: linear-gradient(135deg, #f59e0b, #d97706);">
                        <span>‚úèÔ∏è Editar Informaci√≥n Financiera - #${numero}</span>
                        <button class="modal-close" onclick="document.getElementById('editFinancialModal').remove()">√ó</button>
                    </div>
                    <div class="modal-body" style="padding: 1.5rem;">
                        <div style="background: #fef3c7; padding: 0.75rem; border-radius: 6px; margin-bottom: 1rem; font-size: 0.85rem; color: #92400e;">
                            ‚ö†Ô∏è <strong>Atenci√≥n:</strong> Los cambios aqu√≠ afectar√°n los registros permanentes del animal.
                        </div>

                        <h4 style="color: #065f46; margin-bottom: 0.75rem; border-bottom: 2px solid #10b981; padding-bottom: 0.5rem;">
                            üì• Datos de Compra/Entrada
                        </h4>

                        <div class="form-group">
                            <label class="form-label">Peso de Entrada (kg)</label>
                            <input type="number" class="form-input" id="editPesoEntrada" value="${pesoEntrada}" step="0.1" min="0">
                        </div>

                        <div class="form-group">
                            <label class="form-label">Precio por Kg de Compra ($)</label>
                            <input type="number" class="form-input" id="editPrecioKilo" value="${precioKilo}" step="100" min="0">
                        </div>

                        <div class="form-group">
                            <label class="form-label">Costo Total de Compra ($)</label>
                            <input type="number" class="form-input" id="editCostoTotal" value="${costoTotal}" step="1000" min="0">
                            <small style="color: #666;">Se recalcula autom√°ticamente: Peso √ó Precio/kg</small>
                        </div>

                        ${isSold ? `
                        <h4 style="color: #065f46; margin-top: 1.5rem; margin-bottom: 0.75rem; border-bottom: 2px solid #10b981; padding-bottom: 0.5rem;">
                            üì§ Datos de Venta/Salida
                        </h4>

                        <div class="form-group">
                            <label class="form-label">Peso de Salida (kg)</label>
                            <input type="number" class="form-input" id="editPesoSalida" value="${salida.peso || 0}" step="0.1" min="0">
                        </div>

                        <div class="form-group">
                            <label class="form-label">Precio por Kg de Venta ($)</label>
                            <input type="number" class="form-input" id="editPrecioVenta" value="${salida.precioKilo || 0}" step="100" min="0">
                        </div>

                        <div class="form-group">
                            <label class="form-label">Total de Venta ($)</label>
                            <input type="number" class="form-input" id="editTotalVenta" value="${salida.total || 0}" step="1000" min="0">
                        </div>
                        ` : ''}

                        <button onclick="prepareFinancialUpdate('${numero}', ${isSold})" class="btn btn-primary" style="width: 100%; padding: 1rem; font-size: 1.1rem; background: #f59e0b; margin-top: 1rem;">
                            üíæ Revisar Cambios
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            // Auto-calculate costo total when peso or precio changes
            const pesoInput = document.getElementById('editPesoEntrada');
            const precioInput = document.getElementById('editPrecioKilo');
            const costoInput = document.getElementById('editCostoTotal');

            const recalculate = () => {
                const peso = parseFloat(pesoInput.value) || 0;
                const precio = parseFloat(precioInput.value) || 0;
                costoInput.value = Math.round(peso * precio);
            };

            pesoInput.addEventListener('input', recalculate);
            precioInput.addEventListener('input', recalculate);

            // Same for sale if sold
            if (isSold) {
                const pesoSalidaInput = document.getElementById('editPesoSalida');
                const precioVentaInput = document.getElementById('editPrecioVenta');
                const totalVentaInput = document.getElementById('editTotalVenta');

                const recalculateSale = () => {
                    const peso = parseFloat(pesoSalidaInput.value) || 0;
                    const precio = parseFloat(precioVentaInput.value) || 0;
                    totalVentaInput.value = Math.round(peso * precio);
                };

                pesoSalidaInput.addEventListener('input', recalculateSale);
                precioVentaInput.addEventListener('input', recalculateSale);
            }
        }

        function prepareFinancialUpdate(numero, isSold) {
            const animal = data.entradas.find(e => String(e.numero) === String(numero));
            if (!animal) return;

            const salida = isSold ? data.salidas.find(s => String(s.numero) === String(numero)) : null;

            // Get new values
            const newPesoEntrada = parseFloat(document.getElementById('editPesoEntrada').value) || 0;
            const newPrecioKilo = parseFloat(document.getElementById('editPrecioKilo').value) || 0;
            const newCostoTotal = parseFloat(document.getElementById('editCostoTotal').value) || 0;

            // Build change summary
            let changes = [];
            if (animal.peso !== newPesoEntrada) {
                changes.push(`Peso Entrada: ${animal.peso || 0} kg ‚Üí ${newPesoEntrada} kg`);
            }
            if (animal.precioKilo !== newPrecioKilo) {
                changes.push(`Precio/Kg Compra: ${formatCurrency(animal.precioKilo || 0)} ‚Üí ${formatCurrency(newPrecioKilo)}`);
            }
            if ((animal.costoTotal || (animal.peso * animal.precioKilo) || 0) !== newCostoTotal) {
                changes.push(`Costo Total: ${formatCurrency(animal.costoTotal || (animal.peso * animal.precioKilo) || 0)} ‚Üí ${formatCurrency(newCostoTotal)}`);
            }

            let saleChanges = [];
            if (isSold && salida) {
                const newPesoSalida = parseFloat(document.getElementById('editPesoSalida').value) || 0;
                const newPrecioVenta = parseFloat(document.getElementById('editPrecioVenta').value) || 0;
                const newTotalVenta = parseFloat(document.getElementById('editTotalVenta').value) || 0;

                if (salida.peso !== newPesoSalida) {
                    saleChanges.push(`Peso Salida: ${salida.peso || 0} kg ‚Üí ${newPesoSalida} kg`);
                }
                if (salida.precioKilo !== newPrecioVenta) {
                    saleChanges.push(`Precio/Kg Venta: ${formatCurrency(salida.precioKilo || 0)} ‚Üí ${formatCurrency(newPrecioVenta)}`);
                }
                if (salida.total !== newTotalVenta) {
                    saleChanges.push(`Total Venta: ${formatCurrency(salida.total || 0)} ‚Üí ${formatCurrency(newTotalVenta)}`);
                }
            }

            if (changes.length === 0 && saleChanges.length === 0) {
                showToast('No hay cambios para guardar', 'info');
                return;
            }

            // First confirmation with summary
            let confirmMsg = `¬øDesea realizar los siguientes cambios para el animal #${numero}?\n\n`;
            if (changes.length > 0) {
                confirmMsg += `üì• DATOS DE COMPRA:\n${changes.map(c => '  ‚Ä¢ ' + c).join('\n')}\n\n`;
            }
            if (saleChanges.length > 0) {
                confirmMsg += `üì§ DATOS DE VENTA:\n${saleChanges.map(c => '  ‚Ä¢ ' + c).join('\n')}\n\n`;
            }
            confirmMsg += `\n¬øContinuar?`;

            if (!confirm(confirmMsg)) {
                return;
            }

            // Second confirmation
            if (!confirm('‚ö†Ô∏è CONFIRMACI√ìN FINAL\n\nEste cambio afectar√° los registros permanentes y se sincronizar√° con la nube.\n\n¬øEst√° completamente seguro?')) {
                return;
            }

            // Apply changes
            applyFinancialChanges(numero, isSold);
        }

        function applyFinancialChanges(numero, isSold) {
            const animal = data.entradas.find(e => String(e.numero) === String(numero));
            if (!animal) return;

            // Store old values for log
            const oldValues = {
                peso: animal.peso,
                precioKilo: animal.precioKilo,
                costoTotal: animal.costoTotal
            };

            // Update entrada
            animal.peso = parseFloat(document.getElementById('editPesoEntrada').value) || 0;
            animal.precioKilo = parseFloat(document.getElementById('editPrecioKilo').value) || 0;
            animal.costoTotal = parseFloat(document.getElementById('editCostoTotal').value) || 0;

            // Add edit log to animal
            if (!animal.editLog) animal.editLog = [];
            animal.editLog.push({
                fecha: new Date().toISOString(),
                tipo: 'financial_edit',
                oldValues: oldValues,
                newValues: {
                    peso: animal.peso,
                    precioKilo: animal.precioKilo,
                    costoTotal: animal.costoTotal
                }
            });

            // Update salida if sold
            if (isSold) {
                const salida = data.salidas.find(s => String(s.numero) === String(numero));
                if (salida) {
                    const oldSaleValues = {
                        peso: salida.peso,
                        precioKilo: salida.precioKilo,
                        total: salida.total
                    };

                    salida.peso = parseFloat(document.getElementById('editPesoSalida').value) || 0;
                    salida.precioKilo = parseFloat(document.getElementById('editPrecioVenta').value) || 0;
                    salida.total = parseFloat(document.getElementById('editTotalVenta').value) || 0;

                    // Recalculate GDP for sold animal
                    const diasEnFinca = salida.fechaSalida && animal.fechaEntrada
                        ? Math.floor((new Date(salida.fechaSalida) - new Date(animal.fechaEntrada)) / (1000 * 60 * 60 * 24))
                        : 0;
                    if (diasEnFinca > 0) {
                        salida.gananciaDay = (salida.peso - animal.peso) / diasEnFinca;
                    }

                    // Add edit log to salida
                    if (!salida.editLog) salida.editLog = [];
                    salida.editLog.push({
                        fecha: new Date().toISOString(),
                        tipo: 'financial_edit',
                        oldValues: oldSaleValues,
                        newValues: {
                            peso: salida.peso,
                            precioKilo: salida.precioKilo,
                            total: salida.total
                        }
                    });
                }
            }

            // Save data
            saveData();

            // Close modal
            document.getElementById('editFinancialModal').remove();

            // Refresh the animal profile
            showAnimalProfile(numero);

            // Update all views
            updateAllViews();

            showToast(`‚úÖ Informaci√≥n financiera del animal #${numero} actualizada`, 'success');
        }

        // Close modal when clicking outside
        document.addEventListener('click', function(e) {
            const modal = document.getElementById('animalProfileModal');
            if (e.target === modal) {
                closeAnimalProfile();
            }
        });

        // ==================== PESO PROGRESS TRACKING MODULE ====================
        
        function showRegistrarPesoForm() {
            document.getElementById('pesoFormContainer').style.display = 'block';
            document.getElementById('pesoFecha').value = new Date().toISOString().split('T')[0];
            populatePesoAnimalSelector();
            document.getElementById('pesoAnimalInfo').style.display = 'none';
        }
        
        function hidePesoForm() {
            document.getElementById('pesoFormContainer').style.display = 'none';
            document.getElementById('pesoForm').reset();
            document.getElementById('pesoAnimalNumero').value = '';
            document.getElementById('pesoAnimalInfo').style.display = 'none';
        }
        
        function populatePesoAnimalSelector() {
            const container = document.getElementById('pesoAnimalSelector');
            const inventario = getInventario();
            
            if (inventario.length === 0) {
                container.innerHTML = '<div style="padding: 1rem; text-align: center; color: var(--gray);">No hay animales en inventario</div>';
                return;
            }
            
            // Simple chip-style selector - just chapeta numbers
            container.innerHTML = inventario.map(animal => {
                return `
                    <div class="animal-chip" data-numero="${animal.numero}" onclick="selectAnimalForPeso('${animal.numero}')">
                        #${animal.numero}
                    </div>
                `;
            }).join('');
            
            // Add hover and selection effects
            document.querySelectorAll('#pesoAnimalSelector .animal-chip').forEach(chip => {
                chip.addEventListener('mouseenter', function() {
                    if (!this.classList.contains('selected')) {
                        this.style.borderColor = 'var(--primary)';
                        this.style.background = '#e8f5e9';
                    }
                });
                chip.addEventListener('mouseleave', function() {
                    if (!this.classList.contains('selected')) {
                        this.style.borderColor = '#ddd';
                        this.style.background = 'white';
                    }
                });
            });
        }
        
        function selectAnimalForPeso(numero) {
            const animal = getInventario().find(a => a.numero == numero);
            if (!animal) return;
            
            document.getElementById('pesoAnimalNumero').value = numero;
            
            // Visual selection
            document.querySelectorAll('#pesoAnimalSelector .animal-chip').forEach(opt => {
                opt.classList.remove('selected');
                opt.style.borderColor = '';
                opt.style.background = '';
            });
            const selectedChip = document.querySelector(`#pesoAnimalSelector .animal-chip[data-numero="${numero}"]`);
            if (selectedChip) {
                selectedChip.style.borderColor = '';
                selectedChip.style.background = '';
                selectedChip.classList.add('selected');
            }
            
            // Show animal info
            const diasEnFinca = getDiasEnFinca(animal.fechaEntrada);
            const pesoEstimadoActual = animal.peso + (diasEnFinca * data.config.gdp);
            
            // Get last update if exists
            const updates = data.pesoUpdates ? data.pesoUpdates.filter(u => u.numero == numero).sort((a, b) => new Date(b.fecha) - new Date(a.fecha)) : [];
            const lastUpdate = updates[0];
            
            const infoHtml = `
                <strong>Chapeta: #${numero}</strong><br>
                ${animal.sexo === 'MACHO' ? '‚ôÇÔ∏è' : '‚ôÄÔ∏è'} ${animal.raza || 'Ceb√∫'} - ${animal.vendedor || 'Nacimiento'}<br>
                <div style="margin-top: 0.5rem;">
                    üìä Peso Entrada: <strong>${animal.peso} kg</strong><br>
                    üìà Peso Estimado Actual: <strong>${pesoEstimadoActual.toFixed(0)} kg</strong><br>
                    üìÖ ${diasEnFinca} d√≠as en finca
                    ${lastUpdate ? `<br>üîÑ √öltima actualizaci√≥n: ${lastUpdate.pesoNuevo} kg (${formatDate(lastUpdate.fecha)})` : ''}
                </div>
            `;
            
            document.getElementById('pesoAnimalInfoContent').innerHTML = infoHtml;
            document.getElementById('pesoAnimalInfo').style.display = 'block';
            
            // Pre-fill with estimated weight
            document.getElementById('pesoNuevo').value = Math.round(pesoEstimadoActual);
            document.getElementById('pesoNuevo').focus();
        }
        
        function filterAnimalsForPeso() {
            const search = document.getElementById('pesoSearchAnimal').value.toLowerCase();
            document.querySelectorAll('#pesoAnimalSelector .animal-chip').forEach(opt => {
                const numero = opt.dataset.numero.toLowerCase();
                const text = opt.textContent.toLowerCase();
                opt.style.display = (numero.includes(search) || text.includes(search)) ? '' : 'none';
            });
        }
        
        function getDiasDesde(fechaStr) {
            const fecha = new Date(fechaStr);
            const hoy = new Date();
            return Math.floor((hoy - fecha) / (1000 * 60 * 60 * 24));
        }
        
        function savePesoUpdate(event) {
            event.preventDefault();
            
            const numero = document.getElementById('pesoAnimalNumero').value;
            if (!numero) {
                showToast('Debe seleccionar un animal', 'error');
                return;
            }
            
            const animal = getInventario().find(a => a.numero == numero);
            if (!animal) {
                showToast('Animal no encontrado', 'error');
                return;
            }
            
            const pesoNuevo = parseFloat(document.getElementById('pesoNuevo').value);
            const fecha = document.getElementById('pesoFecha').value;
            const observaciones = document.getElementById('pesoObservaciones').value.trim();
            
            if (!pesoNuevo || pesoNuevo <= 0) {
                showToast('Ingrese un peso v√°lido', 'error');
                return;
            }
            
            if (!fecha) {
                showToast('Ingrese la fecha', 'error');
                return;
            }
            
            // Calculate previous weight and days
            const updates = data.pesoUpdates ? data.pesoUpdates.filter(u => u.numero == numero).sort((a, b) => new Date(a.fecha) - new Date(b.fecha)) : [];
            const lastUpdate = updates[updates.length - 1];
            
            let pesoAnterior, diasTranscurridos, fechaAnterior;
            
            if (lastUpdate) {
                pesoAnterior = lastUpdate.pesoNuevo;
                fechaAnterior = lastUpdate.fecha;
            } else {
                pesoAnterior = animal.peso;
                fechaAnterior = animal.fechaEntrada;
            }
            
            diasTranscurridos = Math.floor((new Date(fecha) - new Date(fechaAnterior)) / (1000 * 60 * 60 * 24));
            
            if (diasTranscurridos < 0) {
                showToast('La fecha no puede ser anterior al √∫ltimo registro', 'error');
                return;
            }
            
            const ganancia = pesoNuevo - pesoAnterior;
            const gdpReal = diasTranscurridos > 0 ? ganancia / diasTranscurridos : 0;
            
            // Create update record
            const update = {
                id: Date.now(),
                numero: numero,
                fecha: fecha,
                pesoAnterior: pesoAnterior,
                pesoNuevo: pesoNuevo,
                ganancia: ganancia,
                dias: diasTranscurridos,
                gdpReal: gdpReal,
                observaciones: observaciones
            };
            
            // Initialize array if needed
            if (!data.pesoUpdates) data.pesoUpdates = [];
            
            data.pesoUpdates.push(update);
            saveData();
            
            showToast(`‚úÖ Peso actualizado: #${numero} - ${pesoNuevo} kg (GDP: ${gdpReal.toFixed(3)} kg/d√≠a)`, 'success');
            
            hidePesoForm();
            updateProgresoView();
        }
        
        function updateProgresoView() {
            const tbody = document.getElementById('progresoHistoryTable');
            
            if (!data.pesoUpdates || data.pesoUpdates.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="text-center">No hay actualizaciones registradas</td></tr>';
                return;
            }
            
            // Sort by date descending
            const sorted = [...data.pesoUpdates].sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
            
            tbody.innerHTML = sorted.map(update => {
                const gananciaClass = update.ganancia >= 0 ? 'var(--success)' : 'var(--danger)';
                const gdpClass = update.gdpReal >= 0.3 ? 'var(--success)' : (update.gdpReal >= 0.2 ? 'var(--warning)' : 'var(--danger)');
                
                return `
                    <tr>
                        <td><strong>#${update.numero}</strong></td>
                        <td>${formatDate(update.fecha)}</td>
                        <td class="text-right">${update.pesoAnterior} kg</td>
                        <td class="text-right"><strong>${update.pesoNuevo} kg</strong></td>
                        <td class="text-right" style="color: ${gananciaClass};">
                            ${update.ganancia >= 0 ? '+' : ''}${update.ganancia.toFixed(1)} kg
                        </td>
                        <td class="text-right">${update.dias}</td>
                        <td class="text-right" style="color: ${gdpClass}; font-weight: bold;">
                            ${update.gdpReal.toFixed(3)} kg/d√≠a
                        </td>
                        <td>${update.observaciones || '-'}</td>
                        <td class="text-center">
                            <button class="btn btn-danger" style="padding: 0.15rem 0.4rem; font-size: 0.75rem;" onclick="deletePesoUpdate(${update.id})">üóëÔ∏è</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        function filterProgreso() {
            const search = document.getElementById('progresoSearch').value.toLowerCase();
            document.querySelectorAll('#progresoHistoryTable tr').forEach(row => {
                if (row.querySelector('td')) {
                    const text = row.textContent.toLowerCase();
                    row.style.display = text.includes(search) ? '' : 'none';
                }
            });
        }
        
        function deletePesoUpdate(id) {
            if (!confirm('¬øEliminar esta actualizaci√≥n de peso?')) return;
            
            data.pesoUpdates = data.pesoUpdates.filter(u => u.id !== id);
            saveData();
            updateProgresoView();
            showToast('Actualizaci√≥n eliminada', 'warning');
        }
        
        // ==================== ANIMAL PHOTO PROFILES MODULE ====================
        
        // Storage for animal photos with breed detection
        let animalPhotos = {}; // { chapeta: { photo: dataUrl, breed: {...}, dateAdded: timestamp } }
        
        function loadAnimalPhotos() {
            const saved = localStorage.getItem('animalPhotos_' + currentRanch);
            if (saved) {
                try {
                    animalPhotos = JSON.parse(saved);
                    console.log(`üì∑ Loaded ${Object.keys(animalPhotos).length} animal photos for ${RANCHES[currentRanch].name}`);
                } catch (error) {
                    console.error('Error loading animal photos:', error);
                    animalPhotos = {};
                    showToast('‚ö†Ô∏è Error cargando fotos guardadas', 'warning');
                }
            } else {
                animalPhotos = {};
                console.log(`üì∑ No photos found for ${RANCHES[currentRanch].name}`);
            }
        }
        
        function saveAnimalPhotos() {
            try {
                const photosJson = JSON.stringify(animalPhotos);
                const sizeKB = (new Blob([photosJson]).size / 1024).toFixed(2);
                
                // Check size before saving (warn if > 5MB)
                if (sizeKB > 5000) {
                    console.warn(`Photo storage is large: ${sizeKB} KB. Consider cleaning up old photos.`);
                }
                
                localStorage.setItem('animalPhotos_' + currentRanch, photosJson);
                console.log(`‚úÖ Photos saved successfully (${sizeKB} KB, ${Object.keys(animalPhotos).length} animals)`);
                
                // Force reload photos from storage to ensure sync
                loadAnimalPhotos();
                
                // Update the photos grid display
                updateAnimalPhotosGrid();
                
                // Also update inventory views in case photos affect animal display
                updateInventarioTable();
            } catch (error) {
                console.error('Error saving photos:', error);
                if (error.name === 'QuotaExceededError') {
                    throw new Error('Almacenamiento lleno. Elimine fotos antiguas.');
                }
                throw error;
            }
        }
        
        function updateAnimalPhotosGrid() {
            const grid = document.getElementById('animalPhotosGrid');
            if (!grid) return;
            
            const photoKeys = Object.keys(animalPhotos);
            
            if (photoKeys.length === 0) {
                grid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; color: var(--gray); padding: 2rem;">No hay fotos registradas a√∫n</div>';
                return;
            }
            
            grid.innerHTML = photoKeys.map(chapeta => {
                const photoData = animalPhotos[chapeta];
                const animal = data.entradas.find(e => e.numero == chapeta);
                const breedInfo = photoData.breed ? photoData.breed.breedName || 'Raza detectada' : 'Sin detecci√≥n de raza';
                const confidence = photoData.breed?.confidence || 0;
                
                return `
                    <div style="background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1); transition: transform 0.3s;" onmouseover="this.style.transform='translateY(-4px)'" onmouseout="this.style.transform='translateY(0)'">
                        <div style="position: relative; padding-top: 100%; background: #f5f5f5; cursor: pointer;" onclick="viewAnimalPhotoLarge('${chapeta}')">
                            <img src="${photoData.photo}" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover;" alt="Animal ${chapeta}">
                            ${animal ? '' : '<div style="position: absolute; top: 8px; right: 8px; background: rgba(255,152,0,0.9); color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.75rem;">‚ö†Ô∏è No en inventario</div>'}
                        </div>
                        <div style="padding: 1rem;">
                            <div style="font-size: 1.1rem; font-weight: bold; margin-bottom: 0.5rem;">
                                üêÇ #${chapeta}
                            </div>
                            ${animal ? `
                                <div style="font-size: 0.85rem; color: #666; margin-bottom: 0.5rem;">
                                    ${animal.sexo === 'MACHO' ? '‚ôÇÔ∏è' : '‚ôÄÔ∏è'} ${animal.vendedor || 'Nacimiento'}
                                </div>
                            ` : ''}
                            <div style="font-size: 0.8rem; color: #666; margin-bottom: 0.5rem;">
                                üìÖ ${formatDate(photoData.dateAdded)}
                            </div>
                            ${photoData.breed ? `
                                <div style="background: ${confidence >= 80 ? '#e8f5e9' : '#fff3e0'}; padding: 0.5rem; border-radius: 6px; font-size: 0.85rem; margin-bottom: 0.5rem;">
                                    <strong>üß¨ ${breedInfo}</strong>
                                    <div style="font-size: 0.75rem; color: #666;">Confianza: ${confidence}%</div>
                                </div>
                            ` : ''}
                            <div style="display: flex; gap: 0.5rem; margin-top: 0.75rem;">
                                <button class="btn btn-danger" style="flex: 1; padding: 0.4rem; font-size: 0.8rem;" onclick="event.stopPropagation(); deleteAnimalPhoto('${chapeta}')">
                                    üóëÔ∏è Eliminar
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Simple photo capture with AI breed detection
        function captureAnimalPhoto(chapetaNum, useCamera = true) {
            // Create file input
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';

            // Only use camera capture on mobile devices if useCamera is true
            if (useCamera && /Android|iPhone|iPad|iPod/i.test(navigator.userAgent)) {
                input.capture = 'environment';
            }
            // Otherwise, it will open file picker (gallery on mobile, file browser on desktop)

            input.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;

                // Validate file type
                if (!file.type.startsWith('image/')) {
                    showToast('‚ùå El archivo seleccionado no es una imagen v√°lida', 'error');
                    return;
                }

                // Validate file size (max 10MB before compression)
                const maxSize = 10 * 1024 * 1024; // 10MB
                if (file.size > maxSize) {
                    showToast('‚ö†Ô∏è La imagen es muy grande (m√°x 10MB). Se intentar√° comprimir...', 'warning');
                }

                showToast('üì∑ Procesando foto...', 'info');

                try {
                    // Compress image
                    compressImage(file, (compressedDataUrl) => {
                        try {
                            const timestamp = new Date().toISOString();

                            // Store photo immediately
                            animalPhotos[chapetaNum] = {
                                photo: compressedDataUrl,
                                breed: null,
                                dateAdded: timestamp
                            };

                            console.log(`üì∏ Photo ${useCamera ? 'captured' : 'uploaded'} for animal #${chapetaNum}`, {
                                photoSize: (compressedDataUrl.length / 1024).toFixed(2) + ' KB',
                                totalPhotos: Object.keys(animalPhotos).length,
                                source: useCamera ? 'camera' : 'file'
                            });

                            // Save to localStorage with error handling
                            try {
                                saveAnimalPhotos();

                                // Verify the photo was actually saved
                                const saved = localStorage.getItem('animalPhotos_' + currentRanch);
                                if (!saved || !JSON.parse(saved)[chapetaNum]) {
                                    throw new Error('La foto no se guard√≥ correctamente en el almacenamiento');
                                }

                                updateAllViews();
                                showToast(`‚úÖ Foto guardada exitosamente para animal #${chapetaNum}`, 'success');

                                // Trigger automatic sync if enabled
                                if (window.cloudSync && window.cloudSync.enabled) {
                                    cloudSync.triggerAutoSync();
                                }
                            } catch (saveError) {
                                // Handle storage quota exceeded
                                if (saveError.name === 'QuotaExceededError') {
                                    delete animalPhotos[chapetaNum]; // Remove failed save
                                    showToast('‚ùå Almacenamiento lleno. Elimine fotos antiguas o exporte los datos.', 'error');
                                    alert('‚ö†Ô∏è ALMACENAMIENTO LLENO\n\nLas fotos ocupan mucho espacio. Para continuar:\n\n1. Exporte los datos actuales\n2. Elimine fotos de animales ya vendidos\n3. Use la funci√≥n de respaldo\n4. Considere reducir el n√∫mero de fotos por animal');
                                    return;
                                } else {
                                    throw saveError;
                                }
                            }

                            // Add to photo history (animal profile)
                            try {
                                addQuickPhotoSession(chapetaNum, timestamp);
                            } catch (historyError) {
                                console.error('Error saving photo session:', historyError);
                                showToast('‚ö†Ô∏è Foto guardada, pero no se pudo registrar en el historial', 'warning');
                            }

                            // Sin detecci√≥n de raza para acelerar el proceso
                        } catch (error) {
                            console.error('Error saving photo:', error);
                            showToast('‚ùå Error al guardar foto: ' + error.message, 'error');
                        }
                    });
                } catch (error) {
                    console.error('Error processing photo:', error);
                    showToast('‚ùå Error al procesar foto: ' + error.message, 'error');
                }
            };

            input.click();
        }
        
        // Show breed confirmation with option to change
        function showBreedConfirmation(chapeta, breedData) {
            const animal = data.entradas.find(e => e.numero == chapeta);
            const confidence = breedData.confidence || 0;
            const confidenceColor = confidence >= 80 ? '#10b981' : confidence >= 60 ? '#f59e0b' : '#ef4444';
            
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 500px;">
                    <div class="modal-header" style="background: linear-gradient(135deg, #a855f7, #7c3aed);">
                        <span>üß¨ Raza Detectada por IA</span>
                        <button class="modal-close" onclick="this.closest('.modal').remove()">√ó</button>
                    </div>
                    <div class="modal-body">
                        <div style="text-align: center; margin-bottom: 1.5rem;">
                            <div style="font-size: 3rem; margin-bottom: 0.5rem;">${breedData.breedName || 'No detectada'}</div>
                            <div style="font-size: 1.1rem; color: ${confidenceColor}; font-weight: 600;">
                                Confianza: ${confidence}%
                            </div>
                        </div>
                        
                        ${breedData.evidence && breedData.evidence.length > 0 ? `
                            <div style="background: #f3f4f6; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                                <strong>Evidencia Visual:</strong>
                                <ul style="margin: 0.5rem 0 0 1.5rem; font-size: 0.9rem;">
                                    ${breedData.evidence.map(e => `<li>${e}</li>`).join('')}
                                </ul>
                            </div>
                        ` : ''}
                        
                        <div style="background: #fef3c7; border-left: 4px solid #f59e0b; padding: 1rem; margin-bottom: 1rem; font-size: 0.9rem;">
                            üí° <strong>¬øEs correcta esta raza?</strong><br>
                            Puedes aceptarla o cambiarla manualmente.
                        </div>
                        
                        <div style="display: flex; gap: 0.75rem;">
                            <button class="btn btn-success" onclick="acceptBreed('${chapeta}')" style="flex: 1;">
                                ‚úÖ Aceptar
                            </button>
                            <button class="btn btn-warning" onclick="changeBreed('${chapeta}', ${JSON.stringify(breedData).replace(/"/g, '&quot;')})" style="flex: 1;">
                                ‚úèÔ∏è Cambiar
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        // Accept detected breed
        function acceptBreed(chapeta) {
            const photoData = animalPhotos[chapeta];
            if (!photoData || !photoData.breed) return;
            
            // Update animal's breed in the system
            const animal = data.entradas.find(e => e.numero == chapeta);
            if (animal && photoData.breed.breed) {
                // Map AI breed code to system breed
                const breedMap = {
                    'cebu_puro': 'Ceb√∫',
                    'cebu_europeo': 'Ceb√∫/Europeo',
                    'girolando': 'Girolando',
                    'europeo_lechero': 'Holstein',
                    'europeo_carne': 'Angus'
                };
                animal.raza = breedMap[photoData.breed.breed] || photoData.breed.breedName;
                saveData();
            }
            
            document.querySelector('.modal.active')?.remove();
            showToast(`‚úÖ Raza aceptada: ${photoData.breed.breedName}`, 'success');
        }
        
        // Change breed manually
        function changeBreed(chapeta, breedData) {
            document.querySelector('.modal.active')?.remove();
            
            // Show breed selector
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 500px;">
                    <div class="modal-header">
                        <span>‚úèÔ∏è Seleccionar Raza</span>
                        <button class="modal-close" onclick="this.closest('.modal').remove()">√ó</button>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label class="form-label">Raza Correcta</label>
                            <select class="form-select" id="manualBreedSelect" style="font-size: 1.1rem;">
                                <option value="Ceb√∫">üêÇ Ceb√∫</option>
                                <option value="Ceb√∫/Europeo">üêÆ Ceb√∫/Europeo (F1)</option>
                                <option value="Razuno">üêÑ Razuno</option>
                                <option value="Brangus">üêÉ Brangus</option>
                                <option value="Simbra">üêÇ Simbra</option>
                                <option value="Brahman">üêÉ Brahman</option>
                                <option value="Angus">‚¨õ Angus</option>
                                <option value="Holstein">‚¨ú Holstein</option>
                                <option value="Girolando">üî∂ Girolando</option>
                                <option value="Otra">‚ùì Otra</option>
                            </select>
                        </div>
                        <button class="btn btn-primary" onclick="saveManualBreed('${chapeta}')" style="width: 100%;">
                            üíæ Guardar Raza
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        // Save manually selected breed
        function saveManualBreed(chapeta) {
            const breedSelect = document.getElementById('manualBreedSelect');
            if (!breedSelect) return;
            
            const selectedBreed = breedSelect.value;
            
            // Update animal's breed
            const animal = data.entradas.find(e => e.numero == chapeta);
            if (animal) {
                animal.raza = selectedBreed;
                saveData();
            }
            
            // Update photo data to mark as manually corrected
            if (animalPhotos[chapeta]) {
                animalPhotos[chapeta].breed = {
                    ...animalPhotos[chapeta].breed,
                    breedName: selectedBreed,
                    confidence: 100,
                    manuallySet: true
                };
                saveAnimalPhotos();
            }
            
            document.querySelector('.modal.active')?.remove();
            showToast(`‚úÖ Raza actualizada: ${selectedBreed}`, 'success');
            updateAllViews();
        }
        
        // Legacy function for compatibility
        function showAddAnimalPhoto() {
            const chapeta = prompt('üêÇ Ingrese el n√∫mero de chapeta del animal:');
            if (!chapeta || !chapeta.trim()) {
                showToast('‚ùå Debe ingresar un n√∫mero de chapeta', 'error');
                return;
            }

            const chapetaNum = chapeta.trim();

            // Check if animal exists
            const animal = data.entradas.find(e => e.numero == chapetaNum);
            if (!animal) {
                const msg = `‚ö†Ô∏è El animal #${chapetaNum} no existe en el inventario actual.\n\n¬øDesea agregar la foto de todas formas?\n(√ötil si el animal fue comprado recientemente)`;
                if (!confirm(msg)) {
                    return;
                }
            }

            // Show photo source selection
            showPhotoSourceSelection(chapetaNum, animal);
        }

        function showPhotoSourceSelection(chapetaNum, animal) {
            const animalInfo = animal ?
                `${animal.sexo === 'MACHO' ? '‚ôÇÔ∏è' : '‚ôÄÔ∏è'} #${chapetaNum} - ${animal.raza || 'Ceb√∫'}` :
                `Animal #${chapetaNum}`;

            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.id = 'photoSourceModal';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 500px;">
                    <div class="modal-header" style="background: linear-gradient(135deg, #10b981, #059669);">
                        <span>üì∏ Agregar Foto - ${animalInfo}</span>
                        <button class="modal-close" onclick="document.getElementById('photoSourceModal').remove()">√ó</button>
                    </div>
                    <div class="modal-body" style="padding: 1.5rem;">
                        <p style="text-align: center; margin-bottom: 1.5rem; color: #666;">
                            Seleccione c√≥mo desea agregar la foto:
                        </p>

                        <div style="display: flex; flex-direction: column; gap: 1rem;">
                            <!-- Camera option (mainly for mobile) -->
                            <button onclick="document.getElementById('photoSourceModal').remove(); captureAnimalPhoto('${chapetaNum}', true);"
                                    style="display: flex; align-items: center; gap: 1rem; padding: 1.25rem; background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; border: none; border-radius: 12px; cursor: pointer; font-size: 1rem; transition: transform 0.2s;">
                                <span style="font-size: 2rem;">üì∑</span>
                                <div style="text-align: left;">
                                    <div style="font-weight: 600;">Tomar Foto</div>
                                    <div style="font-size: 0.85rem; opacity: 0.9;">Usar la c√°mara del dispositivo</div>
                                </div>
                            </button>

                            <!-- File picker option -->
                            <button onclick="document.getElementById('photoSourceModal').remove(); openPhotoFilePicker('${chapetaNum}');"
                                    style="display: flex; align-items: center; gap: 1rem; padding: 1.25rem; background: linear-gradient(135deg, #8b5cf6, #7c3aed); color: white; border: none; border-radius: 12px; cursor: pointer; font-size: 1rem; transition: transform 0.2s;">
                                <span style="font-size: 2rem;">üìÅ</span>
                                <div style="text-align: left;">
                                    <div style="font-weight: 600;">Seleccionar Archivo</div>
                                    <div style="font-size: 0.85rem; opacity: 0.9;">Buscar en Descargas u otra carpeta</div>
                                </div>
                            </button>

                            <!-- Multiple files option -->
                            <button onclick="document.getElementById('photoSourceModal').remove(); openMultiplePhotosPicker();"
                                    style="display: flex; align-items: center; gap: 1rem; padding: 1.25rem; background: linear-gradient(135deg, #f59e0b, #d97706); color: white; border: none; border-radius: 12px; cursor: pointer; font-size: 1rem; transition: transform 0.2s;">
                                <span style="font-size: 2rem;">üñºÔ∏è</span>
                                <div style="text-align: left;">
                                    <div style="font-weight: 600;">Subir M√∫ltiples Fotos</div>
                                    <div style="font-size: 0.85rem; opacity: 0.9;">Seleccionar varias fotos y asignarlas</div>
                                </div>
                            </button>
                        </div>

                        <div style="margin-top: 1.5rem; padding: 1rem; background: #f0fdf4; border-radius: 8px; font-size: 0.85rem; color: #166534;">
                            <strong>üí° Tip:</strong> Para acceder r√°pidamente a Descargas, en el selector de archivos navega a tu carpeta de Descargas o usa el acceso directo.
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // Open file picker for single photo (opens to file browser)
        function openPhotoFilePicker(chapetaNum) {
            showToast('üìÅ Seleccione una foto...', 'info');
            captureAnimalPhoto(chapetaNum, false);
        }

        // Open picker for multiple photos with preview and assignment
        function openMultiplePhotosPicker() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.multiple = true;

            input.onchange = function(e) {
                const files = Array.from(e.target.files);
                if (files.length === 0) return;

                showPhotoAssignmentModal(files);
            };

            input.click();
        }

        // Show modal to preview and assign multiple photos to animals
        function showPhotoAssignmentModal(files) {
            const activeAnimals = data.entradas.filter(e => !data.salidas.some(s => s.numero === e.numero));

            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.id = 'photoAssignModal';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow: hidden; display: flex; flex-direction: column;">
                    <div class="modal-header" style="background: linear-gradient(135deg, #f59e0b, #d97706);">
                        <span>üñºÔ∏è Asignar ${files.length} Foto(s) a Animales</span>
                        <button class="modal-close" onclick="document.getElementById('photoAssignModal').remove()">√ó</button>
                    </div>
                    <div class="modal-body" style="padding: 1rem; overflow-y: auto; flex: 1;">
                        <p style="margin-bottom: 1rem; color: #666;">
                            Seleccione a qu√© animal corresponde cada foto:
                        </p>
                        <div id="photoAssignList" style="display: flex; flex-direction: column; gap: 1rem;">
                            <!-- Photos will be loaded here -->
                        </div>
                    </div>
                    <div style="padding: 1rem; border-top: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center;">
                        <span id="assignProgress" style="color: #666;">0 de ${files.length} asignadas</span>
                        <div style="display: flex; gap: 0.5rem;">
                            <button onclick="document.getElementById('photoAssignModal').remove()" class="btn" style="background: #6b7280;">
                                Cancelar
                            </button>
                            <button onclick="saveAssignedPhotos()" class="btn btn-primary" style="background: #10b981;">
                                üíæ Guardar Todas
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            // Load previews
            const listContainer = document.getElementById('photoAssignList');
            window.pendingPhotoAssignments = [];

            files.forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const photoItem = document.createElement('div');
                    photoItem.style.cssText = 'display: flex; gap: 1rem; padding: 1rem; background: #f9fafb; border-radius: 12px; align-items: center;';
                    photoItem.innerHTML = `
                        <div style="flex-shrink: 0;">
                            <img src="${e.target.result}" style="width: 120px; height: 120px; object-fit: cover; border-radius: 8px; cursor: pointer;"
                                 onclick="viewPhotoPreview('${e.target.result.substring(0, 100)}...')"
                                 data-full-src="${e.target.result}">
                        </div>
                        <div style="flex: 1;">
                            <div style="font-weight: 600; margin-bottom: 0.5rem;">üì∑ ${file.name}</div>
                            <div style="font-size: 0.85rem; color: #666; margin-bottom: 0.75rem;">
                                ${(file.size / 1024).toFixed(1)} KB
                            </div>
                            <div style="display: flex; gap: 0.5rem; align-items: center;">
                                <label style="font-weight: 500;">Asignar a:</label>
                                <select id="photoAssign_${index}" style="flex: 1; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 6px; font-size: 1rem;" onchange="updateAssignProgress()">
                                    <option value="">-- Seleccionar animal --</option>
                                    ${activeAnimals.map(a => `
                                        <option value="${a.numero}">#${a.numero} - ${a.sexo === 'MACHO' ? '‚ôÇÔ∏è' : '‚ôÄÔ∏è'} ${a.raza || 'Ceb√∫'} (Lote ${a.lote})</option>
                                    `).join('')}
                                </select>
                            </div>
                        </div>
                    `;
                    listContainer.appendChild(photoItem);

                    // Store the file data for later saving
                    window.pendingPhotoAssignments[index] = {
                        dataUrl: e.target.result,
                        file: file
                    };
                };
                reader.readAsDataURL(file);
            });
        }

        function updateAssignProgress() {
            const total = window.pendingPhotoAssignments?.length || 0;
            let assigned = 0;
            for (let i = 0; i < total; i++) {
                const select = document.getElementById(`photoAssign_${i}`);
                if (select && select.value) assigned++;
            }
            const progressEl = document.getElementById('assignProgress');
            if (progressEl) {
                progressEl.textContent = `${assigned} de ${total} asignadas`;
                progressEl.style.color = assigned === total ? '#10b981' : '#666';
            }
        }

        function saveAssignedPhotos() {
            const assignments = window.pendingPhotoAssignments || [];
            let saved = 0;
            let errors = [];

            assignments.forEach((photo, index) => {
                const select = document.getElementById(`photoAssign_${index}`);
                if (select && select.value && photo) {
                    const chapetaNum = select.value;

                    try {
                        // Compress and save
                        compressImage(photo.file, (compressedDataUrl) => {
                            const timestamp = new Date().toISOString();
                            animalPhotos[chapetaNum] = {
                                photo: compressedDataUrl,
                                breed: null,
                                dateAdded: timestamp
                            };

                            try {
                                saveAnimalPhotos();
                                saved++;

                                if (saved === assignments.filter((_, i) => document.getElementById(`photoAssign_${i}`)?.value).length) {
                                    updateAllViews();
                                    showToast(`‚úÖ ${saved} foto(s) guardadas exitosamente`, 'success');
                                    document.getElementById('photoAssignModal')?.remove();
                                }
                            } catch (saveError) {
                                errors.push(`#${chapetaNum}: ${saveError.message}`);
                            }
                        });
                    } catch (error) {
                        errors.push(`#${chapetaNum}: ${error.message}`);
                    }
                }
            });

            if (assignments.every((_, i) => !document.getElementById(`photoAssign_${i}`)?.value)) {
                showToast('‚ö†Ô∏è No hay fotos asignadas para guardar', 'warning');
            }

            if (errors.length > 0) {
                showToast(`‚ùå Errores: ${errors.join(', ')}`, 'error');
            }
        }
        
        function getAnimalPhoto(chapeta) {
            return animalPhotos[chapeta] || null;
        }
        
        function deleteAnimalPhoto(chapeta) {
            if (!confirm(`¬øEliminar foto del animal #${chapeta}?`)) return;
            
            delete animalPhotos[chapeta];
            saveAnimalPhotos();
            updateAllViews();
            showToast(`Foto eliminada de animal #${chapeta}`, 'warning');
        }
        
        function viewAnimalPhotoLarge(chapeta) {
            const photoData = getAnimalPhoto(chapeta);
            console.log('viewAnimalPhotoLarge - chapeta:', chapeta, 'photoData:', photoData);

            if (!photoData) {
                console.log('No photo data found for animal', chapeta);
                showToast('No hay foto disponible para este animal', 'warning');
                return;
            }

            // Handle multiple formats:
            // 1. String (old format - direct data URL)
            // 2. Object with 'photo' property (new format)
            // 3. Object with nested structure from cloud sync
            let photoUrl;

            if (typeof photoData === 'string') {
                photoUrl = photoData;
            } else if (photoData.photo) {
                photoUrl = photoData.photo;
            } else if (photoData.dataUrl) {
                photoUrl = photoData.dataUrl;
            } else if (photoData.url) {
                photoUrl = photoData.url;
            }

            console.log('Extracted photoUrl:', photoUrl ? photoUrl.substring(0, 50) + '...' : 'null');

            if (!photoUrl) {
                console.log('Could not extract photo URL from data:', photoData);
                showToast('Error al cargar la foto', 'error');
                return;
            }

            viewPhoto(photoUrl, `Animal #${chapeta}`);
        }
        
        // ==================== AI ANALYTICS MODULE ====================
        
        let currentAIProvider = 'google'; // 'google' or 'anthropic'
        
        function selectAIProvider(provider) {
            currentAIProvider = provider;
            localStorage.setItem('aiProvider', provider);
            
            // Update UI - with safety checks
            const btnGoogle = document.getElementById('btnProviderGoogle');
            const btnAnthropic = document.getElementById('btnProviderAnthropic');
            const googleConfig = document.getElementById('googleConfig');
            const anthropicConfig = document.getElementById('anthropicConfig');
            
            if (btnGoogle) btnGoogle.classList.toggle('active', provider === 'google');
            if (btnAnthropic) btnAnthropic.classList.toggle('active', provider === 'anthropic');
            if (googleConfig) googleConfig.style.display = provider === 'google' ? 'block' : 'none';
            if (anthropicConfig) anthropicConfig.style.display = provider === 'anthropic' ? 'block' : 'none';
        }
        
        function saveGoogleApiKey() {
            const apiKey = document.getElementById('googleApiKey').value.trim();
            if (!apiKey) {
                showToast('Ingrese una API Key v√°lida', 'error');
                return;
            }
            
            localStorage.setItem('googleApiKey', apiKey);
            document.getElementById('googleApiKeyStatus').innerHTML = '<span style="color: #4caf50;">‚úÖ API Key de Google guardada correctamente</span>';
            showToast('API Key de Google guardada', 'success');
        }
        
        async function testGoogleApiKey() {
            const apiKey = document.getElementById('googleApiKey').value.trim();
            if (!apiKey) {
                showToast('Primero ingrese una API Key', 'error');
                return;
            }

            const statusDiv = document.getElementById('googleApiKeyStatus');
            statusDiv.style.display = 'block';
            statusDiv.innerHTML = '<span style="color: #ff9800;">üîÑ Probando conexi√≥n con Google Gemini...</span>';

            try {
                // Test with a simple prompt using current model (gemini-2.0-flash)
                const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{ text: 'Responde solo con "OK" si puedes leer este mensaje.' }]
                        }]
                    })
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error?.message || 'Error al conectar con Google Gemini');
                }
                
                const result = await response.json();
                
                if (result.candidates && result.candidates[0]) {
                    statusDiv.innerHTML = '<span style="color: #4caf50;">‚úÖ Conexi√≥n exitosa - API Key v√°lida y funcionando</span>';
                    showToast('‚úÖ API Key de Google Gemini verificada correctamente', 'success');
                } else {
                    throw new Error('Respuesta inesperada de la API');
                }
                
            } catch (error) {
                console.error('API Key test error:', error);
                statusDiv.innerHTML = `<span style="color: #f44336;">‚ùå Error: ${error.message}</span>`;
                showToast('‚ùå API Key inv√°lida o error de conexi√≥n', 'error');
            }
        }
        
        function saveAnthropicApiKey() {
            const apiKey = document.getElementById('anthropicApiKey').value.trim();
            if (!apiKey) {
                showToast('Ingrese una API Key v√°lida', 'error');
                return;
            }
            
            localStorage.setItem('anthropicApiKey', apiKey);
            document.getElementById('anthropicApiKeyStatus').innerHTML = '<span style="color: #4caf50;">‚úÖ API Key de Anthropic guardada correctamente</span>';
            showToast('API Key de Anthropic guardada', 'success');
        }
        
        function loadApiKeys() {
            // Load provider preference
            const savedProvider = localStorage.getItem('aiProvider') || 'google';
            
            // Only call selectAIProvider if the elements exist (AI tab has been rendered)
            try {
                if (document.getElementById('btnProviderGoogle')) {
                    selectAIProvider(savedProvider);
                }
            } catch (error) {
                console.log('AI provider elements not yet loaded:', error);
            }
            
            // Load Google API Key - NO DEFAULT KEY FOR SECURITY
            let googleKey = localStorage.getItem('googleApiKey');
            if (googleKey) {
                const googleKeyInput = document.getElementById('googleApiKey');
                const googleKeyStatus = document.getElementById('googleApiKeyStatus');
                if (googleKeyInput) googleKeyInput.value = googleKey;
                if (googleKeyStatus) googleKeyStatus.innerHTML = '<span style="color: #4caf50;">‚úÖ API Key configurada</span>';
            } else {
                const googleKeyStatus = document.getElementById('googleApiKeyStatus');
                if (googleKeyStatus) googleKeyStatus.innerHTML = '<span style="color: #ff9800;">‚ö†Ô∏è Configure su API Key para usar IA</span>';
            }
            
            // Load Anthropic API Key
            const anthropicKey = localStorage.getItem('anthropicApiKey');
            if (anthropicKey) {
                const anthropicKeyInput = document.getElementById('anthropicApiKey');
                const anthropicKeyStatus = document.getElementById('anthropicApiKeyStatus');
                if (anthropicKeyInput) anthropicKeyInput.value = anthropicKey;
                if (anthropicKeyStatus) anthropicKeyStatus.innerHTML = '<span style="color: #4caf50;">‚úÖ API Key configurada</span>';
            }
        }
        
        // Get data summary for a specific ranch (limited to last 5 years)
        function getRanchDataSummary(ranchId, ranchData) {
            const today = new Date();
            const fiveYearsAgo = new Date();
            fiveYearsAgo.setFullYear(fiveYearsAgo.getFullYear() - 5);

            const gdp = ranchData.config?.gdp || 0.31;
            const precioVenta = ranchData.config?.precioVenta || 9000;

            // Filter entries from last 5 years only
            const recentEntradas = (ranchData.entradas || []).filter(e => {
                const entryDate = new Date(e.fechaEntrada);
                return entryDate >= fiveYearsAgo;
            });

            const salidaIds = (ranchData.salidas || []).map(s => s.numero);
            const inventario = recentEntradas.filter(e => !salidaIds.includes(e.numero));

            let totalPesoInicial = 0;
            let totalPesoEstimado = 0;
            let totalInversion = 0;
            let totalValorActual = 0;

            const animalDetails = inventario.map(a => {
                const dias = Math.floor((today - new Date(a.fechaEntrada)) / (1000 * 60 * 60 * 24));
                const pesoEst = a.peso + (dias * gdp);
                const costo = a.costoTotal || (a.peso * a.precioKilo) || 0;
                const valorActual = pesoEst * precioVenta;
                const ganancia = valorActual - costo;

                totalPesoInicial += a.peso;
                totalPesoEstimado += pesoEst;
                totalInversion += costo;
                totalValorActual += valorActual;

                return {
                    numero: a.numero,
                    sexo: a.sexo,
                    raza: a.raza || 'No especificada',
                    pesoInicial: a.peso,
                    pesoEstimado: Math.round(pesoEst),
                    diasEnFinca: dias,
                    listoParaVenta: pesoEst >= (ranchData.config?.pesoObjetivo || 450)
                };
            });

            // Breeding data for San Fernando
            let breedingData = null;
            if (ranchId === 'san_fernando') {
                const servicios = ranchData.servicios || [];
                const diagnosticos = ranchData.diagnosticos || [];
                const toros = ranchData.toros || [];
                const vacas = inventario.filter(a => a.sexo === 'HEMBRA');
                const crias = inventario.filter(a => a.tipoEntrada === 'nacimiento' && a.numeroVaca);

                breedingData = {
                    totalVacas: vacas.length,
                    totalToros: toros.length,
                    totalCrias: crias.length,
                    serviciosRegistrados: servicios.length,
                    diagnosticosRegistrados: diagnosticos.length,
                    vacasServidas: servicios.filter(s => {
                        const diag = diagnosticos.find(d => d.vacaNumero === s.vacaNumero);
                        return !diag;
                    }).length,
                    vacasPrenadas: diagnosticos.filter(d => d.resultado === 'prenada').length,
                    criasListasDestete: crias.filter(c => {
                        const dias = Math.floor((today - new Date(c.fechaEntrada)) / (1000 * 60 * 60 * 24));
                        return dias >= 180 && !c.fechaDestete;
                    }).length
                };
            }

            return {
                fincaId: ranchId,
                fincaNombre: RANCHES[ranchId]?.name || ranchId,
                resumen: {
                    totalAnimales: inventario.length,
                    machos: inventario.filter(a => a.sexo === 'MACHO').length,
                    hembras: inventario.filter(a => a.sexo === 'HEMBRA').length,
                    totalPesoEstimado: Math.round(totalPesoEstimado),
                    inversionTotal: Math.round(totalInversion),
                    valorActualTotal: Math.round(totalValorActual),
                    gananciaEstimada: Math.round(totalValorActual - totalInversion),
                    animalesListosVenta: animalDetails.filter(a => a.listoParaVenta).length
                },
                ventas: (ranchData.salidas || []).filter(s => {
                    const saleDate = new Date(s.fechaSalida || s.fecha);
                    return s.comprador !== 'MUERTE' && saleDate >= fiveYearsAgo;
                }).length,
                muertes: (ranchData.salidas || []).filter(s => {
                    const deathDate = new Date(s.fechaSalida || s.fecha);
                    return s.comprador === 'MUERTE' && deathDate >= fiveYearsAgo;
                }).length,
                potreros: (ranchData.potreros || []).length,
                breeding: breedingData,
                animales: animalDetails.slice(0, 20) // Limit to avoid token overflow
            };
        }

        // Get combined data from ALL ranches for AI analysis
        function getAllRanchesDataForAI() {
            const today = new Date();
            const allRanchesData = {};
            let globalTotals = {
                totalAnimales: 0,
                totalMachos: 0,
                totalHembras: 0,
                totalPesoEstimado: 0,
                totalInversion: 0,
                totalValorActual: 0,
                totalGanancia: 0,
                totalVentas: 0,
                totalMuertes: 0,
                animalesListosVenta: 0
            };

            // Iterate through all ranches (excluding San Fernando - test ranch with non-real data)
            Object.keys(RANCHES).forEach(ranchId => {
                // Skip San Fernando - it's a test ranch with non-real data
                if (ranchId === 'san_fernando') {
                    console.log('AI: Skipping San Fernando (test ranch)');
                    return;
                }

                const ranch = RANCHES[ranchId];
                try {
                    const ranchDataStr = localStorage.getItem(ranch.storageKey);
                    const ranchData = ranchDataStr ? JSON.parse(ranchDataStr) : null;

                    if (ranchData && ranchData.entradas && ranchData.entradas.length > 0) {
                        const summary = getRanchDataSummary(ranchId, ranchData);
                        allRanchesData[ranchId] = summary;

                        // Add to global totals
                        globalTotals.totalAnimales += summary.resumen.totalAnimales;
                        globalTotals.totalMachos += summary.resumen.machos;
                        globalTotals.totalHembras += summary.resumen.hembras;
                        globalTotals.totalPesoEstimado += summary.resumen.totalPesoEstimado;
                        globalTotals.totalInversion += summary.resumen.inversionTotal;
                        globalTotals.totalValorActual += summary.resumen.valorActualTotal;
                        globalTotals.totalGanancia += summary.resumen.gananciaEstimada;
                        globalTotals.totalVentas += summary.ventas;
                        globalTotals.totalMuertes += summary.muertes;
                        globalTotals.animalesListosVenta += summary.resumen.animalesListosVenta;
                    }
                } catch (e) {
                    console.error(`Error loading ranch ${ranchId} for AI:`, e);
                }
            });

            return {
                fecha: today.toISOString().split('T')[0],
                fincaActual: RANCHES[currentRanch]?.name || currentRanch,
                fincaActualId: currentRanch,
                resumenGlobal: globalTotals,
                fincas: allRanchesData
            };
        }

        function getDataSummaryForAI() {
            // Get data from ALL ranches combined
            return getAllRanchesDataForAI();
        }
        
        function updateAIStats() {
            // Function disabled - stats elements removed from UI
            return;
        }
        
        function getSystemPrompt(dataSummary) {
            // Build compact summary per ranch (without individual animals to reduce token count)
            const ranchSummaries = Object.keys(dataSummary.fincas || {}).map(id => {
                const f = dataSummary.fincas[id];
                let summary = `
### ${f.fincaNombre}
- Animales: ${f.resumen.totalAnimales} (${f.resumen.machos} machos, ${f.resumen.hembras} hembras)
- Peso estimado total: ${f.resumen.totalPesoEstimado?.toLocaleString('es-CO')} kg
- Inversi√≥n: $${f.resumen.inversionTotal?.toLocaleString('es-CO')}
- Valor actual: $${f.resumen.valorActualTotal?.toLocaleString('es-CO')}
- Ganancia estimada: $${f.resumen.gananciaEstimada?.toLocaleString('es-CO')}
- Listos para venta: ${f.resumen.animalesListosVenta}
- Ventas realizadas: ${f.ventas}, Muertes: ${f.muertes}`;

                // Add breeding info for San Fernando
                if (f.breeding) {
                    summary += `
- DATOS CR√çA: ${f.breeding.totalVacas} vacas, ${f.breeding.totalToros} toros, ${f.breeding.totalCrias} cr√≠as
- Servicios: ${f.breeding.serviciosRegistrados}, Pre√±adas: ${f.breeding.vacasPrenadas}
- Cr√≠as listas destete: ${f.breeding.criasListasDestete}`;
                }
                return summary;
            }).join('\n');

            return `Eres un experto en ganader√≠a bovina colombiana, especializado en cr√≠a y ceba de ganado grass-fed en zonas tropicales.
Analizas datos de m√∫ltiples fincas ganaderas y proporcionas insights accionables.

üè† Finca actual del usuario: "${dataSummary.fincaActual}"

üìà RESUMEN GLOBAL (TODAS LAS FINCAS):
- Total animales: ${dataSummary.resumenGlobal?.totalAnimales || 0}
- Machos: ${dataSummary.resumenGlobal?.totalMachos || 0} | Hembras: ${dataSummary.resumenGlobal?.totalHembras || 0}
- Inversi√≥n total: $${(dataSummary.resumenGlobal?.totalInversion || 0).toLocaleString('es-CO')}
- Valor actual: $${(dataSummary.resumenGlobal?.totalValorActual || 0).toLocaleString('es-CO')}
- Ganancia estimada: $${(dataSummary.resumenGlobal?.totalGanancia || 0).toLocaleString('es-CO')}
- Listos para venta: ${dataSummary.resumenGlobal?.animalesListosVenta || 0}
- Ventas totales: ${dataSummary.resumenGlobal?.totalVentas || 0} | Muertes: ${dataSummary.resumenGlobal?.totalMuertes || 0}

üìã DETALLE POR FINCA:
${ranchSummaries || '(No hay datos)'}

INSTRUCCIONES DE CONTENIDO:
- Responde en espa√±ol
- SIEMPRE considera los datos de TODAS las fincas en tu an√°lisis
- Cuando te pregunten sobre una finca espec√≠fica, da el an√°lisis de esa finca Y comp√°rala con las otras
- Si preguntan en general, da un resumen consolidado de todas las fincas
- Incluye n√∫meros espec√≠ficos de los datos
- Da recomendaciones pr√°cticas y accionables
- Considera el contexto de ganader√≠a colombiana (clima tropical, pastos, mercado local)
- Si hay datos de cr√≠a (San Fernando), incluye an√°lisis reproductivo

üé® INSTRUCCIONES DE FORMATO VISUAL (MUY IMPORTANTE):
Tus respuestas deben ser VISUALES y bien organizadas. USA SIEMPRE:

1. **TABLAS MARKDOWN** para comparaciones y datos:
   | Finca | Animales | Inversi√≥n | Ganancia |
   |-------|----------|-----------|----------|
   | La Coru√±a | 45 | $50M | $15M |

2. **EMOJIS** para categor√≠as y estados:
   - üü¢ Excelente/Positivo
   - üü° Regular/Atenci√≥n
   - üî¥ Cr√≠tico/Negativo
   - üìä Datos/Estad√≠sticas
   - üí∞ Dinero/Inversi√≥n
   - üêÑ Animales
   - ‚öñÔ∏è Peso
   - üìà Crecimiento
   - ‚ö†Ô∏è Alertas

3. **SECCIONES CLARAS** con headers:
   ## üìä Resumen Ejecutivo
   ## üèÜ Top Performers
   ## ‚ö†Ô∏è Alertas y Recomendaciones

4. **INDICADORES VISUALES** para m√©tricas:
   - GDP: üü¢ 0.45 kg/d√≠a (Excelente)
   - Margen: üü° 15% (Aceptable)
   - Mortalidad: üî¥ 5% (Alto)

5. **LISTAS CON ICONOS** para recomendaciones:
   - ‚úÖ Acci√≥n recomendada
   - ‚è∞ Urgente
   - üí° Sugerencia

6. **BARRAS DE PROGRESO ASCII** cuando aplique:
   Ocupaci√≥n: [‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñë‚ñë] 80%

7. **COMPARATIVAS LADO A LADO**:
   üìç La Coru√±a vs Santa Catalina

Ejemplo de respuesta bien formateada:

## üìä An√°lisis Global de Fincas

| M√©trica | La Coru√±a | Santa Catalina | La Vega |
|---------|-----------|----------------|---------|
| üêÑ Animales | 45 | 32 | 28 |
| üí∞ Inversi√≥n | $50M | $35M | $30M |
| üìà Ganancia | üü¢ $15M | üü° $8M | üî¥ $2M |

### üèÜ Mejor Rendimiento: La Coru√±a
- GDP Promedio: **0.42 kg/d√≠a** üü¢
- Margen: **30%** üü¢

### ‚ö†Ô∏è Requiere Atenci√≥n: La Vega
- ‚è∞ 5 animales listos para venta
- üí° Considerar rotaci√≥n de potreros

NUNCA des respuestas en texto plano sin formato. SIEMPRE usa tablas, emojis y secciones.`;
        }
        
        // ========== API RATE LIMITING & RETRY LOGIC ==========
        let apiRequestQueue = [];
        let isProcessingQueue = false;
        let lastRequestTime = 0;
        const MIN_REQUEST_INTERVAL = 2000; // 2 seconds between requests
        
        async function throttledAPICall(apiFunction, ...args) {
            return new Promise((resolve) => {
                apiRequestQueue.push({ apiFunction, args, resolve });
                processQueue();
            });
        }
        
        async function processQueue() {
            if (isProcessingQueue || apiRequestQueue.length === 0) return;
            
            isProcessingQueue = true;
            
            while (apiRequestQueue.length > 0) {
                const now = Date.now();
                const timeSinceLastRequest = now - lastRequestTime;
                
                if (timeSinceLastRequest < MIN_REQUEST_INTERVAL) {
                    await new Promise(resolve => setTimeout(resolve, MIN_REQUEST_INTERVAL - timeSinceLastRequest));
                }
                
                const { apiFunction, args, resolve } = apiRequestQueue.shift();
                lastRequestTime = Date.now();
                
                const result = await apiFunction(...args);
                resolve(result);
            }
            
            isProcessingQueue = false;
        }
        
        async function retryWithBackoff(apiFunction, maxRetries = 3) {
            for (let attempt = 0; attempt < maxRetries; attempt++) {
                try {
                    const result = await apiFunction();
                    return result;
                } catch (error) {
                    if (error.message.includes('429') || error.message.includes('rate limit')) {
                        const delay = Math.pow(2, attempt) * 1000; // Exponential backoff: 1s, 2s, 4s
                        console.log(`Rate limit hit. Retrying in ${delay}ms... (Attempt ${attempt + 1}/${maxRetries})`);
                        showToast(`Esperando ${delay/1000}s para reintentar... (${attempt + 1}/${maxRetries})`, 'warning');
                        await new Promise(resolve => setTimeout(resolve, delay));
                    } else {
                        throw error;
                    }
                }
            }
            throw new Error('M√°ximo de reintentos alcanzado. Por favor intente m√°s tarde.');
        }
        
        // ========== GOOGLE GEMINI API WITH RETRY ==========
        // Default API key for family use (embedded for convenience across all devices)
        const DEFAULT_GEMINI_API_KEY = 'AIzaSyA2OpWwDWSvFVdtEGOEQiE5eKnt6CFKcqA';

        // Use current Gemini models (2026)
        const GEMINI_MODEL_FALLBACKS = [
            { name: 'gemini-2.0-flash', label: 'Flash 2.0 (r√°pido)', endpoint: 'v1beta' },
            { name: 'gemini-1.5-flash-latest', label: 'Flash 1.5 Latest', endpoint: 'v1beta' },
            { name: 'gemini-pro', label: 'Pro (legacy)', endpoint: 'v1' }
        ];

        async function callGoogleGeminiAPI(prompt) {
            console.log('ü§ñ callGoogleGeminiAPI called with prompt:', prompt.substring(0, 50) + '...');
            // Use localStorage key if set, otherwise use embedded default
            const apiKey = localStorage.getItem('googleApiKey') || DEFAULT_GEMINI_API_KEY;

            if (!apiKey) {
                console.error('‚ùå No API key configured');
                showToast('‚ö†Ô∏è API Key de Google no configurada', 'error');
                return null;
            }
            console.log('‚úÖ API Key found (using ' + (localStorage.getItem('googleApiKey') ? 'custom' : 'default') + '), length:', apiKey.length);

            try {
                const dataSummary = getDataSummaryForAI();
                console.log('AI Data Summary:', {
                    totalFincas: Object.keys(dataSummary.fincas || {}).length,
                    totalAnimales: dataSummary.resumenGlobal?.totalAnimales,
                    fincas: Object.keys(dataSummary.fincas || {})
                });
                const systemPrompt = getSystemPrompt(dataSummary);
                console.log('System prompt length:', systemPrompt.length, 'chars');
                const fullPrompt = `${systemPrompt}\n\n---\n\nSOLICITUD DEL USUARIO:\n${prompt}`;
                console.log('Full prompt length:', fullPrompt.length, 'chars');

                const callGeminiModel = async (modelConfig) => {
                    const url = `https://generativelanguage.googleapis.com/${modelConfig.endpoint}/models/${modelConfig.name}:generateContent?key=${apiKey}`;
                    
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{
                                parts: [{ text: fullPrompt }]
                            }],
                            generationConfig: {
                                temperature: 0.7,
                                maxOutputTokens: 8192,  // Maximum for Gemini 2.5
                                topP: 0.95,
                                topK: 40,
                                candidateCount: 1,
                                stopSequences: []
                            },
                            safetySettings: [
                                {
                                    category: "HARM_CATEGORY_HARASSMENT",
                                    threshold: "BLOCK_NONE"
                                },
                                {
                                    category: "HARM_CATEGORY_HATE_SPEECH",
                                    threshold: "BLOCK_NONE"
                                },
                                {
                                    category: "HARM_CATEGORY_SEXUALLY_EXPLICIT",
                                    threshold: "BLOCK_NONE"
                                },
                                {
                                    category: "HARM_CATEGORY_DANGEROUS_CONTENT",
                                    threshold: "BLOCK_NONE"
                                }
                            ]
                        })
                    });
                    
                    console.log('Gemini API response status:', response.status);

                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('API Error Status:', response.status);
                        console.error('API Error Body:', errorText);
                        try {
                            const errorData = JSON.parse(errorText);
                            throw new Error(errorData.error?.message || `Error ${response.status} en la API de Google`);
                        } catch (e) {
                            throw new Error(`Error ${response.status}: ${errorText.substring(0, 200)}`);
                        }
                    }

                    const result = await response.json();
                    console.log('Gemini API result keys:', Object.keys(result));

                    if (result.candidates && result.candidates[0] && result.candidates[0].content) {
                        console.log('Gemini response received successfully');
                        return result.candidates[0].content.parts[0].text;
                    }

                    console.error('Unexpected Gemini response structure:', JSON.stringify(result).substring(0, 500));
                    throw new Error('Respuesta inesperada de Google Gemini');
                };

                let lastError = null;
                
                for (let i = 0; i < GEMINI_MODEL_FALLBACKS.length; i++) {
                    const modelConfig = GEMINI_MODEL_FALLBACKS[i];
                    
                    if (i > 0) {
                        showToast(`üîÑ Intentando con modelo alternativo ${modelConfig.label}...`, 'warning');
                        await new Promise(resolve => setTimeout(resolve, 2000));
                    }
                    
                    try {
                        const responseText = await retryWithBackoff(
                            () => callGeminiModel(modelConfig),
                            4
                        );
                        return responseText;
                    } catch (error) {
                        lastError = error;
                        console.error(`Gemini model failed (${modelConfig.name}):`, error);
                    }
                }
                
                throw lastError || new Error('Error en la API de Google');
                
            } catch (error) {
                console.error('Error:', error);
                showToast('‚ùå Error: ' + error.message, 'error');
                return null;
            }
        }
        
        // ========== ANTHROPIC CLAUDE API WITH RETRY ==========
        async function callAnthropicAPI(prompt) {
            const apiKey = localStorage.getItem('anthropicApiKey');
            if (!apiKey) {
                showToast('Configure su API Key de Anthropic primero', 'error');
                document.getElementById('apiKeySetup')?.scrollIntoView({ behavior: 'smooth' });
                return null;
            }
            
            const dataSummary = getDataSummaryForAI();
            const systemPrompt = getSystemPrompt(dataSummary);
            
            const makeRequest = async () => {
                const response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': apiKey,
                        'anthropic-version': '2023-06-01',
                        'anthropic-dangerous-direct-browser-access': 'true'
                    },
                    body: JSON.stringify({
                        model: 'claude-3-5-sonnet-20241022',
                        max_tokens: 2000,
                        messages: [
                            { role: 'user', content: prompt }
                        ],
                        system: systemPrompt
                    })
                });
                
                if (!response.ok) {
                    if (response.status === 429) {
                        throw new Error('429 - Rate limit exceeded');
                    }
                    const error = await response.json();
                    throw new Error(error.error?.message || 'Error en la API de Anthropic');
                }
                
                const result = await response.json();
                return result.content[0].text;
            };
            
            try {
                return await retryWithBackoff(makeRequest);
            } catch (error) {
                console.error('Anthropic API Error:', error);
                showToast('Error: ' + error.message, 'error');
                return null;
            }
        }
        
        // ========== UNIFIED AI CALL WITH THROTTLING ==========
        async function callAI(prompt) {
            const providerName = currentAIProvider === 'google' ? 'Google Gemini' : 'Anthropic Claude';
            document.getElementById('aiLoadingText').textContent = `Analizando con ${providerName}...`;
            
            // Use throttled call to prevent rate limiting
            if (currentAIProvider === 'google') {
                return await throttledAPICall(callGoogleGeminiAPI, prompt);
            } else {
                return await throttledAPICall(callAnthropicAPI, prompt);
            }
        }
        
        async function quickAnalysis(type) {
            console.log('Quick analysis called with type:', type);
            
            const prompts = {
                'resumen': 'Genera un resumen ejecutivo completo del estado actual de la finca. Incluye: inventario, valor, rentabilidad, y 3 puntos clave de atenci√≥n.',
                'listos_venta': 'Analiza qu√© animales est√°n listos para venta (peso >= objetivo y sin per√≠odo de retiro). Lista los animales con su peso estimado, valor, y d√≠as en finca. Calcula el ingreso total potencial si se venden todos.',
                'mejor_gdp': 'Identifica los 10 animales con mejor rendimiento (GDP m√°s alto). Analiza qu√© tienen en com√∫n (vendedor, lote, raza, etc.) y qu√© podemos aprender para futuras compras.',
                'rentabilidad': 'Realiza un an√°lisis de rentabilidad detallado: margen por animal, ROI, costo por kg producido, y comparaci√≥n entre lotes. Identifica los animales m√°s y menos rentables.',
                'vendedores': 'Eval√∫a el desempe√±o de cada vendedor: n√∫mero de animales, peso promedio de entrada, costo promedio por kg, y calidad general. ¬øDe qu√© vendedor conviene seguir comprando?',
                'compradores': 'Analiza el historial de ventas por comprador: volumen, precios pagados, frecuencia. ¬øQui√©nes son los mejores compradores y c√≥mo podemos fortalecer esas relaciones?',
                'salud': 'Eval√∫a el estado de salud del hato: vacunaciones al d√≠a, tratamientos recientes, animales en retiro. ¬øQu√© acciones sanitarias se necesitan pr√≥ximamente?',
                'potreros': 'Analiza la eficiencia de uso de potreros: ocupaci√≥n, rotaci√≥n, d√≠as de descanso. ¬øEst√°n bien distribuidos los animales? ¬øHay potreros subutilizados?',
                'proyeccion': 'Genera una proyecci√≥n a 30, 60 y 90 d√≠as: cu√°ntos animales llegar√°n al peso objetivo, ingreso estimado por ventas, y recomendaciones de timing para maximizar ganancias.',
                'recomendaciones': 'Bas√°ndote en todos los datos, genera las 5 recomendaciones m√°s importantes para mejorar la rentabilidad de la finca en los pr√≥ximos 3 meses.',
                'peso_rentabilidad': 'AN√ÅLISIS CR√çTICO: Analiza en detalle qu√© rangos de peso de compra (ej: 100-150kg, 150-200kg, 200-250kg, etc.) han dado la mejor rentabilidad. Para cada rango calcula: 1) Margen de ganancia promedio (%), 2) ROI promedio, 3) GDP promedio, 4) D√≠as promedio hasta venta, 5) Ganancia total en $ por animal. Identifica el "punto dulce" √≥ptimo de peso de compra y explica por qu√©. Incluye recomendaciones espec√≠ficas de qu√© pesos buscar en futuras compras.'
            };
            
            const prompt = prompts[type];
            if (!prompt) {
                console.error('No prompt found for type:', type);
                showToast('Tipo de an√°lisis no encontrado', 'error');
                return;
            }
            
            try {
                showAILoading(true);
                console.log('Calling AI with prompt:', prompt.substring(0, 50) + '...');
                const response = await callAI(prompt);
                console.log('AI response received:', response ? 'Success' : 'Failed');
                showAILoading(false);
                
                if (response) {
                    showAIResponse(response);
                } else {
                    showToast('No se recibi√≥ respuesta de la IA', 'error');
                }
            } catch (error) {
                console.error('Error in quickAnalysis:', error);
                showAILoading(false);
                showToast('Error: ' + error.message, 'error');
            }
        }
        
        async function askCustomQuestion() {
            const question = document.getElementById('aiCustomQuestion').value.trim();
            console.log('Custom question asked:', question);
            
            if (!question) {
                showToast('Escribe una pregunta primero', 'error');
                return;
            }
            
            try {
                showAILoading(true);
                console.log('Sending custom question to AI...');
                const response = await callAI(question);
                console.log('Custom question response received:', response ? 'Success' : 'Failed');
                showAILoading(false);
                
                if (response) {
                    showAIResponse(response);
                } else {
                    showToast('No se recibi√≥ respuesta de la IA', 'error');
                }
            } catch (error) {
                console.error('Error in askCustomQuestion:', error);
                showAILoading(false);
                showToast('Error: ' + error.message, 'error');
            }
        }
        
        function showAILoading(show) {
            document.getElementById('aiLoading').style.display = show ? 'block' : 'none';
            if (show) {
                document.getElementById('aiResponseCard').style.display = 'none';
            }
        }
        
        function showAIResponse(response) {
            document.getElementById('aiResponseCard').style.display = 'block';
            document.getElementById('aiResponseContent').innerHTML = formatAIResponse(response);
            document.getElementById('aiResponseCard').scrollIntoView({ behavior: 'smooth' });
        }
        
        function formatAIResponse(text) {
            // Clean up any artifacts
            text = text.trim();

            // First, handle markdown tables
            const tableRegex = /\|(.+)\|\n\|[-:\s|]+\|\n((?:\|.+\|\n?)+)/g;
            text = text.replace(tableRegex, function(match) {
                const lines = match.trim().split('\n');
                if (lines.length < 3) return match;

                // Parse header row
                const headers = lines[0].split('|').filter(h => h.trim()).map(h => h.trim());

                // Parse data rows (skip separator line at index 1)
                const rows = [];
                for (let i = 2; i < lines.length; i++) {
                    const cells = lines[i].split('|').filter(c => c.trim() !== '').map(c => c.trim());
                    if (cells.length > 0) rows.push(cells);
                }

                // Build HTML table
                let tableHtml = `<div style="overflow-x: auto; margin: 1rem 0;">
                    <table style="width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                    <thead>
                        <tr style="background: linear-gradient(135deg, #9c27b0, #7b1fa2);">`;

                headers.forEach(h => {
                    tableHtml += `<th style="padding: 0.75rem; color: white; text-align: left; font-weight: 600; white-space: nowrap;">${h}</th>`;
                });

                tableHtml += `</tr></thead><tbody>`;

                rows.forEach((row, idx) => {
                    const bgColor = idx % 2 === 0 ? '#fafafa' : '#ffffff';
                    tableHtml += `<tr style="background: ${bgColor}; border-bottom: 1px solid #eee;">`;
                    row.forEach((cell, cellIdx) => {
                        const isFirst = cellIdx === 0;
                        const fontWeight = isFirst ? '600' : 'normal';
                        // Color cells based on emoji indicators
                        let cellBg = 'transparent';
                        if (cell.includes('üü¢')) cellBg = 'rgba(16, 185, 129, 0.1)';
                        else if (cell.includes('üü°')) cellBg = 'rgba(245, 158, 11, 0.1)';
                        else if (cell.includes('üî¥')) cellBg = 'rgba(239, 68, 68, 0.1)';
                        tableHtml += `<td style="padding: 0.6rem 0.75rem; font-weight: ${fontWeight}; background: ${cellBg};">${cell}</td>`;
                    });
                    tableHtml += `</tr>`;
                });

                tableHtml += `</tbody></table></div>`;
                return tableHtml;
            });

            // Handle progress bars [‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñë‚ñë] 80%
            text = text.replace(/\[([‚ñà‚ñë]+)\]\s*(\d+%?)/g, function(match, bars, percent) {
                const filled = (bars.match(/‚ñà/g) || []).length;
                const total = bars.length;
                const percentage = (filled / total) * 100;
                let color = '#10b981';
                if (percentage < 50) color = '#ef4444';
                else if (percentage < 75) color = '#f59e0b';

                return `<div style="display: inline-flex; align-items: center; gap: 0.5rem; background: #f3f4f6; border-radius: 4px; padding: 0.25rem 0.5rem;">
                    <div style="width: 100px; height: 12px; background: #e5e7eb; border-radius: 6px; overflow: hidden;">
                        <div style="width: ${percentage}%; height: 100%; background: ${color}; border-radius: 6px;"></div>
                    </div>
                    <span style="font-weight: 600; font-size: 0.85rem;">${percent}</span>
                </div>`;
            });

            let html = text
                // Headers - improved detection with colors
                .replace(/^####\s+(.*$)/gim, '<h5 style="color: #7c3aed; margin-top: 0.75rem; margin-bottom: 0.25rem; font-size: 0.95rem;">$1</h5>')
                .replace(/^###\s+(.*$)/gim, '<h4 style="color: #9c27b0; margin-top: 1rem; margin-bottom: 0.5rem; font-size: 1.05rem; border-bottom: 2px solid #f3e8ff; padding-bottom: 0.25rem;">$1</h4>')
                .replace(/^##\s+(.*$)/gim, '<h3 style="color: #7b1fa2; margin-top: 1.25rem; margin-bottom: 0.5rem; font-size: 1.15rem; border-bottom: 3px solid #9c27b0; padding-bottom: 0.35rem;">$1</h3>')
                .replace(/^#\s+(.*$)/gim, '<h2 style="color: #6d28d9; margin-top: 1.5rem; margin-bottom: 0.75rem; font-size: 1.3rem; border-bottom: 4px solid #7c3aed; padding-bottom: 0.5rem;">$1</h2>')
                // Bold text with color
                .replace(/\*\*(.*?)\*\*/g, '<strong style="color: #1e40af; background: linear-gradient(to bottom, transparent 60%, rgba(99, 102, 241, 0.2) 60%);">$1</strong>')
                // Inline code
                .replace(/`([^`]+)`/g, '<code style="background: #f3f4f6; padding: 0.15rem 0.4rem; border-radius: 4px; font-family: monospace; font-size: 0.9em;">$1</code>')
                // Status indicators with backgrounds
                .replace(/üü¢\s*([^üü°üî¥\n<]+)/g, '<span style="background: #d1fae5; color: #065f46; padding: 0.15rem 0.5rem; border-radius: 4px; font-weight: 500;">üü¢ $1</span>')
                .replace(/üü°\s*([^üü¢üî¥\n<]+)/g, '<span style="background: #fef3c7; color: #92400e; padding: 0.15rem 0.5rem; border-radius: 4px; font-weight: 500;">üü° $1</span>')
                .replace(/üî¥\s*([^üü¢üü°\n<]+)/g, '<span style="background: #fee2e2; color: #991b1b; padding: 0.15rem 0.5rem; border-radius: 4px; font-weight: 500;">üî¥ $1</span>')
                // Action items with icons
                .replace(/‚úÖ\s+(.+?)(?=\n|$|<)/g, '<div style="background: #ecfdf5; border-left: 4px solid #10b981; padding: 0.5rem; margin: 0.25rem 0; border-radius: 0 4px 4px 0;">‚úÖ $1</div>')
                .replace(/‚è∞\s+(.+?)(?=\n|$|<)/g, '<div style="background: #fef3c7; border-left: 4px solid #f59e0b; padding: 0.5rem; margin: 0.25rem 0; border-radius: 0 4px 4px 0;">‚è∞ $1</div>')
                .replace(/üí°\s+(.+?)(?=\n|$|<)/g, '<div style="background: #ede9fe; border-left: 4px solid #8b5cf6; padding: 0.5rem; margin: 0.25rem 0; border-radius: 0 4px 4px 0;">üí° $1</div>')
                .replace(/‚ö†Ô∏è\s+(.+?)(?=\n|$|<)/g, '<div style="background: #fee2e2; border-left: 4px solid #ef4444; padding: 0.5rem; margin: 0.25rem 0; border-radius: 0 4px 4px 0;">‚ö†Ô∏è $1</div>')
                // Lists - improved with proper styling
                .replace(/^\s*[-*]\s+(.*$)/gim, '<div style="display: flex; align-items: flex-start; margin: 0.35rem 0; padding-left: 0.5rem;"><span style="color: #9c27b0; margin-right: 0.5rem;">‚Ä¢</span><span>$1</span></div>')
                // Numbered lists
                .replace(/^\s*(\d+)\.\s+(.*$)/gim, '<div style="display: flex; align-items: flex-start; margin: 0.35rem 0; padding-left: 0.5rem;"><span style="color: #7c3aed; font-weight: 600; margin-right: 0.5rem; min-width: 1.5rem;">$1.</span><span>$2</span></div>')
                // Horizontal rules
                .replace(/^---+$/gim, '<hr style="border: none; border-top: 2px solid #e5e7eb; margin: 1rem 0;">')
                // Preserve paragraph breaks
                .replace(/\n{3,}/g, '\n\n')
                .replace(/\n\n/g, '</p><p style="margin: 0.75rem 0;">')
                .replace(/\n/g, '<br>');

            // Wrap in container with nice styling
            return `<div style="font-size: 0.95rem; line-height: 1.6; color: #374151;"><p style="margin: 0.75rem 0;">${html}</p></div>`;
        }
        
        // Add function to generate peso rentabilidad report
        function generatePesoRentabilidadReport() {
            const reportDiv = document.getElementById('pesoRentabilidadReport');
            reportDiv.style.display = 'block';
            reportDiv.innerHTML = '<div style="text-align: center; padding: 2rem;"><div style="font-size: 2rem;">üìä</div><div>Generando an√°lisis...</div></div>';
            
            // Get all sold animals with purchase and sale data
            const soldAnimals = data.salidas.filter(s => s.comprador !== 'MUERTE').map(salida => {
                const entrada = data.entradas.find(e => e.numero === salida.numero);
                if (!entrada) return null;
                
                const costoCompra = entrada.costoTotal || (entrada.peso * entrada.precioKilo);
                const ingresoVenta = salida.costoVenta || (salida.peso * salida.precioKiloVenta);
                const ganancia = ingresoVenta - costoCompra;
                const margen = costoCompra > 0 ? (ganancia / costoCompra) * 100 : 0;
                const diasEnFinca = Math.floor((new Date(salida.fechaSalida) - new Date(entrada.fechaEntrada)) / (1000*60*60*24));
                const gananciaKg = salida.peso - entrada.peso;
                const gdp = diasEnFinca > 0 ? gananciaKg / diasEnFinca : 0;
                
                return {
                    numero: entrada.numero,
                    pesoCompra: entrada.peso,
                    pesoVenta: salida.peso,
                    costoCompra: costoCompra,
                    ingresoVenta: ingresoVenta,
                    ganancia: ganancia,
                    margen: margen,
                    diasEnFinca: diasEnFinca,
                    gdp: gdp,
                    vendedor: entrada.vendedor
                };
            }).filter(a => a !== null);
            
            if (soldAnimals.length === 0) {
                reportDiv.innerHTML = '<div style="text-align: center; padding: 2rem; color: var(--gray);">No hay suficientes datos de ventas para generar el an√°lisis</div>';
                return;
            }
            
            // Group by weight ranges
            const ranges = [
                { min: 0, max: 100, label: '< 100 kg' },
                { min: 100, max: 150, label: '100-150 kg' },
                { min: 150, max: 200, label: '150-200 kg' },
                { min: 200, max: 250, label: '200-250 kg' },
                { min: 250, max: 300, label: '250-300 kg' },
                { min: 300, max: 999, label: '> 300 kg' }
            ];
            
            const rangeStats = ranges.map(range => {
                const animalsInRange = soldAnimals.filter(a => a.pesoCompra >= range.min && a.pesoCompra < range.max);
                
                if (animalsInRange.length === 0) {
                    return { ...range, count: 0 };
                }
                
                const avgMargen = animalsInRange.reduce((sum, a) => sum + a.margen, 0) / animalsInRange.length;
                const avgGanancia = animalsInRange.reduce((sum, a) => sum + a.ganancia, 0) / animalsInRange.length;
                const avgGDP = animalsInRange.reduce((sum, a) => sum + a.gdp, 0) / animalsInRange.length;
                const avgDias = animalsInRange.reduce((sum, a) => sum + a.diasEnFinca, 0) / animalsInRange.length;
                const totalGanancia = animalsInRange.reduce((sum, a) => sum + a.ganancia, 0);
                
                return {
                    ...range,
                    count: animalsInRange.length,
                    avgMargen: avgMargen,
                    avgGanancia: avgGanancia,
                    avgGDP: avgGDP,
                    avgDias: avgDias,
                    totalGanancia: totalGanancia,
                    avgROI: avgMargen // Same as margin in this case
                };
            }).filter(r => r.count > 0);
            
            // Sort by average margin (best first)
            rangeStats.sort((a, b) => b.avgMargen - a.avgMargen);
            
            // Generate visual report
            let html = '<div style="background: linear-gradient(135deg, #e8f5e9, #c8e6c9); padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem;">';
            html += '<h3 style="margin: 0 0 1rem 0; color: #2e7d32;">üéØ PUNTO √ìPTIMO DE COMPRA</h3>';
            
            if (rangeStats.length > 0) {
                const best = rangeStats[0];
                html += `<div style="font-size: 1.2rem; font-weight: bold; margin-bottom: 0.5rem;">üìä ${best.label}</div>`;
                html += `<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-top: 1rem;">`;
                html += `<div><strong>Margen:</strong> ${best.avgMargen.toFixed(1)}%</div>`;
                html += `<div><strong>Ganancia:</strong> ${formatCurrency(best.avgGanancia)}</div>`;
                html += `<div><strong>GDP:</strong> ${best.avgGDP.toFixed(3)} kg/d√≠a</div>`;
                html += `<div><strong>Animales:</strong> ${best.count}</div>`;
                html += `</div>`;
            }
            html += '</div>';
            
            // Detailed table
            html += '<div style="overflow-x: auto;"><table style="width: 100%; border-collapse: collapse;">';
            html += '<thead><tr style="background: var(--primary); color: white;">';
            html += '<th style="padding: 0.75rem; text-align: left;">Rango de Peso</th>';
            html += '<th style="padding: 0.75rem; text-align: center;">Animales</th>';
            html += '<th style="padding: 0.75rem; text-align: right;">Margen %</th>';
            html += '<th style="padding: 0.75rem; text-align: right;">Ganancia Promedio</th>';
            html += '<th style="padding: 0.75rem; text-align: right;">GDP Promedio</th>';
            html += '<th style="padding: 0.75rem; text-align: right;">D√≠as Promedio</th>';
            html += '<th style="padding: 0.75rem; text-align: right;">Ganancia Total</th>';
            html += '</tr></thead><tbody>';
            
            rangeStats.forEach((r, i) => {
                const rowColor = i === 0 ? 'background: #e8f5e9;' : '';
                html += `<tr style="${rowColor}">`;
                html += `<td style="padding: 0.75rem; border-bottom: 1px solid #ddd;"><strong>${r.label}</strong></td>`;
                html += `<td style="padding: 0.75rem; border-bottom: 1px solid #ddd; text-align: center;">${r.count}</td>`;
                html += `<td style="padding: 0.75rem; border-bottom: 1px solid #ddd; text-align: right;"><strong style="color: var(--success);">${r.avgMargen.toFixed(1)}%</strong></td>`;
                html += `<td style="padding: 0.75rem; border-bottom: 1px solid #ddd; text-align: right;">${formatCurrency(r.avgGanancia)}</td>`;
                html += `<td style="padding: 0.75rem; border-bottom: 1px solid #ddd; text-align: right;">${r.avgGDP.toFixed(3)} kg/d√≠a</td>`;
                html += `<td style="padding: 0.75rem; border-bottom: 1px solid #ddd; text-align: right;">${Math.round(r.avgDias)} d√≠as</td>`;
                html += `<td style="padding: 0.75rem; border-bottom: 1px solid #ddd; text-align: right;"><strong>${formatCurrency(r.totalGanancia)}</strong></td>`;
                html += '</tr>';
            });
            
            html += '</tbody></table></div>';
            
            // Recommendations
            html += '<div style="margin-top: 1.5rem; padding: 1.5rem; background: #fff3e0; border-left: 4px solid #ff9800; border-radius: 8px;">';
            html += '<h4 style="margin: 0 0 1rem 0; color: #e65100;">üí° RECOMENDACIONES</h4>';
            html += '<ul style="margin: 0; padding-left: 1.5rem;">';
            
            if (rangeStats.length > 0) {
                const best = rangeStats[0];
                const worst = rangeStats[rangeStats.length - 1];
                
                html += `<li><strong>ENFOCARSE EN:</strong> Comprar animales en el rango ${best.label} - han generado ${best.avgMargen.toFixed(1)}% de margen promedio</li>`;
                html += `<li><strong>EVITAR:</strong> El rango ${worst.label} muestra menor rentabilidad (${worst.avgMargen.toFixed(1)}% margen)</li>`;
                
                if (best.avgGDP > 0.4) {
                    html += `<li><strong>GDP EXCELENTE:</strong> Animales en ${best.label} tienen GDP de ${best.avgGDP.toFixed(3)} kg/d√≠a - muy por encima del promedio</li>`;
                }
                
                html += `<li><strong>TIEMPO DE INVERSI√ìN:</strong> Animales en rango √≥ptimo toman ${Math.round(best.avgDias)} d√≠as promedio hasta venta</li>`;
            }
            
            html += '</ul></div>';
            
            reportDiv.innerHTML = html;
        }
        
        function copyAnalysis() {
            const content = document.getElementById('aiResponseContent').innerText;
            navigator.clipboard.writeText(content).then(() => {
                showToast('An√°lisis copiado al portapapeles', 'success');
            }).catch(() => {
                showToast('Error al copiar', 'error');
            });
        }
        
        // ==================== IMPORT RANCH DATA FUNCTIONS ====================
        
        function importLaVegaData() {
            if (!confirm('¬øImportar 113 animales a La Vega? Esta acci√≥n agregar√° los datos al inventario existente.')) {
                return;
            }
            
            try {
                showToast('üì• Cargando datos de La Vega...', 'info');
                
                // Complete La Vega data - 113 animals
                const laVegaAnimals = [
                    { chapeta: "785", lote: "138", vendedor: "Wilson Escobar", raza: "Ceb√∫", sexo: "HEMBRA", pesoInicial: 380, precioKg: 5394.74, fecha: "2022-10-05" },
                    { chapeta: "810", lote: "146", vendedor: "Wilson Escobar", raza: "Ceb√∫", sexo: "HEMBRA", pesoInicial: 150, precioKg: 8666.67, fecha: "2023-01-15" },
                    { chapeta: "854", lote: "162", vendedor: "Wilson Escobar", raza: "Ceb√∫", sexo: "HEMBRA", pesoInicial: 140, precioKg: 7500, fecha: "2023-03-06" },
                    { chapeta: "856", lote: "164", vendedor: "Wilson Escobar", raza: "Ceb√∫", sexo: "HEMBRA", pesoInicial: 120, precioKg: 6666.67, fecha: "2023-03-12" },
                    { chapeta: "881", lote: "173", vendedor: "Wilson Escobar", raza: "Ceb√∫", sexo: "HEMBRA", pesoInicial: 185, precioKg: 7837.84, fecha: "2023-05-13" },
                    { chapeta: "893", lote: "177", vendedor: "Joye", raza: "Ceb√∫", sexo: "MACHO", pesoInicial: 132, precioKg: 8200, fecha: "2023-08-13" },
                    { chapeta: "903", lote: "181", vendedor: "Coemangel", raza: "Ceb√∫", sexo: "HEMBRA", pesoInicial: 55, precioKg: 10000, fecha: "2023-10-16" },
                    { chapeta: "920", lote: "185", vendedor: "David Cadavid", raza: "Ceb√∫", sexo: "MACHO", pesoInicial: 110, precioKg: 8454.55, fecha: "2023-10-31" },
                    { chapeta: "921", lote: "185", vendedor: "David Cadavid", raza: "Ceb√∫", sexo: "MACHO", pesoInicial: 110, precioKg: 8454.55, fecha: "2023-10-31" },
                    { chapeta: "922", lote: "186", vendedor: "Varios", raza: "Ceb√∫", sexo: "MACHO", pesoInicial: 120, precioKg: 10000, fecha: "2023-07-30" },
                    { chapeta: "923", lote: "187", vendedor: "Wilson Escobar", raza: "Ceb√∫", sexo: "MACHO", pesoInicial: 75, precioKg: 8666.67, fecha: "2023-11-03" },
                    { chapeta: "924", lote: "188", vendedor: "Wilson Escobar", raza: "Ceb√∫", sexo: "HEMBRA", pesoInicial: 160, precioKg: 9375, fecha: "2023-11-03" },
                    { chapeta: "925", lote: "189", vendedor: "Wilson Escobar", raza: "Ceb√∫", sexo: "MACHO", pesoInicial: 70, precioKg: 4285.71, fecha: "2023-11-26" },
                    { chapeta: "926", lote: "190", vendedor: "Wilson Escobar", raza: "Ceb√∫", sexo: "MACHO", pesoInicial: 85, precioKg: 6470.59, fecha: "2023-11-25" },
                    { chapeta: "928", lote: "191", vendedor: "Wilson Escobar", raza: "Ceb√∫", sexo: "MACHO", pesoInicial: 170, precioKg: 8029.41, fecha: "2023-11-25" },
                    { chapeta: "929", lote: "192", vendedor: "Omar Cardona", raza: "Ceb√∫", sexo: "MACHO", pesoInicial: 170, precioKg: 7941.18, fecha: "2023-11-13" },
                    { chapeta: "930", lote: "192", vendedor: "Omar Cardona", raza: "Ceb√∫", sexo: "MACHO", pesoInicial: 170, precioKg: 7941.18, fecha: "2023-11-13" },
                    { chapeta: "934", lote: "194", vendedor: "H√©ctor Vecino", raza: "Ceb√∫", sexo: "HEMBRA", pesoInicial: 160, precioKg: 10000, fecha: "2023-11-13" },
                    { chapeta: "935", lote: "195", vendedor: "H√©ctor Vecino", raza: "Ceb√∫", sexo: "MACHO", pesoInicial: 90, precioKg: 6666.67, fecha: "2023-11-13" },
                    { chapeta: "936", lote: "196", vendedor: "Wilson Escobar", raza: "Ceb√∫", sexo: "HEMBRA", pesoInicial: 270, precioKg: 10000, fecha: "2023-12-02" },
                    { chapeta: "939", lote: "197", vendedor: "David Cadavid", raza: "Ceb√∫", sexo: "MACHO", pesoInicial: 135, precioKg: 8000, fecha: "2023-12-04" },
                    { chapeta: "940", lote: "197", vendedor: "David Cadavid", raza: "Ceb√∫", sexo: "MACHO", pesoInicial: 135, precioKg: 8000, fecha: "2023-12-04" },
                    { chapeta: "941", lote: "197", vendedor: "David Cadavid", raza: "Ceb√∫", sexo: "MACHO", pesoInicial: 135, precioKg: 8000, fecha: "2023-12-04" },
                    { chapeta: "942", lote: "197", vendedor: "David Cadavid", raza: "Ceb√∫", sexo: "MACHO", pesoInicial: 135, precioKg: 8000, fecha: "2023-12-04" },
                    { chapeta: "943", lote: "197", vendedor: "David Cadavid", raza: "Ceb√∫", sexo: "MACHO", pesoInicial: 140, precioKg: 7714.29, fecha: "2023-12-04" },
                    { chapeta: "944", lote: "197", vendedor: "David Cadavid", raza: "Ceb√∫", sexo: "MACHO", pesoInicial: 135, precioKg: 8000, fecha: "2023-12-04" },
                    { chapeta: "945", lote: "197", vendedor: "David Cadavid", raza: "Ceb√∫", sexo: "MACHO", pesoInicial: 135, precioKg: 8000, fecha: "2023-12-04" },
                    { chapeta: "946", lote: "197", vendedor: "David Cadavid", raza: "Ceb√∫", sexo: "MACHO", pesoInicial: 135, precioKg: 8000, fecha: "2023-12-04" },
                    { chapeta: "947", lote: "197", vendedor: "David Cadavid", raza: "Ceb√∫", sexo: "MACHO", pesoInicial: 135, precioKg: 8000, fecha: "2023-12-04" },
                    { chapeta: "948", lote: "197", vendedor: "David Cadavid", raza: "Ceb√∫", sexo: "MACHO", pesoInicial: 140, precioKg: 7714.29, fecha: "2023-12-04" },
                    { chapeta: "951", lote: "199", vendedor: "David Cadavid", raza: "Ceb√∫", sexo: "MACHO", pesoInicial: 110, precioKg: 8545.45, fecha: "2023-12-17" },
                    { chapeta: "952", lote: "199", vendedor: "David Cadavid", raza: "Ceb√∫", sexo: "MACHO", pesoInicial: 110, precioKg: 8545.45, fecha: "2023-12-17" },
                    { chapeta: "953", lote: "199", vendedor: "David Cadavid", raza: "Ceb√∫", sexo: "MACHO", pesoInicial: 115, precioKg: 8173.91, fecha: "2023-12-17" },
                    { chapeta: "954", lote: "199", vendedor: "David Cadavid", raza: "Ceb√∫", sexo: "MACHO", pesoInicial: 110, precioKg: 8545.45, fecha: "2023-12-17" },
                    { chapeta: "955", lote: "199", vendedor: "David Cadavid", raza: "Ceb√∫", sexo: "MACHO", pesoInicial: 115, precioKg: 8173.91, fecha: "2023-12-17" },
                    { chapeta: "957", lote: "200", vendedor: "David Cadavid", raza: "Ceb√∫", sexo: "MACHO", pesoInicial: 115, precioKg: 8521.74, fecha: "2023-12-27" },
                    { chapeta: "958", lote: "201", vendedor: "David Cadavid", raza: "Ceb√∫", sexo: "MACHO", pesoInicial: 110, precioKg: 8636.36, fecha: "2023-12-30" },
                    { chapeta: "959", lote: "202", vendedor: "Wilson Escobar", raza: "Ceb√∫", sexo: "MACHO", pesoInicial: 70, precioKg: 7857.14, fecha: "2024-01-28" },
                    { chapeta: "960", lote: "203", vendedor: "Wilson Escobar", raza: "Ceb√∫", sexo: "MACHO", pesoInicial: 135, precioKg: 7111.11, fecha: "2024-01-30" },
                    { chapeta: "961", lote: "204", vendedor: "Wilson Escobar", raza: "Ceb√∫", sexo: "MACHO", pesoInicial: 130, precioKg: 8461.54, fecha: "2024-03-23" },
                    { chapeta: "963", lote: "206", vendedor: "Wilson Escobar", raza: "Ceb√∫", sexo: "MACHO", pesoInicial: 100, precioKg: 7500, fecha: "2024-05-26" },
                    { chapeta: "964", lote: "207", vendedor: "Wilson Escobar", raza: "Ceb√∫", sexo: "MACHO", pesoInicial: 70, precioKg: 9428.57, fecha: "2024-07-07" },
                    { chapeta: "965", lote: "208", vendedor: "Wilson Escobar", raza: "Ceb√∫", sexo: "MACHO", pesoInicial: 100, precioKg: 6500, fecha: "2024-06-15" },
                    { chapeta: "966", lote: "209", vendedor: "Wilson Escobar", raza: "Ceb√∫", sexo: "MACHO", pesoInicial: 60, precioKg: 8333.33, fecha: "2024-06-15" },
                    { chapeta: "969", lote: "210", vendedor: "Wilson Escobar", raza: "Ceb√∫", sexo: "MACHO", pesoInicial: 135, precioKg: 8776.79, fecha: "2024-07-29" },
                    { chapeta: "970", lote: "210", vendedor: "Wilson Escobar", raza: "Ceb√∫", sexo: "MACHO", pesoInicial: 135, precioKg: 8776.79, fecha: "2024-07-29" },
                    { chapeta: "971", lote: "210", vendedor: "Wilson Escobar", raza: "Ceb√∫", sexo: "MACHO", pesoInicial: 135, precioKg: 8776.79, fecha: "2024-07-29" },
                    { chapeta: "972", lote: "210", vendedor: "Wilson Escobar", raza: "Ceb√∫", sexo: "MACHO", pesoInicial: 135, precioKg: 8776.79, fecha: "2024-07-29" },
                    { chapeta: "973", lote: "210", vendedor: "Wilson Escobar", raza: "Ceb√∫", sexo: "MACHO", pesoInicial: 135, precioKg: 8776.79, fecha: "2024-07-29" },
                    { chapeta: "974", lote: "210", vendedor: "Wilson Escobar", raza: "Ceb√∫", sexo: "MACHO", pesoInicial: 135, precioKg: 8776.79, fecha: "2024-07-29" },
                    { chapeta: "978", lote: "210", vendedor: "Wilson Escobar", raza: "Ceb√∫", sexo: "MACHO", pesoInicial: 145, precioKg: 8171.50, fecha: "2024-07-29" },
                    { chapeta: "979", lote: "210", vendedor: "Wilson Escobar", raza: "Ceb√∫", sexo: "MACHO", pesoInicial: 145, precioKg: 8171.50, fecha: "2024-07-29" },
                    { chapeta: "981", lote: "210", vendedor: "Wilson Escobar", raza: "Ceb√∫", sexo: "MACHO", pesoInicial: 145, precioKg: 8171.50, fecha: "2024-07-29" },
                    { chapeta: "982", lote: "210", vendedor: "Wilson Escobar", raza: "Ceb√∫", sexo: "MACHO", pesoInicial: 145, precioKg: 8171.50, fecha: "2024-07-29" },
                    { chapeta: "983", lote: "210", vendedor: "Wilson Escobar", raza: "Ceb√∫", sexo: "MACHO", pesoInicial: 145, precioKg: 8171.50, fecha: "2024-07-29" },
                    { chapeta: "984", lote: "211", vendedor: "Wilson Escobar", raza: "Ceb√∫", sexo: "MACHO", pesoInicial: 145, precioKg: 8275.86, fecha: "2024-08-03" },
                    { chapeta: "985", lote: "211", vendedor: "Wilson Escobar", raza: "Ceb√∫", sexo: "MACHO", pesoInicial: 150, precioKg: 8000, fecha: "2024-08-03" },
                    { chapeta: "986", lote: "211", vendedor: "Wilson Escobar", raza: "Ceb√∫", sexo: "MACHO", pesoInicial: 140, precioKg: 8571.43, fecha: "2024-08-03" },
                    { chapeta: "987", lote: "212", vendedor: "Cundino", raza: "Ceb√∫", sexo: "MACHO", pesoInicial: 140, precioKg: 8000, fecha: "2024-09-01" },
                    { chapeta: "997", lote: "214", vendedor: "Victor Munera", raza: "Ceb√∫", sexo: "MACHO", pesoInicial: 140, precioKg: 8821.80, fecha: "2024-10-08" },
                    { chapeta: "998", lote: "214", vendedor: "Victor Munera", raza: "Ceb√∫", sexo: "MACHO", pesoInicial: 140, precioKg: 8821.80, fecha: "2024-10-08" },
                    { chapeta: "999", lote: "214", vendedor: "Victor Munera", raza: "Ceb√∫", sexo: "MACHO", pesoInicial: 140, precioKg: 8821.80, fecha: "2024-10-08" },
                    { chapeta: "1001", lote: "214", vendedor: "Victor Munera", raza: "Ceb√∫", sexo: "MACHO", pesoInicial: 140, precioKg: 8821.80, fecha: "2024-10-08" },
                    { chapeta: "1002", lote: "214", vendedor: "Victor Munera", raza: "Ceb√∫", sexo: "MACHO", pesoInicial: 140, precioKg: 8821.80, fecha: "2024-10-08" },
                    { chapeta: "1003", lote: "214", vendedor: "Victor Munera", raza: "Ceb√∫", sexo: "MACHO", pesoInicial: 140, precioKg: 8821.80, fecha: "2024-10-08" },
                    { chapeta: "1004", lote: "214", vendedor: "Victor Munera", raza: "Ceb√∫", sexo: "MACHO", pesoInicial: 145, precioKg: 8517.60, fecha: "2024-10-08" },
                    { chapeta: "1005", lote: "214", vendedor: "Victor Munera", raza: "Ceb√∫", sexo: "MACHO", pesoInicial: 145, precioKg: 8517.60, fecha: "2024-10-08" },
                    { chapeta: "1006", lote: "214", vendedor: "Victor Munera", raza: "Ceb√∫", sexo: "MACHO", pesoInicial: 145, precioKg: 8517.60, fecha: "2024-10-08" },
                    { chapeta: "1007", lote: "214", vendedor: "Victor Munera", raza: "Ceb√∫", sexo: "MACHO", pesoInicial: 145, precioKg: 8517.60, fecha: "2024-10-08" },
                    { chapeta: "1008", lote: "214", vendedor: "Victor Munera", raza: "Ceb√∫", sexo: "MACHO", pesoInicial: 145, precioKg: 8517.60, fecha: "2024-10-08" },
                    { chapeta: "1017", lote: "218", vendedor: "Victor Munera", raza: "Ceb√∫", sexo: "MACHO", pesoInicial: 125, precioKg: 9200, fecha: "2024-10-22" },
                    { chapeta: "1018", lote: "218", vendedor: "Victor Munera", raza: "Ceb√∫", sexo: "MACHO", pesoInicial: 125, precioKg: 9200, fecha: "2024-10-22" },
                    { chapeta: "1019", lote: "218", vendedor: "Victor Munera", raza: "Ceb√∫", sexo: "MACHO", pesoInicial: 130, precioKg: 8846.15, fecha: "2024-10-22" },
                    { chapeta: "1021", lote: "219", vendedor: "Victor Munera", raza: "Ceb√∫", sexo: "MACHO", pesoInicial: 135, precioKg: 8888.89, fecha: "2024-10-22" },
                    { chapeta: "1023", lote: "219", vendedor: "Victor Munera", raza: "Ceb√∫", sexo: "MACHO", pesoInicial: 135, precioKg: 8888.89, fecha: "2024-10-22" },
                    { chapeta: "1024", lote: "219", vendedor: "Victor Munera", raza: "Ceb√∫", sexo: "MACHO", pesoInicial: 140, precioKg: 8571.43, fecha: "2024-10-22" },
                    { chapeta: "1025", lote: "219", vendedor: "Victor Munera", raza: "Ceb√∫", sexo: "MACHO", pesoInicial: 140, precioKg: 8571.43, fecha: "2024-10-22" },
                    { chapeta: "1026", lote: "220", vendedor: "Victor Munera", raza: "Ceb√∫", sexo: "MACHO", pesoInicial: 150, precioKg: 9178.67, fecha: "2024-10-22" },
                    { chapeta: "1027", lote: "220", vendedor: "Victor Munera", raza: "Ceb√∫", sexo: "MACHO", pesoInicial: 150, precioKg: 9178.67, fecha: "2024-10-22" },
                    { chapeta: "1030", lote: "220", vendedor: "Victor Munera", raza: "Ceb√∫", sexo: "MACHO", pesoInicial: 160, precioKg: 8605, fecha: "2024-10-22" },
                    { chapeta: "1031", lote: "220", vendedor: "Victor Munera", raza: "Ceb√∫", sexo: "MACHO", pesoInicial: 160, precioKg: 8605, fecha: "2024-10-22" },
                    { chapeta: "1032", lote: "221", vendedor: "Nicol√°s Rodr√≠guez", raza: "Ceb√∫", sexo: "MACHO", pesoInicial: 100, precioKg: 10500, fecha: "2024-11-04" },
                    { chapeta: "1038", lote: "223", vendedor: "Wilson Escobar", raza: "Ceb√∫", sexo: "HEMBRA", pesoInicial: 150, precioKg: 8533.33, fecha: "2024-12-08" },
                    { chapeta: "1039", lote: "224", vendedor: "Wilson Escobar", raza: "Ceb√∫", sexo: "MACHO", pesoInicial: 80, precioKg: 8750, fecha: "2024-12-27" },
                    { chapeta: "1040", lote: "224", vendedor: "Wilson Escobar", raza: "Ceb√∫", sexo: "MACHO", pesoInicial: 90, precioKg: 7777.78, fecha: "2024-12-27" },
                    { chapeta: "1042", lote: "225", vendedor: "Wilson Escobar", raza: "Ceb√∫", sexo: "HEMBRA", pesoInicial: 215, precioKg: 10000, fecha: "2025-03-25" },
                    { chapeta: "1043", lote: "226", vendedor: "Wilson Escobar", raza: "Ceb√∫", sexo: "MACHO", pesoInicial: 75, precioKg: 8000, fecha: "2025-04-06" },
                    { chapeta: "1045", lote: "227", vendedor: "Gabriel Escobar", raza: "Ceb√∫", sexo: "MACHO", pesoInicial: 145, precioKg: 9425.29, fecha: "2025-05-01" },
                    { chapeta: "1046", lote: "227", vendedor: "Gabriel Escobar", raza: "Ceb√∫", sexo: "MACHO", pesoInicial: 145, precioKg: 9425.29, fecha: "2025-05-01" },
                    { chapeta: "1047", lote: "228", vendedor: "Edisson Carmona", raza: "Ceb√∫", sexo: "MACHO", pesoInicial: 120, precioKg: 8333.33, fecha: "2025-05-01" },
                    { chapeta: "1049", lote: "230", vendedor: "Wilson Escobar", raza: "Ceb√∫", sexo: "HEMBRA", pesoInicial: 120, precioKg: 9166.67, fecha: "2025-05-11" },
                    { chapeta: "1050", lote: "N/A", vendedor: "NACIMIENTO", raza: "Ceb√∫", sexo: "HEMBRA", pesoInicial: 35, precioKg: 10000, fecha: "2025-06-29" },
                    { chapeta: "1051", lote: "231", vendedor: "Wilson Escobar", raza: "Ceb√∫", sexo: "MACHO", pesoInicial: 280, precioKg: 7142.86, fecha: "2025-07-20" },
                    { chapeta: "1053", lote: "N/A", vendedor: "NACIMIENTO", raza: "Ceb√∫", sexo: "HEMBRA", pesoInicial: 30, precioKg: 10000, fecha: "2025-07-29" },
                    { chapeta: "1054", lote: "233", vendedor: "Albeiro Pineda", raza: "Ceb√∫", sexo: "MACHO", pesoInicial: 216, precioKg: 9100, fecha: "2025-08-30" },
                    { chapeta: "1055", lote: "N/A", vendedor: "NACIMIENTO", raza: "Ceb√∫", sexo: "MACHO", pesoInicial: 35, precioKg: 10000, fecha: "2025-09-01" },
                    { chapeta: "1056", lote: "234", vendedor: "Cundino", raza: "Ceb√∫", sexo: "MACHO", pesoInicial: 135, precioKg: 8148.15, fecha: "2025-09-06" },
                    { chapeta: "1057", lote: "234", vendedor: "Cundino", raza: "Ceb√∫", sexo: "MACHO", pesoInicial: 140, precioKg: 7857.14, fecha: "2025-09-06" },
                    { chapeta: "1058", lote: "235", vendedor: "Wilson Escobar", raza: "Ceb√∫", sexo: "MACHO", pesoInicial: 105, precioKg: 9523.81, fecha: "2025-10-05" },
                    { chapeta: "1059", lote: "236", vendedor: "Wilson Escobar", raza: "Ceb√∫", sexo: "MACHO", pesoInicial: 195, precioKg: 8461.54, fecha: "2025-10-05" },
                    { chapeta: "1060", lote: "237", vendedor: "Wilson Escobar", raza: "Ceb√∫", sexo: "MACHO", pesoInicial: 115, precioKg: 10000, fecha: "2025-11-03" },
                    { chapeta: "1061", lote: "237", vendedor: "Wilson Escobar", raza: "Ceb√∫", sexo: "MACHO", pesoInicial: 115, precioKg: 10000, fecha: "2025-11-03" },
                    { chapeta: "1062", lote: "237", vendedor: "Wilson Escobar", raza: "Ceb√∫", sexo: "MACHO", pesoInicial: 115, precioKg: 10000, fecha: "2025-11-03" },
                    { chapeta: "1063", lote: "237", vendedor: "Wilson Escobar", raza: "Ceb√∫", sexo: "MACHO", pesoInicial: 115, precioKg: 10000, fecha: "2025-11-03" },
                    { chapeta: "1064", lote: "237", vendedor: "Wilson Escobar", raza: "Ceb√∫", sexo: "MACHO", pesoInicial: 115, precioKg: 10000, fecha: "2025-11-03" },
                    { chapeta: "1065", lote: "238", vendedor: "Construinmuniza", raza: "Ceb√∫", sexo: "MACHO", pesoInicial: 135, precioKg: 8888.89, fecha: "2025-12-08" },
                    { chapeta: "1066", lote: "238", vendedor: "Construinmuniza", raza: "Ceb√∫", sexo: "MACHO", pesoInicial: 140, precioKg: 8571.43, fecha: "2025-12-08" },
                    { chapeta: "1067", lote: "239", vendedor: "Construinmuniza", raza: "Ceb√∫", sexo: "MACHO", pesoInicial: 100, precioKg: 9500, fecha: "2025-12-08" },
                    { chapeta: "1068", lote: "240", vendedor: "Wilson Escobar", raza: "Ceb√∫", sexo: "MACHO", pesoInicial: 120, precioKg: 9000, fecha: "2025-12-23" },
                    { chapeta: "1069", lote: "240", vendedor: "Wilson Escobar", raza: "Ceb√∫", sexo: "MACHO", pesoInicial: 80, precioKg: 9000, fecha: "2025-12-23" }
                ];
                
                // Switch to La Vega ranch
                const previousRanch = currentRanch;
                currentRanch = 'la_vega';
                applyRanchTheme();
                loadData();
                
                // Convert and import data
                let importedCount = 0;
                laVegaAnimals.forEach(animal => {
                    // Check if animal already exists
                    const exists = data.entradas.some(e => e.numero == animal.chapeta);
                    if (!exists) {
                        const entrada = {
                            numero: animal.chapeta,
                            lote: animal.lote,
                            vendedor: animal.vendedor,
                            raza: animal.raza || 'Ceb√∫',
                            sexo: animal.sexo,
                            peso: animal.pesoInicial,
                            precioKilo: Math.round(animal.precioKg),
                            fechaEntrada: animal.fecha,
                            numeroVaca: null,
                            costoTotal: animal.pesoInicial * animal.precioKg
                        };
                        data.entradas.push(entrada);
                        importedCount++;
                    }
                });
                
                // Save data
                saveData();
                
                // Update all views
                updateAllViews();
                
                showToast(`‚úÖ Importados ${importedCount} animales a La Vega (Total: ${data.entradas.length})`, 'success');
                
                // Switch back to previous ranch if needed
                if (previousRanch !== 'la_vega') {
                    setTimeout(() => {
                        switchRanch(previousRanch);
                    }, 2000);
                }
            } catch (error) {
                console.error('Error importing La Vega data:', error);
                showToast('‚ùå Error al importar datos: ' + error.message, 'error');
            }
        }
        
        function importLaCorunaData() {
            // Since the user has the Excel file, guide them to use the manual import
            if (confirm('Para importar los datos de La Coru√±a:\n\n1. Haga clic en "üì• Importar Excel" abajo\n2. Seleccione el archivo "La Coruna.xlsx" de su carpeta Downloads\n\n¬øDesea continuar?')) {
                // Scroll to the import section and highlight it
                document.getElementById('importExcel').scrollIntoView({ behavior: 'smooth' });
                
                // Flash the import button
                const importLabel = document.querySelector('label[for="importExcel"]');
                if (importLabel) {
                    importLabel.style.animation = 'pulse 1s ease 3';
                    setTimeout(() => {
                        importLabel.style.animation = '';
                    }, 3000);
                }
                
                showToast('üëâ Use el bot√≥n "üì• Importar Excel" para cargar La Coruna.xlsx', 'info');
            }
        }
        
        function importSantaCatalinaData() {
            if (!confirm('¬øImportar 103 animales a Santa Catalina? Esta acci√≥n agregar√° los datos al inventario existente.')) {
                return;
            }
            
            try {
                showToast('üì• Cargando datos de Santa Catalina...', 'info');
                
                // Embedded Santa Catalina data (from import-catalina-data.js)
                const catalinaData = [
                    { numero: '140', lote: '22', vendedor: 'Vizcaya', sexo: 'MACHO', peso: 135, precioKilo: 8400, fecha: '2023-05-27' },
                    { numero: '142', lote: '22', vendedor: 'Vizcaya', sexo: 'MACHO', peso: 163, precioKilo: 8400, fecha: '2023-05-27' },
                    { numero: '144', lote: '22', vendedor: 'Vizcaya', sexo: 'MACHO', peso: 200, precioKilo: 8400, fecha: '2023-05-27' },
                    { numero: '153', lote: '23', vendedor: 'Joye', sexo: 'MACHO', peso: 126, precioKilo: 7900, fecha: '2023-06-04' },
                    { numero: '155', lote: '25', vendedor: 'Joye', sexo: 'MACHO', peso: 194, precioKilo: 7900, fecha: '2023-06-04' },
                    { numero: '161', lote: '26', vendedor: 'Vizcaya', sexo: 'MACHO', peso: 178, precioKilo: 8200, fecha: '2023-07-20' },
                    { numero: '162', lote: '26', vendedor: 'Vizcaya', sexo: 'MACHO', peso: 150, precioKilo: 8200, fecha: '2023-07-20' },
                    { numero: '165', lote: '26', vendedor: 'Vizcaya', sexo: 'MACHO', peso: 224, precioKilo: 8200, fecha: '2023-07-20' },
                    { numero: '166', lote: '27', vendedor: 'Joye', sexo: 'MACHO', peso: 143, precioKilo: 8200, fecha: '2023-08-13' },
                    { numero: '167', lote: '27', vendedor: 'Joye', sexo: 'MACHO', peso: 139, precioKilo: 8200, fecha: '2023-08-13' },
                    { numero: '173', lote: '29', vendedor: 'Vizcaya', sexo: 'MACHO', peso: 239, precioKilo: 8100, fecha: '2023-10-15' },
                    { numero: '175', lote: '30', vendedor: 'San Fernando', sexo: 'MACHO', peso: 221, precioKilo: 8200, fecha: '2024-01-10' },
                    { numero: '178', lote: '31', vendedor: 'Vizcaya', sexo: 'MACHO', peso: 200, precioKilo: 8000, fecha: '2024-01-10' },
                    { numero: '179', lote: '31', vendedor: 'Vizcaya', sexo: 'MACHO', peso: 271, precioKilo: 8000, fecha: '2024-01-10' },
                    { numero: '181', lote: '31', vendedor: 'Vizcaya', sexo: 'MACHO', peso: 256, precioKilo: 8000, fecha: '2024-01-10' },
                    { numero: '183', lote: '32', vendedor: 'Fernando Uribe', sexo: 'MACHO', peso: 212, precioKilo: 7901, fecha: '2024-03-14' },
                    { numero: '184', lote: '33', vendedor: 'Vizcaya', sexo: 'MACHO', peso: 294, precioKilo: 8000, fecha: '2024-06-08' },
                    { numero: '185', lote: '33', vendedor: 'Vizcaya', sexo: 'MACHO', peso: 265, precioKilo: 8000, fecha: '2024-06-08' },
                    { numero: '187', lote: '35', vendedor: 'Vizcaya', sexo: 'MACHO', peso: 237, precioKilo: 8000, fecha: '2024-06-08' },
                    { numero: '188', lote: '35', vendedor: 'Vizcaya', sexo: 'MACHO', peso: 233, precioKilo: 8000, fecha: '2024-06-08' },
                    { numero: '190', lote: '35', vendedor: 'Vizcaya', sexo: 'MACHO', peso: 256, precioKilo: 8000, fecha: '2024-06-08' },
                    { numero: '191', lote: '35', vendedor: 'Vizcaya', sexo: 'MACHO', peso: 306, precioKilo: 8000, fecha: '2024-06-08' },
                    { numero: '192', lote: '35', vendedor: 'Vizcaya', sexo: 'MACHO', peso: 257, precioKilo: 8000, fecha: '2024-06-08' },
                    { numero: '193', lote: '35', vendedor: 'Vizcaya', sexo: 'MACHO', peso: 260, precioKilo: 8000, fecha: '2024-06-08' },
                    { numero: '195', lote: '35', vendedor: 'Vizcaya', sexo: 'MACHO', peso: 213, precioKilo: 8000, fecha: '2024-06-08' },
                    { numero: '196', lote: '36', vendedor: 'Vizcaya', sexo: 'MACHO', peso: 256, precioKilo: 8000, fecha: '2024-06-21' },
                    { numero: '197', lote: '36', vendedor: 'Vizcaya', sexo: 'MACHO', peso: 258, precioKilo: 8000, fecha: '2024-06-21' },
                    { numero: '198', lote: '36', vendedor: 'Vizcaya', sexo: 'MACHO', peso: 279, precioKilo: 8000, fecha: '2024-06-21' },
                    { numero: '201', lote: '37', vendedor: 'Albeiro Pineda', sexo: 'MACHO', peso: 268, precioKilo: 8000, fecha: '2024-07-27' },
                    { numero: '202', lote: '38', vendedor: 'Vizcaya', sexo: 'MACHO', peso: 274, precioKilo: 8000, fecha: '2024-08-10' },
                    { numero: '203', lote: '39', vendedor: 'Llanitos', sexo: 'MACHO', peso: 244, precioKilo: 8000, fecha: '2024-08-10' },
                    { numero: '207', lote: '40', vendedor: 'Vizcaya', sexo: 'MACHO', peso: 260, precioKilo: 8000, fecha: '2024-08-10' },
                    { numero: '208', lote: '41', vendedor: 'Llanitos', sexo: 'MACHO', peso: 260, precioKilo: 8000, fecha: '2024-08-10' },
                    { numero: '215', lote: '42', vendedor: 'Gustavo Garc√≠a', sexo: 'MACHO', peso: 293, precioKilo: 7800, fecha: '2024-10-05' },
                    { numero: '216', lote: '43', vendedor: 'Vizcaya', sexo: 'MACHO', peso: 300, precioKilo: 8100, fecha: '2024-10-12' },
                    { numero: '217', lote: '43', vendedor: 'Vizcaya', sexo: 'MACHO', peso: 190, precioKilo: 8100, fecha: '2024-10-12' },
                    { numero: '218', lote: '43', vendedor: 'Vizcaya', sexo: 'MACHO', peso: 235, precioKilo: 8100, fecha: '2024-10-12' },
                    { numero: '219', lote: '43', vendedor: 'Vizcaya', sexo: 'MACHO', peso: 265, precioKilo: 8100, fecha: '2024-10-12' },
                    { numero: '220', lote: '43', vendedor: 'Vizcaya', sexo: 'MACHO', peso: 257, precioKilo: 8100, fecha: '2024-10-12' },
                    { numero: '221', lote: '43', vendedor: 'Vizcaya', sexo: 'MACHO', peso: 208, precioKilo: 8100, fecha: '2024-10-12' },
                    { numero: '222', lote: '43', vendedor: 'Vizcaya', sexo: 'MACHO', peso: 221, precioKilo: 8100, fecha: '2024-10-12' },
                    { numero: '223', lote: '44', vendedor: 'Albeiro Pineda', sexo: 'MACHO', peso: 307, precioKilo: 7950, fecha: '2024-11-17' },
                    { numero: '224', lote: '44', vendedor: 'Albeiro Pineda', sexo: 'MACHO', peso: 292, precioKilo: 7950, fecha: '2024-11-17' },
                    { numero: '225', lote: '44', vendedor: 'Albeiro Pineda', sexo: 'MACHO', peso: 288, precioKilo: 7950, fecha: '2024-11-17' },
                    { numero: '226', lote: '45', vendedor: 'Fernando Uribe', sexo: 'MACHO', peso: 247, precioKilo: 8400, fecha: '2025-01-30' },
                    { numero: '227', lote: '46', vendedor: 'Vizcaya', sexo: 'MACHO', peso: 247, precioKilo: 8100, fecha: '2025-02-23' },
                    { numero: '228', lote: '46', vendedor: 'Vizcaya', sexo: 'MACHO', peso: 212, precioKilo: 8100, fecha: '2025-02-23' },
                    { numero: '229', lote: '46', vendedor: 'Vizcaya', sexo: 'MACHO', peso: 215, precioKilo: 8100, fecha: '2025-02-23' },
                    { numero: '230', lote: '46', vendedor: 'Vizcaya', sexo: 'MACHO', peso: 206, precioKilo: 8100, fecha: '2025-02-23' },
                    { numero: '231', lote: '46', vendedor: 'Vizcaya', sexo: 'MACHO', peso: 230, precioKilo: 8100, fecha: '2025-02-23' },
                    { numero: '232', lote: '47', vendedor: 'Vizcaya', sexo: 'MACHO', peso: 315, precioKilo: 8100, fecha: '2025-04-14' },
                    { numero: '233', lote: '48', vendedor: 'Vizcaya', sexo: 'MACHO', peso: 228, precioKilo: 8300, fecha: '2025-04-15' },
                    { numero: '234', lote: '48', vendedor: 'Vizcaya', sexo: 'MACHO', peso: 227, precioKilo: 8300, fecha: '2025-04-15' },
                    { numero: '235', lote: '48', vendedor: 'Vizcaya', sexo: 'MACHO', peso: 205, precioKilo: 8300, fecha: '2025-04-15' },
                    { numero: '236', lote: '48', vendedor: 'Vizcaya', sexo: 'MACHO', peso: 190, precioKilo: 8300, fecha: '2025-04-15' },
                    { numero: '237', lote: '48', vendedor: 'Vizcaya', sexo: 'MACHO', peso: 180, precioKilo: 8300, fecha: '2025-04-15' },
                    { numero: '238', lote: '48', vendedor: 'Vizcaya', sexo: 'MACHO', peso: 210, precioKilo: 8300, fecha: '2025-04-15' },
                    { numero: '239', lote: '48', vendedor: 'Vizcaya', sexo: 'MACHO', peso: 182, precioKilo: 8300, fecha: '2025-04-15' },
                    { numero: '240', lote: '48', vendedor: 'Vizcaya', sexo: 'MACHO', peso: 229, precioKilo: 8300, fecha: '2025-04-15' },
                    { numero: '241', lote: '49', vendedor: 'Vizcaya', sexo: 'MACHO', peso: 135, precioKilo: 9630, fecha: '2025-04-16' },
                    { numero: '242', lote: '50', vendedor: 'Vizcaya', sexo: 'MACHO', peso: 125, precioKilo: 10000, fecha: '2025-04-16' },
                    { numero: '243', lote: '51', vendedor: 'Albeiro Pineda', sexo: 'MACHO', peso: 230, precioKilo: 8300, fecha: '2025-05-21' },
                    { numero: '244', lote: '51', vendedor: 'Albeiro Pineda', sexo: 'MACHO', peso: 267, precioKilo: 8300, fecha: '2025-05-21' },
                    { numero: '245', lote: '51', vendedor: 'Albeiro Pineda', sexo: 'MACHO', peso: 306, precioKilo: 8300, fecha: '2025-05-21' },
                    { numero: '246', lote: '52', vendedor: 'Vizcaya', sexo: 'MACHO', peso: 201, precioKilo: 8600, fecha: '2025-08-09' },
                    { numero: '247', lote: '52', vendedor: 'Vizcaya', sexo: 'MACHO', peso: 206, precioKilo: 8600, fecha: '2025-08-09' },
                    { numero: '248', lote: '52', vendedor: 'Vizcaya', sexo: 'MACHO', peso: 231, precioKilo: 8600, fecha: '2025-08-09' },
                    { numero: '249', lote: '52', vendedor: 'Vizcaya', sexo: 'MACHO', peso: 175, precioKilo: 8600, fecha: '2025-08-09' },
                    { numero: '250', lote: '52', vendedor: 'Vizcaya', sexo: 'MACHO', peso: 188, precioKilo: 8600, fecha: '2025-08-09' },
                    { numero: '251', lote: '52', vendedor: 'Vizcaya', sexo: 'MACHO', peso: 221, precioKilo: 8600, fecha: '2025-08-09' },
                    { numero: '252', lote: '52', vendedor: 'Vizcaya', sexo: 'MACHO', peso: 185, precioKilo: 8600, fecha: '2025-08-09' },
                    { numero: '253', lote: '53', vendedor: 'Vizcaya', sexo: 'MACHO', peso: 190, precioKilo: 9000, fecha: '2025-08-15' },
                    { numero: '254', lote: '54', vendedor: 'Albeiro Pineda', sexo: 'MACHO', peso: 395, precioKilo: 9226, fecha: '2025-08-30' },
                    { numero: '255', lote: '54', vendedor: 'Albeiro Pineda', sexo: 'MACHO', peso: 349, precioKilo: 9226, fecha: '2025-08-30' },
                    { numero: '256', lote: '54', vendedor: 'Albeiro Pineda', sexo: 'MACHO', peso: 337, precioKilo: 9226, fecha: '2025-08-30' },
                    { numero: '257', lote: '54', vendedor: 'Albeiro Pineda', sexo: 'MACHO', peso: 288, precioKilo: 9226, fecha: '2025-08-30' },
                    { numero: '258', lote: '55', vendedor: 'Albeiro Pineda', sexo: 'MACHO', peso: 259, precioKilo: 9100, fecha: '2025-08-31' },
                    { numero: '259', lote: '55', vendedor: 'Albeiro Pineda', sexo: 'MACHO', peso: 294, precioKilo: 9100, fecha: '2025-08-31' },
                    { numero: '260', lote: '55', vendedor: 'Albeiro Pineda', sexo: 'MACHO', peso: 226, precioKilo: 9100, fecha: '2025-08-31' },
                    { numero: '261', lote: '55', vendedor: 'Albeiro Pineda', sexo: 'MACHO', peso: 308, precioKilo: 9100, fecha: '2025-08-31' },
                    { numero: '262', lote: '55', vendedor: 'Albeiro Pineda', sexo: 'MACHO', peso: 203, precioKilo: 9100, fecha: '2025-08-31' },
                    { numero: '263', lote: '56', vendedor: 'Albeiro Pineda', sexo: 'MACHO', peso: 315, precioKilo: 9750, fecha: '2025-11-29' },
                    { numero: '264', lote: '56', vendedor: 'Albeiro Pineda', sexo: 'MACHO', peso: 305, precioKilo: 9750, fecha: '2025-11-29' },
                    { numero: '265', lote: '56', vendedor: 'Albeiro Pineda', sexo: 'MACHO', peso: 280, precioKilo: 9750, fecha: '2025-11-29' },
                    { numero: '266', lote: '56', vendedor: 'Albeiro Pineda', sexo: 'MACHO', peso: 280, precioKilo: 9750, fecha: '2025-11-29' },
                    { numero: '267', lote: '56', vendedor: 'Albeiro Pineda', sexo: 'MACHO', peso: 295, precioKilo: 9750, fecha: '2025-11-29' },
                    { numero: '268', lote: '56', vendedor: 'Albeiro Pineda', sexo: 'MACHO', peso: 260, precioKilo: 9750, fecha: '2025-11-29' },
                    { numero: '269', lote: '56', vendedor: 'Albeiro Pineda', sexo: 'MACHO', peso: 300, precioKilo: 9750, fecha: '2025-11-29' },
                    { numero: '270', lote: '56', vendedor: 'Albeiro Pineda', sexo: 'MACHO', peso: 295, precioKilo: 9750, fecha: '2025-11-29' },
                    { numero: '271', lote: '56', vendedor: 'Albeiro Pineda', sexo: 'MACHO', peso: 275, precioKilo: 9750, fecha: '2025-11-29' },
                    { numero: '272', lote: '56', vendedor: 'Albeiro Pineda', sexo: 'MACHO', peso: 314, precioKilo: 9750, fecha: '2025-11-29' },
                    { numero: '273', lote: '57', vendedor: 'Albeiro Pineda', sexo: 'MACHO', peso: 325, precioKilo: 9700, fecha: '2025-12-02' }
                ];
                
                // Switch to Santa Catalina ranch
                const previousRanch = currentRanch;
                currentRanch = 'santa_catalina';
                applyRanchTheme();
                loadData();
                
                // Convert and import data
                let importedCount = 0;
                catalinaData.forEach(animal => {
                    // Check if animal already exists
                    const exists = data.entradas.some(e => e.numero == animal.numero);
                    if (!exists) {
                        const entrada = {
                            numero: animal.numero,
                            lote: animal.lote,
                            vendedor: animal.vendedor,
                            raza: 'Ceb√∫',
                            sexo: animal.sexo,
                            peso: animal.peso,
                            precioKilo: Math.round(animal.precioKilo),
                            fechaEntrada: animal.fecha,
                            numeroVaca: null,
                            costoTotal: animal.peso * animal.precioKilo
                        };
                        data.entradas.push(entrada);
                        importedCount++;
                    }
                });
                
                // Save data
                saveData();
                
                // Update all views
                updateAllViews();
                
                showToast(`‚úÖ Importados ${importedCount} animales a Santa Catalina (Total: ${data.entradas.length})`, 'success');
                
                // Switch back to previous ranch if needed
                if (previousRanch !== 'santa_catalina') {
                    setTimeout(() => {
                        switchRanch(previousRanch);
                    }, 2000);
                }
            } catch (error) {
                console.error('Error importing Santa Catalina data:', error);
                showToast('‚ùå Error al importar datos: ' + error.message, 'error');
            }
        }
        
        // ==================== FIREBASE CONFIGURATION FUNCTIONS ====================
        
        function toggleFirebaseConfig() {
            const body = document.getElementById('firebaseConfigBody');
            const toggle = document.getElementById('firebaseConfigToggle');
            
            if (body.style.display === 'none') {
                body.style.display = 'block';
                toggle.textContent = '‚ñ≤';
                loadFirebaseConfig();
            } else {
                body.style.display = 'none';
                toggle.textContent = '‚ñº';
            }
        }
        
        function loadFirebaseConfig() {
            // Load from firebase-config.js global variable if available
            if (typeof firebaseConfig !== 'undefined') {
                document.getElementById('fbApiKey').value = firebaseConfig.apiKey || '';
                document.getElementById('fbAuthDomain').value = firebaseConfig.authDomain || '';
                document.getElementById('fbDatabaseURL').value = firebaseConfig.databaseURL || '';
                document.getElementById('fbProjectId').value = firebaseConfig.projectId || '';
                document.getElementById('fbStorageBucket').value = firebaseConfig.storageBucket || '';
                document.getElementById('fbMessagingSenderId').value = firebaseConfig.messagingSenderId || '';
                document.getElementById('fbAppId').value = firebaseConfig.appId || '';
                document.getElementById('fbMeasurementId').value = firebaseConfig.measurementId || '';
                
                showToast('‚úÖ Configuraci√≥n cargada desde firebase-config.js', 'success');
            } else {
                showToast('‚ö†Ô∏è No se pudo cargar la configuraci√≥n. Aseg√∫rese de que firebase-config.js est√© incluido.', 'warning');
            }
        }
        
        function saveFirebaseConfig(event) {
            event.preventDefault();
            
            const newConfig = {
                apiKey: document.getElementById('fbApiKey').value.trim(),
                authDomain: document.getElementById('fbAuthDomain').value.trim(),
                databaseURL: document.getElementById('fbDatabaseURL').value.trim(),
                projectId: document.getElementById('fbProjectId').value.trim(),
                storageBucket: document.getElementById('fbStorageBucket').value.trim(),
                messagingSenderId: document.getElementById('fbMessagingSenderId').value.trim(),
                appId: document.getElementById('fbAppId').value.trim(),
                measurementId: document.getElementById('fbMeasurementId').value.trim()
            };
            
            // Validate required fields
            if (!newConfig.apiKey || !newConfig.authDomain || !newConfig.projectId || !newConfig.appId) {
                showToast('‚ö†Ô∏è Complete todos los campos requeridos', 'error');
                return;
            }
            
            // Generate the new firebase-config.js content
            const configContent = `/**
 * FIREBASE CONFIGURATION
 * Your Firebase project configuration for cloud sync
 * 
 * IMPORTANT: Keep this file private - don't share it publicly
 */

const firebaseConfig = {
  apiKey: "${newConfig.apiKey}",
  authDomain: "${newConfig.authDomain}",
  databaseURL: "${newConfig.databaseURL}",
  projectId: "${newConfig.projectId}",
  storageBucket: "${newConfig.storageBucket}",
  messagingSenderId: "${newConfig.messagingSenderId}",
  appId: "${newConfig.appId}",
  measurementId: "${newConfig.measurementId}"
};

// Auto-initialize cloud sync if enabled
document.addEventListener('DOMContentLoaded', async function() {
  const syncEnabled = localStorage.getItem('cloudSync_enabled') === 'true';
  
  if (syncEnabled && typeof cloudSync !== 'undefined') {
    console.log('Auto-initializing cloud sync...');
    try {
      await cloudSync.initialize(firebaseConfig);
      console.log('Cloud sync initialized successfully');
      
      // Update UI if it exists
      if (typeof updateSyncStatus === 'function') {
        updateSyncStatus();
      }
    } catch (error) {
      console.error('Error initializing cloud sync:', error);
    }
  }
});
`;
            
            // Show instructions to save the file manually
            const statusDiv = document.getElementById('firebaseConfigStatus');
            statusDiv.style.display = 'block';
            statusDiv.style.background = '#e3f2fd';
            statusDiv.style.borderLeft = '4px solid #2196f3';
            statusDiv.innerHTML = `
                <strong>üìù Instrucciones para guardar:</strong>
                <ol style="margin: 0.5rem 0 0.5rem 1.5rem; font-size: 0.9rem;">
                    <li>Copie el c√≥digo generado abajo</li>
                    <li>Abra el archivo <code>firebase-config.js</code> en su editor</li>
                    <li>Reemplace todo el contenido con el nuevo c√≥digo</li>
                    <li>Guarde el archivo</li>
                    <li>Recargue esta p√°gina</li>
                </ol>
                <div style="margin-top: 1rem;">
                    <button class="btn btn-secondary" onclick="copyFirebaseConfig()" style="font-size: 0.9rem;">
                        üìã Copiar C√≥digo
                    </button>
                </div>
                <textarea id="generatedConfigCode" readonly style="width: 100%; height: 300px; margin-top: 1rem; font-family: monospace; font-size: 0.85rem; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">${configContent}</textarea>
            `;
            
            showToast('‚úÖ Configuraci√≥n generada. Siga las instrucciones para guardarla.', 'success');
        }
        
        function copyFirebaseConfig() {
            const textarea = document.getElementById('generatedConfigCode');
            textarea.select();
            document.execCommand('copy');
            showToast('üìã C√≥digo copiado al portapapeles', 'success');
        }
        
        async function testFirebaseConnection() {
            const statusDiv = document.getElementById('firebaseConfigStatus');
            statusDiv.style.display = 'block';
            statusDiv.style.background = '#fff3e0';
            statusDiv.innerHTML = '<div style="text-align: center;">üîÑ Probando conexi√≥n...</div>';
            
            try {
                // Check if Firebase config is loaded
                if (typeof firebaseConfig === 'undefined') {
                    throw new Error('Configuraci√≥n de Firebase no encontrada');
                }
                
                // Check if cloud-sync.js is loaded
                if (typeof cloudSync === 'undefined') {
                    throw new Error('M√≥dulo cloud-sync.js no cargado');
                }
                
                // Try to initialize (this will validate the config)
                await cloudSync.initialize(firebaseConfig);
                
                statusDiv.style.background = '#e8f5e9';
                statusDiv.style.borderLeft = '4px solid #4caf50';
                statusDiv.innerHTML = `
                    <strong style="color: #2e7d32;">‚úÖ Conexi√≥n Exitosa</strong>
                    <ul style="margin: 0.5rem 0 0 1.5rem; font-size: 0.9rem;">
                        <li>Firebase inicializado correctamente</li>
                        <li>Proyecto: ${firebaseConfig.projectId}</li>
                        <li>Base de datos: Conectada</li>
                        <li>Autenticaci√≥n: Disponible</li>
                    </ul>
                `;
                
                showToast('‚úÖ Firebase conectado exitosamente', 'success');
                
            } catch (error) {
                console.error('Firebase connection test failed:', error);
                statusDiv.style.background = '#ffebee';
                statusDiv.style.borderLeft = '4px solid #f44336';
                statusDiv.innerHTML = `
                    <strong style="color: #c62828;">‚ùå Error de Conexi√≥n</strong>
                    <p style="margin: 0.5rem 0; font-size: 0.9rem;">${error.message}</p>
                    <ul style="margin: 0.5rem 0 0 1.5rem; font-size: 0.85rem;">
                        <li>Verifique que todos los campos est√©n correctos</li>
                        <li>Aseg√∫rese de que el proyecto Firebase est√© activo</li>
                        <li>Revise las reglas de seguridad en Firebase Console</li>
                        <li>Verifique su conexi√≥n a internet</li>
                    </ul>
                `;
                
                showToast('‚ùå Error al conectar con Firebase', 'error');
            }
        }
        
        // ==================== BACKUP & RESTORE FUNCTIONS ====================
        
        function backupAllData() {
            try {
                showToast('üì¶ Preparando respaldo completo...', 'info');
                
                // Collect ALL data from all ranches
                const fullBackup = {
                    version: '1.0',
                    backupDate: new Date().toISOString(),
                    appName: 'Ganado Finca - Sistema de Gesti√≥n',
                    ranches: {}
                };
                
                // Backup each ranch
                Object.keys(RANCHES).forEach(ranchId => {
                    const ranch = RANCHES[ranchId];
                    const ranchData = localStorage.getItem(ranch.storageKey);
                    if (ranchData) {
                        fullBackup.ranches[ranchId] = {
                            name: ranch.name,
                            data: JSON.parse(ranchData)
                        };
                    }
                });
                
                // Backup animal photos
                Object.keys(RANCHES).forEach(ranchId => {
                    const photosKey = 'animalPhotos_' + ranchId;
                    const photos = localStorage.getItem(photosKey);
                    if (photos) {
                        if (!fullBackup.ranches[ranchId]) {
                            fullBackup.ranches[ranchId] = { name: RANCHES[ranchId].name, data: {} };
                        }
                        fullBackup.ranches[ranchId].animalPhotos = JSON.parse(photos);
                    }
                });
                
                // Backup API keys (optional - user may want to exclude for security)
                const includeApiKeys = confirm('¬øIncluir API Keys de IA en el respaldo?\n\n(Recomendado: NO si compartir√° el archivo)');
                if (includeApiKeys) {
                    fullBackup.apiKeys = {
                        google: localStorage.getItem('googleApiKey'),
                        anthropic: localStorage.getItem('anthropicApiKey'),
                        provider: localStorage.getItem('aiProvider')
                    };
                }
                
                // Backup last selected ranch
                fullBackup.lastRanch = localStorage.getItem('ganadoFinca_lastRanch');
                
                // Calculate backup size
                const backupJson = JSON.stringify(fullBackup, null, 2);
                const backupSizeKB = (new Blob([backupJson]).size / 1024).toFixed(2);
                
                // Generate filename with timestamp
                const now = new Date();
                const filename = `GanadoFinca_Backup_${now.getFullYear()}-${(now.getMonth()+1).toString().padStart(2,'0')}-${now.getDate().toString().padStart(2,'0')}_${now.getHours()}${now.getMinutes()}.json`;
                
                // Create and download backup file
                const blob = new Blob([backupJson], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                a.click();
                URL.revokeObjectURL(url);
                
                // Count totals
                let totalAnimals = 0;
                let totalSalidas = 0;
                let totalSalud = 0;
                Object.values(fullBackup.ranches).forEach(ranch => {
                    if (ranch.data.entradas) totalAnimals += ranch.data.entradas.length;
                    if (ranch.data.salidas) totalSalidas += ranch.data.salidas.length;
                    if (ranch.data.saludEventos) totalSalud += ranch.data.saludEventos.length;
                });
                
                showToast(`‚úÖ Respaldo completado: ${filename}\nüìä ${totalAnimals} entradas, ${totalSalidas} salidas, ${totalSalud} registros de salud\nüíæ Tama√±o: ${backupSizeKB} KB`, 'success');
                
                // Show reminder to save to cloud
                setTimeout(() => {
                    if (confirm('üí° IMPORTANTE: Guarde este archivo en la nube (Google Drive, Dropbox, etc.) para mayor seguridad.\n\n¬øDesea ver informaci√≥n sobre c√≥mo hacerlo?')) {
                        alert('üì± RECOMENDACIONES DE RESPALDO:\n\n1. Guarde el archivo en Google Drive o Dropbox\n2. Mantenga m√∫ltiples versiones (semanal/mensual)\n3. Respalde despu√©s de eventos importantes\n4. Pruebe restaurar el respaldo peri√≥dicamente\n5. Considere guardar en m√∫ltiples ubicaciones\n\nüíæ El archivo est√° en su carpeta de Descargas');
                    }
                }, 1000);
                
            } catch (error) {
                console.error('Error creating backup:', error);
                showToast('‚ùå Error al crear respaldo: ' + error.message, 'error');
            }
        }
        
        function restoreFromBackup() {
            if (!confirm('‚ö†Ô∏è ADVERTENCIA: Restaurar un respaldo reemplazar√° TODOS los datos actuales.\n\n¬øEst√° seguro de continuar?')) {
                return;
            }

            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';

            input.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;

                showToast('üì• Restaurando respaldo...', 'info');

                const reader = new FileReader();
                reader.onload = function(event) {
                    try {
                        const backup = JSON.parse(event.target.result);

                        // Validate backup structure
                        if (!backup.version || !backup.ranches) {
                            throw new Error('Archivo de respaldo inv√°lido o corrupto');
                        }

                        // Map backup keys to app keys (handles different naming conventions)
                        const backupKeyMapping = {
                            'la_coruna': 'la_coruna',
                            'LaCoruna': 'la_coruna',
                            'catalina': 'santa_catalina',
                            'santa_catalina': 'santa_catalina',
                            'Catalina': 'santa_catalina',
                            'SantaCatalina': 'santa_catalina',
                            'la_vega': 'la_vega',
                            'LaVega': 'la_vega'
                        };

                        // Confirm restoration with details
                        const ranchCount = Object.keys(backup.ranches).length;
                        let totalEntradas = 0;
                        let totalSalidas = 0;
                        Object.values(backup.ranches).forEach(ranch => {
                            if (ranch.data.entradas) totalEntradas += ranch.data.entradas.length;
                            if (ranch.data.salidas) totalSalidas += ranch.data.salidas.length;
                        });

                        if (!confirm(`üìä RESUMEN DEL RESPALDO:\n\n` +
                            `Fecha: ${formatDate(backup.backupDate)}\n` +
                            `Fincas: ${ranchCount}\n` +
                            `Entradas: ${totalEntradas}\n` +
                            `Salidas: ${totalSalidas}\n\n` +
                            `¬øConfirmar restauraci√≥n?`)) {
                            return;
                        }

                        // Restore ranch data
                        Object.keys(backup.ranches).forEach(backupRanchId => {
                            // Map backup key to app key
                            const appRanchId = backupKeyMapping[backupRanchId] || backupRanchId;
                            const ranch = RANCHES[appRanchId];
                            if (ranch) {
                                const ranchBackup = backup.ranches[backupRanchId];
                                localStorage.setItem(ranch.storageKey, JSON.stringify(ranchBackup.data));
                                console.log(`Restored ${backupRanchId} -> ${ranch.storageKey}`);

                                // Restore animal photos if present
                                if (ranchBackup.animalPhotos) {
                                    const photosKey = 'animalPhotos_' + appRanchId;
                                    localStorage.setItem(photosKey, JSON.stringify(ranchBackup.animalPhotos));
                                }
                            } else {
                                console.warn(`Ranch not found for backup key: ${backupRanchId}, mapped to: ${appRanchId}`);
                            }
                        });
                        
                        // Restore API keys if present and user wants them
                        if (backup.apiKeys) {
                            if (confirm('¬øRestaurar tambi√©n las API Keys de IA guardadas?')) {
                                if (backup.apiKeys.google) localStorage.setItem('googleApiKey', backup.apiKeys.google);
                                if (backup.apiKeys.anthropic) localStorage.setItem('anthropicApiKey', backup.apiKeys.anthropic);
                                if (backup.apiKeys.provider) localStorage.setItem('aiProvider', backup.apiKeys.provider);
                            }
                        }
                        
                        // Restore last ranch selection
                        if (backup.lastRanch) {
                            localStorage.setItem('ganadoFinca_lastRanch', backup.lastRanch);
                        }
                        
                        showToast('‚úÖ Respaldo restaurado exitosamente', 'success');

                        // FORCE SYNC TO CLOUD after restore
                        if (typeof cloudSync !== 'undefined' && cloudSync.enabled) {
                            showToast('‚òÅÔ∏è Subiendo datos a la nube...', 'info');
                            cloudSync.syncToCloud().then(() => {
                                showToast('‚úÖ Datos sincronizados con la nube', 'success');
                                setTimeout(() => location.reload(), 1500);
                            }).catch(err => {
                                console.error('Sync error:', err);
                                setTimeout(() => location.reload(), 1500);
                            });
                        } else {
                            // Reload page to apply changes
                            setTimeout(() => {
                                location.reload();
                            }, 1500);
                        }
                        
                    } catch (error) {
                        console.error('Error restoring backup:', error);
                        showToast('‚ùå Error al restaurar: ' + error.message, 'error');
                    }
                };
                
                reader.onerror = function() {
                    showToast('‚ùå Error al leer el archivo de respaldo', 'error');
                };
                
                reader.readAsText(file);
            };
            
            input.click();
        }
        
        function showBackupInfo() {
            // Calculate current data size
            let totalSize = 0;
            let totalEntradas = 0;
            let totalSalidas = 0;
            let totalSalud = 0;
            let totalPotreros = 0;
            let totalFotos = 0;
            
            Object.keys(RANCHES).forEach(ranchId => {
                const ranch = RANCHES[ranchId];
                const ranchData = localStorage.getItem(ranch.storageKey);
                if (ranchData) {
                    totalSize += ranchData.length;
                    const data = JSON.parse(ranchData);
                    if (data.entradas) totalEntradas += data.entradas.length;
                    if (data.salidas) totalSalidas += data.salidas.length;
                    if (data.saludEventos) totalSalud += data.saludEventos.length;
                    if (data.potreros) totalPotreros += data.potreros.length;
                    if (data.fotoSesiones) totalFotos += data.fotoSesiones.length;
                }
            });
            
            const sizeKB = (totalSize / 1024).toFixed(2);
            const sizeMB = (totalSize / 1024 / 1024).toFixed(2);
            
            // Check last backup (we can't really know, but we can estimate)
            const lastBackupDate = localStorage.getItem('lastBackupDate');
            const lastBackupText = lastBackupDate ? 
                `√öltimo respaldo: ${formatDate(lastBackupDate)}\n` : 
                'No hay registro de respaldos previos\n';
            
            alert(`üìä INFORMACI√ìN DE RESPALDO\n\n` +
                `${lastBackupText}\n` +
                `üìà DATOS ACTUALES:\n` +
                `‚Ä¢ Fincas: ${Object.keys(RANCHES).length}\n` +
                `‚Ä¢ Entradas totales: ${totalEntradas}\n` +
                `‚Ä¢ Salidas totales: ${totalSalidas}\n` +
                `‚Ä¢ Registros de salud: ${totalSalud}\n` +
                `‚Ä¢ Potreros: ${totalPotreros}\n` +
                `‚Ä¢ Sesiones de fotos: ${totalFotos}\n\n` +
                `üíæ Tama√±o estimado: ${sizeKB} KB (${sizeMB} MB)\n\n` +
                `‚ö†Ô∏è IMPORTANTE:\n` +
                `Los datos est√°n en el navegador y pueden perderse si:\n` +
                `‚Ä¢ Se borra el cach√©\n` +
                `‚Ä¢ Se desinstala el navegador\n` +
                `‚Ä¢ Se cambia de dispositivo\n` +
                `‚Ä¢ Hay problemas t√©cnicos\n\n` +
                `üí° Respalde semanalmente o despu√©s de cambios importantes`);
            
            // Update last backup check date
            localStorage.setItem('lastBackupDate', new Date().toISOString());
        }
        
        // ==================== UTILITIES ====================
        function formatCurrency(value) {
            return '$' + Math.round(value).toLocaleString('es-CO');
        }
        
        function formatNumber(value) {
            return Math.round(value).toLocaleString('es-CO');
        }
        
        function formatDate(dateStr) {
            if (!dateStr) return '-';
            const date = new Date(dateStr);
            return date.toLocaleDateString('es-CO');
        }
        
        // ==================== VOICE DICTATION MODULE ====================

        // Speech Recognition setup
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition = null;
        let isListening = false;
        let pendingDictations = []; // Array of dictated animals pending photo/save
        let currentDictationContext = null; // 'photos', 'profile', 'weight'

        function initSpeechRecognition() {
            if (!SpeechRecognition) {
                console.warn('Speech Recognition not supported in this browser');
                return false;
            }

            recognition = new SpeechRecognition();
            recognition.lang = 'es-CO'; // Colombian Spanish
            recognition.continuous = false;
            recognition.interimResults = true;
            recognition.maxAlternatives = 1;

            recognition.onstart = function() {
                isListening = true;
                updateVoiceUI(true);
                console.log('üé§ Voice recognition started');
            };

            recognition.onend = function() {
                isListening = false;
                updateVoiceUI(false);
                console.log('üé§ Voice recognition ended');
            };

            recognition.onerror = function(event) {
                console.error('Speech recognition error:', event.error);
                isListening = false;
                updateVoiceUI(false);

                if (event.error === 'not-allowed') {
                    showToast('‚ö†Ô∏è Permiso de micr√≥fono denegado. Habil√≠telo en configuraci√≥n del navegador.', 'error');
                } else if (event.error === 'no-speech') {
                    showToast('üé§ No se detect√≥ voz. Intente de nuevo.', 'warning');
                } else {
                    showToast('‚ö†Ô∏è Error de reconocimiento de voz: ' + event.error, 'error');
                }
            };

            recognition.onresult = function(event) {
                let finalTranscript = '';
                let interimTranscript = '';

                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const transcript = event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        finalTranscript += transcript;
                    } else {
                        interimTranscript += transcript;
                    }
                }

                // Update live preview
                const previewEl = document.getElementById('voiceTranscriptPreview');
                if (previewEl) {
                    previewEl.textContent = finalTranscript || interimTranscript || 'Escuchando...';
                }

                // Process final transcript
                if (finalTranscript) {
                    processVoiceDictation(finalTranscript);
                }
            };

            return true;
        }

        function updateVoiceUI(listening) {
            const voiceBtn = document.getElementById('voiceDictationBtn');
            const statusEl = document.getElementById('voiceStatus');

            if (voiceBtn) {
                if (listening) {
                    voiceBtn.innerHTML = '<span class="pulse-mic">üé§</span> Escuchando...';
                    voiceBtn.style.background = '#ef4444';
                    voiceBtn.classList.add('recording');
                } else {
                    voiceBtn.innerHTML = 'üé§ Dictar Animal';
                    voiceBtn.style.background = '';
                    voiceBtn.classList.remove('recording');
                }
            }

            if (statusEl) {
                statusEl.style.display = listening ? 'block' : 'none';
            }
        }

        function startVoiceDictation(context = 'photos') {
            if (!SpeechRecognition) {
                showToast('‚ö†Ô∏è Tu navegador no soporta reconocimiento de voz. Usa Chrome o Safari.', 'error');
                return;
            }

            if (!recognition) {
                initSpeechRecognition();
            }

            currentDictationContext = context;

            if (isListening) {
                recognition.stop();
            } else {
                try {
                    recognition.start();
                    showToast('üé§ Hable ahora: "Animal 1207, peso 300 kilos, buenas condiciones..."', 'info');
                } catch (error) {
                    console.error('Error starting recognition:', error);
                    showToast('‚ö†Ô∏è Error al iniciar micr√≥fono', 'error');
                }
            }
        }

        function stopVoiceDictation() {
            if (recognition && isListening) {
                recognition.stop();
            }
        }

        // Parse Spanish voice input to extract animal data
        function parseVoiceDictation(text) {
            const result = {
                chapeta: null,
                peso: null,
                condicion: null,
                observaciones: text // Store original text as observations
            };

            const lowerText = text.toLowerCase();

            // Extract chapeta/animal number
            // Patterns: "animal 1207", "numero 1207", "chapeta 1207", "el 1207"
            const chapetaPatterns = [
                /(?:animal|numero|n√∫mero|chapeta|el)\s*(\d+)/i,
                /(\d{3,4})\s*(?:tiene|pesa|esta|est√°)/i,
                /^(\d{3,4})\b/i
            ];

            for (const pattern of chapetaPatterns) {
                const match = text.match(pattern);
                if (match) {
                    result.chapeta = match[1];
                    break;
                }
            }

            // Extract weight
            // Patterns: "peso 300", "pesa 300", "300 kilos", "300 kg", "aproximado 300"
            const pesoPatterns = [
                /(?:peso|pesa|aproximado|aproximadamente)\s*(?:de\s*)?(\d+)\s*(?:kilos?|kg|kilogramos?)?/i,
                /(\d+)\s*(?:kilos?|kg|kilogramos?)/i,
                /(?:unos?|como)\s*(\d+)\s*(?:kilos?|kg)?/i
            ];

            for (const pattern of pesoPatterns) {
                const match = text.match(pattern);
                if (match) {
                    result.peso = parseInt(match[1]);
                    break;
                }
            }

            // Extract condition keywords
            const conditionKeywords = {
                'buenas condiciones': 'Buenas condiciones',
                'buena condici√≥n': 'Buenas condiciones',
                'buen estado': 'Buen estado',
                'excelente': 'Excelente',
                'muy bien': 'Muy bien',
                'bien': 'Bien',
                'normal': 'Normal',
                'regular': 'Regular',
                'mal estado': 'Mal estado',
                'malas condiciones': 'Malas condiciones',
                'mala condici√≥n': 'Malas condiciones',
                'flaco': 'Flaco',
                'flaca': 'Flaco',
                'delgado': 'Delgado',
                'delgada': 'Delgado',
                'gordo': 'Gordo',
                'gorda': 'Gordo',
                'lleno': 'Gordo',
                'llena': 'Gordo',
                'enfermo': 'Enfermo',
                'enferma': 'Enfermo',
                'sano': 'Sano',
                'sana': 'Sano',
                'saludable': 'Saludable',
                'cojo': 'Cojo',
                'coja': 'Cojo',
                'rengo': 'Rengo',
                'renga': 'Rengo',
                'buen progreso': 'Buen progreso',
                'mal progreso': 'Mal progreso',
                'recuper√°ndose': 'Recuper√°ndose',
                'mejorando': 'Mejorando',
                'pre√±ada': 'Pre√±ada',
                'parida': 'Parida',
                'lactando': 'Lactando',
                'en celo': 'En celo'
            };

            for (const [keyword, value] of Object.entries(conditionKeywords)) {
                if (lowerText.includes(keyword)) {
                    result.condicion = value;
                    break;
                }
            }

            // If no specific condition found, try to extract general observation
            if (!result.condicion) {
                const condicionMatch = text.match(/(?:condici[o√≥]n|estado)\s*(?:es\s*)?(.+?)(?:\.|,|$)/i);
                if (condicionMatch) {
                    result.condicion = condicionMatch[1].trim();
                }
            }

            return result;
        }

        function processVoiceDictation(transcript) {
            console.log('üìù Processing dictation:', transcript);

            const parsed = parseVoiceDictation(transcript);
            console.log('üìã Parsed result:', parsed);

            if (currentDictationContext === 'photos') {
                // Add to pending dictations for photos
                addPendingDictation(parsed, transcript);
            } else if (currentDictationContext === 'weight') {
                // Fill weight update form
                fillWeightUpdateFromVoice(parsed);
            } else if (currentDictationContext === 'profile') {
                // Update animal profile
                fillProfileFromVoice(parsed);
            }
        }

        function addPendingDictation(parsed, originalText) {
            const dictation = {
                id: Date.now(),
                chapeta: parsed.chapeta || '',
                peso: parsed.peso || '',
                condicion: parsed.condicion || '',
                observaciones: originalText,
                hasPhoto: false,
                photoData: null,
                timestamp: new Date().toISOString()
            };

            pendingDictations.push(dictation);
            updatePendingDictationsUI();

            if (parsed.chapeta) {
                showToast(`‚úÖ Animal ${parsed.chapeta} agregado. Puede tomar la foto.`, 'success');
            } else {
                showToast('‚ö†Ô∏è No se detect√≥ n√∫mero de animal. Edite manualmente.', 'warning');
            }
        }

        function updatePendingDictationsUI() {
            const container = document.getElementById('pendingDictationsContainer');
            const actionsDiv = document.getElementById('dictationActions');
            if (!container) return;

            if (pendingDictations.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; color: #999; padding: 0.5rem; font-size: 0.8rem;">
                        üé§ Use AI Voice para dictar informaci√≥n del animal
                    </div>
                `;
                if (actionsDiv) actionsDiv.style.display = 'none';
                return;
            }

            // Show actions when there are dictations
            if (actionsDiv) actionsDiv.style.display = 'flex';

            // Compact card layout for mobile
            container.innerHTML = pendingDictations.map((d, index) => `
                <div style="background: white; border-radius: 8px; padding: 0.6rem; margin-bottom: 0.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border-left: 3px solid ${d.hasPhoto ? '#10b981' : '#f59e0b'};">
                    <div style="display: flex; gap: 0.5rem; align-items: center; margin-bottom: 0.4rem;">
                        <span style="font-size: 0.9rem;">${d.hasPhoto ? '‚úÖ' : 'üìù'}</span>
                        <input type="text" value="${d.chapeta}" placeholder="#" onchange="updatePendingDictation(${d.id}, 'chapeta', this.value)"
                               style="width: 60px; font-size: 0.9rem; font-weight: bold; border: 1px solid #ddd; border-radius: 4px; padding: 3px 6px;">
                        <input type="number" value="${d.peso}" placeholder="kg" onchange="updatePendingDictation(${d.id}, 'peso', this.value)"
                               style="width: 55px; font-size: 0.85rem; border: 1px solid #ddd; border-radius: 4px; padding: 3px 6px;">
                        <select onchange="updatePendingDictation(${d.id}, 'condicion', this.value)"
                                style="flex: 1; font-size: 0.75rem; border: 1px solid #ddd; border-radius: 4px; padding: 3px; min-width: 0;">
                            <option value="" ${!d.condicion ? 'selected' : ''}>Condici√≥n</option>
                            <option value="Excelente" ${d.condicion === 'Excelente' ? 'selected' : ''}>Excelente</option>
                            <option value="Buenas condiciones" ${d.condicion === 'Buenas condiciones' ? 'selected' : ''}>Buena</option>
                            <option value="Regular" ${d.condicion === 'Regular' ? 'selected' : ''}>Regular</option>
                            <option value="Flaco" ${d.condicion === 'Flaco' ? 'selected' : ''}>Flaco</option>
                            <option value="Enfermo" ${d.condicion === 'Enfermo' ? 'selected' : ''}>Enfermo</option>
                        </select>
                        <button onclick="removePendingDictation(${d.id})" style="background: none; border: none; font-size: 1rem; cursor: pointer; color: #ef4444; padding: 0;">‚úï</button>
                    </div>
                    <div style="display: flex; gap: 0.4rem; align-items: center;">
                        ${d.hasPhoto ? `
                            <img src="${d.photoData}" style="width: 40px; height: 40px; object-fit: cover; border-radius: 4px; border: 1px solid #10b981;">
                        ` : `
                            <button onclick="takePendingPhoto(${d.id})" style="background: #0ea5e9; color: white; border: none; border-radius: 4px; padding: 0.3rem 0.6rem; font-size: 0.75rem; cursor: pointer;">
                                üì∏ Foto
                            </button>
                        `}
                        ${d.audioUrl ? `
                            <audio src="${d.audioUrl}" controls style="height: 28px; flex: 1;"></audio>
                        ` : `
                            <input type="text" value="${d.observaciones}" placeholder="Notas..." onchange="updatePendingDictation(${d.id}, 'observaciones', this.value)"
                                   style="flex: 1; font-size: 0.75rem; border: 1px solid #ddd; border-radius: 4px; padding: 3px 6px; color: #666;">
                        `}
                    </div>
                </div>
            `).join('');

            // Update save button text
            const saveAllBtn = document.getElementById('saveAllDictationsBtn');
            if (saveAllBtn) {
                const readyCount = pendingDictations.filter(d => d.chapeta && d.hasPhoto).length;
                saveAllBtn.innerHTML = `üíæ Guardar (${readyCount})`;
                saveAllBtn.disabled = readyCount === 0;
                saveAllBtn.style.opacity = readyCount === 0 ? '0.5' : '1';
            }
        }

        function updatePendingDictation(id, field, value) {
            const dictation = pendingDictations.find(d => d.id === id);
            if (dictation) {
                dictation[field] = value;
            }
        }

        function removePendingDictation(id) {
            pendingDictations = pendingDictations.filter(d => d.id !== id);
            updatePendingDictationsUI();
        }

        function clearAllPendingDictations() {
            if (pendingDictations.length === 0) return;
            if (confirm('¬øEst√° seguro de borrar todas las dictaciones pendientes?')) {
                pendingDictations = [];
                updatePendingDictationsUI();
                showToast('üóëÔ∏è Dictaciones borradas', 'info');
            }
        }

        function takePendingPhoto(id) {
            const dictation = pendingDictations.find(d => d.id === id);
            if (!dictation) return;

            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.capture = 'environment'; // Use back camera

            input.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;

                compressImage(file, function(dataUrl) {
                    dictation.photoData = dataUrl;
                    dictation.hasPhoto = true;
                    updatePendingDictationsUI();
                    showToast('üì∏ Foto capturada', 'success');
                });
            };

            input.click();
        }

        function saveAllPendingDictations() {
            const readyDictations = pendingDictations.filter(d => d.chapeta && d.hasPhoto);

            if (readyDictations.length === 0) {
                showToast('‚ö†Ô∏è No hay dictaciones completas para guardar', 'warning');
                return;
            }

            let savedCount = 0;
            let errorCount = 0;

            readyDictations.forEach(d => {
                try {
                    // Save photo
                    if (!animalPhotos[d.chapeta]) {
                        animalPhotos[d.chapeta] = {};
                    }
                    animalPhotos[d.chapeta].photo = d.photoData;
                    animalPhotos[d.chapeta].dateAdded = d.timestamp;

                    // Update animal data with condition and weight if animal exists
                    const animal = data.entradas.find(e => e.numero == d.chapeta);
                    if (animal) {
                        // Add condicion general to animal
                        animal.condicionGeneral = d.condicion;

                        // If peso was dictated and different from current, add weight update
                        if (d.peso && d.peso !== animal.peso) {
                            const lastUpdate = data.pesoUpdates
                                .filter(u => u.numero == d.chapeta)
                                .sort((a, b) => new Date(b.fecha) - new Date(a.fecha))[0];

                            const pesoAnterior = lastUpdate ? lastUpdate.pesoNuevo : animal.peso;

                            if (d.peso !== pesoAnterior) {
                                const diasDesdeUltimo = lastUpdate
                                    ? Math.max(1, Math.floor((new Date() - new Date(lastUpdate.fecha)) / (1000 * 60 * 60 * 24)))
                                    : getDiasEnFinca(animal.fechaEntrada);

                                const ganancia = d.peso - pesoAnterior;
                                const gdpReal = diasDesdeUltimo > 0 ? (ganancia / diasDesdeUltimo).toFixed(2) : 0;

                                data.pesoUpdates.push({
                                    id: Date.now() + Math.random(),
                                    numero: d.chapeta,
                                    fecha: new Date().toISOString().split('T')[0],
                                    pesoAnterior: pesoAnterior,
                                    pesoNuevo: d.peso,
                                    ganancia: ganancia,
                                    dias: diasDesdeUltimo,
                                    gdpReal: parseFloat(gdpReal),
                                    observaciones: d.observaciones || 'Actualizado por dictado de voz'
                                });
                            }
                        }
                    }

                    savedCount++;
                } catch (error) {
                    console.error('Error saving dictation for', d.chapeta, error);
                    errorCount++;
                }
            });

            // Save all data
            saveAnimalPhotos();
            saveData();

            // Remove saved dictations from pending
            const savedIds = readyDictations.map(d => d.id);
            pendingDictations = pendingDictations.filter(d => !savedIds.includes(d.id));
            updatePendingDictationsUI();

            // Update views
            updateAllViews();

            if (errorCount > 0) {
                showToast(`‚úÖ ${savedCount} guardados, ‚ö†Ô∏è ${errorCount} errores`, 'warning');
            } else {
                showToast(`‚úÖ ${savedCount} animal(es) guardados exitosamente`, 'success');
            }

            // Trigger cloud sync
            if (typeof cloudSync !== 'undefined' && cloudSync.enabled) {
                cloudSync.triggerAutoSync();
            }
        }

        // ==================== PROGRESO SECTION DICTATION ====================
        let pendingProgresoDictations = [];

        function startProgressoDictation() {
            if (!SpeechRecognition) {
                showToast('‚ö†Ô∏è Tu navegador no soporta reconocimiento de voz. Usa Chrome o Safari.', 'error');
                return;
            }

            if (!recognition) {
                initSpeechRecognition();
            }

            currentDictationContext = 'progreso';

            // Show status
            const statusEl = document.getElementById('progresoVoiceStatus');
            const transcriptEl = document.getElementById('progresoVoiceTranscript');
            if (statusEl) statusEl.style.display = 'block';
            if (transcriptEl) transcriptEl.textContent = 'Escuchando...';

            recognition.onresult = function(event) {
                let finalTranscript = '';
                let interimTranscript = '';

                for (let i = event.resultIndex; i < event.results.length; i++) {
                    if (event.results[i].isFinal) {
                        finalTranscript += event.results[i][0].transcript;
                    } else {
                        interimTranscript += event.results[i][0].transcript;
                    }
                }

                if (transcriptEl) {
                    transcriptEl.textContent = finalTranscript || interimTranscript || 'Escuchando...';
                }

                if (finalTranscript) {
                    processProgressoDictation(finalTranscript);
                }
            };

            recognition.onend = function() {
                if (statusEl) statusEl.style.display = 'none';
            };

            recognition.onerror = function(event) {
                console.error('Speech recognition error:', event.error);
                if (statusEl) statusEl.style.display = 'none';
                if (event.error === 'not-allowed') {
                    showToast('‚ö†Ô∏è Permiso de micr√≥fono denegado', 'error');
                }
            };

            try {
                recognition.start();
                showToast('üé§ Escuchando... Diga: "Animal [n√∫mero], peso [kilos], [condici√≥n]"', 'info');
            } catch (e) {
                console.error('Error starting recognition:', e);
            }
        }

        function processProgressoDictation(transcript) {
            console.log('üìù Processing progreso dictation:', transcript);

            const parsed = parseVoiceDictation(transcript);
            console.log('üìã Parsed result:', parsed);

            // Add to pending progreso dictations
            const dictation = {
                id: Date.now(),
                chapeta: parsed.chapeta || '',
                peso: parsed.peso || '',
                condicion: parsed.condicion || '',
                observaciones: transcript,
                timestamp: new Date().toISOString()
            };

            pendingProgresoDictations.push(dictation);
            updateProgresoDictationsUI();

            showToast('‚úÖ Dictaci√≥n agregada. Puede continuar dictando o guardar.', 'success');
        }

        function updateProgresoDictationsUI() {
            const container = document.getElementById('progresoDictationsContainer');
            const section = document.getElementById('pendingProgresoDictations');

            if (!container || !section) return;

            if (pendingProgresoDictations.length === 0) {
                section.style.display = 'none';
                return;
            }

            section.style.display = 'block';

            container.innerHTML = pendingProgresoDictations.map((d, index) => {
                // Find animal to show current info
                const animal = d.chapeta ? data.entradas.find(e => String(e.numero) === String(d.chapeta)) : null;
                const animalInfo = animal ? `<div style="font-size: 0.8rem; color: #666; margin-bottom: 0.5rem;">Peso actual: ${animal.peso}kg | Raza: ${animal.raza || 'N/A'}</div>` : '';

                return `
                <div style="background: white; border-radius: 12px; padding: 1rem; margin-bottom: 1rem; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-left: 4px solid ${d.chapeta && d.peso ? '#10b981' : '#f59e0b'};">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.75rem;">
                        <div style="font-weight: bold; font-size: 1.2rem;">
                            ${d.chapeta && d.peso ? '‚úÖ' : 'üìù'} Animal:
                            <input type="text" value="${d.chapeta}" onchange="updateProgresoDictation(${d.id}, 'chapeta', this.value)"
                                   style="width: 80px; font-size: 1.1rem; font-weight: bold; border: 1px solid #ddd; border-radius: 4px; padding: 4px 8px;">
                        </div>
                        <button onclick="removeProgresoDictation(${d.id})" style="background: none; border: none; font-size: 1.2rem; cursor: pointer; color: #ef4444;">‚úï</button>
                    </div>

                    ${animalInfo}

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; margin-bottom: 0.75rem;">
                        <div>
                            <label style="font-size: 0.8rem; color: #666;">Nuevo Peso (kg):</label>
                            <input type="number" value="${d.peso}" onchange="updateProgresoDictation(${d.id}, 'peso', this.value)"
                                   style="width: 100%; border: 1px solid #ddd; border-radius: 4px; padding: 6px;">
                        </div>
                        <div>
                            <label style="font-size: 0.8rem; color: #666;">Condici√≥n General:</label>
                            <select onchange="updateProgresoDictation(${d.id}, 'condicion', this.value)"
                                    style="width: 100%; border: 1px solid #ddd; border-radius: 4px; padding: 6px;">
                                <option value="" ${!d.condicion ? 'selected' : ''}>Seleccionar...</option>
                                <option value="Excelente" ${d.condicion === 'Excelente' ? 'selected' : ''}>Excelente</option>
                                <option value="Muy bien" ${d.condicion === 'Muy bien' ? 'selected' : ''}>Muy bien</option>
                                <option value="Buenas condiciones" ${d.condicion === 'Buenas condiciones' ? 'selected' : ''}>Buenas condiciones</option>
                                <option value="Regular" ${d.condicion === 'Regular' ? 'selected' : ''}>Regular</option>
                                <option value="Flaco" ${d.condicion === 'Flaco' ? 'selected' : ''}>Flaco</option>
                                <option value="Enfermo" ${d.condicion === 'Enfermo' ? 'selected' : ''}>Enfermo</option>
                                <option value="Recuper√°ndose" ${d.condicion === 'Recuper√°ndose' ? 'selected' : ''}>Recuper√°ndose</option>
                            </select>
                        </div>
                    </div>

                    <div>
                        <label style="font-size: 0.8rem; color: #666;">Observaciones:</label>
                        <textarea onchange="updateProgresoDictation(${d.id}, 'observaciones', this.value)"
                                  style="width: 100%; border: 1px solid #ddd; border-radius: 4px; padding: 6px; min-height: 50px; resize: vertical;">${d.observaciones}</textarea>
                    </div>
                </div>
            `}).join('');
        }

        function updateProgresoDictation(id, field, value) {
            const dictation = pendingProgresoDictations.find(d => d.id === id);
            if (dictation) {
                dictation[field] = value;
                updateProgresoDictationsUI();
            }
        }

        function removeProgresoDictation(id) {
            pendingProgresoDictations = pendingProgresoDictations.filter(d => d.id !== id);
            updateProgresoDictationsUI();
        }

        function clearProgresoDictations() {
            if (pendingProgresoDictations.length === 0) return;
            if (confirm('¬øEst√° seguro de borrar todas las dictaciones pendientes?')) {
                pendingProgresoDictations = [];
                updateProgresoDictationsUI();
                showToast('üóëÔ∏è Dictaciones borradas', 'info');
            }
        }

        function saveAllProgresoDictations() {
            const validDictations = pendingProgresoDictations.filter(d => d.chapeta && d.peso);

            if (validDictations.length === 0) {
                showToast('‚ö†Ô∏è No hay dictaciones completas para guardar (necesita chapeta y peso)', 'warning');
                return;
            }

            let savedCount = 0;
            let errorCount = 0;

            validDictations.forEach(d => {
                try {
                    const animal = data.entradas.find(e => String(e.numero) === String(d.chapeta));

                    if (!animal) {
                        console.warn(`Animal ${d.chapeta} not found`);
                        errorCount++;
                        return;
                    }

                    // Get previous weight
                    const animalUpdates = data.pesoUpdates ? data.pesoUpdates.filter(u => String(u.numero) === String(d.chapeta)).sort((a, b) => {
                        const dateCompare = new Date(b.fecha) - new Date(a.fecha);
                        if (dateCompare !== 0) return dateCompare;
                        return (b.id || 0) - (a.id || 0);
                    }) : [];
                    const lastUpdate = animalUpdates.length > 0 ? animalUpdates[0] : null;
                    const pesoAnterior = lastUpdate ? lastUpdate.pesoNuevo : animal.peso;

                    const pesoNuevo = parseFloat(d.peso);
                    const ganancia = pesoNuevo - pesoAnterior;

                    // Calculate days
                    const diasDesdeUltimo = lastUpdate
                        ? Math.max(1, Math.floor((new Date() - new Date(lastUpdate.fecha)) / (1000 * 60 * 60 * 24)))
                        : getDiasEnFinca(animal.fechaEntrada);

                    const gdpReal = diasDesdeUltimo > 0 ? (ganancia / diasDesdeUltimo).toFixed(2) : 0;

                    // Add weight update
                    data.pesoUpdates.push({
                        id: Date.now() + Math.random(),
                        numero: d.chapeta,
                        fecha: new Date().toISOString().split('T')[0],
                        pesoAnterior: pesoAnterior,
                        pesoNuevo: pesoNuevo,
                        ganancia: ganancia,
                        dias: diasDesdeUltimo,
                        gdpReal: parseFloat(gdpReal),
                        observaciones: d.observaciones || 'Actualizado por dictado de voz'
                    });

                    // Update animal condition if provided
                    if (d.condicion) {
                        animal.condicionGeneral = d.condicion;
                    }

                    savedCount++;
                } catch (error) {
                    console.error('Error saving dictation for', d.chapeta, error);
                    errorCount++;
                }
            });

            // Save data
            saveData();

            // Remove saved dictations
            const savedIds = validDictations.map(d => d.id);
            pendingProgresoDictations = pendingProgresoDictations.filter(d => !savedIds.includes(d.id));
            updateProgresoDictationsUI();

            // Update views
            updateAllViews();

            if (errorCount > 0) {
                showToast(`‚úÖ ${savedCount} guardados, ‚ö†Ô∏è ${errorCount} errores (animales no encontrados)`, 'warning');
            } else {
                showToast(`‚úÖ ${savedCount} actualizaci√≥n(es) de peso guardadas`, 'success');
            }

            // Trigger cloud sync
            if (typeof cloudSync !== 'undefined' && cloudSync.enabled) {
                cloudSync.triggerAutoSync();
            }
        }
        // ==================== END PROGRESO DICTATION ====================

        // ==================== PERFORMANCE ANALYTICS SYSTEM ====================
        let gdpDistributionChart = null;
        let gdpByRazaChart = null;
        let performanceData = { top: [], average: [], poor: [], all: [] };
        let currentTierTab = 'inventory'; // 'inventory' or 'sold'

        // GDP Thresholds
        const GDP_TOP_THRESHOLD = 0.40;
        const GDP_AVG_THRESHOLD = 0.25;
        const TARGET_WEIGHT = 450; // kg - target weight for sale

        function showTierTab(tab) {
            currentTierTab = tab;

            // Update button styles
            const invBtn = document.getElementById('tabTierInventory');
            const soldBtn = document.getElementById('tabTierSold');

            if (tab === 'inventory') {
                invBtn.className = 'btn';
                invBtn.style.background = '#10b981';
                invBtn.style.color = 'white';
                soldBtn.className = 'btn btn-secondary';
                soldBtn.style.background = '';
                soldBtn.style.color = '';
            } else {
                soldBtn.className = 'btn';
                soldBtn.style.background = '#10b981';
                soldBtn.style.color = 'white';
                invBtn.className = 'btn btn-secondary';
                invBtn.style.background = '';
                invBtn.style.color = '';
            }

            refreshPerformanceAnalytics();
        }

        function getTierDateRange() {
            const period = document.getElementById('tierPeriodSelect')?.value || 'all';
            const now = new Date();
            let startDate = new Date(2000, 0, 1);
            let endDate = new Date();

            if (period === '24months') {
                startDate = new Date(now.getFullYear() - 2, now.getMonth(), now.getDate());
            } else if (period === '12months') {
                startDate = new Date(now.getFullYear() - 1, now.getMonth(), now.getDate());
            }

            return { startDate, endDate };
        }

        function calculateAnimalGDP(numero) {
            const animal = data.entradas.find(e => String(e.numero) === String(numero));
            if (!animal) return null;

            // Get weight updates for this animal
            const updates = (data.pesoUpdates || [])
                .filter(u => String(u.numero) === String(numero))
                .sort((a, b) => new Date(a.fecha) - new Date(b.fecha));

            if (updates.length === 0) {
                // Calculate estimated GDP based on days in farm
                const diasEnFinca = getDiasEnFinca(animal.fechaEntrada);
                if (diasEnFinca > 30) {
                    // Use default GDP estimate
                    return {
                        numero: numero,
                        animal: animal,
                        gdp: data.config.gdp || 0.31,
                        isEstimated: true,
                        pesoActual: animal.peso + (diasEnFinca * (data.config.gdp || 0.31)),
                        pesoInicial: animal.peso,
                        diasTotal: diasEnFinca,
                        updates: 0
                    };
                }
                return null;
            }

            // Calculate actual GDP from weight updates
            const lastUpdate = updates[updates.length - 1];
            const pesoInicial = animal.peso;
            const pesoActual = lastUpdate.pesoNuevo;
            const gananciaTotal = pesoActual - pesoInicial;
            const diasTotal = getDiasEnFinca(animal.fechaEntrada);
            const gdpReal = diasTotal > 0 ? gananciaTotal / diasTotal : 0;

            // Also calculate GDP from last update period
            let gdpUltimoPeriodo = lastUpdate.gdpReal || gdpReal;

            return {
                numero: numero,
                animal: animal,
                gdp: gdpReal,
                gdpUltimoPeriodo: gdpUltimoPeriodo,
                isEstimated: false,
                pesoActual: pesoActual,
                pesoInicial: pesoInicial,
                gananciaTotal: gananciaTotal,
                diasTotal: diasTotal,
                updates: updates.length,
                lastUpdate: lastUpdate
            };
        }

        function refreshPerformanceAnalytics() {
            const { startDate, endDate } = getTierDateRange();
            performanceData = { top: [], average: [], poor: [], all: [] };

            if (currentTierTab === 'inventory') {
                // Get current inventory and filter by entry date
                const inventario = getInventario();
                const filteredInv = inventario.filter(a => {
                    if (!a.fechaEntrada) return true; // Include if no date
                    const fecha = new Date(a.fechaEntrada);
                    return fecha >= startDate && fecha <= endDate;
                });

                // Calculate GDP for all animals in inventory
                filteredInv.forEach(animal => {
                    const gdpData = calculateAnimalGDP(animal.numero);
                    if (gdpData && gdpData.gdp !== null) {
                        gdpData.raza = animal.raza || 'Sin raza';
                        gdpData.sexo = animal.sexo || 'N/A';
                        gdpData.condicion = animal.condicionGeneral || 'Sin datos';
                        gdpData.isSold = false;

                        performanceData.all.push(gdpData);

                        // Classify by tier
                        if (gdpData.gdp >= GDP_TOP_THRESHOLD) {
                            performanceData.top.push(gdpData);
                        } else if (gdpData.gdp >= GDP_AVG_THRESHOLD) {
                            performanceData.average.push(gdpData);
                        } else {
                            performanceData.poor.push(gdpData);
                        }
                    }
                });
            } else {
                // Get sold animals (exclude deaths and transfers)
                const filteredSalidas = (data.salidas || []).filter(s => {
                    if (!s.fechaSalida) return false;
                    if (s.comprador === 'MUERTE' || s.comprador?.includes('TRANSFERENCIA')) return false;
                    const fecha = new Date(s.fechaSalida);
                    return fecha >= startDate && fecha <= endDate;
                });

                // Calculate GDP for sold animals
                filteredSalidas.forEach(s => {
                    const original = data.entradas.find(e => String(e.numero) === String(s.numero));
                    const pesoEntrada = original?.peso || 0;
                    const pesoSalida = s.peso || 0;
                    const gananciaKg = pesoSalida - pesoEntrada;

                    // Calculate days in farm
                    let diasEnFinca = 0;
                    if (original?.fechaEntrada && s.fechaSalida) {
                        const entrada = new Date(original.fechaEntrada);
                        const salida = new Date(s.fechaSalida);
                        diasEnFinca = Math.floor((salida - entrada) / (1000 * 60 * 60 * 24));
                    }

                    // Use stored GDP or calculate
                    const gdp = s.gananciaDay || (diasEnFinca > 0 ? gananciaKg / diasEnFinca : 0);

                    if (gdp > 0) {
                        const gdpData = {
                            numero: s.numero,
                            animal: original || s,
                            gdp: gdp,
                            pesoInicial: pesoEntrada,
                            pesoActual: pesoSalida,
                            gananciaTotal: gananciaKg,
                            diasTotal: diasEnFinca,
                            raza: original?.raza || s.raza || 'Sin raza',
                            sexo: original?.sexo || 'N/A',
                            condicion: original?.condicionGeneral || 'Sin datos',
                            isSold: true,
                            fechaSalida: s.fechaSalida,
                            comprador: s.comprador
                        };

                        performanceData.all.push(gdpData);

                        // Classify by tier
                        if (gdp >= GDP_TOP_THRESHOLD) {
                            performanceData.top.push(gdpData);
                        } else if (gdp >= GDP_AVG_THRESHOLD) {
                            performanceData.average.push(gdpData);
                        } else {
                            performanceData.poor.push(gdpData);
                        }
                    }
                });
            }

            // Sort each tier by GDP (best first)
            performanceData.top.sort((a, b) => b.gdp - a.gdp);
            performanceData.average.sort((a, b) => b.gdp - a.gdp);
            performanceData.poor.sort((a, b) => b.gdp - a.gdp);
            performanceData.all.sort((a, b) => b.gdp - a.gdp);

            // Update UI
            updatePerformanceTiers();
            const inventario = getInventario();
            updateHerdSummary(inventario);
            updateCorrelationAnalysis();
            updateActionableLists();
            // updateGDPCharts(); // Disabled - charts removed for now
        }

        function updatePerformanceTiers() {
            const noDataEl = document.getElementById('noPerformanceData');
            const tiersEl = document.getElementById('performanceTiers');

            if (performanceData.all.length === 0) {
                if (noDataEl) noDataEl.style.display = 'block';
                if (tiersEl) tiersEl.style.display = 'none';
                return;
            }

            if (noDataEl) noDataEl.style.display = 'none';
            if (tiersEl) tiersEl.style.display = 'grid';

            // Top performers
            document.getElementById('topPerformersCount').textContent = performanceData.top.length;
            const topAvgGDP = performanceData.top.length > 0
                ? performanceData.top.reduce((sum, a) => sum + a.gdp, 0) / performanceData.top.length
                : 0;
            document.getElementById('topPerformersAvgGDP').textContent = `GDP: ${topAvgGDP.toFixed(2)} kg/d√≠a`;

            // Average performers
            document.getElementById('avgPerformersCount').textContent = performanceData.average.length;
            const avgAvgGDP = performanceData.average.length > 0
                ? performanceData.average.reduce((sum, a) => sum + a.gdp, 0) / performanceData.average.length
                : 0;
            document.getElementById('avgPerformersAvgGDP').textContent = `GDP: ${avgAvgGDP.toFixed(2)} kg/d√≠a`;

            // Poor performers
            document.getElementById('poorPerformersCount').textContent = performanceData.poor.length;
            const poorAvgGDP = performanceData.poor.length > 0
                ? performanceData.poor.reduce((sum, a) => sum + a.gdp, 0) / performanceData.poor.length
                : 0;
            document.getElementById('poorPerformersAvgGDP').textContent = `GDP: ${poorAvgGDP.toFixed(2)} kg/d√≠a`;
        }

        function updateHerdSummary(inventario) {
            // Update label based on current tab
            const labelEl = document.getElementById('herdTotalLabel');
            if (labelEl) {
                labelEl.textContent = currentTierTab === 'inventory' ? 'Total Inventario' : 'Total Vendidos';
            }

            // For sold animals, show the count from performanceData
            if (currentTierTab === 'sold') {
                document.getElementById('herdTotalAnimals').textContent = performanceData.all.length;
            } else {
                document.getElementById('herdTotalAnimals').textContent = inventario.length;
            }
            document.getElementById('herdWithGDP').textContent = performanceData.all.length;

            if (performanceData.all.length > 0) {
                const avgGDP = performanceData.all.reduce((sum, a) => sum + a.gdp, 0) / performanceData.all.length;
                const bestGDP = performanceData.all[0].gdp;

                document.getElementById('herdAvgGDP').textContent = avgGDP.toFixed(2) + ' kg/d√≠a';
                document.getElementById('herdBestGDP').textContent = bestGDP.toFixed(2) + ' kg/d√≠a';
            } else {
                document.getElementById('herdAvgGDP').textContent = '-- kg/d√≠a';
                document.getElementById('herdBestGDP').textContent = '-- kg/d√≠a';
            }
        }

        function updateCorrelationAnalysis() {
            // By Raza
            const byRaza = {};
            performanceData.all.forEach(a => {
                const raza = a.raza || 'Sin raza';
                if (!byRaza[raza]) byRaza[raza] = { total: 0, gdpSum: 0 };
                byRaza[raza].total++;
                byRaza[raza].gdpSum += a.gdp;
            });

            let razaHtml = '';
            Object.entries(byRaza)
                .map(([raza, data]) => ({ raza, avg: data.gdpSum / data.total, count: data.total }))
                .sort((a, b) => b.avg - a.avg)
                .forEach(item => {
                    const color = item.avg >= GDP_TOP_THRESHOLD ? '#10b981' : item.avg >= GDP_AVG_THRESHOLD ? '#f59e0b' : '#ef4444';
                    razaHtml += `<div style="display: flex; justify-content: space-between; padding: 0.25rem 0; border-bottom: 1px solid #eee;">
                        <span>${item.raza} (${item.count})</span>
                        <span style="color: ${color}; font-weight: bold;">${item.avg.toFixed(2)} kg/d√≠a</span>
                    </div>`;
                });
            document.getElementById('correlationByRaza').innerHTML = razaHtml || '<span style="color: #999;">Sin datos</span>';

            // By Condition
            const byCondition = {};
            performanceData.all.forEach(a => {
                const cond = a.condicion || 'Sin datos';
                if (!byCondition[cond]) byCondition[cond] = { total: 0, gdpSum: 0 };
                byCondition[cond].total++;
                byCondition[cond].gdpSum += a.gdp;
            });

            let condHtml = '';
            Object.entries(byCondition)
                .map(([cond, data]) => ({ cond, avg: data.gdpSum / data.total, count: data.total }))
                .sort((a, b) => b.avg - a.avg)
                .forEach(item => {
                    const color = item.avg >= GDP_TOP_THRESHOLD ? '#10b981' : item.avg >= GDP_AVG_THRESHOLD ? '#f59e0b' : '#ef4444';
                    condHtml += `<div style="display: flex; justify-content: space-between; padding: 0.25rem 0; border-bottom: 1px solid #eee;">
                        <span>${item.cond} (${item.count})</span>
                        <span style="color: ${color}; font-weight: bold;">${item.avg.toFixed(2)} kg/d√≠a</span>
                    </div>`;
                });
            document.getElementById('correlationByCondition').innerHTML = condHtml || '<span style="color: #999;">Sin datos</span>';

            // By Entry Weight Range
            const weightRanges = [
                { label: '< 200 kg', min: 0, max: 200 },
                { label: '200-300 kg', min: 200, max: 300 },
                { label: '300-400 kg', min: 300, max: 400 },
                { label: '> 400 kg', min: 400, max: 9999 }
            ];

            let weightHtml = '';
            weightRanges.forEach(range => {
                const animals = performanceData.all.filter(a => a.pesoInicial >= range.min && a.pesoInicial < range.max);
                if (animals.length > 0) {
                    const avgGDP = animals.reduce((sum, a) => sum + a.gdp, 0) / animals.length;
                    const color = avgGDP >= GDP_TOP_THRESHOLD ? '#10b981' : avgGDP >= GDP_AVG_THRESHOLD ? '#f59e0b' : '#ef4444';
                    weightHtml += `<div style="display: flex; justify-content: space-between; padding: 0.25rem 0; border-bottom: 1px solid #eee;">
                        <span>${range.label} (${animals.length})</span>
                        <span style="color: ${color}; font-weight: bold;">${avgGDP.toFixed(2)} kg/d√≠a</span>
                    </div>`;
                }
            });
            document.getElementById('correlationByWeight').innerHTML = weightHtml || '<span style="color: #999;">Sin datos</span>';

            // By Sex
            const bySex = {};
            performanceData.all.forEach(a => {
                const sex = a.sexo || 'N/A';
                if (!bySex[sex]) bySex[sex] = { total: 0, gdpSum: 0 };
                bySex[sex].total++;
                bySex[sex].gdpSum += a.gdp;
            });

            let sexHtml = '';
            Object.entries(bySex)
                .map(([sex, data]) => ({ sex, avg: data.gdpSum / data.total, count: data.total }))
                .sort((a, b) => b.avg - a.avg)
                .forEach(item => {
                    const icon = item.sex === 'MACHO' ? '‚ôÇÔ∏è' : item.sex === 'HEMBRA' ? '‚ôÄÔ∏è' : '‚ùì';
                    const color = item.avg >= GDP_TOP_THRESHOLD ? '#10b981' : item.avg >= GDP_AVG_THRESHOLD ? '#f59e0b' : '#ef4444';
                    sexHtml += `<div style="display: flex; justify-content: space-between; padding: 0.25rem 0; border-bottom: 1px solid #eee;">
                        <span>${icon} ${item.sex} (${item.count})</span>
                        <span style="color: ${color}; font-weight: bold;">${item.avg.toFixed(2)} kg/d√≠a</span>
                    </div>`;
                });
            document.getElementById('correlationBySex').innerHTML = sexHtml || '<span style="color: #999;">Sin datos</span>';
        }

        function updateActionableLists() {
            // Ready to Sell: Good GDP + weight >= TARGET_WEIGHT
            const readyToSell = performanceData.all.filter(a =>
                a.gdp >= GDP_AVG_THRESHOLD && a.pesoActual >= TARGET_WEIGHT
            ).slice(0, 10);

            let sellHtml = readyToSell.map(a => `
                <div onclick="showAnimalProfile('${a.numero}')" style="background: white; border-radius: 6px; padding: 0.5rem; margin-bottom: 0.5rem; cursor: pointer; border-left: 3px solid #10b981;">
                    <div style="font-weight: bold;">#${a.numero}</div>
                    <div style="font-size: 0.75rem; color: #666;">${Math.round(a.pesoActual)}kg | GDP: ${a.gdp.toFixed(2)}</div>
                </div>
            `).join('');
            document.getElementById('readyToSellList').innerHTML = sellHtml || '<div style="color: #999; font-size: 0.85rem;">Ninguno listo a√∫n</div>';
            document.getElementById('readyToSellCount').textContent = `${readyToSell.length} animales`;

            // Stars: Top 10 by GDP
            const stars = performanceData.top.slice(0, 10);
            let starsHtml = stars.map(a => `
                <div onclick="showAnimalProfile('${a.numero}')" style="background: white; border-radius: 6px; padding: 0.5rem; margin-bottom: 0.5rem; cursor: pointer; border-left: 3px solid #f59e0b;">
                    <div style="font-weight: bold;">#${a.numero} <span style="color: #f59e0b;">‚≠ê</span></div>
                    <div style="font-size: 0.75rem; color: #666;">${a.raza} | GDP: ${a.gdp.toFixed(2)}</div>
                </div>
            `).join('');
            document.getElementById('starAnimalsList').innerHTML = starsHtml || '<div style="color: #999; font-size: 0.85rem;">Sin estrellas a√∫n</div>';
            document.getElementById('starAnimalsCount').textContent = `${stars.length} animales`;

            // Underperformers: Poor GDP
            const underperformers = performanceData.poor.slice(0, 10);
            let underHtml = underperformers.map(a => `
                <div onclick="showAnimalProfile('${a.numero}')" style="background: white; border-radius: 6px; padding: 0.5rem; margin-bottom: 0.5rem; cursor: pointer; border-left: 3px solid #ef4444;">
                    <div style="font-weight: bold;">#${a.numero} <span style="color: #ef4444;">‚ö†Ô∏è</span></div>
                    <div style="font-size: 0.75rem; color: #666;">${a.raza} | GDP: ${a.gdp.toFixed(2)}</div>
                </div>
            `).join('');
            document.getElementById('underperformersList').innerHTML = underHtml || '<div style="color: #999; font-size: 0.85rem;">Ninguno con bajo rendimiento</div>';
            document.getElementById('underperformersCount').textContent = `${underperformers.length} animales`;
        }

        function updateGDPCharts() {
            // Check if Chart.js is loaded
            if (typeof Chart === 'undefined') {
                console.warn('Chart.js not loaded yet, skipping chart update');
                return;
            }

            // GDP Distribution Chart
            const ctx1 = document.getElementById('gdpDistributionChart');
            if (!ctx1) return;

            // Destroy existing chart
            if (gdpDistributionChart) {
                gdpDistributionChart.destroy();
            }

            gdpDistributionChart = new Chart(ctx1, {
                type: 'bar',
                data: {
                    labels: ['Top (>0.40)', 'Promedio (0.25-0.40)', 'Bajo (<0.25)'],
                    datasets: [{
                        label: 'Cantidad de Animales',
                        data: [performanceData.top.length, performanceData.average.length, performanceData.poor.length],
                        backgroundColor: ['#10b981', '#f59e0b', '#ef4444'],
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });

            // GDP by Raza Chart
            const ctx2 = document.getElementById('gdpByRazaChart');
            if (!ctx2) return;

            if (gdpByRazaChart) {
                gdpByRazaChart.destroy();
            }

            // Aggregate by raza
            const razaData = {};
            performanceData.all.forEach(a => {
                const raza = a.raza || 'Sin raza';
                if (!razaData[raza]) razaData[raza] = { total: 0, gdpSum: 0 };
                razaData[raza].total++;
                razaData[raza].gdpSum += a.gdp;
            });

            const razaLabels = Object.keys(razaData);
            const razaAvgs = razaLabels.map(r => razaData[r].gdpSum / razaData[r].total);
            const razaColors = razaAvgs.map(avg =>
                avg >= GDP_TOP_THRESHOLD ? '#10b981' : avg >= GDP_AVG_THRESHOLD ? '#f59e0b' : '#ef4444'
            );

            gdpByRazaChart = new Chart(ctx2, {
                type: 'bar',
                data: {
                    labels: razaLabels,
                    datasets: [{
                        label: 'GDP Promedio (kg/d√≠a)',
                        data: razaAvgs,
                        backgroundColor: razaColors,
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: { beginAtZero: true }
                    }
                }
            });
        }

        function showTierAnimals(tier) {
            let animals = [];
            let tierName = '';
            let tierColor = '';

            switch(tier) {
                case 'top':
                    animals = performanceData.top;
                    tierName = 'Top Performers (GDP > 0.40 kg/d√≠a)';
                    tierColor = '#10b981';
                    break;
                case 'average':
                    animals = performanceData.average;
                    tierName = 'Rendimiento Promedio (GDP 0.25 - 0.40 kg/d√≠a)';
                    tierColor = '#f59e0b';
                    break;
                case 'poor':
                    animals = performanceData.poor;
                    tierName = 'Bajo Rendimiento (GDP < 0.25 kg/d√≠a)';
                    tierColor = '#ef4444';
                    break;
            }

            if (animals.length === 0) {
                showToast('No hay animales en esta categor√≠a', 'info');
                return;
            }

            // Create modal with animal list
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.id = 'tierAnimalsModal';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 700px; max-height: 80vh;">
                    <div class="modal-header" style="background: ${tierColor};">
                        <span>üèÜ ${tierName}</span>
                        <button class="modal-close" onclick="document.getElementById('tierAnimalsModal').remove()">√ó</button>
                    </div>
                    <div class="modal-body" style="padding: 1rem; overflow-y: auto; max-height: 60vh;">
                        <div style="margin-bottom: 1rem; display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-weight: bold;">${animals.length} animales</span>
                            <span style="color: #666; font-size: 0.85rem;">Click para ver perfil</span>
                        </div>
                        <div class="table-container">
                            <table style="width: 100%;">
                                <thead>
                                    <tr>
                                        <th>Chapeta</th>
                                        <th>Raza</th>
                                        <th>Sexo</th>
                                        <th class="text-right">Peso Actual</th>
                                        <th class="text-right">GDP</th>
                                        <th>Condici√≥n</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${animals.map(a => `
                                        <tr onclick="document.getElementById('tierAnimalsModal').remove(); showAnimalProfile('${a.numero}');" style="cursor: pointer;" onmouseover="this.style.background='#f0f9ff'" onmouseout="this.style.background=''">
                                            <td><strong>#${a.numero}</strong></td>
                                            <td>${a.raza}</td>
                                            <td>${a.sexo === 'MACHO' ? '‚ôÇÔ∏è' : '‚ôÄÔ∏è'} ${a.sexo}</td>
                                            <td class="text-right">${Math.round(a.pesoActual)} kg</td>
                                            <td class="text-right" style="color: ${tierColor}; font-weight: bold;">${a.gdp.toFixed(2)}</td>
                                            <td>${a.condicion}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // ==================== DEMO DATA SIMULATION ====================
        // Generate simulated weight updates for demonstration purposes
        function generateDemoData() {
            const inventario = getInventario();
            if (inventario.length === 0) {
                showToast('No hay animales en el inventario', 'error');
                return;
            }

            // Varied razas for simulation
            const razas = ['Ceb√∫', 'Brahman', 'Angus', 'Criollo', 'Gyr', 'Holstein', 'Simmental'];
            const condiciones = ['Excelente', 'Buenas condiciones', 'Regular', 'Flaco', 'Muy flaco'];

            // Performance distributions (GDP ranges)
            // Top performers: 0.45-0.60 kg/day
            // Average performers: 0.28-0.38 kg/day
            // Poor performers: 0.10-0.22 kg/day
            const gdpProfiles = [
                { name: 'top', gdpMin: 0.45, gdpMax: 0.60, weight: 25 },      // ~25% top
                { name: 'average', gdpMin: 0.28, gdpMax: 0.38, weight: 50 }, // ~50% average
                { name: 'poor', gdpMin: 0.10, gdpMax: 0.22, weight: 25 }     // ~25% poor
            ];

            // Clear existing demo data
            if (!data.pesoUpdates) data.pesoUpdates = [];

            // Filter to animals from 2025 or with at least 60 days in farm
            const eligibleAnimals = inventario.filter(animal => {
                const fechaEntrada = new Date(animal.fechaEntrada);
                const diasEnFinca = getDiasEnFinca(animal.fechaEntrada);
                return diasEnFinca >= 60; // At least 60 days to have meaningful data
            });

            if (eligibleAnimals.length === 0) {
                showToast('No hay animales con suficiente tiempo en la finca', 'info');
                return;
            }

            let updatedCount = 0;

            eligibleAnimals.forEach((animal, idx) => {
                // Skip if animal already has real weight updates
                const existingUpdates = data.pesoUpdates.filter(u => String(u.numero) === String(animal.numero));
                if (existingUpdates.length > 0) return;

                // Find the original animal in data.entradas to modify
                const originalAnimal = data.entradas.find(e => String(e.numero) === String(animal.numero));
                if (!originalAnimal) return;

                // Assign random raza if all are Ceb√∫ (for demo variety)
                if (originalAnimal.raza === 'Ceb√∫' || !originalAnimal.raza) {
                    originalAnimal.raza = razas[idx % razas.length];
                    originalAnimal.razaOriginal = 'Ceb√∫'; // Store original for clearing
                }

                // Assign GDP profile based on weighted distribution
                const rand = Math.random() * 100;
                let profile;
                if (rand < 25) {
                    profile = gdpProfiles[0]; // top
                } else if (rand < 75) {
                    profile = gdpProfiles[1]; // average
                } else {
                    profile = gdpProfiles[2]; // poor
                }

                // Calculate random GDP within profile range
                const gdp = profile.gdpMin + (Math.random() * (profile.gdpMax - profile.gdpMin));

                // Assign condition based on GDP
                let condicion;
                if (gdp >= 0.40) {
                    condicion = Math.random() > 0.3 ? 'Excelente' : 'Buenas condiciones';
                } else if (gdp >= 0.25) {
                    condicion = Math.random() > 0.5 ? 'Buenas condiciones' : 'Regular';
                } else {
                    condicion = Math.random() > 0.5 ? 'Flaco' : 'Regular';
                }

                // Update animal's condicion (mark as demo for later cleanup)
                originalAnimal.condicionGeneral = condicion;
                originalAnimal.condicionIsDemo = true;

                // Calculate days in farm and weight gain
                const diasEnFinca = getDiasEnFinca(animal.fechaEntrada);
                const pesoInicial = animal.peso;

                // Create 2-3 weight updates over time
                const numUpdates = 2 + Math.floor(Math.random() * 2); // 2-3 updates
                const intervalDays = Math.floor(diasEnFinca / (numUpdates + 1));

                let currentPeso = pesoInicial;
                let currentDate = new Date(animal.fechaEntrada);

                for (let i = 1; i <= numUpdates; i++) {
                    // Add some variation to the interval
                    const daysToAdd = intervalDays + Math.floor((Math.random() - 0.5) * 14);
                    currentDate = new Date(currentDate.getTime() + (daysToAdd * 24 * 60 * 60 * 1000));

                    // Calculate weight with some daily variation
                    const dailyGdp = gdp * (0.85 + Math.random() * 0.30); // 85%-115% of target GDP
                    const pesoGanado = daysToAdd * dailyGdp;
                    currentPeso = currentPeso + pesoGanado;

                    // Create weight update
                    const update = {
                        id: `demo_${animal.numero}_${i}_${Date.now()}`,
                        numero: animal.numero,
                        fecha: currentDate.toISOString().split('T')[0],
                        pesoAnterior: Math.round(currentPeso - pesoGanado),
                        pesoNuevo: Math.round(currentPeso),
                        diasTranscurridos: daysToAdd,
                        gdpReal: dailyGdp,
                        observaciones: `[Demo] ${condicion}`,
                        isDemo: true
                    };

                    data.pesoUpdates.push(update);
                }

                updatedCount++;
            });

            // Save data
            saveData();

            // Refresh analytics
            refreshPerformanceAnalytics();

            showToast(`‚úÖ Datos demo generados para ${updatedCount} animales`, 'success');
        }

        // Clear demo data
        function clearDemoData() {
            if (!confirm('¬øEliminar todos los datos de demostraci√≥n?')) return;

            if (data.pesoUpdates) {
                data.pesoUpdates = data.pesoUpdates.filter(u => !u.isDemo);
            }

            // Reset razas and conditions back to original for demo animals
            data.entradas.forEach(animal => {
                if (animal.razaOriginal) {
                    animal.raza = animal.razaOriginal;
                    delete animal.razaOriginal;
                }
                // Clear demo condition
                if (animal.condicionIsDemo) {
                    delete animal.condicionGeneral;
                    delete animal.condicionIsDemo;
                }
            });

            saveData();
            refreshPerformanceAnalytics();
            showToast('Datos demo eliminados', 'info');
        }

        // Clear ALL peso updates (use with caution)
        function clearAllPesoUpdates() {
            const count = data.pesoUpdates ? data.pesoUpdates.length : 0;
            if (count === 0) {
                showToast('No hay actualizaciones de peso para eliminar', 'info');
                return;
            }

            if (!confirm(`‚ö†Ô∏è ¬øEliminar TODAS las ${count} actualizaciones de peso?\n\nEsto no se puede deshacer.`)) return;

            data.pesoUpdates = [];
            saveData();

            // Refresh views
            if (typeof updateInventarioTable === 'function') updateInventarioTable();
            if (typeof updateProgresoView === 'function') updateProgresoView();
            if (typeof refreshPerformanceAnalytics === 'function') refreshPerformanceAnalytics();

            showToast(`üóëÔ∏è ${count} actualizaciones de peso eliminadas`, 'warning');
        }
        // ==================== END DEMO DATA SIMULATION ====================

        // ==================== END PERFORMANCE ANALYTICS ====================

        // Fill weight update modal from voice
        function fillWeightUpdateFromVoice(parsed) {
            const pesoInput = document.getElementById('quickPesoNuevo');
            const obsInput = document.getElementById('quickPesoObservaciones');

            if (pesoInput && parsed.peso) {
                pesoInput.value = parsed.peso;
            }

            if (obsInput) {
                let obs = parsed.observaciones || '';
                if (parsed.condicion) {
                    obs = `Condici√≥n: ${parsed.condicion}. ${obs}`;
                }
                obsInput.value = obs;
            }

            showToast('‚úÖ Datos de voz aplicados al formulario', 'success');
        }

        // Fill profile from voice
        function fillProfileFromVoice(parsed) {
            // This would update the animal's condicion general in their profile
            if (parsed.chapeta) {
                const animal = data.entradas.find(e => e.numero == parsed.chapeta);
                if (animal && parsed.condicion) {
                    animal.condicionGeneral = parsed.condicion;
                    saveData();
                    showToast(`‚úÖ Condici√≥n actualizada para animal ${parsed.chapeta}`, 'success');
                }
            }
        }

        // Update animal condition from dropdown or voice
        function updateAnimalCondicion(numero, condicion) {
            const animal = data.entradas.find(e => e.numero == numero);
            if (animal) {
                animal.condicionGeneral = condicion;
                saveData();

                // Update display
                const displayEl = document.getElementById('animalCondicion_' + numero);
                if (displayEl) {
                    displayEl.textContent = condicion || 'Sin observaciones';
                }

                showToast(`‚úÖ Condici√≥n actualizada para animal #${numero}`, 'success');

                // Trigger cloud sync
                if (typeof cloudSync !== 'undefined' && cloudSync.enabled) {
                    cloudSync.triggerAutoSync();
                }
            }
        }

        // Variable to store current animal for voice dictation
        let currentVoiceAnimal = null;

        // Start voice dictation for a specific animal (from profile)
        function startVoiceDictationForAnimal(numero) {
            currentVoiceAnimal = numero;

            if (!SpeechRecognition) {
                showToast('‚ö†Ô∏è Tu navegador no soporta reconocimiento de voz. Usa Chrome o Safari.', 'error');
                return;
            }

            if (!recognition) {
                initSpeechRecognition();
            }

            // Set up special handler for animal-specific dictation
            recognition.onresult = function(event) {
                let finalTranscript = '';
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    if (event.results[i].isFinal) {
                        finalTranscript += event.results[i][0].transcript;
                    }
                }

                if (finalTranscript) {
                    const parsed = parseVoiceDictation(finalTranscript);

                    // Update animal condition
                    if (parsed.condicion || finalTranscript) {
                        const condicion = parsed.condicion || finalTranscript;
                        updateAnimalCondicion(currentVoiceAnimal, condicion);

                        // Update the select dropdown
                        const selectEl = document.getElementById('condicionSelect_' + currentVoiceAnimal);
                        if (selectEl) {
                            // Check if the condition matches an option
                            const options = Array.from(selectEl.options);
                            const matchingOption = options.find(opt => opt.value === parsed.condicion);
                            if (matchingOption) {
                                selectEl.value = parsed.condicion;
                            } else {
                                selectEl.value = '';
                            }
                        }
                    }

                    // If weight was mentioned, offer to update it
                    if (parsed.peso) {
                        if (confirm(`¬øDesea actualizar el peso del animal #${currentVoiceAnimal} a ${parsed.peso} kg?`)) {
                            // Close profile and open weight update modal
                            closeAnimalProfile();
                            setTimeout(() => {
                                showQuickWeightUpdate(currentVoiceAnimal);
                                setTimeout(() => {
                                    const pesoInput = document.getElementById('quickPesoNuevo');
                                    if (pesoInput) pesoInput.value = parsed.peso;
                                }, 100);
                            }, 300);
                        }
                    }
                }
            };

            try {
                recognition.start();
                showToast('üé§ Dicte la condici√≥n del animal. Ej: "Se ve en buenas condiciones, gordo y sano"', 'info');
            } catch (error) {
                console.error('Error starting recognition:', error);
                showToast('‚ö†Ô∏è Error al iniciar micr√≥fono', 'error');
            }
        }

        // Start voice dictation for weight update modal
        function startVoiceForWeightUpdate(numero) {
            if (!SpeechRecognition) {
                showToast('‚ö†Ô∏è Tu navegador no soporta reconocimiento de voz. Usa Chrome o Safari.', 'error');
                return;
            }

            if (!recognition) {
                initSpeechRecognition();
            }

            // Set up handler for weight update
            recognition.onresult = function(event) {
                let finalTranscript = '';
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    if (event.results[i].isFinal) {
                        finalTranscript += event.results[i][0].transcript;
                    }
                }

                if (finalTranscript) {
                    const parsed = parseVoiceDictation(finalTranscript);

                    // Fill weight if detected
                    const pesoInput = document.getElementById('quickPesoNuevo');
                    if (pesoInput && parsed.peso) {
                        pesoInput.value = parsed.peso;
                    }

                    // Fill observations with full transcript
                    const obsInput = document.getElementById('quickPesoObs');
                    if (obsInput) {
                        let obs = finalTranscript;
                        if (parsed.condicion) {
                            obs = `Condici√≥n: ${parsed.condicion}. ` + finalTranscript;
                        }
                        obsInput.value = obs;
                    }

                    showToast('‚úÖ Datos de voz aplicados', 'success');
                }
            };

            try {
                recognition.start();
                showToast('üé§ Dicte el peso y observaciones. Ej: "Pesa 320 kilos, se ve en buenas condiciones"', 'info');
            } catch (error) {
                console.error('Error starting recognition:', error);
                showToast('‚ö†Ô∏è Error al iniciar micr√≥fono', 'error');
            }
        }

        // Initialize speech recognition on page load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üì± Ganado Finca - Version 2.1');
            if (SpeechRecognition) {
                initSpeechRecognition();
                console.log('üé§ Speech recognition available');
            } else {
                console.warn('üé§ Speech recognition not available');
            }
        });

        // ==================== QUICK CAPTURE MODE ====================

        let quickCapturePhotos = []; // Array of photos taken in quick mode

        function startQuickCaptureMode() {
            quickCapturePhotos = [];

            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.id = 'quickCaptureModal';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 600px; max-height: 90vh; overflow-y: auto;">
                    <div class="modal-header" style="background: linear-gradient(135deg, #f59e0b, #d97706);">
                        <span>‚ö° Modo Captura R√°pida</span>
                        <button class="modal-close" onclick="closeQuickCaptureMode()">√ó</button>
                    </div>
                    <div class="modal-body" style="padding: 1.5rem;">
                        <div style="background: #fef3c7; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border-left: 4px solid #f59e0b;">
                            <strong>üì∑ Instrucciones:</strong>
                            <ol style="margin: 0.5rem 0 0 1.25rem; font-size: 0.9rem;">
                                <li>Tome fotos r√°pidamente de varios animales</li>
                                <li>Las fotos se guardan temporalmente</li>
                                <li>Despu√©s asigne cada foto a un animal</li>
                            </ol>
                        </div>

                        <div style="text-align: center; margin-bottom: 1.5rem;">
                            <button onclick="takeQuickPhoto()" class="btn" style="background: #f59e0b; color: white; font-size: 1.5rem; padding: 1.5rem 3rem; border-radius: 16px;">
                                üì∏ Tomar Foto
                            </button>
                            <div style="margin-top: 0.5rem; color: #666; font-size: 0.85rem;">
                                Fotos capturadas: <strong id="quickPhotoCount">0</strong>
                            </div>
                        </div>

                        <div id="quickCapturePreview" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 0.5rem; margin-bottom: 1rem;">
                            <!-- Photos will appear here -->
                        </div>

                        <div id="quickCaptureActions" style="display: none;">
                            <button onclick="assignQuickPhotos()" class="btn btn-primary" style="width: 100%; margin-bottom: 0.5rem;">
                                ‚úÖ Asignar Fotos a Animales
                            </button>
                            <button onclick="downloadQuickPhotos()" class="btn btn-secondary" style="width: 100%;">
                                üíæ Guardar en Dispositivo
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function closeQuickCaptureMode() {
            if (quickCapturePhotos.length > 0) {
                if (!confirm('¬øCerrar sin guardar las fotos?')) return;
            }
            document.getElementById('quickCaptureModal')?.remove();
            quickCapturePhotos = [];
        }

        function takeQuickPhoto() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.capture = 'environment';

            input.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;

                compressImage(file, function(dataUrl) {
                    quickCapturePhotos.push({
                        id: Date.now(),
                        dataUrl: dataUrl,
                        timestamp: new Date().toISOString(),
                        chapeta: null
                    });

                    updateQuickCaptureUI();
                    showToast(`üì∏ Foto ${quickCapturePhotos.length} capturada`, 'success');
                });
            };

            input.click();
        }

        function updateQuickCaptureUI() {
            const countEl = document.getElementById('quickPhotoCount');
            const previewEl = document.getElementById('quickCapturePreview');
            const actionsEl = document.getElementById('quickCaptureActions');

            if (countEl) countEl.textContent = quickCapturePhotos.length;

            if (previewEl) {
                previewEl.innerHTML = quickCapturePhotos.map((p, i) => `
                    <div style="position: relative;">
                        <img src="${p.dataUrl}" style="width: 100%; aspect-ratio: 1; object-fit: cover; border-radius: 8px; border: 2px solid #ddd;">
                        <button onclick="removeQuickPhoto(${p.id})" style="position: absolute; top: 4px; right: 4px; background: #ef4444; color: white; border: none; border-radius: 50%; width: 24px; height: 24px; cursor: pointer; font-size: 14px;">√ó</button>
                        <div style="position: absolute; bottom: 4px; left: 4px; background: rgba(0,0,0,0.7); color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.75rem;">${i + 1}</div>
                    </div>
                `).join('');
            }

            if (actionsEl) {
                actionsEl.style.display = quickCapturePhotos.length > 0 ? 'block' : 'none';
            }
        }

        function removeQuickPhoto(id) {
            quickCapturePhotos = quickCapturePhotos.filter(p => p.id !== id);
            updateQuickCaptureUI();
        }

        function assignQuickPhotos() {
            document.getElementById('quickCaptureModal')?.remove();

            // Convert to pending dictations for assignment
            quickCapturePhotos.forEach(photo => {
                pendingDictations.push({
                    id: photo.id,
                    chapeta: '',
                    peso: '',
                    condicion: '',
                    observaciones: 'Foto capturada en modo r√°pido',
                    hasPhoto: true,
                    photoData: photo.dataUrl,
                    timestamp: photo.timestamp
                });
            });

            quickCapturePhotos = [];
            updatePendingDictationsUI();

            showToast(`üì∏ ${pendingDictations.length} fotos listas para asignar`, 'success');

            // Scroll to pending dictations section
            document.getElementById('pendingDictationsSection')?.scrollIntoView({ behavior: 'smooth' });
        }

        function downloadQuickPhotos() {
            quickCapturePhotos.forEach((photo, i) => {
                const link = document.createElement('a');
                link.href = photo.dataUrl;
                link.download = `animal_foto_${i + 1}_${new Date().toISOString().split('T')[0]}.jpg`;
                link.click();
            });
            showToast(`üíæ ${quickCapturePhotos.length} fotos descargadas`, 'success');
        }

        // ==================== VOICE NOTE MODE (Audio Recording Fallback) ====================

        let mediaRecorder = null;
        let audioChunks = [];
        let voiceNotePhotos = []; // Photos with associated voice notes
        let isRecordingAudio = false;

        function startVoiceNoteMode() {
            voiceNotePhotos = [];

            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.id = 'voiceNoteModal';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 600px; max-height: 90vh; overflow-y: auto;">
                    <div class="modal-header" style="background: linear-gradient(135deg, #ec4899, #db2777);">
                        <span>üéôÔ∏è Nota de Voz + Foto</span>
                        <button class="modal-close" onclick="closeVoiceNoteMode()">√ó</button>
                    </div>
                    <div class="modal-body" style="padding: 1.5rem;">
                        <div style="background: #fce7f3; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border-left: 4px solid #ec4899;">
                            <strong>üéôÔ∏è Modo Sin Internet:</strong>
                            <p style="margin: 0.5rem 0 0 0; font-size: 0.9rem;">
                                Grabe un mensaje de voz con la informaci√≥n del animal, tome la foto, y despu√©s en casa transcriba la informaci√≥n.
                            </p>
                        </div>

                        <!-- Current Recording -->
                        <div id="voiceNoteRecorder" style="text-align: center; padding: 1.5rem; background: #f9fafb; border-radius: 12px; margin-bottom: 1.5rem;">
                            <div style="font-size: 4rem; margin-bottom: 1rem;" id="voiceNoteIcon">üéôÔ∏è</div>

                            <button id="recordAudioBtn" onclick="toggleAudioRecording()" class="btn" style="background: #ec4899; color: white; font-size: 1.2rem; padding: 1rem 2rem; border-radius: 30px;">
                                üéôÔ∏è Iniciar Grabaci√≥n
                            </button>

                            <div id="recordingStatus" style="margin-top: 1rem; display: none;">
                                <div style="color: #dc2626; font-weight: bold; font-size: 1.1rem;">
                                    <span class="pulse-mic">üî¥</span> Grabando...
                                </div>
                                <div id="recordingTime" style="font-family: monospace; font-size: 1.5rem; margin-top: 0.5rem;">00:00</div>
                            </div>

                            <audio id="audioPreview" controls style="display: none; width: 100%; margin-top: 1rem;"></audio>
                        </div>

                        <!-- Take Photo Button (appears after recording) -->
                        <div id="takePhotoSection" style="display: none; text-align: center; margin-bottom: 1.5rem;">
                            <button onclick="takeVoiceNotePhoto()" class="btn btn-primary" style="font-size: 1.2rem; padding: 1rem 2rem;">
                                üì∏ Tomar Foto del Animal
                            </button>
                        </div>

                        <!-- Saved Notes -->
                        <div id="voiceNotesContainer">
                            <h4 style="margin-bottom: 1rem;">üìù Notas Guardadas (<span id="voiceNoteCount">0</span>)</h4>
                            <div id="voiceNotesList" style="max-height: 300px; overflow-y: auto;">
                                <div style="text-align: center; color: #666; padding: 1rem;">
                                    Grabe su primera nota de voz
                                </div>
                            </div>
                        </div>

                        <div id="voiceNotesActions" style="display: none; margin-top: 1rem;">
                            <button onclick="processVoiceNotes()" class="btn btn-success" style="width: 100%;">
                                ‚úÖ Procesar Notas (Agregar a Pendientes)
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function closeVoiceNoteMode() {
            if (voiceNotePhotos.length > 0) {
                if (!confirm('¬øCerrar sin procesar las notas?')) return;
            }
            stopAudioRecording();
            document.getElementById('voiceNoteModal')?.remove();
            voiceNotePhotos = [];
        }

        let recordingStartTime = null;
        let recordingTimer = null;

        async function toggleAudioRecording() {
            if (isRecordingAudio) {
                stopAudioRecording();
            } else {
                await startAudioRecording();
            }
        }

        async function startAudioRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });

                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];

                mediaRecorder.ondataavailable = (event) => {
                    audioChunks.push(event.data);
                };

                mediaRecorder.onstop = () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    const audioUrl = URL.createObjectURL(audioBlob);

                    const audioPreview = document.getElementById('audioPreview');
                    if (audioPreview) {
                        audioPreview.src = audioUrl;
                        audioPreview.style.display = 'block';
                    }

                    // Store the current recording temporarily
                    window.currentAudioBlob = audioBlob;
                    window.currentAudioUrl = audioUrl;

                    // Show take photo section
                    document.getElementById('takePhotoSection').style.display = 'block';

                    // Stop all tracks
                    stream.getTracks().forEach(track => track.stop());
                };

                mediaRecorder.start();
                isRecordingAudio = true;

                // Update UI
                const btn = document.getElementById('recordAudioBtn');
                btn.innerHTML = '‚èπÔ∏è Detener Grabaci√≥n';
                btn.style.background = '#dc2626';

                document.getElementById('recordingStatus').style.display = 'block';
                document.getElementById('voiceNoteIcon').innerHTML = '<span class="pulse-mic">üî¥</span>';

                // Start timer
                recordingStartTime = Date.now();
                recordingTimer = setInterval(() => {
                    const elapsed = Math.floor((Date.now() - recordingStartTime) / 1000);
                    const mins = Math.floor(elapsed / 60).toString().padStart(2, '0');
                    const secs = (elapsed % 60).toString().padStart(2, '0');
                    document.getElementById('recordingTime').textContent = `${mins}:${secs}`;
                }, 1000);

            } catch (error) {
                console.error('Error accessing microphone:', error);
                showToast('‚ö†Ô∏è No se pudo acceder al micr√≥fono. Verifique permisos.', 'error');
            }
        }

        function stopAudioRecording() {
            if (mediaRecorder && isRecordingAudio) {
                mediaRecorder.stop();
                isRecordingAudio = false;

                // Update UI
                const btn = document.getElementById('recordAudioBtn');
                if (btn) {
                    btn.innerHTML = 'üéôÔ∏è Nueva Grabaci√≥n';
                    btn.style.background = '#ec4899';
                }

                document.getElementById('recordingStatus').style.display = 'none';
                document.getElementById('voiceNoteIcon').innerHTML = 'üéôÔ∏è';

                // Stop timer
                if (recordingTimer) {
                    clearInterval(recordingTimer);
                    recordingTimer = null;
                }
            }
        }

        function takeVoiceNotePhoto() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.capture = 'environment';

            input.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;

                compressImage(file, function(dataUrl) {
                    // Save the note with photo
                    voiceNotePhotos.push({
                        id: Date.now(),
                        audioBlob: window.currentAudioBlob,
                        audioUrl: window.currentAudioUrl,
                        photoData: dataUrl,
                        timestamp: new Date().toISOString(),
                        transcription: '' // To be filled later
                    });

                    // Reset for next recording
                    window.currentAudioBlob = null;
                    window.currentAudioUrl = null;
                    document.getElementById('audioPreview').style.display = 'none';
                    document.getElementById('takePhotoSection').style.display = 'none';

                    updateVoiceNotesUI();
                    showToast('‚úÖ Nota de voz + foto guardada', 'success');
                });
            };

            input.click();
        }

        function updateVoiceNotesUI() {
            const countEl = document.getElementById('voiceNoteCount');
            const listEl = document.getElementById('voiceNotesList');
            const actionsEl = document.getElementById('voiceNotesActions');

            if (countEl) countEl.textContent = voiceNotePhotos.length;

            if (listEl) {
                if (voiceNotePhotos.length === 0) {
                    listEl.innerHTML = '<div style="text-align: center; color: #666; padding: 1rem;">Grabe su primera nota de voz</div>';
                } else {
                    listEl.innerHTML = voiceNotePhotos.map((note, i) => `
                        <div style="background: white; border-radius: 8px; padding: 1rem; margin-bottom: 0.75rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <div style="display: flex; gap: 1rem; align-items: start;">
                                <img src="${note.photoData}" style="width: 80px; height: 80px; object-fit: cover; border-radius: 8px;">
                                <div style="flex: 1;">
                                    <div style="font-weight: bold; margin-bottom: 0.5rem;">Nota #${i + 1}</div>
                                    <audio src="${note.audioUrl}" controls style="width: 100%; height: 32px;"></audio>
                                    <input type="text" placeholder="# Chapeta (completar despu√©s)"
                                           value="${note.transcription}"
                                           onchange="voiceNotePhotos[${i}].transcription = this.value"
                                           style="width: 100%; margin-top: 0.5rem; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                                </div>
                                <button onclick="removeVoiceNote(${note.id})" style="background: none; border: none; color: #ef4444; cursor: pointer; font-size: 1.2rem;">√ó</button>
                            </div>
                        </div>
                    `).join('');
                }
            }

            if (actionsEl) {
                actionsEl.style.display = voiceNotePhotos.length > 0 ? 'block' : 'none';
            }
        }

        function removeVoiceNote(id) {
            voiceNotePhotos = voiceNotePhotos.filter(n => n.id !== id);
            updateVoiceNotesUI();
        }

        function processVoiceNotes() {
            document.getElementById('voiceNoteModal')?.remove();

            // Add to pending dictations
            voiceNotePhotos.forEach(note => {
                pendingDictations.push({
                    id: note.id,
                    chapeta: note.transcription || '',
                    peso: '',
                    condicion: '',
                    observaciones: 'Nota de voz grabada - escuchar audio para completar',
                    hasPhoto: true,
                    photoData: note.photoData,
                    audioUrl: note.audioUrl,
                    timestamp: note.timestamp
                });
            });

            voiceNotePhotos = [];
            updatePendingDictationsUI();

            showToast(`üìù ${pendingDictations.length} notas agregadas a pendientes`, 'success');
            document.getElementById('pendingDictationsSection')?.scrollIntoView({ behavior: 'smooth' });
        }

        // ==================== END VOICE DICTATION MODULE ====================

        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = 'toast ' + type;
            toast.innerHTML = `<span>${message}</span>`;
            container.appendChild(toast);

            setTimeout(() => {
                toast.style.animation = 'slideIn 0.3s ease reverse';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }
    </script>
</body>
</html>
