<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Ganado Finca">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#2e7d32">
    <meta name="description" content="Sistema de Gesti√≥n Ganadera para Fincas">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%232e7d32' width='100' height='100' rx='20'/><text x='50' y='65' font-size='50' text-anchor='middle' fill='white'>üêÇ</text></svg>">
    <title>Ganado Finca - Sistema de Gesti√≥n</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary: #2d5016;
            --primary-light: #4a7c23;
            --primary-dark: #1a3009;
            --accent: #8b4513;
            --success: #28a745;
            --warning: #ffc107;
            --danger: #dc3545;
            --info: #17a2b8;
            --light: #f8f9fa;
            --dark: #343a40;
            --white: #ffffff;
            --gray: #6c757d;
            --border: #dee2e6;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            min-height: 100vh;
        }
        
        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 1rem 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 1.5rem;
            font-weight: bold;
        }
        
        .logo-icon {
            font-size: 2rem;
        }
        
        .header-stats {
            display: flex;
            gap: 2rem;
            font-size: 0.9rem;
        }
        
        .header-stat {
            text-align: center;
        }
        
        .header-stat-value {
            font-size: 1.25rem;
            font-weight: bold;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 1.5rem;
        }
        
        /* Navigation Tabs */
        .nav-tabs {
            display: flex;
            gap: 0.5rem;
            background: var(--white);
            padding: 0.5rem;
            border-radius: 12px;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            flex-wrap: wrap;
        }
        
        .nav-tab {
            padding: 0.75rem 1.25rem;
            border: none;
            background: transparent;
            cursor: pointer;
            border-radius: 8px;
            font-size: 0.95rem;
            font-weight: 500;
            color: var(--gray);
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .nav-tab:hover {
            background: var(--light);
            color: var(--primary);
        }
        
        .nav-tab.active {
            background: var(--primary);
            color: white;
        }
        
        .nav-tab-icon {
            font-size: 1.1rem;
        }
        
        /* Tab Content */
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Cards */
        .card {
            background: var(--white);
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 1.5rem;
            overflow: hidden;
        }
        
        .card-header {
            background: linear-gradient(135deg, var(--primary-light) 0%, var(--primary) 100%);
            color: white;
            padding: 1rem 1.5rem;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .card-header.compras { background: linear-gradient(135deg, #4CAF50, #2E7D32); }
        .card-header.nacimientos { background: linear-gradient(135deg, #2196F3, #1565C0); }
        .card-header.ventas { background: linear-gradient(135deg, #FF9800, #E65100); }
        .card-header.muertes { background: linear-gradient(135deg, #607D8B, #37474F); }
        
        .card-body {
            padding: 1.5rem;
        }
        
        /* Event Type Cards */
        .event-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .event-card {
            background: var(--white);
            border-radius: 12px;
            padding: 1.5rem;
            cursor: pointer;
            transition: all 0.3s;
            border: 3px solid transparent;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .event-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        }
        
        .event-card.compras { border-color: #4CAF50; }
        .event-card.compras:hover { background: #E8F5E9; }
        .event-card.nacimientos { border-color: #2196F3; }
        .event-card.nacimientos:hover { background: #E3F2FD; }
        .event-card.ventas { border-color: #FF9800; }
        .event-card.ventas:hover { background: #FFF3E0; }
        .event-card.muertes { border-color: #607D8B; }
        .event-card.muertes:hover { background: #ECEFF1; }
        
        .event-card-icon {
            font-size: 2.5rem;
            margin-bottom: 0.75rem;
        }
        
        .event-card-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 0.5rem;
        }
        
        .event-card-desc {
            color: var(--gray);
            font-size: 0.9rem;
        }
        
        /* Forms */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }
        
        .form-group {
            margin-bottom: 1rem;
        }
        
        .form-group.full-width {
            grid-column: 1 / -1;
        }
        
        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--dark);
        }
        
        .form-label .required {
            color: var(--danger);
        }
        
        .form-input, .form-select {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.2s;
        }
        
        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: var(--primary);
        }
        
        .form-hint {
            font-size: 0.8rem;
            color: var(--gray);
            margin-top: 0.25rem;
        }
        
        .form-calculated {
            background: #f0f7f0;
            font-weight: 600;
            color: var(--primary);
        }
        
        /* Buttons */
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .btn-primary {
            background: var(--primary);
            color: white;
        }
        
        .btn-primary:hover {
            background: var(--primary-dark);
        }
        
        .btn-success {
            background: var(--success);
            color: white;
        }
        
        .btn-success:hover {
            background: #218838;
        }
        
        .btn-warning {
            background: var(--warning);
            color: var(--dark);
        }
        
        .btn-danger {
            background: var(--danger);
            color: white;
        }
        
        .btn-danger:hover {
            background: #c82333;
        }
        
        .btn-secondary {
            background: var(--gray);
            color: white;
        }
        
        .btn-outline {
            background: transparent;
            border: 2px solid var(--primary);
            color: var(--primary);
        }
        
        .btn-outline:hover {
            background: var(--primary);
            color: white;
        }
        
        .btn-group {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
            margin-top: 1rem;
        }
        
        /* Tables */
        .table-container {
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }
        
        th {
            background: var(--light);
            font-weight: 600;
            color: var(--dark);
            white-space: nowrap;
        }
        
        th.sortable {
            cursor: pointer;
            user-select: none;
            position: relative;
            padding-right: 1.5rem;
        }
        
        th.sortable:hover {
            background: #e9ecef;
        }
        
        th.sortable::after {
            content: '‚áÖ';
            position: absolute;
            right: 0.5rem;
            opacity: 0.3;
            font-size: 0.8rem;
        }
        
        th.sortable.asc::after {
            content: '‚Üë';
            opacity: 1;
            color: var(--primary);
        }
        
        th.sortable.desc::after {
            content: '‚Üì';
            opacity: 1;
            color: var(--primary);
        }
        
        tr:hover {
            background: #f8fff8;
        }
        
        .text-right {
            text-align: right;
        }
        
        .text-center {
            text-align: center;
        }
        
        /* Status badges */
        .badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        .badge-success { background: #d4edda; color: #155724; }
        .badge-warning { background: #fff3cd; color: #856404; }
        .badge-danger { background: #f8d7da; color: #721c24; }
        .badge-info { background: #d1ecf1; color: #0c5460; }
        .badge-secondary { background: #e2e3e5; color: #383d41; }
        
        /* Summary boxes */
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .summary-box {
            background: var(--white);
            border-radius: 12px;
            padding: 1.25rem;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .summary-box-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }
        
        .summary-box-value {
            font-size: 1.75rem;
            font-weight: bold;
            color: var(--primary);
        }
        
        .summary-box-label {
            color: var(--gray);
            font-size: 0.85rem;
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: var(--white);
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--gray);
        }
        
        .modal-body {
            padding: 1.5rem;
        }
        
        .modal-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
        }
        
        /* Toast notifications */
        .toast-container {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 2000;
        }
        
        .toast {
            background: var(--dark);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            margin-bottom: 0.5rem;
            animation: slideIn 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .toast.success { background: var(--success); }
        .toast.error { background: var(--danger); }
        .toast.warning { background: var(--warning); color: var(--dark); }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        /* Animal selector */
        .animal-selector {
            max-height: 300px;
            overflow-y: auto;
            border: 2px solid var(--border);
            border-radius: 8px;
            margin-bottom: 1rem;
        }
        
        .animal-option {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .animal-option:hover {
            background: var(--light);
        }
        
        .animal-option.selected {
            background: #e8f5e9;
            border-left: 4px solid var(--primary);
        }
        
        .animal-option:last-child {
            border-bottom: none;
        }
        
        /* Filters */
        .filters {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .filters .form-input,
        .filters .form-select {
            width: auto;
            min-width: 150px;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .header-stats {
                display: none;
            }
            
            .nav-tabs {
                justify-content: center;
            }
            
            .nav-tab {
                padding: 0.5rem 0.75rem;
                font-size: 0.85rem;
            }
            
            .nav-tab span:not(.nav-tab-icon) {
                display: none;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
        }
        
        /* Print styles */
        @media print {
            .header, .nav-tabs, .btn, .filters {
                display: none !important;
            }
            
            .card {
                box-shadow: none;
                border: 1px solid #ddd;
            }
        }
        
        /* Camera styles */
        .camera-container {
            background: #000;
            border-radius: 12px;
            overflow: hidden;
            position: relative;
            margin-bottom: 1rem;
        }
        
        .camera-preview {
            width: 100%;
            max-height: 400px;
            object-fit: contain;
            display: block;
        }
        
        .camera-controls {
            display: flex;
            justify-content: center;
            gap: 1rem;
            padding: 1rem;
            background: rgba(0,0,0,0.8);
        }
        
        .camera-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: 3px solid white;
            background: transparent;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
            transition: all 0.2s;
        }
        
        .camera-btn:hover {
            background: rgba(255,255,255,0.2);
        }
        
        .camera-btn.capture {
            background: #f44336;
            border-color: #f44336;
        }
        
        .camera-btn.capture:hover {
            background: #d32f2f;
        }
        
        .photo-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 0.5rem;
            margin-top: 1rem;
        }
        
        .photo-thumbnail {
            position: relative;
            aspect-ratio: 1;
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
            border: 2px solid var(--border);
        }
        
        .photo-thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .photo-thumbnail .delete-photo {
            position: absolute;
            top: 4px;
            right: 4px;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: rgba(244, 67, 54, 0.9);
            color: white;
            border: none;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .photo-thumbnail .photo-label {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0,0,0,0.7);
            color: white;
            font-size: 0.7rem;
            padding: 2px 4px;
            text-align: center;
        }
        
        .photo-type-selector {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
            flex-wrap: wrap;
        }
        
        .photo-type-btn {
            padding: 0.5rem 1rem;
            border: 2px solid var(--border);
            border-radius: 20px;
            background: white;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s;
        }
        
        .photo-type-btn:hover {
            border-color: var(--primary);
        }
        
        .photo-type-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        .photo-type-btn.has-photo {
            background: #e8f5e9;
            border-color: var(--success);
        }
        
        /* Fullscreen photo viewer */
        .photo-viewer {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.95);
            z-index: 3000;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }
        
        .photo-viewer.active {
            display: flex;
        }
        
        .photo-viewer img {
            max-width: 95%;
            max-height: 85%;
            object-fit: contain;
        }
        
        .photo-viewer-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            color: white;
            font-size: 2rem;
            cursor: pointer;
        }
        
        .photo-viewer-info {
            color: white;
            margin-top: 1rem;
            text-align: center;
        }
        
        .photo-viewer-nav {
            display: flex;
            gap: 2rem;
            margin-top: 1rem;
        }
        
        .photo-viewer-nav button {
            background: rgba(255,255,255,0.2);
            border: 2px solid white;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
        }
        
        .photo-viewer-nav button:hover {
            background: rgba(255,255,255,0.3);
        }
        
        /* Mobile camera input styling */
        .camera-input-wrapper {
            position: relative;
            display: inline-block;
        }
        
        .camera-input-wrapper input[type="file"] {
            position: absolute;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }
        
        /* AI Analytics Styles */
        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.7; }
        }
        
        #aiResponseContent {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        #aiResponseContent h3 {
            color: #9c27b0;
            margin-top: 1rem;
            margin-bottom: 0.5rem;
        }
        
        #aiResponseContent ul {
            margin: 0.5rem 0;
            padding-left: 1.5rem;
        }
        
        #aiResponseContent li {
            margin: 0.3rem 0;
        }
        
        #aiResponseContent strong {
            color: #2e7d32;
        }
        
        #aiResponseContent code {
            background: #f5f5f5;
            padding: 0.2rem 0.4rem;
            border-radius: 4px;
            font-size: 0.9em;
        }
        
        /* AI Provider Button Styles */
        .ai-provider-btn {
            padding: 0.75rem 1rem;
            border: 2px solid #ddd;
            background: #f5f5f5;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
        }
        
        .ai-provider-btn:hover {
            border-color: #999;
        }
        
        .ai-provider-btn.active {
            border-color: #4285f4;
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
            color: #1565c0;
        }
        
        #btnProviderAnthropic.active {
            border-color: #9c27b0;
            background: linear-gradient(135deg, #f3e5f5, #e1bee7);
            color: #7b1fa2;
        }
        
        /* Ranch Selector Styles */
        .ranch-selector-bar {
            background: linear-gradient(135deg, #37474f, #263238);
            padding: 0.5rem 1rem;
            position: sticky;
            top: 0;
            z-index: 1001;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        
        .ranch-selector-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            flex-wrap: wrap;
        }
        
        .ranch-label {
            color: white;
            font-weight: 500;
            font-size: 0.9rem;
        }
        
        .ranch-buttons {
            display: flex;
            gap: 0.5rem;
        }
        
        .ranch-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border: 2px solid transparent;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.3s ease;
            opacity: 0.7;
        }
        
        .ranch-btn:hover {
            opacity: 1;
            transform: translateY(-2px);
        }
        
        .ranch-btn.active {
            opacity: 1;
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        
        .ranch-icon {
            font-size: 1.2rem;
        }
        
        /* La Coru√±a - Orange Theme */
        .ranch-coruna {
            background: linear-gradient(135deg, #ff9800, #f57c00);
            color: white;
            border-color: #ff9800;
        }
        
        .ranch-coruna.active {
            border-color: #fff;
            box-shadow: 0 4px 12px rgba(255, 152, 0, 0.5);
        }
        
        /* Santa Catalina - Blue Theme */
        .ranch-catalina {
            background: linear-gradient(135deg, #1976d2, #1565c0);
            color: white;
            border-color: #1976d2;
        }
        
        .ranch-catalina.active {
            border-color: #fff;
            box-shadow: 0 4px 12px rgba(25, 118, 210, 0.5);
        }
        
        /* La Vega - Green Theme */
        .ranch-vega {
            background: linear-gradient(135deg, #4caf50, #2e7d32);
            color: white;
            border-color: #4caf50;
        }
        
        .ranch-vega.active {
            border-color: #fff;
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.5);
        }
        
        /* Dynamic header themes */
        .header.theme-coruna {
            background: linear-gradient(135deg, #ff9800, #e65100) !important;
        }
        
        .header.theme-catalina {
            background: linear-gradient(135deg, #1976d2, #0d47a1) !important;
        }
        
        .header.theme-vega {
            background: linear-gradient(135deg, #4caf50, #1b5e20) !important;
        }
        
        /* Active tab indicator color change */
        .theme-coruna-active .nav-tab.active {
            border-bottom-color: #ff9800 !important;
            color: #ff9800 !important;
        }
        
        .theme-catalina-active .nav-tab.active {
            border-bottom-color: #1976d2 !important;
            color: #1976d2 !important;
        }
        
        /* Animal Selector Styles */
        .animal-selector {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 0.5rem;
            max-height: 200px;
            overflow-y: auto;
            padding: 0.75rem;
            background: #f5f5f5;
            border-radius: 8px;
            border: 1px solid #ddd;
        }
        
        .animal-chip {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0.4rem 0.6rem;
            background: white;
            border: 2px solid #ddd;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        .animal-chip:hover {
            border-color: var(--primary);
            background: #e8f5e9;
        }
        
        .animal-chip.selected {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        .animal-chip.in-retiro {
            background: #ffebee;
            border-color: #e57373;
        }
        
        .animal-chip.in-retiro.selected {
            background: #e57373;
        }
        
        /* Modal Styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            padding: 1rem;
        }
        
        .modal-content {
            background: white;
            border-radius: 12px;
            width: 100%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.25rem;
            background: var(--primary);
            color: white;
            border-radius: 12px 12px 0 0;
            font-weight: 600;
        }
        
        .modal-close {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            line-height: 1;
        }
        
        .modal-body {
            padding: 1.25rem;
        }
        
        /* Potrero Card Styles */
        .potrero-card {
            background: white;
            border-radius: 12px;
            padding: 1rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-left: 5px solid #4caf50;
            transition: all 0.3s;
        }
        
        .potrero-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
        }
        
        .potrero-card.ocupado {
            border-left-color: #ff9800;
        }
        
        .potrero-card.descanso {
            border-left-color: #2196f3;
        }
        
        .potrero-card.mantenimiento {
            border-left-color: #9e9e9e;
        }
        
        .potrero-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.75rem;
        }
        
        .potrero-card-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #333;
        }
        
        .potrero-card-status {
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .potrero-card-status.disponible {
            background: #e8f5e9;
            color: #2e7d32;
        }
        
        .potrero-card-status.ocupado {
            background: #fff3e0;
            color: #e65100;
        }
        
        .potrero-card-status.descanso {
            background: #e3f2fd;
            color: #1565c0;
        }
        
        .potrero-card-status.mantenimiento {
            background: #f5f5f5;
            color: #616161;
        }
        
        .potrero-card-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
            font-size: 0.85rem;
            margin-bottom: 0.75rem;
        }
        
        .potrero-stat {
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }
        
        .potrero-card-footer {
            display: flex;
            gap: 0.5rem;
            padding-top: 0.75rem;
            border-top: 1px solid #eee;
        }
        
        .potrero-card-footer button {
            flex: 1;
            padding: 0.4rem;
            font-size: 0.8rem;
        }
        
        /* Alert Styles */
        .alert-item {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            padding: 0.75rem;
            background: #fff;
            border-radius: 8px;
            margin-bottom: 0.5rem;
            border-left: 4px solid #ff9800;
        }
        
        .alert-item.critical {
            border-left-color: #f44336;
            background: #ffebee;
        }
        
        .alert-item.warning {
            border-left-color: #ff9800;
            background: #fff3e0;
        }
        
        .alert-item.info {
            border-left-color: #2196f3;
            background: #e3f2fd;
        }
        
        .alert-icon {
            font-size: 1.3rem;
        }
        
        .alert-content {
            flex: 1;
        }
        
        .alert-title {
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        .alert-desc {
            font-size: 0.8rem;
            color: #666;
        }
        
        /* Animal Profile Styles */
        .profile-section {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        
        .profile-section-title {
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .profile-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.5rem;
        }
        
        .profile-item {
            display: flex;
            flex-direction: column;
        }
        
        .profile-item-label {
            font-size: 0.75rem;
            color: #666;
            text-transform: uppercase;
        }
        
        .profile-item-value {
            font-size: 1rem;
            font-weight: 500;
            color: #333;
        }
        
        .profile-item-value.large {
            font-size: 1.5rem;
            color: var(--primary);
        }
        
        /* Health Type Badge */
        .health-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.2rem 0.5rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        
        .health-badge.vacuna {
            background: #e8f5e9;
            color: #2e7d32;
        }
        
        .health-badge.desparasitacion {
            background: #fff3e0;
            color: #e65100;
        }
        
        .health-badge.tratamiento {
            background: #fce4ec;
            color: #c2185b;
        }
        
        .health-badge.revision {
            background: #f3e5f5;
            color: #7b1fa2;
        }
        
        /* Clickable row */
        .clickable-row {
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .clickable-row:hover {
            background: #e8f5e9 !important;
        }
    </style>
</head>
<body>
    <!-- Ranch Selector Bar -->
    <div class="ranch-selector-bar">
        <div class="ranch-selector-content">
            <span class="ranch-label">üè† Seleccionar Finca:</span>
            <div class="ranch-buttons">
                <button class="ranch-btn ranch-coruna" onclick="switchRanch('la_coruna')" id="btnRanchCoruna">
                    <span class="ranch-icon">üèîÔ∏è</span>
                    <span class="ranch-name">La Coru√±a</span>
                </button>
                <button class="ranch-btn ranch-catalina" onclick="switchRanch('santa_catalina')" id="btnRanchCatalina">
                    <span class="ranch-icon">‚õ™</span>
                    <span class="ranch-name">Santa Catalina</span>
                </button>
                <button class="ranch-btn ranch-vega" onclick="switchRanch('la_vega')" id="btnRanchVega">
                    <span class="ranch-icon">üåæ</span>
                    <span class="ranch-name">La Vega</span>
                </button>
            </div>
        </div>
    </div>

    <header class="header" id="mainHeader">
        <div class="header-content">
            <div class="logo">
                <span class="logo-icon">üêÇ</span>
                <span id="headerRanchName">Ganado Finca</span>
            </div>
            <div class="header-stats">
                <div class="header-stat">
                    <div class="header-stat-value" id="headerTotalAnimals">0</div>
                    <div>Animales</div>
                </div>
                <div class="header-stat">
                    <div class="header-stat-value" id="headerTotalKg">0</div>
                    <div>Kg Totales</div>
                </div>
                <div class="header-stat">
                    <div class="header-stat-value" id="headerTotalValue">$0</div>
                    <div>Valor Inventario</div>
                </div>
            </div>
        </div>
    </header>
    
    <div class="container">
        <!-- Navigation -->
        <nav class="nav-tabs">
            <button class="nav-tab active" data-tab="inicio">
                <span class="nav-tab-icon">üè†</span>
                <span>Inicio</span>
            </button>
            <button class="nav-tab" data-tab="eventos">
                <span class="nav-tab-icon">üìù</span>
                <span>Eventos</span>
            </button>
            <button class="nav-tab" data-tab="inventario">
                <span class="nav-tab-icon">üìä</span>
                <span>Inventario</span>
            </button>
            <button class="nav-tab" data-tab="salud">
                <span class="nav-tab-icon">üíâ</span>
                <span>Salud</span>
            </button>
            <button class="nav-tab" data-tab="potreros">
                <span class="nav-tab-icon">üåø</span>
                <span>Potreros</span>
            </button>
            <button class="nav-tab" data-tab="entradas">
                <span class="nav-tab-icon">üì•</span>
                <span>Entradas</span>
            </button>
            <button class="nav-tab" data-tab="salidas">
                <span class="nav-tab-icon">üì§</span>
                <span>Salidas</span>
            </button>
            <button class="nav-tab" data-tab="reportes">
                <span class="nav-tab-icon">üìà</span>
                <span>Reportes</span>
            </button>
            <button class="nav-tab" data-tab="fotos">
                <span class="nav-tab-icon">üì∑</span>
                <span>Fotos</span>
            </button>
            <button class="nav-tab" data-tab="analytics">
                <span class="nav-tab-icon">ü§ñ</span>
                <span>An√°lisis IA</span>
            </button>
            <button class="nav-tab" data-tab="config">
                <span class="nav-tab-icon">‚öôÔ∏è</span>
                <span>Config</span>
            </button>
        </nav>
        
        <!-- Tab: Inicio -->
        <div id="tab-inicio" class="tab-content active">
            <div class="summary-grid">
                <div class="summary-box">
                    <div class="summary-box-icon">üêÇ</div>
                    <div class="summary-box-value" id="summaryTotal">0</div>
                    <div class="summary-box-label">Total Animales</div>
                </div>
                <div class="summary-box">
                    <div class="summary-box-icon">‚ôÇÔ∏è</div>
                    <div class="summary-box-value" id="summaryMachos">0</div>
                    <div class="summary-box-label">Machos</div>
                </div>
                <div class="summary-box">
                    <div class="summary-box-icon">‚ôÄÔ∏è</div>
                    <div class="summary-box-value" id="summaryHembras">0</div>
                    <div class="summary-box-label">Hembras</div>
                </div>
                <div class="summary-box">
                    <div class="summary-box-icon">üí∞</div>
                    <div class="summary-box-value" id="summaryInversion">$0</div>
                    <div class="summary-box-label">Total Inventario</div>
                </div>
                <div class="summary-box">
                    <div class="summary-box-icon">‚öñÔ∏è</div>
                    <div class="summary-box-value" id="summaryKgTotal">0</div>
                    <div class="summary-box-label">Kg Totales</div>
                </div>
                <div class="summary-box">
                    <div class="summary-box-icon">üìä</div>
                    <div class="summary-box-value" id="summaryPrecioKg">$0</div>
                    <div class="summary-box-label">$/Kg</div>
                </div>
                <div class="summary-box">
                    <div class="summary-box-icon">üìè</div>
                    <div class="summary-box-value" id="summaryKgPromedio">0</div>
                    <div class="summary-box-label">Kg Promedio</div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <span>üìÇ Importar/Exportar Datos</span>
                </div>
                <div class="card-body">
                    <div class="btn-group">
                        <label class="btn btn-primary">
                            <span>üì•</span> Importar Excel
                            <input type="file" id="importExcel" accept=".xlsx,.xlsm,.xls" style="display:none">
                        </label>
                        <button class="btn btn-success" onclick="exportToExcel()">
                            <span>üì§</span> Exportar a Excel
                        </button>
                        <button class="btn btn-outline" onclick="exportToCSV()">
                            <span>üìÑ</span> Exportar CSV
                        </button>
                    </div>
                    <p class="form-hint" style="margin-top: 1rem;">
                        Importa tu archivo Excel con las hojas: Entradas, Salidas, Inventario
                    </p>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <span>üìÖ Actividad Reciente</span>
                </div>
                <div class="card-body">
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Fecha</th>
                                    <th>Tipo</th>
                                    <th>Chapeta</th>
                                    <th>Detalle</th>
                                </tr>
                            </thead>
                            <tbody id="recentActivity">
                                <tr><td colspan="4" class="text-center">No hay actividad reciente</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Tab: Eventos -->
        <div id="tab-eventos" class="tab-content">
            <h2 style="margin-bottom: 1.5rem; color: var(--dark);">Registrar Nuevo Evento</h2>
            
            <div class="event-cards">
                <div class="event-card compras" onclick="showEventForm('compra')">
                    <div class="event-card-icon">üõí</div>
                    <div class="event-card-title">COMPRA</div>
                    <div class="event-card-desc">Registrar compra de ganado nuevo</div>
                </div>
                
                <div class="event-card nacimientos" onclick="showEventForm('nacimiento')">
                    <div class="event-card-icon">üê£</div>
                    <div class="event-card-title">NACIMIENTO</div>
                    <div class="event-card-desc">Registrar nacimiento de ternero</div>
                </div>
                
                <div class="event-card ventas" onclick="showEventForm('venta')">
                    <div class="event-card-icon">üíµ</div>
                    <div class="event-card-title">VENTA</div>
                    <div class="event-card-desc">Registrar venta de ganado</div>
                </div>
                
                <div class="event-card muertes" onclick="showEventForm('muerte')">
                    <div class="event-card-icon">‚úùÔ∏è</div>
                    <div class="event-card-title">MUERTE</div>
                    <div class="event-card-desc">Registrar muerte/p√©rdida de animal</div>
                </div>
            </div>
            
            <!-- Form: Compra -->
            <div id="form-compra" class="card" style="display:none;">
                <div class="card-header compras">
                    <span>üõí Registrar Compra - Lote</span>
                    <button class="modal-close" onclick="hideEventForm('compra')" style="color:white;">√ó</button>
                </div>
                <div class="card-body">
                    <!-- Step 1: Lote Information (set once) -->
                    <div id="compraLoteInfo">
                        <h3 style="margin-bottom: 1rem; color: var(--primary);">üì¶ Paso 1: Informaci√≥n del Lote</h3>
                        <div class="form-hint" style="margin-bottom: 1rem;">Esta informaci√≥n aplica a todos los animales del lote</div>
                        
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">N√∫mero de Lote</label>
                                <input type="text" class="form-input" id="compraLote" readonly style="background: #e8f5e9; font-weight: bold;">
                                <div class="form-hint">Consecutivo autom√°tico</div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Cantidad de Animales <span class="required">*</span></label>
                                <input type="number" class="form-input" id="compraCantidadAnimales" required min="1" max="100" placeholder="ej: 6" style="font-size: 1.2rem; font-weight: bold;">
                                <div class="form-hint">¬øCu√°ntos animales en este lote?</div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Vendedor <span class="required">*</span></label>
                                <input type="text" class="form-input" id="compraVendedor" required list="vendedoresList" placeholder="ej: Alveiro Pineda">
                                <datalist id="vendedoresList"></datalist>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Precio/Kg del Lote <span class="required">*</span></label>
                                <input type="number" class="form-input" id="compraPrecioKilo" required min="1" step="1" placeholder="ej: 8500">
                                <div class="form-hint">Mismo precio para todos los animales</div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Fecha de Entrada <span class="required">*</span></label>
                                <input type="date" class="form-input" id="compraFecha" required>
                            </div>
                        </div>
                        
                        <button type="button" class="btn btn-primary" onclick="startLoteEntry()" style="width: 100%;">
                            ‚úÖ Confirmar Lote y Agregar Animales ‚Üí
                        </button>
                    </div>
                    
                    <!-- Step 2: Add Animals to Lote -->
                    <div id="compraAnimalesSection" style="display: none;">
                        <!-- Lote Summary Header -->
                        <div style="background: linear-gradient(135deg, #e8f5e9, #c8e6c9); padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">
                            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 0.5rem;">
                                <div>
                                    <strong style="font-size: 1.1rem;">üì¶ Lote <span id="loteNumeroDisplay">---</span></strong>
                                    <span style="margin-left: 1rem;" id="loteVendedorDisplay">---</span>
                                </div>
                                <div>
                                    <span id="lotePrecioDisplay">$---/kg</span> | 
                                    <span id="loteFechaDisplay">---</span>
                                </div>
                            </div>
                            <!-- Progress indicator -->
                            <div style="margin-top: 0.75rem; padding: 0.5rem; background: white; border-radius: 6px;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <span><strong id="loteProgressText">0 de 0</strong> animales agregados</span>
                                    <span id="loteProgressStatus" class="badge badge-warning">En progreso</span>
                                </div>
                                <div style="margin-top: 0.5rem; height: 8px; background: #e0e0e0; border-radius: 4px; overflow: hidden;">
                                    <div id="loteProgressBar" style="height: 100%; background: var(--primary); width: 0%; transition: width 0.3s;"></div>
                                </div>
                            </div>
                        </div>
                        
                        <h3 style="margin-bottom: 1rem; color: var(--primary);">üêÑ Paso 2: Agregar Animales</h3>
                        
                        <form id="compraAnimalForm" onsubmit="addAnimalToLote(event)">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="form-label">Chapeta <span class="required">*</span></label>
                                    <input type="text" class="form-input" id="compraNumero" required style="font-size: 1.2rem; font-weight: bold;">
                                    <div class="form-hint" id="compraChapetaHint">Autom√°tico</div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Raza <span class="required">*</span></label>
                                    <select class="form-select" id="compraRaza" required>
                                        <option value="Ceb√∫">Ceb√∫</option>
                                        <option value="Razuno">Razuno</option>
                                        <option value="Brangus">Brangus</option>
                                        <option value="Ceb√∫/Europeo">Ceb√∫/Europeo</option>
                                        <option value="Simbra">Simbra</option>
                                        <option value="Brahman">Brahman</option>
                                        <option value="Angus">Angus</option>
                                        <option value="Otra">Otra</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Sexo <span class="required">*</span></label>
                                    <select class="form-select" id="compraSexo" required>
                                        <option value="MACHO">‚ôÇÔ∏è MACHO</option>
                                        <option value="HEMBRA">‚ôÄÔ∏è HEMBRA</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Peso (kg) <span class="required">*</span></label>
                                    <input type="number" class="form-input" id="compraPeso" required min="1" step="0.1" placeholder="ej: 220" style="font-size: 1.1rem;">
                                </div>
                            </div>
                            
                            <div id="addAnimalBtnContainer">
                                <button type="submit" class="btn btn-success" id="btnAddAnimal" style="width: 100%;">
                                    ‚ûï Agregar Animal (<span id="animalCountRemaining">0</span> restantes)
                                </button>
                            </div>
                        </form>
                        
                        <!-- Animals in current lote -->
                        <div style="margin-top: 1.5rem;">
                            <h4 style="margin-bottom: 0.5rem;">
                                Animales en este Lote: <span id="loteAnimalCount">0</span>
                                <span style="font-weight: normal; color: var(--gray); margin-left: 1rem;">
                                    Total: <span id="loteTotalKg">0</span> kg | <span id="loteTotalCosto">$0</span>
                                </span>
                            </h4>
                            <div class="table-container" style="max-height: 250px; overflow-y: auto;">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>#</th>
                                            <th>Chapeta</th>
                                            <th>Raza</th>
                                            <th>Sexo</th>
                                            <th class="text-right">Peso</th>
                                            <th class="text-right">Costo</th>
                                            <th></th>
                                        </tr>
                                    </thead>
                                    <tbody id="loteAnimalesTable">
                                        <tr><td colspan="7" class="text-center" style="color: var(--gray);">A√∫n no hay animales en este lote</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <!-- Action buttons -->
                        <div style="margin-top: 1.5rem; padding-top: 1rem; border-top: 2px solid var(--border);">
                            <div style="display: flex; gap: 0.75rem; flex-wrap: wrap;">
                                <button type="button" class="btn btn-primary" id="btnFinalizarLote" onclick="finalizarLote()" style="flex: 2;" disabled>
                                    ‚úÖ Finalizar Lote y Guardar
                                </button>
                                <button type="button" class="btn btn-secondary" onclick="cancelarLote()">
                                    ‚ùå Cancelar Lote
                                </button>
                            </div>
                            <div id="finalizarLoteWarning" style="margin-top: 0.5rem; padding: 0.5rem; background: #fff3e0; border-radius: 6px; font-size: 0.9rem; display: none;">
                                ‚ö†Ô∏è <span id="finalizarWarningText">Debe agregar todos los animales antes de finalizar</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Form: Nacimiento -->
            <div id="form-nacimiento" class="card" style="display:none;">
                <div class="card-header nacimientos">
                    <span>üê£ Registrar Nacimiento</span>
                    <button class="modal-close" onclick="hideEventForm('nacimiento')" style="color:white;">√ó</button>
                </div>
                <div class="card-body">
                    <form id="nacimientoForm" onsubmit="saveNacimiento(event)">
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">N√∫mero (Chapeta) del Ternero <span class="required">*</span></label>
                                <input type="text" class="form-input" id="nacimientoNumero" required placeholder="ej: 300">
                                <div class="form-hint" id="nacimientoChapetaHint">Siguiente sugerido: ---</div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">N√∫mero Vaca (Madre) <span class="required">*</span></label>
                                <input type="text" class="form-input" id="nacimientoMadre" required list="vacasList" placeholder="ej: 150" oninput="autoFillMotherRaza()">
                                <datalist id="vacasList"></datalist>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Raza <span class="required">*</span></label>
                                <select class="form-select" id="nacimientoRaza" required>
                                    <option value="Ceb√∫">Ceb√∫</option>
                                    <option value="Razuno">Razuno</option>
                                    <option value="Brangus">Brangus</option>
                                    <option value="Ceb√∫/Europeo">Ceb√∫/Europeo</option>
                                    <option value="Simbra">Simbra</option>
                                    <option value="Brahman">Brahman</option>
                                    <option value="Angus">Angus</option>
                                    <option value="Cruce">Cruce</option>
                                    <option value="Otra">Otra</option>
                                </select>
                                <div class="form-hint" id="razaMotherHint"></div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Sexo <span class="required">*</span></label>
                                <select class="form-select" id="nacimientoSexo" required>
                                    <option value="MACHO">MACHO</option>
                                    <option value="HEMBRA">HEMBRA</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Peso al Nacer (kg)</label>
                                <input type="number" class="form-input" id="nacimientoPeso" min="1" step="0.1" placeholder="ej: 35">
                                <div class="form-hint">Peso t√≠pico: 25-40 kg</div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Fecha de Nacimiento <span class="required">*</span></label>
                                <input type="date" class="form-input" id="nacimientoFecha" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Lote</label>
                                <input type="text" class="form-input" id="nacimientoLote" placeholder="ej: NAC-01">
                            </div>
                        </div>
                        <div class="btn-group">
                            <button type="submit" class="btn btn-success">üíæ Guardar Nacimiento</button>
                            <button type="button" class="btn btn-primary" onclick="saveNacimientoAndContinue()">üíæ Guardar y Agregar Otro ‚Üí</button>
                            <button type="button" class="btn btn-secondary" onclick="hideEventForm('nacimiento')">Cancelar</button>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- Form: Venta -->
            <div id="form-venta" class="card" style="display:none;">
                <div class="card-header ventas">
                    <span>üíµ Registrar Venta</span>
                    <button class="modal-close" onclick="hideEventForm('venta')" style="color:white;">√ó</button>
                </div>
                <div class="card-body">
                    <!-- Step 1: Sale Information (set once) -->
                    <div id="ventaLoteInfo">
                        <h3 style="margin-bottom: 1rem; color: var(--warning);">üíµ Paso 1: Informaci√≥n de la Venta</h3>
                        <div class="form-hint" style="margin-bottom: 1rem;">Esta informaci√≥n aplica a todos los animales de esta venta</div>
                        
                        <!-- Transfer option -->
                        <div class="form-group full-width" style="margin-bottom: 1.5rem; padding: 1rem; background: #e3f2fd; border-radius: 8px; border-left: 4px solid #2196f3;">
                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; font-weight: 600;">
                                <input type="checkbox" id="ventaEsTransferencia" onchange="toggleTransferMode()" style="width: 20px; height: 20px;">
                                <span>üîÑ Transferencia entre fincas</span>
                            </label>
                            <div class="form-hint" style="margin-top: 0.5rem;">
                                Marque esta opci√≥n si est√° transfiriendo animales a otra finca propia
                            </div>
                        </div>
                        
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">Cantidad de Animales <span class="required">*</span></label>
                                <input type="number" class="form-input" id="ventaCantidadAnimales" required min="1" max="100" placeholder="ej: 6" style="font-size: 1.2rem; font-weight: bold;">
                                <div class="form-hint">¬øCu√°ntos animales vas a vender?</div>
                            </div>
                            
                            <!-- Normal sale fields -->
                            <div id="ventaNormalFields">
                                <div class="form-group">
                                    <label class="form-label">Comprador <span class="required">*</span></label>
                                    <input type="text" class="form-input" id="ventaComprador" list="compradoresList" placeholder="ej: Camilo Correa">
                                    <datalist id="compradoresList"></datalist>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Precio/Kg de Venta <span class="required">*</span></label>
                                    <input type="number" class="form-input" id="ventaPrecioKilo" min="1" step="1" placeholder="ej: 9500">
                                    <div class="form-hint">Mismo precio para todos los animales</div>
                                </div>
                            </div>
                            
                            <!-- Transfer fields -->
                            <div id="ventaTransferFields" style="display: none;">
                                <div class="form-group">
                                    <label class="form-label">Finca Destino <span class="required">*</span></label>
                                    <select class="form-select" id="ventaFincaDestino">
                                        <option value="">-- Seleccionar finca --</option>
                                    </select>
                                    <div class="form-hint">Finca que recibir√° los animales</div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Precio/Kg de Transferencia</label>
                                    <input type="number" class="form-input" id="ventaPrecioTransfer" min="0" step="1" placeholder="0" value="0">
                                    <div class="form-hint">Dejar en 0 para transferir al costo original</div>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Fecha de Venta/Transferencia <span class="required">*</span></label>
                                <input type="date" class="form-input" id="ventaFecha" required>
                            </div>
                        </div>
                        
                        <button type="button" class="btn btn-warning" onclick="startVentaEntry()" style="width: 100%; color: #333;">
                            ‚úÖ Confirmar y Seleccionar Animales ‚Üí
                        </button>
                    </div>
                    
                    <!-- Step 2: Select Animals for Sale -->
                    <div id="ventaAnimalesSection" style="display: none;">
                        <!-- Sale Summary Header -->
                        <div style="background: linear-gradient(135deg, #fff3e0, #ffe0b2); padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">
                            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 0.5rem;">
                                <div>
                                    <strong style="font-size: 1.1rem;">üíµ Venta a:</strong>
                                    <span style="margin-left: 0.5rem;" id="ventaCompradorDisplay">---</span>
                                </div>
                                <div>
                                    <span id="ventaPrecioDisplay">$---/kg</span> | 
                                    <span id="ventaFechaDisplay">---</span>
                                </div>
                            </div>
                            <!-- Progress indicator -->
                            <div style="margin-top: 0.75rem; padding: 0.5rem; background: white; border-radius: 6px;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <span><strong id="ventaProgressText">0 de 0</strong> animales seleccionados</span>
                                    <span id="ventaProgressStatus" class="badge badge-warning">En progreso</span>
                                </div>
                                <div style="margin-top: 0.5rem; height: 8px; background: #e0e0e0; border-radius: 4px; overflow: hidden;">
                                    <div id="ventaProgressBar" style="height: 100%; background: var(--warning); width: 0%; transition: width 0.3s;"></div>
                                </div>
                            </div>
                        </div>
                        
                        <h3 style="margin-bottom: 1rem; color: var(--warning);">üêÑ Paso 2: Seleccionar Animales</h3>
                        
                        <!-- Animal selector -->
                        <div class="form-group" id="ventaAnimalSelectorContainer">
                            <label class="form-label">Buscar Animal en Inventario</label>
                            <input type="text" class="form-input" id="ventaSearchLote" placeholder="Buscar por chapeta, lote, vendedor..." oninput="filterAnimalsForSaleLote()">
                        </div>
                        
                        <!-- Available animals grid -->
                        <div id="ventaAnimalSelectorLote" class="animal-selector" style="max-height: 200px; margin-bottom: 1rem;"></div>
                        
                        <!-- Add selected animal form -->
                        <div id="ventaAddAnimalForm" style="display: none; padding: 1rem; background: #f5f5f5; border-radius: 8px; margin-bottom: 1rem;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                                <strong>Animal seleccionado: <span id="ventaSelectedAnimalInfo">---</span></strong>
                                <button type="button" class="btn btn-secondary" style="padding: 0.25rem 0.5rem;" onclick="clearVentaSelection()">‚úï</button>
                            </div>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="form-label">Peso de Venta (kg) <span class="required">*</span></label>
                                    <input type="number" class="form-input" id="ventaPesoAnimal" required min="1" step="0.1" placeholder="Peso actual" style="font-size: 1.1rem;">
                                    <div class="form-hint" id="ventaPesoEstimadoHint">Peso estimado: --- kg</div>
                                </div>
                                <div class="form-group" style="display: flex; align-items: flex-end;">
                                    <button type="button" class="btn btn-success" id="btnAddAnimalVenta" onclick="addAnimalToVenta()">
                                        ‚ûï Agregar (<span id="ventaAnimalCountRemaining">0</span> restantes)
                                    </button>
                                </div>
                            </div>
                            <input type="hidden" id="ventaSelectedNumero">
                        </div>
                        
                        <!-- Animals in current sale -->
                        <div style="margin-top: 1rem;">
                            <h4 style="margin-bottom: 0.5rem;">
                                Animales en esta Venta: <span id="ventaAnimalCount">0</span>
                                <span style="font-weight: normal; color: var(--gray); margin-left: 1rem;">
                                    Total: <span id="ventaTotalKg">0</span> kg | <span id="ventaTotalVenta">$0</span>
                                </span>
                            </h4>
                            <div class="table-container" style="max-height: 250px; overflow-y: auto;">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>#</th>
                                            <th>Chapeta</th>
                                            <th>Lote Compra</th>
                                            <th>Raza</th>
                                            <th class="text-right">Peso Entrada</th>
                                            <th class="text-right">Peso Venta</th>
                                            <th class="text-right">Ganancia kg</th>
                                            <th class="text-right">Valor Venta</th>
                                            <th></th>
                                        </tr>
                                    </thead>
                                    <tbody id="ventaAnimalesTable">
                                        <tr><td colspan="9" class="text-center" style="color: var(--gray);">Selecciona animales del inventario</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <!-- Action buttons -->
                        <div style="margin-top: 1.5rem; padding-top: 1rem; border-top: 2px solid var(--border);">
                            <div style="display: flex; gap: 0.75rem; flex-wrap: wrap;">
                                <button type="button" class="btn btn-warning" id="btnFinalizarVenta" onclick="finalizarVenta()" style="flex: 2; color: #333;" disabled>
                                    ‚úÖ Finalizar Venta y Guardar
                                </button>
                                <button type="button" class="btn btn-secondary" onclick="cancelarVenta()">
                                    ‚ùå Cancelar
                                </button>
                            </div>
                            <div id="finalizarVentaWarning" style="margin-top: 0.5rem; padding: 0.5rem; background: #fff3e0; border-radius: 6px; font-size: 0.9rem; display: none;">
                                ‚ö†Ô∏è <span id="finalizarVentaWarningText">Debe seleccionar todos los animales antes de finalizar</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Form: Muerte -->
            <div id="form-muerte" class="card" style="display:none;">
                <div class="card-header muertes">
                    <span>‚úùÔ∏è Registrar Muerte</span>
                    <button class="modal-close" onclick="hideEventForm('muerte')" style="color:white;">√ó</button>
                </div>
                <div class="card-body">
                    <form id="muerteForm" onsubmit="saveMuerte(event)">
                        <div class="form-group">
                            <label class="form-label">Seleccionar Animal <span class="required">*</span></label>
                            <input type="text" class="form-input" id="muerteSearch" placeholder="Buscar por chapeta..." oninput="filterAnimalsForDeath()">
                            <div class="animal-selector" id="muerteAnimalSelector"></div>
                            <input type="hidden" id="muerteNumero" required>
                        </div>
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">Peso al Momento (kg)</label>
                                <input type="number" class="form-input" id="muertePeso" min="1" step="0.1" placeholder="Peso estimado">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Fecha de Muerte <span class="required">*</span></label>
                                <input type="date" class="form-input" id="muerteFecha" required>
                            </div>
                            <div class="form-group full-width">
                                <label class="form-label">Causa / Observaciones</label>
                                <input type="text" class="form-input" id="muerteCausa" placeholder="ej: Enfermedad, accidente, etc.">
                            </div>
                        </div>
                        <div class="btn-group">
                            <button type="submit" class="btn btn-danger">üíæ Registrar Muerte</button>
                            <button type="button" class="btn btn-secondary" onclick="hideEventForm('muerte')">Cancelar</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- Tab: Inventario -->
        <div id="tab-inventario" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <span>üìä Inventario Actual</span>
                    <button class="btn btn-outline" onclick="exportInventario()" style="padding: 0.5rem 1rem; font-size: 0.85rem;">
                        üì§ Exportar
                    </button>
                </div>
                <div class="card-body">
                    <div class="filters">
                        <input type="text" class="form-input" id="inventarioSearch" placeholder="Buscar chapeta..." oninput="filterInventario()">
                        <select class="form-select" id="inventarioSexoFilter" onchange="filterInventario()">
                            <option value="">Todos los sexos</option>
                            <option value="MACHO">Machos</option>
                            <option value="HEMBRA">Hembras</option>
                        </select>
                        <select class="form-select" id="inventarioVendedorFilter" onchange="filterInventario()">
                            <option value="">Todos los vendedores</option>
                        </select>
                    </div>
                    <div class="table-container">
                        <table id="inventarioTableContainer">
                            <thead>
                                <tr>
                                    <th class="sortable" data-sort="numero" data-type="number">Chapeta</th>
                                    <th class="sortable" data-sort="lote" data-type="text">Lote</th>
                                    <th class="sortable" data-sort="vendedor" data-type="text">Vendedor</th>
                                    <th class="sortable" data-sort="raza" data-type="text">Raza</th>
                                    <th class="sortable" data-sort="sexo" data-type="text">Sexo</th>
                                    <th class="sortable text-right" data-sort="peso" data-type="number">Peso Inicial</th>
                                    <th class="sortable text-right" data-sort="precioKilo" data-type="number">$/Kg</th>
                                    <th class="sortable" data-sort="fechaEntrada" data-type="date">Fecha</th>
                                    <th class="sortable text-right" data-sort="diasEnFinca" data-type="number">D√≠as</th>
                                    <th class="sortable text-right" data-sort="pesoEstimado" data-type="number">Peso Est.</th>
                                    <th class="text-center">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="inventarioTable">
                                <tr><td colspan="11" class="text-center">No hay datos</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Tab: Entradas -->
        <div id="tab-entradas" class="tab-content">
            <div class="card">
                <div class="card-header compras">
                    <span>üì• Historial de Entradas (Compras + Nacimientos)</span>
                </div>
                <div class="card-body">
                    <div class="filters" style="flex-wrap: wrap;">
                        <input type="text" class="form-input" id="entradasSearch" placeholder="Buscar..." oninput="filterEntradas()">
                        <select class="form-select" id="entradasTipoFilter" onchange="filterEntradas()">
                            <option value="">Todos los tipos</option>
                            <option value="compra">Compras</option>
                            <option value="nacimiento">Nacimientos</option>
                        </select>
                        <select class="form-select" id="entradasPeriodoFilter" onchange="handleEntradasPeriodoChange()" style="min-width: 150px;">
                            <option value="">Todos los registros</option>
                            <option value="ano_actual">üìÖ A√±o en curso</option>
                            <option value="ultimo_mes">üìÜ √öltimo mes</option>
                            <option value="ultimo_lote">üì¶ √öltimo lote</option>
                            <option value="ano_especifico">üóìÔ∏è A√±o espec√≠fico</option>
                            <option value="rango_fechas">üìä Rango de fechas</option>
                        </select>
                        <select class="form-select" id="entradasYearSelect" style="display:none; min-width: 100px;" onchange="filterEntradas()">
                            <option value="">Seleccionar a√±o</option>
                        </select>
                        <div id="entradasDateRange" style="display:none; display: flex; gap: 0.5rem; align-items: center;">
                            <input type="date" class="form-input" id="entradasDateFrom" onchange="filterEntradas()" style="width: auto;">
                            <span>a</span>
                            <input type="date" class="form-input" id="entradasDateTo" onchange="filterEntradas()" style="width: auto;">
                        </div>
                    </div>
                    <div class="table-container">
                        <table id="entradasTableContainer">
                            <thead>
                                <tr>
                                    <th class="sortable" data-sort="numero" data-type="number">Chapeta</th>
                                    <th class="sortable" data-sort="tipo" data-type="text">Tipo</th>
                                    <th class="sortable" data-sort="lote" data-type="text">Lote</th>
                                    <th class="sortable" data-sort="vendedor" data-type="text">Vendedor/Madre</th>
                                    <th class="sortable" data-sort="raza" data-type="text">Raza</th>
                                    <th class="sortable" data-sort="sexo" data-type="text">Sexo</th>
                                    <th class="sortable text-right" data-sort="peso" data-type="number">Peso</th>
                                    <th class="sortable text-right" data-sort="precioKilo" data-type="number">$/Kg</th>
                                    <th class="sortable" data-sort="fechaEntrada" data-type="date">Fecha</th>
                                    <th class="sortable text-right" data-sort="costoTotal" data-type="number">Costo</th>
                                    <th class="sortable" data-sort="estado" data-type="text">Estado</th>
                                </tr>
                            </thead>
                            <tbody id="entradasTable">
                                <tr><td colspan="11" class="text-center">No hay datos</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Tab: Salidas -->
        <div id="tab-salidas" class="tab-content">
            <div class="card">
                <div class="card-header ventas">
                    <span>üì§ Historial de Salidas (Ventas + Muertes)</span>
                </div>
                <div class="card-body">
                    <div class="filters" style="flex-wrap: wrap;">
                        <input type="text" class="form-input" id="salidasSearch" placeholder="Buscar..." oninput="filterSalidas()">
                        <select class="form-select" id="salidasTipoFilter" onchange="filterSalidas()">
                            <option value="">Todos los tipos</option>
                            <option value="venta">Ventas</option>
                            <option value="muerte">Muertes</option>
                        </select>
                        <select class="form-select" id="salidasPeriodoFilter" onchange="handleSalidasPeriodoChange()" style="min-width: 150px;">
                            <option value="">Todos los registros</option>
                            <option value="ano_actual">üìÖ A√±o en curso</option>
                            <option value="ultimo_mes">üìÜ √öltimo mes</option>
                            <option value="ano_especifico">üóìÔ∏è A√±o espec√≠fico</option>
                            <option value="rango_fechas">üìä Rango de fechas</option>
                        </select>
                        <select class="form-select" id="salidasYearSelect" style="display:none; min-width: 100px;" onchange="filterSalidas()">
                            <option value="">Seleccionar a√±o</option>
                        </select>
                        <div id="salidasDateRange" style="display:none; display: flex; gap: 0.5rem; align-items: center;">
                            <input type="date" class="form-input" id="salidasDateFrom" onchange="filterSalidas()" style="width: auto;">
                            <span>a</span>
                            <input type="date" class="form-input" id="salidasDateTo" onchange="filterSalidas()" style="width: auto;">
                        </div>
                    </div>
                    <div class="table-container">
                        <table id="salidasTableContainer">
                            <thead>
                                <tr>
                                    <th class="sortable" data-sort="numero" data-type="number">Chapeta</th>
                                    <th class="sortable" data-sort="tipo" data-type="text">Tipo</th>
                                    <th class="sortable text-right" data-sort="peso" data-type="number">Peso</th>
                                    <th class="sortable" data-sort="fechaSalida" data-type="date">Fecha</th>
                                    <th class="sortable text-right" data-sort="precioKiloVenta" data-type="number">$/Kg</th>
                                    <th class="sortable" data-sort="comprador" data-type="text">Comprador</th>
                                    <th class="sortable text-right" data-sort="costoVenta" data-type="number">Valor</th>
                                    <th class="sortable text-right" data-sort="gananciaDay" data-type="number">GDP</th>
                                </tr>
                            </thead>
                            <tbody id="salidasTable">
                                <tr><td colspan="8" class="text-center">No hay datos</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Tab: Salud (Health & Treatments) -->
        <div id="tab-salud" class="tab-content">
            <div class="card">
                <div class="card-header" style="background: linear-gradient(135deg, #e91e63, #c2185b);">
                    <span>üíâ Gesti√≥n de Salud</span>
                </div>
                <div class="card-body">
                    <!-- Quick Stats -->
                    <div class="summary-grid" style="margin-bottom: 1.5rem;">
                        <div class="summary-box" style="background: linear-gradient(135deg, #e8f5e9, #c8e6c9);">
                            <div class="summary-box-icon">‚úÖ</div>
                            <div class="summary-box-value" id="saludVacunasAlDia">0</div>
                            <div class="summary-box-label">Vacunas al d√≠a</div>
                        </div>
                        <div class="summary-box" style="background: linear-gradient(135deg, #fff3e0, #ffe0b2);">
                            <div class="summary-box-icon">‚ö†Ô∏è</div>
                            <div class="summary-box-value" id="saludVacunasPendientes">0</div>
                            <div class="summary-box-label">Vacunas pendientes</div>
                        </div>
                        <div class="summary-box" style="background: linear-gradient(135deg, #fce4ec, #f8bbd9);">
                            <div class="summary-box-icon">üíä</div>
                            <div class="summary-box-value" id="saludEnTratamiento">0</div>
                            <div class="summary-box-label">En tratamiento</div>
                        </div>
                        <div class="summary-box" style="background: linear-gradient(135deg, #ffebee, #ffcdd2);">
                            <div class="summary-box-icon">üö´</div>
                            <div class="summary-box-value" id="saludEnRetiro">0</div>
                            <div class="summary-box-label">En periodo retiro</div>
                        </div>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div class="action-grid" style="margin-bottom: 1.5rem;">
                        <button class="action-btn" style="background: linear-gradient(135deg, #4caf50, #388e3c);" onclick="showSaludForm('vacuna')">
                            <span class="action-btn-icon">üíâ</span>
                            <span class="action-btn-label">Registrar Vacuna</span>
                        </button>
                        <button class="action-btn" style="background: linear-gradient(135deg, #ff9800, #f57c00);" onclick="showSaludForm('desparasitacion')">
                            <span class="action-btn-icon">üêõ</span>
                            <span class="action-btn-label">Desparasitaci√≥n</span>
                        </button>
                        <button class="action-btn" style="background: linear-gradient(135deg, #e91e63, #c2185b);" onclick="showSaludForm('tratamiento')">
                            <span class="action-btn-icon">üíä</span>
                            <span class="action-btn-label">Tratamiento</span>
                        </button>
                        <button class="action-btn" style="background: linear-gradient(135deg, #9c27b0, #7b1fa2);" onclick="showSaludForm('revision')">
                            <span class="action-btn-icon">ü©∫</span>
                            <span class="action-btn-label">Revisi√≥n Veterinaria</span>
                        </button>
                    </div>
                    
                    <!-- Health Registration Form (hidden by default) -->
                    <div id="saludFormContainer" style="display: none;">
                        <div class="card" style="border: 2px solid #e91e63; margin-bottom: 1.5rem;">
                            <div class="card-header" style="background: linear-gradient(135deg, #e91e63, #c2185b);">
                                <span id="saludFormTitle">üíâ Registrar Evento de Salud</span>
                                <button class="modal-close" onclick="hideSaludForm()" style="color:white;">√ó</button>
                            </div>
                            <div class="card-body">
                                <form id="saludForm" onsubmit="saveSaludEvento(event)">
                                    <input type="hidden" id="saludTipo" value="vacuna">
                                    
                                    <div class="form-group">
                                        <label class="form-label">Seleccionar Animales <span class="required">*</span></label>
                                        <div style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
                                            <button type="button" class="btn btn-secondary" onclick="selectAllAnimalsForSalud()">Seleccionar todos</button>
                                            <button type="button" class="btn btn-secondary" onclick="clearSaludSelection()">Limpiar selecci√≥n</button>
                                            <input type="text" class="form-input" id="saludSearchAnimal" placeholder="Buscar por chapeta..." oninput="filterAnimalsForSalud()" style="flex: 1;">
                                        </div>
                                        <div class="animal-selector" id="saludAnimalSelector" style="max-height: 150px;"></div>
                                        <div class="form-hint">Animales seleccionados: <strong id="saludSelectedCount">0</strong></div>
                                    </div>
                                    
                                    <div class="form-grid">
                                        <div class="form-group">
                                            <label class="form-label">Fecha <span class="required">*</span></label>
                                            <input type="date" class="form-input" id="saludFecha" required>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label" id="saludProductoLabel">Vacuna/Medicamento <span class="required">*</span></label>
                                            <input type="text" class="form-input" id="saludProducto" required list="productosSaludList" placeholder="ej: Aftosa, Carb√≥n, Ivermectina">
                                            <datalist id="productosSaludList">
                                                <option value="Fiebre Aftosa">
                                                <option value="Carb√≥n Sintom√°tico">
                                                <option value="Brucelosis">
                                                <option value="Rabia">
                                                <option value="Triple (Carb√≥n+Edema+Septicemia)">
                                                <option value="Ivermectina">
                                                <option value="Albendazol">
                                                <option value="Levamisol">
                                                <option value="Oxitetraciclina">
                                                <option value="Penicilina">
                                                <option value="Vitaminas ADE">
                                            </datalist>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Dosis</label>
                                            <input type="text" class="form-input" id="saludDosis" placeholder="ej: 5ml, 2 tabletas">
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Lote del Producto</label>
                                            <input type="text" class="form-input" id="saludLoteProducto" placeholder="Lote del fabricante">
                                        </div>
                                        <div class="form-group" id="saludRetiroGroup">
                                            <label class="form-label">D√≠as de Retiro</label>
                                            <input type="number" class="form-input" id="saludDiasRetiro" min="0" value="0" placeholder="0">
                                            <div class="form-hint">D√≠as antes de poder vender el animal</div>
                                        </div>
                                        <div class="form-group" id="saludProximaGroup">
                                            <label class="form-label">Pr√≥xima Aplicaci√≥n</label>
                                            <input type="date" class="form-input" id="saludProximaFecha">
                                            <div class="form-hint">Para vacunas con refuerzo</div>
                                        </div>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label class="form-label">Veterinario / Aplicador</label>
                                        <input type="text" class="form-input" id="saludVeterinario" placeholder="Nombre del veterinario o responsable">
                                    </div>
                                    
                                    <div class="form-group">
                                        <label class="form-label">Observaciones</label>
                                        <textarea class="form-input" id="saludObservaciones" rows="2" placeholder="Notas adicionales..."></textarea>
                                    </div>
                                    
                                    <button type="submit" class="btn btn-primary" style="width: 100%;">
                                        üíæ Guardar Registro de Salud
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Alerts Section -->
                    <div id="saludAlertas" class="card" style="margin-bottom: 1.5rem; display: none;">
                        <div class="card-header" style="background: linear-gradient(135deg, #ff9800, #f57c00);">
                            <span>‚ö†Ô∏è Alertas de Salud</span>
                        </div>
                        <div class="card-body" id="saludAlertasContent">
                        </div>
                    </div>
                    
                    <!-- Health History -->
                    <div class="card">
                        <div class="card-header">
                            <span>üìã Historial de Salud</span>
                        </div>
                        <div class="card-body">
                            <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem; flex-wrap: wrap;">
                                <input type="text" class="form-input" id="saludHistorialSearch" placeholder="Buscar..." oninput="filterSaludHistorial()" style="flex: 1; min-width: 150px;">
                                <select class="form-select" id="saludHistorialTipo" onchange="filterSaludHistorial()" style="width: auto;">
                                    <option value="">Todos los tipos</option>
                                    <option value="vacuna">üíâ Vacunas</option>
                                    <option value="desparasitacion">üêõ Desparasitaciones</option>
                                    <option value="tratamiento">üíä Tratamientos</option>
                                    <option value="revision">ü©∫ Revisiones</option>
                                </select>
                            </div>
                            <div class="table-container">
                                <table id="saludHistorialTable">
                                    <thead>
                                        <tr>
                                            <th>Fecha</th>
                                            <th>Tipo</th>
                                            <th>Producto</th>
                                            <th>Animales</th>
                                            <th>Retiro</th>
                                            <th>Pr√≥xima</th>
                                        </tr>
                                    </thead>
                                    <tbody id="saludHistorialBody">
                                        <tr><td colspan="6" class="text-center">No hay registros de salud</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Tab: Potreros (Paddock Rotation) -->
        <div id="tab-potreros" class="tab-content">
            <div class="card">
                <div class="card-header" style="background: linear-gradient(135deg, #4caf50, #2e7d32);">
                    <span>üåø Gesti√≥n de Potreros</span>
                </div>
                <div class="card-body">
                    <!-- Quick Stats -->
                    <div class="summary-grid" style="margin-bottom: 1.5rem;">
                        <div class="summary-box" style="background: linear-gradient(135deg, #e8f5e9, #c8e6c9);">
                            <div class="summary-box-icon">üåø</div>
                            <div class="summary-box-value" id="potrerosTotal">0</div>
                            <div class="summary-box-label">Potreros</div>
                        </div>
                        <div class="summary-box" style="background: linear-gradient(135deg, #fff3e0, #ffe0b2);">
                            <div class="summary-box-icon">üêÑ</div>
                            <div class="summary-box-value" id="potrerosOcupados">0</div>
                            <div class="summary-box-label">Ocupados</div>
                        </div>
                        <div class="summary-box" style="background: linear-gradient(135deg, #e3f2fd, #bbdefb);">
                            <div class="summary-box-icon">üå±</div>
                            <div class="summary-box-value" id="potrerosDescansando">0</div>
                            <div class="summary-box-label">En descanso</div>
                        </div>
                        <div class="summary-box" style="background: linear-gradient(135deg, #c8e6c9, #a5d6a7);">
                            <div class="summary-box-icon">‚úÖ</div>
                            <div class="summary-box-value" id="potrerosListos">0</div>
                            <div class="summary-box-label">Listos (30+ d√≠as)</div>
                        </div>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div style="display: flex; gap: 0.75rem; margin-bottom: 1.5rem; flex-wrap: wrap;">
                        <button class="btn btn-primary" onclick="showPotreroForm()">
                            ‚ûï Agregar Potrero
                        </button>
                        <button class="btn btn-success" onclick="showMoverAnimalesForm()">
                            üîÑ Mover Animales
                        </button>
                    </div>
                    
                    <!-- Add Potrero Form (hidden by default) -->
                    <div id="potreroFormContainer" style="display: none;">
                        <div class="card" style="border: 2px solid #4caf50; margin-bottom: 1.5rem;">
                            <div class="card-header" style="background: linear-gradient(135deg, #4caf50, #2e7d32);">
                                <span id="potreroFormTitle">‚ûï Agregar Potrero</span>
                                <button class="modal-close" onclick="hidePotreroForm()" style="color:white;">√ó</button>
                            </div>
                            <div class="card-body">
                                <form id="potreroForm" onsubmit="savePotrero(event)">
                                    <input type="hidden" id="potreroEditId" value="">
                                    <div class="form-grid">
                                        <div class="form-group">
                                            <label class="form-label">Nombre del Potrero <span class="required">*</span></label>
                                            <input type="text" class="form-input" id="potreroNombre" required placeholder="ej: Potrero Norte, Loma Alta">
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">√Årea (hect√°reas)</label>
                                            <input type="number" class="form-input" id="potreroArea" min="0" step="0.1" placeholder="ej: 5.5">
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Tipo de Pasto</label>
                                            <select class="form-select" id="potreroTipoPasto">
                                                <option value="Brachiaria">Brachiaria</option>
                                                <option value="Estrella">Estrella</option>
                                                <option value="Guinea">Guinea</option>
                                                <option value="Angleton">Angleton</option>
                                                <option value="Kikuyo">Kikuyo</option>
                                                <option value="Nativo">Nativo/Mixto</option>
                                                <option value="Otro">Otro</option>
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Capacidad (cabezas)</label>
                                            <input type="number" class="form-input" id="potreroCapacidad" min="1" placeholder="ej: 20">
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Agua Disponible</label>
                                            <select class="form-select" id="potreroAgua">
                                                <option value="quebrada">Quebrada/R√≠o</option>
                                                <option value="bebedero">Bebedero</option>
                                                <option value="jag√ºey">Jag√ºey/Estanque</option>
                                                <option value="pozo">Pozo</option>
                                                <option value="ninguna">Sin agua directa</option>
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Estado Actual</label>
                                            <select class="form-select" id="potreroEstado">
                                                <option value="disponible">üå± Disponible</option>
                                                <option value="ocupado">üêÑ Ocupado</option>
                                                <option value="descanso">üí§ En descanso</option>
                                                <option value="mantenimiento">üîß Mantenimiento</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Notas</label>
                                        <textarea class="form-input" id="potreroNotas" rows="2" placeholder="Caracter√≠sticas, mejoras necesarias, etc."></textarea>
                                    </div>
                                    <button type="submit" class="btn btn-success" style="width: 100%;">
                                        üíæ Guardar Potrero
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Move Animals Form (hidden by default) -->
                    <div id="moverAnimalesFormContainer" style="display: none;">
                        <div class="card" style="border: 2px solid #ff9800; margin-bottom: 1.5rem;">
                            <div class="card-header" style="background: linear-gradient(135deg, #ff9800, #f57c00);">
                                <span>üîÑ Mover Animales a Potrero</span>
                                <button class="modal-close" onclick="hideMoverAnimalesForm()" style="color:white;">√ó</button>
                            </div>
                            <div class="card-body">
                                <form id="moverAnimalesForm" onsubmit="moverAnimales(event)">
                                    <div class="form-grid">
                                        <div class="form-group">
                                            <label class="form-label">Desde Potrero</label>
                                            <select class="form-select" id="moverDesde" onchange="updateAnimalesEnPotrero()">
                                                <option value="">-- Sin potrero asignado --</option>
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Hacia Potrero <span class="required">*</span></label>
                                            <select class="form-select" id="moverHacia" required>
                                                <option value="">-- Seleccionar destino --</option>
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Fecha del Movimiento</label>
                                            <input type="date" class="form-input" id="moverFecha" required>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Seleccionar Animales a Mover</label>
                                        <div style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
                                            <button type="button" class="btn btn-secondary" onclick="selectAllAnimalesMover()">Todos</button>
                                            <button type="button" class="btn btn-secondary" onclick="clearMoverSelection()">Limpiar</button>
                                        </div>
                                        <div class="animal-selector" id="moverAnimalSelector" style="max-height: 200px;"></div>
                                        <div class="form-hint">Animales seleccionados: <strong id="moverSelectedCount">0</strong></div>
                                    </div>
                                    <button type="submit" class="btn btn-warning" style="width: 100%; color: #333;">
                                        üîÑ Mover Animales
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Potreros Grid -->
                    <div id="potrerosGrid" class="summary-grid" style="grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));">
                        <div class="text-center" style="grid-column: 1/-1; padding: 2rem; color: var(--gray);">
                            No hay potreros registrados. Haga clic en "Agregar Potrero" para comenzar.
                        </div>
                    </div>
                    
                    <!-- Rotation History -->
                    <div class="card" style="margin-top: 1.5rem;">
                        <div class="card-header">
                            <span>üìú Historial de Rotaci√≥n</span>
                        </div>
                        <div class="card-body">
                            <div class="table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Fecha</th>
                                            <th>Desde</th>
                                            <th>Hacia</th>
                                            <th>Animales</th>
                                            <th>D√≠as en potrero anterior</th>
                                        </tr>
                                    </thead>
                                    <tbody id="rotacionHistorialBody">
                                        <tr><td colspan="5" class="text-center">No hay movimientos registrados</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Animal Profile Modal -->
        <div id="animalProfileModal" class="modal" style="display: none;">
            <div class="modal-content" style="max-width: 700px;">
                <div class="modal-header" id="animalProfileHeader" style="background: linear-gradient(135deg, var(--primary), #1b5e20);">
                    <span id="animalProfileTitle">üêÇ Perfil del Animal</span>
                    <button class="modal-close" onclick="closeAnimalProfile()">√ó</button>
                </div>
                <div class="modal-body" id="animalProfileBody">
                    <!-- Content will be populated dynamically -->
                </div>
            </div>
        </div>
        
        <!-- Tab: Reportes -->
        <div id="tab-reportes" class="tab-content">
            <div class="summary-grid">
                <div class="summary-box">
                    <div class="summary-box-icon">üì•</div>
                    <div class="summary-box-value" id="reportTotalCompras">0</div>
                    <div class="summary-box-label">Total Compras</div>
                </div>
                <div class="summary-box">
                    <div class="summary-box-icon">üê£</div>
                    <div class="summary-box-value" id="reportTotalNacimientos">0</div>
                    <div class="summary-box-label">Total Nacimientos</div>
                </div>
                <div class="summary-box">
                    <div class="summary-box-icon">üíµ</div>
                    <div class="summary-box-value" id="reportTotalVentas">0</div>
                    <div class="summary-box-label">Total Ventas</div>
                </div>
                <div class="summary-box">
                    <div class="summary-box-icon">‚úùÔ∏è</div>
                    <div class="summary-box-value" id="reportTotalMuertes">0</div>
                    <div class="summary-box-label">Total Muertes</div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <span>üìä Resumen por Vendedor</span>
                </div>
                <div class="card-body">
                    <div class="table-container">
                        <table id="vendedoresTableContainer">
                            <thead>
                                <tr>
                                    <th class="sortable" data-sort="vendedor" data-type="text">Vendedor</th>
                                    <th class="sortable text-right" data-sort="count" data-type="number">Animales</th>
                                    <th class="sortable text-right" data-sort="kg" data-type="number">Kg Totales</th>
                                    <th class="sortable text-right" data-sort="inversion" data-type="number">Inversi√≥n</th>
                                    <th class="sortable text-right" data-sort="precioKg" data-type="number">$/Kg Promedio</th>
                                </tr>
                            </thead>
                            <tbody id="vendedoresReport">
                                <tr><td colspan="5" class="text-center">No hay datos</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <span>ü§ù Resumen por Comprador</span>
                </div>
                <div class="card-body">
                    <div class="table-container">
                        <table id="compradoresTableContainer">
                            <thead>
                                <tr>
                                    <th class="sortable" data-sort="comprador" data-type="text">Comprador</th>
                                    <th class="sortable text-right" data-sort="count" data-type="number">Animales</th>
                                    <th class="sortable text-right" data-sort="kg" data-type="number">Kg Totales</th>
                                    <th class="sortable text-right" data-sort="ingresos" data-type="number">Ingresos</th>
                                    <th class="sortable text-right" data-sort="gdp" data-type="number">GDP Promedio</th>
                                </tr>
                            </thead>
                            <tbody id="compradoresReport">
                                <tr><td colspan="5" class="text-center">No hay datos</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Tab: Fotos/Mediciones -->
        <div id="tab-fotos" class="tab-content">
            <!-- Summary Cards -->
            <div class="summary-grid">
                <div class="summary-box" style="border-left: 4px solid var(--danger);">
                    <div class="summary-box-icon">üî¥</div>
                    <div class="summary-box-value" id="fotosVencidas">0</div>
                    <div class="summary-box-label">Fotos Vencidas (&gt;90 d√≠as)</div>
                </div>
                <div class="summary-box" style="border-left: 4px solid var(--warning);">
                    <div class="summary-box-icon">üü°</div>
                    <div class="summary-box-value" id="fotosProntas">0</div>
                    <div class="summary-box-label">Pr√≥ximas (60-90 d√≠as)</div>
                </div>
                <div class="summary-box" style="border-left: 4px solid var(--success);">
                    <div class="summary-box-icon">üü¢</div>
                    <div class="summary-box-value" id="fotosAlDia">0</div>
                    <div class="summary-box-label">Al D√≠a (&lt;60 d√≠as)</div>
                </div>
                <div class="summary-box">
                    <div class="summary-box-icon">üì∑</div>
                    <div class="summary-box-value" id="totalSesiones">0</div>
                    <div class="summary-box-label">Total Sesiones</div>
                </div>
            </div>
            
            <!-- Register Photo Session -->
            <div class="card">
                <div class="card-header" style="background: linear-gradient(135deg, #9C27B0, #7B1FA2);">
                    <span>üì∑ Registrar Sesi√≥n de Fotos</span>
                </div>
                <div class="card-body">
                    <form id="fotoForm" onsubmit="saveFotoSesion(event)">
                        <!-- Step 1: Identify Animal by Chapeta -->
                        <div class="form-group" id="chapetaIdentificationStep">
                            <label class="form-label">üìç Paso 1: Identificar Animal</label>
                            <div class="form-hint" style="margin-bottom: 1rem;">
                                Toma foto de la chapeta (arete) o ingresa el n√∫mero manualmente.
                            </div>
                            
                            <div style="display: flex; gap: 1rem; flex-wrap: wrap; margin-bottom: 1rem;">
                                <!-- Chapeta photo capture -->
                                <div class="camera-input-wrapper">
                                    <button type="button" class="btn btn-primary" id="btnCaptureChapeta">
                                        üì∑ Foto de Chapeta
                                    </button>
                                    <input type="file" accept="image/*" capture="environment" onchange="handleChapetaCapture(event)">
                                </div>
                                <span style="align-self: center; color: var(--gray);">√≥</span>
                                <div style="flex: 1; min-width: 150px;">
                                    <input type="text" class="form-input" id="fotoNumeroManual" placeholder="Ingresar # chapeta" oninput="handleManualChapeta(event)">
                                </div>
                            </div>
                            
                            <!-- Chapeta photo preview -->
                            <div id="chapetaPreview" style="display: none; margin-bottom: 1rem;">
                                <div style="display: flex; align-items: center; gap: 1rem; padding: 1rem; background: #e8f5e9; border-radius: 8px;">
                                    <img id="chapetaPhotoImg" src="" style="width: 80px; height: 80px; object-fit: cover; border-radius: 8px; cursor: pointer;" onclick="viewPhoto(this.src, 'Foto de Chapeta')">
                                    <div style="flex: 1;">
                                        <div style="font-weight: 600; color: var(--primary);">‚úÖ Chapeta Capturada</div>
                                        <div style="font-size: 0.9rem; color: var(--gray);">Ingresa el n√∫mero de la chapeta:</div>
                                        <input type="text" class="form-input" id="fotoNumeroFromPhoto" placeholder="# chapeta visible en foto" style="margin-top: 0.5rem;" oninput="handleManualChapeta(event)">
                                    </div>
                                    <button type="button" class="btn btn-danger" style="padding: 0.5rem;" onclick="clearChapetaPhoto()">üóëÔ∏è</button>
                                </div>
                            </div>
                            
                            <!-- Animal info display (after identification) -->
                            <div id="animalInfoDisplay" style="display: none; padding: 1rem; background: #e3f2fd; border-radius: 8px; margin-bottom: 1rem;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <div style="font-size: 1.25rem; font-weight: bold;" id="animalInfoNumero">#---</div>
                                        <div style="font-size: 0.9rem; color: var(--gray);" id="animalInfoDetails">---</div>
                                    </div>
                                    <div id="animalInfoStatus"></div>
                                </div>
                            </div>
                            
                            <input type="hidden" id="fotoNumero" required>
                            <input type="hidden" id="chapetaPhotoData" value="">
                        </div>
                        
                        <!-- Step 2: Animal Photos (hidden until chapeta identified) -->
                        <div id="animalPhotosStep" style="display: none;">
                            <div class="form-group" style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 2px solid var(--border);">
                                <label class="form-label">üì∑ Paso 2: Fotos del Animal</label>
                                <div class="form-hint" style="margin-bottom: 0.75rem;">
                                    Toma fotos desde diferentes √°ngulos para mejor estimaci√≥n de peso.
                                </div>
                                
                                <!-- Reference type selector -->
                                <div class="form-group" style="margin-bottom: 1rem;">
                                    <label class="form-label" style="font-size: 0.9rem;">üìè Tipo de Referencia en Fotos</label>
                                    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                        <label class="ref-type-option" style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 0.75rem; background: #e8f5e9; border: 2px solid var(--success); border-radius: 8px; cursor: pointer;">
                                            <input type="radio" name="tipoReferencia" value="manga_calibrada" checked onchange="updateReferenciaHint()">
                                            <span>üöß Manga Calibrada</span>
                                        </label>
                                        <label class="ref-type-option" style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 0.75rem; background: #f5f5f5; border: 2px solid transparent; border-radius: 8px; cursor: pointer;">
                                            <input type="radio" name="tipoReferencia" value="vara_1m" onchange="updateReferenciaHint()">
                                            <span>üìè Vara 1m</span>
                                        </label>
                                        <label class="ref-type-option" style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 0.75rem; background: #f5f5f5; border: 2px solid transparent; border-radius: 8px; cursor: pointer;">
                                            <input type="radio" name="tipoReferencia" value="chapeta_only" onchange="updateReferenciaHint()">
                                            <span>üè∑Ô∏è Solo Chapeta</span>
                                        </label>
                                        <label class="ref-type-option" style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 0.75rem; background: #f5f5f5; border: 2px solid transparent; border-radius: 8px; cursor: pointer;">
                                            <input type="radio" name="tipoReferencia" value="ninguna" onchange="updateReferenciaHint()">
                                            <span>‚ùå Ninguna</span>
                                        </label>
                                    </div>
                                    <div class="form-hint" id="referenciaHint">‚úÖ Barras de la manga con marcas de altura para calibraci√≥n IA</div>
                                </div>
                                
                                <!-- Manga position selector (only visible when manga_calibrada selected) -->
                                <div id="mangaPositionSelector" style="display: flex; gap: 1rem; flex-wrap: wrap; margin-bottom: 1rem; padding: 0.75rem; background: #fff3e0; border-radius: 8px; font-size: 0.9rem;">
                                    <span style="font-weight: 500; color: var(--warning);">üöß Posici√≥n en Manga:</span>
                                    <label style="display: flex; align-items: center; gap: 0.25rem; cursor: pointer;">
                                        <input type="radio" name="posicionManga" value="entrada">
                                        <span>Entrada</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.25rem; cursor: pointer;">
                                        <input type="radio" name="posicionManga" value="centro" checked>
                                        <span>Centro ‚úì</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.25rem; cursor: pointer;">
                                        <input type="radio" name="posicionManga" value="salida">
                                        <span>Salida</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.25rem; cursor: pointer;">
                                        <input type="checkbox" id="marcasVisibles" checked>
                                        <span>Marcas visibles</span>
                                    </label>
                                </div>
                                
                                <!-- Reference visibility per photo -->
                                <div id="referenceCheckboxes" style="display: none; gap: 1rem; flex-wrap: wrap; margin-bottom: 1rem; padding: 0.75rem; background: #e3f2fd; border-radius: 8px; font-size: 0.9rem;">
                                    <span style="font-weight: 500; color: var(--primary);">üìè Referencia visible en:</span>
                                    <label style="display: flex; align-items: center; gap: 0.25rem; cursor: pointer;">
                                        <input type="checkbox" id="refVisibleLateral" checked>
                                        <span>Lateral</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.25rem; cursor: pointer;">
                                        <input type="checkbox" id="refVisibleTrasera" checked>
                                        <span>Trasera</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 0.25rem; cursor: pointer;">
                                        <input type="checkbox" id="refVisibleSuperior">
                                        <span>Superior</span>
                                    </label>
                                </div>
                                
                                <!-- Distance selector (hidden for manga, shown for vara) -->
                                <div class="form-group" id="distanciaSelector" style="display: none; margin-bottom: 1rem;">
                                    <label class="form-label" style="font-size: 0.9rem;">üìê Distancia Aproximada al Animal</label>
                                    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                        <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.4rem 0.75rem; background: #f5f5f5; border-radius: 8px; cursor: pointer; font-size: 0.9rem;">
                                            <input type="radio" name="distanciaFoto" value="2m">
                                            <span>2m</span>
                                        </label>
                                        <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.4rem 0.75rem; background: #e8f5e9; border: 2px solid var(--success); border-radius: 8px; cursor: pointer; font-size: 0.9rem;">
                                            <input type="radio" name="distanciaFoto" value="3m" checked>
                                            <span>3m ‚úì</span>
                                        </label>
                                        <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.4rem 0.75rem; background: #f5f5f5; border-radius: 8px; cursor: pointer; font-size: 0.9rem;">
                                            <input type="radio" name="distanciaFoto" value="4m">
                                            <span>4m</span>
                                        </label>
                                        <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.4rem 0.75rem; background: #f5f5f5; border-radius: 8px; cursor: pointer; font-size: 0.9rem;">
                                            <input type="radio" name="distanciaFoto" value="5m+">
                                            <span>5m+</span>
                                        </label>
                                    </div>
                                </div>
                                
                                <!-- Photo type selector -->
                                <div class="photo-type-selector">
                                    <button type="button" class="photo-type-btn active" data-type="lateral" onclick="setPhotoType('lateral')">
                                        üìê Lateral
                                    </button>
                                    <button type="button" class="photo-type-btn" data-type="trasera" onclick="setPhotoType('trasera')">
                                        üîô Trasera
                                    </button>
                                    <button type="button" class="photo-type-btn" data-type="superior" onclick="setPhotoType('superior')">
                                        ‚¨ÜÔ∏è Superior (opcional)
                                    </button>
                                </div>
                                
                                <!-- Camera capture buttons -->
                                <div style="display: flex; gap: 0.75rem; flex-wrap: wrap; margin-bottom: 1rem;">
                                    <div class="camera-input-wrapper">
                                        <button type="button" class="btn btn-primary">
                                            üì∑ Tomar Foto
                                        </button>
                                        <input type="file" accept="image/*" capture="environment" onchange="handlePhotoCapture(event)">
                                    </div>
                                    <div class="camera-input-wrapper">
                                        <button type="button" class="btn btn-outline">
                                            üñºÔ∏è Galer√≠a
                                        </button>
                                        <input type="file" accept="image/*" onchange="handlePhotoCapture(event)">
                                    </div>
                                </div>
                                
                                <!-- Photo preview grid -->
                                <div id="photoPreviewGrid" class="photo-grid"></div>
                                
                                <!-- Minimum photos indicator -->
                                <div id="photosProgressIndicator" style="margin-top: 0.75rem; padding: 0.5rem; background: #fff3e0; border-radius: 8px; font-size: 0.9rem;">
                                    <span id="photosProgressText">‚ö†Ô∏è M√≠nimo recomendado: 2 fotos (Lateral + Trasera)</span>
                                </div>
                            </div>
                            
                            <!-- Step 3: Additional Data -->
                            <div class="form-group" style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 2px solid var(--border);">
                                <label class="form-label">üìã Paso 3: Datos Adicionales</label>
                            </div>
                            
                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="form-label">Fecha de Sesi√≥n <span class="required">*</span></label>
                                    <input type="date" class="form-input" id="fotoFecha" required onchange="updateSeasonFromDate()">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Temporada <span class="required">*</span></label>
                                    <select class="form-select" id="fotoTemporada" required>
                                        <option value="lluvias_fuertes">üåßÔ∏è Lluvias Fuertes (Abr-May)</option>
                                        <option value="veranillo">üå§Ô∏è Veranillo (Jun-Ago)</option>
                                        <option value="lluvias">üåßÔ∏è Lluvias (Sep-Nov)</option>
                                        <option value="seco">‚òÄÔ∏è Seco/Verano (Dic-Mar)</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Condici√≥n Corporal (BCS) <span class="required">*</span></label>
                                    <select class="form-select" id="fotoBCS" required>
                                        <option value="1">1 - Muy Flaco (costillas muy visibles)</option>
                                        <option value="2">2 - Flaco (costillas visibles)</option>
                                        <option value="3" selected>3 - Normal (costillas palpables)</option>
                                        <option value="4">4 - Gordo (costillas no palpables)</option>
                                        <option value="5">5 - Obeso (grasa excesiva)</option>
                                    </select>
                                    <div class="form-hint">Body Condition Score: 1-5 escala est√°ndar</div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Calidad del Pasto</label>
                                    <select class="form-select" id="fotoPasto">
                                        <option value="excelente">üåø Excelente (abundante, verde)</option>
                                        <option value="bueno" selected>üå± Bueno (suficiente)</option>
                                        <option value="regular">üåæ Regular (escaso)</option>
                                        <option value="malo">ü•Ä Malo (muy escaso, seco)</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Peso Estimado Visual (kg)</label>
                                    <input type="number" class="form-input" id="fotoPesoVisual" min="50" max="800" step="5" placeholder="Tu estimaci√≥n">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Peso B√°scula (kg)</label>
                                    <input type="number" class="form-input" id="fotoPesoBascula" min="50" max="800" step="0.1" placeholder="Si pesaste">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Estado de Salud</label>
                                    <select class="form-select" id="fotoSalud">
                                        <option value="excelente">üíö Excelente</option>
                                        <option value="bueno" selected>üíô Bueno</option>
                                        <option value="regular">üíõ Regular</option>
                                        <option value="enfermo">‚ù§Ô∏è Enfermo/Tratamiento</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Observaciones</label>
                                <textarea class="form-input" id="fotoObservaciones" rows="2" placeholder="Notas adicionales..."></textarea>
                            </div>
                            
                            <input type="hidden" id="fotoNumFotos" value="0">
                            
                            <div class="btn-group">
                                <button type="submit" class="btn btn-success" id="btnSaveFotoSession">
                                    üíæ Guardar Sesi√≥n
                                </button>
                                <button type="button" class="btn btn-primary" onclick="saveAndNextAnimal()">
                                    üíæ Guardar y Siguiente Animal ‚Üí
                                </button>
                                <button type="button" class="btn btn-secondary" onclick="clearPhotoSession()">
                                    üóëÔ∏è Limpiar Todo
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- Animals Needing Photos -->
            <div class="card">
                <div class="card-header" style="background: linear-gradient(135deg, #f44336, #c62828);">
                    <span>‚ö†Ô∏è Animales que Necesitan Fotos</span>
                    <button class="btn btn-outline" onclick="exportFotosPendientes()" style="padding: 0.5rem 1rem; font-size: 0.85rem; color: white; border-color: white;">
                        üì§ Exportar Lista
                    </button>
                </div>
                <div class="card-body">
                    <div class="table-container">
                        <table id="fotosPendientesTableContainer">
                            <thead>
                                <tr>
                                    <th class="sortable" data-sort="numero" data-type="number">Chapeta</th>
                                    <th>Vendedor</th>
                                    <th class="sortable text-right" data-sort="diasSinFoto" data-type="number">D√≠as Sin Foto</th>
                                    <th>√öltima Foto</th>
                                    <th>√öltimo BCS</th>
                                    <th class="text-right">Peso Estimado</th>
                                    <th>Estado</th>
                                    <th class="text-center">Acci√≥n</th>
                                </tr>
                            </thead>
                            <tbody id="fotosPendientesTable">
                                <tr><td colspan="8" class="text-center">Cargando...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Photo Session History -->
            <div class="card">
                <div class="card-header" style="background: linear-gradient(135deg, #673AB7, #512DA8);">
                    <span>üìã Historial de Sesiones de Fotos</span>
                </div>
                <div class="card-body">
                    <div class="filters">
                        <input type="text" class="form-input" id="fotoHistorialSearch" placeholder="Buscar chapeta..." oninput="filterFotoHistorial()">
                        <select class="form-select" id="fotoTemporadaFilter" onchange="filterFotoHistorial()">
                            <option value="">Todas las temporadas</option>
                            <option value="lluvias_fuertes">üåßÔ∏è Lluvias Fuertes</option>
                            <option value="veranillo">üå§Ô∏è Veranillo</option>
                            <option value="lluvias">üåßÔ∏è Lluvias</option>
                            <option value="seco">‚òÄÔ∏è Seco</option>
                        </select>
                        <select class="form-select" id="fotoBCSFilter" onchange="filterFotoHistorial()">
                            <option value="">Todos los BCS</option>
                            <option value="1">BCS 1 - Muy Flaco</option>
                            <option value="2">BCS 2 - Flaco</option>
                            <option value="3">BCS 3 - Normal</option>
                            <option value="4">BCS 4 - Gordo</option>
                            <option value="5">BCS 5 - Obeso</option>
                        </select>
                    </div>
                    <div class="table-container">
                        <table id="fotoHistorialTableContainer">
                            <thead>
                                <tr>
                                    <th class="sortable" data-sort="numero" data-type="number">Chapeta</th>
                                    <th class="sortable" data-sort="fecha" data-type="date">Fecha</th>
                                    <th>Temporada</th>
                                    <th class="sortable text-center" data-sort="bcs" data-type="number">BCS</th>
                                    <th>Pasto</th>
                                    <th class="sortable text-right" data-sort="pesoVisual" data-type="number">Peso Visual</th>
                                    <th class="sortable text-right" data-sort="pesoBascula" data-type="number">Peso B√°scula</th>
                                    <th>Fotos</th>
                                    <th>Salud</th>
                                    <th class="text-center">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="fotoHistorialTable">
                                <tr><td colspan="10" class="text-center">No hay sesiones registradas</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- BCS Trends Chart -->
            <div class="card">
                <div class="card-header" style="background: linear-gradient(135deg, #00BCD4, #0097A7);">
                    <span>üìä Tendencias de Condici√≥n Corporal</span>
                </div>
                <div class="card-body">
                    <div class="form-group">
                        <label class="form-label">Seleccionar Animal para Ver Historial</label>
                        <select class="form-select" id="bcsChartAnimal" onchange="updateBCSChart()">
                            <option value="">-- Seleccionar Animal --</option>
                        </select>
                    </div>
                    <div id="bcsChartContainer" style="margin-top: 1rem;">
                        <div style="text-align: center; color: var(--gray); padding: 2rem;">
                            Selecciona un animal para ver su historial de condici√≥n corporal
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Season GDP Reference -->
            <div class="card">
                <div class="card-header">
                    <span>üìÖ GDP Estimado por Temporada (Referencia)</span>
                </div>
                <div class="card-body">
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Temporada</th>
                                    <th>Meses</th>
                                    <th class="text-right">GDP Estimado</th>
                                    <th>Calidad Pasto</th>
                                    <th>Notas</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr style="background: #ffebee;">
                                    <td>üåßÔ∏è <strong>Lluvias Fuertes</strong></td>
                                    <td>Abril - Mayo</td>
                                    <td class="text-right"><strong>0.22 kg/d√≠a</strong></td>
                                    <td><span class="badge badge-danger">Escaso</span></td>
                                    <td>Considerar suplementaci√≥n</td>
                                </tr>
                                <tr>
                                    <td>üåßÔ∏è <strong>Lluvias</strong></td>
                                    <td>Sept - Nov</td>
                                    <td class="text-right"><strong>0.36 kg/d√≠a</strong></td>
                                    <td><span class="badge badge-success">Bueno</span></td>
                                    <td>Buen crecimiento</td>
                                </tr>
                                <tr style="background: #e3f2fd;">
                                    <td>üå§Ô∏è <strong>Veranillo</strong></td>
                                    <td>Junio - Agosto</td>
                                    <td class="text-right"><strong>0.42 kg/d√≠a</strong></td>
                                    <td><span class="badge badge-success">Excelente</span></td>
                                    <td>M√°ximo crecimiento, pasto abundante</td>
                                </tr>
                                <tr style="background: #fff8e1;">
                                    <td>‚òÄÔ∏è <strong>Seco/Verano</strong></td>
                                    <td>Dic - Marzo</td>
                                    <td class="text-right"><strong>0.30 kg/d√≠a</strong></td>
                                    <td><span class="badge badge-warning">Regular</span></td>
                                    <td>Crecimiento moderado</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <p class="form-hint" style="margin-top: 1rem;">
                        <strong>Promedio anual calibrado:</strong> (2√ó0.42 + 3√ó0.30 + 3√ó0.36 + 4√ó0.22) √∑ 12 = <strong>0.31 kg/d√≠a</strong>
                    </p>
                </div>
            </div>
        </div>
        
        <!-- Tab: Analytics IA -->
        <div id="tab-analytics" class="tab-content">
            <div class="card">
                <div class="card-header" style="background: linear-gradient(135deg, #9c27b0, #7b1fa2);">
                    <span>ü§ñ An√°lisis con Inteligencia Artificial</span>
                </div>
                <div class="card-body">
                    <!-- API Provider Selection -->
                    <div id="apiKeySetup" class="card" style="border: 2px solid #9c27b0; margin-bottom: 1.5rem;">
                        <div class="card-header" style="background: linear-gradient(135deg, #9c27b0, #7b1fa2);">
                            <span>üîë Configurar Proveedor de IA</span>
                        </div>
                        <div class="card-body">
                            <!-- Provider Selection -->
                            <div class="form-group">
                                <label class="form-label">Seleccionar Proveedor</label>
                                <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
                                    <button type="button" class="btn ai-provider-btn active" id="btnProviderGoogle" onclick="selectAIProvider('google')" style="flex: 1;">
                                        <span style="font-size: 1.2rem;">üîµ</span> Google Gemini
                                    </button>
                                    <button type="button" class="btn ai-provider-btn" id="btnProviderAnthropic" onclick="selectAIProvider('anthropic')" style="flex: 1;">
                                        <span style="font-size: 1.2rem;">üü†</span> Anthropic Claude
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Google Gemini Config -->
                            <div id="googleConfig">
                                <p style="margin-bottom: 1rem; color: #666;">
                                    Usa tu cuenta de Google para obtener una API Key gratuita de Gemini.
                                    <a href="https://aistudio.google.com/app/apikey" target="_blank" style="color: #4285f4;">Obtener API Key de Google ‚Üí</a>
                                </p>
                                <div class="form-group">
                                    <label class="form-label">API Key de Google Gemini</label>
                                    <div style="display: flex; gap: 0.5rem;">
                                        <input type="password" class="form-input" id="googleApiKey" placeholder="AIza...">
                                        <button class="btn btn-primary" onclick="saveGoogleApiKey()" style="background: #4285f4;">
                                            üíæ Guardar
                                        </button>
                                    </div>
                                    <div class="form-hint">üí° Google ofrece un nivel gratuito generoso</div>
                                </div>
                                <div id="googleApiKeyStatus" style="margin-top: 0.5rem;"></div>
                            </div>
                            
                            <!-- Anthropic Claude Config -->
                            <div id="anthropicConfig" style="display: none;">
                                <p style="margin-bottom: 1rem; color: #666;">
                                    Para usar Claude, necesitas una API Key de Anthropic.
                                    <a href="https://console.anthropic.com/" target="_blank" style="color: #9c27b0;">Obtener API Key de Anthropic ‚Üí</a>
                                </p>
                                <div class="form-group">
                                    <label class="form-label">API Key de Anthropic</label>
                                    <div style="display: flex; gap: 0.5rem;">
                                        <input type="password" class="form-input" id="anthropicApiKey" placeholder="sk-ant-...">
                                        <button class="btn btn-primary" onclick="saveAnthropicApiKey()" style="background: #9c27b0;">
                                            üíæ Guardar
                                        </button>
                                    </div>
                                    <div class="form-hint">Los an√°lisis cuestan ~$0.01-0.05 cada uno</div>
                                </div>
                                <div id="anthropicApiKeyStatus" style="margin-top: 0.5rem;"></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Quick Stats Summary -->
                    <div class="summary-grid" style="margin-bottom: 1.5rem;">
                        <div class="summary-box" style="background: linear-gradient(135deg, #f3e5f5, #e1bee7);">
                            <div class="summary-box-icon">üìä</div>
                            <div class="summary-box-value" id="aiTotalAnimales">0</div>
                            <div class="summary-box-label">En Inventario</div>
                        </div>
                        <div class="summary-box" style="background: linear-gradient(135deg, #e8f5e9, #c8e6c9);">
                            <div class="summary-box-icon">üí∞</div>
                            <div class="summary-box-value" id="aiValorTotal">$0</div>
                            <div class="summary-box-label">Valor Estimado</div>
                        </div>
                        <div class="summary-box" style="background: linear-gradient(135deg, #e3f2fd, #bbdefb);">
                            <div class="summary-box-icon">üìà</div>
                            <div class="summary-box-value" id="aiGDPPromedio">0</div>
                            <div class="summary-box-label">GDP Promedio</div>
                        </div>
                        <div class="summary-box" style="background: linear-gradient(135deg, #fff3e0, #ffe0b2);">
                            <div class="summary-box-icon">‚öñÔ∏è</div>
                            <div class="summary-box-value" id="aiPesoPromedio">0</div>
                            <div class="summary-box-label">Peso Prom. Est.</div>
                        </div>
                    </div>
                    
                    <!-- Quick Analysis Buttons -->
                    <div class="card" style="margin-bottom: 1.5rem;">
                        <div class="card-header">
                            <span>‚ö° An√°lisis R√°pidos</span>
                        </div>
                        <div class="card-body">
                            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 0.75rem;">
                                <button class="btn btn-secondary" onclick="quickAnalysis('resumen')">
                                    üìã Resumen General
                                </button>
                                <button class="btn btn-secondary" onclick="quickAnalysis('listos_venta')">
                                    üíµ Animales Listos para Venta
                                </button>
                                <button class="btn btn-secondary" onclick="quickAnalysis('mejor_gdp')">
                                    üèÜ Mejor Rendimiento (GDP)
                                </button>
                                <button class="btn btn-secondary" onclick="quickAnalysis('rentabilidad')">
                                    üí∞ An√°lisis de Rentabilidad
                                </button>
                                <button class="btn btn-secondary" onclick="quickAnalysis('vendedores')">
                                    üë• Evaluaci√≥n de Vendedores
                                </button>
                                <button class="btn btn-secondary" onclick="quickAnalysis('compradores')">
                                    üõí An√°lisis de Compradores
                                </button>
                                <button class="btn btn-secondary" onclick="quickAnalysis('salud')">
                                    üíâ Estado de Salud del Hato
                                </button>
                                <button class="btn btn-secondary" onclick="quickAnalysis('potreros')">
                                    üåø Eficiencia de Potreros
                                </button>
                                <button class="btn btn-secondary" onclick="quickAnalysis('proyeccion')">
                                    üìÖ Proyecci√≥n 30/60/90 d√≠as
                                </button>
                                <button class="btn btn-secondary" onclick="quickAnalysis('recomendaciones')">
                                    üí° Recomendaciones
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Custom Question Input -->
                    <div class="card" style="margin-bottom: 1.5rem;">
                        <div class="card-header" style="background: linear-gradient(135deg, #9c27b0, #7b1fa2);">
                            <span>üí¨ Pregunta Personalizada</span>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label class="form-label">Escribe tu pregunta sobre los datos del ganado:</label>
                                <textarea class="form-input" id="aiCustomQuestion" rows="3" placeholder="Ejemplos:
- ¬øCu√°les animales tienen el mejor GDP y por qu√©?
- ¬øCu√°l es el margen de ganancia promedio por animal?
- ¬øQu√© vendedor me ha dado los animales m√°s rentables?
- ¬øCu√°nto dinero generar√© si vendo todos los animales listos?"></textarea>
                            </div>
                            <button class="btn btn-primary" onclick="askCustomQuestion()" style="width: 100%; background: linear-gradient(135deg, #9c27b0, #7b1fa2);">
                                ü§ñ Analizar con IA
                            </button>
                        </div>
                    </div>
                    
                    <!-- AI Response Area -->
                    <div class="card" id="aiResponseCard" style="display: none;">
                        <div class="card-header" style="background: linear-gradient(135deg, #4caf50, #388e3c);">
                            <span>üìä Resultado del An√°lisis</span>
                            <button class="btn btn-secondary" onclick="copyAnalysis()" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;">
                                üìã Copiar
                            </button>
                        </div>
                        <div class="card-body">
                            <div id="aiResponseContent" style="white-space: pre-wrap; line-height: 1.6;"></div>
                        </div>
                    </div>
                    
                    <!-- Loading Indicator -->
                    <div id="aiLoading" style="display: none; text-align: center; padding: 2rem;">
                        <div style="font-size: 3rem; animation: pulse 1s infinite;">ü§ñ</div>
                        <p style="color: #666; margin-top: 1rem;" id="aiLoadingText">Analizando datos con IA...</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Tab: Configuraci√≥n -->
        <div id="tab-config" class="tab-content">
            <!-- Weather Condition Selector -->
            <div class="card">
                <div class="card-header" style="background: linear-gradient(135deg, #2196F3, #1565C0);">
                    <span>üå¶Ô∏è Condiciones Clim√°ticas Actuales</span>
                </div>
                <div class="card-body">
                    <div class="form-hint" style="margin-bottom: 1rem; font-size: 0.95rem;">
                        Selecciona las condiciones clim√°ticas actuales de la finca. Esto afecta el GDP (Ganancia Diaria de Peso) usado para estimar el peso actual de los animales.
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
                        <label class="weather-option" style="display: flex; flex-direction: column; padding: 1rem; background: #fff; border: 3px solid #ddd; border-radius: 12px; cursor: pointer; transition: all 0.3s;">
                            <input type="radio" name="currentWeather" value="lluvias_fuertes" onchange="updateWeatherCondition()" style="margin-bottom: 0.5rem;">
                            <span style="font-size: 2rem; margin-bottom: 0.5rem;">üåßÔ∏è</span>
                            <strong>Lluvias Fuertes</strong>
                            <span style="color: var(--gray); font-size: 0.85rem;">Abril - Mayo</span>
                            <span style="color: var(--danger); font-weight: bold; margin-top: 0.5rem;">0.22 kg/d√≠a</span>
                        </label>
                        
                        <label class="weather-option" style="display: flex; flex-direction: column; padding: 1rem; background: #fff; border: 3px solid #ddd; border-radius: 12px; cursor: pointer; transition: all 0.3s;">
                            <input type="radio" name="currentWeather" value="lluvias" onchange="updateWeatherCondition()" style="margin-bottom: 0.5rem;">
                            <span style="font-size: 2rem; margin-bottom: 0.5rem;">üåßÔ∏è</span>
                            <strong>Lluvias</strong>
                            <span style="color: var(--gray); font-size: 0.85rem;">Sept - Nov</span>
                            <span style="color: var(--success); font-weight: bold; margin-top: 0.5rem;">0.36 kg/d√≠a</span>
                        </label>
                        
                        <label class="weather-option" style="display: flex; flex-direction: column; padding: 1rem; background: #fff; border: 3px solid #ddd; border-radius: 12px; cursor: pointer; transition: all 0.3s;">
                            <input type="radio" name="currentWeather" value="veranillo" onchange="updateWeatherCondition()" style="margin-bottom: 0.5rem;">
                            <span style="font-size: 2rem; margin-bottom: 0.5rem;">üå§Ô∏è</span>
                            <strong>Veranillo</strong>
                            <span style="color: var(--gray); font-size: 0.85rem;">Junio - Agosto</span>
                            <span style="color: var(--success); font-weight: bold; margin-top: 0.5rem;">0.42 kg/d√≠a</span>
                        </label>
                        
                        <label class="weather-option" style="display: flex; flex-direction: column; padding: 1rem; background: #fff; border: 3px solid #ddd; border-radius: 12px; cursor: pointer; transition: all 0.3s;">
                            <input type="radio" name="currentWeather" value="seco" onchange="updateWeatherCondition()" style="margin-bottom: 0.5rem;">
                            <span style="font-size: 2rem; margin-bottom: 0.5rem;">‚òÄÔ∏è</span>
                            <strong>Seco/Verano</strong>
                            <span style="color: var(--gray); font-size: 0.85rem;">Dic - Marzo</span>
                            <span style="color: var(--warning); font-weight: bold; margin-top: 0.5rem;">0.30 kg/d√≠a</span>
                        </label>
                    </div>
                    
                    <div id="weatherChangeInfo" style="padding: 1rem; background: #e3f2fd; border-radius: 8px; display: none;">
                        <strong>üìÖ √öltimo cambio:</strong> <span id="lastWeatherChange">-</span>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <span>‚öôÔ∏è Configuraci√≥n de la Finca</span>
                </div>
                <div class="card-body">
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">GDP Promedio (kg/d√≠a)</label>
                            <input type="number" class="form-input" id="configGDP" value="0.31" step="0.01" min="0.1" max="1" readonly style="background: #f5f5f5;">
                            <div class="form-hint">Calculado autom√°ticamente seg√∫n condiciones clim√°ticas</div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Precio Venta Estimado ($/kg)</label>
                            <input type="number" class="form-input" id="configPrecioVenta" value="9000" step="100" min="1000">
                            <div class="form-hint">Para calcular valor del inventario</div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Peso Objetivo Venta (kg)</label>
                            <input type="number" class="form-input" id="configPesoObjetivo" value="450" step="10" min="300">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Peso M√≠nimo Venta (kg)</label>
                            <input type="number" class="form-input" id="configPesoMinimo" value="380" step="10" min="200">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Intervalo de Fotos (d√≠as)</label>
                            <input type="number" class="form-input" id="configFotoIntervalo" value="90" step="15" min="30" max="180">
                            <div class="form-hint">D√≠as recomendados entre sesiones de fotos (90 = cada 3 meses)</div>
                        </div>
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="saveConfig()">üíæ Guardar Configuraci√≥n</button>
                        <button class="btn btn-danger" onclick="clearAllData()">üóëÔ∏è Borrar Todos los Datos</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Photo viewer modal -->
    <div class="photo-viewer" id="photoViewer" onclick="closePhotoViewer(event)">
        <button class="photo-viewer-close" onclick="closePhotoViewer()">&times;</button>
        <img id="photoViewerImg" src="" alt="Foto" onclick="event.stopPropagation()">
        <div class="photo-viewer-info" id="photoViewerInfo"></div>
        <div class="photo-viewer-nav" id="photoViewerNav" style="display: none;">
            <button onclick="event.stopPropagation(); navigatePhoto(-1)">‚Üê Anterior</button>
            <button onclick="event.stopPropagation(); navigatePhoto(1)">Siguiente ‚Üí</button>
        </div>
    </div>
    
    <!-- Toast container -->
    <div class="toast-container" id="toastContainer"></div>
    
    <script>
        // ==================== RANCH CONFIGURATION ====================
        const RANCHES = {
            la_coruna: {
                id: 'la_coruna',
                name: 'La Coru√±a',
                icon: 'üèîÔ∏è',
                theme: 'coruna',
                storageKey: 'ganadoFinca_LaCoruna'
            },
            santa_catalina: {
                id: 'santa_catalina',
                name: 'Santa Catalina',
                icon: '‚õ™',
                theme: 'catalina',
                storageKey: 'ganadoFinca_SantaCatalina'
            },
            la_vega: {
                id: 'la_vega',
                name: 'La Vega',
                icon: 'üåæ',
                theme: 'vega',
                storageKey: 'ganadoFinca_LaVega'
            }
        };
        
        // Current active ranch
        let currentRanch = 'la_coruna'; // Default to La Coru√±a
        
        // ==================== DATA STORAGE ====================
        let data = {
            entradas: [],  // Compras + Nacimientos
            salidas: [],   // Ventas + Muertes
            fotoSesiones: [], // Photo sessions for weight estimation
            saludEventos: [], // Health events (vaccines, treatments, etc.)
            potreros: [], // Paddocks/pastures
            rotaciones: [], // Paddock rotation history
            animalPotreros: {}, // Map of animal number -> current potrero
            weatherHistory: [], // Track weather condition changes over time
            config: {
                gdp: 0.31, // Default/average GDP
                precioVenta: 9000,
                pesoObjetivo: 450,
                pesoMinimo: 380,
                fotoIntervalo: 90, // Days between recommended photos
                currentWeather: 'lluvias', // Current weather condition
                gdpByWeather: {
                    'lluvias_fuertes': 0.22,
                    'lluvias': 0.36,
                    'veranillo': 0.42,
                    'seco': 0.30
                }
            }
        };
        
        // Sorting state for each table
        let sortState = {
            inventario: { column: null, direction: 'asc' },
            entradas: { column: null, direction: 'asc' },
            salidas: { column: null, direction: 'asc' },
            vendedores: { column: null, direction: 'asc' },
            compradores: { column: null, direction: 'asc' },
            fotoSesiones: { column: null, direction: 'asc' },
            saludHistorial: { column: null, direction: 'asc' }
        };
        
        // Selected animals for health/movement forms
        let selectedSaludAnimals = new Set();
        let selectedMoverAnimals = new Set();
        
        // ==================== INITIALIZATION ====================
        document.addEventListener('DOMContentLoaded', function() {
            // Load last selected ranch from localStorage
            const lastRanch = localStorage.getItem('ganadoFinca_lastRanch') || 'la_coruna';
            currentRanch = lastRanch;
            
            // Apply ranch theme and load data
            applyRanchTheme();
            loadData();
            initTabs();
            initForms();
            initSortableHeaders();
            updateAllViews();
            initConfigValues();
            
            document.getElementById('importExcel').addEventListener('change', handleExcelImport);
            
            // Set today's date as default
            const today = new Date().toISOString().split('T')[0];
            document.querySelectorAll('input[type="date"]').forEach(el => el.value = today);
            
            // Set season based on today's date for foto form
            updateSeasonFromDate();
        });
        
        // ==================== RANCH SWITCHING ====================
        function switchRanch(ranchId) {
            if (ranchId === currentRanch) return;
            
            try {
                // Check for unsaved work
                const hasUnsavedWork = currentLote && currentLote.animales && currentLote.animales.length > 0 || 
                                     currentVenta && currentVenta.animales && currentVenta.animales.length > 0;
                
                // Confirm if there's unsaved work
                if (hasUnsavedWork) {
                    if (!confirm('Hay datos sin guardar. ¬øCambiar de finca de todas formas?')) {
                        return;
                    }
                }
                
                // Save current ranch data before switching
                saveData();
                
                // Reset lote/venta workflows
                currentLote = { numero: null, vendedor: null, precioKilo: null, fecha: null, cantidadEsperada: 0, animales: [] };
                currentVenta = { comprador: null, precioKilo: null, fecha: null, cantidadEsperada: 0, animales: [], esTransferencia: false, fincaDestino: null };
                
                // Switch to new ranch
                currentRanch = ranchId;
                localStorage.setItem('ganadoFinca_lastRanch', ranchId);
                
                // Apply new theme and update UI
                applyRanchTheme();
                
                // Load new ranch data
                loadData();
                
                // Update all views
                updateAllViews();
                initConfigValues();
                
                // Reset any open forms
                document.querySelectorAll('[id^="form-"]').forEach(f => f.style.display = 'none');
                
                // Hide form containers
                const formContainers = ['saludFormContainer', 'potreroFormContainer', 'moverAnimalesFormContainer'];
                formContainers.forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.style.display = 'none';
                });
                
                // Show confirmation
                const ranch = RANCHES[ranchId];
                showToast(`${ranch.icon} Cambiado a ${ranch.name}`, 'success');
                
                console.log('Ranch switched successfully to:', ranchId);
            } catch (error) {
                console.error('Error switching ranch:', error);
                showToast('Error al cambiar de finca. Recargue la p√°gina.', 'error');
            }
        }
        
        function applyRanchTheme() {
            const ranch = RANCHES[currentRanch];
            
            // Update ranch buttons
            document.querySelectorAll('.ranch-btn').forEach(btn => btn.classList.remove('active'));
            const btnIds = {
                'la_coruna': 'btnRanchCoruna',
                'santa_catalina': 'btnRanchCatalina',
                'la_vega': 'btnRanchVega'
            };
            document.getElementById(btnIds[currentRanch]).classList.add('active');
            
            // Update header
            const header = document.getElementById('mainHeader');
            header.classList.remove('theme-coruna', 'theme-catalina');
            header.classList.add('theme-' + ranch.theme);
            
            // Update header title
            document.getElementById('headerRanchName').innerHTML = `${ranch.icon} ${ranch.name}`;
            
            // Update container theme for nav tabs
            document.body.classList.remove('theme-coruna-active', 'theme-catalina-active');
            document.body.classList.add('theme-' + ranch.theme + '-active');
        }
        
        function initConfigValues() {
            document.getElementById('configGDP').value = data.config.gdp || 0.31;
            document.getElementById('configPrecioVenta').value = data.config.precioVenta || 9000;
            document.getElementById('configPesoObjetivo').value = data.config.pesoObjetivo || 450;
            document.getElementById('configPesoMinimo').value = data.config.pesoMinimo || 380;
            document.getElementById('configFotoIntervalo').value = data.config.fotoIntervalo || 90;
            
            // Initialize weather selector
            const currentWeather = data.config.currentWeather || 'lluvias';
            const weatherRadio = document.querySelector(`input[name="currentWeather"][value="${currentWeather}"]`);
            if (weatherRadio) {
                weatherRadio.checked = true;
                updateWeatherVisuals();
            }
            
            // Show last weather change info if available
            if (data.weatherHistory && data.weatherHistory.length > 0) {
                const lastChange = data.weatherHistory[data.weatherHistory.length - 1];
                document.getElementById('weatherChangeInfo').style.display = 'block';
                document.getElementById('lastWeatherChange').textContent = `${getTemporadaDisplay(lastChange.to)} - ${formatDate(lastChange.fecha)}`;
            }
        }
        
        function updateWeatherCondition() {
            const selectedWeather = document.querySelector('input[name="currentWeather"]:checked')?.value;
            if (!selectedWeather) return;
            
            const oldWeather = data.config.currentWeather;
            
            // Update config
            data.config.currentWeather = selectedWeather;
            data.config.gdp = data.config.gdpByWeather[selectedWeather];
            
            // Record weather change in history
            if (!data.weatherHistory) data.weatherHistory = [];
            if (oldWeather !== selectedWeather) {
                data.weatherHistory.push({
                    fecha: new Date().toISOString().split('T')[0],
                    from: oldWeather,
                    to: selectedWeather,
                    gdp: data.config.gdp
                });
                
                // Show last change info
                document.getElementById('weatherChangeInfo').style.display = 'block';
                document.getElementById('lastWeatherChange').textContent = `${getTemporadaDisplay(selectedWeather)} - ${formatDate(new Date().toISOString().split('T')[0])}`;
            }
            
            // Update GDP field
            document.getElementById('configGDP').value = data.config.gdp;
            
            // Update visual selection
            updateWeatherVisuals();
            
            // Save and refresh views
            saveData();
            
            const weatherNames = {
                'lluvias_fuertes': 'Lluvias Fuertes (0.22 kg/d√≠a)',
                'lluvias': 'Lluvias (0.36 kg/d√≠a)',
                'veranillo': 'Veranillo (0.42 kg/d√≠a)',
                'seco': 'Seco (0.30 kg/d√≠a)'
            };
            
            showToast(`üå¶Ô∏è Condiciones actualizadas: ${weatherNames[selectedWeather]}`, 'success');
        }
        
        function updateWeatherVisuals() {
            // Update visual styling of weather cards
            document.querySelectorAll('.weather-option').forEach(label => {
                const radio = label.querySelector('input[type="radio"]');
                if (radio && radio.checked) {
                    label.style.background = 'linear-gradient(135deg, #e8f5e9, #c8e6c9)';
                    label.style.borderColor = 'var(--success)';
                    label.style.transform = 'scale(1.05)';
                } else {
                    label.style.background = '#fff';
                    label.style.borderColor = '#ddd';
                    label.style.transform = 'scale(1)';
                }
            });
        }
        
        function loadData() {
            const ranch = RANCHES[currentRanch];
            const saved = localStorage.getItem(ranch.storageKey);
            if (saved) {
                data = JSON.parse(saved);
                // Ensure all arrays exist
                if (!data.fotoSesiones) data.fotoSesiones = [];
                if (!data.saludEventos) data.saludEventos = [];
                if (!data.potreros) data.potreros = [];
                if (!data.rotaciones) data.rotaciones = [];
                if (!data.animalPotreros) data.animalPotreros = {};
                if (!data.weatherHistory) data.weatherHistory = [];
                
                // Ensure config has all fields including new weather-related fields
                if (!data.config) data.config = {};
                if (!data.config.fotoIntervalo) data.config.fotoIntervalo = 90;
                if (!data.config.gdpByWeather) {
                    data.config.gdpByWeather = {
                        'lluvias_fuertes': 0.22,
                        'lluvias': 0.36,
                        'veranillo': 0.42,
                        'seco': 0.30
                    };
                }
                if (!data.config.currentWeather) data.config.currentWeather = 'lluvias';
                if (!data.config.gdp) data.config.gdp = data.config.gdpByWeather[data.config.currentWeather];
                if (!data.config.precioVenta) data.config.precioVenta = 9000;
                if (!data.config.pesoObjetivo) data.config.pesoObjetivo = 450;
                if (!data.config.pesoMinimo) data.config.pesoMinimo = 380;
            } else {
                // Initialize with empty data for this ranch
                data = {
                    entradas: [],
                    salidas: [],
                    fotoSesiones: [],
                    saludEventos: [],
                    potreros: [],
                    rotaciones: [],
                    animalPotreros: {},
                    weatherHistory: [],
                    config: {
                        gdp: 0.31,
                        precioVenta: 9000,
                        pesoObjetivo: 450,
                        pesoMinimo: 380,
                        fotoIntervalo: 90,
                        currentWeather: 'lluvias',
                        gdpByWeather: {
                            'lluvias_fuertes': 0.22,
                            'lluvias': 0.36,
                            'veranillo': 0.42,
                            'seco': 0.30
                        }
                    }
                };
            }
        }
        
        function saveData() {
            const ranch = RANCHES[currentRanch];
            localStorage.setItem(ranch.storageKey, JSON.stringify(data));
            updateAllViews();
        }
        
        // ==================== TAB NAVIGATION ====================
        function initTabs() {
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabId = this.dataset.tab;
                    
                    document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    
                    this.classList.add('active');
                    document.getElementById('tab-' + tabId).classList.add('active');
                });
            });
        }
        
        // ==================== SORTABLE TABLES ====================
        function initSortableHeaders() {
            // Inventario table
            document.querySelectorAll('#inventarioTableContainer th.sortable').forEach(th => {
                th.addEventListener('click', () => handleSort('inventario', th));
            });
            
            // Entradas table
            document.querySelectorAll('#entradasTableContainer th.sortable').forEach(th => {
                th.addEventListener('click', () => handleSort('entradas', th));
            });
            
            // Salidas table
            document.querySelectorAll('#salidasTableContainer th.sortable').forEach(th => {
                th.addEventListener('click', () => handleSort('salidas', th));
            });
            
            // Vendedores table
            document.querySelectorAll('#vendedoresTableContainer th.sortable').forEach(th => {
                th.addEventListener('click', () => handleSort('vendedores', th));
            });
            
            // Compradores table
            document.querySelectorAll('#compradoresTableContainer th.sortable').forEach(th => {
                th.addEventListener('click', () => handleSort('compradores', th));
            });
            
            // Foto historial table
            document.querySelectorAll('#fotoHistorialTableContainer th.sortable').forEach(th => {
                th.addEventListener('click', () => handleSort('fotoSesiones', th));
            });
        }
        
        function handleSort(tableId, th) {
            const column = th.dataset.sort;
            const type = th.dataset.type;
            const table = th.closest('table');
            
            // Toggle direction
            if (sortState[tableId].column === column) {
                sortState[tableId].direction = sortState[tableId].direction === 'asc' ? 'desc' : 'asc';
            } else {
                sortState[tableId].column = column;
                sortState[tableId].direction = 'asc';
            }
            
            // Update header classes
            table.querySelectorAll('th.sortable').forEach(header => {
                header.classList.remove('asc', 'desc');
            });
            th.classList.add(sortState[tableId].direction);
            
            // Re-render the appropriate table
            switch(tableId) {
                case 'inventario':
                    updateInventarioTable();
                    break;
                case 'entradas':
                    updateEntradasTable();
                    break;
                case 'salidas':
                    updateSalidasTable();
                    break;
                case 'vendedores':
                case 'compradores':
                    updateReports();
                    break;
                case 'fotoSesiones':
                    updateFotoHistorial();
                    break;
            }
        }
        
        function sortData(dataArray, column, direction, type, tableId) {
            return [...dataArray].sort((a, b) => {
                let valA, valB;
                
                // Handle special computed columns
                if (tableId === 'inventario') {
                    if (column === 'diasEnFinca') {
                        valA = getDiasEnFinca(a.fechaEntrada);
                        valB = getDiasEnFinca(b.fechaEntrada);
                    } else if (column === 'pesoEstimado') {
                        valA = a.peso + (getDiasEnFinca(a.fechaEntrada) * data.config.gdp);
                        valB = b.peso + (getDiasEnFinca(b.fechaEntrada) * data.config.gdp);
                    } else {
                        valA = a[column];
                        valB = b[column];
                    }
                } else if (tableId === 'entradas') {
                    if (column === 'tipo') {
                        valA = a.numeroVaca ? 'nacimiento' : 'compra';
                        valB = b.numeroVaca ? 'nacimiento' : 'compra';
                    } else if (column === 'estado') {
                        valA = isAnimalSold(a.numero) ? 'vendido' : 'en finca';
                        valB = isAnimalSold(b.numero) ? 'vendido' : 'en finca';
                    } else {
                        valA = a[column];
                        valB = b[column];
                    }
                } else if (tableId === 'salidas') {
                    if (column === 'tipo') {
                        valA = a.comprador === 'MUERTE' ? 'muerte' : 'venta';
                        valB = b.comprador === 'MUERTE' ? 'muerte' : 'venta';
                    } else {
                        valA = a[column];
                        valB = b[column];
                    }
                } else {
                    valA = a[column];
                    valB = b[column];
                }
                
                // Handle null/undefined
                if (valA == null) valA = type === 'number' ? 0 : '';
                if (valB == null) valB = type === 'number' ? 0 : '';
                
                // Compare based on type
                let comparison = 0;
                if (type === 'number') {
                    comparison = parseFloat(valA) - parseFloat(valB);
                } else if (type === 'date') {
                    comparison = new Date(valA) - new Date(valB);
                } else {
                    comparison = String(valA).localeCompare(String(valB), 'es');
                }
                
                return direction === 'asc' ? comparison : -comparison;
            });
        }
        
        // ==================== EVENT FORMS ====================
        function initForms() {
            // Note: With lote-based workflows, calculations happen when adding animals
            // These listeners are kept for backward compatibility but check if elements exist
            
            const compraPeso = document.getElementById('compraPeso');
            const compraPrecioKilo = document.getElementById('compraPrecioKilo');
            
            if (compraPeso) compraPeso.addEventListener('input', calcCompraTotal);
            if (compraPrecioKilo) compraPrecioKilo.addEventListener('input', calcCompraTotal);
            
            // Venta is now lote-based, no individual calculation needed
        }
        
        function calcCompraTotal() {
            // This is called when peso changes in the animal entry form
            // Not used in lote workflow but kept for safety
        }
        
        function calcVentaTotal() {
            // Not used in lote-based venta workflow
        }
        
        function showEventForm(type) {
            // Hide all forms first
            document.querySelectorAll('[id^="form-"]').forEach(f => f.style.display = 'none');
            
            // Show selected form
            document.getElementById('form-' + type).style.display = 'block';
            
            // Populate datalists
            updateDataLists();
            
            // Type-specific initialization
            if (type === 'compra') {
                initCompraForm();
            } else if (type === 'venta') {
                initVentaForm();
            } else if (type === 'muerte') {
                populateAnimalSelector('muerteAnimalSelector', 'muerteNumero');
            } else if (type === 'nacimiento') {
                // Suggest next consecutive chapeta for nacimiento
                const nextChapeta = getNextConsecutiveChapeta();
                const hintElement = document.getElementById('nacimientoChapetaHint');
                if (hintElement) {
                    hintElement.innerHTML = `Siguiente sugerido: <strong>${nextChapeta}</strong> <button type="button" class="btn" style="padding: 0.1rem 0.5rem; font-size: 0.75rem;" onclick="useNextChapeta('nacimiento', '${nextChapeta}')">Usar</button>`;
                }
            }
        }
        
        function getNextConsecutiveChapeta() {
            // Get all chapeta numbers from entradas
            const allNumeros = data.entradas.map(e => {
                const num = parseInt(e.numero);
                return isNaN(num) ? 0 : num;
            }).filter(n => n > 0);
            
            if (allNumeros.length === 0) {
                return '1';
            }
            
            // Find the maximum and return next
            const maxNumero = Math.max(...allNumeros);
            return String(maxNumero + 1);
        }
        
        function useNextChapeta(type, chapeta) {
            document.getElementById(type + 'Numero').value = chapeta;
            // Focus on next field
            if (type === 'compra') {
                document.getElementById('compraLote').focus();
            } else if (type === 'nacimiento') {
                document.getElementById('nacimientoMadre').focus();
            }
        }
        
        function autoFillMotherRaza() {
            const madreNumero = document.getElementById('nacimientoMadre').value.trim();
            const hintElement = document.getElementById('razaMotherHint');
            
            if (!madreNumero) {
                hintElement.textContent = '';
                return;
            }
            
            // Find mother in entradas
            const madre = data.entradas.find(e => e.numero == madreNumero);
            
            if (madre && madre.raza) {
                document.getElementById('nacimientoRaza').value = madre.raza;
                hintElement.innerHTML = `<span style="color: var(--success);">‚úì Heredado de madre: ${madre.raza}</span>`;
            } else if (madre) {
                hintElement.innerHTML = `<span style="color: var(--gray);">Madre encontrada (sin raza registrada)</span>`;
            } else {
                hintElement.innerHTML = `<span style="color: var(--warning);">‚ö†Ô∏è Madre no encontrada en sistema</span>`;
            }
        }
        
        function updateLotePrecioHint() {
            const lote = document.getElementById('compraLote').value.trim();
            const hintElement = document.getElementById('lotePrecioHint');
            
            if (lote) {
                hintElement.innerHTML = `Este precio aplica a todos los animales del lote <strong>${lote}</strong>`;
            } else {
                hintElement.textContent = 'Este precio aplica a todos los animales del lote';
            }
        }
        
        function hideEventForm(type) {
            document.getElementById('form-' + type).style.display = 'none';
            document.getElementById(type + 'Form').reset();
        }
        
        function updateDataLists() {
            // Vendedores
            const vendedores = [...new Set(data.entradas.filter(e => !e.numeroVaca).map(e => e.vendedor))];
            document.getElementById('vendedoresList').innerHTML = vendedores.map(v => `<option value="${v}">`).join('');
            
            // Compradores
            const compradores = [...new Set(data.salidas.filter(s => s.comprador !== 'MUERTE').map(s => s.comprador))];
            document.getElementById('compradoresList').innerHTML = compradores.map(c => `<option value="${c}">`).join('');
            
            // Vacas (hembras en inventario)
            const vacas = getInventario().filter(a => a.sexo === 'HEMBRA').map(a => a.numero);
            document.getElementById('vacasList').innerHTML = vacas.map(v => `<option value="${v}">`).join('');
        }
        
        function populateAnimalSelector(selectorId, hiddenInputId) {
            const inventario = getInventario();
            const selector = document.getElementById(selectorId);
            
            if (inventario.length === 0) {
                selector.innerHTML = '<div style="padding: 1rem; text-align: center; color: var(--gray);">No hay animales en inventario</div>';
                return;
            }
            
            selector.innerHTML = inventario.map(animal => {
                const diasEnFinca = getDiasEnFinca(animal.fechaEntrada);
                const pesoEstimado = (animal.peso + (diasEnFinca * data.config.gdp)).toFixed(0);
                return `
                    <div class="animal-option" data-numero="${animal.numero}" onclick="selectAnimal('${animal.numero}', '${selectorId}', '${hiddenInputId}')">
                        <div>
                            <strong>#${animal.numero}</strong> - ${animal.sexo === 'MACHO' ? '‚ôÇÔ∏è' : '‚ôÄÔ∏è'} ${animal.vendedor || 'Nacimiento'}
                        </div>
                        <div style="color: var(--gray); font-size: 0.85rem;">
                            ${pesoEstimado} kg est. | ${diasEnFinca} d√≠as
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function selectAnimal(numero, selectorId, hiddenInputId) {
            // Update hidden input
            document.getElementById(hiddenInputId).value = numero;
            
            // Visual selection
            document.querySelectorAll(`#${selectorId} .animal-option`).forEach(opt => {
                opt.classList.remove('selected');
            });
            document.querySelector(`#${selectorId} .animal-option[data-numero="${numero}"]`).classList.add('selected');
            
            // If it's venta, calculate GDP
            if (selectorId === 'ventaAnimalSelector') {
                const animal = getInventario().find(a => a.numero == numero);
                if (animal) {
                    const pesoEstimado = animal.peso + (getDiasEnFinca(animal.fechaEntrada) * data.config.gdp);
                    document.getElementById('ventaPeso').value = Math.round(pesoEstimado);
                    calcVentaTotal();
                }
            } else if (selectorId === 'muerteAnimalSelector') {
                const animal = getInventario().find(a => a.numero == numero);
                if (animal) {
                    const pesoEstimado = animal.peso + (getDiasEnFinca(animal.fechaEntrada) * data.config.gdp);
                    document.getElementById('muertePeso').value = Math.round(pesoEstimado);
                }
            }
        }
        
        function filterAnimalsForSale() {
            const search = document.getElementById('ventaSearch').value.toLowerCase();
            document.querySelectorAll('#ventaAnimalSelector .animal-option').forEach(opt => {
                const numero = opt.dataset.numero.toLowerCase();
                opt.style.display = numero.includes(search) ? '' : 'none';
            });
        }
        
        function filterAnimalsForDeath() {
            const search = document.getElementById('muerteSearch').value.toLowerCase();
            document.querySelectorAll('#muerteAnimalSelector .animal-option').forEach(opt => {
                const numero = opt.dataset.numero.toLowerCase();
                opt.style.display = numero.includes(search) ? '' : 'none';
            });
        }
        
        // ==================== CALCULATIONS ====================
        // Old calc functions removed - now using lote-based workflow
        
        function getDiasEnFinca(fechaEntrada) {
            const entrada = new Date(fechaEntrada);
            const hoy = new Date();
            return Math.floor((hoy - entrada) / (1000 * 60 * 60 * 24));
        }
        
        // ==================== SAVE EVENTS ====================
        // ==================== LOTE-BASED COMPRA WORKFLOW ====================
        let currentLote = {
            numero: null,
            vendedor: null,
            precioKilo: null,
            fecha: null,
            cantidadEsperada: 0,
            animales: []
        };
        
        function getNextLoteNumber() {
            // Get all unique lote numbers that start with "L-"
            const loteNumbers = data.entradas
                .filter(e => e.lote && e.lote.startsWith('L-'))
                .map(e => parseInt(e.lote.replace('L-', '')))
                .filter(n => !isNaN(n));
            
            if (loteNumbers.length === 0) {
                return 'L-1';
            }
            
            const maxLote = Math.max(...loteNumbers);
            return `L-${maxLote + 1}`;
        }
        
        function initCompraForm() {
            // Reset to step 1
            document.getElementById('compraLoteInfo').style.display = 'block';
            document.getElementById('compraAnimalesSection').style.display = 'none';
            
            // Set next lote number
            const nextLote = getNextLoteNumber();
            document.getElementById('compraLote').value = nextLote;
            
            // Clear fields
            document.getElementById('compraVendedor').value = '';
            document.getElementById('compraPrecioKilo').value = '';
            document.getElementById('compraCantidadAnimales').value = '';
            
            // Reset current lote
            currentLote = {
                numero: nextLote,
                vendedor: null,
                precioKilo: null,
                fecha: null,
                cantidadEsperada: 0,
                animales: []
            };
        }
        
        function startLoteEntry() {
            const cantidadAnimales = parseInt(document.getElementById('compraCantidadAnimales').value);
            const vendedor = document.getElementById('compraVendedor').value.trim();
            const precioKilo = parseFloat(document.getElementById('compraPrecioKilo').value);
            const fecha = document.getElementById('compraFecha').value;
            
            if (!cantidadAnimales || cantidadAnimales < 1) {
                showToast('Ingrese la cantidad de animales', 'error');
                return;
            }
            if (!vendedor) {
                showToast('Ingrese el vendedor', 'error');
                return;
            }
            if (!precioKilo || precioKilo <= 0) {
                showToast('Ingrese el precio por kilo', 'error');
                return;
            }
            if (!fecha) {
                showToast('Ingrese la fecha de entrada', 'error');
                return;
            }
            
            // Store lote info
            currentLote.cantidadEsperada = cantidadAnimales;
            currentLote.vendedor = vendedor;
            currentLote.precioKilo = precioKilo;
            currentLote.fecha = fecha;
            
            // Update display
            document.getElementById('loteNumeroDisplay').textContent = currentLote.numero;
            document.getElementById('loteVendedorDisplay').textContent = vendedor;
            document.getElementById('lotePrecioDisplay').textContent = formatCurrency(precioKilo) + '/kg';
            document.getElementById('loteFechaDisplay').textContent = formatDate(fecha);
            
            // Show animals section
            document.getElementById('compraLoteInfo').style.display = 'none';
            document.getElementById('compraAnimalesSection').style.display = 'block';
            
            // Set first chapeta number
            const nextChapeta = getNextConsecutiveChapeta();
            document.getElementById('compraNumero').value = nextChapeta;
            document.getElementById('compraChapetaHint').textContent = `Siguiente: ${nextChapeta}`;
            
            // Focus on raza
            document.getElementById('compraRaza').focus();
            
            updateLoteTable();
            updateLoteProgress();
        }
        
        function updateLoteProgress() {
            const current = currentLote.animales.length;
            const expected = currentLote.cantidadEsperada;
            const remaining = expected - current;
            const percentage = expected > 0 ? (current / expected) * 100 : 0;
            
            // Update progress text and bar
            document.getElementById('loteProgressText').textContent = `${current} de ${expected}`;
            document.getElementById('loteProgressBar').style.width = `${Math.min(percentage, 100)}%`;
            document.getElementById('animalCountRemaining').textContent = remaining;
            
            // Update progress status badge
            const statusBadge = document.getElementById('loteProgressStatus');
            const finalizarBtn = document.getElementById('btnFinalizarLote');
            const addBtn = document.getElementById('btnAddAnimal');
            const warningDiv = document.getElementById('finalizarLoteWarning');
            
            if (current === expected) {
                // Exact count reached
                statusBadge.className = 'badge badge-success';
                statusBadge.textContent = '‚úÖ Completo';
                finalizarBtn.disabled = false;
                addBtn.disabled = true;
                addBtn.textContent = '‚úÖ Lote completo';
                warningDiv.style.display = 'none';
                document.getElementById('loteProgressBar').style.background = 'var(--success)';
            } else if (current > expected) {
                // Too many (shouldn't happen)
                statusBadge.className = 'badge badge-danger';
                statusBadge.textContent = '‚ö†Ô∏è Excedido';
                finalizarBtn.disabled = true;
                warningDiv.style.display = 'block';
                document.getElementById('finalizarWarningText').textContent = `Hay ${current - expected} animal(es) de m√°s. Elimine para continuar.`;
            } else {
                // Still adding
                statusBadge.className = 'badge badge-warning';
                statusBadge.textContent = 'En progreso';
                finalizarBtn.disabled = true;
                addBtn.disabled = false;
                addBtn.innerHTML = `‚ûï Agregar Animal (<span id="animalCountRemaining">${remaining}</span> restantes)`;
                warningDiv.style.display = 'block';
                document.getElementById('finalizarWarningText').textContent = `Faltan ${remaining} animal(es) para completar el lote`;
                document.getElementById('loteProgressBar').style.background = 'var(--primary)';
            }
        }
        
        function addAnimalToLote(event) {
            event.preventDefault();
            
            // Check if lote is already complete
            if (currentLote.animales.length >= currentLote.cantidadEsperada) {
                showToast('El lote ya est√° completo', 'warning');
                return;
            }
            
            const numero = document.getElementById('compraNumero').value.trim();
            const raza = document.getElementById('compraRaza').value;
            const sexo = document.getElementById('compraSexo').value;
            const peso = parseFloat(document.getElementById('compraPeso').value);
            
            if (!numero) {
                showToast('Ingrese el n√∫mero de chapeta', 'error');
                return;
            }
            if (!peso || peso <= 0) {
                showToast('Ingrese el peso', 'error');
                return;
            }
            
            // Check if chapeta already exists in inventory or current lote
            if (data.entradas.some(e => e.numero == numero && !isAnimalSold(e.numero))) {
                showToast('Ya existe un animal con ese n√∫mero de chapeta en el inventario', 'error');
                return;
            }
            if (currentLote.animales.some(a => a.numero == numero)) {
                showToast('Ya agregaste un animal con ese n√∫mero en este lote', 'error');
                return;
            }
            
            // Add to current lote
            currentLote.animales.push({
                numero: numero,
                raza: raza,
                sexo: sexo,
                peso: peso,
                costoTotal: peso * currentLote.precioKilo
            });
            
            // Update table and progress
            updateLoteTable();
            updateLoteProgress();
            
            const remaining = currentLote.cantidadEsperada - currentLote.animales.length;
            
            if (remaining > 0) {
                // Prepare for next animal
                const nextChapeta = parseInt(numero) + 1;
                document.getElementById('compraNumero').value = nextChapeta;
                document.getElementById('compraPeso').value = '';
                document.getElementById('compraPeso').focus();
                
                showToast(`‚úÖ Animal #${numero} agregado (${remaining} restantes)`, 'success');
            } else {
                showToast(`‚úÖ Animal #${numero} agregado. ¬°Lote completo! Puede finalizar.`, 'success');
            }
        }
        
        function updateLoteTable() {
            const tbody = document.getElementById('loteAnimalesTable');
            const count = document.getElementById('loteAnimalCount');
            const totalKg = document.getElementById('loteTotalKg');
            const totalCosto = document.getElementById('loteTotalCosto');
            
            if (currentLote.animales.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center" style="color: var(--gray);">A√∫n no hay animales en este lote</td></tr>';
                count.textContent = '0';
                totalKg.textContent = '0';
                totalCosto.textContent = '$0';
                return;
            }
            
            const sumKg = currentLote.animales.reduce((sum, a) => sum + a.peso, 0);
            const sumCosto = currentLote.animales.reduce((sum, a) => sum + a.costoTotal, 0);
            
            count.textContent = currentLote.animales.length;
            totalKg.textContent = formatNumber(sumKg);
            totalCosto.textContent = formatCurrency(sumCosto);
            
            tbody.innerHTML = currentLote.animales.map((animal, index) => `
                <tr>
                    <td>${index + 1}</td>
                    <td><strong>${animal.numero}</strong></td>
                    <td>${animal.raza}</td>
                    <td>${animal.sexo === 'MACHO' ? '‚ôÇÔ∏è' : '‚ôÄÔ∏è'}</td>
                    <td class="text-right">${animal.peso} kg</td>
                    <td class="text-right">${formatCurrency(animal.costoTotal)}</td>
                    <td class="text-center">
                        <button type="button" class="btn btn-danger" style="padding: 0.15rem 0.4rem; font-size: 0.75rem;" onclick="removeAnimalFromLote(${index})">‚úï</button>
                    </td>
                </tr>
            `).join('');
        }
        
        function removeAnimalFromLote(index) {
            const animal = currentLote.animales[index];
            currentLote.animales.splice(index, 1);
            updateLoteTable();
            updateLoteProgress();
            showToast(`Animal #${animal.numero} eliminado del lote`, 'warning');
        }
        
        function finalizarLote() {
            if (currentLote.animales.length !== currentLote.cantidadEsperada) {
                showToast(`Debe agregar exactamente ${currentLote.cantidadEsperada} animales`, 'error');
                return;
            }
            
            if (!confirm(`¬øFinalizar lote ${currentLote.numero} con ${currentLote.animales.length} animales?`)) {
                return;
            }
            
            // Save all animals to entradas
            currentLote.animales.forEach(animal => {
                const entrada = {
                    numero: animal.numero,
                    lote: currentLote.numero,
                    vendedor: currentLote.vendedor,
                    raza: animal.raza,
                    sexo: animal.sexo,
                    peso: animal.peso,
                    precioKilo: currentLote.precioKilo,
                    fechaEntrada: currentLote.fecha,
                    numeroVaca: null,
                    costoTotal: animal.costoTotal
                };
                data.entradas.push(entrada);
            });
            
            saveData();
            
            const totalKg = currentLote.animales.reduce((sum, a) => sum + a.peso, 0);
            const totalCosto = currentLote.animales.reduce((sum, a) => sum + a.costoTotal, 0);
            
            showToast(`‚úÖ Lote ${currentLote.numero} guardado: ${currentLote.animales.length} animales, ${formatNumber(totalKg)} kg, ${formatCurrency(totalCosto)}`, 'success');
            
            hideEventForm('compra');
        }
        
        function cancelarLote() {
            if (currentLote.animales.length > 0) {
                if (!confirm(`¬øCancelar lote? Se perder√°n ${currentLote.animales.length} animales sin guardar.`)) {
                    return;
                }
            }
            
            hideEventForm('compra');
        }
        
        function saveNacimiento(event) {
            event.preventDefault();
            saveNacimientoInternal(false);
        }
        
        function saveNacimientoAndContinue() {
            const form = document.getElementById('nacimientoForm');
            if (!form.reportValidity()) return;
            saveNacimientoInternal(true);
        }
        
        function saveNacimientoInternal(continueAdding) {
            const nacimiento = {
                numero: document.getElementById('nacimientoNumero').value.trim(),
                lote: document.getElementById('nacimientoLote').value.trim() || 'NAC',
                vendedor: 'Nacimiento',
                raza: document.getElementById('nacimientoRaza').value,
                sexo: document.getElementById('nacimientoSexo').value,
                peso: parseFloat(document.getElementById('nacimientoPeso').value) || 30,
                precioKilo: 0,
                fechaEntrada: document.getElementById('nacimientoFecha').value,
                numeroVaca: document.getElementById('nacimientoMadre').value.trim(),
                costoTotal: 0
            };
            
            // Check if chapeta already exists
            if (data.entradas.some(e => e.numero == nacimiento.numero && !isAnimalSold(e.numero))) {
                showToast('Ya existe un animal con ese n√∫mero de chapeta', 'error');
                return;
            }
            
            data.entradas.push(nacimiento);
            saveData();
            
            if (continueAdding) {
                // Keep lote and fecha - clear everything else
                const lote = document.getElementById('nacimientoLote').value;
                const fecha = document.getElementById('nacimientoFecha').value;
                
                document.getElementById('nacimientoForm').reset();
                
                // Restore data
                document.getElementById('nacimientoLote').value = lote;
                document.getElementById('nacimientoFecha').value = fecha;
                
                // Set next consecutive chapeta
                const nextChapeta = getNextConsecutiveChapeta();
                document.getElementById('nacimientoNumero').value = nextChapeta;
                document.getElementById('razaMotherHint').textContent = '';
                
                showToast(`‚úÖ Nacimiento #${nacimiento.numero} guardado. Siguiente: #${nextChapeta}`, 'success');
                document.getElementById('nacimientoMadre').focus();
            } else {
                showToast('Nacimiento registrado exitosamente', 'success');
                hideEventForm('nacimiento');
            }
        }
        
        // ==================== VENTA WORKFLOW (NO LOTES) ====================
        let currentVenta = {
            comprador: null,
            precioKilo: null,
            fecha: null,
            cantidadEsperada: 0,
            animales: [],
            transferenciaHacia: null // Ranch ID for inter-ranch transfers
        };
        
        function initVentaForm() {
            // Reset to step 1
            document.getElementById('ventaLoteInfo').style.display = 'block';
            document.getElementById('ventaAnimalesSection').style.display = 'none';
            
            // Clear fields
            document.getElementById('ventaComprador').value = '';
            document.getElementById('ventaPrecioKilo').value = '';
            document.getElementById('ventaCantidadAnimales').value = '';
            
            const checkboxEl = document.getElementById('ventaEsTransferencia');
            if (checkboxEl) checkboxEl.checked = false;
            
            // Populate destination ranch selector (only if element exists)
            populateDestinationRanches();
            
            // Reset transfer mode UI
            toggleTransferMode();
            
            // Reset current venta
            currentVenta = {
                comprador: null,
                precioKilo: null,
                fecha: null,
                cantidadEsperada: 0,
                animales: [],
                esTransferencia: false,
                fincaDestino: null
            };
        }
        
        function populateDestinationRanches() {
            const select = document.getElementById('ventaFincaDestino');
            if (!select) return; // Element might not exist yet
            
            // Get all ranches except current one
            select.innerHTML = '<option value="">-- Seleccionar finca --</option>' +
                Object.keys(RANCHES)
                    .filter(id => id !== currentRanch)
                    .map(id => {
                        const ranch = RANCHES[id];
                        return `<option value="${id}">${ranch.icon} ${ranch.name}</option>`;
                    })
                    .join('');
        }
        
        function toggleTransferMode() {
            const isTransfer = document.getElementById('ventaEsTransferencia').checked;
            const normalFields = document.getElementById('ventaNormalFields');
            const transferFields = document.getElementById('ventaTransferFields');
            
            if (isTransfer) {
                normalFields.style.display = 'none';
                transferFields.style.display = 'contents';
            } else {
                normalFields.style.display = 'contents';
                transferFields.style.display = 'none';
            }
        }
        
        function startVentaEntry() {
            const cantidadAnimales = parseInt(document.getElementById('ventaCantidadAnimales').value);
            const esTransferencia = document.getElementById('ventaEsTransferencia').checked;
            const fecha = document.getElementById('ventaFecha').value;
            
            if (!cantidadAnimales || cantidadAnimales < 1) {
                showToast('Ingrese la cantidad de animales a vender', 'error');
                return;
            }
            
            let comprador, precioKilo, fincaDestino;
            
            if (esTransferencia) {
                // Transfer mode validation
                fincaDestino = document.getElementById('ventaFincaDestino').value;
                precioKilo = parseFloat(document.getElementById('ventaPrecioTransfer').value) || 0;
                
                if (!fincaDestino) {
                    showToast('Seleccione la finca destino', 'error');
                    return;
                }
                
                comprador = `TRANSFERENCIA ‚Üí ${RANCHES[fincaDestino].name}`;
            } else {
                // Normal sale validation
                comprador = document.getElementById('ventaComprador').value.trim();
                precioKilo = parseFloat(document.getElementById('ventaPrecioKilo').value);
                
                if (!comprador) {
                    showToast('Ingrese el comprador', 'error');
                    return;
                }
                if (!precioKilo || precioKilo <= 0) {
                    showToast('Ingrese el precio por kilo', 'error');
                    return;
                }
            }
            
            if (!fecha) {
                showToast('Ingrese la fecha', 'error');
                return;
            }
            
            // Check if there are enough animals in inventory
            const inventarioCount = getInventario().length;
            if (cantidadAnimales > inventarioCount) {
                showToast(`Solo hay ${inventarioCount} animales en inventario`, 'error');
                return;
            }
            
            // Store venta info
            currentVenta.cantidadEsperada = cantidadAnimales;
            currentVenta.comprador = comprador;
            currentVenta.precioKilo = precioKilo;
            currentVenta.fecha = fecha;
            currentVenta.esTransferencia = esTransferencia;
            currentVenta.fincaDestino = fincaDestino || null;
            
            // Update display
            document.getElementById('ventaCompradorDisplay').textContent = comprador;
            document.getElementById('ventaPrecioDisplay').textContent = formatCurrency(precioKilo) + '/kg';
            document.getElementById('ventaFechaDisplay').textContent = formatDate(fecha);
            
            // Show animals section
            document.getElementById('ventaLoteInfo').style.display = 'none';
            document.getElementById('ventaAnimalesSection').style.display = 'block';
            
            // Populate available animals
            populateVentaAnimalSelector();
            updateVentaTable();
            updateVentaProgress();
        }
        
        function updateVentaProgress() {
            const current = currentVenta.animales.length;
            const expected = currentVenta.cantidadEsperada;
            const remaining = expected - current;
            const percentage = expected > 0 ? (current / expected) * 100 : 0;
            
            // Update progress text and bar
            document.getElementById('ventaProgressText').textContent = `${current} de ${expected}`;
            document.getElementById('ventaProgressBar').style.width = `${Math.min(percentage, 100)}%`;
            document.getElementById('ventaAnimalCountRemaining').textContent = remaining;
            
            // Update progress status badge
            const statusBadge = document.getElementById('ventaProgressStatus');
            const finalizarBtn = document.getElementById('btnFinalizarVenta');
            const addBtn = document.getElementById('btnAddAnimalVenta');
            const warningDiv = document.getElementById('finalizarVentaWarning');
            const selectorContainer = document.getElementById('ventaAnimalSelectorContainer');
            
            if (current === expected) {
                // Exact count reached
                statusBadge.className = 'badge badge-success';
                statusBadge.textContent = '‚úÖ Completo';
                finalizarBtn.disabled = false;
                if (addBtn) addBtn.disabled = true;
                warningDiv.style.display = 'none';
                selectorContainer.style.display = 'none';
                document.getElementById('ventaAnimalSelectorLote').style.display = 'none';
                document.getElementById('ventaAddAnimalForm').style.display = 'none';
                document.getElementById('ventaProgressBar').style.background = 'var(--success)';
            } else if (current > expected) {
                // Too many (shouldn't happen)
                statusBadge.className = 'badge badge-danger';
                statusBadge.textContent = '‚ö†Ô∏è Excedido';
                finalizarBtn.disabled = true;
                warningDiv.style.display = 'block';
                document.getElementById('finalizarVentaWarningText').textContent = `Hay ${current - expected} animal(es) de m√°s. Elimine para continuar.`;
            } else {
                // Still adding
                statusBadge.className = 'badge badge-warning';
                statusBadge.textContent = 'En progreso';
                finalizarBtn.disabled = true;
                if (addBtn) addBtn.disabled = false;
                selectorContainer.style.display = 'block';
                document.getElementById('ventaAnimalSelectorLote').style.display = 'block';
                warningDiv.style.display = 'block';
                document.getElementById('finalizarVentaWarningText').textContent = `Faltan ${remaining} animal(es) para completar la venta`;
                document.getElementById('ventaProgressBar').style.background = 'var(--warning)';
            }
        }
        
        function populateVentaAnimalSelector() {
            const container = document.getElementById('ventaAnimalSelectorLote');
            const searchTerm = (document.getElementById('ventaSearchLote')?.value || '').toLowerCase();
            
            // Get inventory excluding animals already in current venta
            let inventario = getInventario().filter(a => 
                !currentVenta.animales.some(v => v.numero == a.numero)
            );
            
            // Filter by search term
            if (searchTerm) {
                inventario = inventario.filter(a => 
                    String(a.numero).toLowerCase().includes(searchTerm) ||
                    (a.lote || '').toLowerCase().includes(searchTerm) ||
                    (a.vendedor || '').toLowerCase().includes(searchTerm) ||
                    (a.raza || '').toLowerCase().includes(searchTerm)
                );
            }
            
            if (inventario.length === 0) {
                container.innerHTML = '<div style="padding: 1rem; text-align: center; color: var(--gray);">No hay animales disponibles</div>';
                return;
            }
            
            container.innerHTML = inventario.map(animal => {
                const diasEnFinca = getDiasEnFinca(animal.fechaEntrada);
                const pesoEstimado = animal.peso + (diasEnFinca * data.config.gdp);
                
                return `
                    <div class="animal-option" onclick="selectAnimalForVenta('${animal.numero}')">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong>#${animal.numero}</strong>
                                <span style="color: var(--gray); margin-left: 0.5rem;">${animal.lote || ''}</span>
                                <span style="margin-left: 0.5rem;">${animal.raza || ''}</span>
                            </div>
                            <div style="text-align: right;">
                                <div>${animal.sexo === 'MACHO' ? '‚ôÇÔ∏è' : '‚ôÄÔ∏è'} ${pesoEstimado.toFixed(0)} kg est.</div>
                                <div style="font-size: 0.8rem; color: var(--gray);">${diasEnFinca} d√≠as</div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function filterAnimalsForSaleLote() {
            populateVentaAnimalSelector();
        }
        
        function selectAnimalForVenta(numero) {
            // Check if venta is already complete
            if (currentVenta.animales.length >= currentVenta.cantidadEsperada) {
                showToast('La venta ya est√° completa', 'warning');
                return;
            }
            
            const animal = getInventario().find(a => a.numero == numero);
            if (!animal) return;
            
            const diasEnFinca = getDiasEnFinca(animal.fechaEntrada);
            const pesoEstimado = animal.peso + (diasEnFinca * data.config.gdp);
            
            // Store selected animal
            document.getElementById('ventaSelectedNumero').value = numero;
            
            // Show add animal form
            document.getElementById('ventaAddAnimalForm').style.display = 'block';
            document.getElementById('ventaSelectedAnimalInfo').innerHTML = 
                `<span style="font-size: 1.1rem;">#${numero}</span> | ${animal.raza || '-'} | ${animal.sexo === 'MACHO' ? '‚ôÇÔ∏è' : '‚ôÄÔ∏è'} | Lote: ${animal.lote || '-'}`;
            
            // Pre-fill estimated weight
            document.getElementById('ventaPesoAnimal').value = Math.round(pesoEstimado);
            document.getElementById('ventaPesoEstimadoHint').textContent = `Peso entrada: ${animal.peso} kg | Estimado: ${pesoEstimado.toFixed(0)} kg | ${diasEnFinca} d√≠as`;
            
            // Update remaining count on button
            const remaining = currentVenta.cantidadEsperada - currentVenta.animales.length;
            document.getElementById('ventaAnimalCountRemaining').textContent = remaining;
            
            // Highlight selected
            document.querySelectorAll('#ventaAnimalSelectorLote .animal-option').forEach(opt => {
                opt.classList.remove('selected');
                if (opt.querySelector('strong')?.textContent === `#${numero}`) {
                    opt.classList.add('selected');
                }
            });
            
            document.getElementById('ventaPesoAnimal').focus();
        }
        
        function clearVentaSelection() {
            document.getElementById('ventaSelectedNumero').value = '';
            document.getElementById('ventaAddAnimalForm').style.display = 'none';
            document.querySelectorAll('#ventaAnimalSelectorLote .animal-option').forEach(opt => {
                opt.classList.remove('selected');
            });
        }
        
        function addAnimalToVenta() {
            // Check if venta is already complete
            if (currentVenta.animales.length >= currentVenta.cantidadEsperada) {
                showToast('La venta ya est√° completa', 'warning');
                return;
            }
            
            const numero = document.getElementById('ventaSelectedNumero').value;
            const pesoVenta = parseFloat(document.getElementById('ventaPesoAnimal').value);
            
            if (!numero) {
                showToast('Seleccione un animal', 'error');
                return;
            }
            if (!pesoVenta || pesoVenta <= 0) {
                showToast('Ingrese el peso de venta', 'error');
                return;
            }
            
            const animal = getInventario().find(a => a.numero == numero);
            if (!animal) {
                showToast('Animal no encontrado', 'error');
                return;
            }
            
            const diasEnFinca = getDiasEnFinca(animal.fechaEntrada);
            const gananciaKg = pesoVenta - animal.peso;
            
            // Add to current venta
            currentVenta.animales.push({
                numero: numero,
                loteCompra: animal.lote,
                raza: animal.raza,
                sexo: animal.sexo,
                pesoEntrada: animal.peso,
                pesoVenta: pesoVenta,
                gananciaKg: gananciaKg,
                diasEnFinca: diasEnFinca,
                gdp: diasEnFinca > 0 ? gananciaKg / diasEnFinca : 0,
                costoVenta: pesoVenta * currentVenta.precioKilo
            });
            
            // Update table and progress
            updateVentaTable();
            updateVentaProgress();
            
            // Clear selection and refresh available animals
            clearVentaSelection();
            populateVentaAnimalSelector();
            
            const remaining = currentVenta.cantidadEsperada - currentVenta.animales.length;
            
            if (remaining > 0) {
                showToast(`‚úÖ Animal #${numero} agregado (${remaining} restantes)`, 'success');
            } else {
                showToast(`‚úÖ Animal #${numero} agregado. ¬°Venta completa! Puede finalizar.`, 'success');
            }
        }
        
        function updateVentaTable() {
            const tbody = document.getElementById('ventaAnimalesTable');
            const count = document.getElementById('ventaAnimalCount');
            const totalKg = document.getElementById('ventaTotalKg');
            const totalVenta = document.getElementById('ventaTotalVenta');
            
            if (currentVenta.animales.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="text-center" style="color: var(--gray);">Selecciona animales del inventario</td></tr>';
                count.textContent = '0';
                totalKg.textContent = '0';
                totalVenta.textContent = '$0';
                return;
            }
            
            const sumKg = currentVenta.animales.reduce((sum, a) => sum + a.pesoVenta, 0);
            const sumVenta = currentVenta.animales.reduce((sum, a) => sum + a.costoVenta, 0);
            
            count.textContent = currentVenta.animales.length;
            totalKg.textContent = formatNumber(sumKg);
            totalVenta.textContent = formatCurrency(sumVenta);
            
            tbody.innerHTML = currentVenta.animales.map((animal, index) => `
                <tr>
                    <td>${index + 1}</td>
                    <td><strong>${animal.numero}</strong></td>
                    <td>${animal.loteCompra || '-'}</td>
                    <td>${animal.raza || '-'}</td>
                    <td class="text-right">${animal.pesoEntrada} kg</td>
                    <td class="text-right"><strong>${animal.pesoVenta} kg</strong></td>
                    <td class="text-right" style="color: ${animal.gananciaKg >= 0 ? 'var(--success)' : 'var(--danger)'};">
                        ${animal.gananciaKg >= 0 ? '+' : ''}${animal.gananciaKg.toFixed(1)} kg
                    </td>
                    <td class="text-right">${formatCurrency(animal.costoVenta)}</td>
                    <td class="text-center">
                        <button type="button" class="btn btn-danger" style="padding: 0.15rem 0.4rem; font-size: 0.75rem;" onclick="removeAnimalFromVenta(${index})">‚úï</button>
                    </td>
                </tr>
            `).join('');
        }
        
        function removeAnimalFromVenta(index) {
            const animal = currentVenta.animales[index];
            currentVenta.animales.splice(index, 1);
            updateVentaTable();
            updateVentaProgress();
            populateVentaAnimalSelector();
            showToast(`Animal #${animal.numero} eliminado de la venta`, 'warning');
        }
        
        function finalizarVenta() {
            if (currentVenta.animales.length !== currentVenta.cantidadEsperada) {
                showToast(`Debe seleccionar exactamente ${currentVenta.cantidadEsperada} animales`, 'error');
                return;
            }
            
            const esTransferencia = currentVenta.esTransferencia || false;
            const fincaDestino = currentVenta.fincaDestino;
            
            const confirmMsg = esTransferencia 
                ? `¬øFinalizar transferencia de ${currentVenta.animales.length} animales a ${RANCHES[fincaDestino].name}?`
                : `¬øFinalizar venta de ${currentVenta.animales.length} animales a ${currentVenta.comprador}?`;
            
            if (!confirm(confirmMsg)) {
                return;
            }
            
            // Save all animals to salidas in CURRENT ranch
            currentVenta.animales.forEach(animal => {
                const venta = {
                    numero: animal.numero,
                    peso: animal.pesoVenta,
                    fechaSalida: currentVenta.fecha,
                    precioKiloVenta: currentVenta.precioKilo,
                    comprador: esTransferencia ? `TRANSFERENCIA ‚Üí ${RANCHES[fincaDestino].name}` : currentVenta.comprador,
                    costoVenta: animal.costoVenta,
                    gananciaDay: animal.gdp,
                    esTransferencia: esTransferencia,
                    fincaDestino: esTransferencia ? fincaDestino : null
                };
                data.salidas.push(venta);
            });
            
            saveData();
            
            // If it's a transfer, create purchase entries in destination ranch
            if (esTransferencia && fincaDestino) {
                const destinoRanch = RANCHES[fincaDestino];
                const destinoData = JSON.parse(localStorage.getItem(destinoRanch.storageKey) || '{"entradas":[],"salidas":[],"config":{}}');
                
                if (!destinoData.entradas) destinoData.entradas = [];
                
                const precioTransfer = currentVenta.precioKilo || 0;
                
                currentVenta.animales.forEach(animal => {
                    // Find original animal data to get complete info
                    const originalAnimal = data.entradas.find(e => e.numero === animal.numero);
                    
                    const compra = {
                        numero: animal.numero,
                        lote: `TRANSFER-${currentRanch.toUpperCase()}-${new Date().getTime()}`,
                        vendedor: `Transferencia desde ${RANCHES[currentRanch].name}`,
                        raza: originalAnimal?.raza || animal.raza || 'No especificada',
                        sexo: originalAnimal?.sexo || animal.sexo || 'MACHO',
                        peso: animal.pesoVenta,
                        precioKilo: precioTransfer,
                        fechaEntrada: currentVenta.fecha,
                        numeroVaca: null,
                        costoTotal: animal.pesoVenta * precioTransfer,
                        esTransferencia: true,
                        fincaOrigen: currentRanch
                    };
                    
                    destinoData.entradas.push(compra);
                });
                
                // Save to destination ranch
                localStorage.setItem(destinoRanch.storageKey, JSON.stringify(destinoData));
            }
            
            const totalKg = currentVenta.animales.reduce((sum, a) => sum + a.pesoVenta, 0);
            const totalVenta = currentVenta.animales.reduce((sum, a) => sum + a.costoVenta, 0);
            
            const successMsg = esTransferencia
                ? `‚úÖ Transferencia completada: ${currentVenta.animales.length} animales a ${RANCHES[fincaDestino].name}, ${formatNumber(totalKg)} kg`
                : `‚úÖ Venta guardada: ${currentVenta.animales.length} animales, ${formatNumber(totalKg)} kg, ${formatCurrency(totalVenta)}`;
            
            showToast(successMsg, 'success');
            
            hideEventForm('venta');
        }
        
        function cancelarVenta() {
            if (currentVenta.animales.length > 0) {
                if (!confirm(`¬øCancelar venta? Se perder√°n ${currentVenta.animales.length} animales seleccionados.`)) {
                    return;
                }
            }
            
            hideEventForm('venta');
        }
        
        // Keep old function for backward compatibility (quick sale from inventory)
        function saveVenta(event) {
            event.preventDefault();
            // Redirect to new workflow
            showEventForm('venta');
        }
        
        function saveMuerte(event) {
            event.preventDefault();
            
            const numero = document.getElementById('muerteNumero').value;
            if (!numero) {
                showToast('Debe seleccionar un animal', 'error');
                return;
            }
            
            const animal = getInventario().find(a => a.numero == numero);
            
            const muerte = {
                numero: numero,
                peso: parseFloat(document.getElementById('muertePeso').value) || animal.peso,
                fechaSalida: document.getElementById('muerteFecha').value,
                precioKiloVenta: 0,
                comprador: 'MUERTE',
                costoVenta: animal.costoTotal || 0,
                gananciaDay: 0,
                causa: document.getElementById('muerteCausa').value.trim()
            };
            
            data.salidas.push(muerte);
            saveData();
            
            showToast('Muerte registrada', 'success');
            hideEventForm('muerte');
        }
        
        // ==================== INVENTORY HELPERS ====================
        function isAnimalSold(numero) {
            return data.salidas.some(s => s.numero == numero);
        }
        
        function getInventario() {
            return data.entradas.filter(e => !isAnimalSold(e.numero));
        }
        
        // ==================== UPDATE VIEWS ====================
        function updateAllViews() {
            updateSummary();
            updateHeader();
            updateInventarioTable();
            updateEntradasTable();
            updateSalidasTable();
            updateReports();
            updateRecentActivity();
            updateFilters();
            updateFotosView();
            updateSaludView();
            updatePotrerosView();
        }
        
        function updateSummary() {
            const inventario = getInventario();
            const machos = inventario.filter(a => a.sexo === 'MACHO').length;
            const hembras = inventario.filter(a => a.sexo === 'HEMBRA').length;
            
            let kgTotalInicial = 0;  // Initial purchase weight (matches Excel)
            let inversionTotal = 0;
            
            inventario.forEach(a => {
                kgTotalInicial += a.peso;  // Use initial weight, not estimated
                // Calculate cost as peso √ó precioKilo if costoTotal is missing
                const costo = a.costoTotal || (a.peso * a.precioKilo) || 0;
                inversionTotal += costo;
            });
            
            const kgPromedio = inventario.length > 0 ? kgTotalInicial / inventario.length : 0;
            
            document.getElementById('summaryTotal').textContent = inventario.length;
            document.getElementById('summaryMachos').textContent = machos;
            document.getElementById('summaryHembras').textContent = hembras;
            document.getElementById('summaryKgTotal').textContent = formatNumber(Math.round(kgTotalInicial));
            document.getElementById('summaryInversion').textContent = formatCurrency(inversionTotal);
            document.getElementById('summaryPrecioKg').textContent = kgTotalInicial > 0 ? formatCurrency(inversionTotal / kgTotalInicial) : '$0';
            document.getElementById('summaryKgPromedio').textContent = kgPromedio.toFixed(2);
        }
        
        function updateHeader() {
            const inventario = getInventario();
            let kgTotalInicial = 0;
            let inversionTotal = 0;
            
            inventario.forEach(a => {
                kgTotalInicial += a.peso;  // Initial weight
                const costo = a.costoTotal || (a.peso * a.precioKilo) || 0;
                inversionTotal += costo;
            });
            
            document.getElementById('headerTotalAnimals').textContent = inventario.length;
            document.getElementById('headerTotalKg').textContent = formatNumber(Math.round(kgTotalInicial));
            document.getElementById('headerTotalValue').textContent = formatCurrency(inversionTotal);
        }
        
        function updateInventarioTable() {
            let inventario = getInventario();
            const tbody = document.getElementById('inventarioTable');
            
            if (inventario.length === 0) {
                tbody.innerHTML = '<tr><td colspan="11" class="text-center">No hay animales en inventario</td></tr>';
                return;
            }
            
            // Apply sorting if active
            if (sortState.inventario.column) {
                const th = document.querySelector(`#inventarioTableContainer th[data-sort="${sortState.inventario.column}"]`);
                const type = th ? th.dataset.type : 'text';
                inventario = sortData(inventario, sortState.inventario.column, sortState.inventario.direction, type, 'inventario');
            }
            
            tbody.innerHTML = inventario.map(animal => {
                const diasEnFinca = getDiasEnFinca(animal.fechaEntrada);
                const pesoEstimado = animal.peso + (diasEnFinca * data.config.gdp);
                const inRetiro = isAnimalInRetiro(animal.numero);
                const potrero = data.animalPotreros[animal.numero] ? data.potreros.find(p => p.id === data.animalPotreros[animal.numero]) : null;
                
                return `
                    <tr class="clickable-row" onclick="showAnimalProfile('${animal.numero}')" title="Ver perfil del animal">
                        <td><strong>${animal.numero}</strong>${inRetiro ? ' üö´' : ''}</td>
                        <td>${animal.lote || '-'}</td>
                        <td>${animal.numeroVaca ? 'Nac. (' + animal.numeroVaca + ')' : animal.vendedor}</td>
                        <td>${animal.raza || '-'}</td>
                        <td>${animal.sexo === 'MACHO' ? '‚ôÇÔ∏è' : '‚ôÄÔ∏è'}</td>
                        <td class="text-right">${animal.peso} kg</td>
                        <td class="text-right">${formatCurrency(animal.precioKilo)}</td>
                        <td>${formatDate(animal.fechaEntrada)}</td>
                        <td class="text-right">${diasEnFinca}</td>
                        <td class="text-right"><strong>${pesoEstimado.toFixed(0)} kg</strong></td>
                        <td class="text-center">
                            <button class="btn btn-warning" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;" onclick="event.stopPropagation(); quickSale('${animal.numero}')">üíµ</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        function updateEntradasTable() {
            const tbody = document.getElementById('entradasTable');
            
            if (data.entradas.length === 0) {
                tbody.innerHTML = '<tr><td colspan="11" class="text-center">No hay entradas registradas</td></tr>';
                return;
            }
            
            // Default sort by date descending, or use active sort
            let sorted;
            if (sortState.entradas.column) {
                const th = document.querySelector(`#entradasTableContainer th[data-sort="${sortState.entradas.column}"]`);
                const type = th ? th.dataset.type : 'text';
                sorted = sortData(data.entradas, sortState.entradas.column, sortState.entradas.direction, type, 'entradas');
            } else {
                sorted = [...data.entradas].sort((a, b) => new Date(b.fechaEntrada) - new Date(a.fechaEntrada));
            }
            
            tbody.innerHTML = sorted.map(entrada => {
                const tipo = entrada.numeroVaca ? 'nacimiento' : 'compra';
                const vendedorMadre = entrada.numeroVaca ? `Madre: ${entrada.numeroVaca}` : entrada.vendedor;
                const sold = isAnimalSold(entrada.numero);
                
                return `
                    <tr>
                        <td><strong>${entrada.numero}</strong></td>
                        <td><span class="badge ${tipo === 'compra' ? 'badge-success' : 'badge-info'}">${tipo === 'compra' ? 'üõí' : 'üê£'}</span></td>
                        <td>${entrada.lote || '-'}</td>
                        <td>${vendedorMadre}</td>
                        <td>${entrada.raza || '-'}</td>
                        <td>${entrada.sexo === 'MACHO' ? '‚ôÇÔ∏è' : '‚ôÄÔ∏è'}</td>
                        <td class="text-right">${entrada.peso} kg</td>
                        <td class="text-right">${formatCurrency(entrada.precioKilo)}</td>
                        <td>${formatDate(entrada.fechaEntrada)}</td>
                        <td class="text-right">${formatCurrency(entrada.costoTotal)}</td>
                        <td><span class="badge ${sold ? 'badge-secondary' : 'badge-success'}">${sold ? 'Vendido' : 'En Finca'}</span></td>
                    </tr>
                `;
            }).join('');
        }
        
        function updateSalidasTable() {
            const tbody = document.getElementById('salidasTable');
            
            if (data.salidas.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center">No hay salidas registradas</td></tr>';
                return;
            }
            
            // Default sort by date descending, or use active sort
            let sorted;
            if (sortState.salidas.column) {
                const th = document.querySelector(`#salidasTableContainer th[data-sort="${sortState.salidas.column}"]`);
                const type = th ? th.dataset.type : 'text';
                sorted = sortData(data.salidas, sortState.salidas.column, sortState.salidas.direction, type, 'salidas');
            } else {
                sorted = [...data.salidas].sort((a, b) => new Date(b.fechaSalida) - new Date(a.fechaSalida));
            }
            
            tbody.innerHTML = sorted.map(salida => {
                const tipo = salida.comprador === 'MUERTE' ? 'muerte' : 'venta';
                
                return `
                    <tr>
                        <td><strong>${salida.numero}</strong></td>
                        <td><span class="badge ${tipo === 'venta' ? 'badge-warning' : 'badge-danger'}">${tipo === 'venta' ? 'üíµ' : '‚úùÔ∏è'}</span></td>
                        <td class="text-right">${salida.peso} kg</td>
                        <td>${formatDate(salida.fechaSalida)}</td>
                        <td class="text-right">${formatCurrency(salida.precioKiloVenta)}</td>
                        <td>${salida.comprador}${salida.causa ? ' (' + salida.causa + ')' : ''}</td>
                        <td class="text-right">${formatCurrency(salida.costoVenta)}</td>
                        <td class="text-right">${salida.gananciaDay ? salida.gananciaDay.toFixed(3) : '-'}</td>
                    </tr>
                `;
            }).join('');
        }
        
        function updateReports() {
            const compras = data.entradas.filter(e => !e.numeroVaca).length;
            const nacimientos = data.entradas.filter(e => e.numeroVaca).length;
            const ventas = data.salidas.filter(s => s.comprador !== 'MUERTE').length;
            const muertes = data.salidas.filter(s => s.comprador === 'MUERTE').length;
            
            document.getElementById('reportTotalCompras').textContent = compras;
            document.getElementById('reportTotalNacimientos').textContent = nacimientos;
            document.getElementById('reportTotalVentas').textContent = ventas;
            document.getElementById('reportTotalMuertes').textContent = muertes;
            
            // Vendedores report
            const vendedoresData = {};
            data.entradas.filter(e => !e.numeroVaca).forEach(e => {
                if (!vendedoresData[e.vendedor]) {
                    vendedoresData[e.vendedor] = { vendedor: e.vendedor, count: 0, kg: 0, inversion: 0 };
                }
                vendedoresData[e.vendedor].count++;
                vendedoresData[e.vendedor].kg += e.peso;
                vendedoresData[e.vendedor].inversion += e.costoTotal || 0;
            });
            
            // Add precioKg for sorting
            Object.values(vendedoresData).forEach(v => {
                v.precioKg = v.kg > 0 ? v.inversion / v.kg : 0;
            });
            
            const vendedoresTbody = document.getElementById('vendedoresReport');
            let vendedoresRows = Object.values(vendedoresData);
            
            // Apply sorting
            if (sortState.vendedores.column) {
                const th = document.querySelector(`#vendedoresTableContainer th[data-sort="${sortState.vendedores.column}"]`);
                const type = th ? th.dataset.type : 'text';
                vendedoresRows = sortData(vendedoresRows, sortState.vendedores.column, sortState.vendedores.direction, type, 'vendedores');
            } else {
                vendedoresRows.sort((a, b) => b.count - a.count);
            }
            
            if (vendedoresRows.length === 0) {
                vendedoresTbody.innerHTML = '<tr><td colspan="5" class="text-center">No hay datos</td></tr>';
            } else {
                vendedoresTbody.innerHTML = vendedoresRows.map(stats => `
                    <tr>
                        <td><strong>${stats.vendedor}</strong></td>
                        <td class="text-right">${stats.count}</td>
                        <td class="text-right">${formatNumber(stats.kg)} kg</td>
                        <td class="text-right">${formatCurrency(stats.inversion)}</td>
                        <td class="text-right">${formatCurrency(stats.precioKg)}</td>
                    </tr>
                `).join('');
            }
            
            // Compradores report
            const compradoresData = {};
            data.salidas.filter(s => s.comprador !== 'MUERTE').forEach(s => {
                if (!compradoresData[s.comprador]) {
                    compradoresData[s.comprador] = { comprador: s.comprador, count: 0, kg: 0, ingresos: 0, gdpSum: 0 };
                }
                compradoresData[s.comprador].count++;
                compradoresData[s.comprador].kg += s.peso;
                compradoresData[s.comprador].ingresos += s.costoVenta || 0;
                compradoresData[s.comprador].gdpSum += s.gananciaDay || 0;
            });
            
            // Add gdp for sorting
            Object.values(compradoresData).forEach(c => {
                c.gdp = c.count > 0 ? c.gdpSum / c.count : 0;
            });
            
            const compradoresTbody = document.getElementById('compradoresReport');
            let compradoresRows = Object.values(compradoresData);
            
            // Apply sorting
            if (sortState.compradores.column) {
                const th = document.querySelector(`#compradoresTableContainer th[data-sort="${sortState.compradores.column}"]`);
                const type = th ? th.dataset.type : 'text';
                compradoresRows = sortData(compradoresRows, sortState.compradores.column, sortState.compradores.direction, type, 'compradores');
            } else {
                compradoresRows.sort((a, b) => b.count - a.count);
            }
            
            if (compradoresRows.length === 0) {
                compradoresTbody.innerHTML = '<tr><td colspan="5" class="text-center">No hay datos</td></tr>';
            } else {
                compradoresTbody.innerHTML = compradoresRows.map(stats => `
                    <tr>
                        <td><strong>${stats.comprador}</strong></td>
                        <td class="text-right">${stats.count}</td>
                        <td class="text-right">${formatNumber(stats.kg)} kg</td>
                        <td class="text-right">${formatCurrency(stats.ingresos)}</td>
                        <td class="text-right">${stats.gdp.toFixed(3)} kg/d√≠a</td>
                    </tr>
                `).join('');
            }
        }
        
        function updateRecentActivity() {
            const activities = [];
            
            // Add entradas
            data.entradas.forEach(e => {
                activities.push({
                    fecha: e.fechaEntrada,
                    tipo: e.numeroVaca ? 'üê£ Nacimiento' : 'üõí Compra',
                    chapeta: e.numero,
                    detalle: e.numeroVaca ? `Madre: ${e.numeroVaca}` : `${e.vendedor} - ${e.peso} kg`
                });
            });
            
            // Add salidas
            data.salidas.forEach(s => {
                activities.push({
                    fecha: s.fechaSalida,
                    tipo: s.comprador === 'MUERTE' ? '‚úùÔ∏è Muerte' : 'üíµ Venta',
                    chapeta: s.numero,
                    detalle: s.comprador === 'MUERTE' ? (s.causa || 'Sin causa') : `${s.comprador} - ${s.peso} kg`
                });
            });
            
            // Sort by date descending and take last 10
            activities.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
            const recent = activities.slice(0, 10);
            
            const tbody = document.getElementById('recentActivity');
            if (recent.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center">No hay actividad reciente</td></tr>';
            } else {
                tbody.innerHTML = recent.map(a => `
                    <tr>
                        <td>${formatDate(a.fecha)}</td>
                        <td>${a.tipo}</td>
                        <td><strong>${a.chapeta}</strong></td>
                        <td>${a.detalle}</td>
                    </tr>
                `).join('');
            }
        }
        
        function updateFilters() {
            // Vendedor filter
            const vendedores = [...new Set(data.entradas.filter(e => !e.numeroVaca).map(e => e.vendedor))];
            const inventarioVendedorFilter = document.getElementById('inventarioVendedorFilter');
            if (inventarioVendedorFilter) {
                inventarioVendedorFilter.innerHTML = 
                    '<option value="">Todos los vendedores</option>' +
                    vendedores.map(v => `<option value="${v}">${v}</option>`).join('');
            }
            
            // Year filters
            const years = [...new Set([
                ...data.entradas.map(e => new Date(e.fechaEntrada).getFullYear()),
                ...data.salidas.map(s => new Date(s.fechaSalida).getFullYear())
            ])].sort((a, b) => b - a);
            
            const yearOptions = '<option value="">Todos los a√±os</option>' + years.map(y => `<option value="${y}">${y}</option>`).join('');
            
            const entradasYearSelect = document.getElementById('entradasYearSelect');
            if (entradasYearSelect) {
                entradasYearSelect.innerHTML = yearOptions;
            }
            
            const salidasYearSelect = document.getElementById('salidasYearSelect');
            if (salidasYearSelect) {
                salidasYearSelect.innerHTML = yearOptions;
            }
        }
        
        // ==================== FILTERS ====================
        function filterInventario() {
            const search = document.getElementById('inventarioSearch').value.toLowerCase();
            const sexo = document.getElementById('inventarioSexoFilter').value;
            const vendedor = document.getElementById('inventarioVendedorFilter').value;
            
            const rows = document.querySelectorAll('#inventarioTable tr');
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                const matchSearch = !search || text.includes(search);
                const matchSexo = !sexo || text.includes(sexo.toLowerCase());
                const matchVendedor = !vendedor || text.includes(vendedor.toLowerCase());
                
                row.style.display = matchSearch && matchSexo && matchVendedor ? '' : 'none';
            });
        }
        
        function handleEntradasPeriodoChange() {
            const periodo = document.getElementById('entradasPeriodoFilter').value;
            const yearSelect = document.getElementById('entradasYearSelect');
            const dateRange = document.getElementById('entradasDateRange');
            
            // Hide all extra controls first
            yearSelect.style.display = 'none';
            dateRange.style.display = 'none';
            
            // Show appropriate controls based on selection
            if (periodo === 'ano_especifico') {
                yearSelect.style.display = 'block';
                // Populate years if empty
                if (yearSelect.options.length <= 1) {
                    const years = [...new Set(data.entradas.map(e => new Date(e.fechaEntrada).getFullYear()))].sort((a, b) => b - a);
                    yearSelect.innerHTML = '<option value="">Seleccionar a√±o</option>' + 
                        years.map(y => `<option value="${y}">${y}</option>`).join('');
                }
            } else if (periodo === 'rango_fechas') {
                dateRange.style.display = 'flex';
            }
            
            // Apply filter
            filterEntradas();
        }
        
        function filterEntradas() {
            const search = document.getElementById('entradasSearch').value.toLowerCase();
            const tipo = document.getElementById('entradasTipoFilter').value;
            const periodo = document.getElementById('entradasPeriodoFilter').value;
            const yearSelect = document.getElementById('entradasYearSelect').value;
            const dateFrom = document.getElementById('entradasDateFrom').value;
            const dateTo = document.getElementById('entradasDateTo').value;
            
            const rows = document.querySelectorAll('#entradasTable tr');
            const today = new Date();
            const currentYear = today.getFullYear();
            const currentMonth = today.getMonth();
            
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length === 0) return; // Skip header or empty rows
                
                const text = row.textContent.toLowerCase();
                const matchSearch = !search || text.includes(search);
                const matchTipo = !tipo || text.includes(tipo);
                
                // Get the fecha from the row (assuming it's in column 9 - Fecha)
                const fechaCell = cells[8]?.textContent.trim();
                let matchPeriodo = true;
                
                if (periodo && fechaCell) {
                    const [day, month, year] = fechaCell.split('/').map(Number);
                    if (day && month && year) {
                        // Note: month is 1-12 in display, but Date uses 0-11
                        const fechaEntrada = new Date(year, month - 1, day);
                        
                        switch(periodo) {
                            case 'ano_actual':
                                matchPeriodo = fechaEntrada.getFullYear() === currentYear;
                                break;
                            case 'ultimo_mes':
                                const lastMonth = new Date(today);
                                lastMonth.setMonth(lastMonth.getMonth() - 1);
                                matchPeriodo = fechaEntrada >= lastMonth;
                                break;
                            case 'ultimo_lote':
                                // Find the most recent lote
                                const lotes = data.entradas.map(e => ({
                                    lote: e.lote,
                                    fecha: new Date(e.fechaEntrada)
                                }));
                                if (lotes.length > 0) {
                                    lotes.sort((a, b) => b.fecha - a.fecha);
                                    const ultimoLote = lotes[0].lote;
                                    const loteCell = cells[2]?.textContent.trim();
                                    matchPeriodo = loteCell === ultimoLote;
                                }
                                break;
                            case 'ano_especifico':
                                if (yearSelect) {
                                    matchPeriodo = fechaEntrada.getFullYear() === parseInt(yearSelect);
                                }
                                break;
                            case 'rango_fechas':
                                if (dateFrom && dateTo) {
                                    const from = new Date(dateFrom);
                                    const to = new Date(dateTo);
                                    matchPeriodo = fechaEntrada >= from && fechaEntrada <= to;
                                } else if (dateFrom) {
                                    const from = new Date(dateFrom);
                                    matchPeriodo = fechaEntrada >= from;
                                } else if (dateTo) {
                                    const to = new Date(dateTo);
                                    matchPeriodo = fechaEntrada <= to;
                                }
                                break;
                        }
                    }
                }
                
                row.style.display = matchSearch && matchTipo && matchPeriodo ? '' : 'none';
            });
        }
        
        function filterSalidas() {
            const search = document.getElementById('salidasSearch').value.toLowerCase();
            const tipo = document.getElementById('salidasTipoFilter').value;
            const year = document.getElementById('salidasYearFilter').value;
            
            const rows = document.querySelectorAll('#salidasTable tr');
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                const matchSearch = !search || text.includes(search);
                const matchTipo = !tipo || text.includes(tipo);
                const matchYear = !year || text.includes(year);
                
                row.style.display = matchSearch && matchTipo && matchYear ? '' : 'none';
            });
        }
        
        // ==================== QUICK ACTIONS ====================
        function quickSale(numero) {
            document.querySelector('.nav-tab[data-tab="eventos"]').click();
            setTimeout(() => {
                showEventForm('venta');
                // Pre-fill can be done after lote info is set
                // Store the number for later
                window.pendingQuickSaleNumber = numero;
                showToast(`Animal #${numero} listo para agregar a la venta`, 'info');
            }, 100);
        }
        
        // ==================== IMPORT/EXPORT ====================
        function handleExcelImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const workbook = XLSX.read(e.target.result, { type: 'array', cellDates: true });
                    
                    // Process Entradas sheet
                    if (workbook.SheetNames.includes('Entradas')) {
                        const sheet = workbook.Sheets['Entradas'];
                        const rows = XLSX.utils.sheet_to_json(sheet);
                        
                        data.entradas = rows.map(row => ({
                            numero: String(row['N√∫mero'] || row['Numero'] || ''),
                            lote: String(row['Lote'] || ''),
                            vendedor: row['Vendedor'] || '',
                            sexo: row['Sexo'] || 'MACHO',
                            peso: parseFloat(row['Peso']) || 0,
                            precioKilo: parseFloat(row['Precio/Kilo']) || 0,
                            fechaEntrada: parseExcelDate(row['Fecha'] || row['Fecha de entrada']),
                            numeroVaca: row['N√∫mero vaca'] || row['Numero vaca'] || null,
                            costoTotal: parseFloat(row['Costo Total']) || 0
                        })).filter(e => e.numero);
                    }
                    
                    // Process Salidas sheet
                    if (workbook.SheetNames.includes('Salidas')) {
                        const sheet = workbook.Sheets['Salidas'];
                        const rows = XLSX.utils.sheet_to_json(sheet);
                        
                        data.salidas = rows.map(row => ({
                            numero: String(row['N√∫mero'] || row['Numero'] || ''),
                            peso: parseFloat(row['Peso']) || 0,
                            fechaSalida: parseExcelDate(row['Fecha'] || row['Fecha Salida']),
                            precioKiloVenta: parseFloat(row['Precio/Kilo Venta']) || 0,
                            comprador: row['Comprador'] || '',
                            costoVenta: parseFloat(row['Costo de venta']) || 0,
                            gananciaDay: parseFloat(row['Ganancia/D√≠a']) || 0
                        })).filter(s => s.numero);
                    }
                    
                    saveData();
                    showToast(`Importados: ${data.entradas.length} entradas, ${data.salidas.length} salidas`, 'success');
                } catch (err) {
                    console.error(err);
                    showToast('Error al importar el archivo: ' + err.message, 'error');
                }
            };
            reader.readAsArrayBuffer(file);
            event.target.value = '';
        }
        
        function parseExcelDate(value) {
            if (!value) return new Date().toISOString().split('T')[0];
            
            if (value instanceof Date) {
                return value.toISOString().split('T')[0];
            }
            
            if (typeof value === 'number') {
                // Excel serial date
                const date = new Date((value - 25569) * 86400 * 1000);
                return date.toISOString().split('T')[0];
            }
            
            return String(value).split('T')[0];
        }
        
        function exportToExcel() {
            const wb = XLSX.utils.book_new();
            
            // Entradas sheet
            const entradasData = data.entradas.map(e => ({
                'N√∫mero': e.numero,
                'Lote': e.lote,
                'Vendedor': e.vendedor,
                'Sexo': e.sexo,
                'Peso': e.peso,
                'Precio/Kilo': e.precioKilo,
                'Fecha de entrada': e.fechaEntrada,
                'N√∫mero vaca': e.numeroVaca || '',
                'Costo Total': e.costoTotal,
                'Fecha': e.fechaEntrada
            }));
            const wsEntradas = XLSX.utils.json_to_sheet(entradasData);
            XLSX.utils.book_append_sheet(wb, wsEntradas, 'Entradas');
            
            // Salidas sheet
            const salidasData = data.salidas.map(s => ({
                'N√∫mero': s.numero,
                'Peso': s.peso,
                'Fecha Salida': s.fechaSalida,
                'Precio/Kilo Venta': s.precioKiloVenta,
                'Comprador': s.comprador,
                'Fecha': s.fechaSalida,
                'Costo de venta': s.costoVenta,
                'Ganancia/D√≠a': s.gananciaDay
            }));
            const wsSalidas = XLSX.utils.json_to_sheet(salidasData);
            XLSX.utils.book_append_sheet(wb, wsSalidas, 'Salidas');
            
            // Inventario sheet
            const inventario = getInventario();
            const inventarioData = inventario.map(a => {
                const dias = getDiasEnFinca(a.fechaEntrada);
                return {
                    'N√∫mero': a.numero,
                    'Lote': a.lote,
                    'Vendedor': a.vendedor,
                    'Sexo': a.sexo,
                    'Peso Inicial': a.peso,
                    'Precio/Kilo': a.precioKilo,
                    'Fecha de entrada': a.fechaEntrada,
                    'D√≠as en finca': dias,
                    'Peso Estimado': Math.round(a.peso + (dias * data.config.gdp)),
                    'Fecha': a.fechaEntrada
                };
            });
            const wsInventario = XLSX.utils.json_to_sheet(inventarioData);
            XLSX.utils.book_append_sheet(wb, wsInventario, 'Inventario');
            
            // Foto Sessions sheet
            if (data.fotoSesiones && data.fotoSesiones.length > 0) {
                const fotosData = data.fotoSesiones.map(f => ({
                    'N√∫mero': f.numero,
                    'Fecha': f.fecha,
                    'Temporada': f.temporada,
                    'BCS': f.bcs,
                    'Calidad Pasto': f.pasto,
                    'Peso Visual': f.pesoVisual || '',
                    'Peso B√°scula': f.pesoBascula || '',
                    'Num Fotos': f.numFotos,
                    'Salud': f.salud,
                    'Observaciones': f.observaciones || ''
                }));
                const wsFotos = XLSX.utils.json_to_sheet(fotosData);
                XLSX.utils.book_append_sheet(wb, wsFotos, 'SesionesFotos');
            }
            
            XLSX.writeFile(wb, 'ganado_finca_export.xlsx');
            showToast('Archivo exportado exitosamente', 'success');
        }
        
        function exportToCSV() {
            const inventario = getInventario();
            const headers = ['N√∫mero', 'Lote', 'Vendedor', 'Sexo', 'Peso Inicial', 'Precio/Kilo', 'Fecha Entrada', 'D√≠as en Finca', 'Peso Estimado'];
            
            const rows = inventario.map(a => {
                const dias = getDiasEnFinca(a.fechaEntrada);
                return [
                    a.numero,
                    a.lote,
                    a.vendedor,
                    a.sexo,
                    a.peso,
                    a.precioKilo,
                    a.fechaEntrada,
                    dias,
                    Math.round(a.peso + (dias * data.config.gdp))
                ];
            });
            
            const csv = [headers, ...rows].map(row => row.join(',')).join('\n');
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'inventario_ganado.csv';
            a.click();
            
            showToast('CSV exportado exitosamente', 'success');
        }
        
        function exportInventario() {
            exportToCSV();
        }
        
        // ==================== CONFIG ====================
        function saveConfig() {
            data.config.gdp = parseFloat(document.getElementById('configGDP').value) || 0.31;
            data.config.precioVenta = parseFloat(document.getElementById('configPrecioVenta').value) || 9000;
            data.config.pesoObjetivo = parseFloat(document.getElementById('configPesoObjetivo').value) || 450;
            data.config.pesoMinimo = parseFloat(document.getElementById('configPesoMinimo').value) || 380;
            data.config.fotoIntervalo = parseInt(document.getElementById('configFotoIntervalo').value) || 90;
            
            saveData();
            showToast('Configuraci√≥n guardada', 'success');
        }
        
        function clearAllData() {
            if (confirm('¬øEst√° seguro de borrar TODOS los datos? Esta acci√≥n no se puede deshacer.')) {
                if (confirm('¬øREALMENTE est√° seguro? Se perder√°n todas las entradas, salidas e inventario.')) {
                    data.entradas = [];
                    data.salidas = [];
                    saveData();
                    showToast('Todos los datos han sido borrados', 'warning');
                }
            }
        }
        
        // ==================== PHOTO SESSION FUNCTIONS ====================
        
        // Current session photos (temporary storage before save)
        let currentSessionPhotos = [];
        let currentPhotoType = 'lateral';
        let currentChapetaPhoto = null;
        
        function updateFotosView() {
            updateFotosPendientes();
            updateFotoHistorial();
            updateFotoSummary();
            updateBCSChartSelector();
        }
        
        // ==================== CHAPETA IDENTIFICATION ====================
        
        function handleChapetaCapture(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            compressImage(file, (compressedDataUrl) => {
                currentChapetaPhoto = compressedDataUrl;
                
                // Show chapeta preview
                document.getElementById('chapetaPreview').style.display = 'block';
                document.getElementById('chapetaPhotoImg').src = compressedDataUrl;
                document.getElementById('fotoNumeroFromPhoto').value = '';
                document.getElementById('fotoNumeroFromPhoto').focus();
                
                showToast('Foto de chapeta capturada. Ingresa el n√∫mero visible.', 'info');
            });
            
            event.target.value = '';
        }
        
        function handleManualChapeta(event) {
            const input = event.target;
            const numero = input.value.trim();
            
            if (numero.length > 0) {
                validateAndShowAnimalInfo(numero);
            } else {
                hideAnimalPhotosStep();
            }
        }
        
        function validateAndShowAnimalInfo(numero) {
            const inventario = getInventario();
            const animal = inventario.find(a => String(a.numero) === String(numero));
            
            document.getElementById('fotoNumero').value = numero;
            
            const infoDisplay = document.getElementById('animalInfoDisplay');
            const numeroDisplay = document.getElementById('animalInfoNumero');
            const detailsDisplay = document.getElementById('animalInfoDetails');
            const statusDisplay = document.getElementById('animalInfoStatus');
            
            if (animal) {
                // Animal found in inventory
                const diasEnFinca = getDiasEnFinca(animal.fechaEntrada);
                const pesoEstimado = animal.peso + (diasEnFinca * data.config.gdp);
                const ultimaFoto = getUltimaFoto(numero);
                const diasSinFoto = ultimaFoto ? getDiasDesde(ultimaFoto.fecha) : null;
                
                numeroDisplay.textContent = `#${numero}`;
                detailsDisplay.innerHTML = `
                    ${animal.sexo === 'MACHO' ? '‚ôÇÔ∏è' : '‚ôÄÔ∏è'} ${animal.vendedor || 'Nacimiento'} | 
                    Peso inicial: ${animal.peso} kg | 
                    Estimado: <strong>${pesoEstimado.toFixed(0)} kg</strong> | 
                    ${diasEnFinca} d√≠as en finca
                `;
                
                if (diasSinFoto === null) {
                    statusDisplay.innerHTML = '<span class="badge badge-warning">üÜï Sin fotos previas</span>';
                } else if (diasSinFoto > 90) {
                    statusDisplay.innerHTML = `<span class="badge badge-danger">üî¥ ${diasSinFoto} d√≠as sin foto</span>`;
                } else if (diasSinFoto > 60) {
                    statusDisplay.innerHTML = `<span class="badge badge-warning">üü° ${diasSinFoto} d√≠as sin foto</span>`;
                } else {
                    statusDisplay.innerHTML = `<span class="badge badge-success">üü¢ ${diasSinFoto} d√≠as sin foto</span>`;
                }
                
                infoDisplay.style.display = 'block';
                infoDisplay.style.background = '#e8f5e9';
                
                // Pre-fill BCS if there's a previous session
                if (ultimaFoto) {
                    document.getElementById('fotoBCS').value = ultimaFoto.bcs;
                    document.getElementById('fotoPasto').value = ultimaFoto.pasto || 'bueno';
                }
                
                showAnimalPhotosStep();
            } else {
                // Animal not found - might be new or typo
                numeroDisplay.textContent = `#${numero}`;
                detailsDisplay.textContent = '‚ö†Ô∏è Animal no encontrado en inventario actual';
                statusDisplay.innerHTML = '<span class="badge badge-secondary">Verificar n√∫mero</span>';
                
                infoDisplay.style.display = 'block';
                infoDisplay.style.background = '#fff3e0';
                
                // Still allow photos (might be newly purchased)
                showAnimalPhotosStep();
            }
        }
        
        function showAnimalPhotosStep() {
            document.getElementById('animalPhotosStep').style.display = 'block';
            updatePhotosProgressIndicator();
        }
        
        function hideAnimalPhotosStep() {
            document.getElementById('animalPhotosStep').style.display = 'none';
            document.getElementById('animalInfoDisplay').style.display = 'none';
            document.getElementById('fotoNumero').value = '';
        }
        
        function clearChapetaPhoto() {
            currentChapetaPhoto = null;
            document.getElementById('chapetaPreview').style.display = 'none';
            document.getElementById('chapetaPhotoImg').src = '';
            document.getElementById('fotoNumeroFromPhoto').value = '';
            hideAnimalPhotosStep();
        }
        
        function updatePhotosProgressIndicator() {
            const indicator = document.getElementById('photosProgressIndicator');
            const text = document.getElementById('photosProgressText');
            
            const hasLateral = currentSessionPhotos.some(p => p.type === 'lateral');
            const hasTrasera = currentSessionPhotos.some(p => p.type === 'trasera');
            const hasSuperior = currentSessionPhotos.some(p => p.type === 'superior');
            const count = currentSessionPhotos.length;
            
            if (hasLateral && hasTrasera) {
                indicator.style.background = '#e8f5e9';
                text.innerHTML = `‚úÖ ${count} foto(s) - M√≠nimo alcanzado ${hasSuperior ? '(+Superior)' : ''}`;
            } else {
                indicator.style.background = '#fff3e0';
                const missing = [];
                if (!hasLateral) missing.push('Lateral');
                if (!hasTrasera) missing.push('Trasera');
                text.innerHTML = `‚ö†Ô∏è ${count} foto(s) - Falta: ${missing.join(', ')}`;
            }
        }
        
        // ==================== CAMERA FUNCTIONS ====================
        
        function setPhotoType(type) {
            currentPhotoType = type;
            document.querySelectorAll('.photo-type-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.type === type) {
                    btn.classList.add('active');
                }
            });
        }
        
        function updateReferenciaHint() {
            const tipoRef = document.querySelector('input[name="tipoReferencia"]:checked')?.value || 'ninguna';
            const hintEl = document.getElementById('referenciaHint');
            const mangaSelector = document.getElementById('mangaPositionSelector');
            const refCheckboxes = document.getElementById('referenceCheckboxes');
            const distanciaSelector = document.getElementById('distanciaSelector');
            
            // Update hint text
            const hints = {
                'manga_calibrada': '‚úÖ Barras de la manga con marcas de altura para calibraci√≥n IA',
                'vara_1m': '‚úÖ La vara de 1m permite calibraci√≥n precisa para IA',
                'chapeta_only': '‚ö†Ô∏è Solo chapeta como referencia (precisi√≥n limitada)',
                'ninguna': '‚ùå Sin referencia - estimaci√≥n de peso menos precisa'
            };
            hintEl.textContent = hints[tipoRef] || '';
            
            // Update visual styling of radio buttons
            document.querySelectorAll('input[name="tipoReferencia"]').forEach(radio => {
                const label = radio.closest('label');
                if (radio.checked) {
                    label.style.background = '#e8f5e9';
                    label.style.borderColor = 'var(--success)';
                } else {
                    label.style.background = '#f5f5f5';
                    label.style.borderColor = 'transparent';
                }
            });
            
            // Show/hide manga position selector
            if (tipoRef === 'manga_calibrada') {
                mangaSelector.style.display = 'flex';
                refCheckboxes.style.display = 'none';
                distanciaSelector.style.display = 'none';
            } else if (tipoRef === 'vara_1m') {
                mangaSelector.style.display = 'none';
                refCheckboxes.style.display = 'flex';
                distanciaSelector.style.display = 'block';
            } else {
                mangaSelector.style.display = 'none';
                refCheckboxes.style.display = 'none';
                distanciaSelector.style.display = 'none';
            }
        }
        
        function handlePhotoCapture(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Check if animal is identified
            const numero = document.getElementById('fotoNumero').value;
            if (!numero) {
                showToast('Primero identifica el animal con la chapeta', 'error');
                event.target.value = '';
                return;
            }
            
            // Compress and store the image
            compressImage(file, (compressedDataUrl) => {
                const photo = {
                    id: Date.now(),
                    type: currentPhotoType,
                    dataUrl: compressedDataUrl,
                    timestamp: new Date().toISOString()
                };
                
                currentSessionPhotos.push(photo);
                updatePhotoPreviewGrid();
                updatePhotoTypeButtons();
                updatePhotosProgressIndicator();
                
                // Update photo count
                document.getElementById('fotoNumFotos').value = currentSessionPhotos.length;
                
                showToast(`Foto ${getPhotoTypeLabel(currentPhotoType)} capturada`, 'success');
                
                // Auto-advance to next photo type
                autoAdvancePhotoType();
            });
            
            // Reset the input
            event.target.value = '';
        }
        
        function compressImage(file, callback) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    // Calculate new dimensions (max 800px on longest side)
                    const maxSize = 800;
                    let width = img.width;
                    let height = img.height;
                    
                    if (width > height) {
                        if (width > maxSize) {
                            height *= maxSize / width;
                            width = maxSize;
                        }
                    } else {
                        if (height > maxSize) {
                            width *= maxSize / height;
                            height = maxSize;
                        }
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    
                    // Draw and compress
                    ctx.drawImage(img, 0, 0, width, height);
                    const compressedDataUrl = canvas.toDataURL('image/jpeg', 0.7);
                    
                    callback(compressedDataUrl);
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }
        
        function updatePhotoPreviewGrid() {
            const grid = document.getElementById('photoPreviewGrid');
            
            if (currentSessionPhotos.length === 0) {
                grid.innerHTML = '';
                return;
            }
            
            grid.innerHTML = currentSessionPhotos.map((photo, index) => `
                <div class="photo-thumbnail" onclick="viewPhoto('${photo.dataUrl}', '${getPhotoTypeLabel(photo.type)}')">
                    <img src="${photo.dataUrl}" alt="${photo.type}">
                    <button type="button" class="delete-photo" onclick="event.stopPropagation(); deleteSessionPhoto(${index})">√ó</button>
                    <div class="photo-label">${getPhotoTypeLabel(photo.type)}</div>
                </div>
            `).join('');
        }
        
        function updatePhotoTypeButtons() {
            const types = ['lateral', 'trasera', 'superior'];
            types.forEach(type => {
                const btn = document.querySelector(`.photo-type-btn[data-type="${type}"]`);
                if (btn) {
                    const hasPhoto = currentSessionPhotos.some(p => p.type === type);
                    btn.classList.toggle('has-photo', hasPhoto);
                }
            });
        }
        
        function autoAdvancePhotoType() {
            const typeOrder = ['lateral', 'trasera', 'superior'];
            const currentIndex = typeOrder.indexOf(currentPhotoType);
            
            if (currentIndex >= 0 && currentIndex < typeOrder.length - 1) {
                const nextType = typeOrder[currentIndex + 1];
                const hasNextPhoto = currentSessionPhotos.some(p => p.type === nextType);
                
                if (!hasNextPhoto) {
                    setPhotoType(nextType);
                }
            }
        }
        
        function getPhotoTypeLabel(type) {
            const labels = {
                'lateral': 'üìê Lateral',
                'trasera': 'üîô Trasera',
                'superior': '‚¨ÜÔ∏è Superior',
                'chapeta': 'üè∑Ô∏è Chapeta',
                'otra': 'üì∑ Otra'
            };
            return labels[type] || type;
        }
        
        function deleteSessionPhoto(index) {
            currentSessionPhotos.splice(index, 1);
            updatePhotoPreviewGrid();
            updatePhotoTypeButtons();
            updatePhotosProgressIndicator();
            document.getElementById('fotoNumFotos').value = currentSessionPhotos.length;
        }
        
        function clearPhotoSession() {
            if ((currentSessionPhotos.length > 0 || currentChapetaPhoto) && 
                !confirm('¬øLimpiar toda la sesi√≥n actual?')) return;
            
            // Clear all
            currentSessionPhotos = [];
            currentChapetaPhoto = null;
            currentPhotoType = 'lateral';
            
            // Reset form
            document.getElementById('fotoForm').reset();
            document.getElementById('fotoNumero').value = '';
            document.getElementById('fotoNumeroManual').value = '';
            document.getElementById('chapetaPreview').style.display = 'none';
            document.getElementById('chapetaPhotoImg').src = '';
            
            // Hide steps
            hideAnimalPhotosStep();
            
            // Reset photo UI
            updatePhotoPreviewGrid();
            updatePhotoTypeButtons();
            setPhotoType('lateral');
            
            // Reset date
            document.getElementById('fotoFecha').value = new Date().toISOString().split('T')[0];
            updateSeasonFromDate();
            
            showToast('Sesi√≥n limpiada', 'info');
        }
        
        function saveAndNextAnimal() {
            // First save current session
            const form = document.getElementById('fotoForm');
            if (!form.reportValidity()) return;
            
            // Trigger save
            saveFotoSesionInternal(true);
        }
        
        function populateFotoAnimalSelector() {
            const inventario = getInventario();
            const selector = document.getElementById('fotoAnimalSelector');
            
            if (!selector) return;
            
            if (inventario.length === 0) {
                selector.innerHTML = '<div style="padding: 1rem; text-align: center; color: var(--gray);">No hay animales en inventario</div>';
                return;
            }
            
            selector.innerHTML = inventario.map(animal => {
                const ultimaFoto = getUltimaFoto(animal.numero);
                const diasSinFoto = ultimaFoto ? getDiasDesde(ultimaFoto.fecha) : 999;
                const statusColor = diasSinFoto > 90 ? '#f44336' : diasSinFoto > 60 ? '#ff9800' : '#4caf50';
                
                return `
                    <div class="animal-option" data-numero="${animal.numero}" onclick="selectAnimalForFoto('${animal.numero}')">
                        <div>
                            <strong>#${animal.numero}</strong> - ${animal.sexo === 'MACHO' ? '‚ôÇÔ∏è' : '‚ôÄÔ∏è'} ${animal.vendedor || 'Nacimiento'}
                        </div>
                        <div style="color: ${statusColor}; font-size: 0.85rem;">
                            ${ultimaFoto ? diasSinFoto + ' d√≠as sin foto' : 'Sin fotos'}
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function selectAnimalForFoto(numero) {
            document.getElementById('fotoNumero').value = numero;
            
            document.querySelectorAll('#fotoAnimalSelector .animal-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            document.querySelector(`#fotoAnimalSelector .animal-option[data-numero="${numero}"]`).classList.add('selected');
            
            // Pre-fill with last known data
            const ultimaFoto = getUltimaFoto(numero);
            if (ultimaFoto) {
                document.getElementById('fotoBCS').value = ultimaFoto.bcs;
                document.getElementById('fotoPasto').value = ultimaFoto.pasto || 'bueno';
            }
        }
        
        function filterAnimalsForFoto() {
            const search = document.getElementById('fotoSearch').value.toLowerCase();
            document.querySelectorAll('#fotoAnimalSelector .animal-option').forEach(opt => {
                const numero = opt.dataset.numero.toLowerCase();
                opt.style.display = numero.includes(search) ? '' : 'none';
            });
        }
        
        function updateSeasonFromDate() {
            const fecha = document.getElementById('fotoFecha').value;
            if (!fecha) return;
            
            const month = new Date(fecha).getMonth() + 1; // 1-12
            let temporada;
            
            if (month >= 4 && month <= 5) {
                temporada = 'lluvias_fuertes';
            } else if (month >= 6 && month <= 8) {
                temporada = 'veranillo';
            } else if (month >= 9 && month <= 11) {
                temporada = 'lluvias';
            } else {
                temporada = 'seco';
            }
            
            document.getElementById('fotoTemporada').value = temporada;
        }
        
        function getUltimaFoto(numero) {
            if (!data.fotoSesiones) return null;
            const sesiones = data.fotoSesiones.filter(s => s.numero == numero);
            if (sesiones.length === 0) return null;
            return sesiones.sort((a, b) => new Date(b.fecha) - new Date(a.fecha))[0];
        }
        
        function getDiasDesde(fecha) {
            return Math.floor((new Date() - new Date(fecha)) / (1000 * 60 * 60 * 24));
        }
        
        function saveFotoSesion(event) {
            event.preventDefault();
            saveFotoSesionInternal(false);
        }
        
        function saveFotoSesionInternal(continueToNext) {
            const numero = document.getElementById('fotoNumero').value;
            if (!numero) {
                showToast('Debe identificar un animal primero', 'error');
                return;
            }
            
            if (currentSessionPhotos.length === 0) {
                showToast('Debe tomar al menos una foto del animal', 'error');
                return;
            }
            
            // Check minimum photos
            const hasLateral = currentSessionPhotos.some(p => p.type === 'lateral');
            const hasTrasera = currentSessionPhotos.some(p => p.type === 'trasera');
            
            if (!hasLateral || !hasTrasera) {
                if (!confirm('‚ö†Ô∏è Faltan fotos recomendadas (Lateral y Trasera). ¬øGuardar de todas formas?')) {
                    return;
                }
            }
            
            // Get reference data
            const tipoReferencia = document.querySelector('input[name="tipoReferencia"]:checked')?.value || 'ninguna';
            const distancia = document.querySelector('input[name="distanciaFoto"]:checked')?.value || '3m';
            const refVisibility = {
                lateral: document.getElementById('refVisibleLateral')?.checked || false,
                trasera: document.getElementById('refVisibleTrasera')?.checked || false,
                superior: document.getElementById('refVisibleSuperior')?.checked || false
            };
            
            // Get manga-specific data if using manga calibrada
            const posicionManga = document.querySelector('input[name="posicionManga"]:checked')?.value || 'centro';
            const marcasVisibles = document.getElementById('marcasVisibles')?.checked || false;
            
            // Build all photos array (chapeta first, then body photos)
            const allPhotos = [];
            
            // Add chapeta photo if captured
            if (currentChapetaPhoto) {
                allPhotos.push({
                    type: 'chapeta',
                    dataUrl: currentChapetaPhoto,
                    timestamp: new Date().toISOString(),
                    hasReference: false
                });
            }
            
            // Add body photos with reference visibility
            currentSessionPhotos.forEach(p => {
                allPhotos.push({
                    type: p.type,
                    dataUrl: p.dataUrl,
                    timestamp: p.timestamp,
                    hasReference: tipoReferencia === 'manga_calibrada' ? marcasVisibles : (refVisibility[p.type] || false)
                });
            });
            
            const sesion = {
                id: Date.now(),
                numero: numero,
                fecha: document.getElementById('fotoFecha').value,
                temporada: document.getElementById('fotoTemporada').value,
                bcs: parseInt(document.getElementById('fotoBCS').value),
                pasto: document.getElementById('fotoPasto').value,
                pesoVisual: parseFloat(document.getElementById('fotoPesoVisual').value) || null,
                pesoBascula: parseFloat(document.getElementById('fotoPesoBascula').value) || null,
                numFotos: allPhotos.length,
                fotos: allPhotos,
                // Reference calibration data
                calibracion: {
                    tipoReferencia: tipoReferencia,
                    distancia: tipoReferencia === 'manga_calibrada' ? 'manga' : distancia,
                    refVisibility: refVisibility,
                    // Manga-specific data
                    posicionManga: tipoReferencia === 'manga_calibrada' ? posicionManga : null,
                    marcasVisibles: tipoReferencia === 'manga_calibrada' ? marcasVisibles : null
                },
                salud: document.getElementById('fotoSalud').value,
                observaciones: document.getElementById('fotoObservaciones').value.trim()
            };
            
            if (!data.fotoSesiones) data.fotoSesiones = [];
            data.fotoSesiones.push(sesion);
            
            // Try to save
            try {
                saveData();
                const refInfo = tipoReferencia !== 'ninguna' ? ` (Ref: ${tipoReferencia})` : '';
                showToast(`‚úÖ Sesi√≥n guardada: #${numero} (${allPhotos.length} fotos)${refInfo}`, 'success');
            } catch (e) {
                if (e.name === 'QuotaExceededError') {
                    showToast('‚ö†Ô∏è Almacenamiento lleno. Exporta y borra sesiones antiguas.', 'error');
                    data.fotoSesiones.pop();
                    return;
                }
                throw e;
            }
            
            // Clear current session
            currentSessionPhotos = [];
            currentChapetaPhoto = null;
            
            if (continueToNext) {
                // Prepare for next animal
                document.getElementById('fotoNumeroManual').value = '';
                document.getElementById('chapetaPreview').style.display = 'none';
                hideAnimalPhotosStep();
                updatePhotoPreviewGrid();
                updatePhotoTypeButtons();
                setPhotoType('lateral');
                
                // Keep same date, season, and reference settings
                showToast('üì∑ Listo para el siguiente animal', 'info');
                
                // Scroll to top
                window.scrollTo({ top: 0, behavior: 'smooth' });
            } else {
                // Full reset
                clearPhotoSession();
            }
        }
        
        function viewPhoto(dataUrl, label) {
            // Clear any existing session navigation
            window.currentViewingSession = null;
            window.currentPhotoIndex = 0;
            
            const viewer = document.getElementById('photoViewer');
            const img = document.getElementById('photoViewerImg');
            const info = document.getElementById('photoViewerInfo');
            const nav = document.getElementById('photoViewerNav');
            
            img.src = dataUrl;
            info.textContent = label;
            nav.style.display = 'none';
            viewer.classList.add('active');
            
            document.addEventListener('keydown', function escHandler(e) {
                if (e.key === 'Escape') {
                    closePhotoViewer();
                    document.removeEventListener('keydown', escHandler);
                }
            });
        }
        
        function updateFotoSummary() {
            const inventario = getInventario();
            let vencidas = 0, prontas = 0, alDia = 0;
            
            inventario.forEach(animal => {
                const ultimaFoto = getUltimaFoto(animal.numero);
                const diasSinFoto = ultimaFoto ? getDiasDesde(ultimaFoto.fecha) : 999;
                
                if (diasSinFoto > 90) vencidas++;
                else if (diasSinFoto > 60) prontas++;
                else alDia++;
            });
            
            document.getElementById('fotosVencidas').textContent = vencidas;
            document.getElementById('fotosProntas').textContent = prontas;
            document.getElementById('fotosAlDia').textContent = alDia;
            document.getElementById('totalSesiones').textContent = data.fotoSesiones ? data.fotoSesiones.length : 0;
        }
        
        function updateFotosPendientes() {
            const inventario = getInventario();
            const tbody = document.getElementById('fotosPendientesTable');
            
            // Create list with photo status
            const animalesConStatus = inventario.map(animal => {
                const ultimaFoto = getUltimaFoto(animal.numero);
                const diasSinFoto = ultimaFoto ? getDiasDesde(ultimaFoto.fecha) : 999;
                const diasEnFinca = getDiasEnFinca(animal.fechaEntrada);
                const pesoEstimado = animal.peso + (diasEnFinca * data.config.gdp);
                
                return {
                    ...animal,
                    ultimaFoto,
                    diasSinFoto,
                    pesoEstimado
                };
            });
            
            // Filter to only show animals needing photos (>60 days)
            const pendientes = animalesConStatus.filter(a => a.diasSinFoto > 60)
                .sort((a, b) => b.diasSinFoto - a.diasSinFoto);
            
            if (pendientes.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center" style="color: var(--success);">‚úÖ Todos los animales tienen fotos al d√≠a</td></tr>';
                return;
            }
            
            tbody.innerHTML = pendientes.map(animal => {
                const statusClass = animal.diasSinFoto > 90 ? 'badge-danger' : 'badge-warning';
                const statusText = animal.diasSinFoto > 90 ? 'üî¥ Vencida' : 'üü° Pr√≥xima';
                
                return `
                    <tr>
                        <td><strong>${animal.numero}</strong></td>
                        <td>${animal.vendedor || 'Nacimiento'}</td>
                        <td class="text-right"><strong>${animal.diasSinFoto === 999 ? 'Nunca' : animal.diasSinFoto + ' d√≠as'}</strong></td>
                        <td>${animal.ultimaFoto ? formatDate(animal.ultimaFoto.fecha) : 'Nunca'}</td>
                        <td>${animal.ultimaFoto ? getBCSDisplay(animal.ultimaFoto.bcs) : '-'}</td>
                        <td class="text-right">${animal.pesoEstimado.toFixed(0)} kg</td>
                        <td><span class="badge ${statusClass}">${statusText}</span></td>
                        <td class="text-center">
                            <button class="btn btn-primary" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;" onclick="quickFoto('${animal.numero}')">üì∑ Foto</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        function updateFotoHistorial() {
            const tbody = document.getElementById('fotoHistorialTable');
            
            if (!data.fotoSesiones || data.fotoSesiones.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" class="text-center">No hay sesiones registradas</td></tr>';
                return;
            }
            
            let sesiones = [...data.fotoSesiones];
            
            // Apply sorting if active
            if (sortState.fotoSesiones && sortState.fotoSesiones.column) {
                const th = document.querySelector(`#fotoHistorialTableContainer th[data-sort="${sortState.fotoSesiones.column}"]`);
                const type = th ? th.dataset.type : 'text';
                sesiones = sortData(sesiones, sortState.fotoSesiones.column, sortState.fotoSesiones.direction, type, 'fotoSesiones');
            } else {
                sesiones.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
            }
            
            tbody.innerHTML = sesiones.map(sesion => {
                // Generate photo thumbnails
                let fotosHtml = '-';
                if (sesion.fotos && sesion.fotos.length > 0) {
                    fotosHtml = `
                        <div style="display: flex; gap: 4px;">
                            ${sesion.fotos.slice(0, 3).map(foto => `
                                <img src="${foto.dataUrl}" 
                                     style="width: 40px; height: 40px; object-fit: cover; border-radius: 4px; cursor: pointer;"
                                     onclick="viewPhoto('${foto.dataUrl}', '${getPhotoTypeLabel(foto.type)} - #${sesion.numero}')"
                                     title="${getPhotoTypeLabel(foto.type)}">
                            `).join('')}
                            ${sesion.fotos.length > 3 ? `<span style="font-size: 0.8rem; color: var(--gray);">+${sesion.fotos.length - 3}</span>` : ''}
                        </div>
                    `;
                } else if (sesion.numFotos) {
                    fotosHtml = `<span class="badge badge-secondary">${sesion.numFotos} fotos</span>`;
                }
                
                return `
                    <tr>
                        <td><strong>${sesion.numero}</strong></td>
                        <td>${formatDate(sesion.fecha)}</td>
                        <td>${getTemporadaDisplay(sesion.temporada)}</td>
                        <td class="text-center">${getBCSDisplay(sesion.bcs)}</td>
                        <td>${getPastoDisplay(sesion.pasto)}</td>
                        <td class="text-right">${sesion.pesoVisual ? sesion.pesoVisual + ' kg' : '-'}</td>
                        <td class="text-right">${sesion.pesoBascula ? sesion.pesoBascula + ' kg' : '-'}</td>
                        <td>${fotosHtml}</td>
                        <td>${getSaludDisplay(sesion.salud)}</td>
                        <td class="text-center">
                            <button class="btn btn-primary" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;" onclick="viewSessionPhotos(${sesion.id})" ${!sesion.fotos || sesion.fotos.length === 0 ? 'disabled' : ''}>üëÅÔ∏è</button>
                            <button class="btn btn-danger" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;" onclick="deleteFotoSesion(${sesion.id})">üóëÔ∏è</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        function viewSessionPhotos(sessionId) {
            const sesion = data.fotoSesiones.find(s => s.id === sessionId);
            if (!sesion || !sesion.fotos || sesion.fotos.length === 0) {
                showToast('No hay fotos en esta sesi√≥n', 'info');
                return;
            }
            
            // Store session for navigation
            window.currentViewingSession = sesion;
            window.currentPhotoIndex = 0;
            
            // Show first photo
            updatePhotoViewerDisplay();
            document.getElementById('photoViewer').classList.add('active');
            
            // Show navigation buttons if multiple photos
            const navButtons = document.getElementById('photoViewerNav');
            navButtons.style.display = sesion.fotos.length > 1 ? 'flex' : 'none';
            
            // Add keyboard navigation
            document.addEventListener('keydown', handlePhotoNavigation);
            
            // Add touch/swipe support
            addSwipeSupport();
        }
        
        function navigatePhoto(direction) {
            if (!window.currentViewingSession) return;
            
            const fotos = window.currentViewingSession.fotos;
            window.currentPhotoIndex = (window.currentPhotoIndex + direction + fotos.length) % fotos.length;
            updatePhotoViewerDisplay();
        }
        
        function updatePhotoViewerDisplay() {
            const sesion = window.currentViewingSession;
            const fotos = sesion.fotos;
            const foto = fotos[window.currentPhotoIndex];
            
            document.getElementById('photoViewerImg').src = foto.dataUrl;
            document.getElementById('photoViewerInfo').textContent = 
                `#${sesion.numero} - ${getPhotoTypeLabel(foto.type)} (${window.currentPhotoIndex + 1}/${fotos.length})`;
        }
        
        function addSwipeSupport() {
            const viewer = document.getElementById('photoViewer');
            let touchStartX = 0;
            let touchEndX = 0;
            
            viewer.ontouchstart = (e) => {
                touchStartX = e.changedTouches[0].screenX;
            };
            
            viewer.ontouchend = (e) => {
                touchEndX = e.changedTouches[0].screenX;
                handleSwipe();
            };
            
            function handleSwipe() {
                const swipeThreshold = 50;
                const diff = touchStartX - touchEndX;
                
                if (Math.abs(diff) > swipeThreshold) {
                    if (diff > 0) {
                        // Swipe left - next photo
                        navigatePhoto(1);
                    } else {
                        // Swipe right - previous photo
                        navigatePhoto(-1);
                    }
                }
            }
        }
        
        function handlePhotoNavigation(e) {
            if (!window.currentViewingSession) return;
            
            const viewer = document.getElementById('photoViewer');
            if (!viewer.classList.contains('active')) {
                document.removeEventListener('keydown', handlePhotoNavigation);
                return;
            }
            
            if (e.key === 'ArrowRight' || e.key === ' ') {
                e.preventDefault();
                navigatePhoto(1);
            } else if (e.key === 'ArrowLeft') {
                e.preventDefault();
                navigatePhoto(-1);
            } else if (e.key === 'Escape') {
                closePhotoViewer();
            }
        }
        
        function closePhotoViewer(event) {
            if (event && event.target !== document.getElementById('photoViewer') && 
                event.target !== document.querySelector('.photo-viewer-close')) return;
            
            document.getElementById('photoViewer').classList.remove('active');
            document.removeEventListener('keydown', handlePhotoNavigation);
            window.currentViewingSession = null;
            window.currentPhotoIndex = 0;
        }
        
        function getBCSDisplay(bcs) {
            const colors = { 1: '#f44336', 2: '#ff9800', 3: '#4caf50', 4: '#2196f3', 5: '#9c27b0' };
            const labels = { 1: 'Muy Flaco', 2: 'Flaco', 3: 'Normal', 4: 'Gordo', 5: 'Obeso' };
            return `<span class="badge" style="background: ${colors[bcs]}; color: white;">${bcs} - ${labels[bcs]}</span>`;
        }
        
        function getTemporadaDisplay(temporada) {
            const map = {
                'lluvias_fuertes': 'üåßÔ∏è Lluvias Fuertes',
                'veranillo': 'üå§Ô∏è Veranillo',
                'lluvias': 'üåßÔ∏è Lluvias',
                'seco': '‚òÄÔ∏è Seco'
            };
            return map[temporada] || temporada;
        }
        
        function getPastoDisplay(pasto) {
            const map = {
                'excelente': 'üåø Excelente',
                'bueno': 'üå± Bueno',
                'regular': 'üåæ Regular',
                'malo': 'ü•Ä Malo'
            };
            return map[pasto] || pasto;
        }
        
        function getSaludDisplay(salud) {
            const map = {
                'excelente': 'üíö',
                'bueno': 'üíô',
                'regular': 'üíõ',
                'enfermo': '‚ù§Ô∏è'
            };
            return map[salud] || salud;
        }
        
        function quickFoto(numero) {
            // Clear any existing session
            currentSessionPhotos = [];
            updatePhotoPreviewGrid();
            updatePhotoTypeButtons();
            setPhotoType('lateral');
            
            // Navigate to photos tab and select animal
            document.querySelector('.nav-tab[data-tab="fotos"]').click();
            setTimeout(() => {
                selectAnimalForFoto(numero);
                document.getElementById('fotoFecha').value = new Date().toISOString().split('T')[0];
                updateSeasonFromDate();
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }, 100);
        }
        
        function deleteFotoSesion(id) {
            if (!confirm('¬øEliminar esta sesi√≥n de fotos?')) return;
            
            data.fotoSesiones = data.fotoSesiones.filter(s => s.id !== id);
            saveData();
            showToast('Sesi√≥n eliminada', 'warning');
        }
        
        function updateBCSChartSelector() {
            const select = document.getElementById('bcsChartAnimal');
            if (!select) return;
            
            const inventario = getInventario();
            const animalesConFotos = inventario.filter(a => {
                return data.fotoSesiones && data.fotoSesiones.some(s => s.numero == a.numero);
            });
            
            select.innerHTML = '<option value="">-- Seleccionar Animal --</option>' +
                animalesConFotos.map(a => `<option value="${a.numero}">#${a.numero} - ${a.vendedor || 'Nacimiento'}</option>`).join('');
        }
        
        function updateBCSChart() {
            const numero = document.getElementById('bcsChartAnimal').value;
            const container = document.getElementById('bcsChartContainer');
            
            if (!numero) {
                container.innerHTML = '<div style="text-align: center; color: var(--gray); padding: 2rem;">Selecciona un animal para ver su historial de condici√≥n corporal</div>';
                return;
            }
            
            const sesiones = data.fotoSesiones.filter(s => s.numero == numero)
                .sort((a, b) => new Date(a.fecha) - new Date(b.fecha));
            
            if (sesiones.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: var(--gray); padding: 2rem;">No hay sesiones para este animal</div>';
                return;
            }
            
            // Create simple text-based chart
            const maxBCS = 5;
            const chartHeight = 150;
            
            let html = `
                <div style="display: flex; align-items: flex-end; gap: 1rem; height: ${chartHeight}px; padding: 1rem; background: #f5f5f5; border-radius: 8px; overflow-x: auto;">
            `;
            
            sesiones.forEach((sesion, i) => {
                const height = (sesion.bcs / maxBCS) * (chartHeight - 40);
                const colors = { 1: '#f44336', 2: '#ff9800', 3: '#4caf50', 4: '#2196f3', 5: '#9c27b0' };
                
                html += `
                    <div style="display: flex; flex-direction: column; align-items: center; min-width: 60px;">
                        <div style="font-weight: bold; margin-bottom: 4px;">BCS ${sesion.bcs}</div>
                        <div style="width: 40px; height: ${height}px; background: ${colors[sesion.bcs]}; border-radius: 4px 4px 0 0;"></div>
                        <div style="font-size: 0.7rem; margin-top: 4px; text-align: center;">${formatDate(sesion.fecha)}</div>
                    </div>
                `;
            });
            
            html += '</div>';
            
            // Add peso tracking if available
            const pesosBascula = sesiones.filter(s => s.pesoBascula);
            if (pesosBascula.length > 0) {
                html += `
                    <div style="margin-top: 1rem;">
                        <strong>Pesos Registrados (B√°scula):</strong>
                        <div style="display: flex; gap: 1rem; flex-wrap: wrap; margin-top: 0.5rem;">
                            ${pesosBascula.map(s => `
                                <div style="background: #e3f2fd; padding: 0.5rem 1rem; border-radius: 8px;">
                                    <div style="font-weight: bold;">${s.pesoBascula} kg</div>
                                    <div style="font-size: 0.8rem; color: var(--gray);">${formatDate(s.fecha)}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            container.innerHTML = html;
        }
        
        function filterFotoHistorial() {
            const search = document.getElementById('fotoHistorialSearch').value.toLowerCase();
            const temporada = document.getElementById('fotoTemporadaFilter').value;
            const bcs = document.getElementById('fotoBCSFilter').value;
            
            const rows = document.querySelectorAll('#fotoHistorialTable tr');
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                const matchSearch = !search || text.includes(search);
                const matchTemporada = !temporada || text.includes(getTemporadaDisplay(temporada).toLowerCase());
                const matchBCS = !bcs || row.querySelector('td:nth-child(4)')?.textContent.includes(bcs);
                
                row.style.display = matchSearch && matchTemporada && matchBCS ? '' : 'none';
            });
        }
        
        function startBulkFotoSession() {
            showToast('Funci√≥n de sesi√≥n masiva pr√≥ximamente. Por ahora, registra cada animal individualmente.', 'info');
        }
        
        function exportFotosPendientes() {
            const inventario = getInventario();
            const pendientes = inventario.map(animal => {
                const ultimaFoto = getUltimaFoto(animal.numero);
                const diasSinFoto = ultimaFoto ? getDiasDesde(ultimaFoto.fecha) : 999;
                return { ...animal, diasSinFoto, ultimaFoto };
            }).filter(a => a.diasSinFoto > 60).sort((a, b) => b.diasSinFoto - a.diasSinFoto);
            
            const headers = ['Chapeta', 'Vendedor', 'D√≠as Sin Foto', '√öltima Foto', '√öltimo BCS'];
            const rows = pendientes.map(a => [
                a.numero,
                a.vendedor || 'Nacimiento',
                a.diasSinFoto === 999 ? 'Nunca' : a.diasSinFoto,
                a.ultimaFoto ? a.ultimaFoto.fecha : 'Nunca',
                a.ultimaFoto ? a.ultimaFoto.bcs : '-'
            ]);
            
            const csv = [headers, ...rows].map(row => row.join(',')).join('\n');
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'animales_pendientes_fotos.csv';
            a.click();
            
            showToast('Lista exportada', 'success');
        }
        
        // ==================== SALUD (HEALTH) MODULE ====================
        function showSaludForm(tipo) {
            document.getElementById('saludFormContainer').style.display = 'block';
            document.getElementById('saludTipo').value = tipo;
            document.getElementById('saludFecha').value = new Date().toISOString().split('T')[0];
            
            const titles = {
                'vacuna': 'üíâ Registrar Vacunaci√≥n',
                'desparasitacion': 'üêõ Registrar Desparasitaci√≥n',
                'tratamiento': 'üíä Registrar Tratamiento',
                'revision': 'ü©∫ Registrar Revisi√≥n Veterinaria'
            };
            document.getElementById('saludFormTitle').textContent = titles[tipo] || 'üíâ Registrar Evento de Salud';
            
            // Show/hide relevant fields
            document.getElementById('saludRetiroGroup').style.display = (tipo === 'tratamiento') ? 'block' : 'none';
            document.getElementById('saludProximaGroup').style.display = (tipo === 'vacuna' || tipo === 'desparasitacion') ? 'block' : 'none';
            
            // Update product label
            const labels = {
                'vacuna': 'Tipo de Vacuna',
                'desparasitacion': 'Desparasitante',
                'tratamiento': 'Medicamento',
                'revision': 'Tipo de Revisi√≥n'
            };
            document.getElementById('saludProductoLabel').textContent = labels[tipo] || 'Producto';
            
            // Populate animal selector
            populateSaludAnimalSelector();
            selectedSaludAnimals.clear();
            updateSaludSelectedCount();
        }
        
        function hideSaludForm() {
            document.getElementById('saludFormContainer').style.display = 'none';
            document.getElementById('saludForm').reset();
            selectedSaludAnimals.clear();
        }
        
        function populateSaludAnimalSelector() {
            const container = document.getElementById('saludAnimalSelector');
            const inventario = getInventario();
            
            if (inventario.length === 0) {
                container.innerHTML = '<div style="grid-column: 1/-1; text-align: center; color: var(--gray);">No hay animales en inventario</div>';
                return;
            }
            
            container.innerHTML = inventario.map(a => {
                const inRetiro = isAnimalInRetiro(a.numero);
                return `<div class="animal-chip ${inRetiro ? 'in-retiro' : ''}" data-numero="${a.numero}" onclick="toggleSaludAnimal('${a.numero}')">${a.numero}${inRetiro ? ' üö´' : ''}</div>`;
            }).join('');
        }
        
        function toggleSaludAnimal(numero) {
            if (selectedSaludAnimals.has(numero)) {
                selectedSaludAnimals.delete(numero);
            } else {
                selectedSaludAnimals.add(numero);
            }
            
            document.querySelectorAll('#saludAnimalSelector .animal-chip').forEach(chip => {
                if (chip.dataset.numero === numero) {
                    chip.classList.toggle('selected');
                }
            });
            
            updateSaludSelectedCount();
        }
        
        function selectAllAnimalsForSalud() {
            const inventario = getInventario();
            inventario.forEach(a => selectedSaludAnimals.add(a.numero));
            document.querySelectorAll('#saludAnimalSelector .animal-chip').forEach(chip => {
                chip.classList.add('selected');
            });
            updateSaludSelectedCount();
        }
        
        function clearSaludSelection() {
            selectedSaludAnimals.clear();
            document.querySelectorAll('#saludAnimalSelector .animal-chip').forEach(chip => {
                chip.classList.remove('selected');
            });
            updateSaludSelectedCount();
        }
        
        function filterAnimalsForSalud() {
            const search = document.getElementById('saludSearchAnimal').value.toLowerCase();
            document.querySelectorAll('#saludAnimalSelector .animal-chip').forEach(chip => {
                const numero = chip.dataset.numero.toLowerCase();
                chip.style.display = numero.includes(search) ? '' : 'none';
            });
        }
        
        function updateSaludSelectedCount() {
            document.getElementById('saludSelectedCount').textContent = selectedSaludAnimals.size;
        }
        
        function isAnimalInRetiro(numero) {
            const today = new Date();
            return data.saludEventos.some(e => {
                if (!e.diasRetiro || e.diasRetiro <= 0) return false;
                if (!e.animales.includes(numero)) return false;
                const eventDate = new Date(e.fecha);
                const retiroEnd = new Date(eventDate);
                retiroEnd.setDate(retiroEnd.getDate() + e.diasRetiro);
                return today < retiroEnd;
            });
        }
        
        function getRetiroEndDate(numero) {
            const today = new Date();
            let latestRetiro = null;
            
            data.saludEventos.forEach(e => {
                if (!e.diasRetiro || e.diasRetiro <= 0) return;
                if (!e.animales.includes(numero)) return;
                const eventDate = new Date(e.fecha);
                const retiroEnd = new Date(eventDate);
                retiroEnd.setDate(retiroEnd.getDate() + e.diasRetiro);
                if (retiroEnd > today && (!latestRetiro || retiroEnd > latestRetiro)) {
                    latestRetiro = retiroEnd;
                }
            });
            
            return latestRetiro;
        }
        
        function saveSaludEvento(event) {
            event.preventDefault();
            
            if (selectedSaludAnimals.size === 0) {
                showToast('Debe seleccionar al menos un animal', 'error');
                return;
            }
            
            const evento = {
                id: Date.now(),
                tipo: document.getElementById('saludTipo').value,
                fecha: document.getElementById('saludFecha').value,
                producto: document.getElementById('saludProducto').value.trim(),
                dosis: document.getElementById('saludDosis').value.trim(),
                loteProducto: document.getElementById('saludLoteProducto').value.trim(),
                diasRetiro: parseInt(document.getElementById('saludDiasRetiro').value) || 0,
                proximaFecha: document.getElementById('saludProximaFecha').value || null,
                veterinario: document.getElementById('saludVeterinario').value.trim(),
                observaciones: document.getElementById('saludObservaciones').value.trim(),
                animales: Array.from(selectedSaludAnimals)
            };
            
            data.saludEventos.push(evento);
            saveData();
            
            const tipoNames = { 'vacuna': 'Vacunaci√≥n', 'desparasitacion': 'Desparasitaci√≥n', 'tratamiento': 'Tratamiento', 'revision': 'Revisi√≥n' };
            showToast(`${tipoNames[evento.tipo]} registrada para ${evento.animales.length} animales`, 'success');
            
            hideSaludForm();
        }
        
        function updateSaludView() {
            updateSaludStats();
            updateSaludAlertas();
            updateSaludHistorial();
        }
        
        function updateSaludStats() {
            const inventario = getInventario();
            const today = new Date();
            
            let vacunasAlDia = 0;
            let vacunasPendientes = 0;
            let enTratamiento = 0;
            let enRetiro = 0;
            
            inventario.forEach(a => {
                // Check retiro status
                if (isAnimalInRetiro(a.numero)) enRetiro++;
                
                // Check if has recent vaccination (within 6 months)
                const lastVacuna = data.saludEventos
                    .filter(e => e.tipo === 'vacuna' && e.animales.includes(a.numero))
                    .sort((a, b) => new Date(b.fecha) - new Date(a.fecha))[0];
                
                if (lastVacuna) {
                    const vacunaDate = new Date(lastVacuna.fecha);
                    const daysSince = Math.floor((today - vacunaDate) / (1000 * 60 * 60 * 24));
                    if (daysSince <= 180) {
                        vacunasAlDia++;
                    } else {
                        vacunasPendientes++;
                    }
                } else {
                    vacunasPendientes++;
                }
                
                // Check active treatments
                const activeTreatments = data.saludEventos.filter(e => {
                    if (e.tipo !== 'tratamiento') return false;
                    if (!e.animales.includes(a.numero)) return false;
                    if (!e.diasRetiro) return false;
                    const eventDate = new Date(e.fecha);
                    const endDate = new Date(eventDate);
                    endDate.setDate(endDate.getDate() + e.diasRetiro);
                    return today < endDate;
                });
                if (activeTreatments.length > 0) enTratamiento++;
            });
            
            document.getElementById('saludVacunasAlDia').textContent = vacunasAlDia;
            document.getElementById('saludVacunasPendientes').textContent = vacunasPendientes;
            document.getElementById('saludEnTratamiento').textContent = enTratamiento;
            document.getElementById('saludEnRetiro').textContent = enRetiro;
        }
        
        function updateSaludAlertas() {
            const alertas = [];
            const today = new Date();
            
            // Check for upcoming vaccinations
            data.saludEventos.forEach(e => {
                if (e.proximaFecha) {
                    const proxima = new Date(e.proximaFecha);
                    const daysUntil = Math.floor((proxima - today) / (1000 * 60 * 60 * 24));
                    
                    if (daysUntil <= 7 && daysUntil >= 0) {
                        alertas.push({
                            type: 'warning',
                            icon: '‚è∞',
                            title: `${e.producto} - Refuerzo pr√≥ximo`,
                            desc: `${e.animales.length} animales - ${daysUntil === 0 ? 'Hoy' : `en ${daysUntil} d√≠as`} (${formatDate(e.proximaFecha)})`
                        });
                    } else if (daysUntil < 0) {
                        alertas.push({
                            type: 'critical',
                            icon: 'üö®',
                            title: `${e.producto} - Refuerzo VENCIDO`,
                            desc: `${e.animales.length} animales - hace ${Math.abs(daysUntil)} d√≠as`
                        });
                    }
                }
            });
            
            // Check for animals in retiro about to end
            const inventario = getInventario();
            inventario.forEach(a => {
                const retiroEnd = getRetiroEndDate(a.numero);
                if (retiroEnd) {
                    const daysUntil = Math.floor((retiroEnd - today) / (1000 * 60 * 60 * 24));
                    if (daysUntil <= 3 && daysUntil >= 0) {
                        alertas.push({
                            type: 'info',
                            icon: '‚úÖ',
                            title: `Animal ${a.numero} - Retiro termina pronto`,
                            desc: `${daysUntil === 0 ? 'Hoy' : `en ${daysUntil} d√≠as`} (${formatDate(retiroEnd.toISOString())})`
                        });
                    }
                }
            });
            
            const container = document.getElementById('saludAlertas');
            const content = document.getElementById('saludAlertasContent');
            
            if (alertas.length === 0) {
                container.style.display = 'none';
                return;
            }
            
            container.style.display = 'block';
            content.innerHTML = alertas.map(a => `
                <div class="alert-item ${a.type}">
                    <span class="alert-icon">${a.icon}</span>
                    <div class="alert-content">
                        <div class="alert-title">${a.title}</div>
                        <div class="alert-desc">${a.desc}</div>
                    </div>
                </div>
            `).join('');
        }
        
        function updateSaludHistorial() {
            const tbody = document.getElementById('saludHistorialBody');
            
            if (data.saludEventos.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center">No hay registros de salud</td></tr>';
                return;
            }
            
            const sorted = [...data.saludEventos].sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
            
            tbody.innerHTML = sorted.map(e => {
                const tipoIcons = { 'vacuna': 'üíâ', 'desparasitacion': 'üêõ', 'tratamiento': 'üíä', 'revision': 'ü©∫' };
                const tipoNames = { 'vacuna': 'Vacuna', 'desparasitacion': 'Desparasitaci√≥n', 'tratamiento': 'Tratamiento', 'revision': 'Revisi√≥n' };
                
                return `<tr>
                    <td>${formatDate(e.fecha)}</td>
                    <td><span class="health-badge ${e.tipo}">${tipoIcons[e.tipo]} ${tipoNames[e.tipo]}</span></td>
                    <td>${e.producto}</td>
                    <td>${e.animales.length} animal${e.animales.length > 1 ? 'es' : ''}</td>
                    <td>${e.diasRetiro ? `${e.diasRetiro} d√≠as` : '-'}</td>
                    <td>${e.proximaFecha ? formatDate(e.proximaFecha) : '-'}</td>
                </tr>`;
            }).join('');
        }
        
        function filterSaludHistorial() {
            const search = document.getElementById('saludHistorialSearch').value.toLowerCase();
            const tipo = document.getElementById('saludHistorialTipo').value;
            
            document.querySelectorAll('#saludHistorialBody tr').forEach(row => {
                const text = row.textContent.toLowerCase();
                const rowTipo = row.querySelector('.health-badge')?.classList.contains(tipo) || !tipo;
                const matchSearch = text.includes(search);
                row.style.display = (matchSearch && rowTipo) ? '' : 'none';
            });
        }
        
        // ==================== POTREROS (PADDOCK) MODULE ====================
        function showPotreroForm(editId = null) {
            document.getElementById('potreroFormContainer').style.display = 'block';
            document.getElementById('potreroEditId').value = editId || '';
            
            if (editId) {
                const potrero = data.potreros.find(p => p.id === editId);
                if (potrero) {
                    document.getElementById('potreroFormTitle').textContent = '‚úèÔ∏è Editar Potrero';
                    document.getElementById('potreroNombre').value = potrero.nombre;
                    document.getElementById('potreroArea').value = potrero.area || '';
                    document.getElementById('potreroTipoPasto').value = potrero.tipoPasto || 'Brachiaria';
                    document.getElementById('potreroCapacidad').value = potrero.capacidad || '';
                    document.getElementById('potreroAgua').value = potrero.agua || 'bebedero';
                    document.getElementById('potreroEstado').value = potrero.estado || 'disponible';
                    document.getElementById('potreroNotas').value = potrero.notas || '';
                }
            } else {
                document.getElementById('potreroFormTitle').textContent = '‚ûï Agregar Potrero';
                document.getElementById('potreroForm').reset();
            }
        }
        
        function hidePotreroForm() {
            document.getElementById('potreroFormContainer').style.display = 'none';
            document.getElementById('potreroForm').reset();
        }
        
        function savePotrero(event) {
            event.preventDefault();
            
            const editId = document.getElementById('potreroEditId').value;
            const potreroData = {
                id: editId ? parseInt(editId) : Date.now(),
                nombre: document.getElementById('potreroNombre').value.trim(),
                area: parseFloat(document.getElementById('potreroArea').value) || null,
                tipoPasto: document.getElementById('potreroTipoPasto').value,
                capacidad: parseInt(document.getElementById('potreroCapacidad').value) || null,
                agua: document.getElementById('potreroAgua').value,
                estado: document.getElementById('potreroEstado').value,
                notas: document.getElementById('potreroNotas').value.trim(),
                ultimaEntrada: editId ? (data.potreros.find(p => p.id === parseInt(editId))?.ultimaEntrada || null) : null,
                ultimaSalida: editId ? (data.potreros.find(p => p.id === parseInt(editId))?.ultimaSalida || null) : null
            };
            
            if (editId) {
                const idx = data.potreros.findIndex(p => p.id === parseInt(editId));
                if (idx >= 0) data.potreros[idx] = potreroData;
            } else {
                data.potreros.push(potreroData);
            }
            
            saveData();
            showToast(`Potrero ${editId ? 'actualizado' : 'agregado'}: ${potreroData.nombre}`, 'success');
            hidePotreroForm();
        }
        
        function deletePotrero(id) {
            const potrero = data.potreros.find(p => p.id === id);
            if (!potrero) return;
            
            // Check if animals are assigned
            const animalesEnPotrero = Object.entries(data.animalPotreros).filter(([num, pId]) => pId === id);
            if (animalesEnPotrero.length > 0) {
                showToast(`No se puede eliminar: hay ${animalesEnPotrero.length} animales en este potrero`, 'error');
                return;
            }
            
            if (!confirm(`¬øEliminar el potrero "${potrero.nombre}"?`)) return;
            
            data.potreros = data.potreros.filter(p => p.id !== id);
            saveData();
            showToast('Potrero eliminado', 'success');
        }
        
        function showMoverAnimalesForm() {
            document.getElementById('moverAnimalesFormContainer').style.display = 'block';
            document.getElementById('moverFecha').value = new Date().toISOString().split('T')[0];
            
            // Populate potrero selectors
            const desdeSelect = document.getElementById('moverDesde');
            const haciaSelect = document.getElementById('moverHacia');
            
            desdeSelect.innerHTML = '<option value="">-- Sin potrero asignado --</option>' + 
                data.potreros.map(p => `<option value="${p.id}">${p.nombre}</option>`).join('');
            
            haciaSelect.innerHTML = '<option value="">-- Seleccionar destino --</option>' + 
                data.potreros.filter(p => p.estado !== 'mantenimiento')
                    .map(p => `<option value="${p.id}">${p.nombre} (${p.estado})</option>`).join('');
            
            selectedMoverAnimals.clear();
            updateAnimalesEnPotrero();
        }
        
        function hideMoverAnimalesForm() {
            document.getElementById('moverAnimalesFormContainer').style.display = 'none';
            selectedMoverAnimals.clear();
        }
        
        function updateAnimalesEnPotrero() {
            const desdeId = document.getElementById('moverDesde').value;
            const container = document.getElementById('moverAnimalSelector');
            const inventario = getInventario();
            
            let animalesFiltrados;
            if (desdeId === '') {
                // Animals without assigned potrero
                animalesFiltrados = inventario.filter(a => !data.animalPotreros[a.numero]);
            } else {
                // Animals in selected potrero
                animalesFiltrados = inventario.filter(a => data.animalPotreros[a.numero] === parseInt(desdeId));
            }
            
            if (animalesFiltrados.length === 0) {
                container.innerHTML = '<div style="grid-column: 1/-1; text-align: center; color: var(--gray);">No hay animales en esta ubicaci√≥n</div>';
                return;
            }
            
            container.innerHTML = animalesFiltrados.map(a => 
                `<div class="animal-chip" data-numero="${a.numero}" onclick="toggleMoverAnimal('${a.numero}')">${a.numero}</div>`
            ).join('');
            
            selectedMoverAnimals.clear();
            updateMoverSelectedCount();
        }
        
        function toggleMoverAnimal(numero) {
            if (selectedMoverAnimals.has(numero)) {
                selectedMoverAnimals.delete(numero);
            } else {
                selectedMoverAnimals.add(numero);
            }
            
            document.querySelectorAll('#moverAnimalSelector .animal-chip').forEach(chip => {
                if (chip.dataset.numero === numero) {
                    chip.classList.toggle('selected');
                }
            });
            
            updateMoverSelectedCount();
        }
        
        function selectAllAnimalesMover() {
            document.querySelectorAll('#moverAnimalSelector .animal-chip').forEach(chip => {
                selectedMoverAnimals.add(chip.dataset.numero);
                chip.classList.add('selected');
            });
            updateMoverSelectedCount();
        }
        
        function clearMoverSelection() {
            selectedMoverAnimals.clear();
            document.querySelectorAll('#moverAnimalSelector .animal-chip').forEach(chip => {
                chip.classList.remove('selected');
            });
            updateMoverSelectedCount();
        }
        
        function updateMoverSelectedCount() {
            document.getElementById('moverSelectedCount').textContent = selectedMoverAnimals.size;
        }
        
        function moverAnimales(event) {
            event.preventDefault();
            
            if (selectedMoverAnimals.size === 0) {
                showToast('Debe seleccionar al menos un animal', 'error');
                return;
            }
            
            const haciaId = parseInt(document.getElementById('moverHacia').value);
            if (!haciaId) {
                showToast('Debe seleccionar potrero destino', 'error');
                return;
            }
            
            const desdeId = document.getElementById('moverDesde').value ? parseInt(document.getElementById('moverDesde').value) : null;
            const fecha = document.getElementById('moverFecha').value;
            
            // Calculate days in previous potrero
            let diasEnAnterior = null;
            if (desdeId) {
                const potrero = data.potreros.find(p => p.id === desdeId);
                if (potrero && potrero.ultimaEntrada) {
                    const entrada = new Date(potrero.ultimaEntrada);
                    const hoy = new Date(fecha);
                    diasEnAnterior = Math.floor((hoy - entrada) / (1000 * 60 * 60 * 24));
                }
            }
            
            // Record rotation
            const rotacion = {
                id: Date.now(),
                fecha: fecha,
                desdeId: desdeId,
                haciaId: haciaId,
                animales: Array.from(selectedMoverAnimals),
                diasEnAnterior: diasEnAnterior
            };
            data.rotaciones.push(rotacion);
            
            // Update animal assignments
            selectedMoverAnimals.forEach(numero => {
                data.animalPotreros[numero] = haciaId;
            });
            
            // Update potrero states
            if (desdeId) {
                const potreroDesde = data.potreros.find(p => p.id === desdeId);
                if (potreroDesde) {
                    potreroDesde.ultimaSalida = fecha;
                    // Check if potrero is now empty
                    const remaining = Object.values(data.animalPotreros).filter(pId => pId === desdeId).length;
                    if (remaining === 0) {
                        potreroDesde.estado = 'descanso';
                    }
                }
            }
            
            const potreroHacia = data.potreros.find(p => p.id === haciaId);
            if (potreroHacia) {
                potreroHacia.ultimaEntrada = fecha;
                potreroHacia.estado = 'ocupado';
            }
            
            saveData();
            
            const destino = data.potreros.find(p => p.id === haciaId)?.nombre || 'destino';
            showToast(`${selectedMoverAnimals.size} animales movidos a ${destino}`, 'success');
            
            hideMoverAnimalesForm();
        }
        
        function updatePotrerosView() {
            updatePotrerosStats();
            updatePotrerosGrid();
            updateRotacionHistorial();
        }
        
        function updatePotrerosStats() {
            const total = data.potreros.length;
            const ocupados = data.potreros.filter(p => p.estado === 'ocupado').length;
            const descansando = data.potreros.filter(p => p.estado === 'descanso').length;
            
            // Count potreros that have been resting for 30+ days
            const today = new Date();
            const listos = data.potreros.filter(p => {
                if (p.estado !== 'descanso') return false;
                if (!p.ultimaSalida) return true; // Never used = ready
                const salida = new Date(p.ultimaSalida);
                const dias = Math.floor((today - salida) / (1000 * 60 * 60 * 24));
                return dias >= 30;
            }).length;
            
            document.getElementById('potrerosTotal').textContent = total;
            document.getElementById('potrerosOcupados').textContent = ocupados;
            document.getElementById('potrerosDescansando').textContent = descansando;
            document.getElementById('potrerosListos').textContent = listos;
        }
        
        function updatePotrerosGrid() {
            const container = document.getElementById('potrerosGrid');
            
            if (data.potreros.length === 0) {
                container.innerHTML = '<div class="text-center" style="grid-column: 1/-1; padding: 2rem; color: var(--gray);">No hay potreros registrados. Haga clic en "Agregar Potrero" para comenzar.</div>';
                return;
            }
            
            const today = new Date();
            
            container.innerHTML = data.potreros.map(p => {
                // Count animals in this potrero
                const animalesCount = Object.values(data.animalPotreros).filter(pId => pId === p.id).length;
                
                // Calculate days resting or occupied
                let diasEstado = null;
                if (p.estado === 'descanso' && p.ultimaSalida) {
                    diasEstado = Math.floor((today - new Date(p.ultimaSalida)) / (1000 * 60 * 60 * 24));
                } else if (p.estado === 'ocupado' && p.ultimaEntrada) {
                    diasEstado = Math.floor((today - new Date(p.ultimaEntrada)) / (1000 * 60 * 60 * 24));
                }
                
                const statusLabels = {
                    'disponible': 'üå± Disponible',
                    'ocupado': 'üêÑ Ocupado',
                    'descanso': 'üí§ Descanso',
                    'mantenimiento': 'üîß Mantenimiento'
                };
                
                const waterLabels = {
                    'quebrada': 'üåä Quebrada',
                    'bebedero': 'üö∞ Bebedero',
                    'jag√ºey': 'üíß Jag√ºey',
                    'pozo': 'üï≥Ô∏è Pozo',
                    'ninguna': '‚ùå Sin agua'
                };
                
                return `
                    <div class="potrero-card ${p.estado}">
                        <div class="potrero-card-header">
                            <div class="potrero-card-title">üåø ${p.nombre}</div>
                            <span class="potrero-card-status ${p.estado}">${statusLabels[p.estado]}</span>
                        </div>
                        <div class="potrero-card-stats">
                            <div class="potrero-stat">üìè ${p.area ? p.area + ' ha' : 'Sin √°rea'}</div>
                            <div class="potrero-stat">üåæ ${p.tipoPasto}</div>
                            <div class="potrero-stat">üêÑ ${animalesCount}${p.capacidad ? '/' + p.capacidad : ''} cabezas</div>
                            <div class="potrero-stat">${waterLabels[p.agua] || '‚ùì'}</div>
                            ${diasEstado !== null ? `<div class="potrero-stat" style="grid-column: 1/-1;">‚è±Ô∏è ${diasEstado} d√≠as ${p.estado === 'descanso' ? 'descansando' : 'ocupado'}</div>` : ''}
                        </div>
                        ${p.notas ? `<div style="font-size: 0.8rem; color: #666; margin-bottom: 0.5rem;">üìù ${p.notas}</div>` : ''}
                        <div class="potrero-card-footer">
                            <button class="btn btn-secondary" onclick="showPotreroForm(${p.id})">‚úèÔ∏è Editar</button>
                            <button class="btn btn-danger" onclick="deletePotrero(${p.id})">üóëÔ∏è</button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function updateRotacionHistorial() {
            const tbody = document.getElementById('rotacionHistorialBody');
            
            if (data.rotaciones.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center">No hay movimientos registrados</td></tr>';
                return;
            }
            
            const sorted = [...data.rotaciones].sort((a, b) => new Date(b.fecha) - new Date(a.fecha)).slice(0, 20);
            
            tbody.innerHTML = sorted.map(r => {
                const desde = r.desdeId ? (data.potreros.find(p => p.id === r.desdeId)?.nombre || 'Desconocido') : 'Sin asignar';
                const hacia = data.potreros.find(p => p.id === r.haciaId)?.nombre || 'Desconocido';
                
                return `<tr>
                    <td>${formatDate(r.fecha)}</td>
                    <td>${desde}</td>
                    <td>${hacia}</td>
                    <td>${r.animales.length} animal${r.animales.length > 1 ? 'es' : ''}</td>
                    <td>${r.diasEnAnterior !== null ? r.diasEnAnterior + ' d√≠as' : '-'}</td>
                </tr>`;
            }).join('');
        }
        
        // ==================== ANIMAL PROFILE MODULE ====================
        function showAnimalProfile(numero) {
            const animal = getInventario().find(a => a.numero === numero);
            if (!animal) {
                showToast('Animal no encontrado', 'error');
                return;
            }
            
            const modal = document.getElementById('animalProfileModal');
            const body = document.getElementById('animalProfileBody');
            const title = document.getElementById('animalProfileTitle');
            
            title.textContent = `üêÇ Animal #${numero}`;
            
            // Calculate current estimated weight
            const today = new Date();
            const entryDate = new Date(animal.fechaEntrada);
            const days = Math.floor((today - entryDate) / (1000 * 60 * 60 * 24));
            const gdp = data.config.gdp || 0.31;
            const pesoActual = animal.peso + (days * gdp);
            const gananciaTotal = pesoActual - animal.peso;
            
            // Get potrero
            const potreroId = data.animalPotreros[numero];
            const potrero = potreroId ? data.potreros.find(p => p.id === potreroId) : null;
            
            // Get health history
            const saludHistorial = data.saludEventos
                .filter(e => e.animales.includes(numero))
                .sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
            
            // Get photo sessions
            const fotoSesiones = (data.fotoSesiones || [])
                .filter(f => f.numero === numero)
                .sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
            
            // Check retiro status
            const inRetiro = isAnimalInRetiro(numero);
            const retiroEnd = getRetiroEndDate(numero);
            
            // Calculate value
            const valorActual = pesoActual * (data.config.precioVenta || 9000);
            
            // Get GDP from photos if available
            const calculatedGDP = animal.gananciaDay || gdp;
            
            body.innerHTML = `
                <!-- Basic Info Section -->
                <div class="profile-section">
                    <div class="profile-section-title">üìã Informaci√≥n B√°sica</div>
                    <div class="profile-grid">
                        <div class="profile-item">
                            <span class="profile-item-label">Chapeta</span>
                            <span class="profile-item-value large">#${numero}</span>
                        </div>
                        <div class="profile-item">
                            <span class="profile-item-label">Lote</span>
                            <span class="profile-item-value">${animal.lote || '-'}</span>
                        </div>
                        <div class="profile-item">
                            <span class="profile-item-label">Sexo</span>
                            <span class="profile-item-value">${animal.sexo === 'MACHO' ? '‚ôÇÔ∏è Macho' : '‚ôÄÔ∏è Hembra'}</span>
                        </div>
                        <div class="profile-item">
                            <span class="profile-item-label">Raza</span>
                            <span class="profile-item-value">${animal.raza || 'No especificada'}</span>
                        </div>
                        <div class="profile-item">
                            <span class="profile-item-label">Tipo Entrada</span>
                            <span class="profile-item-value">${animal.tipo === 'nacimiento' ? 'üê£ Nacimiento' : 'üõí Compra'}</span>
                        </div>
                        <div class="profile-item">
                            <span class="profile-item-label">Fecha Entrada</span>
                            <span class="profile-item-value">${formatDate(animal.fechaEntrada)}</span>
                        </div>
                        <div class="profile-item">
                            <span class="profile-item-label">Vendedor</span>
                            <span class="profile-item-value">${animal.vendedor || '-'}</span>
                        </div>
                        <div class="profile-item">
                            <span class="profile-item-label">D√≠as en Finca</span>
                            <span class="profile-item-value">${days} d√≠as</span>
                        </div>
                    </div>
                </div>
                
                <!-- Weight Section -->
                <div class="profile-section" style="background: linear-gradient(135deg, #e8f5e9, #c8e6c9);">
                    <div class="profile-section-title">‚öñÔ∏è Peso y Crecimiento</div>
                    <div class="profile-grid">
                        <div class="profile-item">
                            <span class="profile-item-label">Peso Entrada</span>
                            <span class="profile-item-value">${animal.peso} kg</span>
                        </div>
                        <div class="profile-item">
                            <span class="profile-item-label">Peso Actual (Est.)</span>
                            <span class="profile-item-value large">${Math.round(pesoActual)} kg</span>
                        </div>
                        <div class="profile-item">
                            <span class="profile-item-label">Ganancia Total</span>
                            <span class="profile-item-value" style="color: var(--success);">+${Math.round(gananciaTotal)} kg</span>
                        </div>
                        <div class="profile-item">
                            <span class="profile-item-label">GDP (Ganancia/d√≠a)</span>
                            <span class="profile-item-value">${calculatedGDP.toFixed(2)} kg/d√≠a</span>
                        </div>
                    </div>
                </div>
                
                <!-- Financial Section -->
                <div class="profile-section" style="background: linear-gradient(135deg, #fff3e0, #ffe0b2);">
                    <div class="profile-section-title">üí∞ Informaci√≥n Financiera</div>
                    <div class="profile-grid">
                        <div class="profile-item">
                            <span class="profile-item-label">Costo Compra</span>
                            <span class="profile-item-value">${formatCurrency(animal.costoTotal || (animal.peso * animal.precioKilo) || 0)}</span>
                        </div>
                        <div class="profile-item">
                            <span class="profile-item-label">Precio/Kg Compra</span>
                            <span class="profile-item-value">${formatCurrency(animal.precioKilo || 0)}/kg</span>
                        </div>
                        <div class="profile-item">
                            <span class="profile-item-label">Valor Actual (Est.)</span>
                            <span class="profile-item-value large">${formatCurrency(valorActual)}</span>
                        </div>
                        <div class="profile-item">
                            <span class="profile-item-label">Precio Venta/Kg</span>
                            <span class="profile-item-value">${formatCurrency(data.config.precioVenta)}/kg</span>
                        </div>
                    </div>
                </div>
                
                <!-- Location Section -->
                <div class="profile-section">
                    <div class="profile-section-title">üìç Ubicaci√≥n</div>
                    <div class="profile-grid">
                        <div class="profile-item" style="grid-column: 1/-1;">
                            <span class="profile-item-label">Potrero Actual</span>
                            <span class="profile-item-value">${potrero ? `üåø ${potrero.nombre}` : '‚ùì Sin asignar'}</span>
                        </div>
                    </div>
                </div>
                
                <!-- Health Status -->
                <div class="profile-section" style="background: ${inRetiro ? 'linear-gradient(135deg, #ffebee, #ffcdd2)' : 'linear-gradient(135deg, #e3f2fd, #bbdefb)'};">
                    <div class="profile-section-title">üíâ Estado de Salud</div>
                    ${inRetiro ? `
                        <div class="alert-item critical" style="margin-bottom: 1rem;">
                            <span class="alert-icon">üö´</span>
                            <div class="alert-content">
                                <div class="alert-title">EN PERIODO DE RETIRO</div>
                                <div class="alert-desc">No disponible para venta hasta ${formatDate(retiroEnd.toISOString())}</div>
                            </div>
                        </div>
                    ` : ''}
                    ${saludHistorial.length > 0 ? `
                        <div style="font-size: 0.9rem;">
                            <strong>√öltimos eventos:</strong>
                            <ul style="margin: 0.5rem 0; padding-left: 1.5rem;">
                                ${saludHistorial.slice(0, 5).map(e => {
                                    const icons = { 'vacuna': 'üíâ', 'desparasitacion': 'üêõ', 'tratamiento': 'üíä', 'revision': 'ü©∫' };
                                    return `<li>${icons[e.tipo]} ${e.producto} - ${formatDate(e.fecha)}</li>`;
                                }).join('')}
                            </ul>
                        </div>
                    ` : '<div style="color: var(--gray);">Sin registros de salud</div>'}
                </div>
                
                <!-- Photo History -->
                <div class="profile-section">
                    <div class="profile-section-title">üì∏ Historial Fotogr√°fico</div>
                    ${fotoSesiones.length > 0 ? `
                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 0.5rem;">
                            ${fotoSesiones.slice(0, 6).map(f => `
                                <div style="text-align: center; padding: 0.5rem; background: #f5f5f5; border-radius: 8px;">
                                    <div style="font-size: 1.5rem;">üì∑</div>
                                    <div style="font-size: 0.8rem;">${formatDate(f.fecha)}</div>
                                    <div style="font-size: 0.75rem; color: var(--gray);">BCS: ${f.bcs}</div>
                                    ${f.pesoBascula ? `<div style="font-size: 0.75rem; color: var(--success);">${f.pesoBascula} kg</div>` : ''}
                                </div>
                            `).join('')}
                        </div>
                        ${fotoSesiones.length > 6 ? `<div style="text-align: center; margin-top: 0.5rem; color: var(--gray);">+${fotoSesiones.length - 6} m√°s sesiones</div>` : ''}
                    ` : '<div style="color: var(--gray);">Sin sesiones fotogr√°ficas</div>'}
                </div>
                
                <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
                    <button class="btn btn-secondary" onclick="closeAnimalProfile()" style="flex: 1;">Cerrar</button>
                </div>
            `;
            
            modal.style.display = 'flex';
        }
        
        function closeAnimalProfile() {
            document.getElementById('animalProfileModal').style.display = 'none';
        }
        
        // Close modal when clicking outside
        document.addEventListener('click', function(e) {
            const modal = document.getElementById('animalProfileModal');
            if (e.target === modal) {
                closeAnimalProfile();
            }
        });
        
        // ==================== AI ANALYTICS MODULE ====================
        
        let currentAIProvider = 'google'; // 'google' or 'anthropic'
        
        function selectAIProvider(provider) {
            currentAIProvider = provider;
            localStorage.setItem('aiProvider', provider);
            
            // Update UI
            document.getElementById('btnProviderGoogle').classList.toggle('active', provider === 'google');
            document.getElementById('btnProviderAnthropic').classList.toggle('active', provider === 'anthropic');
            
            document.getElementById('googleConfig').style.display = provider === 'google' ? 'block' : 'none';
            document.getElementById('anthropicConfig').style.display = provider === 'anthropic' ? 'block' : 'none';
        }
        
        function saveGoogleApiKey() {
            const apiKey = document.getElementById('googleApiKey').value.trim();
            if (!apiKey) {
                showToast('Ingrese una API Key v√°lida', 'error');
                return;
            }
            
            localStorage.setItem('googleApiKey', apiKey);
            document.getElementById('googleApiKeyStatus').innerHTML = '<span style="color: #4caf50;">‚úÖ API Key de Google guardada correctamente</span>';
            showToast('API Key de Google guardada', 'success');
        }
        
        function saveAnthropicApiKey() {
            const apiKey = document.getElementById('anthropicApiKey').value.trim();
            if (!apiKey) {
                showToast('Ingrese una API Key v√°lida', 'error');
                return;
            }
            
            localStorage.setItem('anthropicApiKey', apiKey);
            document.getElementById('anthropicApiKeyStatus').innerHTML = '<span style="color: #4caf50;">‚úÖ API Key de Anthropic guardada correctamente</span>';
            showToast('API Key de Anthropic guardada', 'success');
        }
        
        function loadApiKeys() {
            // Load provider preference
            const savedProvider = localStorage.getItem('aiProvider') || 'google';
            selectAIProvider(savedProvider);
            
            // Load Google API Key - with default key pre-configured
            let googleKey = localStorage.getItem('googleApiKey');
            if (!googleKey) {
                // Pre-configure with provided API key
                googleKey = 'AIzaSyA4y3nCiv79TevLUfRGEx4gDfRFEVYCaac';
                localStorage.setItem('googleApiKey', googleKey);
            }
            if (googleKey) {
                document.getElementById('googleApiKey').value = googleKey;
                document.getElementById('googleApiKeyStatus').innerHTML = '<span style="color: #4caf50;">‚úÖ API Key configurada y lista para usar</span>';
            }
            
            // Load Anthropic API Key
            const anthropicKey = localStorage.getItem('anthropicApiKey');
            if (anthropicKey) {
                document.getElementById('anthropicApiKey').value = anthropicKey;
                document.getElementById('anthropicApiKeyStatus').innerHTML = '<span style="color: #4caf50;">‚úÖ API Key configurada</span>';
            }
        }
        
        function getDataSummaryForAI() {
            const inventario = getInventario();
            const today = new Date();
            const gdp = data.config.gdp || 0.31;
            const precioVenta = data.config.precioVenta || 9000;
            
            let totalPesoInicial = 0;
            let totalPesoEstimado = 0;
            let totalInversion = 0;
            let totalValorActual = 0;
            
            const animalDetails = inventario.map(a => {
                const dias = Math.floor((today - new Date(a.fechaEntrada)) / (1000 * 60 * 60 * 24));
                const pesoEst = a.peso + (dias * gdp);
                const costo = a.costoTotal || (a.peso * a.precioKilo) || 0;
                const valorActual = pesoEst * precioVenta;
                const ganancia = valorActual - costo;
                const margen = costo > 0 ? ((ganancia / costo) * 100) : 0;
                
                totalPesoInicial += a.peso;
                totalPesoEstimado += pesoEst;
                totalInversion += costo;
                totalValorActual += valorActual;
                
                return {
                    numero: a.numero,
                    lote: a.lote || 'N/A',
                    sexo: a.sexo,
                    raza: a.raza || 'No especificada',
                    vendedor: a.vendedor || 'Nacimiento',
                    pesoInicial: a.peso,
                    pesoEstimado: Math.round(pesoEst),
                    diasEnFinca: dias,
                    gdpReal: dias > 0 ? ((pesoEst - a.peso) / dias).toFixed(3) : gdp,
                    costo: costo,
                    valorActual: Math.round(valorActual),
                    gananciaEstimada: Math.round(ganancia),
                    margenPorcentaje: margen.toFixed(1),
                    listoParaVenta: pesoEst >= (data.config.pesoObjetivo || 450),
                    enRetiro: typeof isAnimalInRetiro === 'function' ? isAnimalInRetiro(a.numero) : false,
                    potrero: data.animalPotreros && data.animalPotreros[a.numero] ? 
                        (data.potreros.find(p => p.id === data.animalPotreros[a.numero])?.nombre || 'Desconocido') : 'Sin asignar'
                };
            });
            
            const vendedorStats = {};
            inventario.forEach(a => {
                const v = a.vendedor || 'Nacimiento';
                if (!vendedorStats[v]) vendedorStats[v] = { count: 0, totalPeso: 0, totalCosto: 0 };
                vendedorStats[v].count++;
                vendedorStats[v].totalPeso += a.peso;
                vendedorStats[v].totalCosto += a.costoTotal || (a.peso * a.precioKilo) || 0;
            });
            
            const ventasRecientes = data.salidas.filter(s => s.comprador !== 'MUERTE').slice(-20).map(s => ({
                numero: s.numero,
                peso: s.peso,
                fecha: s.fechaSalida,
                precioKg: s.precioKiloVenta,
                comprador: s.comprador,
                total: s.costoVenta || (s.peso * s.precioKiloVenta)
            }));
            
            const saludResumen = {
                totalEventos: data.saludEventos ? data.saludEventos.length : 0,
                ultimasVacunas: data.saludEventos ? data.saludEventos.filter(e => e.tipo === 'vacuna').slice(-5) : [],
                animalesEnRetiro: inventario.filter(a => typeof isAnimalInRetiro === 'function' ? isAnimalInRetiro(a.numero) : false).length
            };
            
            const potreroResumen = data.potreros ? data.potreros.map(p => {
                const animalesEnPotrero = Object.values(data.animalPotreros || {}).filter(pId => pId === p.id).length;
                return {
                    nombre: p.nombre,
                    area: p.area,
                    capacidad: p.capacidad,
                    animalesActuales: animalesEnPotrero,
                    estado: p.estado,
                    tipoPasto: p.tipoPasto
                };
            }) : [];
            
            return {
                fecha: today.toISOString().split('T')[0],
                finca: RANCHES[currentRanch].name,
                config: {
                    gdpConfigurado: gdp,
                    precioVentaKg: precioVenta,
                    pesoObjetivo: data.config.pesoObjetivo || 450
                },
                resumenGeneral: {
                    totalAnimales: inventario.length,
                    machos: inventario.filter(a => a.sexo === 'MACHO').length,
                    hembras: inventario.filter(a => a.sexo === 'HEMBRA').length,
                    totalPesoInicial: Math.round(totalPesoInicial),
                    totalPesoEstimado: Math.round(totalPesoEstimado),
                    pesoPromedioEstimado: inventario.length > 0 ? Math.round(totalPesoEstimado / inventario.length) : 0,
                    inversionTotal: Math.round(totalInversion),
                    valorActualTotal: Math.round(totalValorActual),
                    gananciaEstimadaTotal: Math.round(totalValorActual - totalInversion),
                    animalesListosVenta: animalDetails.filter(a => a.listoParaVenta && !a.enRetiro).length
                },
                animales: animalDetails,
                vendedores: vendedorStats,
                ventasRecientes: ventasRecientes,
                totalVentas: data.salidas.filter(s => s.comprador !== 'MUERTE').length,
                totalMuertes: data.salidas.filter(s => s.comprador === 'MUERTE').length,
                salud: saludResumen,
                potreros: potreroResumen
            };
        }
        
        function updateAIStats() {
            const inventario = getInventario();
            const today = new Date();
            const gdp = data.config.gdp || 0.31;
            const precioVenta = data.config.precioVenta || 9000;
            
            let totalPesoEst = 0;
            let totalValor = 0;
            
            inventario.forEach(a => {
                const dias = Math.floor((today - new Date(a.fechaEntrada)) / (1000 * 60 * 60 * 24));
                const pesoEst = a.peso + (dias * gdp);
                totalPesoEst += pesoEst;
                totalValor += pesoEst * precioVenta;
            });
            
            document.getElementById('aiTotalAnimales').textContent = inventario.length;
            document.getElementById('aiValorTotal').textContent = formatCurrency(totalValor);
            document.getElementById('aiGDPPromedio').textContent = gdp.toFixed(2) + ' kg/d√≠a';
            document.getElementById('aiPesoPromedio').textContent = inventario.length > 0 ? 
                Math.round(totalPesoEst / inventario.length) + ' kg' : '0 kg';
        }
        
        function getSystemPrompt(dataSummary) {
            return `Eres un experto en ganader√≠a bovina colombiana, especializado en cr√≠a y ceba de ganado grass-fed en zonas tropicales. 
Analizas datos de fincas ganaderas y proporcionas insights accionables.

DATOS ACTUALES DE LA FINCA "${dataSummary.finca}":
${JSON.stringify(dataSummary, null, 2)}

INSTRUCCIONES:
- Responde en espa√±ol
- Usa formato claro con secciones cuando sea apropiado
- Incluye n√∫meros espec√≠ficos de los datos
- Da recomendaciones pr√°cticas y accionables
- Considera el contexto de ganader√≠a colombiana (clima tropical, pastos, mercado local)
- Usa emojis para hacer el an√°lisis m√°s visual
- Cuando menciones valores monetarios, usa formato colombiano ($ con separador de miles)`;
        }
        
        // ========== GOOGLE GEMINI API ==========
        async function callGoogleGeminiAPI(prompt) {
            const apiKey = localStorage.getItem('googleApiKey');
            if (!apiKey) {
                showToast('Configure su API Key de Google primero', 'error');
                document.getElementById('apiKeySetup').scrollIntoView({ behavior: 'smooth' });
                return null;
            }
            
            const dataSummary = getDataSummaryForAI();
            const systemPrompt = getSystemPrompt(dataSummary);
            
            const fullPrompt = `${systemPrompt}\n\n---\n\nSOLICITUD DEL USUARIO:\n${prompt}`;
            
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: fullPrompt
                            }]
                        }],
                        generationConfig: {
                            temperature: 0.7,
                            maxOutputTokens: 2048
                        }
                    })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error?.message || 'Error en la API de Google');
                }
                
                const result = await response.json();
                
                if (result.candidates && result.candidates[0] && result.candidates[0].content) {
                    return result.candidates[0].content.parts[0].text;
                } else {
                    throw new Error('Respuesta inesperada de Google Gemini');
                }
            } catch (error) {
                console.error('Google API Error:', error);
                showToast('Error: ' + error.message, 'error');
                return null;
            }
        }
        
        // ========== ANTHROPIC CLAUDE API ==========
        async function callAnthropicAPI(prompt) {
            const apiKey = localStorage.getItem('anthropicApiKey');
            if (!apiKey) {
                showToast('Configure su API Key de Anthropic primero', 'error');
                document.getElementById('apiKeySetup').scrollIntoView({ behavior: 'smooth' });
                return null;
            }
            
            const dataSummary = getDataSummaryForAI();
            const systemPrompt = getSystemPrompt(dataSummary);
            
            try {
                const response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': apiKey,
                        'anthropic-version': '2023-06-01',
                        'anthropic-dangerous-direct-browser-access': 'true'
                    },
                    body: JSON.stringify({
                        model: 'claude-sonnet-4-20250514',
                        max_tokens: 2000,
                        messages: [
                            { role: 'user', content: prompt }
                        ],
                        system: systemPrompt
                    })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error?.message || 'Error en la API de Anthropic');
                }
                
                const result = await response.json();
                return result.content[0].text;
            } catch (error) {
                console.error('Anthropic API Error:', error);
                showToast('Error: ' + error.message, 'error');
                return null;
            }
        }
        
        // ========== UNIFIED AI CALL ==========
        async function callAI(prompt) {
            const providerName = currentAIProvider === 'google' ? 'Google Gemini' : 'Anthropic Claude';
            document.getElementById('aiLoadingText').textContent = `Analizando con ${providerName}...`;
            
            if (currentAIProvider === 'google') {
                return await callGoogleGeminiAPI(prompt);
            } else {
                return await callAnthropicAPI(prompt);
            }
        }
        
        async function quickAnalysis(type) {
            const prompts = {
                'resumen': 'Genera un resumen ejecutivo completo del estado actual de la finca. Incluye: inventario, valor, rentabilidad, y 3 puntos clave de atenci√≥n.',
                'listos_venta': 'Analiza qu√© animales est√°n listos para venta (peso >= objetivo y sin per√≠odo de retiro). Lista los animales con su peso estimado, valor, y d√≠as en finca. Calcula el ingreso total potencial si se venden todos.',
                'mejor_gdp': 'Identifica los 10 animales con mejor rendimiento (GDP m√°s alto). Analiza qu√© tienen en com√∫n (vendedor, lote, raza, etc.) y qu√© podemos aprender para futuras compras.',
                'rentabilidad': 'Realiza un an√°lisis de rentabilidad detallado: margen por animal, ROI, costo por kg producido, y comparaci√≥n entre lotes. Identifica los animales m√°s y menos rentables.',
                'vendedores': 'Eval√∫a el desempe√±o de cada vendedor: n√∫mero de animales, peso promedio de entrada, costo promedio por kg, y calidad general. ¬øDe qu√© vendedor conviene seguir comprando?',
                'compradores': 'Analiza el historial de ventas por comprador: volumen, precios pagados, frecuencia. ¬øQui√©nes son los mejores compradores y c√≥mo podemos fortalecer esas relaciones?',
                'salud': 'Eval√∫a el estado de salud del hato: vacunaciones al d√≠a, tratamientos recientes, animales en retiro. ¬øQu√© acciones sanitarias se necesitan pr√≥ximamente?',
                'potreros': 'Analiza la eficiencia de uso de potreros: ocupaci√≥n, rotaci√≥n, d√≠as de descanso. ¬øEst√°n bien distribuidos los animales? ¬øHay potreros subutilizados?',
                'proyeccion': 'Genera una proyecci√≥n a 30, 60 y 90 d√≠as: cu√°ntos animales llegar√°n al peso objetivo, ingreso estimado por ventas, y recomendaciones de timing para maximizar ganancias.',
                'recomendaciones': 'Bas√°ndote en todos los datos, genera las 5 recomendaciones m√°s importantes para mejorar la rentabilidad de la finca en los pr√≥ximos 3 meses.'
            };
            
            const prompt = prompts[type];
            if (!prompt) return;
            
            showAILoading(true);
            const response = await callAI(prompt);
            showAILoading(false);
            
            if (response) {
                showAIResponse(response);
            }
        }
        
        async function askCustomQuestion() {
            const question = document.getElementById('aiCustomQuestion').value.trim();
            if (!question) {
                showToast('Escribe una pregunta primero', 'error');
                return;
            }
            
            showAILoading(true);
            const response = await callAI(question);
            showAILoading(false);
            
            if (response) {
                showAIResponse(response);
            }
        }
        
        function showAILoading(show) {
            document.getElementById('aiLoading').style.display = show ? 'block' : 'none';
            if (show) {
                document.getElementById('aiResponseCard').style.display = 'none';
            }
        }
        
        function showAIResponse(response) {
            document.getElementById('aiResponseCard').style.display = 'block';
            document.getElementById('aiResponseContent').innerHTML = formatAIResponse(response);
            document.getElementById('aiResponseCard').scrollIntoView({ behavior: 'smooth' });
        }
        
        function formatAIResponse(text) {
            let html = text
                .replace(/^### (.*$)/gim, '<h4 style="color: #9c27b0; margin-top: 1rem;">$1</h4>')
                .replace(/^## (.*$)/gim, '<h3 style="color: #9c27b0; margin-top: 1.2rem;">$1</h3>')
                .replace(/^# (.*$)/gim, '<h2 style="color: #9c27b0; margin-top: 1.5rem;">$1</h2>')
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/^\- (.*$)/gim, '‚Ä¢ $1<br>')
                .replace(/^\* (.*$)/gim, '‚Ä¢ $1<br>')
                .replace(/\n\n/g, '<br><br>')
                .replace(/\n/g, '<br>');
            
            return html;
        }
        
        function copyAnalysis() {
            const content = document.getElementById('aiResponseContent').innerText;
            navigator.clipboard.writeText(content).then(() => {
                showToast('An√°lisis copiado al portapapeles', 'success');
            }).catch(() => {
                showToast('Error al copiar', 'error');
            });
        }
        
        // ==================== UTILITIES ====================
        function formatCurrency(value) {
            return '$' + Math.round(value).toLocaleString('es-CO');
        }
        
        function formatNumber(value) {
            return Math.round(value).toLocaleString('es-CO');
        }
        
        function formatDate(dateStr) {
            if (!dateStr) return '-';
            const date = new Date(dateStr);
            return date.toLocaleDateString('es-CO');
        }
        
        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = 'toast ' + type;
            toast.innerHTML = `<span>${message}</span>`;
            container.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slideIn 0.3s ease reverse';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }
    </script>
</body>
</html>
